<!DOCTYPE html>
<html lang="de">
<head>
<script type="text/javascript" data-cmp-ab="1" src="https://cdn.consentmanager.net/delivery/autoblocking/d9a4221a32ad0.js" data-cmp-host="a.delivery.consentmanager.net" data-cmp-cdn="cdn.consentmanager.net" data-cmp-codesrc="0"></script>
<meta charset="UTF-8"/>
<!-- Optimiert f√ºr iPhone 11 / moderne Smartphones -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes"/>
<title>Linda ‚Äì Deine pers√∂nliche Assistentin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

<style>
  :root {
    --font-body: 'Inter', system-ui, -apple-system, sans-serif;
    --mobile-base: 16px;
    --mobile-title: 22px;
    --mobile-text: 17px;
    --mobile-chat: 18px;
    --mobile-subtle: 14px;
    --mobile-touch: 48px;
    --mobile-radius: 14px;
    --mobile-gap: 16px;
    --mobile-pad: 16px;
    
    --bg: #ffffff;
    --surface: #f8f9fa;
    --surface-2: #ffffff;
    --border: #e9ecef;
    --text: #1a1a1a;
    --text-muted: #6c757d;
    --brand: #004481;
    --brand-2: #0071ce;
    --danger: #dc3545;
    --success: #28a745;
    
    --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.05);
    --shadow-strong: 0 4px 16px rgba(0, 68, 129, 0.15);
    
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  body.dark {
    --bg: #121212;
    --surface: #1e1e1e;
    --surface-2: #2a2a2a;
    --border: #333333;
    --text: #e0e0e0;
    --text-muted: #a0a0a0;
    --brand: #5bb3ff;
    --brand-2: #8fd3ff;
    --danger: #ff6b6b;
    --success: #41c078;
    --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-strong: 0 4px 16px rgba(0, 0, 0, 0.5);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { 
    height: 100%; 
    height: 100dvh; 
    margin: 0; 
    padding: 0; 
    font-family: var(--font-body); 
    font-size: var(--mobile-base);
    background: var(--bg); 
    color: var(--text); 
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* Main Layout - Mobile First */
  #app {
    display: flex;
    flex-direction: column;
    height: 100%;
    height: 100dvh;
    position: relative;
  }

  /* Header */
  .header {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: max(12px, var(--safe-top)) 16px 12px 16px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    z-index: 100;
    min-height: 60px;
  }

  .header-title {
    font-weight: 700;
    font-size: var(--mobile-title);
    letter-spacing: -0.02em;
    color: var(--brand);
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .header-badge {
    display: none;
    background: rgba(0, 68, 129, 0.1);
    color: var(--brand);
    padding: 6px 12px;
    border-radius: 999px;
    font-size: var(--mobile-subtle);
    font-weight: 600;
    white-space: nowrap;
  }

  .header-badge.active { display: inline-block; }

  .header-btn {
    background: none;
    border: none;
    width: var(--mobile-touch);
    height: var(--mobile-touch);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-muted);
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .header-btn:hover { background: var(--border); }
  .header-btn svg { width: 24px; height: 24px; stroke: currentColor; }

  /* Chat Area */
  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  .chat-scroll {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: var(--mobile-pad) 12px 80px 12px;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    background: var(--bg);
  }

  /* Messages */
  .message {
    display: flex;
    flex-direction: column;
    margin-bottom: 12px;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .bubble {
    max-width: 92%;
    padding: 14px 18px;
    border-radius: 16px;
    background: var(--surface);
    box-shadow: var(--shadow-soft);
    line-height: 1.7;
    word-wrap: break-word;
    overflow-wrap: break-word;
    position: relative;
  }

  .bubble.user {
    align-self: flex-end;
    background: var(--brand);
    color: #ffffff;
    border-bottom-right-radius: 4px;
  }

  .bubble.assistant {
    align-self: flex-start;
    background: var(--surface-2);
    border-bottom-left-radius: 4px;
    border: 1px solid var(--border);
  }

  /* Rich Text Styles */
  .bubble .md {
    font-size: var(--mobile-chat);
    color: inherit;
  }
  
  .bubble .md h1,
  .bubble .md h2,
  .bubble .md h3 {
    font-weight: 700;
    margin: 0 0 8px 0;
    font-size: 1.1em;
    color: var(--brand);
  }
  
  .bubble .md p { margin: 0 0 8px 0; }
  .bubble .md ul, .bubble .md ol { margin: 0 0 8px 24px; padding: 0; }
  .bubble .md li { margin: 4px 0; }
  .bubble .md pre {
    background: var(--bg);
    padding: 12px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 8px 0;
    font-size: 0.9em;
  }
  .bubble .md code {
    background: rgba(0,0,0,0.06);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'SF Mono', monospace;
  }
  .bubble.user .md code { background: rgba(255,255,255,0.2); }
  
  .bubble .md table {
    width: 100%;
    border-collapse: collapse;
    margin: 8px 0;
    font-size: 0.9em;
  }
  .bubble .md th, .bubble .md td {
    border: 1px solid var(--border);
    padding: 6px 8px;
    text-align: left;
  }
  .bubble .md th { background: var(--surface); }

  /* Message Actions */
  .message-actions {
    display: flex;
    gap: 8px;
    margin-top: 6px;
    justify-content: flex-end;
    flex-wrap: wrap;
    opacity: 0.9;
  }
  
  .msg-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 6px 12px;
    font-size: var(--mobile-subtle);
    font-weight: 600;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 32px;
  }
  
  .msg-btn:active { transform: scale(0.96); }
  .msg-btn:hover { background: var(--border); }
  .msg-btn svg { width: 14px; height: 14px; stroke: currentColor; }

  /* Sources Block */
  .sources {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    background: rgba(0, 68, 129, 0.08);
    border: 1px solid var(--border);
  }
  .sources .src-title {
    font-weight: 700;
    color: var(--brand);
    margin-bottom: 6px;
    font-size: var(--mobile-subtle);
  }
  .sources ul { margin: 0; padding: 0 0 0 16px; }
  .sources li {
    margin: 4px 0;
    font-size: var(--mobile-subtle);
    color: var(--text);
  }

  /* Input Area */
  .composer {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 12px 16px max(12px, var(--safe-bottom)) 16px;
    display: flex;
    gap: 12px;
    align-items: flex-end;
    z-index: 200;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
  }

  .input-wrapper {
    flex: 1;
    position: relative;
  }

  #in {
    width: 100%;
    min-height: 48px;
    max-height: 120px;
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 24px;
    background: var(--bg);
    color: var(--text);
    font-size: var(--mobile-text);
    line-height: 1.5;
    font-family: inherit;
    resize: none;
    overflow-y: auto;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }

  #in:focus {
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(0, 68, 129, 0.15);
  }

  #send {
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 50%;
    width: var(--mobile-touch);
    height: var(--mobile-touch);
    min-width: var(--mobile-touch);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: 700;
    transition: transform 0.1s, background 0.2s;
    flex-shrink: 0;
  }

  #send:hover { background: var(--brand-2); }
  #send:active { transform: scale(0.95); }
  #send:disabled { opacity: 0.5; cursor: not-allowed; }
  #send.stop-mode { background: var(--danger); }
  
  #send svg { width: 24px; height: 24px; stroke: currentColor; fill: none; }

  /* Navigation (Bottom Tabs for Mobile) */
  .nav-tabs {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 56px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    display: flex;
    padding-bottom: var(--safe-bottom);
    z-index: 150;
  }

  .nav-tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: var(--mobile-subtle);
    font-weight: 600;
    cursor: pointer;
    transition: color 0.2s;
    padding-top: 6px;
  }

  .nav-tab.active {
    color: var(--brand);
    background: var(--surface-2);
  }

  .nav-tab svg { width: 22px; height: 22px; stroke: currentColor; }

  /* Desktop Layout Override */
  @media (min-width: 768px) {
    .header-badge { display: inline-block !important; }
    .nav-tabs { display: none; }
    .composer { position: relative; padding-bottom: 12px; }
    .chat-scroll { padding-bottom: 24px; }
    
    /* Desktop-only Container */
    .desktop-container {
      display: flex;
      flex-direction: row;
      height: 100%;
    }
    
    .desktop-sidebar {
      width: 280px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .desktop-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
  }

  /* Overlay Modals */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: flex-end;
    z-index: 1000;
    animation: fadeIn 0.2s;
  }
  
  .modal-overlay.open { display: flex; }

  .modal-sheet {
    background: var(--surface);
    width: 100%;
    max-height: 85vh;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }

  .modal-title {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--brand);
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .btn {
    flex: 1;
    padding: 14px 20px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 16px;
    text-align: center;
    border: none;
    cursor: pointer;
    transition: transform 0.1s;
  }
  
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: var(--brand); color: white; }
  .btn-secondary { background: var(--surface-2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--danger); color: white; }

  /* Form Elements in Modals */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: var(--mobile-subtle); }
  .form-control {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 16px;
  }
  .form-control:focus { border-color: var(--brand); outline: none; }

  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  
  .toggle-switch {
    width: 52px;
    height: 28px;
    border-radius: 14px;
    background: var(--border);
    position: relative;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .toggle-switch::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 50%;
    transition: left 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .toggle-switch.active { background: var(--brand); }
  .toggle-switch.active::after { left: 26px; }

  /* Session List */
  .session-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }
  
  .session-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px;
    border-radius: 12px;
    background: var(--surface-2);
    border: 2px solid transparent;
    cursor: pointer;
  }
  
  .session-item.active {
    border-color: var(--brand);
    background: rgba(0, 68, 129, 0.08);
  }
  
  .session-title {
    font-weight: 600;
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .session-actions { display: flex; gap: 8px; }
  
  .icon-btn-sm {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
  }
  
  .icon-btn-sm svg { width: 18px; height: 18px; stroke: var(--text-muted); }

  /* Loading Indicator */
  .loading {
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 4px 0;
  }
  .loading span {
    width: 8px;
    height: 8px;
    background: var(--brand);
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
  }
  .loading span:nth-child(2) { animation-delay: 0.2s; }
  .loading span:nth-child(3) { animation-delay: 0.4s; }
  
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }

  /* Desktop Viewport Overrides */
  @media (min-width: 768px) {
    .header { padding: 12px 24px; }
    .chat-scroll { padding: 24px 40px; }
    .composer { 
      margin: 0 40px 20px 40px; 
      border-radius: 16px; 
      border: 2px solid var(--border);
      box-shadow: var(--shadow-strong);
    }
    .modal-overlay { align-items: center; justify-content: center; }
    .modal-sheet { 
      width: 600px; 
      max-height: 80vh; 
      border-radius: 20px; 
      padding: 30px;
    }
    .session-item { padding: 16px 20px; }
  }

  /* Accessibility */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    border: 0;
  }
  
  /* High Contrast Mode Support */
  @media (prefers-contrast: high) {
    :root {
      --border: #000000;
      --text: #000000;
    }
    body.dark {
      --border: #ffffff;
      --text: #ffffff;
    }
  }
</style>
</head>

<body>
<div id="app">
  <!-- Header -->
  <div class="header">
    <div class="header-title">Linda</div>
    <div id="domain-badge" class="header-badge">üìò Fachmodus</div>
    <button class="header-btn" id="btn-menu" aria-label="Men√º √∂ffnen">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <button class="header-btn" id="btn-settings" aria-label="Einstellungen √∂ffnen">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
  </div>

  <!-- Main Content -->
  <div id="content-area" class="chat-container">
    <div id="log" class="chat-scroll" role="log" aria-live="polite" aria-label="Chat-Verlauf">
      <!-- Messages will be inserted here -->
    </div>
    
    <!-- Input Area -->
    <div class="composer">
      <div class="input-wrapper">
        <textarea id="in" class="in" placeholder="Deine Frage..." aria-label="Deine Frage eingeben" rows="1"></textarea>
      </div>
      <button id="send" aria-label="Nachricht senden">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="nav-tabs">
    <button class="nav-tab" id="nav-chat" data-action="chat">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
      </svg>
      <span>Chat</span>
    </button>
    <button class="nav-tab" id="nav-sessions" data-action="sessions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 6h18"></path>
        <path d="M7 12h10"></path>
        <path d="M10 18h4"></path>
      </svg>
      <span>Verl√§ufe</span>
    </button>
    <button class="nav-tab" id="nav-new" data-action="new">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      <span>Neu</span>
    </button>
  </div>
</div>

<!-- Modals -->
<!-- Privacy Modal -->
<div id="m-privacy" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Datenschutzhinweis</div>
    <div style="line-height: 1.6; color: var(--text-muted);">
      <p style="margin-bottom: 12px;">Um diesen Chatbot nutzen zu k√∂nnen, ist deine Zustimmung zur Datenschutzerkl√§rung erforderlich:</p>
      <ul style="margin-bottom: 16px; padding-left: 20px;">
        <li style="margin-bottom: 8px;">Deine Eingaben werden an OpenAI (USA) und Make (EU) √ºbermittelt.</li>
        <li style="margin-bottom: 8px;">Die √ºbermittelten Daten werden zur Generierung von Antworten verarbeitet.</li>
        <li style="margin-bottom: 8px;">Bitte gib <strong>keine sensiblen oder personenbezogenen Daten</strong> ein!</li>
        <li style="margin-bottom: 8px;">Weitere Informationen: <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a>, <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make.com</a>.</li>
      </ul>
      <p style="font-size: 14px; color: var(--text-muted);">Hinweis: Dein <b>Chatverlauf</b> wird <b>nur lokal</b> auf deinem Ger√§t gespeichert (localStorage).</p>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="p-decline">Ablehnen</button>
      <button class="btn btn-primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<!-- Usage Modal -->
<div id="m-usage" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Wichtige Hinweise</div>
    <ul style="line-height: 1.7; color: var(--text-muted); padding-left: 20px;">
      <li style="margin-bottom: 8px;"><strong>Automatisierte Antworten:</strong> Alle Antworten werden von KI generiert.</li>
      <li style="margin-bottom: 8px;"><strong>Keine Gew√§hr:</strong> Inhalte k√∂nnen unvollst√§ndig/fehlerhaft sein.</li>
      <li style="margin-bottom: 8px;"><strong>Kein Ersatz f√ºr Beratung:</strong> Keine Rechts-, Medizin- oder Finanzberatung.</li>
      <li style="margin-bottom: 8px;"><strong>Eigenverantwortung:</strong> Antworten kritisch hinterfragen.</li>
    </ul>
    <div class="modal-actions">
      <button class="btn btn-primary" id="u-accept">Einverstanden</button>
    </div>
  </div>
</div>

<!-- Sessions Modal -->
<div id="m-sessions" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Verl√§ufe</div>
    <div class="modal-actions" style="margin-bottom: 16px;">
      <button class="btn btn-secondary" id="mob-export-all">Export</button>
      <button class="btn btn-danger" id="mob-clear-all">L√∂schen</button>
    </div>
    <div id="mob-sess-list" class="session-list"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="mob-sess-close">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="m-settings" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Einstellungen</div>
    
    <div class="form-group">
      <label class="form-label">Darstellung</label>
      <select id="sel-theme" class="form-control">
        <option value="light">Hell</option>
        <option value="dark">Dunkel</option>
        <option value="system">System</option>
      </select>
    </div>

    <div class="toggle-row">
      <span>Gender-Sprache</span>
      <div id="sw-gender" class="toggle-switch" role="switch" aria-checked="false"></div>
    </div>
    
    <div class="toggle-row">
      <span>Begr√º√üung anzeigen</span>
      <div id="sw-greet" class="toggle-switch active" role="switch" aria-checked="true"></div>
    </div>

    <div class="form-group">
      <label class="form-label">Fachmodus</label>
      <select id="sel-domain" class="form-control">
        <option value="">‚Äî Kein spezieller Modus ‚Äî</option>
        <option value="AEVO">AEVO</option>
        <option value="VWL">VWL</option>
        <option value="PERSONAL">Personal (Allgemein)</option>
      </select>
    </div>

    <div class="form-group">
      <label class="form-label">Schriftart</label>
      <select id="sel-font" class="form-control">
        <option value="Arial">Arial</option>
        <option value="Inter" selected>Inter</option>
        <option value="Times New Roman">Times New Roman</option>
      </select>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" id="s-close">Abbrechen</button>
      <button class="btn btn-primary" id="s-save">Speichern</button>
    </div>
  </div>
</div>

<!-- Feedback Modal -->
<div id="m-feedback" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Feedback senden</div>
    <p style="color: var(--text-muted); margin-bottom: 16px;">
      Dieses Feedback kannst du direkt in deinem Mailprogramm formulieren.
      <br><br>
      <strong>Hinweis:</strong> Der Chatverlauf wird optional als .txt angeh√§ngt.
    </p>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="fb-cancel">Abbrechen</button>
      <button class="btn btn-primary" id="fb-continue">Weiter</button>
    </div>
  </div>
</div>

<!-- Logik (unver√§ndert von urspr√ºnglichem Code) -->
<script id="linda-context-addon">
(function(){
  if (localStorage.getItem('linda.addon.disabled') === '1') { return; }
  const MAX_CONTEXT_CHARS = 2500;
  function getFachmodus() { const sel = document.getElementById('sel-domain'); if (sel && sel.value) return sel.value; return ''; }
  function buildCompressedContext() {
    let rawSessions = null, sessions = [], activeId = null, session = null;
    try { rawSessions = localStorage.getItem('linda.sessions'); sessions = rawSessions ? JSON.parse(rawSessions) : []; } catch {}
    try { activeId = localStorage.getItem('linda.activeId'); } catch {}
    if (activeId) session = sessions.find(s=>s.id===activeId);
    if (!session && sessions && sessions.length) session = sessions[0];
    if (!session || !Array.isArray(session.messages)) return '';
    let context = '', currentLen = 0, msgs = session.messages;
    for (let i = msgs.length - 1; i >= 0; i--) {
      const m = msgs[i];
      const txt = (m.role==='user'?'User: ':'Linda: ') + (m.content||'') + "\n";
      if (currentLen + txt.length > MAX_CONTEXT_CHARS) break;
      context = txt + context;
      currentLen += txt.length;
    }
    return context;
  }
  const _origFetch = window.fetch.bind(window);
  window.fetch = async function(url, options = {}) {
    try {
      const method = ((options && options.method) || "GET").toUpperCase();
      const isPost = method === "POST";
      const headers = options && options.headers ? options.headers : {};
      const contentType = (headers["Content-Type"] || headers["content-type"] || "").toLowerCase();
      const isJson = contentType.includes("application/json") || (typeof options.body === "string" && options.body.trim().startsWith("{"));
      if (isPost && isJson && typeof options.body === "string") {
        try {
          const body = JSON.parse(options.body);
          const hasMessageLike = (typeof body.message === "string") || (typeof body.question === "string");
          if (body && typeof body === "object" && hasMessageLike && !("context" in body)) {
            const context = buildCompressedContext();
            const fachmodus = getFachmodus();
            const augmented = { ...body, context, fachmodus, user: body.user || "Dozent" };
            options.body = JSON.stringify(augmented);
          }
        } catch (err) {}
      }
    } catch (err) {}
    return _origFetch(url, options);
  };
})();
</script>

<script>
(function(){
  // Prevent default context/copy/cut/paste/select for security
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('copy', e => e.preventDefault());
  document.addEventListener('cut', e => e.preventDefault());
  document.addEventListener('paste', e => e.preventDefault());
  document.addEventListener('selectstart', e => e.preventDefault());

  const uniqueToken = 'Linda-v28.0-Sec-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
  const IS_MOBILE = /Mobi|Android|iPhone/i.test(navigator.userAgent || '');

  const $=id=>document.getElementById(id);
  const LS={
    get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},
    set(k,v){localStorage.setItem(k,JSON.stringify(v))},
    del(k){localStorage.removeItem(k)}
  };

  const S=LS.get('linda.settings',{theme:'light',gender:false,greet:true,domain:'',font:'Inter'});
  let Sessions=LS.get('linda.sessions',[]);
  let activeId=LS.get('linda.activeId',null);
  let abortCtrl = null;

  const md=(txt)=>{
    try {
      const raw = marked.parse(txt, {
        breaks: true,
        gfm: true
      });
      return DOMPurify.sanitize(raw);
    } catch { return txt; }
  };

  const show=m=>{ if(m){ m.classList.add('open'); } }, hide=m=>{ if(m){ m.classList.remove('open'); } };
  const uid=()=> 's_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);

  function saveAll(){ LS.set('linda.settings',S); LS.set('linda.sessions',Sessions); LS.set('linda.activeId',activeId); }

  function applyTheme(){
    if(S.theme==='system'){
      const m=window.matchMedia('(prefers-color-scheme: dark)');
      document.body.classList.toggle('dark',m.matches);
      m.onchange=()=>document.body.classList.toggle('dark',m.matches);
    }else{
      document.body.classList.toggle('dark',S.theme==='dark');
    }
  }

  function applyTypography(){
    const root = document.documentElement;
    if (S.font === 'Inter') root.style.setProperty('--font-body', "'Inter', system-ui, -apple-system, sans-serif");
    else if (S.font === 'Arial') root.style.setProperty('--font-body', "Arial, Helvetica, sans-serif");
    else if (S.font === 'Times New Roman') root.style.setProperty('--font-body', "'Times New Roman', Times, serif");
  }

  function ensureFirstSession(){
    if(!Sessions.length){
      const id=uid();
      Sessions=[{id,name:'Neuer Chat',ts:Date.now(),messages:[]}];
      activeId=id; Sessions[0].id=id; saveAll();
    }
    if(!activeId || !Sessions.find(s=>s.id===activeId)){ activeId=Sessions[0].id; saveAll(); }
  }

  function active(){ return Sessions.find(s=>s.id===activeId); }
  function setActive(id){ activeId=id; saveAll(); renderSessionsMobile(); renderChat(); setBadge(); switchTab('chat'); }
  function addSession(){
    const id=uid();
    Sessions.unshift({id,name:'Neuer Chat',ts:Date.now(),messages:[]});
    setActive(id);
  }

  function renameSession(id){
    const s=Sessions.find(x=>x.id===id); if(!s) return;
    const nn=prompt('Neuer Name f√ºr Verlauf:', s.name||''); if(nn!==null){ s.name=nn.trim()||s.name; saveAll(); renderSessionsMobile(); }
  }
  function deleteSession(id){
    if(!confirm('Diesen Verlauf wirklich l√∂schen?')) return;
    Sessions=Sessions.filter(x=>x.id!==id);
    if(!Sessions.length){ addSession(); } else if(activeId===id){ activeId=Sessions[0].id; }
    saveAll(); renderSessionsMobile(); renderChat(); setBadge();
  }
  function exportSession(id){
    const s=Sessions.find(x=>x.id===id); if(!s) return;
    const text=s.messages.map(m=>(m.role==='user'?'Du: ':'Linda: ')+m.content).join('\n\n');
    const blob=new Blob([text],{type:'text/plain'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=(s.name||'linda_chat')+'.txt'; a.click(); URL.revokeObjectURL(a.href);
  }

  function buildSharePayload(answerText){
    const q = getLastUserQuestion();
    const a = answerText || '';
    const payload = `Frage:\n${q}\n\nAntwort:\n${a}\n`;
    return { q, a, payload };
  }

  function shareAnswer(answerText){
    const { payload } = buildSharePayload(answerText);
    const title = 'Linda ‚Äì Frage & Antwort';
    if (navigator.share) {
      navigator.share({ title, text: payload }).catch(()=>{});
      return;
    }
    const subject = encodeURIComponent(title);
    const body = encodeURIComponent(payload);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  function downloadAnswerPdf(answerText){
    const { q } = buildSharePayload(answerText);
    const now = new Date();
    const dt = now.toLocaleDateString('de-DE') + ', ' + now.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}) + ' Uhr';
    const disclaimer = "Disclaimer: KI-Antworten k√∂nnen unvollst√§ndig oder fehlerhaft sein.";
    const w = window.open('', '_blank', 'width=600,height=800');
    if (!w) return;
    const esc = (s)=>String(s||'').replace(/</g,'&lt;');
    w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Linda ‚Äì Ausdruck</title>
      <style>
        body { font-family: -apple-system, Arial, sans-serif; margin: 0; color: #111; padding: 20px; line-height: 1.6; }
        .header { font-weight: bold; font-size: 18px; color: #004481; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .qbox { background: #eaf3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .qbox .t { font-weight: bold; color: #004481; margin-bottom: 8px; }
        .answer { white-space: pre-wrap; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: #fff; }
        .footer { margin-top: 30px; font-size: 12px; color: #666; border-top: 1px solid #eee; padding-top: 10px; }
      </style>
    </head><body>
      <div class="header">KI-LINDA ‚Äì Chat-Ausdruck</div>
      <div class="qbox"><div class="t">Frage</div><div>${esc(q)}</div></div>
      <div class="answer">${esc(answerText||'')}</div>
      <div class="footer">${esc(dt)}<br><br>${esc(disclaimer)}</div>
    </body></html>`);
    w.document.close(); w.focus(); w.print();
  }

  function buildChatTxt(){
    const s = active();
    if(!s || !Array.isArray(s.messages)) return '';
    const header = `Linda Chat Export\nDatum: ${new Date().toLocaleString('de-DE')}\n\n`;
    const body = s.messages.map(m => (m.role==='user' ? 'Du: ' : 'Linda: ') + (m.content||'')).join('\n\n');
    return header + body + '\n';
  }

  async function openFeedbackMail(){
    const to = 'KI-TEST@GMX.COM';
    const subject = 'Feedback Linda';
    const intro = `Gebe hier bitte Dein Feedback ein:\n\n(Als Anhang wird Dein Chat mitgeschickt, nur wenn Du einverstanden bist.)`;
    const txt = buildChatTxt();
    const filename = 'linda-chat.txt';
    const file = new File([txt], filename, { type: 'text/plain' });

    const canShareFile = !!(navigator.share && navigator.canShare && navigator.canShare({ files: [file] }));

    if (canShareFile) {
      try {
        await navigator.share({ title: subject, text: intro, files: [file] });
      } catch(err) {}
      return;
    }

    try {
      const blob = new Blob([txt], { type: 'text/plain' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename;
      document.body.appendChild(a); a.click(); URL.revokeObjectURL(a.href); a.remove();
    } catch(_) {}

    const mailto = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(intro)}`;
    window.location.href = mailto;
  }

  function addMsg(role, content, isUpdate = false){
    const log = $('log');
    
    if (isUpdate) {
      const last = log.lastElementChild;
      if (last && last.dataset.role === role) {
        last.innerHTML = buildMessageHTML(role, content);
        postProcessMessage(last, content);
        return;
      }
    }

    const d = document.createElement('div');
    d.className = 'message';
    d.dataset.role = role;
    d.innerHTML = buildMessageHTML(role, content);
    
    log.appendChild(d);
    
    const isAtBottom = log.scrollTop + log.clientHeight >= log.scrollHeight - 100;
    if (isAtBottom || role === 'user') {
      log.scrollTop = log.scrollHeight;
    }

    postProcessMessage(d, content);
  }

  function buildMessageHTML(role, content) {
    if (role === 'assistant') {
      return `
        <div class="bubble assistant">
          <div class="md">${md(content)}</div>
        </div>
        <div class="message-actions">
          <button class="msg-btn" data-action="copy">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Kopieren
          </button>
          <button class="msg-btn" data-action="share">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
            Teilen
          </button>
          <button class="msg-btn" data-action="pdf">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            PDF
          </button>
          <button class="msg-btn" data-action="feedback">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            Feedback
          </button>
        </div>
      `;
    } else {
      return `<div class="bubble user"><div class="md">${md(content)}</div></div>`;
    }
  }

  function postProcessMessage(d, content) {
    if (d.dataset.role === 'assistant') {
      // Style sources
      const mdEl = d.querySelector('.md');
      if (mdEl) {
        const headings = Array.from(mdEl.querySelectorAll('h1,h2,h3'));
        const h = headings.find(x => /quellen/i.test((x.textContent||'').trim()));
        if (h) {
          let n = h.nextElementSibling;
          while (n && n.tagName && !/UL|OL/i.test(n.tagName)) n = n.nextElementSibling;
          if (n && /UL|OL/i.test(n.tagName)) {
            const wrap = document.createElement('div');
            wrap.className = 'sources';
            wrap.innerHTML = `<div class="src-title">Quellen</div>`;
            const ul = document.createElement('ul');
            ul.innerHTML = n.innerHTML;
            wrap.appendChild(ul);
            n.replaceWith(wrap);
            h.remove();
          }
        }
      }

      // Attach event listeners to buttons
      const buttons = d.querySelectorAll('.msg-btn');
      const answerText = d.querySelector('.md')?.innerText || '';
      
      buttons.forEach(btn => {
        const action = btn.dataset.action;
        btn.addEventListener('click', () => {
          if (action === 'copy') {
            const payload = buildSharePayload(answerText).payload;
            navigator.clipboard.writeText(payload).then(() => {
              const original = btn.innerHTML;
              btn.innerHTML = '‚úì Kopiert';
              setTimeout(() => btn.innerHTML = original, 1500);
            });
          } else if (action === 'share') {
            shareAnswer(answerText);
          } else if (action === 'pdf') {
            downloadAnswerPdf(answerText);
          } else if (action === 'feedback') {
            show($('m-feedback'));
          }
        });
      });
    }
  }

  function renderChat(){
    $('log').innerHTML = '';
    const s = active();
    if (!s) return;
    s.messages.forEach(m => addMsg(m.role, m.content));
  }

  function push(role, content){ 
    const s = active(); 
    s.messages.push({role, content}); 
    s.ts = Date.now(); 
    saveAll(); 
  }

  function setBadge(){
    const b = $('domain-badge');
    if (S.domain) {
      b.classList.add('active');
      b.textContent = `üìò ${S.domain} ${S.gender ? '‚ö•' : ''}`;
    } else {
      b.classList.remove('active');
      b.textContent = 'üìò Fachmodus';
    }
  }

  function buildHistoryArray() {
    const s = active();
    if (!s || !Array.isArray(s.messages)) return [];
    const msgs = s.messages.slice(-3);
    return msgs.map(m => ({ role: m.role, content: m.content }));
  }

  function getLastUserQuestion(){
    const s = active();
    if (!s || !Array.isArray(s.messages)) return '';
    for (let i = s.messages.length - 1; i >= 0; i--) {
      if (s.messages[i].role === 'user' && s.messages[i].content) return s.messages[i].content;
    }
    return '';
  }

  async function send(){
    const sendBtn = $('send');
    const inp = $('in');

    if (abortCtrl) {
      abortCtrl.abort();
      abortCtrl = null;
      sendBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      `;
      sendBtn.classList.remove('stop-mode');
      const s = active();
      if (s.messages.length > 0 && s.messages[s.messages.length-1].content.includes('‚è≥')) {
        s.messages[s.messages.length-1] = {role:'assistant',content:'üõë Generierung abgebrochen.'};
        saveAll();
        renderChat();
      }
      return;
    }

    const q = inp.value.trim();
    if (!q) return;
    
    // Reset textarea height
    inp.style.height = 'auto';
    inp.value = '';

    sendBtn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <line x1="6" y1="6" x2="18" y2="18"></line>
        <line x1="6" y1="18" x2="18" y2="6"></line>
      </svg>
    `;
    sendBtn.classList.add('stop-mode');
    sendBtn.disabled = true;

    push('user', q);
    addMsg('user', q);
    push('assistant', '<div class="loading"><span></span><span></span><span></span></div>');
    addMsg('assistant', '<div class="loading"><span></span><span></span><span></span></div>');

    abortCtrl = new AbortController();

    try {
      const historyArray = buildHistoryArray();
      const payload = {
        question: q,
        fachmodus: S.domain || '',
        token: uniqueToken,
        history: historyArray
      };

      const r = await fetch('/api/bot', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
        signal: abortCtrl.signal
      });

      const text = await r.text();
      const out = (text && text.trim().toLowerCase() !== 'accepted') ? text : 'Ich habe deine Frage erhalten ‚Äì bitte erneut senden, falls nichts erscheint.';

      const s = active();
      s.messages[s.messages.length - 1] = {role: 'assistant', content: out};
      saveAll();
      renderChat();

    } catch (e) {
      const s = active();
      s.messages[s.messages.length - 1] = {role: 'assistant', content: 'Es gab ein Verbindungsproblem. Bitte versuche es erneut.'};
      saveAll();
      renderChat();
    } finally {
      sendBtn.innerHTML = `
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      `;
      sendBtn.classList.remove('stop-mode');
      sendBtn.disabled = false;
      abortCtrl = null;
      $('in').focus();
    }
  }

  // Tab Navigation
  function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    
    if (tab === 'chat') {
      $('nav-chat').classList.add('active');
      $('content-area').style.display = 'flex';
      hide($('m-sessions'));
    } else if (tab === 'sessions') {
      $('nav-sessions').classList.add('active');
      show($('m-sessions'));
      renderSessionsMobile();
    } else if (tab === 'new') {
      $('nav-new').classList.add('active');
      setTimeout(() => {
        addSession();
        switchTab('chat');
      }, 100);
    }
  }

  // Mobile Session List Renderer
  function renderSessionsMobile() {
    const el = $('mob-sess-list');
    if (!el) return;

    const limit = 10; // Show all on mobile for now
    const sessions = Sessions.slice(0, limit);

    el.innerHTML = sessions.map(s => `
      <div class="session-item ${s.id === activeId ? 'active' : ''}" data-id="${s.id}">
        <div class="session-title">${s.name || 'Chat'}</div>
        <div class="session-actions">
          <button class="icon-btn-sm" data-action="rename" data-id="${s.id}" title="Umbenennen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
          <button class="icon-btn-sm" data-action="export" data-id="${s.id}" title="Exportieren">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
          <button class="icon-btn-sm" data-action="delete" data-id="${s.id}" title="L√∂schen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
          </button>
        </div>
      </div>
    `).join('');

    // Session selection
    el.querySelectorAll('.session-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const id = item.dataset.id;
        if (e.target.closest('.session-actions')) return;
        setActive(id);
        hide($('m-sessions'));
      });
    });

    // Action buttons
    el.querySelectorAll('[data-action="rename"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        renameSession(btn.dataset.id);
      });
    });
    el.querySelectorAll('[data-action="export"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        exportSession(btn.dataset.id);
      });
    });
    el.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteSession(btn.dataset.id);
      });
    });
  }

  // Event Listeners
  $('send').addEventListener('click', send);
  $('in').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // Auto-resize textarea
  $('in').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
  });

  // Modal buttons
  $('p-accept').addEventListener('click', () => {
    hide($('m-privacy'));
    if ($('m-usage')) {
      show($('m-usage'));
      return;
    }
    handleUsageAccept();
  });
  $('p-decline').addEventListener('click', () => location.reload());
  $('u-accept').addEventListener('click', () => {
    hide($('m-usage'));
    handleUsageAccept();
  });

  $('fb-cancel').addEventListener('click', () => hide($('m-feedback')));
  $('fb-continue').addEventListener('click', async () => {
    hide($('m-feedback'));
    await openFeedbackMail();
  });

  function handleUsageAccept(){
    const s = active();
    if (S.greet && s.messages.length === 0) {
      push('assistant', '**Willkommen!** Nutze mich f√ºr AEVO, VWL und Personalthemen. √ñffne *Einstellungen* (Fachmodus-K√ºrzel).');
      addMsg('assistant', '**Willkommen!** Nutze mich f√ºr AEVO, VWL und Personalthemen. √ñffne *Einstellungen* (Fachmodus-K√ºrzel).');
    }
  }

  // Menu Actions
  $('btn-menu').addEventListener('click', () => {
    show($('m-sessions'));
    renderSessionsMobile();
  });

  $('btn-settings').addEventListener('click', () => {
    // Populate form
    $('sel-theme').value = S.theme;
    $('sel-domain').value = S.domain;
    $('sel-font').value = S.font;
    
    // Update toggles
    const swGender = $('sw-gender');
    const swGreet = $('sw-greet');
    
    if (S.gender) swGender.classList.add('active'); else swGender.classList.remove('active');
    swGender.setAttribute('aria-checked', S.gender);
    
    if (S.greet) swGreet.classList.add('active'); else swGreet.classList.remove('active');
    swGreet.setAttribute('aria-checked', S.greet);

    show($('m-settings'));
  });

  // Toggle Switches
  $('sw-gender').addEventListener('click', () => {
    const el = $('sw-gender');
    S.gender = !S.gender;
    el.classList.toggle('active', S.gender);
    el.setAttribute('aria-checked', S.gender);
  });

  $('sw-greet').addEventListener('click', () => {
    const el = $('sw-greet');
    S.greet = !S.greet;
    el.classList.toggle('active', S.greet);
    el.setAttribute('aria-checked', S.greet);
  });

  // Settings Save
  $('s-save').addEventListener('click', () => {
    S.theme = $('sel-theme').value;
    S.domain = $('sel-domain').value;
    S.font = $('sel-font').value;
    
    saveAll();
    applyTheme();
    applyTypography();
    setBadge();
    hide($('m-settings'));
  });

  $('s-close').addEventListener('click', () => hide($('m-settings')));

  // Modal close handlers
  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', (e) => {
      if (e.target === m) hide(m);
    });
  });

  // Session Modal buttons
  $('mob-sess-close').addEventListener('click', () => hide($('m-sessions')));
  $('mob-export-all').addEventListener('click', () => {
    const all = Sessions.map(s => 
      `# ${s.name || 'Chat'} (${new Date(s.ts).toLocaleString()})\n\n` +
      s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + (m.content || '')).join('\n\n')
    ).join('\n\n---\n\n');
    const blob = new Blob([all], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'linda_all_chats.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $('mob-clear-all').addEventListener('click', () => {
    if (confirm('Wirklich alle Verl√§ufe l√∂schen?')) {
      Sessions = [];
      addSession();
      saveAll();
      renderSessionsMobile();
      renderChat();
      setBadge();
    }
  });

  // Bottom Navigation
  $('nav-chat').addEventListener('click', () => switchTab('chat'));
  $('nav-sessions').addEventListener('click', () => switchTab('sessions'));
  $('nav-new').addEventListener('click', () => switchTab('new'));

  // Initialize
  ensureFirstSession();
  applyTheme();
  applyTypography();
  setBadge();
  renderSessionsMobile();
  renderChat();

  // Set active tab
  $('nav-chat').classList.add('active');

})();
</script>
</body>
</html>
