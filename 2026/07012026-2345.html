<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Linda ‚Äì Deine pers√∂nliche Assistentin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

<style>
  :root {
    --font-body: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    --font-size: 13px;

    --bg: #ffffff;
    --panel: #f8f9fa;
    --line: #e9ecef;
    --text: #1a1a1a;
    --muted: #666;

    --brand: #051c2c;
    --brand-2: #004481;
    --accent: #0071ce;

    --shadow: 0 4px 12px rgba(0,0,0,0.06);
    --radius: 4px;
    --transition: all 0.2s ease;
  }

  body.dark {
    --bg: #121212;
    --panel: #1e1e1e;
    --line: #333;
    --text: #e0e0e0;
    --muted: #a0a0a0;
    --brand: #ffffff;
    --brand-2: #64b5f6;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; font-family: var(--font-body); font-size: var(--font-size); background: var(--bg); color: var(--text); line-height: 1.6; }
  a { color: var(--accent); text-decoration: none; transition: var(--transition); }
  a:hover { text-decoration: underline; }

  .app-layout { display: flex; flex-direction: column; height: 100vh; }

  .top {
    flex-shrink: 0;
    background: #fff;
    border-bottom: 1px solid var(--line);
    padding: 0 2rem;
    height: 64px;
    display: flex; align-items: center; justify-content: space-between;
    z-index: 50;
  }
  .brand { font-weight: 700; font-size: 1.25rem; color: var(--brand); letter-spacing: -0.01em; }

  .badge {
    display: inline-flex; align-items: center; gap: 0.5rem;
    background: #f0f4f8; color: var(--brand-2);
    border: 1px solid #dceefb;
    padding: 0.3rem 0.8rem;
    border-radius: 99px;
    font-size: 0.8rem; font-weight: 500;
  }

  .icon-btn { appearance: none; border: 0; background: transparent; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: var(--transition); color: var(--text); }
  .icon-btn:hover { background: rgba(0,0,0,0.04); }

  .main-content { flex: 1; display: flex; overflow: hidden; position: relative; }

  .sidebar {
    width: 280px;
    background: var(--panel);
    border-right: 1px solid var(--line);
    display: flex; flex-direction: column;
    flex-shrink: 0;
  }
  .avatar-area { padding: 2rem 1.5rem; text-align: center; border-bottom: 1px solid var(--line); }
  .avatar-area img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .avatar-area .name { font-weight: 600; font-size: 1.1rem; color: var(--brand); }

  .session-list { flex: 1; overflow-y: auto; padding: 1rem; }
  .sess-item {
    padding: 0.8rem 1rem; margin-bottom: 0.5rem;
    border-radius: var(--radius); cursor: pointer;
    font-size: 0.9rem; color: var(--text);
    transition: var(--transition);
    display: flex; justify-content: space-between; align-items: center;
  }
  .sess-item:hover { background: rgba(0,0,0,0.04); }
  .sess-item.active { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-weight: 500; border-left: 3px solid var(--brand-2); }
  .sess-item .actions { opacity: 0; display: flex; gap: 4px; }
  .sess-item:hover .actions { opacity: 1; }

  .sess-btn { border: none; background: transparent; cursor: pointer; font-size: 1rem; color: var(--muted); padding: 2px 4px; }
  .sess-btn:hover { color: var(--brand-2); }

  .chat-wrapper { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }

  .log {
    flex: 1;
    overflow-y: auto;
    padding: 2rem 15%;
    scroll-behavior: smooth;
    display: flex; flex-direction: column; gap: 2rem;
  }

  .bubble { max-width: 100%; position: relative; line-height: 1.7; font-size: 1rem; }

  .bubble.me {
    align-self: flex-end;
    background: #f0f2f5;
    color: var(--text);
    padding: 1rem 1.5rem;
    border-radius: 12px 12px 0 12px;
    max-width: 70%;
  }

  .bubble:not(.me) { align-self: flex-start; padding-right: 2rem; width: 100%; }

  .bubble .md h1, .bubble .md h2, .bubble .md h3 {
    margin: 1.5rem 0 0.8rem;
    font-weight: 700;
    color: var(--brand);
    letter-spacing: -0.01em;
  }
  .bubble .md h1 { font-size: 1.4rem; }
  .bubble .md h2 { font-size: 1.25rem; }
  .bubble .md p { margin-bottom: 1rem; }
  .bubble .md ul, .bubble .md ol { margin-bottom: 1rem; padding-left: 1.5rem; }
  .bubble .md li { margin-bottom: 0.5rem; }
  .bubble .md strong { font-weight: 600; color: #000; }

  .bubble-header {
    display: flex; justify-content: flex-end; gap: 0.5rem;
    margin-bottom: 0.25rem; opacity: 0.7; transition: opacity 0.2s;
  }
  .bubble:hover .bubble-header { opacity: 1; }

  .action-pill {
    appearance: none; border: 1px solid var(--line); background: #fff;
    border-radius: 4px; padding: 2px 8px; font-size: 0.75rem;
    color: var(--muted); cursor: pointer; display: flex; align-items: center; gap: 4px;
    transition: var(--transition);
  }
  .action-pill:hover { border-color: var(--brand-2); color: var(--brand-2); }

  .composer-wrapper {
    flex-shrink: 0;
    padding: 1.5rem 15%;
    background: var(--bg);
    border-top: 1px solid var(--line);
    position: sticky; bottom: 0;
  }
  .composer {
    display: flex; gap: 0.75rem; align-items: flex-end;
    background: #fff; border: 1px solid #ccc;
    border-radius: 8px; padding: 0.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: border 0.2s;
  }

  .in {
    flex: 1; border: none; outline: none; resize: none;
    max-height: 200px; min-height: 24px;
    font-family: inherit; font-size: 1rem; padding: 0.5rem;
    background: transparent; color: var(--text);
  }

  .send-btn {
    appearance: none; border: none; background: var(--brand-2); color: #fff;
    width: 36px; height: 36px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: var(--transition);
  }
  .send-btn:hover { background: var(--brand); }
  .send-btn:disabled { opacity: 0.6; cursor: not-allowed; }
  .send-btn svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

  .sources {
    margin-top: 1.5rem; padding: 1rem;
    background: #f8f9fa; border-left: 3px solid var(--brand-2);
    font-size: 0.9rem;
  }
  .sources .src-title { font-weight: 600; margin-bottom: 0.5rem; color: var(--brand); text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem; }
  .sources ul { margin: 0; padding: 0; list-style: none; }
  .sources li { display: inline-block; background: #fff; border: 1px solid var(--line); padding: 2px 8px; border-radius: 4px; margin: 0 4px 4px 0; font-size: 0.85rem; color: var(--muted); }

  @media (max-width: 768px) {
    .sidebar { display: none; }
    .top { padding: 0 1rem; height: 56px; border-bottom: 1px solid #eee; }
    .brand { font-size: 1.1rem; }

    .log { padding: 1rem; gap: 1.5rem; }

    .bubble.me {
      background: #f2f2f2;
      border-radius: 8px;
      padding: 0.8rem 1rem;
      font-size: 0.95rem;
      max-width: 85%;
    }

    .bubble:not(.me) {
      padding-right: 0;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .bubble:not(.me):last-child { border-bottom: none; }

    .bubble .md h1, .bubble .md h2 { font-size: 1.2rem; margin-top: 1rem; }
    .bubble .md p { margin-bottom: 0.8rem; color: #333; }

    .composer-wrapper {
      padding: 0.75rem 1rem;
      border-top: 1px solid #eee;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
    }
    .composer { border-radius: 20px; padding: 0.4rem 0.8rem; background: #f2f2f2; border: 1px solid transparent; box-shadow: none; }
    .in { font-size: 16px; padding: 0.5rem 0; } /* iOS Zoom vermeiden */
    .send-btn { width: 32px; height: 32px; border-radius: 50%; background: #000; }

    .mobile-actions { display: flex; gap: 0.5rem; }
    .m-btn { font-size: 0.8rem; font-weight: 600; padding: 0.4rem 0.8rem; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; color: #333; }
  }

  .footer { text-align: center; font-size: 0.75rem; color: #999; padding: 1rem; }

  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); z-index: 1000; display: none; align-items: center; justify-content: center; }
  .card { background: #fff; width: min(90vw, 500px); border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; max-height: 85vh; }
  .card-h { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--line); font-weight: 600; font-size: 1.1rem; color: var(--brand); display: flex; justify-content: space-between; align-items: center; }
  .card-b { padding: 1.5rem; overflow-y: auto; line-height: 1.6; }
  .card-f { padding: 1rem 1.5rem; border-top: 1px solid var(--line); display: flex; justify-content: flex-end; gap: 0.75rem; background: #fcfcfc; }

  .btn { appearance: none; border: 1px solid var(--line); background: #fff; padding: 0.6rem 1.2rem; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: var(--transition); }
  .btn:hover { background: #f8f9fa; border-color: #ccc; }
  .btn.primary { background: var(--brand-2); color: #fff; border-color: var(--brand-2); }
  .btn.primary:hover { background: var(--brand); }

  .set-row { margin-bottom: 1.2rem; }
  .set-label { display: block; font-weight: 500; margin-bottom: 0.4rem; font-size: 0.9rem; }
  .set-in { width: 100%; padding: 0.6rem; border: 1px solid var(--line); border-radius: 4px; font-family: inherit; }
  .switch { display: inline-flex; align-items: center; cursor: pointer; gap: 0.75rem; user-select: none; }
  .toggle { width: 40px; height: 22px; background: #e0e0e0; border-radius: 11px; position: relative; transition: 0.3s; }
  .toggle::after { content:''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: #fff; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
  .switch.on .toggle { background: var(--brand-2); }
  .switch.on .toggle::after { transform: translateX(18px); }

  @media print {
    html, body { height: auto !important; overflow: visible !important; }
    .app-layout { height: auto !important; display: block !important; }
    .top, .composer-wrapper, .sidebar, .footer, .bubble-header, .mobile-actions { display: none !important; }
    .main-content { overflow: visible !important; display: block !important; }
    .log { padding: 0 !important; overflow: visible !important; }
    .chat-wrapper { background: #fff !important; }
    .bubble { page-break-inside: avoid; border: none !important; padding: 0 !important; margin-bottom: 2rem !important; color: #000 !important; }
    .bubble.me { background: none !important; border-left: 3px solid #ccc !important; padding-left: 1rem !important; font-style: italic; }
  }
</style>
</head>
<body>

<div id="m-privacy" class="modal" style="display:flex">
  <div class="card">
    <div class="card-h">Datenschutz</div>
    <div class="card-b">
      <p>Willkommen bei Linda.</p>
      <ul style="margin:1rem 0 1rem 1.5rem; font-size:0.95rem; color:var(--text)">
        <li>Deine Eingaben werden zur Verarbeitung √ºber einen Proxy an OpenAI gesendet (Vercel API Route).</li>
        <li>Zus√§tzlich wird Make.com f√ºr die Verarbeitung genutzt (serverseitig, nicht im Browser sichtbar).</li>
        <li>Bitte gib <strong>keine sensiblen Daten</strong> ein ‚Äì insbesondere keine Gesundheitsdaten, Kontonummern/IBAN oder Kreditkartendaten.</li>
        <li>Der Chatverlauf wird lokal in deinem Browser gespeichert.</li>
      </ul>
      <p style="font-size:0.85rem; color:var(--muted)">Durch Klick auf "Zustimmen" akzeptierst du die Verarbeitung.</p>
    </div>
    <div class="card-f">
      <button class="btn" onclick="location.reload()">Ablehnen</button>
      <button class="btn primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<div id="m-settings" class="modal">
  <div class="card">
    <div class="card-h">Einstellungen <button class="icon-btn" id="s-close-x">‚úï</button></div>
    <div class="card-b">
      <div class="set-row">
        <label class="set-label">Fachmodus</label>
        <select id="sel-domain" class="set-in">
          <option value="">‚Äî Allgemein ‚Äî</option>
          <option value="AEVO">AEVO (Ausbilder)</option>
          <option value="Personal">Personal / HR</option>
          <option value="Recht">Recht & Compliance</option>
          <option value="VWL">VWL & Wirtschaft</option>
        </select>
      </div>
      <div class="set-row">
        <div class="switch" id="sw-gender">
          <div class="toggle"></div>
          <span>Gendergerechte Sprache nutzen</span>
        </div>
      </div>
      <div class="set-row">
        <label class="set-label">Schriftgr√∂√üe</label>
        <select id="sel-size" class="set-in">
          <option value="12">Klein</option>
          <option value="14">Mittel (Standard)</option>
          <option value="16">Gro√ü</option>
        </select>
      </div>
      <div style="margin-top:2rem; border-top:1px solid var(--line); padding-top:1rem">
        <div class="set-label">Datenverwaltung</div>
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap">
          <button class="btn" id="btn-export-all">Backup (.txt)</button>
          <button class="btn" id="btn-clear-all" style="color:#d32f2f; border-color:#d32f2f">Alles l√∂schen</button>
        </div>
      </div>
    </div>
    <div class="card-f">
      <button class="btn primary" id="s-save">Speichern</button>
    </div>
  </div>
</div>

<div id="m-history" class="modal">
  <div class="card">
    <div class="card-h">Verl√§ufe <button class="icon-btn" id="h-close">‚úï</button></div>
    <div class="card-b">
      <button class="btn primary" id="mob-new-chat" style="width:100%; margin-bottom:1rem">+ Neuer Chat</button>
      <div id="mob-sess-list"></div>
    </div>
  </div>
</div>

<div class="app-layout">
  <header class="top">
    <div style="display:flex; align-items:center; gap:1rem">
      <div class="brand">Linda</div>
      <div id="badge-domain" class="badge" style="display:none"></div>
    </div>

    <div class="mobile-actions">
      <button class="m-btn" id="mob-open-history">Verl√§ufe</button>
      <button class="icon-btn" id="mob-settings">‚öô</button>
    </div>

    <div style="display:none;" id="desktop-actions">
      <button class="icon-btn" id="dt-settings">‚öô</button>
    </div>
  </header>

  <div class="main-content">
    <aside class="sidebar">
      <div class="avatar-area">
        <div style="width:64px; height:64px; background:#e1e4e8; border-radius:50%; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; font-size:1.5rem">üë©‚Äçüíº</div>
        <div class="name">Linda</div>
        <div style="font-size:0.8rem; color:var(--muted); margin-top:0.2rem">Pers√∂nliche Assistentin</div>
      </div>
      <div style="padding:1rem 1rem 0; font-weight:600; font-size:0.85rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.05em">Chats</div>
      <div id="sess-list" class="session-list"></div>
      <div style="padding:1rem; border-top:1px solid var(--line)">
        <button class="btn" id="dt-new-chat" style="width:100%">+ Neuer Chat</button>
        <button class="btn" id="dt-open-settings" style="width:100%; margin-top:0.5rem">Einstellungen</button>
      </div>
    </aside>

    <div class="chat-wrapper">
      <div id="log" class="log"></div>

      <div class="composer-wrapper">
        <div class="composer">
          <textarea id="in" class="in" rows="1" placeholder="Frag Linda etwas..."></textarea>
          <button id="send" class="send-btn" title="Senden">
            <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
      </div>

      <div class="footer">&copy; 2025 Linda Assistent. Vertraulich.</div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ========= Konfiguration ========= */
  const BOT_ENDPOINT = "/api/linda-proxy";     // Vercel Route Handler (Make bleibt serverseitig)
  const HISTORY_TURNS = 3;

  /* ========= marked & Sanitizing ========= */
  marked.setOptions({ mangle:false, headerIds:false, breaks:true });

  function mdToSafeHtml(markdownText){
    const raw = marked.parse(String(markdownText || ""));
    // DOMPurify: blockt gef√§hrliche Tags/Attribute
    return DOMPurify.sanitize(raw, {
      USE_PROFILES: { html: true },
      FORBID_TAGS: ["script","style","iframe","object","embed","link","meta"],
      FORBID_ATTR: ["onerror","onload","onclick","onmouseover","onfocus","onmouseenter","onmouseleave"]
    });
  }

  function hardenLinks(root){
    try{
      (root||document).querySelectorAll("a[href]").forEach(a=>{
        const href = a.getAttribute("href") || "";
        if (/^https?:\/\//i.test(href)){
          a.setAttribute("target","_blank");
          a.setAttribute("rel","noopener noreferrer");
        }
      });
    }catch(_){}
  }

  /* ========= Utilities ========= */
  const $ = id => document.getElementById(id);
  const LS = {
    get: (k,d) => { try { return JSON.parse(localStorage.getItem(k)) || d } catch { return d } },
    set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
  };
  const uid = () => 's_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
  const esc = txt => (txt||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  function looksSensitive(input){
    const s = String(input||"");
    const compact = s.replace(/\s+/g,'');
    const iban = /\b[A-Z]{2}\d{2}[A-Z0-9]{11,30}\b/;
    const cc = /\b(?:\d[ -]*?){13,19}\b/;
    const health = /\b(diagnose|symptom|krankenakte|medikation|impfung|blutdruck|krankheit|arzt|patient)\b/i;
    return iban.test(compact) || cc.test(s) || health.test(s);
  }

  /* ========= State ========= */
  let Settings = LS.get('linda_s', { domain:'', gender:false, fontSize:'14' });
  let Sessions = LS.get('linda_h', []);
  let ActiveId = LS.get('linda_act', null);

  /* ========= Logic ========= */
  function init(){
    if(!Sessions.length) createSession();
    if(!ActiveId || !Sessions.find(s=>s.id===ActiveId)) ActiveId = Sessions[0].id;

    applySettings();
    renderSidebar();
    renderChat();

    $('in').focus();

    $('send').onclick = send;
    $('in').onkeydown = e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }};

    $('in').oninput = function(){
      this.style.height='auto';
      this.style.height = Math.min(this.scrollHeight, 150)+'px';
    };

    $('p-accept').onclick = () => { $('m-privacy').style.display='none'; checkWelcome(); };

    $('dt-open-settings').onclick = $('mob-settings').onclick = () => $('m-settings').style.display='flex';
    $('s-close-x').onclick = () => $('m-settings').style.display='none';
    $('s-save').onclick = saveSettings;
    $('sw-gender').onclick = function(){ this.classList.toggle('on'); };

    $('mob-open-history').onclick = () => { renderMobileList(); $('m-history').style.display='flex'; };
    $('h-close').onclick = () => $('m-history').style.display='none';

    $('dt-new-chat').onclick = $('mob-new-chat').onclick = () => { createSession(); $('m-history').style.display='none'; };
    $('btn-clear-all').onclick = () => { if(confirm('Alles l√∂schen?')) { Sessions=[]; createSession(); save(); location.reload(); }};
    $('btn-export-all').onclick = exportAll;
  }

  function checkWelcome(){
    const s = getActive();
    if(s && s.msgs.length === 0){
      pushMsg('assistant', 'Hallo! Ich bin Linda. Wie kann ich dich heute unterst√ºtzen?');
    }
  }

  function createSession(){
    const id = uid();
    Sessions.unshift({ id, title:'Neuer Chat', msgs:[], ts:Date.now() });
    ActiveId = id;
    save();
    renderSidebar();
    renderChat();
    checkWelcome();
  }

  function getActive(){ return Sessions.find(s=>s.id===ActiveId); }

  function switchSession(id){
    ActiveId = id;
    save();
    renderSidebar();
    renderChat();
    try { $('m-history').style.display='none'; } catch(_){}
  }

  function deleteSession(e, id){
    e.stopPropagation();
    if(!confirm('Chat l√∂schen?')) return;
    Sessions = Sessions.filter(s=>s.id!==id);
    if(!Sessions.length) createSession();
    else if(ActiveId===id) ActiveId=Sessions[0].id;
    save(); renderSidebar(); renderChat();
  }

  function save(){
    LS.set('linda_h', Sessions);
    LS.set('linda_act', ActiveId);
  }

  function pushMsg(role, content){
    const s = getActive();
    s.msgs.push({ role, content });

    if(role==='user' && s.msgs.length <= 3){
      s.title = content.substring(0, 30) + (content.length>30?'...':'');
    }
    s.ts = Date.now();
    save();
    renderChat();
    renderSidebar();
  }

  function buildHistory(){
    const s = getActive();
    if(!s) return [];
    const last = s.msgs.slice(-HISTORY_TURNS*2); // grob
    return last.map(m => ({ role: m.role === 'assistant' ? 'assistant' : 'user', content: m.content }));
  }

  function systemPrefix(){
    const lines=[];
    if(Settings.domain){
      const map={
        'AEVO':'Antworte fachlich fundiert im AEVO-Kontext mit kurzer Pr√ºfungsrelevanz.',
        'Personal':'Antworte als Expertin f√ºr Personal/HR mit Praxisbeispiel.',
        'Recht':'Antworte juristisch sauber (Normen nennen) und praxisnah.',
        'VWL':'Antworte fachlich fundiert in Volkswirtschaftslehre (IHK-Pr√ºfungskontext).'
      };
      lines.push(map[Settings.domain]||'');
    }
    lines.push(Settings.gender ? 'Verwende gendergerechte Sprache (neutral, inklusiv, gut lesbar).' : 'Verwende neutrale, nicht gegenderte Sprache.');
    lines.push('Strukturiere Antworten klar und pr√ºfungsrelevant; wenn m√∂glich mit kurzen Quellenhinweisen.');
    return lines.filter(Boolean).join('\n');
  }

  async function send(){
    const el = $('in');
    const text = el.value.trim();
    if(!text) return;

    if (looksSensitive(text)){
      alert('Bitte keine sensiblen Daten eingeben (insbesondere keine Gesundheitsdaten, Kontonummern/IBAN oder Kreditkartendaten).');
      return;
    }

    el.value='';
    el.style.height='auto';
    $('send').disabled=true;

    pushMsg('user', text);
    // Placeholder als Plaintext (kein HTML)
    pushMsg('assistant', '‚Ä¶ schreibt ‚Ä¶');

    try{
      const payload = {
        fachmodus: Settings.domain || '',
        question: systemPrefix() + "\n\n" + text,
        history: buildHistory()
      };

      const res = await fetch(BOT_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const outText = await res.text();
      const responseText = outText && outText.trim() ? outText : 'Keine Antwort erhalten.';

      const s = getActive();
      s.msgs.pop(); // placeholder raus
      s.msgs.push({ role:'assistant', content: responseText });
      save();
      renderChat();
    }catch(err){
      console.error(err);
      const s = getActive();
      s.msgs.pop();
      s.msgs.push({ role:'assistant', content: '‚ùå Senden fehlgeschlagen. Pr√ºfe /api/linda-proxy auf Vercel (Network/Console).' });
      save();
      renderChat();
    }finally{
      $('send').disabled=false;
      $('in').focus();
    }
  }

  /* ========= Rendering ========= */
  function renderSidebar(){
    const list = Sessions.map(s => `
      <div class="sess-item ${s.id===ActiveId?'active':''}" onclick="activeSession('${s.id}')">
        <div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1">${esc(s.title)}</div>
        <div class="actions">
          <button class="sess-btn" onclick="delSession(event,'${s.id}')">√ó</button>
        </div>
      </div>
    `).join('');
    $('sess-list').innerHTML = list;

    window.activeSession = switchSession;
    window.delSession = deleteSession;
  }

  function renderMobileList(){
    $('mob-sess-list').innerHTML = $('sess-list').innerHTML;
  }

  function renderChat(){
    const s = getActive();
    const log = $('log');
    if(!s) return;

    log.innerHTML = s.msgs.map(m => {
      const isMe = m.role === 'user';

      let html = '';
      if (!isMe) {
        // Bot: sanitize
        html = mdToSafeHtml(m.content);
      } else {
        // User: plain text (optional markdown, aber sicherer als HTML)
        html = '<p>' + esc(m.content).replace(/\n/g,'<br>') + '</p>';
      }

      let actions = '';
      if(!isMe && m.content !== '‚Ä¶ schreibt ‚Ä¶'){
        actions = `
          <div class="bubble-header">
             <button class="action-pill" onclick="copyText(this)">üìã Kopieren</button>
             <button class="action-pill" onclick="shareText(this)">‚Üó Teilen</button>
             <button class="action-pill" onclick="printChat()">üñ® PDF</button>
          </div>
        `;
      }

      const bubble = `
        <div class="bubble ${isMe?'me':''}">
          ${actions}
          <div class="md">${html}</div>
          <div style="display:none" class="raw-text">${esc(m.content)}</div>
        </div>
      `;
      return bubble;
    }).join('');

    // Links h√§rten
    hardenLinks(log);

    log.scrollTop = log.scrollHeight;
  }

  /* ========= Features ========= */
  window.shareText = async (btn) => {
    const bubble = btn.closest('.bubble');
    const cleanText = bubble.querySelector('.md').innerText;

    if(navigator.share){
      try {
        await navigator.share({ title: 'Antwort von Linda', text: cleanText });
      } catch(err) { console.log(err); }
    } else {
      copyText(btn);
    }
  };

  window.copyText = (btn) => {
    const txt = btn.closest('.bubble').querySelector('.md').innerText;
    navigator.clipboard.writeText(txt).then(() => {
      const old = btn.innerHTML;
      btn.innerHTML = '‚úî Kopiert';
      setTimeout(()=>btn.innerHTML=old, 1500);
    });
  };

  window.printChat = () => {
    setTimeout(() => window.print(), 250);
  };

  window.exportAll = () => {
    const txt = Sessions.map(s => `--- ${s.title} ---\n` + s.msgs.map(m=> `${m.role}: ${m.content}`).join('\n\n')).join('\n\n=================\n\n');
    const blob = new Blob([txt], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'Linda_Backup.txt';
    a.click();
  };

  /* ========= Settings ========= */
  function applySettings(){
    $('sel-domain').value = Settings.domain;
    if(Settings.gender) $('sw-gender').classList.add('on'); else $('sw-gender').classList.remove('on');
    $('sel-size').value = Settings.fontSize;

    document.documentElement.style.setProperty('--font-size', Settings.fontSize + 'px');

    const b = $('badge-domain');
    if(Settings.domain){
      b.style.display='inline-flex';
      b.textContent = Settings.domain;
    } else {
      b.style.display='none';
    }
  }

  function saveSettings(){
    Settings.domain = $('sel-domain').value;
    Settings.gender = $('sw-gender').classList.contains('on');
    Settings.fontSize = $('sel-size').value;
    LS.set('linda_s', Settings);
    applySettings();
    $('m-settings').style.display='none';
  }

  init();
})();
</script>
</body>
</html>
