<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>Linda ‚Äì Deine pers√∂nliche Assistentin 2026.01</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

<style>
  :root {
    /* Schriftart-Stack: Aptos (Segoe UI modern), Arial, Standard */
    --font-stack: 'Aptos', 'Segoe UI', Arial, Helvetica, sans-serif;
    
    /* Gr√∂√üen */
    --base-font-size: 17px; /* Kompakte Lesegr√∂√üe */
    --header-size: 20px;
    
    /* Farben */
    --bg: #ffffff;
    --surface: #f8f9fa;
    --surface-2: #ffffff;
    --border: #e9ecef;
    --text: #1a1a1a;
    --text-muted: #6c757d;
    --brand: #004481;
    --brand-2: #0071ce;
    --brand-light: #e6f0fa;
    --danger: #dc3545;
    
    --mobile-touch: 48px;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: var(--font-stack); font-size: var(--base-font-size); background: var(--bg); color: var(--text); height: 100dvh; overflow: hidden; -webkit-font-smoothing: antialiased; }

  /* Layout */
  #app { display: flex; flex-direction: column; height: 100%; height: 100dvh; position: relative; }

  /* Header */
  .header {
    flex: 0 0 auto; display: flex; align-items: center; gap: 12px;
    padding: max(12px, var(--safe-top)) 16px 12px 16px;
    background: var(--surface); border-bottom: 1px solid var(--border); z-index: 100; min-height: 60px;
  }
  .header-title { font-weight: 700; font-size: var(--header-size); color: var(--brand); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
  
  .domain-badge {
    display: none;
    background: var(--brand-light);
    color: var(--brand);
    padding: 6px 12px;
    border-radius: 999px;
    font-weight: 700;
    border: 1px solid rgba(0, 68, 129, 0.2);
    cursor: pointer;
    flex-shrink: 0;
  }
  .domain-badge.active { display: flex; align-items: center; gap: 6px; }
  
  .header-btn {
    background: none; border: none; width: var(--mobile-touch); height: var(--mobile-touch);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-muted); flex-shrink: 0;
  }
  .header-btn:hover { background: var(--border); }
  .header-btn.primary { color: var(--brand); font-weight: 700; font-size: 14px; width: auto; padding: 0 12px; border-radius: 20px; background: rgba(0, 68, 129, 0.1); }
  .header-btn svg { width: 24px; height: 24px; stroke: currentColor; }

  /* Chat Area */
  .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
  .chat-scroll {
    flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px 12px 80px 12px;
    scroll-behavior: smooth; -webkit-overflow-scrolling: touch; background: var(--bg);
  }

  /* Messages */
  .message { display: flex; flex-direction: column; margin-bottom: 8px; animation: slideUp 0.2s ease; }
  @keyframes slideUp { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  .bubble {
    max-width: 92%; padding: 10px 14px; border-radius: 12px; background: var(--surface);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
    /* (1) Kompakte Abst√§nde */
    line-height: 1.4; 
    word-wrap: break-word; position: relative;
    white-space: pre-wrap;
    font-size: 1.0em; /* Erbe */
  }
  .bubble.user { align-self: flex-end; background: var(--brand); color: #ffffff; border-bottom-right-radius: 4px; }
  .bubble.assistant { align-self: flex-start; background: var(--surface-2); border-bottom-left-radius: 4px; border: 1px solid var(--border); }

  /* Rich Text - Alle gleich gro√ü */
  .bubble .md { font-family: var(--font-stack); font-size: 1em; line-height: 1.4; color: inherit; }
  .bubble .md h4 { margin: 0 0 4px 0; font-weight: 700; color: var(--brand); font-size: 1em; display: block; }
  .bubble .md h1, .bubble .md h2, .bubble .md h3 { font-weight: 700; margin: 6px 0 4px 0; font-size: 1.1em; color: var(--brand); }
  .bubble .md p { margin: 0 0 6px 0; }
  .bubble .md ul, .bubble .md ol { margin: 0 0 6px 18px; padding: 0; }
  .bubble .md li { margin-bottom: 2px; }
  .bubble .md pre { background: var(--bg); padding: 8px; border-radius: 6px; overflow-x: auto; margin: 6px 0; font-size: 0.95em; white-space: pre-wrap; }
  .bubble .md code { background: rgba(0,0,0,0.06); padding: 1px 4px; border-radius: 3px; font-family: 'Courier New', monospace; }
  .bubble.user .md code { background: rgba(255,255,255,0.2); }

  /* Tables */
  .table-wrapper { overflow-x: auto; margin: 6px 0; border-radius: 6px; border: 1px solid var(--border); }
  .bubble .md table { width: 100%; border-collapse: collapse; font-size: 0.95em; }
  .bubble .md th, .bubble .md td { border: 1px solid var(--border); padding: 6px 8px; text-align: left; }
  .bubble .md th { background: var(--surface); }

  /* Message Actions */
  .message-actions { display: flex; gap: 6px; margin-top: 4px; justify-content: flex-end; flex-wrap: wrap; opacity: 0.8; }
  .msg-btn {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
    padding: 4px 10px; font-size: 0.85em; font-weight: 600; color: var(--text);
    display: flex; align-items: center; gap: 4px; cursor: pointer; min-height: 28px;
  }
  .msg-btn:hover { background: var(--border); }
  .msg-btn svg { width: 12px; height: 12px; stroke: currentColor; }

  /* Sources */
  .sources { margin-top: 8px; padding: 8px; border-radius: 6px; background: rgba(0, 68, 129, 0.06); border: 1px solid var(--border); }
  .sources .src-title { font-weight: 700; color: var(--brand); margin-bottom: 4px; font-size: 0.95em; }
  .sources ul { margin: 0; padding: 0 0 0 16px; list-style: disc; }
  .sources li { margin: 2px 0; font-size: 0.95em; }

  /* Composer */
  .composer {
    position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface);
    border-top: 1px solid var(--border); padding: 10px 16px max(10px, var(--safe-bottom)) 16px;
    display: flex; gap: 10px; align-items: flex-end; z-index: 200;
  }
  .input-wrapper { flex: 1; position: relative; }
  #in {
    width: 100%; min-height: 44px; max-height: 120px; padding: 10px 14px;
    border: 2px solid var(--border); border-radius: 20px; background: var(--bg);
    color: var(--text); font-family: var(--font-stack); font-size: 1em; line-height: 1.4;
    resize: none; overflow-y: auto; outline: none;
  }
  #in:focus { border-color: var(--brand); box-shadow: 0 0 0 2px rgba(0, 68, 129, 0.15); }
  
  #send {
    background: var(--brand); color: white; border: none; border-radius: 50%;
    width: var(--mobile-touch); height: var(--mobile-touch);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    flex-shrink: 0; transition: transform 0.1s;
  }
  #send:hover { background: var(--brand-2); }
  #send:active { transform: scale(0.95); }
  #send.stop-mode { background: var(--danger); }
  #send svg { width: 22px; height: 22px; stroke: currentColor; fill: none; }

  /* Snippet Bar (Unter Input) */
  .snippet-bar {
    position: absolute; bottom: 55px; left: 0; right: 0;
    background: var(--bg); border: 1px solid var(--border); border-radius: 12px;
    padding: 8px; display: none; gap: 8px; flex-wrap: wrap; z-index: 210;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .snippet-bar.active { display: flex; }
  .chip {
    background: var(--surface); border: 1px solid var(--border); padding: 4px 10px;
    border-radius: 16px; font-size: 0.9em; cursor: pointer;
  }
  .chip:hover { background: var(--brand-light); border-color: var(--brand); }

  /* Modals */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
    display: none; align-items: flex-end; justify-content: center; z-index: 1000;
  }
  .modal-overlay.open { display: flex; }
  .modal-sheet {
    background: var(--surface); width: 100%; max-width: 600px; max-height: 85vh;
    border-radius: 20px 20px 0 0; padding: 20px; overflow-y: auto;
    animation: slideUp 0.3s ease;
  }
  @media (min-width: 768px) {
    .modal-overlay { align-items: center; }
    .modal-sheet { border-radius: 20px; width: 600px; max-height: 80vh; }
  }

  .modal-title { font-size: 1.2em; font-weight: 700; margin-bottom: 16px; color: var(--brand); }
  .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
  .btn { flex: 1; padding: 12px 20px; border-radius: 12px; font-weight: 700; font-size: 1em; text-align: center; border: none; cursor: pointer; }
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: var(--brand); color: white; }
  .btn-secondary { background: var(--surface-2); color: var(--text); border: 1px solid var(--border); }
  .btn-danger { background: var(--danger); color: white; }

  /* Inputs in Settings */
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.9em; }
  .form-control {
    width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--border);
    background: var(--bg); color: var(--text); font-family: var(--font-stack); font-size: 1em;
  }
  .form-control:focus { border-color: var(--brand); outline: none; }

  /* Session List */
  .session-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .session-item {
    display: flex; align-items: center; justify-content: space-between; padding: 12px;
    border-radius: 10px; background: var(--surface-2); border: 2px solid transparent; cursor: pointer;
  }
  .session-item.active { border-color: var(--brand); background: rgba(0, 68, 129, 0.08); }
  .session-title { font-weight: 600; flex: 1; overflow: hidden; text-overflow: ellipsis; }
  .session-actions { display: flex; gap: 6px; }
  .icon-btn-sm { width: 32px; height: 32px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; justify-content: center; cursor: pointer; }
  .icon-btn-sm svg { width: 16px; height: 16px; stroke: var(--text-muted); }

  /* Loading Animation (d) */
  .loading { display: inline-flex; gap: 4px; align-items: center; padding: 2px 0; }
  .loading span {
    width: 6px; height: 6px; background: var(--brand); border-radius: 50%;
    animation: bounce 1.2s infinite ease-in-out;
  }
  .loading span:nth-child(2) { animation-delay: 0.15s; }
  .loading span:nth-child(3) { animation-delay: 0.3s; }
  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
  }
</style>
</head>

<body>
<div id="app">
  <!-- Header -->
  <div class="header">
    <div class="header-title">Linda</div>
    
    <div id="domain-badge" class="domain-badge" title="Klicken zum √Ñndern">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;">
        <path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
      </svg>
      <span id="domain-text">Modus</span>
    </div>

    <button class="header-btn primary" id="btn-new-chat">+ Neu</button>
    
    <button class="header-btn" id="btn-sessions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 6h18"></path><path d="M7 12h10"></path><path d="M10 18h4"></path>
      </svg>
    </button>
    <button class="header-btn" id="btn-settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
  </div>

  <!-- Chat Content -->
  <div class="chat-container">
    <div id="log" class="chat-scroll" role="log" aria-live="polite"></div>
    
    <div class="composer">
      <div class="input-wrapper">
        <div id="snippet-bar" class="snippet-bar"></div>
        <textarea id="in" placeholder="Deine Frage (Tippe '/' f√ºr Snippets)..." rows="1" aria-label="Deine Frage eingeben"></textarea>
      </div>
      <button id="send" aria-label="Nachricht senden">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>

<!-- Modal: Datenschutz (f) -->
<div id="m-privacy" class="modal-overlay open">
  <div class="modal-sheet">
    <div class="modal-title">Datenschutzhinweis</div>
    <div style="line-height: 1.5; color: var(--text-muted); padding-bottom: 10px;">
      <p style="margin-bottom: 12px;">Um diesen Chatbot nutzen zu k√∂nnen, ist deine Zustimmung erforderlich:</p>
      <ul style="margin-bottom: 16px; padding-left: 20px;">
        <li style="margin-bottom: 8px;">Deine Eingaben werden an OpenAI (USA) und Make (EU) √ºbermittelt.</li>
        <li style="margin-bottom: 8px;">Bitte gib <strong>keine sensiblen Daten</strong> ein!</li>
        <li style="margin-bottom: 8px;">Weitere Informationen: 
          <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a> & 
          <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make.com</a>
        </li>
      </ul>
      <p style="font-size: 0.9em;">Hinweis: Chatverlauf wird <strong>nur lokal</strong> gespeichert.</p>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="p-decline">Ablehnen</button>
      <button class="btn btn-primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<!-- Modal: Nutzungshinweise -->
<div id="m-usage" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Wichtige Hinweise</div>
    <ul style="line-height: 1.5; color: var(--text-muted); padding-left: 20px;">
      <li style="margin-bottom: 6px;"><strong>Automatisierte Antworten:</strong> KI-generiert.</li>
      <li style="margin-bottom: 6px;"><strong>Keine Gew√§hr:</strong> Inhalte pr√ºfungsbed√ºrftig.</li>
      <li style="margin-bottom: 6px;"><strong>Eigenverantwortung:</strong> Kritisch hinterfragen.</li>
    </ul>
    <div class="modal-actions">
      <button class="btn btn-primary" id="u-accept">Verstanden</button>
    </div>
  </div>
</div>

<!-- Modal: Verl√§ufe -->
<div id="m-sessions" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Verl√§ufe</div>
    <div class="modal-actions" style="margin-bottom: 16px;">
      <button class="btn btn-secondary" id="mob-export-all">Export</button>
      <button class="btn btn-danger" id="mob-clear-all">L√∂schen</button>
    </div>
    <div id="mob-sess-list" class="session-list"></div>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="mob-sess-close">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Modal: Einstellungen -->
<div id="m-settings" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Einstellungen</div>
    
    <!-- User Name -->
    <div class="form-group">
      <label class="form-label">Dein Name (f√ºr Chat-Nachrichten)</label>
      <input type="text" id="user-name" class="form-control" placeholder="z.B. Max Mustermann">
    </div>

    <!-- Fachmodus -->
    <div class="form-group">
      <label class="form-label">Fachmodus</label>
      <select id="sel-domain" class="form-control">
        <option value="">‚Äî Kein Modus ‚Äî</option>
        <option value="AEVO">AEVO</option>
        <option value="VWL">VWL</option>
        <option value="PERSONAL">Personal (Allgemein)</option>
      </select>
    </div>
    
    <!-- Snippets (c) -->
    <div class="form-group">
      <label class="form-label">Snippets (Tippe '/' im Chat)</label>
      <div id="snippet-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; min-height: 30px;"></div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="snippet-input" class="form-control" placeholder="Neuer Snippet Text...">
        <button class="btn btn-primary" id="add-snippet" style="flex: 0; padding: 10px 20px;">+</button>
      </div>
      <small style="color: var(--text-muted); margin-top: 4px; display: block;">Im Chat '/' tippen zum Ausw√§hlen.</small>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" id="s-close">Abbrechen</button>
      <button class="btn btn-primary" id="s-save">Speichern</button>
    </div>
  </div>
</div>

<!-- Modal: Feedback -->
<div id="m-feedback" class="modal-overlay">
  <div class="modal-sheet">
    <div class="modal-title">Feedback senden</div>
    <p style="color: var(--text-muted); margin-bottom: 16px;">
      Feedback √∂ffnet dein E-Mail-Programm. Chatverlauf wird optional angeh√§ngt.
    </p>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="fb-cancel">Abbrechen</button>
      <button class="btn btn-primary" id="fb-continue">Weiter</button>
    </div>
  </div>
</div>

<!-- SCRIPTS -->
<script id="linda-context-addon">
(function(){
  if (localStorage.getItem('linda.addon.disabled') === '1') { return; }
  const MAX_CONTEXT_CHARS = 2500;
  function getFachmodus() { const sel = document.getElementById('sel-domain'); if (sel && sel.value) return sel.value; return ''; }
  function buildCompressedContext() {
    let rawSessions = null, sessions = [], activeId = null, session = null;
    try { rawSessions = localStorage.getItem('linda.sessions'); sessions = rawSessions ? JSON.parse(rawSessions) : []; } catch {}
    try { activeId = localStorage.getItem('linda.activeId'); } catch {}
    if (activeId) session = sessions.find(s=>s.id===activeId);
    if (!session && sessions && sessions.length) session = sessions[0];
    if (!session || !Array.isArray(session.messages)) return '';
    let context = '', currentLen = 0, msgs = session.messages;
    for (let i = msgs.length - 1; i >= 0; i--) {
      const m = msgs[i];
      // (5) User Name Logik f√ºr Context
      const prefix = m.role==='user' ? (JSON.parse(localStorage.getItem('linda.settings')||'{}').userName || 'User') + ': ' : 'Linda: ';
      const txt = prefix + (m.content||'') + "\n";
      if (currentLen + txt.length > MAX_CONTEXT_CHARS) break;
      context = txt + context; currentLen += txt.length;
    }
    return context;
  }
  const _origFetch = window.fetch.bind(window);
  window.fetch = async function(url, options = {}) {
    try {
      const method = ((options && options.method) || "GET").toUpperCase();
      const isPost = method === "POST";
      const headers = options && options.headers ? options.headers : {};
      const contentType = (headers["Content-Type"] || headers["content-type"] || "").toLowerCase();
      const isJson = contentType.includes("application/json") || (typeof options.body === "string" && options.body.trim().startsWith("{"));
      if (isPost && isJson && typeof options.body === "string") {
        try {
          const body = JSON.parse(options.body);
          const hasMessageLike = (typeof body.message === "string") || (typeof body.question === "string");
          if (body && typeof body === "object" && hasMessageLike && !("context" in body)) {
            const context = buildCompressedContext();
            const fachmodus = getFachmodus();
            const augmented = { ...body, context, fachmodus, user: body.user || "Dozent" };
            options.body = JSON.stringify(augmented);
          }
        } catch (err) {}
      }
    } catch (err) {}
    return _origFetch(url, options);
  };
})();
</script>

<script>
(function(){
  // Security
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('copy', e => e.preventDefault());

  const uniqueToken = 'Linda-v28.0-Sec-' + Date.now();
  const $ = id => document.getElementById(id);
  const LS = {
    get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},
    set(k,v){localStorage.setItem(k,JSON.stringify(v))}
  };

  // (4) User Name in Settings
  let settings = LS.get('linda.settings', { domain: '', snippets: [], userName: '' });
  let sessions = LS.get('linda.sessions', []);
  let activeId = LS.get('linda.activeId', null);
  let abortCtrl = null;

  const md = (txt) => {
    try {
      const textWithBold = txt.replace(/\$(.*?)\$/g, '**$1**');
      const raw = marked.parse(textWithBold, { breaks: true, gfm: true });
      return DOMPurify.sanitize(raw, {
        ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'pre', 'code', 'blockquote', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
        ALLOWED_ATTR: ['class']
      });
    } catch { return txt; }
  };

  const show = (m) => { if(m) m.classList.add('open'); };
  const hide = (m) => { if(m) m.classList.remove('open'); };
  const uid = () => 's_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);

  function saveAll() {
    LS.set('linda.settings', settings);
    LS.set('linda.sessions', sessions);
    LS.set('linda.activeId', activeId);
  }

  function ensureFirstSession() {
    if (!sessions.length) {
      const id = uid();
      sessions = [{ id, name: 'Neuer Chat', ts: Date.now(), messages: [] }];
      activeId = id; sessions[0].id = id; saveAll();
    }
    if (!activeId || !sessions.find(s => s.id === activeId)) { activeId = sessions[0].id; saveAll(); }
  }

  function active() { return sessions.find(s => s.id === activeId); }
  function setActive(id) { activeId = id; saveAll(); renderSessions(); renderChat(); }

  // --- Rendering ---

  function updateDomainBadge() {
    const badge = $('domain-badge');
    const text = $('domain-text');
    if (settings.domain) {
      badge.classList.add('active');
      text.textContent = settings.domain;
    } else {
      badge.classList.remove('active');
    }
  }

  function renderSessions() {
    const el = $('mob-sess-list');
    if (!el) return;
    const visible = sessions.slice(0, 20);
    
    el.innerHTML = visible.map(s => `
      <div class="session-item ${s.id === activeId ? 'active' : ''}" data-id="${s.id}">
        <div class="session-title">${s.name || 'Chat'}</div>
        <div class="session-actions">
          <button class="icon-btn-sm" data-action="rename" data-id="${s.id}" title="Umbenennen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          </button>
          <button class="icon-btn-sm" data-action="delete" data-id="${s.id}" title="L√∂schen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          </button>
        </div>
      </div>
    `).join('');

    el.querySelectorAll('.session-item').forEach(item => {
      item.addEventListener('click', (e) => {
        if (e.target.closest('.session-actions')) return;
        setActive(item.dataset.id);
        hide($('m-sessions'));
      });
    });

    el.querySelectorAll('[data-action="rename"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const s = sessions.find(x => x.id === btn.dataset.id);
        if (s) {
          const nn = prompt('Neuer Name:', s.name);
          if (nn !== null) { s.name = nn.trim() || s.name; saveAll(); renderSessions(); }
        }
      });
    });

    el.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (!confirm('L√∂schen?')) return;
        sessions = sessions.filter(x => x.id !== btn.dataset.id);
        if (!sessions.length) sessions.push({ id: uid(), name: 'Neuer Chat', ts: Date.now(), messages: [] });
        if (activeId === btn.dataset.id) activeId = sessions[0].id;
        saveAll(); renderSessions(); renderChat();
      });
    });
  }

  // Snippet Bar Logic
  function updateSnippetBar() {
    const bar = $('snippet-bar');
    if (!settings.snippets || settings.snippets.length === 0) {
      bar.classList.remove('active');
      return;
    }
    // Only show if input starts with /
    const inputVal = $('in').value;
    if (!inputVal.startsWith('/')) {
      bar.classList.remove('active');
      return;
    }

    const query = inputVal.substring(1).toLowerCase();
    const filtered = settings.snippets.filter(s => s.toLowerCase().includes(query));

    if (filtered.length > 0) {
      bar.innerHTML = filtered.map(s => `<div class="chip" data-val="${s.replace(/"/g, '&quot;')}">${s}</div>`).join('');
      bar.classList.add('active');
      
      bar.querySelectorAll('.chip').forEach(chip => {
        chip.addEventListener('click', () => {
          insertSnippet(chip.dataset.val);
        });
      });
    } else {
      bar.classList.remove('active');
    }
  }

  function insertSnippet(text) {
    const inp = $('in');
    inp.value = text; // Replace the "/" command with the snippet
    $('snippet-bar').classList.remove('active');
    inp.focus();
  }

  function renderSnippetSettings() {
    const container = $('snippet-list');
    if (!settings.snippets || settings.snippets.length === 0) {
      container.innerHTML = '<span style="color:var(--muted); font-size:0.9rem;">Keine Snippets.</span>';
      return;
    }
    container.innerHTML = settings.snippets.map((s, i) => `
      <div class="chip" style="cursor:default;">
        ${s} <span onclick="deleteSnippet(${i})" style="margin-left:6px; cursor:pointer; color:red;">&times;</span>
      </div>
    `).join('');
  }

  window.deleteSnippet = (index) => {
    settings.snippets.splice(index, 1);
    saveAll();
    renderSnippetSettings();
  };

  function addMsg(role, content, isUpdate = false) {
    const log = $('log');
    if (isUpdate && log.lastElementChild && log.lastElementChild.dataset.role === role) {
      log.lastElementChild.innerHTML = buildMessageHTML(role, content);
      postProcessMessage(log.lastElementChild);
      return;
    }

    const d = document.createElement('div');
    d.className = 'message';
    d.dataset.role = role;
    d.innerHTML = buildMessageHTML(role, content);
    log.appendChild(d);
    postProcessMessage(d);
    
    if (role === 'user' || log.scrollTop + log.clientHeight >= log.scrollHeight - 150) {
      log.scrollTop = log.scrollHeight;
    }
  }

  function buildMessageHTML(role, content) {
    if (role === 'assistant') {
      const contentWithHeader = `<h4>Linda</h4>` + content;
      return `
        <div class="bubble assistant">
          <div class="md">${md(contentWithHeader)}</div>
        </div>
        <div class="message-actions">
          <button class="msg-btn" data-action="copy">üìã</button>
          <button class="msg-btn" data-action="share">‚Üó</button>
          <button class="msg-btn" data-action="pdf">üñ®</button>
          <button class="msg-btn" data-action="feedback">üëé</button>
        </div>
      `;
    } else {
      return `<div class="bubble user"><div class="md">${md(content)}</div></div>`;
    }
  }

  function postProcessMessage(d) {
    if (d.dataset.role !== 'assistant') return;

    const mdEl = d.querySelector('.md');
    if (mdEl) {
      // Sources
      const headings = Array.from(mdEl.querySelectorAll('h1,h2,h3'));
      const h = headings.find(x => /quellen/i.test((x.textContent||'').trim()));
      if (h) {
        let n = h.nextElementSibling;
        while (n && n.tagName && !/UL|OL/i.test(n.tagName)) n = n.nextElementSibling;
        if (n && /UL|OL/i.test(n.tagName)) {
          const wrap = document.createElement('div');
          wrap.className = 'sources';
          wrap.innerHTML = `<div class="src-title">Quellen</div>`;
          const ul = document.createElement('ul');
          ul.innerHTML = n.innerHTML;
          wrap.appendChild(ul);
          n.replaceWith(wrap);
          h.remove();
        }
      }
      // Tables
      const tables = mdEl.querySelectorAll('table');
      tables.forEach(t => {
        if (!t.parentNode.classList.contains('table-wrapper')) {
          const wrap = document.createElement('div');
          wrap.className = 'table-wrapper';
          t.parentNode.insertBefore(wrap, t);
          wrap.appendChild(t);
        }
      });
    }

    const buttons = d.querySelectorAll('.msg-btn');
    const answerText = d.querySelector('.md')?.innerText || '';
    const s = active();
    const q = s.messages.find(m => m.role === 'user')?.content || '';

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const act = btn.dataset.action;
        if (act === 'copy') copyText(`Frage: ${q}\n\nAntwort: ${answerText}`);
        if (act === 'share') shareText(`Frage: ${q}\n\nAntwort: ${answerText}`);
        if (act === 'pdf') exportPDF(q, answerText);
        if (act === 'feedback') show($('m-feedback'));
      });
    });
  }

  function renderChat() {
    $('log').innerHTML = '';
    const s = active();
    if (!s) return;
    s.messages.forEach(m => addMsg(m.role, m.content));
  }

  // --- Actions ---

  window.copyText = (txt) => {
    document.removeEventListener('copy', e => e.preventDefault());
    navigator.clipboard.writeText(txt).then(() => {
      document.addEventListener('copy', e => e.preventDefault());
      alert('In Zwischenablage kopiert!');
    });
  };

  function shareText(txt) {
    if (navigator.share) navigator.share({ title: 'Linda Chat', text: txt }).catch(() => {});
    else window.location.href = `mailto:?subject=Linda&body=${encodeURIComponent(txt)}`;
  }

  // (c) PDF mit Tabellen & (g) Disclaimer
  function exportPDF(question, answer) {
    const now = new Date();
    const dateStr = now.toLocaleDateString('de-DE');
    const timeStr = now.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
    
    const win = window.open('', '_blank');
    if (!win) return;

    win.document.write(`
      <html>
      <head>
        <title>Ausdruck Linda</title>
        <style>
          @page { margin: 15mm; }
          body { font-family: Arial, sans-serif; line-height: 1.4; color: #111; font-size: 11pt; }
          .header { font-weight: bold; font-size: 16pt; color: #004481; margin-bottom: 20px; border-bottom: 2px solid #004481; padding-bottom: 10px; }
          .content { font-size: 11pt; }
          .qbox { background: #eaf3ff; padding: 12px; border-radius: 6px; margin-bottom: 15px; page-break-inside: avoid; border: 1px solid #cce5ff; }
          .qbox .t { font-weight: bold; color: #004481; margin-bottom: 6px; }
          .answer { white-space: pre-wrap; page-break-inside: avoid; }
          .footer { position: fixed; bottom: 10px; left: 0; right: 0; text-align: center; font-size: 9pt; color: #666; border-top: 1px solid #ddd; padding-top: 5px; }
          .no-print { display: none; }
          
          /* Tabellen im PDF */
          table { border-collapse: collapse; width: 100%; margin: 10px 0; page-break-inside: avoid; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
          th { background: #f0f0f0; color: #333; font-weight: bold; text-align: left; }
          th, td { border: 1px solid #ccc; padding: 6px 8px; vertical-align: top; font-size: 10pt; }
          
          h4 { margin: 0 0 6px 0; color: #004481; font-size: 12pt; font-weight: 700; }
          h1, h2, h3 { color: #004481; margin-top: 10px; font-size: 12pt; }
          p { margin: 0 0 6px 0; }
          
          /* (g) Disclaimer Box */
          .disclaimer-box {
            border: 1px solid #dc3545;
            background: #fff5f5;
            padding: 8px;
            margin-top: 12px;
            border-radius: 4px;
          }
          .disclaimer-box strong { color: #dc3545; display: block; margin-bottom: 4px; font-size: 10pt; }
        </style>
      </head>
      <body>
        <div class="no-print" style="text-align:right; margin-bottom:10px;">
          <button onclick="window.print()">Drucken / PDF</button>
        </div>
        <div class="header">KI-LINDA ‚Äì Chat-Ausdruck</div>
        <div class="content">
          <div class="qbox">
            <div class="t">Frage (${dateStr}, ${timeStr})</div>
            <div>${question}</div>
          </div>
          
          <div class="answer">
            ${answer}
            
            <div class="disclaimer-box">
              <strong>Wichtiger Hinweis:</strong>
              KI-Inhalte √ºberpr√ºfen, diese k√∂nnen falsch sein. Keine rechtlich verbindliche Auskunft.
            </div>
          </div>
        </div>
        
        <div class="footer">
          <strong>Disclaimer:</strong> Inhalte generiert durch KI (OpenAI). Bitte selbst pr√ºfen. | Erstellt am ${dateStr} um ${timeStr} Uhr
        </div>
      </body>
      </html>
    `);
    win.document.close();
    win.focus();
  }

  async function send() {
    const sendBtn = $('send');
    const inp = $('in');

    if (abortCtrl) {
      abortCtrl.abort();
      abortCtrl = null;
      sendBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
      sendBtn.classList.remove('stop-mode');
      const s = active();
      if (s.messages.length > 0 && s.messages[s.messages.length-1].content.includes('loading')) {
        s.messages[s.messages.length-1] = {role:'assistant',content:'üõë Abgebrochen.'};
        saveAll(); renderChat();
      }
      return;
    }

    const q = inp.value.trim();
    if (!q) return;
    
    inp.value = '';
    inp.style.height = 'auto';
    $('snippet-bar').classList.remove('active');
    
    sendBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="6" y1="6" x2="18" y2="18"></line><line x1="6" y1="18" x2="18" y2="6"></line></svg>`;
    sendBtn.classList.add('stop-mode');

    const s = active();
    
    // (4) User Name vor Frage setzen
    const userName = settings.userName || 'User';
    const userMsgContent = `${userName}: ${q}`;
    
    s.messages.push({ role: 'user', content: userMsgContent });
    s.ts = Date.now();
    
    // (d) Loading Animation (Linda steht nicht da, da wir noch nicht wissen ob es Linda ist - aber im Chat wird es als Linda Bubble angezeigt)
    s.messages.push({ role: 'assistant', content: '<div class="loading"><span></span><span></span><span></span></div>' });
    saveAll();
    renderChat();

    abortCtrl = new AbortController();

    try {
      // (5) Begr√º√üung NICHT an API senden
      const historyForApi = s.messages.slice(-3).filter(m => !m.content.includes('Willkommen!')).map(m => ({ role: m.role, content: m.content }));

      const payload = {
        question: q, // Nur reine Frage (ohne User Name)
        fachmodus: settings.domain || '',
        token: uniqueToken,
        history: historyForApi
      };

      const r = await fetch('/api/bot', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
        signal: abortCtrl.signal
      });

      const text = await r.text();
      const out = (text && text.trim().toLowerCase() !== 'accepted') ? text : 'Antwort erhalten.';
      
      s.messages[s.messages.length - 1] = {role: 'assistant', content: out};

    } catch (e) {
      s.messages[s.messages.length - 1] = {role: 'assistant', content: 'Verbindungsfehler.'};
    } finally {
      saveAll();
      renderChat();
      sendBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
      sendBtn.classList.remove('stop-mode');
      abortCtrl = null;
      inp.focus();
    }
  }

  // --- Event Listeners ---

  $('send').addEventListener('click', send);
  $('in').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      send();
    }
    // (c) Snippet Trigger
    if (e.key === '/') {
      setTimeout(updateSnippetBar, 10); // Small delay for value to update
    }
  });
  $('in').addEventListener('input', function() {
    this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    updateSnippetBar(); // Check for / command
  });
  // Close Snippet Bar when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.input-wrapper')) {
      $('snippet-bar').classList.remove('active');
    }
  });

  // Privacy
  $('p-accept').addEventListener('click', () => {
    hide($('m-privacy')); show($('m-usage'));
    const s = active();
    // (6) Begr√º√üung hinzuf√ºgen (Lokal)
    if (s.messages.length === 0) {
      s.messages.push({role: 'assistant', content: 'Linda: **Willkommen!** W√§hle Fachmodus oder gebe deine Frage ein.'});
      saveAll(); renderChat();
    }
  });
  $('p-decline').addEventListener('click', () => location.reload());
  $('u-accept').addEventListener('click', () => hide($('m-usage')));

  // Header Buttons
  $('btn-new-chat').addEventListener('click', () => {
    const id = uid();
    sessions.unshift({ id, name: 'Neuer Chat', ts: Date.now(), messages: [] });
    activeId = id;
    saveAll(); renderSessions(); renderChat();
    
    // (6) Begr√º√üung bei Neuem Chat
    const s = active();
    if (s.messages.length === 0) {
      s.messages.push({role: 'assistant', content: 'Linda: **Willkommen!** Wie kann ich dir helfen?'});
      saveAll(); renderChat();
    }
  });

  $('btn-sessions').addEventListener('click', () => {
    renderSessions(); show($('m-sessions'));
  });
  $('mob-sess-close').addEventListener('click', () => hide($('m-sessions')));
  
  $('mob-export-all').addEventListener('click', () => {
    const txt = sessions.map(s => `# ${s.name}\n${s.messages.map(m => (m.role==='user'?'Du: ':'Linda: ')+m.content).join('\n\n')}`).join('\n\n---\n\n');
    const blob = new Blob([txt], {type: 'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'chats.txt'; a.click();
  });
  $('mob-clear-all').addEventListener('click', () => {
    if (confirm('Alle l√∂schen?')) {
      sessions = []; activeId = null; ensureFirstSession(); saveAll(); renderSessions(); renderChat();
    }
  });

  // Settings
  $('btn-settings').addEventListener('click', () => {
    $('sel-domain').value = settings.domain || '';
    $('user-name').value = settings.userName || '';
    renderSnippetSettings();
    show($('m-settings'));
  });
  
  $('domain-badge').addEventListener('click', () => {
    $('sel-domain').value = settings.domain || '';
    $('user-name').value = settings.userName || '';
    renderSnippetSettings();
    show($('m-settings'));
  });

  $('add-snippet').addEventListener('click', () => {
    const inp = $('snippet-input');
    const val = inp.value.trim();
    if (val) {
      settings.snippets.push(val);
      inp.value = '';
      saveAll();
      renderSnippetSettings();
    }
  });

  $('s-save').addEventListener('click', () => {
    settings.domain = $('sel-domain').value;
    settings.userName = $('user-name').value;
    saveAll();
    updateDomainBadge();
    hide($('m-settings'));
  });
  $('s-close').addEventListener('click', () => hide($('m-settings')));

  // Feedback
  $('fb-cancel').addEventListener('click', () => hide($('m-feedback')));
  $('fb-continue').addEventListener('click', () => {
    hide($('m-feedback'));
    const s = active();
    const txt = s ? s.messages.map(m => (m.role==='user'?'Du: ':'Linda: ')+m.content).join('\n\n') : '';
    window.location.href = `mailto:KI-TEST@GMX.COM?subject=Feedback Linda&body=${encodeURIComponent(txt)}`;
  });

  // --- Init ---
  ensureFirstSession();
  updateDomainBadge();
  renderSessions();
  renderChat();

})();
</script>
</body>
</html>
