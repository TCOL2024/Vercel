<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<title>Linda ‚Äì Schreiben & Chat</title>
<!-- Apple Device Optimization -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=yes"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* --- APPLE DESIGN VARIABLES --- */
  :root {
    --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --font-family-mono: "SF Mono", Menlo, Consolas, monospace;
    
    /* Light Mode (iOS) */
    --bg-body: #F2F2F7; /* System Gray 6 */
    --bg-card: #FFFFFF;
    --bg-input: #F2F2F7;
    --bg-active: #E5E5EA; /* System Gray 5 */
    
    --text-primary: #000000;
    --text-secondary: #8E8E93; /* System Gray 3 */
    --text-tertiary: #C7C7CC; /* System Gray 4 */
    
    --brand-blue: #007AFF; /* iOS Blue */
    --brand-green: #34C759;
    --brand-red: #FF3B30;
    
    --border-color: #C6C6C8;
    --divider: rgba(0,0,0,0.1);
    
    --radius-lg: 18px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    --spacing-xs: 6px;
    --spacing-sm: 12px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    
    --header-height: 54px;
    --tab-height: 54px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-top: env(safe-area-inset-top, 0px);
  }

  /* Dark Mode */
  body.dark-mode {
    --bg-body: #1C1C1E;
    --bg-card: #2C2C2E;
    --bg-input: #3A3A3C;
    --bg-active: #3A3A3C;
    
    --text-primary: #FFFFFF;
    --text-secondary: #98989D;
    --text-tertiary: #636366;
    
    --brand-blue: #0A84FF;
    --border-color: #38383A;
    --divider: rgba(255,255,255,0.1);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  
  body {
    margin: 0;
    padding: 0;
    background: var(--bg-body);
    color: var(--text-primary);
    font-family: var(--font-family);
    font-size: 17px; /* iOS Base Size */
    line-height: 1.4;
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* --- HEADER --- */
  header {
    height: calc(var(--header-height) + var(--safe-top));
    padding-top: var(--safe-top);
    background: rgba(255, 255, 255, 0.85); /* iOS Frosted Glass */
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 0.5px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-x: var(--spacing-md);
    z-index: 100;
    flex-shrink: 0;
  }

  body.dark-mode header {
    background: rgba(30, 30, 30, 0.85);
  }

  .header-title {
    font-weight: 700;
    font-size: 18px;
    letter-spacing: -0.3px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .badge {
    font-size: 10px;
    background: var(--brand-blue);
    color: white;
    padding: 2px 6px;
    border-radius: 99px;
    font-weight: 600;
    display: none;
  }
  .badge.visible { display: inline-block; }

  .header-btn {
    background: transparent;
    border: none;
    padding: 8px;
    border-radius: 8px;
    font-weight: 600;
    color: var(--brand-blue);
    font-size: 16px;
    cursor: pointer;
  }
  .header-btn:active { background: var(--bg-active); }

  /* --- MAIN AREA (Dynamic) --- */
  main {
    flex: 1;
    overflow: hidden;
    position: relative;
    display: flex;
  }

  /* --- TAB: CHAT --- */
  #view-chat {
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 100%;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }
  #view-chat.active {
    opacity: 1;
    pointer-events: auto;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-md);
    padding-bottom: 80px; /* Space for input */
    display: flex;
    flex-direction: column;
    gap: 12px;
    scroll-behavior: smooth;
  }

  .msg {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: var(--radius-lg);
    font-size: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    animation: popIn 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  @keyframes popIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .msg.user {
    align-self: flex-end;
    background: var(--brand-blue);
    color: white;
    border-bottom-right-radius: 4px;
  }

  .msg.assistant {
    align-self: flex-start;
    background: var(--bg-card);
    color: var(--text-primary);
    border: 0.5px solid var(--border-color);
    border-bottom-left-radius: 4px;
  }
  
  /* Markdown Styling within Assistant Msg */
  .msg.assistant h1, .msg.assistant h2, .msg.assistant h3 {
    font-size: 18px;
    font-weight: 700;
    margin: 4px 0 8px 0;
    color: var(--brand-blue);
  }
  .msg.assistant ul, .msg.assistant ol { margin: 0; padding-left: 20px; }
  .msg.assistant li { margin-bottom: 4px; }
  .msg.assistant p { margin: 0 0 8px 0; }
  .msg.assistant p:last-child { margin-bottom: 0; }
  .msg.assistant strong { font-weight: 600; }
  .msg.assistant code {
    font-family: var(--font-family-mono);
    background: var(--bg-input);
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 14px;
  }
  .msg.assistant pre {
    background: var(--bg-input);
    padding: 12px;
    border-radius: 12px;
    overflow-x: auto;
    font-family: var(--font-family-mono);
    font-size: 14px;
    margin: 8px 0;
  }
  
  .msg-actions {
    display: flex;
    gap: 8px;
    margin-top: 6px;
    align-self: flex-end;
  }
  .action-pill {
    font-size: 13px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 4px 10px;
    border-radius: 14px;
    cursor: pointer;
    white-space: nowrap;
  }
  .action-pill:active { background: var(--bg-active); }

  /* --- TAB: WRITER (DeepL Style) --- */
  #view-writer {
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 100%;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    background: var(--bg-body);
  }
  #view-writer.active {
    opacity: 1;
    pointer-events: auto;
  }

  .writer-controls {
    background: var(--bg-card);
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .writer-select {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px;
    border-radius: 10px;
    font-size: 16px;
    outline: none;
  }

  .prompt-input {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px;
    border-radius: 10px;
    font-size: 15px;
    outline: none;
  }
  .prompt-input::placeholder { color: var(--text-tertiary); }

  .writer-grid {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  @media (min-width: 768px) {
    .writer-grid { flex-direction: row; }
  }

  .writer-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-bottom: 1px solid var(--border-color);
  }
  
  @media (min-width: 768px) {
    .writer-pane { border-right: 1px solid var(--border-color); border-bottom: none; }
  }

  .pane-header {
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    background: var(--bg-card);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .writer-textarea {
    flex: 1;
    width: 100%;
    border: none;
    resize: none;
    padding: 16px;
    font-family: var(--font-family);
    font-size: 17px;
    line-height: 1.6;
    background: var(--bg-card);
    color: var(--text-primary);
    outline: none;
  }
  
  .writer-textarea::placeholder { color: var(--text-tertiary); }

  .writer-output {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: var(--bg-body);
    white-space: pre-wrap;
    font-family: var(--font-family);
    font-size: 17px;
    line-height: 1.6;
  }
  
  .writer-output.loading {
    opacity: 0.5;
    font-style: italic;
  }

  /* --- TAB: SESSIONS (Liste) --- */
  #view-sessions {
    flex: 1;
    display: flex;
    flex-direction: column;
    width: 100%;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    background: var(--bg-body);
    overflow-y: auto;
    padding: var(--spacing-md);
  }
  #view-sessions.active {
    opacity: 1;
    pointer-events: auto;
  }

  .session-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 14px;
    margin-bottom: 12px;
    border: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  
  .session-card:active { background: var(--bg-active); }
  
  .session-info { flex: 1; }
  .session-name { font-weight: 600; margin-bottom: 4px; }
  .session-date { font-size: 13px; color: var(--text-secondary); }

  .session-actions {
    display: flex;
    gap: 6px;
  }
  
  .icon-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--bg-card);
  }
  .icon-btn:active { background: var(--bg-active); }

  /* --- INPUT BAR (Bottom) --- */
  .input-bar {
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    padding: 12px 16px calc(12px + var(--safe-bottom)) 16px;
    display: flex;
    gap: 10px;
    align-items: flex-end;
    z-index: 90;
  }

  .text-input-wrapper {
    flex: 1;
    position: relative;
  }

  #main-input {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    border-radius: 20px;
    padding: 10px 16px;
    font-size: 17px;
    max-height: 120px;
    min-height: 40px; /* Reduced for bar */
    resize: none;
    outline: none;
    color: var(--text-primary);
  }
  
  #main-input:focus { border-color: var(--brand-blue); }

  .send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--brand-blue);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
  }
  .send-btn:disabled { opacity: 0.4; }
  .send-btn:active { transform: scale(0.95); }
  
  /* Stop Button State */
  .send-btn.stop { background: var(--brand-red); }

  /* --- BOTTOM TAB NAVIGATION --- */
  .bottom-nav {
    height: calc(var(--tab-height) + var(--safe-bottom));
    padding-bottom: var(--safe-bottom);
    background: var(--bg-card);
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-around;
    align-items: center;
    z-index: 100;
    flex-shrink: 0;
  }

  .nav-item {
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    color: var(--text-secondary);
    background: transparent;
    border: none;
    font-size: 11px;
    cursor: pointer;
    position: relative;
  }

  .nav-item.active { color: var(--brand-blue); }
  
  .nav-icon {
    width: 22px;
    height: 22px;
    stroke-width: 2.2;
  }

  /* --- MODALS --- */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    padding: 24px;
  }
  .modal-overlay.open { display: flex; }

  .modal-sheet {
    background: var(--bg-card);
    width: 100%;
    max-width: 500px;
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-title { font-weight: 700; font-size: 20px; margin-bottom: 16px; }
  .modal-text { color: var(--text-secondary); line-height: 1.5; margin-bottom: 20px; }
  
  .btn-row { display: flex; gap: 12px; justify-content: flex-end; }
  .btn {
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 16px;
    border: none;
    cursor: pointer;
  }
  .btn-primary { background: var(--brand-blue); color: white; }
  .btn-secondary { background: var(--bg-input); color: var(--text-primary); }
  .btn-danger { background: var(--brand-red); color: white; }

  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px; }
  .form-control {
    width: 100%; padding: 12px; border-radius: 10px; 
    border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-primary); font-size: 16px;
  }
  
  .toggle {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0; border-bottom: 1px solid var(--border-color);
  }

  /* Loading Pulse for Writer */
  .pulse-dots { display: inline-block; width: 20px; text-align: left; }
  .pulse-dots::after {
    content: '...'; animation: typing 1.5s infinite steps(4, end);
  }
  @keyframes typing { 0% { content: ''; } 50% { content: '.'; } 100% { content: '...'; } }

  /* Utility SVG styling */
  svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-linecap: round; stroke-linejoin: round; }
  
  /* Hidden helper */
  .hidden { display: none !important; }

</style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div style="display:flex; align-items:center; gap:10px;">
      <button class="header-btn" id="header-back-btn" style="display:none;">Zur√ºck</button>
      <div class="header-title">Linda <span id="header-badge" class="badge">Aktiv</span></div>
    </div>
    <button class="header-btn" id="settings-btn">Einstellungen</button>
  </header>

  <!-- MAIN CONTENT -->
  <main>

    <!-- VIEW: CHAT -->
    <section id="view-chat" class="active">
      <div class="chat-messages" id="chat-log">
        <!-- Messages injected here -->
      </div>
      <div class="input-bar">
        <div class="text-input-wrapper">
          <textarea id="chat-input" placeholder="Nachricht an Linda..." rows="1"></textarea>
        </div>
        <button class="send-btn" id="chat-send">
          <svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </div>
    </section>

    <!-- VIEW: WRITER (DeepL Clone) -->
    <section id="view-writer">
      <div class="writer-controls">
        <select id="writer-style" class="writer-select">
          <option value="standard">Kein Stil (Standard)</option>
          <option value="formell">Formell (Professionell)</option>
          <option value="freundlich">Freundlich & Locker</option>
          <option value="kurz">Kurz & Knapp</option>
          <option value="marketing">Marketing & Werbend</option>
        </select>
        <input type="text" id="writer-prompt" class="prompt-input" placeholder="Anweisung (z.B. 'Verbessere den Text, h√∂flicher Ton')">
      </div>
      
      <div class="writer-grid">
        <div class="writer-pane">
          <div class="pane-header">
            <span>Original</span>
            <button class="header-btn" style="font-size:12px; padding:2px 6px;" onclick="document.getElementById('writer-input').value=''">Leeren</button>
          </div>
          <textarea id="writer-input" class="writer-textarea" placeholder="Text hier einf√ºgen..."></textarea>
        </div>
        <div class="writer-pane">
          <div class="pane-header">
            <span>Optimiert</span>
            <div style="display:flex; gap:5px;">
              <button class="header-btn" style="font-size:12px; padding:2px 6px;" id="writer-copy">Kopieren</button>
              <button class="header-btn" style="font-size:12px; padding:2px 6px;" id="writer-share">Teilen</button>
            </div>
          </div>
          <div id="writer-output" class="writer-output">Dein optimierter Text erscheint hier...</div>
        </div>
      </div>

      <div class="input-bar" style="background: var(--bg-card);">
         <div style="flex:1; text-align:center; font-size:14px; color:var(--text-secondary);">Dr√ºcke "Generieren" um den Text zu optimieren</div>
         <button class="send-btn" id="writer-generate">
            <svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
         </button>
      </div>
    </section>

    <!-- VIEW: SESSIONS -->
    <section id="view-sessions">
      <div style="display:flex; gap:10px; margin-bottom:16px;">
        <button class="btn btn-secondary" style="flex:1;" id="export-all-btn">Alle Exportieren</button>
        <button class="btn btn-danger" style="flex:1;" id="delete-all-btn">Alle L√∂schen</button>
      </div>
      <div id="sessions-list"></div>
    </section>

  </main>

  <!-- BOTTOM NAVIGATION -->
  <nav class="bottom-nav">
    <button class="nav-item active" data-target="view-chat">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      <span>Chat</span>
    </button>
    <button class="nav-item" data-target="view-writer">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
      <span>Schreiben</span>
    </button>
    <button class="nav-item" data-target="view-sessions">
      <svg class="nav-icon" viewBox="0 0 24 24"><path d="M3 6h18"></path><path d="M7 12h14"></path><path d="M11 18h6"></path></svg>
      <span>Verl√§ufe</span>
    </button>
  </nav>

  <!-- MODALS -->
  
  <!-- Privacy -->
  <div id="modal-privacy" class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-title">Datenschutzhinweis</div>
      <div class="modal-text">
        Um Linda nutzen zu k√∂nnen, m√ºssen deine Eingaben an die KI (OpenAI) gesendet werden.
        <br><br>
        <strong>Bitte gib keine personenbezogenen oder sensiblen Daten ein.</strong>
        <br><br>
        Dein Chatverlauf wird <strong>lokal</strong> auf deinem Ger√§t gespeichert.
      </div>
      <div class="btn-row">
        <button class="btn btn-secondary" id="btn-privacy-decline">Ablehnen</button>
        <button class="btn btn-primary" id="btn-privacy-accept">Zustimmen</button>
      </div>
    </div>
  </div>

  <!-- Usage Info -->
  <div id="modal-usage" class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-title">Wichtige Hinweise</div>
      <ul class="modal-text" style="padding-left:20px;">
        <li style="margin-bottom:8px;">KI-Antworten k√∂nnen Fehler enthalten.</li>
        <li style="margin-bottom:8px;">Kein Ersatz f√ºr professionelle Beratung.</li>
        <li style="margin-bottom:8px;">Kritische Inhalte bitte pr√ºfen.</li>
      </ul>
      <div class="btn-row">
        <button class="btn btn-primary" id="btn-usage-ok">Verstanden</button>
      </div>
    </div>
  </div>

  <!-- Settings -->
  <div id="modal-settings" class="modal-overlay">
    <div class="modal-sheet">
      <div class="modal-title">Einstellungen</div>
      
      <div class="form-group">
        <label class="form-label">Fachmodus</label>
        <select id="set-domain" class="form-control">
          <option value="">Standard (Allgemein)</option>
          <option value="AEVO">AEVO</option>
          <option value="VWL">VWL</option>
          <option value="PERSONAL">Personal</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Theme</label>
        <select id="set-theme" class="form-control">
          <option value="system">System (Auto)</option>
          <option value="light">Hell</option>
          <option value="dark">Dunkel</option>
        </select>
      </div>

      <div class="toggle">
        <span>Gender-Sprache</span>
        <input type="checkbox" id="set-gender" style="width:20px; height:20px;">
      </div>

      <div class="toggle">
        <span>Begr√º√üungstext</span>
        <input type="checkbox" id="set-greet" style="width:20px; height:20px;" checked>
      </div>

      <div class="btn-row" style="margin-top:20px;">
        <button class="btn btn-secondary" id="btn-settings-close">Schlie√üen</button>
        <button class="btn btn-primary" id="btn-settings-save">Speichern</button>
      </div>
    </div>
  </div>

  <!-- LOGIC -->
  <script>
    // --- STATE MANAGEMENT ---
    const Store = {
      get: (key, def) => {
        try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : def; } catch(e) { return def; }
      },
      set: (key, val) => {
        try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
      }
    };

    const State = {
      settings: Store.get('linda.settings', {
        theme: 'system', gender: false, greet: true, domain: ''
      }),
      sessions: Store.get('linda.sessions', []),
      activeId: Store.get('linda.activeId', null),
      privacyAccepted: Store.get('linda.privacy', false),
      usageSeen: Store.get('linda.usage', false),
      abortController: null,
      token: 'Linda-v3-' + Date.now()
    };

    // --- DOM ELEMENTS ---
    const $ = (id) => document.getElementById(id);

    // --- CORE FUNCTIONS ---

    function init() {
      if (!State.privacyAccepted) {
        openModal('modal-privacy');
        return;
      }
      if (!State.usageSeen) {
        openModal('modal-usage');
        return;
      }
      
      applyTheme();
      ensureSession();
      renderChat();
      renderSessionsList();
      updateDomainBadge();
      
      // Check Writer Defaults
      if (State.settings.domain) {
        const select = $('writer-style');
        if (select && select.value === 'standard') {
          // Optional: Pre-select style based on domain
        }
      }
    }

    // --- THEME & SETTINGS ---

    function applyTheme() {
      const body = document.body;
      body.classList.remove('dark-mode');
      
      let theme = State.settings.theme;
      if (theme === 'system') {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          body.classList.add('dark-mode');
        }
      } else if (theme === 'dark') {
        body.classList.add('dark-mode');
      }
    }

    function updateDomainBadge() {
      const badge = $('header-badge');
      if (State.settings.domain) {
        badge.textContent = State.settings.domain;
        badge.classList.add('visible');
      } else {
        badge.classList.remove('visible');
      }
    }

    // --- SESSION MANAGEMENT ---

    function ensureSession() {
      if (State.sessions.length === 0) {
        const id = generateId();
        State.sessions = [{ id, name: 'Neuer Chat', ts: Date.now(), messages: [] }];
        State.activeId = id;
        persist();
      } else if (!State.activeId || !State.sessions.find(s => s.id === State.activeId)) {
        State.activeId = State.sessions[0].id;
        persist();
      }
    }

    function createNewSession() {
      const id = generateId();
      const newSess = { id, name: 'Neuer Chat', ts: Date.now(), messages: [] };
      State.sessions.unshift(newSess);
      State.activeId = id;
      persist();
      switchTab('view-chat'); // Back to chat
      renderChat();
      if (State.settings.greet) {
        addMessage('assistant', '**Hallo!** Ich bin bereit zu helfen. W√§hle oben links den Fachmodus, wenn n√∂tig.');
      }
    }

    function deleteSession(id) {
      if (!confirm('Verlauf wirklich l√∂schen?')) return;
      State.sessions = State.sessions.filter(s => s.id !== id);
      if (State.sessions.length === 0) {
        ensureSession();
      } else if (State.activeId === id) {
        State.activeId = State.sessions[0].id;
      }
      persist();
      renderChat();
      renderSessionsList();
    }

    function renameSession(id) {
      const s = State.sessions.find(x => x.id === id);
      if (!s) return;
      const nn = prompt('Neuer Name:', s.name);
      if (nn && nn.trim()) {
        s.name = nn.trim();
        persist();
        renderSessionsList();
      }
    }

    function exportSession(id) {
      const s = State.sessions.find(x => x.id === id);
      if (!s) return;
      const txt = s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + m.content).join('\n\n');
      downloadText(txt, (s.name || 'chat') + '.txt');
    }

    function exportAll() {
      const txt = State.sessions.map(s => 
        `# ${s.name}\nDatum: ${new Date(s.ts).toLocaleString()}\n\n` +
        s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + m.content).join('\n\n')
      ).join('\n\n---\n\n');
      downloadText(txt, 'linda_backup.txt');
    }

    // --- RENDERING ---

    function renderChat() {
      const container = $('chat-log');
      container.innerHTML = '';
      
      const current = State.sessions.find(s => s.id === State.activeId);
      if (!current) return;

      current.messages.forEach(msg => {
        appendMessageToDOM(container, msg.role, msg.content);
      });

      // Scroll to bottom
      setTimeout(() => container.scrollTop = container.scrollHeight, 50);
    }

    function appendMessageToDOM(container, role, content) {
      const div = document.createElement('div');
      
      // Determine if we need actions (only for assistant)
      if (role === 'assistant') {
        div.innerHTML = `
          <div class="msg assistant">${parseMarkdown(content)}</div>
          <div class="msg-actions">
            <button class="action-pill" onclick="copyText(this)">Kopieren</button>
            <button class="action-pill" onclick="shareText(this)">Teilen</button>
            <button class="action-pill" onclick="downloadPDF(this)">PDF</button>
          </div>
        `;
      } else {
        div.innerHTML = `<div class="msg user">${escapeHtml(content)}</div>`;
      }
      container.appendChild(div);
      
      // Auto scroll
      container.scrollTop = container.scrollHeight;
    }

    function renderSessionsList() {
      const list = $('sessions-list');
      if (!list) return;
      
      list.innerHTML = State.sessions.map(s => `
        <div class="session-card" onclick="switchSession('${s.id}')">
          <div class="session-info">
            <div class="session-name">${escapeHtml(s.name)}</div>
            <div class="session-date">${new Date(s.ts).toLocaleDateString('de-DE')} ‚Ä¢ ${s.messages.length} Nachrichten</div>
          </div>
          <div class="session-actions" onclick="event.stopPropagation()">
            <button class="icon-btn" onclick="renameSession('${s.id}')" title="Umbenennen">‚úèÔ∏è</button>
            <button class="icon-btn" onclick="exportSession('${s.id}')" title="Export">‚¨áÔ∏è</button>
            <button class="icon-btn" onclick="deleteSession('${s.id}')" title="L√∂schen">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function addMessage(role, content, isUpdate = false) {
      const s = State.sessions.find(x => x.id === State.activeId);
      if (!s) return;

      if (isUpdate && s.messages.length > 0 && s.messages[s.messages.length - 1].role === role) {
        s.messages[s.messages.length - 1].content = content;
      } else {
        s.messages.push({ role, content });
      }
      
      persist();
      
      if ($('view-chat').classList.contains('active')) {
        const container = $('chat-log');
        if (isUpdate && container.lastElementChild && container.lastElementChild.querySelector('.' + role)) {
           // Update last message in DOM
           const el = container.lastElementChild;
           if (role === 'assistant') {
             el.innerHTML = `
              <div class="msg assistant">${parseMarkdown(content)}</div>
              <div class="msg-actions">
                <button class="action-pill" onclick="copyText(this)">Kopieren</button>
                <button class="action-pill" onclick="shareText(this)">Teilen</button>
                <button class="action-pill" onclick="downloadPDF(this)">PDF</button>
              </div>
            `;
           } else {
             el.innerHTML = `<div class="msg user">${escapeHtml(content)}</div>`;
           }
        } else {
          appendMessageToDOM(container, role, content);
        }
      }
    }

    // --- API LOGIC (Unified) ---

    async function sendRequest(prompt, source = 'chat') {
      // Prepare Data
      const s = State.sessions.find(x => x.id === State.activeId);
      let history = [];
      if (s && s.messages.length > 0) {
        // Take last 4 messages for context
        const lastMsgs = s.messages.slice(-4);
        history = lastMsgs.map(m => ({ role: m.role, content: m.content }));
      }

      const payload = {
        question: prompt,
        fachmodus: State.settings.domain || '',
        token: State.token,
        gender: State.settings.gender || false,
        history: history
      };

      // UI Handling based on source
      if (source === 'chat') {
        // Chat handles UI via addMessage
      } else if (source === 'writer') {
        $('writer-output').innerHTML = '<span class="pulse-dots"></span>';
        $('writer-output').classList.add('loading');
        $('writer-generate').disabled = true;
      }

      // Abort Logic
      if (State.abortController) State.abortController.abort();
      State.abortController = new AbortController();

      try {
        const response = await fetch('/api/bot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: State.abortController.signal
        });

        if (!response.ok) throw new Error('Netzwerkfehler');

        const text = await response.text();
        const cleanText = (text && text.trim() !== 'Accepted') ? text : 'Antwort erhalten (leer).';

        return cleanText;

      } catch (error) {
        if (error.name === 'AbortError') {
          return 'abgebrochen';
        }
        return 'Fehler: ' + error.message;
      } finally {
        State.abortController = null;
      }
    }

    // --- CHAT EVENT HANDLERS ---

    $('chat-send').addEventListener('click', async () => {
      const input = $('chat-input');
      const text = input.value.trim();
      if (!text) return;

      input.value = '';
      input.style.height = 'auto'; // Reset height

      addMessage('user', text);
      
      // Add placeholder loading
      const loadingId = 'loading-' + Date.now();
      addMessage('assistant', '<div style="color:var(--text-secondary);">Generiere Antwort...</div>');

      // Send to API
      const response = await sendRequest(text, 'chat');
      
      // Update placeholder with real response
      addMessage('assistant', response, true);
    });

    $('chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        $('chat-send').click();
      }
    });

    // Auto-resize textarea
    ['chat-input', 'writer-input'].forEach(id => {
      const el = $(id);
      if(el) {
        el.addEventListener('input', function() {
          this.style.height = 'auto';
          this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });
      }
    });

    // --- WRITER EVENT HANDLERS ---

    $('writer-generate').addEventListener('click', async () => {
      const text = $('writer-input').value.trim();
      const style = $('writer-style').value;
      const userPrompt = $('writer-prompt').value.trim();

      if (!text) {
        alert('Bitte Text eingeben.');
        return;
      }

      // Build Context for Writer
      let finalPrompt = "Optimiere folgenden Text.";
      
      if (style === 'formell') finalPrompt += " Formuliere ihn sehr professionell und formell.";
      if (style === 'freundlich') finalPrompt += " Formuliere ihn freundlich, locker und nat√ºrlich.";
      if (style === 'kurz') finalPrompt += " Fasse ihn kurz und pr√§gnant zusammen.";
      if (style === 'marketing') finalPrompt += " Formuliere ihn werbend und √ºberzeugend.";

      if (userPrompt) {
        finalPrompt += ` Besondere Anweisung: ${userPrompt}`;
      }

      finalPrompt += "\n\nZu optimierender Text:\n" + text;

      // Temporarily inject this prompt into the session logic? 
      // For this unified API, we just send it as "question".
      // But we want the history to be ignored for the Writer (it's a fresh task usually)
      // So we set history to empty temporarily for the pure rewriting task
      const sBackup = State.sessions.find(x => x.id === State.activeId);
      const historyBackup = sBackup ? sBackup.messages.slice(-4).map(m => ({ role: m.role, content: m.content })) : [];
      
      // Hack: Force empty history for pure rewriting to avoid confusion, 
      // or keep it if user wants context. Let's keep it (logic says context is good).
      // But we need to override the specific prompt.
      
      // We will temporarily fake the "Question" in the API payload.
      // The API expects {question, ...}
      
      // To make this clean without changing API: 
      // We will manually call the fetch here instead of sendRequest to control payload.
      
      $('writer-output').innerHTML = '<span class="pulse-dots"></span>';
      $('writer-output').classList.add('loading');
      $('writer-generate').disabled = true;

      const payload = {
        question: finalPrompt, // This is the trick: Overwrite question with instruction + text
        fachmodus: State.settings.domain || '',
        token: State.token,
        gender: State.settings.gender || false,
        history: [] // No history for pure rewriting to avoid context confusion
      };

      try {
        const res = await fetch('/api/bot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const txt = await res.text();
        const out = (txt && txt.trim() !== 'Accepted') ? txt : 'Keine Antwort erhalten.';
        $('writer-output').innerText = out;
        $('writer-output').classList.remove('loading');
      } catch (e) {
        $('writer-output').innerText = 'Fehler: ' + e.message;
        $('writer-output').classList.remove('loading');
      } finally {
        $('writer-generate').disabled = false;
      }
    });

    $('writer-copy').addEventListener('click', () => {
      const txt = $('writer-output').innerText;
      if (txt && !txt.includes('erscheint hier')) {
        navigator.clipboard.writeText(txt).then(() => alert('Kopiert!'));
      }
    });

    $('writer-share').addEventListener('click', () => {
      const txt = $('writer-output').innerText;
      if (txt && !txt.includes('erscheint hier')) {
        if (navigator.share) {
          navigator.share({ title: 'Optimierter Text', text: txt }).catch(() => {});
        } else {
          navigator.clipboard.writeText(txt).then(() => alert('In Zwischenablage kopiert (Teilen nicht verf√ºgbar).'));
        }
      }
    });

    // --- NAVIGATION ---

    document.querySelectorAll('.nav-item').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.getAttribute('data-target');
        switchTab(targetId);
        
        // Update Tab Active State
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Header Back Button logic (Only show if needed, simplified here)
        $('header-back-btn').style.display = 'none';
      });
    });

    function switchTab(viewId) {
      // Hide all views
      ['view-chat', 'view-writer', 'view-sessions'].forEach(id => {
        $(id).classList.remove('active');
      });
      // Show target
      $(viewId).classList.add('active');
    }

    function switchSession(id) {
      if (State.activeId === id) {
        switchTab('view-chat');
        return;
      }
      State.activeId = id;
      persist();
      renderChat();
      switchTab('view-chat');
      // Update active tab UI
      document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
      document.querySelector('[data-target="view-chat"]').classList.add('active');
    }

    // --- MODALS & SETTINGS ---

    function openModal(id) {
      $(id).classList.add('open');
    }

    function closeModal(id) {
      $(id).classList.remove('open');
    }

    // Privacy
    $('btn-privacy-accept').addEventListener('click', () => {
      State.privacyAccepted = true;
      Store.set('linda.privacy', true);
      closeModal('modal-privacy');
      init();
    });
    $('btn-privacy-decline').addEventListener('click', () => {
      alert('Du musst zustimmen, um die App zu nutzen.');
    });

    // Usage
    $('btn-usage-ok').addEventListener('click', () => {
      State.usageSeen = true;
      Store.set('linda.usage', true);
      closeModal('modal-usage');
    });

    // Settings Open/Close
    $('settings-btn').addEventListener('click', () => {
      // Populate Form
      $('set-theme').value = State.settings.theme;
      $('set-domain').value = State.settings.domain;
      $('set-gender').checked = State.settings.gender;
      $('set-greet').checked = State.settings.greet;
      openModal('modal-settings');
    });

    $('btn-settings-close').addEventListener('click', () => closeModal('modal-settings'));

    $('btn-settings-save').addEventListener('click', () => {
      State.settings.theme = $('set-theme').value;
      State.settings.domain = $('set-domain').value;
      State.settings.gender = $('set-gender').checked;
      State.settings.greet = $('set-greet').checked;
      
      Store.set('linda.settings', State.settings);
      applyTheme();
      updateDomainBadge();
      closeModal('modal-settings');
    });

    // --- SESSION ACTIONS BUTTONS ---

    $('delete-all-btn').addEventListener('click', () => {
      if (confirm('Wirklich ALLE Verl√§ufe l√∂schen?')) {
        State.sessions = [];
        ensureSession();
        persist();
        renderChat();
        renderSessionsList();
      }
    });

    $('export-all-btn').addEventListener('click', exportAll);

    // --- UTILS ---

    function parseMarkdown(text) {
      if (!text) return '';
      let html = text
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") // Sanitize
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/^\* (.*)/gim, '<ul><li>$1</li></ul>')
        .replace(/<\/ul>\n<ul>/g, '\n') // Merge lists
        .replace(/\n/g, '<br>');
      return html;
    }

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function generateId() {
      return 's_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
    }

    function persist() {
      Store.set('linda.sessions', State.sessions);
      Store.set('linda.activeId', State.activeId);
      Store.set('linda.settings', State.settings);
    }

    function downloadText(content, filename) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Global functions for inline onclicks
    window.renameSession = renameSession;
    window.exportSession = exportSession;
    window.deleteSession = deleteSession;
    window.switchSession = switchSession;

    window.copyText = function(btn) {
      const container = btn.closest('.msg-actions').previousElementSibling;
      const text = container.innerText;
      navigator.clipboard.writeText(text).then(() => {
        const old = btn.innerText;
        btn.innerText = 'Kopiert!';
        setTimeout(() => btn.innerText = old, 1500);
      });
    };

    window.shareText = function(btn) {
      const container = btn.closest('.msg-actions').previousElementSibling;
      const text = container.innerText;
      if (navigator.share) {
        navigator.share({ text: text }).catch(() => {});
      } else {
        navigator.clipboard.writeText(text).then(() => alert('In Zwischenablage kopiert.'));
      }
    };

    window.downloadPDF = function(btn) {
      const container = btn.closest('.msg-actions').previousElementSibling;
      const content = container.innerText;
      const title = "Linda_Antwort_" + new Date().toISOString().slice(0,10);
      // Simple Print Trigger (Browser handles PDF)
      const w = window.open('', '_blank');
      w.document.write(`
        <html><head><title>${title}</title>
        <style>body{font-family:Arial; padding:40px; line-height:1.6;}</style>
        </head><body><h2>${title}</h2><pre>${content}</pre></body></html>
      `);
      w.document.close();
      w.focus();
      w.print();
    };

    // --- BOOT ---
    // Prevent context menu in text areas to allow real native actions, but block elsewhere (optional)
    // Here we keep it simple: only init.
    init();

  </script>
</body>
</html>
