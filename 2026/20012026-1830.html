<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Linda â€“ Deine persÃ¶nliche Assistentin (190126-1815)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

<style>
  :root {
    /* Farbsystem & Variablen */
    --bg: #ffffff;
    --panel: #f8f9fa;
    --line: #e9ecef;
    --text: #212529;
    --muted: #6c757d;

    --brand: #004481;
    --brand-2: #0071ce;
    --brand-danger: #dc3545;

    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    
    --font-body: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    
    /* Mobile-Spezifika (Dynamic, wird per JS/Default gesetzt) */
    --chat-font-size: 17px;
    --line-height: 1.6;
  }

  /* Dark Mode Override */
  body.dark {
    --bg: #121212;
    --panel: #1e1e1e;
    --line: #333333;
    --text: #e0e0e0;
    --muted: #a0a0a0;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  }

  /* Reset & Base */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    height: 100%;
    width: 100%;
    overflow: hidden; /* Verhindert Scrollen des Body, Scrolling nur im Chat */
    display: flex;
    flex-direction: column;
  }

  /* Specific Text Select Behavior */
  body { -webkit-user-select: none; user-select: none; }
  .bubble, .in, .ta { -webkit-user-select: text; user-select: text; }

  /* --- Layout Structure --- */
  
  /* Top Bar (Header) */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: var(--panel);
    border-bottom: 1px solid var(--line);
    height: 60px;
    flex-shrink: 0;
    z-index: 10;
  }
  .brand { font-weight: 700; font-size: 1.25rem; letter-spacing: -0.02em; color: var(--brand); }
  
  .top-actions { display: flex; gap: 0.5rem; align-items: center; }
  .icon-btn {
    background: transparent;
    border: none;
    padding: 8px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .icon-btn:hover { background: rgba(0, 0, 0, 0.05); }
  
  /* Badge (Fachmodus) */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(0, 68, 129, 0.1);
    color: var(--brand);
    border: 1px solid var(--line);
    white-space: nowrap;
  }

  /* Main Container */
  .main-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  /* Sidebar (Desktop Only) */
  .sidebar {
    width: 300px;
    border-right: 1px solid var(--line);
    background: var(--panel);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }
  .sidebar-header { padding: 1rem; border-bottom: 1px solid var(--line); font-weight: 600; }
  .session-list { overflow-y: auto; flex: 1; padding: 0.5rem; }
  
  .session-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem 1rem;
    margin-bottom: 4px;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .session-item:hover { background: rgba(0, 0, 0, 0.04); }
  .session-item.active { background: rgba(0, 68, 129, 0.1); border-left: 3px solid var(--brand); }
  .session-title { font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .session-meta { font-size: 0.75rem; color: var(--muted); }

  /* Chat Area */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: var(--bg);
  }

  /* Chat Log (Scrolling Area) */
  .chat-log {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch; /* Smooth iOS scroll */
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    scroll-behavior: smooth;
  }

  /* Bubbles */
  .bubble {
    max-width: 85%;
    padding: 1rem 1.2rem;
    border-radius: 18px; /* Modern chat radius */
    background: var(--panel);
    box-shadow: var(--shadow);
    line-height: var(--line-height);
    position: relative;
    word-break: break-word;
  }
  
  .bubble.user {
    align-self: flex-end;
    background: var(--brand);
    color: white;
    border-bottom-right-radius: 4px;
  }
  .bubble.assistant {
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  /* Markdown Content in Bubbles */
  .md h1, .md h2, .md h3 { margin: 0.5em 0; font-weight: 700; font-size: 1.1em; color: inherit; }
  .md p { margin: 0.75em 0; }
  .md ul, .md ol { margin: 0.5em 0 0.5em 1.5em; }
  .md code { background: rgba(0,0,0,0.1); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; }
  .md pre { background: var(--bg); padding: 1em; border-radius: var(--radius-sm); overflow-x: auto; margin: 1em 0; }

  /* Bubble Actions (Copy, Share, etc.) */
  .bubble-actions {
    display: flex;
    gap: 6px;
    margin-bottom: 8px;
    justify-content: flex-end;
    opacity: 0.8;
  }
  .action-btn {
    font-size: 0.8rem;
    background: transparent;
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 4px 8px;
    cursor: pointer;
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .action-btn:hover { background: rgba(0,0,0,0.05); color: var(--brand); }

  /* Sources Section */
  .sources {
    margin-top: 1rem;
    padding: 0.8rem;
    border: 1px solid var(--line);
    border-radius: var(--radius-sm);
    background: rgba(0, 68, 129, 0.04);
  }
  .sources-title { font-weight: 600; color: var(--brand); margin-bottom: 0.5rem; font-size: 0.9em; }
  .source-tag {
    display: inline-block;
    font-size: 0.8em;
    padding: 4px 8px;
    margin: 2px;
    border-radius: 999px;
    background: #fff;
    border: 1px solid var(--line);
    color: var(--text);
  }

  /* Composer (Input Area) */
  .composer {
    padding: 1rem;
    background: var(--panel);
    border-top: 1px solid var(--line);
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-shrink: 0;
  }
  
  .input-field {
    flex: 1;
    padding: 12px 16px;
    border-radius: var(--radius);
    border: 1px solid var(--line);
    background: var(--bg);
    color: var(--text);
    font-size: 16px; /* Min size for iOS Zoom prevention */
    outline: none;
    transition: border 0.2s;
  }
  .input-field:focus { border-color: var(--brand); }
  
  .send-btn {
    background: var(--brand);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: var(--radius);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    white-space: nowrap;
  }
  .send-btn:hover { background: var(--brand-2); }
  .send-btn.stop { background: var(--brand-danger); }
  .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Modals */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 1rem;
  }
  .modal.open { display: flex; }
  
  .modal-card {
    background: var(--bg);
    border-radius: var(--radius);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    border: 1px solid var(--line);
  }
  
  .card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--line);
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--brand);
  }
  
  .card-body { padding: 1.5rem; line-height: 1.6; }
  
  .card-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--line);
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
  }

  /* Buttons inside Modals */
  .btn {
    padding: 10px 20px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--line);
    background: var(--panel);
    color: var(--text);
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
  }
  .btn-primary {
    background: var(--brand);
    color: white;
    border: 1px solid var(--brand);
  }
  .btn:hover { background: rgba(0,0,0,0.05); }
  .btn-primary:hover { background: var(--brand-2); }

  /* Mobile Overlay Menus (Sessions/Settings) */
  .overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg);
    z-index: 900;
    display: flex;
    flex-direction: column;
    display: none;
  }
  .overlay.open { display: flex; }
  .overlay-header {
    padding: 1rem;
    border-bottom: 1px solid var(--line);
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 700;
  }
  .overlay-body { flex: 1; overflow-y: auto; padding: 1rem; }
  .overlay-footer { padding: 1rem; border-top: 1px solid var(--line); }

  /* Settings Form Elements */
  .setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid var(--line);
  }
  .switch {
    width: 50px; height: 28px;
    border-radius: 14px;
    background: #e0e0e0;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
  }
  .switch::after {
    content: '';
    position: absolute;
    width: 24px; height: 24px;
    top: 2px; left: 2px;
    background: white;
    border-radius: 50%;
    transition: transform 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  .switch.active { background: var(--brand); }
  .switch.active::after { transform: translateX(22px); }

  select, textarea {
    padding: 10px;
    border: 1px solid var(--line);
    border-radius: var(--radius-sm);
    background: var(--bg);
    color: var(--text);
    font-family: inherit;
    width: 100%;
    margin-top: 0.5rem;
  }

  /* --- Responsive Breakpoints --- */
  
  /* Tablet & Desktop (Show Sidebar) */
  @media (min-width: 769px) {
    .mobile-top { display: none; }
    .mobile-overlay { display: none !important; }
  }

  /* Mobile (iPhone/Android) - Below 769px */
  @media (max-width: 768px) {
    /* Force Font Size for Mobile */
    html, body { font-size: 16px; }
    
    .sidebar { display: none; } /* Hide Desktop Sidebar */
    
    /* Mobile Header Adjustments */
    .top-bar { height: 54px; padding: 0 0.75rem; }
    .brand { font-size: 1.1rem; }
    
    /* Chat Log */
    .chat-log {
      padding: 0.75rem; /* Less side padding */
      gap: 0.75rem;
    }
    
    /* Bubbles Mobile */
    .bubble {
      max-width: 90%;
      padding: 0.9rem 1.1rem;
      font-size: 17px; /* Optimal reading size */
      line-height: 1.6;
      border-radius: 16px;
    }
    
    .bubble-actions {
      flex-wrap: wrap; /* Wrap buttons on small screens */
      justify-content: flex-start;
    }

    /* Composer Mobile */
    .composer {
      padding: 0.75rem;
      gap: 0.5rem;
      background: var(--bg); /* Blend with background */
      border-top: none;
    }
    
    .input-field {
      font-size: 17px; /* Prevents zoom on iOS */
      padding: 14px 16px;
      border-radius: 16px;
      min-height: 54px;
    }
    
    .send-btn {
      padding: 14px 20px;
      border-radius: 16px;
      min-width: 80px;
    }
    
    /* Safe Areas for iPhone Notch/Home Bar */
    .composer {
      padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
    }
    .chat-log {
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
    }
  }

</style>
</head>
<body>

  <!-- PRIVACY MODAL (Auto Shown) -->
  <div id="m-privacy" class="modal open">
    <div class="modal-card">
      <div class="card-header">Datenschutzhinweis</div>
      <div class="card-body">
        <p>Um diesen Chatbot nutzen zu kÃ¶nnen, ist deine Zustimmung erforderlich:</p>
        <ul style="margin: 1rem 0 0 1.5rem; color: var(--muted);">
          <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) Ã¼bermittelt.</li>
          <li>Daten werden zur Generierung von Antworten verarbeitet.</li>
          <li>Bitte gib <strong>keine sensiblen Daten</strong> ein!</li>
          <li>Links: <a href="https://openai.com/policies/privacy-policy" target="_blank">OpenAI</a>, <a href="https://www.make.com/en/privacy-policy" target="_blank">Make.com</a>.</li>
        </ul>
        <p style="margin-top: 1rem; font-size: 0.9em; color: var(--muted);">
          Hinweis: Chatverlauf wird <strong>nur lokal</strong> gespeichert (localStorage).
        </p>
      </div>
      <div class="card-footer">
        <button class="btn" id="p-decline">Ablehnen</button>
        <button class="btn btn-primary" id="p-accept">Zustimmen</button>
      </div>
    </div>
  </div>

  <!-- USAGE MODAL -->
  <div id="m-usage" class="modal">
    <div class="modal-card">
      <div class="card-header">Wichtige Hinweise</div>
      <div class="card-body">
        <ul style="margin: 0 0 0 1.2rem;">
          <li><strong>Automatisierte Antworten:</strong> KI-generiert.</li>
          <li><strong>Keine GewÃ¤hr:</strong> PrÃ¼fe Inhalte auf Richtigkeit.</li>
          <li><strong>Kein Ersatz fÃ¼r Beratung:</strong> Keine Rechts-/Medizin-/Finanzberatung.</li>
        </ul>
      </div>
      <div class="card-footer">
        <button class="btn btn-primary" id="u-accept">Einverstanden</button>
      </div>
    </div>
  </div>

  <!-- SESSIONS OVERLAY (Mobile) -->
  <div id="m-sessions" class="overlay mobile-overlay">
    <div class="overlay-header">
      <span>VerlÃ¤ufe</span>
      <button class="icon-btn" onclick="hide(document.getElementById('m-sessions'))">âœ•</button>
    </div>
    <div class="overlay-body">
      <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
        <button class="btn" id="mob-new">Neuer Chat</button>
        <button class="btn" id="mob-export-all">Export</button>
        <button class="btn" id="mob-clear-all">LÃ¶schen</button>
      </div>
      <div id="mob-sess-list"></div>
    </div>
  </div>

  <!-- SETTINGS OVERLAY (Mobile) -->
  <div id="m-settings" class="overlay mobile-overlay">
    <div class="overlay-header">
      <span>Einstellungen</span>
      <button class="icon-btn" onclick="hide(document.getElementById('m-settings'))">âœ•</button>
    </div>
    <div class="overlay-body">
      <div class="setting-row">
        <span>Dark Mode</span>
        <div id="sw-theme" class="switch"></div>
      </div>
      <div class="setting-row">
        <span>Gendern</span>
        <div id="sw-gender" class="switch"></div>
      </div>
      <div class="setting-row">
        <span>Fachmodus</span>
        <select id="sel-domain-mobile">
          <option value="">Kein Modus</option>
          <option value="AEVO">AEVO</option>
          <option value="VWL">VWL</option>
          <option value="PERSONAL">Personal</option>
        </select>
      </div>
    </div>
    <div class="overlay-footer">
      <button class="btn btn-primary" id="s-save-mobile">Speichern</button>
    </div>
  </div>

  <!-- FEEDBACK MODAL -->
  <div id="m-feedback" class="modal">
    <div class="modal-card">
      <div class="card-header">Feedback</div>
      <div class="card-body">
        <p>Feedback Ã¶ffnet dein E-Mail-Programm. Der Chatverlauf kann als Datei angehÃ¤ngt werden.</p>
      </div>
      <div class="card-footer">
        <button class="btn" id="fb-cancel">Abbrechen</button>
        <button class="btn btn-primary" id="fb-continue">Weiter</button>
      </div>
    </div>
  </div>

  <!-- MAIN UI -->
  <div class="top-bar">
    <div class="brand">Linda</div>
    <div id="domain-badge" class="badge" style="display:none;">ðŸ“˜ â€”</div>
    <div class="top-actions">
      <!-- Mobile Session Toggle -->
      <button class="icon-btn" id="btn-open-sessions" title="VerlÃ¤ufe">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
      </button>
      <!-- Settings -->
      <button class="icon-btn" id="btn-open-settings" title="Einstellungen">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
      </button>
    </div>
  </div>

  <div class="main-layout">
    <!-- Desktop Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">VerlÃ¤ufe</div>
      <div id="desktop-sess-list" class="session-list"></div>
    </aside>

    <!-- Chat Area -->
    <main class="chat-area">
      <div id="log" class="chat-log">
        <!-- Messages appear here -->
      </div>
      <div class="composer">
        <input id="in" class="input-field" placeholder="Deine Frage..." type="text" autocomplete="off" />
        <button id="send" class="send-btn">Senden</button>
      </div>
    </main>
  </div>

  <!-- SCRIPTS & LOGIC -->
  <script id="linda-context-addon">
    // (UNTOUCHED LOGIC: Context injection wrapper)
    (function(){
        if (localStorage.getItem('linda.addon.disabled') === '1') { return; }
        const MAX_CONTEXT_CHARS = 2500;
        function getFachmodus() {
            const selMobile = document.getElementById('sel-domain-mobile');
            const selDesktop = document.getElementById('sel-domain');
            return (selMobile && selMobile.value) || (selDesktop && selDesktop.value) || '';
        }
        function buildCompressedContext() {
            let rawSessions = null, sessions = [], activeId = null, session = null;
            try { rawSessions = localStorage.getItem('linda.sessions'); sessions = rawSessions ? JSON.parse(rawSessions) : []; } catch {}
            try { activeId = localStorage.getItem('linda.activeId'); } catch {}
            if (activeId) session = sessions.find(s=>s.id===activeId);
            if (!session && sessions.length) session = sessions[0];
            if (!session || !Array.isArray(session.messages)) return '';
            let context = ''; let currentLen = 0;
            const msgs = session.messages;
            for (let i = msgs.length - 1; i >= 0; i--) {
                const m = msgs[i];
                const txt = (m.role==='user'?'User: ':'Linda: ') + (m.content||'') + "\n";
                if (currentLen + txt.length > MAX_CONTEXT_CHARS) break;
                context = txt + context; currentLen += txt.length;
            }
            return context;
        }
        const _origFetch = window.fetch.bind(window);
        window.fetch = async function(url, options = {}) {
            try {
                const method = ((options && options.method) || "GET").toUpperCase();
                if (method === "POST" && options.body && typeof options.body === "string" && options.body.trim().startsWith("{")) {
                    try {
                        const body = JSON.parse(options.body);
                        if (body && typeof body === "object" && (body.question || body.message) && !("context" in body)) {
                            const augmented = { ...body, context: buildCompressedContext(), fachmodus: getFachmodus() };
                            options.body = JSON.stringify(augmented);
                        }
                    } catch {}
                }
            } catch {}
            return _origFetch(url, options);
        };
    })();
  </script>

  <script>
    (function(){
      // --- Core Logic (Mostly Untouched, Adapted for Mobile) ---
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('copy', e => e.preventDefault());
      document.addEventListener('cut', e => e.preventDefault());
      document.addEventListener('paste', e => e.preventDefault());
      document.addEventListener('selectstart', e => e.preventDefault());

      const uniqueToken = 'Linda-v28.0-' + Date.now();
      const $ = id => document.getElementById(id);
      const LS = {
        get: (k,d) => { try { return JSON.parse(localStorage.getItem(k)) || d; } catch { return d; } },
        set: (k,v) => localStorage.setItem(k, JSON.stringify(v))
      };

      let settings = LS.get('linda.settings', { dark: false, gender: false, greet: true, domain: '', font: 'Arial', fontSize: '12' });
      let sessions = LS.get('linda.sessions', []);
      let activeId = LS.get('linda.activeId', null);
      let abortCtrl = null;

      // --- DOM Helpers ---
      const show = el => el.style.display = 'flex';
      const hide = el => el.style.display = 'none';
      const uid = () => 's_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);

      function saveState() {
        LS.set('linda.settings', settings);
        LS.set('linda.sessions', sessions);
        LS.set('linda.activeId', activeId);
        updateBadge();
      }

      function activeSession() {
        return sessions.find(s => s.id === activeId);
      }

      function setActive(id) {
        activeId = id;
        saveState();
        renderMobileSessions();
        renderDesktopSessions();
        renderChat();
      }

      function addSession() {
        const id = uid();
        sessions.unshift({ id, name: 'Neuer Chat', ts: Date.now(), messages: [] });
        setActive(id);
      }

      // --- Rendering ---
      function applyTheme() {
        document.body.classList.toggle('dark', settings.dark);
        // Update toggles
        document.querySelectorAll('.switch').forEach(s => s.classList.remove('active'));
        if (settings.dark) $('sw-theme').classList.add('active');
        if (settings.gender) $('sw-gender').classList.add('active');
        
        // Update Selects
        if($('sel-domain-mobile')) $('sel-domain-mobile').value = settings.domain || '';
      }

      function updateBadge() {
        const b = $('domain-badge');
        if (settings.domain) {
          b.style.display = 'inline-flex';
          b.innerHTML = `ðŸ“˜ ${settings.domain} ${settings.gender ? 'â™€' : ''}`;
        } else {
          b.style.display = 'none';
        }
      }

      function renderList(container, isMobile) {
        if (!container) return;
        const visible = sessions.slice(0, 4);
        container.innerHTML = visible.map(s => `
          <div class="${isMobile ? 'session-item' : 'session-item'} ${s.id === activeId ? 'active' : ''}" data-id="${s.id}">
            <div style="flex:1; overflow:hidden;">
              <div class="session-title">${s.name || 'Chat'}</div>
              <div class="session-meta">${new Date(s.ts).toLocaleDateString()}</div>
            </div>
            ${isMobile ? '' : `
              <div style="display:flex; gap:4px;">
                <button class="btn" style="padding:4px 8px; font-size:0.8rem;" onclick="event.stopPropagation(); renameSession('${s.id}')">âœŽ</button>
                <button class="btn" style="padding:4px 8px; font-size:0.8rem;" onclick="event.stopPropagation(); exportSession('${s.id}')">â†“</button>
                <button class="btn" style="padding:4px 8px; font-size:0.8rem;" onclick="event.stopPropagation(); deleteSession('${s.id}')">Ã—</button>
              </div>
            `}
          </div>
        `).join('');

        container.querySelectorAll('.session-item').forEach(item => {
          item.onclick = () => {
            setActive(item.dataset.id);
            if (isMobile) hide($('m-sessions'));
          };
        });
      }

      const renderMobileSessions = () => renderList($('mob-sess-list'), true);
      const renderDesktopSessions = () => renderList($('desktop-sess-list'), false);

      function renderChat() {
        const log = $('log');
        const s = activeSession();
        if (!s) return;
        
        log.innerHTML = '';
        s.messages.forEach(m => {
          const div = document.createElement('div');
          div.className = `bubble ${m.role}`;
          
          if (m.role === 'assistant') {
            // Parse MD safely
            const rawHtml = DOMPurify.sanitize(marked.parse(m.content || ''));
            
            // Build Action Buttons HTML
            const actionsHtml = `
              <div class="bubble-actions">
                <button class="action-btn" onclick="copyMsg(this)">ðŸ“‹</button>
                <button class="action-btn" onclick="shareMsg(this)">â†—</button>
                <button class="action-btn" onclick="pdfMsg(this)">ðŸ–¨</button>
                <button class="action-btn" onclick="feedbackMsg()">ðŸ‘Ž</button>
              </div>
            `;
            
            div.innerHTML = actionsHtml + `<div class="md">${rawHtml}</div>`;
            
            // Post-process for sources (Simple check)
            setTimeout(() => {
              const md = div.querySelector('.md');
              const headings = md.querySelectorAll('h1,h2,h3');
              headings.forEach(h => {
                if (/quellen|source/i.test(h.textContent)) {
                  const list = h.nextElementSibling;
                  if (list && list.tagName === 'UL') {
                    const wrap = document.createElement('div');
                    wrap.className = 'sources';
                    wrap.innerHTML = `<div class="sources-title">Quellen</div>`;
                    const ul = document.createElement('div');
                    list.querySelectorAll('li').forEach(li => {
                      const tag = document.createElement('span');
                      tag.className = 'source-tag';
                      tag.textContent = li.textContent.trim();
                      ul.appendChild(tag);
                    });
                    wrap.appendChild(ul);
                    list.replaceWith(wrap);
                    h.remove();
                  }
                }
              });
            }, 0);
          } else {
            div.textContent = m.content; // User text is plain
          }
          log.appendChild(div);
        });
        
        // Scroll to bottom
        setTimeout(() => { log.scrollTop = log.scrollHeight; }, 50);
      }

      // --- Actions ---
      window.renameSession = (id) => {
        const s = sessions.find(x => x.id === id);
        if (!s) return;
        const nn = prompt('Neuer Name:', s.name);
        if (nn !== null) { s.name = nn.trim() || s.name; saveState(); renderDesktopSessions(); renderMobileSessions(); }
      };

      window.deleteSession = (id) => {
        if (!confirm('Verlauf wirklich lÃ¶schen?')) return;
        sessions = sessions.filter(x => x.id !== id);
        if (!sessions.length) addSession();
        else if (activeId === id) activeId = sessions[0].id;
        saveState(); renderDesktopSessions(); renderMobileSessions(); renderChat();
      };

      window.exportSession = (id) => {
        const s = sessions.find(x => x.id === id);
        if (!s) return;
        const text = s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + m.content).join('\n\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (s.name || 'chat') + '.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      };

      window.exportAll = () => {
        const text = sessions.map(s => `# ${s.name}\n\n${s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + m.content).join('\n\n')}`).join('\n\n---\n\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'linda_chats.txt';
        a.click();
      };

      window.clearAll = () => {
        if (!confirm('Alle VerlÃ¤ufe lÃ¶schen?')) return;
        sessions = [];
        addSession();
        saveState(); renderDesktopSessions(); renderMobileSessions(); renderChat();
      };

      // --- Bubble Actions (Contextual) ---
      // Find the closest bubble to the button pressed
      const findBubbleContent = (btn) => {
        const bubble = btn.closest('.bubble');
        const q = activeSession().messages.find(m => m.role === 'user');
        const a = bubble ? bubble.querySelector('.md')?.innerText || bubble.innerText : '';
        return {
          q: q ? q.content : '',
          a: a
        };
      };

      window.copyMsg = (btn) => {
        const { q, a } = findBubbleContent(btn);
        const txt = `Frage: ${q}\n\nAntwort: ${a}`;
        navigator.clipboard.writeText(txt).then(() => {
          const orig = btn.innerHTML;
          btn.innerHTML = 'âœ”';
          setTimeout(() => btn.innerHTML = orig, 1000);
        });
      };

      window.shareMsg = (btn) => {
        const { q, a } = findBubbleContent(btn);
        const txt = `Frage: ${q}\n\nAntwort: ${a}`;
        if (navigator.share) {
          navigator.share({ title: 'Linda Chat', text: txt }).catch(() => {});
        } else {
          window.location.href = `mailto:?subject=Linda&body=${encodeURIComponent(txt)}`;
        }
      };

      window.pdfMsg = (btn) => {
        const { q, a } = findBubbleContent(btn);
        const win = window.open('', '_blank');
        if (!win) return;
        win.document.write(`
          <html><head><title>Druck</title></head>
          <body style="font-family: sans-serif; max-width: 800px; margin: 2rem auto; line-height: 1.5;">
            <h2>Frage:</h2><p>${q}</p>
            <hr>
            <h2>Antwort:</h2><p style="white-space: pre-wrap;">${a}</p>
            <div style="margin-top: 2rem; color: #666; font-size: 0.8rem;">Generiert von Linda KI - PrÃ¼fe Inhalte.</div>
          </body></html>
        `);
        win.document.close();
        win.print();
      };

      window.feedbackMsg = () => {
        show($('m-feedback'));
      };

      // --- Send Logic ---
      $('send').onclick = () => {
        const sendBtn = $('send');
        const inp = $('in');

        if (abortCtrl) {
          // Abort
          abortCtrl.abort();
          abortCtrl = null;
          sendBtn.textContent = 'Senden';
          sendBtn.classList.remove('stop');
          return;
        }

        const q = inp.value.trim();
        if (!q) return;
        
        inp.value = '';
        sendBtn.textContent = 'â–  Stopp';
        sendBtn.classList.add('stop');

        const s = activeSession();
        s.messages.push({ role: 'user', content: q });
        s.ts = Date.now();
        
        // Add temp loading message
        s.messages.push({ role: 'assistant', content: 'â³ Einen Moment...' });
        saveState();
        renderChat();

        abortCtrl = new AbortController();

        const payload = {
          question: q,
          fachmodus: settings.domain || '',
          token: uniqueToken,
          history: s.messages.slice(-3) // Send recent history
        };

        fetch('/api/bot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: abortCtrl.signal
        })
        .then(r => r.text())
        .then(text => {
          const out = (text && text.trim().toLowerCase() !== 'accepted') ? text : 'Antwort erhalten.';
          s.messages[s.messages.length - 1] = { role: 'assistant', content: out };
        })
        .catch(e => {
          if (e.name !== 'AbortError') {
            s.messages[s.messages.length - 1] = { role: 'assistant', content: 'Verbindungsfehler.' };
          } else {
            s.messages[s.messages.length - 1] = { role: 'assistant', content: 'Abgebrochen.' };
          }
        })
        .finally(() => {
          saveState();
          renderChat();
          sendBtn.textContent = 'Senden';
          sendBtn.classList.remove('stop');
          abortCtrl = null;
          inp.focus();
        });
      };

      $('in').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          $('send').click();
        }
      });

      // --- Event Listeners (Modals & Toggles) ---
      $('p-accept').onclick = () => {
        hide($('m-privacy'));
        show($('m-usage'));
        if (settings.greet) {
          const s = activeSession();
          if (s.messages.length === 0) {
            s.messages.push({ role: 'assistant', content: '**Willkommen!** WÃ¤hle einen Fachmodus in den Einstellungen.' });
            saveState(); renderChat();
          }
        }
      };
      $('p-decline').onclick = () => location.reload();
      $('u-accept').onclick = () => hide($('m-usage'));
      
      $('fb-cancel').onclick = () => hide($('m-feedback'));
      $('fb-continue').onclick = () => {
        hide($('m-feedback'));
        window.open('mailto:KI-TEST@GMX.COM?subject=Feedback Linda');
      };

      // Mobile Overlay Toggles
      $('btn-open-sessions').onclick = () => { renderMobileSessions(); show($('m-sessions')); };
      $('btn-open-settings').onclick = () => { applyTheme(); show($('m-settings')); };

      // Mobile Overlay Actions
      $('mob-new').onclick = addSession;
      $('mob-export-all').onclick = exportAll;
      $('mob-clear-all').onclick = clearAll;
      $('s-save-mobile').onclick = () => {
        settings.dark = $('sw-theme').classList.contains('active');
        settings.gender = $('sw-gender').classList.contains('active');
        settings.domain = $('sel-domain-mobile').value;
        saveState();
        applyTheme();
        hide($('m-settings'));
      };

      // Toggle Switches Logic
      const toggleSwitch = (id, key) => {
        const el = $(id);
        el.onclick = () => {
          el.classList.toggle('active');
          if (key) settings[key] = el.classList.contains('active');
        };
      };
      toggleSwitch('sw-theme', 'dark');
      toggleSwitch('sw-gender', 'gender');

      // --- Init ---
      if (sessions.length === 0) addSession();
      applyTheme();
      updateBadge();
      renderDesktopSessions();
      renderChat();

    })();
  </script>

</body>
</html>
