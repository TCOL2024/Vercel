<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Linda â€“ Deine persÃ¶nliche Assistentin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

<style>
  :root {
    --bg: #ffffff;
    --panel: #f8f9fa;
    --line: #e9ecef;
    --text: #212529;
    --muted: #6c757d;
    --brand: #004481;
    --brand-2: #0071ce;
    --brand-danger: #dc3545;
    --radius: 12px;
    --font-body: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  }

  /* Reset & Base */
  *, *::before, *::after { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--text);
    height: 100dvh; /* Dynamic Viewport Height */
    width: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    -webkit-user-select: none;
    user-select: none;
  }
  .bubble, .in, textarea { -webkit-user-select: text; user-select: text; }

  /* Header */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1rem;
    background: var(--panel);
    border-bottom: 1px solid var(--line);
    flex-shrink: 0;
    z-index: 10;
  }
  .brand { font-weight: 700; font-size: 1.2rem; color: var(--brand); }
  .badge {
    font-size: 0.8rem;
    padding: 6px 10px;
    border-radius: 999px;
    background: rgba(0, 68, 129, 0.1);
    color: var(--brand);
    border: 1px solid var(--line);
    white-space: nowrap;
    display: none;
  }
  .icon-btn { background: transparent; border: none; padding: 8px; border-radius: 8px; cursor: pointer; opacity: 0.8; }
  .icon-btn:hover { opacity: 1; background: rgba(0,0,0,0.05); }

  /* Layout */
  .app-container { display: flex; flex: 1; overflow: hidden; position: relative; }
  
  /* Sidebar (Desktop) */
  .sidebar {
    width: 280px;
    background: var(--panel);
    border-right: 1px solid var(--line);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }
  .sidebar-header { padding: 1rem; font-weight: 600; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; }
  .session-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
  
  .session-item {
    padding: 10px 12px;
    margin-bottom: 6px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
  }
  .session-item:hover { background: rgba(0,0,0,0.05); }
  .session-item.active { background: rgba(0, 68, 129, 0.1); font-weight: 600; border-left: 3px solid var(--brand); }
  .session-meta { font-size: 0.75rem; color: var(--muted); margin-top: 2px; }
  .desktop-actions { display: flex; gap: 4px; }
  .desktop-btn { font-size: 0.7rem; padding: 2px 6px; background: transparent; border: 1px solid var(--line); border-radius: 4px; cursor: pointer; }

  /* Chat Area */
  .chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
  .chat-log {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    scroll-behavior: smooth;
  }

  /* Bubbles */
  .bubble {
    max-width: 82%;
    padding: 12px 16px;
    border-radius: 18px;
    background: var(--panel);
    line-height: 1.6;
    position: relative;
    word-break: break-word;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  .bubble.assistant { align-self: flex-start; border-bottom-left-radius: 4px; }
  .bubble.user { align-self: flex-end; background: var(--brand); color: white; border-bottom-right-radius: 4px; }

  /* Markdown & Content Styling */
  .md h1, .md h2, .md h3 { font-weight: 700; margin: 8px 0; font-size: 1.1em; color: inherit; }
  .md p { margin: 6px 0; }
  .md ul, .md ol { margin: 4px 0 4px 20px; }
  .md code { background: rgba(0,0,0,0.15); padding: 2px 6px; border-radius: 4px; font-family: monospace; }
  .md pre { background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px; overflow-x: auto; margin: 10px 0; white-space: pre-wrap; }
  
  /* Table Styling (Responsive) */
  .md table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.9em; }
  .md th, .md td { border: 1px solid var(--line); padding: 8px; text-align: left; }
  .md th { background: rgba(0,0,0,0.05); }
  .md .table-wrapper { overflow-x: auto; margin: 10px 0; border: 1px solid var(--line); border-radius: 8px; }

  /* Bold Fix ($ detection) */
  .md strong { font-weight: 700; } 
  .md em { font-style: italic; }

  /* User Bubble overrides */
  .bubble.user .md code { background: rgba(255,255,255,0.25); }
  .bubble.user .md strong { color: #fff; } 

  /* Bubble Actions */
  .bubble-actions { display: flex; gap: 6px; margin-top: 8px; justify-content: flex-end; flex-wrap: wrap; }
  .action-btn { font-size: 0.75rem; background: transparent; border: 1px solid rgba(0,0,0,0.15); color: inherit; border-radius: 999px; padding: 4px 8px; cursor: pointer; opacity: 0.7; }
  .action-btn:hover { opacity: 1; background: rgba(0,0,0,0.05); }
  .bubble.user .action-btn { border-color: rgba(255,255,255,0.3); }
  .bubble.user .action-btn:hover { background: rgba(255,255,255,0.1); }

  /* Sources */
  .sources {
    margin-top: 10px;
    padding: 8px;
    border-radius: 8px;
    background: rgba(0, 68, 129, 0.05);
    border: 1px solid var(--line);
  }
  .source-tag {
    display: inline-block;
    font-size: 0.75rem;
    padding: 4px 8px;
    margin: 2px;
    border-radius: 999px;
    background: white;
    border: 1px solid var(--line);
    color: #333;
  }

  /* Composer */
  .composer { padding: 1rem; background: var(--bg); border-top: 1px solid var(--line); display: flex; gap: 10px; align-items: flex-end; flex-shrink: 0; }
  .input-field {
    flex: 1;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: var(--panel);
    color: var(--text);
    font-size: 16px;
    font-family: inherit;
    resize: none;
    min-height: 46px;
    max-height: 150px;
    outline: none;
  }
  .input-field:focus { border-color: var(--brand); background: var(--bg); }
  .send-btn { background: var(--brand); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; white-space: nowrap; min-width: 80px; }
  .send-btn.stop { background: var(--brand-danger); }
  .send-btn:disabled { opacity: 0.5; }

  /* Modals & Overlays */
  .overlay, .modal {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); z-index: 1000;
    display: none; align-items: center; justify-content: center; padding: 20px;
  }
  .overlay.open, .modal.open { display: flex; }
  
  .card {
    background: var(--bg); width: 100%; max-width: 500px; border-radius: 14px; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 1px solid var(--line); max-height: 90vh; display: flex; flex-direction: column;
  }
  .card-header { padding: 1rem 1.2rem; border-bottom: 1px solid var(--line); font-weight: 700; font-size: 1.1rem; color: var(--brand); }
  .card-body { padding: 1.2rem; overflow-y: auto; }
  .card-footer { padding: 1rem 1.2rem; border-top: 1px solid var(--line); display: flex; justify-content: flex-end; gap: 10px; background: var(--panel); }

  .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid var(--line); background: white; color: #333; font-weight: 600; cursor: pointer; }
  .btn-primary { background: var(--brand); color: white; border-color: var(--brand); }
  .btn-danger { background: var(--brand-danger); color: white; border-color: var(--brand-danger); }

  /* Mobile Menu */
  .mobile-menu {
    position: fixed; inset: 0; background: var(--bg); z-index: 1100; display: none; flex-direction: column;
  }
  .mobile-menu.open { display: flex; }
  .mobile-header { padding: 1rem; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
  .mobile-body { flex: 1; overflow-y: auto; padding: 1rem; }
  .mobile-footer { padding: 1rem; border-top: 1px solid var(--line); }

  /* Settings Elements */
  .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--line); flex-wrap: wrap; gap: 10px; }
  .setting-row label { font-weight: 500; }
  
  /* Snippet Chips */
  .chip-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
  .chip {
    background: var(--panel); border: 1px solid var(--line); padding: 6px 12px; border-radius: 999px; cursor: pointer; font-size: 0.85rem;
    display: flex; align-items: center; gap: 6px;
  }
  .chip:hover { background: #e9ecef; }
  .chip-delete { color: var(--brand-danger); cursor: pointer; font-weight: bold; }

  /* Responsive */
  @media (min-width: 769px) {
    .mobile-only { display: none !important; }
    .sidebar { display: flex !important; }
  }

  @media (max-width: 768px) {
    .sidebar { display: none !important; }
    .chat-log { padding: 10px; gap: 8px; }
    .bubble { max-width: 90%; padding: 10px 14px; font-size: 16px; }
    .composer { padding: 10px; gap: 8px; }
    .input-field { padding: 12px 14px; font-size: 17px; border-radius: 12px; min-height: 48px; }
    .send-btn { padding: 12px 16px; border-radius: 12px; min-width: 70px; }
    .composer { padding-bottom: max(10px, env(safe-area-inset-bottom)); }
    .top-bar { padding-top: max(8px, env(safe-area-inset-top)); }
  }
</style>
</head>
<body>

  <!-- Privacy Modal -->
  <div id="m-privacy" class="modal open">
    <div class="card">
      <div class="card-header">Datenschutzhinweis</div>
      <div class="card-body">
        <p>Um diesen Chatbot nutzen zu kÃ¶nnen, ist deine Zustimmung erforderlich:</p>
        <ul style="margin: 1rem 0 0 1.5rem; color: var(--muted);">
          <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) Ã¼bermittelt.</li>
          <li>Bitte gib <strong>keine sensiblen Daten</strong> ein!</li>
        </ul>
        <p style="margin-top: 1rem;">Chatverlauf wird <strong>nur lokal</strong> gespeichert.</p>
      </div>
      <div class="card-footer">
        <button class="btn" id="p-decline">Ablehnen</button>
        <button class="btn btn-primary" id="p-accept">Zustimmen</button>
      </div>
    </div>
  </div>

  <!-- Usage Modal -->
  <div id="m-usage" class="modal">
    <div class="card">
      <div class="card-header">Wichtige Hinweise</div>
      <div class="card-body">
        <p>â€¢ Antworten sind KI-generiert und prÃ¼fungsbedÃ¼rftig.<br>â€¢ Kein Ersatz fÃ¼r professionelle Beratung.<br>â€¢ Eigenverantwortung beachten.</p>
      </div>
      <div class="card-footer">
        <button class="btn btn-primary" id="u-accept">Verstanden</button>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="m-feedback" class="modal">
    <div class="card">
      <div class="card-header">Feedback senden</div>
      <div class="card-body">
        <p>Das Feedback Ã¶ffnet dein E-Mail-Programm. Der Chatverlauf wird angehÃ¤ngt.</p>
      </div>
      <div class="card-footer">
        <button class="btn" id="fb-cancel">Abbrechen</button>
        <button class="btn btn-primary" id="fb-continue">Weiter</button>
      </div>
    </div>
  </div>

  <!-- Mobile Sessions Menu -->
  <div id="mobile-sessions" class="mobile-menu">
    <div class="mobile-header">
      <span>VerlÃ¤ufe</span>
      <button class="icon-btn" onclick="hideMobile('mobile-sessions')">âœ•</button>
    </div>
    <div class="mobile-body" id="mob-sess-list"></div>
    <div class="mobile-footer">
      <div style="display:flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
        <button class="btn" id="mob-new">Neuer Chat</button>
        <button class="btn" id="mob-export">Export</button>
        <button class="btn btn-danger" id="mob-clear">LÃ¶schen</button>
      </div>
    </div>
  </div>

  <!-- Mobile Settings Menu -->
  <div id="mobile-settings" class="mobile-menu">
    <div class="mobile-header">
      <span>Einstellungen</span>
      <button class="icon-btn" onclick="hideMobile('mobile-settings')">âœ•</button>
    </div>
    <div class="mobile-body">
      <div class="setting-row">
        <label>Neuer Chat Button (Desktop)</label>
        <!-- Placeholder fÃ¼r Layout -->
      </div>
      <div class="setting-row">
        <label>Fachmodus</label>
        <select id="sel-domain-mobile" style="width: auto;">
          <option value="">Keiner</option>
          <option value="AEVO">AEVO</option>
          <option value="VWL">VWL</option>
          <option value="PERSONAL">Personal</option>
        </select>
      </div>
      
      <!-- SNIPPETS AREA -->
      <div class="setting-row" style="flex-direction: column; align-items: flex-start;">
        <label>Snippets</label>
        <div class="chip-container" id="snippet-list-mobile"></div>
        <div style="margin-top: 8px; display: flex; gap: 5px; width: 100%;">
          <input type="text" id="snippet-input-mobile" placeholder="Neues Snippet..." style="flex:1; padding: 8px; border: 1px solid var(--line); border-radius: 6px;">
          <button class="btn" id="add-snippet-mobile">+</button>
        </div>
        <small style="color: var(--muted); margin-top: 5px;">Tipps werden in Zwischenablage kopiert.</small>
      </div>
    </div>
    <div class="mobile-footer">
      <button class="btn btn-primary" id="s-save-mobile">Speichern & SchlieÃŸen</button>
    </div>
  </div>

  <!-- Header -->
  <div class="top-bar">
    <div class="brand">Linda</div>
    <div id="domain-badge" class="badge"></div>
    <div class="top-actions">
      <button class="icon-btn mobile-only" onclick="showMobile('mobile-sessions')" title="VerlÃ¤ufe">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      </button>
      <button class="icon-btn" onclick="showMobile('mobile-settings')" title="Einstellungen">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>
  </div>

  <div class="app-container">
    <!-- Desktop Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        VerlÃ¤ufe
        <button class="btn" id="btn-new-desktop" style="padding: 4px 10px; font-size: 0.8rem;">Neu</button>
      </div>
      <div id="desktop-sess-list" class="session-list"></div>
    </aside>

    <!-- Chat -->
    <main class="chat-area">
      <div id="log" class="chat-log"></div>
      <div class="composer">
        <textarea id="in" class="input-field" placeholder="Deine Frage..." rows="1"></textarea>
        <button id="send" class="send-btn">Senden</button>
      </div>
    </main>
  </div>

  <!-- SCRIPTS -->
  <script id="linda-context-addon">
    // (Unchanged Logic Wrapper)
    (function(){
        if (localStorage.getItem('linda.addon.disabled') === '1') { return; }
        const MAX_CONTEXT_CHARS = 2500;
        function getFachmodus() {
            const selM = document.getElementById('sel-domain-mobile');
            return (selM && selM.value) || '';
        }
        function buildCompressedContext() {
            let rawSessions = null, sessions = [], activeId = null, session = null;
            try { rawSessions = localStorage.getItem('linda.sessions'); sessions = rawSessions ? JSON.parse(rawSessions) : []; } catch {}
            try { activeId = localStorage.getItem('linda.activeId'); } catch {}
            if (activeId) session = sessions.find(s=>s.id===activeId);
            if (!session && sessions.length) session = sessions[0];
            if (!session || !Array.isArray(session.messages)) return '';
            let context = ''; let currentLen = 0;
            const msgs = session.messages;
            for (let i = msgs.length - 1; i >= 0; i--) {
                const m = msgs[i];
                const txt = (m.role==='user'?'User: ':'Linda: ') + (m.content||'') + "\n";
                if (currentLen + txt.length > MAX_CONTEXT_CHARS) break;
                context = txt + context; currentLen += txt.length;
            }
            return context;
        }
        const _origFetch = window.fetch.bind(window);
        window.fetch = async function(url, options = {}) {
            try {
                const method = ((options && options.method) || "GET").toUpperCase();
                if (method === "POST" && options.body && typeof options.body === "string" && options.body.trim().startsWith("{")) {
                    try {
                        const body = JSON.parse(options.body);
                        if (body && typeof body === "object" && (body.question || body.message) && !("context" in body)) {
                            const augmented = { ...body, context: buildCompressedContext(), fachmodus: getFachmodus() };
                            options.body = JSON.stringify(augmented);
                        }
                    } catch {}
                }
            } catch {}
            return _origFetch(url, options);
        };
    })();
  </script>

  <script>
    (function(){
      // --- Setup ---
      document.addEventListener('contextmenu', e => e.preventDefault());
      document.addEventListener('copy', e => e.preventDefault()); // Global block, enabled selectively
      const $ = id => document.getElementById(id);
      const LS = { get: (k,d) => { try { return JSON.parse(localStorage.getItem(k)) || d } catch { return d } }, set: (k,v) => localStorage.setItem(k, JSON.stringify(v)) };

      let settings = LS.get('linda.settings', { domain: '', snippets: [] });
      let sessions = LS.get('linda.sessions', []);
      let activeId = LS.get('linda.activeId', null);
      let abortCtrl = null;

      // --- Utils ---
      const uid = () => 's_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
      const show = el => el.classList.add('open');
      const hide = el => el.classList.remove('open');
      const showMobile = (id) => { 
        if(id === 'mobile-settings') renderSnippets(); 
        $(id).classList.add('open'); 
      };
      const hideMobile = (id) => $(id).classList.remove('open');

      function saveState() {
        LS.set('linda.settings', settings);
        LS.set('linda.sessions', sessions);
        LS.set('linda.activeId', activeId);
        updateUI();
      }

      function updateUI() {
        const b = $('domain-badge');
        if (settings.domain) {
          b.style.display = 'inline-block';
          b.textContent = `ðŸ“˜ ${settings.domain}`;
        } else {
          b.style.display = 'none';
        }
        const sel = $('sel-domain-mobile'); if(sel) sel.value = settings.domain || '';
      }

      // --- Rendering ---
      function renderList(targetId, isMobile) {
        const container = $(targetId);
        if (!container) return;
        
        const visible = sessions.slice(0, 5);
        container.innerHTML = visible.map(s => `
          <div class="session-item ${s.id === activeId ? 'active' : ''}" data-id="${s.id}">
            <div style="flex:1; min-width:0;">
              <div style="font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${s.name || 'Chat'}</div>
              <div class="session-meta">${new Date(s.ts).toLocaleDateString()}</div>
            </div>
            ${isMobile ? '' : `
              <div class="desktop-actions">
                <button class="desktop-btn" onclick="event.stopPropagation(); renameSession('${s.id}')">âœŽ</button>
                <button class="desktop-btn" onclick="event.stopPropagation(); exportSession('${s.id}')">â†“</button>
                <button class="desktop-btn" onclick="event.stopPropagation(); deleteSession('${s.id}')">Ã—</button>
              </div>
            `}
          </div>
        `).join('');

        container.querySelectorAll('.session-item').forEach(item => {
          item.onclick = () => {
            setActive(item.dataset.id);
            if (isMobile) hideMobile('mobile-sessions');
          };
        });
      }

      // --- Render Chat (Security & Formatting) ---
      function renderChat() {
        const log = $('log');
        const s = sessions.find(x => x.id === activeId);
        if (!s) return;
        
        log.innerHTML = '';
        s.messages.forEach(m => {
          const div = document.createElement('div');
          div.className = `bubble ${m.role}`;
          
          if (m.role === 'assistant') {
            // 1. Replace $...$ with **...** for Bold (Fix f)
            let content = m.content || '';
            content = content.replace(/\$(.*?)\$/g, '**$1**');

            // 2. Convert Markdown
            const rawHtml = marked.parse(content);

            // 3. Sanitize HTML (Fix j - XSS Protection)
            const safeHtml = DOMPurify.sanitize(rawHtml, {
              ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'pre', 'code', 'blockquote', 'table', 'thead', 'tbody', 'tr', 'th', 'td'],
              ALLOWED_ATTR: ['class']
            });

            div.innerHTML = `
              <div class="bubble-actions">
                <button class="action-btn" onclick="copyMsg(this)">ðŸ“‹</button>
                <button class="action-btn" onclick="shareMsg(this)">â†—</button>
                <button class="action-btn" onclick="pdfMsg(this)">ðŸ–¨</button>
                <button class="action-btn" onclick="show($('m-feedback'))">ðŸ‘Ž</button>
              </div>
              <div class="md">${safeHtml}</div>
            `;
            
            // Post-processing for Sources & Tables
            setTimeout(() => {
              const md = div.querySelector('.md');
              if (!md) return;

              // Sources (d)
              const heads = md.querySelectorAll('h1,h2,h3');
              heads.forEach(h => {
                if (/quellen|source/i.test(h.textContent)) {
                  const ul = h.nextElementSibling;
                  if (ul && ul.tagName === 'UL') {
                    const wrap = document.createElement('div');
                    wrap.className = 'sources';
                    wrap.innerHTML = `<div style="font-weight:700; font-size:0.85rem; margin-bottom:6px; color:var(--brand)">Quellen</div>`;
                    Array.from(ul.querySelectorAll('li')).forEach(li => {
                      const tag = document.createElement('span');
                      tag.className = 'source-tag';
                      tag.textContent = li.textContent.trim();
                      wrap.appendChild(tag);
                    });
                    ul.replaceWith(wrap);
                    h.remove();
                  }
                }
              });

              // Tables (e)
              const tables = md.querySelectorAll('table');
              tables.forEach(t => {
                const wrapper = document.createElement('div');
                wrapper.className = 'table-wrapper';
                t.parentNode.insertBefore(wrapper, t);
                wrapper.appendChild(t);
              });

            }, 0);
          } else {
            div.textContent = m.content; // User text is plain
          }
          log.appendChild(div);
        });
        
        log.scrollTop = log.scrollHeight;
      }

      // --- Snippet Logic (h) ---
      function renderSnippets() {
        const container = $('snippet-list-mobile');
        if(!container) return;
        
        if (!settings.snippets || settings.snippets.length === 0) {
          container.innerHTML = '<span style="color:var(--muted); font-size:0.9rem;">Keine Snippets.</span>';
          return;
        }

        container.innerHTML = settings.snippets.map((s, index) => `
          <div class="chip" onclick="useSnippet(${index})" title="Kopieren">
            ${s.substring(0, 15)}${s.length > 15 ? '...' : ''}
            <span class="chip-delete" onclick="event.stopPropagation(); deleteSnippet(${index})">Ã—</span>
          </div>
        `).join('');
      }

      window.useSnippet = (index) => {
        const txt = settings.snippets[index];
        navigator.clipboard.writeText(txt).then(() => {
          alert('Snippet in Zwischenablage kopiert!');
        });
      };

      window.deleteSnippet = (index) => {
        settings.snippets.splice(index, 1);
        saveState();
        renderSnippets();
      };

      $('add-snippet-mobile').onclick = () => {
        const input = $('snippet-input-mobile');
        const val = input.value.trim();
        if (val) {
          if(!settings.snippets) settings.snippets = [];
          settings.snippets.push(val);
          input.value = '';
          saveState();
          renderSnippets();
        }
      };

      // --- Session Actions ---
      window.setActive = (id) => {
        activeId = id;
        saveState();
        renderChat();
      };

      window.renameSession = (id) => {
        const s = sessions.find(x => x.id === id);
        if (s) {
          const nn = prompt('Neuer Name:', s.name);
          if (nn !== null) { s.name = nn.trim() || s.name; saveState(); renderList('desktop-sess-list', false); }
        }
      };

      window.deleteSession = (id) => {
        if (!confirm('LÃ¶schen?')) return;
        sessions = sessions.filter(x => x.id !== id);
        if (!sessions.length) sessions.push({ id: uid(), name: 'Neuer Chat', ts: Date.now(), messages: [] });
        if (activeId === id) activeId = sessions[0].id;
        saveState();
        renderList('desktop-sess-list', false);
        renderChat();
      };

      window.exportSession = (id) => {
        const s = sessions.find(x => x.id === id);
        if (!s) return;
        const text = s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + m.content).join('\n\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (s.name || 'chat') + '.txt';
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 100);
      };

      window.exportAll = () => {
        const text = sessions.map(s => `# ${s.name}\n${s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + m.content).join('\n\n')}`).join('\n\n---\n\n');
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'linda_all.txt';
        a.click();
      };

      window.clearAll = () => {
        if (!confirm('Alle lÃ¶schen?')) return;
        sessions = [{ id: uid(), name: 'Neuer Chat', ts: Date.now(), messages: [] }];
        activeId = sessions[0].id;
        saveState();
        renderList('desktop-sess-list', false);
        renderChat();
      };

      // --- Bubble Actions ---
      const getBubbleContent = (btn) => {
        const bubble = btn.closest('.bubble');
        const s = sessions.find(x => x.id === activeId);
        const userMsg = s.messages.find(m => m.role === 'user');
        // Extract text securely
        const answer = bubble.querySelector('.md')?.innerText || bubble.innerText;
        return { q: userMsg ? userMsg.content : '', a: answer };
      };

      window.copyMsg = (btn) => {
        const { q, a } = getBubbleContent(btn);
        // Enable copy for this specific action
        document.removeEventListener('copy', e => e.preventDefault());
        navigator.clipboard.writeText(`Frage: ${q}\n\nAntwort: ${a}`).then(() => {
          document.addEventListener('copy', e => e.preventDefault()); // Re-enable block
          const orig = btn.textContent; btn.textContent = 'âœ”';
          setTimeout(() => btn.textContent = orig, 1000);
        });
      };

      window.shareMsg = (btn) => {
        const { q, a } = getBubbleContent(btn);
        const txt = `Frage: ${q}\n\nAntwort: ${a}`;
        if (navigator.share) navigator.share({ title: 'Linda', text: txt }).catch(() => {});
        else window.location.href = `mailto:?subject=Linda&body=${encodeURIComponent(txt)}`;
      };

      // (j) PDF Export with Date/Time & Disclaimer on every page (i)
      window.pdfMsg = (btn) => {
        const { q, a } = getBubbleContent(btn);
        const now = new Date();
        const dateStr = now.toLocaleDateString('de-DE');
        const timeStr = now.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
        
        const win = window.open('', '_blank');
        if (!win) return;
        
        win.document.write(`
          <html>
          <head>
            <title>Ausdruck</title>
            <style>
              body { font-family: sans-serif; margin: 20px; line-height: 1.5; }
              h3 { color: #004481; }
              .footer { 
                position: fixed; bottom: 10px; left: 0; right: 0; 
                text-align: center; font-size: 10px; color: #666; border-top: 1px solid #eee; padding-top: 5px;
              }
              @media print { 
                body { margin: 10mm; } 
                .footer { position: fixed; bottom: 0; } 
                .no-print { display: none; }
              }
              pre { white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 10px; border-radius: 5px; }
            </style>
          </head>
          <body>
            <div class="no-print" style="text-align:right; margin-bottom:10px;">
              <button onclick="window.print()">Drucken</button>
              <button onclick="window.close()">SchlieÃŸen</button>
            </div>
            <h3>Frage:</h3>
            <p>${q}</p>
            <hr>
            <h3>Antwort:</h3>
            <pre>${a}</pre>
            
            <!-- Footer on every page -->
            <div class="footer">
              Ausgedruckt am ${dateStr} um ${timeStr} Uhr | Linda KI - Disclaimer: Inhalte prÃ¼fen.
            </div>
          </body>
          </html>
        `);
        win.document.close();
        // Don't auto-print to allow user to see layout first, but user can click Drucken
      };

      // --- Input & Send ---
      const input = $('in');
      const sendBtn = $('send');

      sendBtn.onclick = () => {
        if (abortCtrl) {
          abortCtrl.abort();
          abortCtrl = null;
          sendBtn.textContent = 'Senden';
          sendBtn.classList.remove('stop');
          return;
        }

        const q = input.value.trim();
        if (!q) return;
        
        input.value = '';
        input.style.height = 'auto';
        sendBtn.textContent = 'â–  Stopp';
        sendBtn.classList.add('stop');

        const s = sessions.find(x => x.id === activeId);
        s.messages.push({ role: 'user', content: q });
        s.ts = Date.now();
        s.messages.push({ role: 'assistant', content: 'â³ Einen Moment...' });
        
        saveState();
        renderChat();

        abortCtrl = new AbortController();

        const payload = {
          question: q,
          fachmodus: settings.domain || '',
          token: 'Linda-' + Date.now(),
          history: s.messages.slice(-3)
        };

        fetch('/api/bot', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: abortCtrl.signal
        })
        .then(r => r.text())
        .then(text => {
          s.messages[s.messages.length - 1] = { 
            role: 'assistant', 
            content: (text && text.trim().toLowerCase() !== 'accepted') ? text : 'Antwort erhalten.' 
          };
        })
        .catch(e => {
          if (e.name !== 'AbortError') {
            s.messages[s.messages.length - 1] = { role: 'assistant', content: 'Verbindungsfehler.' };
          }
        })
        .finally(() => {
          saveState();
          renderChat();
          sendBtn.textContent = 'Senden';
          sendBtn.classList.remove('stop');
          abortCtrl = null;
          input.focus();
        });
      };

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendBtn.click();
        }
      });

      input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });

      // --- Modals & Events ---
      $('p-accept').onclick = () => {
        hide($('m-privacy'));
        show($('m-usage'));
      };
      $('p-decline').onclick = () => location.reload();
      $('u-accept').onclick = () => hide($('m-usage'));
      
      $('fb-cancel').onclick = () => hide($('m-feedback'));
      $('fb-continue').onclick = () => {
        hide($('m-feedback'));
        const s = sessions.find(x => x.id === activeId);
        const txt = s ? s.messages.map(m => (m.role==='user'?'Du: ':'Linda: ')+m.content).join('\n\n') : '';
        window.location.href = `mailto:KI-TEST@GMX.COM?subject=Feedback&body=${encodeURIComponent(txt)}`;
      };

      // Desktop New Chat Button (g)
      $('btn-new-desktop').onclick = () => {
        const id = uid();
        sessions.unshift({ id, name: 'Neuer Chat', ts: Date.now(), messages: [] });
        activeId = id;
        saveState();
        renderList('desktop-sess-list', false);
        renderChat();
      };

      // Mobile Actions
      $('mob-new').onclick = () => {
        const id = uid();
        sessions.unshift({ id, name: 'Neuer Chat', ts: Date.now(), messages: [] });
        activeId = id;
        saveState();
        renderList('mob-sess-list', true);
        renderChat();
        hideMobile('mobile-sessions');
      };
      $('mob-export').onclick = exportAll;
      $('mob-clear').onclick = clearAll;

      $('s-save-mobile').onclick = () => {
        settings.domain = $('sel-domain-mobile').value;
        saveState();
        hideMobile('mobile-settings');
      };

      // --- Init ---
      if (sessions.length === 0) {
        sessions.push({ id: uid(), name: 'Neuer Chat', ts: Date.now(), messages: [] });
        activeId = sessions[0].id;
      }
      updateUI();
      renderList('desktop-sess-list', false);
      renderList('mob-sess-list', true);
      renderChat();

    })();
  </script>

</body>
</html>
