<!DOCTYPE html>
<html lang="de" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>VWL-Quiz ‚Äì Mobile</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { darkMode: 'class' } </script>

  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- Marked (optional f√ºr Bot-Feedback) -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --tap: 48px; --r: 16px; --brand: #0ea5e9; }
    html { -webkit-text-size-adjust: 100%; }
    body { font-size: 17px; line-height: 1.45; }
    .card { border-radius: var(--r); box-shadow: 0 6px 18px rgba(0,0,0,.05); }
    .btn { height: var(--tap); min-height: var(--tap); border-radius: 14px; }
    .btn-icon { width: 22px; height: 22px; }
    .q-badge { background: rgba(14,165,233,.14); color: #065985; border-radius: 999px; padding: 4px 10px; font-size: 12px; }
    .progress { height: 10px; border-radius: 999px; background: linear-gradient(90deg, var(--brand), #22c55e); width: 0%; transition: width .25s; }
    .tip { display:none; margin-top:.6rem; border-left:4px solid var(--brand); background:#f0f9ff; color:#073b4c; padding:.75rem .85rem; border-radius: 12px; }
    .tip p { margin:.15rem 0; }
    textarea { resize: none; font-size: 17px; line-height: 1.45; }
    .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom), 14px); }
    .sticky-actions { position: sticky; bottom: 0; z-index: 50; backdrop-filter: saturate(140%) blur(8px); }

    /* Dark mode tweaks */
    .dark body { background: #0b1220; color: #e6edf3; }
    .dark .card { background: #0f172a; border-color: #1e293b; box-shadow: none; }
    .dark .q-badge { background: rgba(56,189,248,.18); color: #7dd3fc; }
    .dark .tip { background: #032d3d; color: #c3e8ff; border-left-color: #38bdf8; }
    .dark .progress { background: linear-gradient(90deg, #38bdf8, #22c55e); }
  </style>
</head>
<body class="min-h-screen bg-white text-slate-900 dark:bg-[#0b1220] dark:text-[#e6edf3]">
  <!-- Hinweis / Disclaimer -->
  <div id="notice" class="sticky top-0 z-50 bg-amber-50 border-b border-amber-200 dark:bg-yellow-900/30 dark:border-yellow-800">
    <div class="mx-auto max-w-md px-4 py-3">
      <div class="flex items-start gap-3">
        <i data-lucide="alert-triangle" class="w-6 h-6 text-amber-600 dark:text-yellow-400"></i>
        <div class="flex-1">
          <p class="font-semibold text-amber-900 dark:text-yellow-200">Hinweis (Beta)</p>
          <p class="text-amber-900/90 dark:text-yellow-100/90">
            Die KI-Pr√ºfung wird getestet. Antworten m√ºssen fachlich gepr√ºft werden und ersetzen keine Rechtsberatung.
          </p>
          <label class="mt-3 flex items-center gap-3">
            <input id="ack" type="checkbox" class="w-5 h-5 accent-amber-600">
            <span class="text-[16px]">Ich habe den Hinweis gelesen.</span>
          </label>
        </div>
      </div>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <button id="ackBtn" class="btn w-full bg-amber-600 text-white active:bg-amber-700">Weiter</button>
        <!-- Dark mode toggle -->
        <button id="darkToggle" class="btn w-full border border-slate-300 bg-white text-slate-800 active:bg-slate-50 dark:bg-slate-800 dark:text-slate-100 dark:border-slate-700">
          üåô / ‚òÄÔ∏è Dark-Mode
        </button>
      </div>
    </div>
  </div>

  <!-- Header -->
  <header class="mx-auto max-w-md px-4 pt-4">
    <div class="flex items-center gap-3">
      <div class="w-11 h-11 rounded-2xl bg-sky-100 grid place-items-center dark:bg-sky-900/40">
        <i data-lucide="line-chart" class="w-6 h-6 text-sky-700 dark:text-sky-300"></i>
      </div>
      <div class="flex-1">
        <h1 class="text-xl font-semibold">VWL-Quiz ‚Äì Kompaktfragen</h1>
        <p class="text-[15px] text-slate-600 dark:text-slate-300/80">10 kurze Fragen ‚Ä¢ KI-Check pro Antwort oder gesamt</p>
      </div>
      <span id="ackState" class="text-[12px] rounded-full px-2.5 py-1 bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-100">Hinweis offen</span>
    </div>
  </header>

  <!-- Fortschritt -->
  <section class="mx-auto max-w-md px-4 mt-4">
    <div class="card bg-white border border-slate-100 p-4 dark:bg-[#0f172a] dark:border-slate-700">
      <div class="flex items-center gap-3">
        <i data-lucide="target" class="w-5 h-5 text-sky-700 dark:text-sky-300"></i>
        <div class="flex-1">
          <div class="flex justify-between text-[13px] text-slate-600 mb-1 dark:text-slate-300/80">
            <span id="progressText">0 / 10 beantwortet</span>
            <span id="timer">00:00</span>
          </div>
          <div class="w-full bg-slate-100 rounded-full overflow-hidden dark:bg-slate-800">
            <div id="progressBar" class="progress"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="mx-auto max-w-md px-4 py-4">
    <form id="form" class="grid gap-4" novalidate></form>

    <!-- KI-Gesamtfeedback -->
    <section id="resultWrap" class="mt-4 hidden" aria-live="polite">
      <div class="card bg-white border border-slate-100 p-4 dark:bg-[#0f172a] dark:border-slate-700">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkle" class="w-5 h-5 text-emerald-700 dark:text-emerald-300"></i>
          <h2 class="text-base font-semibold">KI-Feedback (Gesamt)</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-[16px] leading-relaxed dark:prose-invert"></article>
      </div>
    </section>
  </main>

  <!-- Sticky Action-Bar -->
  <div class="sticky-actions bg-white/95 border-t border-slate-200 safe-bottom dark:bg-[#0b1220]/95 dark:border-slate-700">
    <div class="mx-auto max-w-md px-4 py-2 grid grid-cols-2 gap-2">
      <button id="submitBtn" class="btn w-full bg-sky-600 text-white active:bg-sky-700 flex items-center justify-center gap-2 disabled:opacity-60">
        <i data-lucide="send" class="btn-icon"></i><span>Gesamt pr√ºfen</span>
      </button>
      <button id="resetBtn" class="btn w-full border border-slate-200 text-slate-800 bg-white active:bg-slate-50 dark:bg-slate-800 dark:text-slate-100 dark:border-slate-700">
        Zur√ºcksetzen
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" style="display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:12px 14px; border-radius:12px; font-size:15px; z-index:60;"></div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // === Konfiguration ===
    const relay = "https://hook.us2.make.com/hq1w4uay9lnxtbdpuw2luier6211ca77"; // Gemini-Webhook (Make)

    // UI Refs
    const form        = document.getElementById("form");
    const submitBtn   = document.getElementById("submitBtn");
    const resetBtn    = document.getElementById("resetBtn");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const resultWrap  = document.getElementById("resultWrap");
    const aiResult    = document.getElementById("aiResult");
    const timerEl     = document.getElementById("timer");
    const ack         = document.getElementById("ack");
    const ackBtn      = document.getElementById("ackBtn");
    const notice      = document.getElementById("notice");
    const ackState    = document.getElementById("ackState");
    const toastEl     = document.getElementById("toast");
    const darkToggle  = document.getElementById("darkToggle");

    // Markdown + Icons
    if (window.marked) marked.setOptions({ breaks: true, gfm: true });
    if (window.lucide) lucide.createIcons();

    // Haptik
    function buzz(pattern = 15){ try { if (navigator.vibrate) navigator.vibrate(pattern); } catch(e){} }

    // Dark mode init
    const rootEl = document.documentElement;
    (function initTheme(){
      const saved = localStorage.getItem("theme");
      if (saved === "dark") rootEl.classList.add("dark");
    })();
    darkToggle.addEventListener("click", ()=>{
      buzz(10);
      const isDark = rootEl.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    });

    // Timer
    let startTs = Date.now();
    setInterval(() => {
      const s = Math.floor((Date.now() - startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    }, 1000);

    // Fragen + Musterl√∂sungen
    const QUESTIONS = [
      {
        ref:"V1 ‚Äì VWL-Definition",
        q:"Erl√§utere kurz, was die Volkswirtschaftslehre untersucht.",
        tip:["Teil der Wirtschaftswissenschaften; analysiert gesamtwirtschaftliche Abl√§ufe/Ph√§nomene, die aus den Wahlhandlungen der Akteure entstehen; Modellblick auf die Volkswirtschaft."]
      },
      {
        ref:"V2 ‚Äì Wirtschaften & Knappheit",
        q:"Was bedeutet ‚ÄûWirtschaften‚Äú ‚Äì und warum ist Knappheit zentral?",
        tip:["Umgang mit knappen G√ºtern zur Bed√ºrfnisbefriedigung; Mittel sind begrenzt ‚Üí Alternativen abw√§gen, effiziente Verteilung."]
      },
      {
        ref:"V3 ‚Äì √ñkonomisches Prinzip",
        q:"Erkl√§re Maximal- und Minimalprinzip je an einem Beispiel.",
        tip:["Maximal: mit gegebenen Mitteln maximalen Nutzen (Budget X ‚Üí gr√∂√üter Output).","Minimal: Ziel mit minimalem Mitteleinsatz (Ziel Y ‚Üí geringste Kosten)."]
      },
      {
        ref:"V4 ‚Äì Maslow & Nachfrage",
        q:"Wozu dient die Maslow-Pyramide wirtschaftlich? Nenne zwei Ebenen + Praxisbezug.",
        tip:["Hierarchie von Bed√ºrfnissen (z. B. physiologische, Sicherheit, soziale ‚Ä¶).","Praxis: Nachfrage/Produktgestaltung/Motivation ausrichten (z. B. Sicherheitsfeatures vs. Wertsch√§tzung)."]
      },
      {
        ref:"V5 ‚Äì Produktionsfaktoren",
        q:"Nenne die drei elementaren Produktionsfaktoren und erl√§utere sie kurz.",
        tip:["Arbeit (menschliche Leistung), Boden (Ressourcen/Standort), Kapital (produzierte Produktionsmittel)."]
      },
      {
        ref:"V6 ‚Äì Makro: Modelle & Kennzahlen",
        q:"Wozu nutzt die VWL Modelle/Kennzahlen?",
        tip:["Vereinfachte Beschreibung/Analyse gesamtwirtschaftlicher Abl√§ufe; Verst√§ndnis von Zusammenh√§ngen; Planungs-/Entscheidungsunterst√ºtzung."]
      },
      {
        ref:"V7 ‚Äì Nutzen im Unternehmen",
        q:"Nenne drei betriebliche Bereiche, in denen VWL-Know-how hilft, + je ein Nutzen.",
        tip:["Produktentwicklung (Bed√ºrfnisfit), Preisbildung (Nachfrage/Markt), Standort/Absatzorte (Marktwirkung). Auch: Personalplanung, Expansion, Gesamtplanung."]
      },
      {
        ref:"V8 ‚Äì Marktarten",
        q:"Unterscheide Faktor- und G√ºterm√§rkte und nenne je zwei Beispiele.",
        tip:["Faktorm√§rkte: Arbeitsmarkt, Kapitalmarkt, Bodenmarkt.","G√ºterm√§rkte: Konsum-/Investitionsg√ºter, Dienstleistungen."]
      },
      {
        ref:"V9 ‚Äì K√§ufer- vs. Verk√§ufermarkt",
        q:"Erkl√§re K√§ufer- und Verk√§ufermarkt und gib je ein Beispiel.",
        tip:["K√§ufermarkt: Angebot > Nachfrage ‚Üí Kunden werden umworben (z. B. Alltagswaren).","Verk√§ufermarkt: Nachfrage > Angebot bzw. wenige Anbieter (z. B. knappe G√ºter)."]
      },
      {
        ref:"V10 ‚Äì Transfer in den Job",
        q:"W√§hle einen Arbeitsbereich und setze zwei VWL-Konzepte praktisch ein.",
        tip:["Beispiel: Preisbildung (K√§ufermarkt) + Personalplanung (Arbeitsmarkt/Lohnentwicklung) ‚Üí bessere Absatzchancen/Planung. Passe auf deinen Bereich an."]
      }
    ];

    // Hinweis best√§tigen
    let accepted = false;
    document.getElementById("ackBtn").addEventListener("click", ()=>{
      if (!document.getElementById("ack").checked) { showToast("Bitte den Hinweis best√§tigen."); buzz([8,40,8]); return; }
      accepted = true;
      document.getElementById("notice").style.display = "none";
      document.getElementById("ackState").textContent = "Hinweis best√§tigt";
      document.getElementById("ackState").className = "text-[12px] rounded-full px-2.5 py-1 bg-emerald-100 text-emerald-700";
      buzz(12);
    });

    // Autosize
    function autosize(el){ el.style.height = "auto"; el.style.height = (el.scrollHeight + 6) + "px"; }

    // Render (mobile-first)
    function renderQuestions() {
      form.innerHTML = "";
      QUESTIONS.forEach((item, idx) => {
        const id = `q_${idx}`;
        const feedbackId = `fb_${idx}`;
        const tipId = `tip_${idx}`;
        const card = document.createElement("section");
        card.className = "card bg-white border border-slate-100 p-4 dark:bg-[#0f172a] dark:border-slate-700";

        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <span class="q-badge">${item.ref}</span>
            <span class="text-slate-500 text-[12px] dark:text-slate-300/80">Frage ${idx+1}/10</span>
          </div>

          <h3 class="text-[17px] font-semibold mb-2">${item.q}</h3>

          <button type="button"
            class="btn w-full bg-sky-50 text-sky-900 border border-sky-100 active:bg-sky-100 dark:bg-sky-900/20 dark:text-sky-100 dark:border-sky-800"
            aria-expanded="false" aria-controls="${tipId}" data-tipbtn="${tipId}">
            <i data-lucide="info" class="btn-icon"></i>
            üõà Musterl√∂sung anzeigen
          </button>

          <div id="${tipId}" class="tip" role="note" aria-live="polite">
            ${item.tip.map(line => `<p>${line}</p>`).join("")}
          </div>

          <div class="mt-3 space-y-3">
            <textarea id="${id}" name="${id}" rows="4"
              class="w-full p-3 rounded-[14px] border border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-300 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-100"
              placeholder="Deine Antwort ‚Ä¶"></textarea>

            <div class="grid grid-cols-2 gap-2">
              <button type="button" data-fill="${id}"
                class="btn w-full border border-slate-200 bg-white text-slate-800 active:bg-slate-50 dark:bg-slate-800 dark:text-slate-100 dark:border-slate-700">
                Gliederung
              </button>
              <button type="button" data-ask="${idx}"
                class="btn w-full bg-sky-600 text-white active:bg-sky-700 flex items-center justify-center gap-2 disabled:opacity-60">
                <i data-lucide="sparkles" class="btn-icon"></i> KI-Check
              </button>
            </div>

            <div id="${feedbackId}" class="prose prose-slate text-[16px] leading-relaxed max-w-none hidden dark:prose-invert"></div>
          </div>
        `;
        form.appendChild(card);
      });

      // Accordion for tips
      form.querySelectorAll("[data-tipbtn]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          buzz(8);
          const tid = e.currentTarget.getAttribute("data-tipbtn");
          const box = document.getElementById(tid);
          const open = box.style.display === "block";
          box.style.display = open ? "none" : "block";
          e.currentTarget.setAttribute("aria-expanded", String(!open));
        });
      });

      // Gliederung + Autosize + Shortcut
      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          buzz(6);
          const tid = e.currentTarget.getAttribute("data-fill");
          const ta = document.getElementById(tid);
          if (!ta) return;
          ta.value = ["‚Ä¢ Kurzantwort","‚Ä¢ Begr√ºndung","‚Ä¢ Beispiel","(optional) Begriff/Modell: ‚Ä¶"].join("\n");
          autosize(ta); updateProgress();
        });
      });
      form.querySelectorAll("textarea").forEach(ta=>{
        autosize(ta);
        ta.addEventListener("input", ()=>{ autosize(ta); updateProgress(); });
        ta.addEventListener("keydown", (ev)=>{
          if ((ev.ctrlKey || ev.metaKey) && ev.key === "Enter") { ev.preventDefault(); submitBtn.click(); }
        });
      });

      // Per-Frage KI-Check
      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          buzz(8);
          if (!accepted) { showToast("Bitte zuerst den Hinweis best√§tigen."); buzz([10,40,10]); return; }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });

      if (window.lucide) lucide.createIcons();
    }

    // Fortschritt
    function updateProgress() {
      const tas = [...form.querySelectorAll("textarea")];
      const filled = tas.filter(t=>t.value.trim().length>0).length;
      const pct = Math.round((filled / 10) * 100);
      progressBar.style.width = pct + "%";
      progressTxt.textContent = `${filled} / 10 beantwortet`;
    }

    function collectAnswers() {
      return QUESTIONS.map((q, i) => {
        const v = (document.getElementById(`q_${i}`)?.value || "").trim();
        return { nr: i+1, ref: q.ref, question: q.q, answer: v };
      });
    }

    // ‚Äî‚Äî‚Äî Gemini-freundliche Prompts ‚Äî‚Äî‚Äî
    const sanitize = (s, cap=1100) => (s||"").trim().replace(/\s+/g," ").slice(0,cap);

    function buildPromptAll(answers) {
      const filled = answers.filter(a => (a.answer||"").trim().length>0);
      return [
        "Rolle: neutraler VWL-Dozent. Pr√ºfe die Antworten pr√§gnant.",
        "Format je Frage: Kurzfeedback (1‚Äì2 S√§tze) ‚Ä¢ Richtige L√∂sung (max. 4 Stichpunkte) ‚Ä¢ (optional) Praxisbezug.",
        "",
        "Fragen & Antworten:",
        ...filled.map(a => `Q${a.nr} (${a.ref})\nFrage: ${a.question}\nAntwort TN: ${sanitize(a.answer)}`)
      ].join("\n");
    }

    function buildPromptSingle(item, answer) {
      return [
        "Rolle: neutraler VWL-Dozent. Pr√ºfe diese EINE Antwort knapp.",
        "Format: Kurzfeedback (1‚Äì2 S√§tze) ‚Ä¢ Richtige L√∂sung (max. 4 Stichpunkte) ‚Ä¢ (optional) Praxisbezug.",
        "",
        `Frage: ${item.q}`,
        `Antwort TN: ${sanitize(answer)}`
      ].join("\n");
    }

    // ‚Äî‚Äî‚Äî HTTP Call (JSON f√ºr Gemini/Make) ‚Äî‚Äî‚Äî
    async function callAIText(promptText, kind="single", attempts=3){
      const payload = {
        prompt: promptText,                
        meta: { source: "vwl-quiz", kind } // optional f√ºr Logging/Router
      };

      for (let i=1; i<=attempts; i++){
        let res, text;
        try{
          res = await fetch(relay, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          text = await res.text();
        }catch(err){
          if (i < attempts) { await new Promise(r=>setTimeout(r, 1200*i)); continue; }
          throw new Error("Netzwerkfehler: " + (err?.message || err));
        }

        if (res.status === 429 && i < attempts) {
          showToast("Viele Anfragen ‚Äì neuer Versuch ‚Ä¶");
          const ra = Number(res.headers.get("retry-after")) || 5*i;
          await new Promise(r=>setTimeout(r, ra*1000));
          continue;
        }
        if (res.status === 400) {
          // Typischer JSON/Mapping-Fehler-Hinweis f√ºr Make/Gemini
          showToast("Hinweis: Webhook erwartet JSON-Feld ‚Äûtext‚Äú. Mapping in Make pr√ºfen.");
        }
        if (!res.ok) throw new Error(`Webhook-Fehler ${res.status}: ${text?.slice(0,200) || "keine Details"}`);

        try {
          const j = JSON.parse(text);
          return j.answer || j.content || j.result || j.output || j.text || text;
        } catch {
          return text; // Plaintext aus ‚ÄûWebhook response‚Äú
        }
      }
      throw new Error("429: wiederholt gebremst");
    }

    // Einzel-KI-Check
    async function askPerAnswer(idx, btnEl){
      const ta = document.getElementById(`q_${idx}`);
      const fb = document.getElementById(`fb_${idx}`);
      const item = QUESTIONS[idx];
      const prompt = buildPromptSingle(item, ta.value);

      const old = btnEl.innerHTML;
      btnEl.disabled = true;
      btnEl.innerHTML = `<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24"></svg>`;
      fb.classList.remove("hidden");
      fb.innerHTML = `<div class="text-slate-500 dark:text-slate-300/80">KI pr√ºft diese Antwort ‚Ä¶</div>`;

      try {
        const aiText = await callAIText(prompt, "single");
        fb.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
        buzz(15);
      } catch (e) {
        fb.innerHTML = `<div class="text-red-600 dark:text-red-400">Fehler: ${String(e)}</div>`;
        showToast("KI-Check fehlgeschlagen."); buzz([10,40,10]);
      } finally {
        btnEl.disabled = false;
        btnEl.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }
    }

    // Gesamt-Feedback
    submitBtn.addEventListener("click", async ()=>{
      buzz(8);
      if (!accepted) { showToast("Bitte zuerst den Hinweis best√§tigen."); buzz([10,40,10]); return; }
      const answers = collectAnswers();
      const prompt = buildPromptAll(answers);

      const old = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<svg class="animate-spin" width="22" height="22" viewBox="0 0 24 24"></svg>`;

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = `<div class="text-slate-500 dark:text-slate-300/80">Bitte warten ‚Ä¶ die KI erstellt Gesamt-Feedback.</div>`;

      try {
        const aiText = await callAIText(prompt, "batch");
        aiResult.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        buzz(15);
      } catch (e) {
        aiResult.innerHTML = `<div class="text-red-600 dark:text-red-400">Fehler beim Gesamt-Feedback: ${String(e)}</div>`;
        showToast("Gesamt-Feedback fehlgeschlagen."); buzz([10,40,10]);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }
    });

    // Reset
    resetBtn.addEventListener("click", ()=>{
      buzz(8);
      if (!confirm("Alle Eingaben wirklich l√∂schen?")) return;
      startTs = Date.now();
      renderQuestions(); updateProgress();
      resultWrap.classList.add("hidden");
      aiResult.innerHTML = "";
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Fortschritt init
    function initProgressListeners(){
      form.querySelectorAll("textarea").forEach(ta=> ta.addEventListener("input", updateProgress));
      updateProgress();
    }

    // Toast
    function showToast(msg){
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toastEl.style.display = "none", 2600);
    }

    // Init
    if (window.marked) marked.setOptions({ breaks: true, gfm: true });
    renderQuestions();
    initProgressListeners();
  });
  </script>
</body>
</html>
