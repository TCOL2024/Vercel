<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Linda – Mobile</title>

  <!-- PWA / iOS -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0b0b0f" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="Linda" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <!-- Icons + Markdown -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg: #0b0b0f;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --hairline: rgba(255,255,255,0.10);
      --accent: #0a84ff; /* iOS blue */
      --danger: #ff453a;
      --ok: #30d158;
      --radius: 16px;
      --shadow: 0 10px 30px rgba(0,0,0,0.30);
      --tap: 44px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body { height:100%; }
    body{
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 900px at 20% -10%, rgba(10,132,255,0.22), transparent 55%),
                  radial-gradient(900px 700px at 90% 0%, rgba(48,209,88,0.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      -webkit-text-size-adjust: 100%;
      overscroll-behavior-y: none;
    }

    a{ color: var(--accent); text-decoration: none; }
    a:active{ opacity: .8; }

    /* --- Modal base --- */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 4000;
      padding: 18px;
    }
    .modal{
      width: min(520px, 100%);
      background: rgba(20,20,28,0.92);
      border: 1px solid var(--hairline);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .modal header{
      padding: 16px 16px 10px 16px;
      display:flex; gap:10px; align-items:center;
      border-bottom: 1px solid var(--hairline);
    }
    .modal header .icon{
      width: 34px; height: 34px;
      display:grid; place-items:center;
      border-radius: 12px;
      background: rgba(10,132,255,0.18);
      border: 1px solid rgba(10,132,255,0.25);
      color: var(--accent);
      flex: 0 0 auto;
    }
    .modal header h2{
      font-size: 1.05rem;
      line-height: 1.2;
      letter-spacing: .2px;
    }
    .modal .content{
      padding: 14px 16px 16px 16px;
      font-size: .95rem;
      line-height: 1.5;
      color: var(--text);
      max-height: 62vh;
      overflow: auto;
    }
    .modal .content ul{ margin: 10px 0 0 18px; }
    .modal .content li{ margin: 8px 0; color: var(--muted); }
    .modal .actions{
      display:flex;
      gap: 10px;
      padding: 12px 16px 16px 16px;
      border-top: 1px solid var(--hairline);
      justify-content:flex-end;
    }
    .btn{
      height: 42px;
      padding: 0 14px;
      border-radius: 999px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-weight: 600;
      letter-spacing: .2px;
      cursor: pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      touch-action: manipulation;
    }
    .btn.primary{
      background: var(--accent);
      border-color: rgba(255,255,255,0.0);
      color: white;
    }
    .btn.danger{
      background: rgba(255,69,58,0.14);
      border-color: rgba(255,69,58,0.25);
      color: rgba(255,255,255,0.92);
    }
    .btn:active{ transform: translateY(1px); opacity: .92; }

    /* --- App layout (mobile only) --- */
    .app{
      height: 100%;
      display: none; /* shown after modals */
      flex-direction: column;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 2000;
      padding: calc(10px + env(safe-area-inset-top)) 14px 10px 14px;
      background: linear-gradient(to bottom, rgba(11,11,15,0.92), rgba(11,11,15,0.68));
      border-bottom: 1px solid var(--hairline);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .topbar .row{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .brand .mark{
      width: 34px; height: 34px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--hairline);
      display:grid; place-items:center;
      color: rgba(255,255,255,0.86);
      flex: 0 0 auto;
    }
    .brand .titles{
      min-width: 0;
      display:flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .brand .titles .name{
      font-weight: 700;
      letter-spacing: .2px;
      font-size: 1.02rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand .titles .sub{
      font-size: .84rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .iconbtn{
      width: var(--tap);
      height: var(--tap);
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.88);
      display:grid; place-items:center;
      cursor:pointer;
      touch-action: manipulation;
    }
    .iconbtn:active{ transform: translateY(1px); opacity:.92; }

    .chat{
      flex: 1;
      overflow: auto;
      padding: 12px 12px 0 12px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    /* bubbles */
    .msg{
      display:flex;
      gap: 10px;
      margin: 10px 0;
      align-items:flex-end;
    }
    .msg.bot{ justify-content: flex-start; }
    .msg.user{ justify-content: flex-end; }

    .bubble{
      max-width: 88%;
      border-radius: 18px;
      padding: 12px 12px;
      line-height: 1.45;
      font-size: 1.02rem;
      border: 1px solid var(--hairline);
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .bubble.bot{
      background: rgba(255,255,255,0.06);
    }
    .bubble.user{
      background: rgba(10,132,255,0.18);
      border-color: rgba(10,132,255,0.35);
    }

    .meta{
      font-size: .78rem;
      color: var(--muted);
      margin-top: 6px;
      padding: 0 4px;
    }
    .msg.user .meta{ text-align:right; }

    /* Markdown within bubble */
    .bubble :is(p, ul, ol, blockquote){ margin: 0 0 10px 0; }
    .bubble :is(ul, ol){ padding-left: 18px; }
    .bubble code{
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 2px 6px;
      font-size: .95em;
    }
    .bubble pre{
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 10px;
      overflow: auto;
    }
    .bubble pre code{ background: transparent; border: none; padding: 0; }

    /* composer */
    .composer{
      position: sticky; /* keeps behavior stable; JS adjusts with keyboard on iOS */
      bottom: 0;
      z-index: 2500;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom)) 12px;
      background: linear-gradient(to top, rgba(11,11,15,0.96), rgba(11,11,15,0.72));
      border-top: 1px solid var(--hairline);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .composer .bar{
      display:flex;
      gap: 10px;
      align-items:flex-end;
      padding: 10px 10px;
      border-radius: 18px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,0.06);
    }

    .field{
      flex:1;
      min-width: 0;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }

    textarea{
      width: 100%;
      resize: none;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      font-size: 1.05rem;
      line-height: 1.35;
      min-height: 24px;
      max-height: 140px;
      padding: 2px 2px;
      -webkit-text-size-adjust: 100%;
    }
    textarea::placeholder{ color: rgba(255,255,255,0.45); }

    .hintrow{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      font-size: .78rem;
      color: var(--muted);
      padding: 0 2px;
    }

    .send{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      border: 1px solid rgba(10,132,255,0.35);
      background: rgba(10,132,255,0.18);
      color: rgba(255,255,255,0.92);
      display:grid;
      place-items:center;
      cursor:pointer;
      touch-action: manipulation;
      flex: 0 0 auto;
    }
    .send:active{ transform: translateY(1px); opacity: .92; }
    .send[disabled]{ opacity: .45; pointer-events:none; }

    .mic{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86);
      display:grid;
      place-items:center;
      cursor:pointer;
      touch-action: manipulation;
      flex: 0 0 auto;
    }
    .mic.recording{
      border-color: rgba(48,209,88,0.45);
      background: rgba(48,209,88,0.16);
      color: var(--ok);
    }

    /* bottom sheet (sessions) */
    .sheetWrap{
      position: fixed;
      inset: 0;
      z-index: 3500;
      display:none;
      background: rgba(0,0,0,0.55);
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom)) 10px;
    }
    .sheet{
      position:absolute;
      left: 10px; right: 10px; bottom: 10px;
      border-radius: 22px;
      background: rgba(20,20,28,0.94);
      border: 1px solid var(--hairline);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:hidden;
      max-height: 72vh;
      display:flex;
      flex-direction: column;
    }
    .sheet header{
      padding: 12px 14px;
      display:flex; align-items:center; justify-content: space-between;
      border-bottom: 1px solid var(--hairline);
    }
    .sheet header .title{
      font-weight: 700; letter-spacing:.2px;
    }
    .sheet header .close{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.86);
      display:grid; place-items:center;
      cursor:pointer;
    }
    .sheetList{
      overflow:auto;
      padding: 6px 10px 10px 10px;
    }
    .session{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      margin: 8px 0;
      border-radius: 16px;
      border: 1px solid var(--hairline);
      background: rgba(255,255,255,0.06);
      cursor:pointer;
    }
    .session:active{ transform: translateY(1px); opacity: .92; }
    .session .name{
      min-width:0;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: rgba(255,255,255,0.90);
      font-weight: 600;
      letter-spacing: .2px;
    }
    .session .trash{
      width: 40px; height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,69,58,0.25);
      background: rgba(255,69,58,0.12);
      color: rgba(255,255,255,0.92);
      display:grid; place-items:center;
      cursor:pointer;
      flex: 0 0 auto;
    }

    /* safety: mobile-first; hide if desktop */
    @media (min-width: 900px){
      body::before{
        content:"Diese Version ist für Mobile optimiert. Öffne sie bitte auf dem Smartphone.";
        position: fixed; inset: 0;
        display:grid; place-items:center;
        padding: 24px;
        color: rgba(255,255,255,0.85);
        background: var(--bg);
        z-index: 99999;
        text-align:center;
        font-size: 1.05rem;
      }
      .app{ display:none !important; }
      .overlay{ display:none !important; }
    }
  </style>
</head>

<body>
  <!-- Privacy -->
  <div class="overlay" id="privacyModal" aria-modal="true" role="dialog">
    <div class="modal">
      <header>
        <div class="icon"><i class="fa-solid fa-lock"></i></div>
        <h2>Datenschutzhinweis</h2>
      </header>
      <div class="content">
        <p>Um Linda zu nutzen, brauchst du deine Zustimmung:</p>
        <ul>
          <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) übermittelt.</li>
          <li>Die Daten werden verarbeitet, um Antworten zu generieren.</li>
          <li><strong>Bitte keine sensiblen oder personenbezogenen Daten eingeben.</strong></li>
          <li>Infos: <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a> · <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make</a></li>
        </ul>
      </div>
      <div class="actions">
        <button class="btn" id="privacyDecline"><i class="fa-solid fa-xmark"></i> Ablehnen</button>
        <button class="btn primary" id="privacyAccept"><i class="fa-solid fa-check"></i> Zustimmen</button>
      </div>
    </div>
  </div>

  <!-- Usage -->
  <div class="overlay" id="usageModal" style="display:none" aria-modal="true" role="dialog">
    <div class="modal">
      <header>
        <div class="icon"><i class="fa-solid fa-bullhorn"></i></div>
        <h2>Wichtige Hinweise</h2>
      </header>
      <div class="content">
        <ul>
          <li><strong>Automatisierte Antworten:</strong> Antworten werden von KI generiert.</li>
          <li><strong>Keine Gewähr:</strong> Inhalte können unvollständig oder fehlerhaft sein.</li>
          <li><strong>Kein Ersatz für Beratung:</strong> Besonders nicht für Recht, Medizin, Steuern, Finanzen.</li>
          <li><strong>Eigenverantwortung:</strong> Bitte kritisch prüfen und ggf. weitere Quellen nutzen.</li>
        </ul>
      </div>
      <div class="actions">
        <button class="btn primary" id="usageAccept"><i class="fa-solid fa-check"></i> Einverstanden</button>
      </div>
    </div>
  </div>

  <!-- Bottom Sheet: Sessions -->
  <div class="sheetWrap" id="sheetWrap" aria-modal="true" role="dialog">
    <div class="sheet" role="document">
      <header>
        <div class="title">Chats</div>
        <button class="close" id="sheetClose" aria-label="Schließen"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <div class="sheetList" id="sessionList"></div>
    </div>
  </div>

  <!-- App -->
  <main class="app" id="app">
    <div class="topbar">
      <div class="row">
        <div class="brand">
          <div class="mark" aria-hidden="true"><i class="fa-solid fa-sparkles"></i></div>
          <div class="titles">
            <div class="name">Linda</div>
            <div class="sub">Personal · Ausbildung · Prüfung</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; align-items:center;">
          <button class="iconbtn" id="btnSessions" aria-label="Chats"><i class="fa-solid fa-list"></i></button>
          <button class="iconbtn" id="btnNew" aria-label="Neuer Chat"><i class="fa-solid fa-plus"></i></button>
          <button class="iconbtn" id="btnClear" aria-label="Chat löschen"><i class="fa-solid fa-trash"></i></button>
        </div>
      </div>
    </div>

    <section class="chat" id="chat" aria-live="polite"></section>

    <footer class="composer" id="composer">
      <div class="bar">
        <button class="mic" id="micBtn" aria-label="Spracheingabe"><i class="fa-solid fa-microphone"></i></button>

        <div class="field">
          <textarea id="q" rows="1" placeholder="Frag Linda … (Enter = senden)" autocomplete="off"></textarea>
          <div class="hintrow">
            <span id="netHint">—</span>
            <span id="lenHint"></span>
          </div>
        </div>

        <button class="send" id="sendBtn" aria-label="Senden"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
    </footer>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Elements
      const privacyModal = document.getElementById('privacyModal');
      const usageModal   = document.getElementById('usageModal');
      const app          = document.getElementById('app');

      const chatEl       = document.getElementById('chat');
      const qEl          = document.getElementById('q');
      const sendBtn      = document.getElementById('sendBtn');
      const micBtn       = document.getElementById('micBtn');

      const btnSessions  = document.getElementById('btnSessions');
      const btnNew       = document.getElementById('btnNew');
      const btnClear     = document.getElementById('btnClear');

      const sheetWrap    = document.getElementById('sheetWrap');
      const sheetClose   = document.getElementById('sheetClose');
      const sessionList  = document.getElementById('sessionList');

      const netHint      = document.getElementById('netHint');
      const lenHint      = document.getElementById('lenHint');

      const composerEl   = document.getElementById('composer');

      // --- Config
      const STORAGE_KEY = 'linda-mobile-sessions';
      const MAX_HISTORY_TO_SEND = 4;
      const initialMsg = {
        role: 'assistant',
        content:
          'Hallo! Ich bin **Linda**. Wie kann ich dich im Bereich **Personalmanagement**, **Ausbildung** oder **Prüfungsvorbereitung** unterstützen?\n\nTipp: Stell deine Frage möglichst **konkret** (Ziel, Kontext, Rahmenbedingungen).'
      };

      // --- State
      let sessions = [];
      let activeId = null;
      let messages = [];
      let isSending = false;

      // --- Helpers
      function saveSessions(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
      }
      function loadSessions(){
        sessions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      }
      function ensureGreeting(){
        if (!Array.isArray(messages)) messages = [];
        if (messages.length === 0 || messages[0].role !== 'assistant') messages.unshift({ ...initialMsg });
        if (!messages[0].content) messages[0] = { ...initialMsg };
      }
      function createSession(){
        const id = Date.now().toString();
        const s = { id, name: 'Chat', messages: [{...initialMsg}] };
        sessions.unshift(s);
        activeId = id;
        saveSessions();
        return s;
      }
      function loadSession(id){
        const s = sessions.find(x => x.id === id);
        if (!s) return;
        activeId = id;
        messages = (s.messages || []).slice();
        ensureGreeting();
        render();
        hideSheet();
        focusInput();
      }
      function updateSession(){
        const s = sessions.find(x => x.id === activeId);
        if (!s) return;
        ensureGreeting();
        s.messages = messages.slice();
        const firstUser = messages.find(m => m.role === 'user');
        s.name = firstUser ? firstUser.content.slice(0, 34) : 'Chat';
        saveSessions();
        renderSessionList();
      }
      function deleteSession(id){
        sessions = sessions.filter(x => x.id !== id);
        if (activeId === id){
          if (sessions.length) loadSession(sessions[0].id);
          else {
            const s = createSession();
            messages = s.messages.slice();
            ensureGreeting();
            render();
          }
        }
        saveSessions();
        renderSessionList();
      }

      function el(html){
        const t = document.createElement('template');
        t.innerHTML = html.trim();
        return t.content.firstChild;
      }

      function render(){
        ensureGreeting();
        chatEl.innerHTML = '';
        messages.forEach(m => {
          const isBot = m.role === 'assistant';
          const html = `
            <div class="msg ${isBot ? 'bot' : 'user'}">
              <div class="bubble ${isBot ? 'bot' : 'user'}">${marked.parse(m.content || '')}</div>
            </div>
          `;
          chatEl.appendChild(el(html));
        });
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function focusInput(){
        setTimeout(() => qEl.focus(), 80);
      }

      function setSending(on){
        isSending = on;
        sendBtn.disabled = on;
      }

      function lastMessagesForApi(all){
        // remove placeholders + limit
        const cleaned = all.filter(m => !(m.role === 'assistant' && (m.content || '').startsWith('⏳')));
        return cleaned.slice(-MAX_HISTORY_TO_SEND).map(m => ({ role: m.role, content: m.content }));
      }

      // --- UI: textarea autosize + hints
      function autosize(){
        qEl.style.height = 'auto';
        qEl.style.height = Math.min(qEl.scrollHeight, 140) + 'px';
        const len = (qEl.value || '').trim().length;
        lenHint.textContent = len ? `${len} Zeichen` : '';
      }

      // --- iOS Keyboard handling
      function adjustComposerForKeyboard(){
        if (!window.visualViewport) return;
        const vv = window.visualViewport;
        const keyboard = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
        composerEl.style.transform = keyboard ? `translateY(-${keyboard}px)` : 'translateY(0px)';
        // keep latest visible
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      if (window.visualViewport){
        window.visualViewport.addEventListener('resize', adjustComposerForKeyboard);
        window.visualViewport.addEventListener('scroll', adjustComposerForKeyboard);
      }
      window.addEventListener('resize', adjustComposerForKeyboard);

      // --- Bottom sheet
      function showSheet(){
        renderSessionList();
        sheetWrap.style.display = 'block';
      }
      function hideSheet(){
        sheetWrap.style.display = 'none';
      }
      function renderSessionList(){
        sessionList.innerHTML = '';
        sessions.forEach(s => {
          const row = el(`
            <div class="session" data-id="${s.id}">
              <div class="name">${escapeHtml(s.name || 'Chat')}</div>
              <button class="trash" aria-label="Chat löschen" data-id="${s.id}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          `);
          row.addEventListener('click', (e) => {
            const id = row.getAttribute('data-id');
            // if clicking trash, ignore here
            if (e.target.closest('button.trash')) return;
            loadSession(id);
          });
          row.querySelector('button.trash').addEventListener('click', (e) => {
            e.stopPropagation();
            const id = e.currentTarget.getAttribute('data-id');
            deleteSession(id);
          });
          sessionList.appendChild(row);
        });
      }

      // --- Safety: minimal HTML escape for session names
      function escapeHtml(str){
        return (str || '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      // --- Network hint
      function updateNetHint(){
        if (!navigator.onLine) netHint.textContent = 'Offline';
        else netHint.textContent = 'Online';
      }
      window.addEventListener('online', updateNetHint);
      window.addEventListener('offline', updateNetHint);

      // --- Speech recognition
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SR){
        const rec = new SR();
        rec.lang = 'de-DE';
        rec.interimResults = false;
        rec.maxAlternatives = 1;
        rec.onstart = () => micBtn.classList.add('recording');
        rec.onend   = () => micBtn.classList.remove('recording');
        rec.onresult = (e) => {
          qEl.value = e.results[0][0].transcript;
          autosize();
        };
        micBtn.addEventListener('click', () => rec.start());
      } else {
        micBtn.disabled = true;
        micBtn.style.opacity = '.45';
      }

      // --- Send logic
      async function send(){
        if (isSending) return;
        const text = (qEl.value || '').trim();
        if (!text) return;

        ensureGreeting();

        messages.push({ role: 'user', content: text });
        qEl.value = '';
        autosize();

        // placeholder
        messages.push({ role: 'assistant', content: '⏳ Einen Moment …' });
        render();
        updateSession();
        setSending(true);

        try{
          const payloadHistory = lastMessagesForApi(messages);

          const res = await fetch('/api/bot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: text, history: payloadHistory })
          });

          const replyText = await res.text();

          // replace last placeholder
          for (let i = messages.length - 1; i >= 0; i--){
            if (messages[i].role === 'assistant' && (messages[i].content || '').startsWith('⏳')){
              messages[i] = { role: 'assistant', content: replyText };
              break;
            }
          }
        } catch (e){
          // remove placeholder + show error
          messages = messages.filter(m => !(m.role === 'assistant' && (m.content || '').startsWith('⏳')));
          messages.push({ role: 'assistant', content: '❌ Fehler: Anfrage konnte nicht gesendet werden.' });
        } finally {
          setSending(false);
        }

        updateSession();
        render();
        focusInput();
      }

      // --- Events
      qEl.addEventListener('input', autosize);
      qEl.addEventListener('focus', () => setTimeout(adjustComposerForKeyboard, 60));
      qEl.addEventListener('blur', () => setTimeout(adjustComposerForKeyboard, 60));

      qEl.addEventListener('keydown', (e) => {
        // Enter sends, Shift+Enter newline
        if (e.key === 'Enter' && !e.shiftKey){
          e.preventDefault();
          send();
        }
      });

      sendBtn.addEventListener('click', send);

      btnSessions.addEventListener('click', showSheet);
      sheetClose.addEventListener('click', hideSheet);
      sheetWrap.addEventListener('click', (e) => { if (e.target === sheetWrap) hideSheet(); });

      btnNew.addEventListener('click', () => {
        const s = createSession();
        messages = s.messages.slice();
        ensureGreeting();
        render();
        focusInput();
      });

      btnClear.addEventListener('click', () => {
        if (!confirm('Diesen Chat wirklich löschen?')) return;
        messages = [{...initialMsg}];
        updateSession();
        render();
        focusInput();
      });

      // --- Modal flow
      document.getElementById('privacyAccept').addEventListener('click', () => {
        privacyModal.style.display = 'none';
        usageModal.style.display = 'flex';
      });
      document.getElementById('privacyDecline').addEventListener('click', () => location.reload());
      document.getElementById('usageAccept').addEventListener('click', () => {
        usageModal.style.display = 'none';
        app.style.display = 'flex';
        init();
      });

      // --- Init
      function init(){
        loadSessions();
        if (sessions.length === 0){
          const s = createSession();
          messages = s.messages.slice();
        } else {
          loadSession(sessions[0].id);
          return;
        }
        ensureGreeting();
        render();
        autosize();
        updateNetHint();
        focusInput();
        setTimeout(adjustComposerForKeyboard, 120);
      }

      // Start: show privacy
      privacyModal.style.display = 'flex';
      autosize();
      updateNetHint();
    });
  </script>
</body>
</html>
