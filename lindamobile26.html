<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<title>Linda – Beta Mobile</title>

<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#ffffff"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Linda"/>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{
    --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

    /* McK-inspired clean */
    --bg:#ffffff;
    --soft:#fbfbfd;
    --panel:#ffffff;
    --line:#e9ecef;
    --text:#0b0b0f;
    --muted:#6b7280;

    --blue:#2563eb;        /* calm blue */
    --blue2:#1d4ed8;

    --bubbleBot:#f2f3f7;
    --bubbleMe:#2563eb;

    --shadow: 0 18px 46px rgba(17,24,39,.10);
    --radius: 18px;

    --topH: 74px;          /* stable header height */
    --base: 18px;
    --chat: 17px;
    --lh: 1.6;

    --tap: 44px;
    --maxW: 820px;         /* like McK, but still phone-perfect */
  }

  *{ box-sizing:border-box; margin:0; padding:0; }
  html, body{
    height:100%;
    height:100dvh;
    overflow:hidden;                 /* KEY: page does not scroll */
    background: var(--bg);
    font-family: var(--font);
    font-size: var(--base);
    color: var(--text);
    -webkit-text-size-adjust:100%;
  }

  a{ color: var(--blue2); text-decoration:none; }
  a:active{ opacity:.85; }

  /* App */
  .app{
    height:100%;
    display:flex;
    flex-direction:column;
    background: var(--bg);
  }

  /* Header (McK-like spacing + type) */
  .top{
    position: sticky;
    top: 0;
    z-index: 30;
    background: var(--bg);
    border-bottom: 1px solid var(--line);
    height: var(--topH);
    padding: 14px 16px 12px;
    padding-top: calc(14px + env(safe-area-inset-top));
  }

  .topInner{
    max-width: var(--maxW);
    margin: 0 auto;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 14px;
  }

  .brand{
    display:flex;
    flex-direction:column;
    gap: 10px;
    min-width:0;
  }

  .beta{
    display:inline-flex;
    align-items:center;
    gap: 8px;
    letter-spacing: .26em;
    text-transform: uppercase;
    font-weight: 800;
    font-size: 12px;
    color: rgba(11,11,15,.55);
  }

  .headline{
    display:flex;
    align-items:flex-end;
    gap: 10px;
    min-width:0;
  }

  .h1{
    font-weight: 900;
    font-size: 38px;
    letter-spacing: -0.6px;
    line-height: 0.95;
    color: var(--blue);
  }

  .spark{
    width: 18px; height: 18px;
    display:inline-block;
    transform: translateY(-6px);
  }

  .sub{
    margin-top: 6px;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.3;
    max-width: 40ch;
  }

  .topActions{
    display:flex;
    align-items:center;
    gap: 10px;
    padding-top: 6px;
    flex:0 0 auto;
  }

  .linkBtn{
    appearance:none;
    border: none;
    background: transparent;
    color: var(--text);
    font-weight: 700;
    font-size: 16px;
    cursor:pointer;
    padding: 8px 10px;
    border-radius: 12px;
    -webkit-tap-highlight-color:transparent;
    user-select:none;
  }
  .linkBtn:active{ background: rgba(37,99,235,.08); }

  .plus{
    width: var(--tap);
    height: var(--tap);
    border-radius: 14px;
    border: 1px solid var(--line);
    background: var(--panel);
    cursor:pointer;
    display:grid;
    place-items:center;
    box-shadow: 0 8px 22px rgba(17,24,39,.06);
    -webkit-tap-highlight-color:transparent;
    user-select:none;
  }
  .plus:active{ transform: translateY(1px); opacity:.92; }
  .plus span{
    color: var(--blue);
    font-weight: 900;
    font-size: 20px;
    line-height: 1;
  }

  /* Content area fills the screen */
  .content{
    height: calc(100dvh - var(--topH));
    display:flex;
    flex-direction:column;
    padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
    background: var(--bg);
  }

  /* Card: fills, stable, clean */
  .card{
    flex:1;
    min-height:0;
    max-width: var(--maxW);
    width:100%;
    margin: 0 auto;
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  /* Log: only scroll area */
  .log{
    flex:1;
    min-height:0;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    padding: 16px 14px 10px;
    display:flex;
    flex-direction:column;
    gap: 12px;
    background: var(--panel);
  }

  .msg{
    display:flex;
    gap: 10px;
    align-items:flex-end;
  }
  .msg.user{ justify-content:flex-end; }
  .msg.bot{ justify-content:flex-start; }

  .avatarMini{
    width: 28px;
    height: 28px;
    border-radius: 999px;
    background: #0b0b0f;
    color:#fff;
    display:grid;
    place-items:center;
    font-weight: 900;
    font-size: 12px;
    flex:0 0 auto;
  }

  .bubble{
    max-width: 86%;
    border-radius: var(--radius);
    padding: 12px 14px;
    font-size: var(--chat);
    line-height: var(--lh);
    overflow-wrap:anywhere;
    word-break: break-word;
  }
  .bubble.bot{
    background: var(--bubbleBot);
    color: var(--text);
    border-top-left-radius: 10px;
  }
  .bubble.user{
    background: var(--bubbleMe);
    color:#fff;
    border-top-right-radius: 10px;
  }

  /* Markdown in bubbles */
  .bubble p{ margin: 0 0 .7em; }
  .bubble p:last-child{ margin-bottom:0; }
  .bubble ul, .bubble ol{ padding-left: 1.2em; margin:.5em 0; }
  .bubble a{ color: inherit; text-decoration: underline; }
  .bubble code{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size: .95em;
    background: rgba(0,0,0,.10);
    padding: .15em .35em;
    border-radius: 8px;
  }
  .bubble.user code{ background: rgba(255,255,255,.22); }
  .bubble pre{
    background: rgba(0,0,0,.08);
    border-radius: 12px;
    padding: 10px;
    overflow:auto;
  }
  .bubble.user pre{ background: rgba(255,255,255,.18); }

  /* Composer: inside card => always stable */
  .composer{
    border-top: 1px solid var(--line);
    background: var(--soft);
    padding: 10px;
  }
  .composerRow{
    display:flex;
    gap: 10px;
    align-items:flex-end;
    background:#fff;
    border: 1px solid var(--line);
    border-radius: 18px;
    padding: 10px 10px;
  }
  textarea{
    flex:1;
    min-width:0;
    border:none;
    outline:none;
    resize:none;
    background: transparent;
    font-size: 18px;
    line-height: 1.25;
    max-height: 160px;
    padding: 8px 6px;
    color: var(--text);
  }
  textarea::placeholder{ color: rgba(17,24,39,.35); }

  .send{
    width: 48px;
    height: 48px;
    border-radius: 16px;
    border:none;
    background: var(--blue);
    color:#fff;
    font-weight: 900;
    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color:transparent;
    flex:0 0 auto;
    display:grid;
    place-items:center;
  }
  .send:active{ transform: translateY(1px); opacity:.92; }
  .send:disabled{ opacity:.45; pointer-events:none; }

  /* Modals – crisp, no blur */
  .modal{
    position: fixed;
    inset: 0;
    display:none;
    align-items:flex-end;
    justify-content:center;
    background: rgba(0,0,0,.35);
    z-index: 1000;
    padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
  }
  .sheet{
    width: min(var(--maxW), 100%);
    background:#fff;
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 22px;
    overflow:hidden;
    box-shadow: var(--shadow);
  }
  .sheetH{
    padding: 14px 16px 10px;
    border-bottom: 1px solid rgba(0,0,0,.08);
    font-weight: 900;
    font-size: 16px;
  }
  .sheetB{
    padding: 12px 16px 16px;
    font-size: 15px;
    color:#374151;
    line-height: 1.55;
    max-height: 62vh;
    overflow:auto;
  }
  .sheetB ul{ margin:10px 0 0 18px; }
  .sheetB li{ margin: 8px 0; }
  .sheetF{
    padding: 12px 16px 16px;
    border-top: 1px solid rgba(0,0,0,.08);
    display:flex;
    gap: 10px;
  }
  .btn{
    flex:1;
    height: 46px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.10);
    background: #f3f4f6;
    color: #111827;
    font-weight: 900;
    cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }
  .btn.primary{
    background: var(--blue);
    border-color: var(--blue);
    color:#fff;
  }
  .btn:active{ transform: translateY(1px); opacity:.92; }

  /* Mobile typography tuning */
  @media (max-width: 430px){
    .h1{ font-size: 34px; }
  }
</style>
</head>

<body>

<!-- Privacy -->
<div class="modal" id="m-privacy" style="display:flex;">
  <div class="sheet">
    <div class="sheetH">Datenschutzhinweis</div>
    <div class="sheetB">
      <p>Um Linda zu nutzen, ist deine Zustimmung erforderlich:</p>
      <ul>
        <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) übermittelt.</li>
        <li>Die Daten werden zur Generierung von Antworten verarbeitet.</li>
        <li><strong>Bitte keine sensiblen oder personenbezogenen Daten</strong> eingeben.</li>
        <li>Infos: <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a> ·
            <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make</a></li>
      </ul>
    </div>
    <div class="sheetF">
      <button class="btn" id="p-decline">Ablehnen</button>
      <button class="btn primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<!-- Usage -->
<div class="modal" id="m-usage">
  <div class="sheet">
    <div class="sheetH">Wichtige Hinweise</div>
    <div class="sheetB">
      <ul>
        <li><strong>Automatisierte Antworten</strong>: Inhalte werden von KI generiert.</li>
        <li><strong>Keine Gewähr</strong>: bitte kritisch prüfen.</li>
        <li><strong>Kein Ersatz</strong> für Rechts-, Steuer-, Finanz- oder medizinische Beratung.</li>
      </ul>
    </div>
    <div class="sheetF">
      <button class="btn primary" id="u-accept">Einverstanden</button>
    </div>
  </div>
</div>

<div class="app">
  <header class="top">
    <div class="topInner">
      <div class="brand">
        <div class="beta">BETA</div>
        <div class="headline">
          <div class="h1">Linda</div>
          <!-- tiny spark -->
          <svg class="spark" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l1.6 6.1L20 10l-6.4 1.9L12 18l-1.6-6.1L4 10l6.4-1.9L12 2Z" fill="rgba(37,99,235,.85)"/>
          </svg>
        </div>
        <div class="sub">Dein Assistenz-Chat für Ausbildung, Prüfung und Personal.</div>
      </div>

      <div class="topActions">
        <button class="linkBtn" id="btnNewText">New Chat</button>
        <button class="plus" id="btnNew" aria-label="New Chat"><span>+</span></button>
      </div>
    </div>
  </header>

  <main class="content">
    <section class="card" aria-label="Chat">
      <div class="log" id="log" aria-live="polite"></div>

      <div class="composer">
        <div class="composerRow">
          <textarea id="in" rows="1" placeholder="Schreibe an Linda …"></textarea>
          <button id="send" class="send" aria-label="Senden">➤</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const MAX_HISTORY_TO_SEND = 4;
  const STORAGE_KEY = 'linda.beta.mobile.v1';

  let messages = [];
  let isSending = false;

  // safer markdown: strip raw HTML
  if (window.marked){
    const r = new marked.Renderer();
    r.html = () => '';
    marked.setOptions({ renderer:r, mangle:false, headerIds:false });
  }

  const initialMsg = {
    role:'assistant',
    content:'Hallo Jens! Ich bin **Linda (BETA)**. Wobei kann ich dir helfen – AEVO, Personal, Recht oder Prüfungsvorbereitung?'
  };

  function load(){
    try{ messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch{ messages = []; }
    if (!messages.length) messages = [{...initialMsg}];
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); }

  function autosize(){
    const el = $('in');
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
  }

  function render(){
    const log = $('log');
    log.innerHTML = '';

    messages.forEach(m=>{
      const row = document.createElement('div');
      row.className = 'msg ' + (m.role==='user' ? 'user' : 'bot');

      if (m.role !== 'user'){
        const av = document.createElement('div');
        av.className = 'avatarMini';
        av.textContent = 'L';
        row.appendChild(av);
      }

      const b = document.createElement('div');
      b.className = 'bubble ' + (m.role==='user' ? 'user' : 'bot');
      b.innerHTML = window.marked ? marked.parse(m.content || '') : (m.content || '');
      row.appendChild(b);

      log.appendChild(row);
    });

    log.scrollTop = log.scrollHeight;
  }

  function lastMessagesForApi(all){
    const cleaned = all.filter(m => !(m.role==='assistant' && (m.content||'').startsWith('⏳')));
    return cleaned.slice(-MAX_HISTORY_TO_SEND).map(m => ({ role:m.role, content:m.content }));
  }

  function setSending(on){
    isSending = on;
    $('send').disabled = on;
  }

  async function send(){
    if (isSending) return;
    const q = ($('in').value || '').trim();
    if (!q) return;

    messages.push({ role:'user', content:q });
    $('in').value = '';
    autosize();

    messages.push({ role:'assistant', content:'⏳ Einen Moment …' });
    render();
    save();
    setSending(true);

    try{
      const payloadHistory = lastMessagesForApi(messages);

      const res = await fetch('/api/bot', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ question:q, history: payloadHistory })
      });

      const reply = await res.text();

      for (let i = messages.length - 1; i >= 0; i--){
        if (messages[i].role==='assistant' && (messages[i].content||'').startsWith('⏳')){
          messages[i] = { role:'assistant', content: reply };
          break;
        }
      }
    } catch {
      messages = messages.filter(m => !(m.role==='assistant' && (m.content||'').startsWith('⏳')));
      messages.push({ role:'assistant', content:'❌ Fehler beim Senden. Bitte prüfe /api/bot.' });
    } finally {
      setSending(false);
      save();
      render();
      setTimeout(()=> $('in').focus(), 50);
    }
  }

  function newChat(){
    messages = [{...initialMsg}];
    save();
    render();
    setTimeout(()=> $('in').focus(), 50);
  }

  // Modals
  $('p-accept').onclick = ()=>{ $('m-privacy').style.display='none'; $('m-usage').style.display='flex'; };
  $('p-decline').onclick = ()=> location.reload();
  $('u-accept').onclick = ()=>{
    $('m-usage').style.display='none';
    load(); render(); autosize();
    setTimeout(()=> $('in').focus(), 80);
  };

  $('btnNew').onclick = newChat;
  $('btnNewText').onclick = newChat;

  $('send').onclick = send;
  $('in').addEventListener('input', autosize);
  $('in').addEventListener('keydown', (e)=>{
    if (e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // Start
  $('m-privacy').style.display='flex';
})();
</script>
</body>
</html>
