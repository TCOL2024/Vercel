<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<title>Linda – Mobile (Clean)</title>

<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#ffffff"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<meta name="apple-mobile-web-app-title" content="Linda"/>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
  :root{
    --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display", system-ui, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

    --bg:#ffffff;
    --panel:#f7f7fb;
    --line:#e9ecef;
    --text:#111827;
    --muted:#6b7280;

    --brand:#2563eb;          /* clean blue */
    --brand2:#1d4ed8;

    --bubbleBot:#f2f3f7;
    --bubbleMe:#2563eb;

    --shadow: 0 10px 26px rgba(17,24,39,.10);
    --radius: 16px;

    --topH: 62px;
    --base: 18px;
    --chat: 17px;
    --lh: 1.55;
  }

  *{ box-sizing:border-box; margin:0; padding:0; }
  html, body{
    height: 100%;
    height: 100dvh;
    overflow: hidden;                 /* WICHTIG: Seite scrollt nicht */
    background: var(--bg);
    font-family: var(--font);
    font-size: var(--base);
    color: var(--text);
  }

  a{ color: var(--brand2); text-decoration:none; }
  a:active{ opacity:.85; }

  /* App frame */
  .top{
    position: sticky;
    top: 0;
    z-index: 30;
    height: var(--topH);
    background: var(--bg);            /* CRISP, kein Blur */
    border-bottom: 1px solid var(--line);
    display:flex;
    align-items:center;
    padding: 12px 14px;
    padding-top: calc(12px + env(safe-area-inset-top));
    gap: 12px;
  }

  .mark{
    width: 36px; height: 36px;
    border-radius: 999px;
    background: var(--brand);
    color:#fff;
    display:grid;
    place-items:center;
    font-weight: 900;
    letter-spacing: .4px;
    flex: 0 0 auto;
  }

  .titlewrap{ min-width:0; flex: 1; }
  .title{
    font-weight: 900;
    font-size: 20px;
    letter-spacing: -0.2px;
    line-height: 1.05;
  }
  .subtitle{
    margin-top: 2px;
    font-size: 13px;
    color: var(--muted);
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }

  .topbtn{
    appearance:none;
    border: 1px solid var(--line);
    background: var(--panel);
    color: var(--text);
    height: 38px;
    padding: 0 12px;
    border-radius: 999px;
    font-weight: 700;
    cursor:pointer;
  }
  .topbtn:active{ transform: translateY(1px); opacity:.92; }

  /* Content area: fills remaining space under top */
  .content{
    height: calc(100dvh - var(--topH));
    display:flex;
    flex-direction:column;
    padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
    gap: 12px;
  }

  /* Card that fills screen nicely (like McK) */
  .card{
    flex: 1;
    min-height: 0;
    background: var(--bg);
    border: 1px solid var(--line);
    border-radius: 22px;
    box-shadow: var(--shadow);
    overflow: hidden;
    display:flex;
    flex-direction:column;
  }

  /* Scroll log */
  .log{
    flex:1;
    min-height:0;
    overflow:auto;                    /* NUR HIER scrollen */
    -webkit-overflow-scrolling: touch;
    padding: 14px 12px 10px;
    display:flex;
    flex-direction:column;
    gap: 12px;
  }

  .bubble{
    max-width: 92%;
    border-radius: var(--radius);
    padding: 12px 14px;
    font-size: var(--chat);
    line-height: var(--lh);
    word-wrap: break-word;
    overflow-wrap:anywhere;
    box-shadow: 0 1px 0 rgba(0,0,0,.06);
  }
  .bot{
    align-self:flex-start;
    background: var(--bubbleBot);
    color: var(--text);
    border-top-left-radius: 10px;
  }
  .me{
    align-self:flex-end;
    background: var(--bubbleMe);
    color:#fff;
    border-top-right-radius: 10px;
  }

  /* Markdown inside bubbles */
  .bubble p{ margin: 0 0 .7em; }
  .bubble p:last-child{ margin-bottom:0; }
  .bubble ul, .bubble ol{ padding-left: 1.2em; margin:.5em 0; }
  .bubble pre{
    background: rgba(0,0,0,.08);
    border-radius: 12px;
    padding: 10px;
    overflow:auto;
  }
  .me pre{ background: rgba(255,255,255,.18); }
  .bubble code{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    font-size: .95em;
    background: rgba(0,0,0,.10);
    padding: .15em .35em;
    border-radius: 8px;
  }
  .me code{ background: rgba(255,255,255,.22); }

  /* Composer is inside the card, so it never "floats weird" */
  .composer{
    border-top: 1px solid var(--line);
    background: var(--panel);
    padding: 10px;
  }
  .composerRow{
    display:flex;
    gap: 10px;
    align-items:flex-end;
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 18px;
    padding: 10px 10px;
  }

  textarea{
    flex:1;
    min-width:0;
    border:none;
    outline:none;
    resize:none;
    background: transparent;
    font-size: 18px;
    line-height: 1.25;
    max-height: 160px;
    padding: 8px 6px;
    color: var(--text);
  }
  textarea::placeholder{ color: rgba(17,24,39,.35); }

  .send{
    width: 48px;
    height: 48px;
    border-radius: 16px;
    border:none;
    background: var(--brand);
    color:#fff;
    font-weight: 900;
    cursor:pointer;
    user-select:none;
  }
  .send:active{ transform: translateY(1px); opacity:.92; }
  .send:disabled{ opacity:.45; pointer-events:none; }

  /* Modal (keine Blur-Orgie) */
  .modal{
    position: fixed;
    inset: 0;
    display:none;
    align-items:flex-end;
    justify-content:center;
    background: rgba(0,0,0,.35);
    z-index: 1000;
    padding: 14px 14px calc(14px + env(safe-area-inset-bottom));
  }
  .sheet{
    width: min(720px, 100%);
    background: #fff;
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 22px;
    overflow:hidden;
    box-shadow: var(--shadow);
  }
  .sheetH{
    padding: 14px 16px 10px;
    border-bottom: 1px solid rgba(0,0,0,.08);
    font-weight: 900;
    font-size: 16px;
  }
  .sheetB{
    padding: 12px 16px 16px;
    font-size: 15px;
    color:#374151;
    line-height: 1.55;
    max-height: 62vh;
    overflow:auto;
  }
  .sheetB ul{ margin: 10px 0 0 18px; }
  .sheetB li{ margin: 8px 0; }
  .sheetF{
    padding: 12px 16px 16px;
    border-top: 1px solid rgba(0,0,0,.08);
    display:flex;
    gap: 10px;
  }
  .btn{
    flex:1;
    height: 46px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,.10);
    background: #f3f4f6;
    color: #111827;
    font-weight: 800;
    cursor:pointer;
  }
  .btn.primary{
    background: var(--brand);
    border-color: var(--brand);
    color:#fff;
  }
  .btn:active{ transform: translateY(1px); opacity:.92; }

</style>
</head>

<body>

  <!-- Privacy Modal -->
  <div class="modal" id="m-privacy" style="display:flex;">
    <div class="sheet">
      <div class="sheetH">Datenschutzhinweis</div>
      <div class="sheetB">
        <p>Um Linda zu nutzen, ist deine Zustimmung erforderlich:</p>
        <ul>
          <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) übermittelt.</li>
          <li>Die Daten werden zur Generierung von Antworten verarbeitet.</li>
          <li><strong>Bitte keine sensiblen oder personenbezogenen Daten</strong> eingeben.</li>
          <li>Infos: <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a> ·
              <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make</a></li>
        </ul>
      </div>
      <div class="sheetF">
        <button class="btn" id="p-decline">Ablehnen</button>
        <button class="btn primary" id="p-accept">Zustimmen</button>
      </div>
    </div>
  </div>

  <!-- Usage Modal -->
  <div class="modal" id="m-usage">
    <div class="sheet">
      <div class="sheetH">Wichtige Hinweise</div>
      <div class="sheetB">
        <ul>
          <li><strong>Automatisierte Antworten:</strong> Inhalte werden von KI generiert.</li>
          <li><strong>Keine Gewähr:</strong> Bitte kritisch prüfen.</li>
          <li><strong>Kein Ersatz</strong> für Rechts-, Steuer-, Finanz- oder medizinische Beratung.</li>
        </ul>
      </div>
      <div class="sheetF">
        <button class="btn primary" id="u-accept">Einverstanden</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div class="top">
    <div class="mark">L</div>
    <div class="titlewrap">
      <div class="title">Linda</div>
      <div class="subtitle">Ausbildung · Prüfung · Personal</div>
    </div>
    <button class="topbtn" id="btnNew">New Chat</button>
  </div>

  <div class="content">
    <div class="card">
      <div class="log" id="log"></div>

      <div class="composer">
        <div class="composerRow">
          <textarea id="in" rows="1" placeholder="Schreibe an Linda …"></textarea>
          <button id="send" class="send">➤</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const MAX_HISTORY_TO_SEND = 4;
  const STORAGE_KEY = 'linda.mobile.clean.v1';

  let messages = [];
  let isSending = false;

  // safer markdown: strip raw HTML
  if (window.marked){
    const r = new marked.Renderer();
    r.html = () => '';
    marked.setOptions({ renderer:r, mangle:false, headerIds:false });
  }

  const initialMsg = {
    role:'assistant',
    content:'Hallo Jens! Ich bin **Linda**. Wobei kann ich dir helfen – AEVO, Personal, Recht oder Prüfungsvorbereitung?'
  };

  function load(){
    try{ messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
    catch{ messages = []; }
    if (!messages.length) messages = [{...initialMsg}];
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(messages)); }

  function autosize(){
    const el = $('in');
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 160) + 'px';
  }

  function render(){
    const log = $('log');
    log.innerHTML = '';
    messages.forEach(m=>{
      const d = document.createElement('div');
      d.className = 'bubble ' + (m.role==='user' ? 'me' : 'bot');
      d.innerHTML = window.marked ? marked.parse(m.content || '') : (m.content || '');
      log.appendChild(d);
    });
    log.scrollTop = log.scrollHeight;
  }

  function lastMessagesForApi(all){
    const cleaned = all.filter(m => !(m.role==='assistant' && (m.content||'').startsWith('⏳')));
    return cleaned.slice(-MAX_HISTORY_TO_SEND).map(m => ({ role:m.role, content:m.content }));
  }

  function setSending(on){
    isSending = on;
    $('send').disabled = on;
  }

  async function send(){
    if (isSending) return;
    const q = ($('in').value || '').trim();
    if (!q) return;

    messages.push({ role:'user', content:q });
    $('in').value = '';
    autosize();

    messages.push({ role:'assistant', content:'⏳ Einen Moment …' });
    render();
    save();
    setSending(true);

    try{
      const payloadHistory = lastMessagesForApi(messages);

      const res = await fetch('/api/bot', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ question:q, history: payloadHistory })
      });

      const reply = await res.text();

      for (let i = messages.length - 1; i >= 0; i--){
        if (messages[i].role==='assistant' && (messages[i].content||'').startsWith('⏳')){
          messages[i] = { role:'assistant', content: reply };
          break;
        }
      }
    } catch {
      messages = messages.filter(m => !(m.role==='assistant' && (m.content||'').startsWith('⏳')));
      messages.push({ role:'assistant', content:'❌ Fehler beim Senden. Bitte prüfe /api/bot.' });
    } finally {
      setSending(false);
      save();
      render();
      setTimeout(()=> $('in').focus(), 50);
    }
  }

  // Modals
  $('p-accept').onclick = ()=>{ $('m-privacy').style.display='none'; $('m-usage').style.display='flex'; };
  $('p-decline').onclick = ()=> location.reload();
  $('u-accept').onclick = ()=>{
    $('m-usage').style.display='none';
    load(); render(); autosize();
    setTimeout(()=> $('in').focus(), 80);
  };

  $('btnNew').onclick = ()=>{
    messages = [{...initialMsg}];
    save(); render();
    setTimeout(()=> $('in').focus(), 50);
  };

  $('send').onclick = send;
  $('in').addEventListener('input', autosize);
  $('in').addEventListener('keydown', (e)=>{
    if (e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // Start
  $('m-privacy').style.display='flex';
})();
</script>
</body>
</html>
