<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeschÃ¼tzter Bereich â€“ LindaBot (Debug)</title>
<style>
  body{font-family:Inter,Arial,sans-serif;background:linear-gradient(135deg,#002b5c,#0072ce);color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
  .card{width:100%;max-width:520px;padding:26px;border-radius:12px;background:rgba(255,255,255,0.04);box-shadow:0 8px 24px rgba(0,0,0,.25);text-align:center}
  input{width:100%;padding:12px;border-radius:8px;border:0;font-size:1rem;box-sizing:border-box}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
  button{padding:10px 14px;border-radius:8px;border:0;background:#00a3e0;color:#fff;font-weight:600;cursor:pointer}
  .error{color:#ffbaba;margin-top:12px;min-height:1.2em}
  .muted{opacity:.9;font-size:.86rem;margin-top:10px}
  .log{background:rgba(0,0,0,0.12);padding:8px;border-radius:6px;margin-top:10px;text-align:left;max-height:120px;overflow:auto;font-size:0.8rem}
</style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="t">
    <h1 id="t">ðŸ”’ GeschÃ¼tzter Bereich (Debug)</h1>
    <p class="muted">Gib das Passwort ein, um LindaBot zu starten. (Nicht im Klartext gespeichert)</p>

    <input id="pw" type="password" autocomplete="current-password" placeholder="Passwort eingeben" />
    <div class="actions">
      <button id="btn">Anmelden</button>
      <button id="btnClear" type="button">ZurÃ¼cksetzen</button>
    </div>

    <div id="error" class="error" role="status" aria-live="polite"></div>
    <div id="help" class="muted">5 Fehlversuche â†’ 5 Minuten Sperre. Siehe Konsole fÃ¼r Debug.</div>

    <div class="log" id="log" aria-hidden="false"></div>
  </div>

<script>
(async function(){
  const LOG = (s) => {
    console.log("[LB-login]", s);
    const el = document.getElementById("log");
    el.textContent = (el.textContent ? el.textContent + "\n" : "") + String(s);
    el.scrollTop = el.scrollHeight;
  };

  LOG("Initialisiere Login...");

  // SHA-256 Hash of ""
  const STORED_HASH = "b91b8c3fb9581f3a2f14020fd19c74d53e60dd3aa7379dffd2f037a7a6c38407";

  // Config
  const MAX_ATTEMPTS = 5;
  const LOCK_MS = 5 * 60 * 1000;
  const KEY_ATT = "lb_attempts";
  const KEY_LOCK = "lb_lock_until";

  // Elements
  const pw = document.getElementById("pw");
  const btn = document.getElementById("btn");
  const btnClear = document.getElementById("btnClear");
  const err = document.getElementById("error");

  // Utils
  function getAttempts(){ return parseInt(localStorage.getItem(KEY_ATT) || "0",10) || 0; }
  function setAttempts(n){ localStorage.setItem(KEY_ATT, String(n)); }
  function getLock(){ return parseInt(localStorage.getItem(KEY_LOCK) || "0",10) || 0; }
  function setLock(ts){ localStorage.setItem(KEY_LOCK, String(ts)); }
  function setError(msg){ err.textContent = msg; LOG(msg); }
  function clearError(){ err.textContent = ""; }

  function constantTimeEquals(a,b){
    if(!a||!b||a.length!==b.length) return false;
    let r=0;
    for(let i=0;i<a.length;i++) r |= a.charCodeAt(i) ^ b.charCodeAt(i);
    return r===0;
  }

  async function sha256Hex(msg){
    if(!window.crypto || !crypto.subtle) throw new Error("Web Crypto API nicht verfÃ¼gbar");
    const enc = new TextEncoder();
    const data = enc.encode(msg);
    const buf = await crypto.subtle.digest("SHA-256", data);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,"0")).join("");
  }

  function lockedState(){
    const now = Date.now();
    const lock = getLock();
    if(lock && now < lock){
      const rem = Math.ceil((lock - now)/1000);
      setError(`TemporÃ¤r gesperrt. Noch ca. ${Math.ceil(rem/60)} min ${rem%60}s`);
      btn.disabled = true; pw.disabled=true;
      return true;
    }
    if(lock && now >= lock){ setLock(0); setAttempts(0); btn.disabled=false; pw.disabled=false; clearError(); }
    return false;
  }

  // init
  try {
    LOG("PrÃ¼fe WebCrypto...");
    if(!window.crypto || !crypto.subtle) {
      LOG("Warnung: Web Crypto API nicht verfÃ¼gbar. Hashing schlÃ¤gt fehl.");
      setError("Fehler: Web Crypto API nicht verfÃ¼gbar (Browser/Privatmodus?).");
    } else {
      LOG("WebCrypto OK.");
    }
  } catch(e){
    LOG("WebCrypto-Check-Fehler: " + e);
  }

  // handler
  async function attemptLogin(){
    clearError();
    LOG("Login-Versuch gestartet...");
    if(lockedState()) return;

    const val = (pw.value || "").trim();
    if(!val){
      setError("Bitte Passwort eingeben.");
      return;
    }

    // Hash berechnen
    let hash;
    try {
      hash = await sha256Hex(val);
      LOG("Eingegebener Hash: " + hash);
    } catch(e){
      setError("Fehler beim Hashen: " + e.message);
      return;
    }

    // Vergleich
    if(constantTimeEquals(hash, STORED_HASH)){
      LOG("Hashvergleich OK â€“ Login erfolgreich.");
      // Setze Session-Flag (kurzlebig)
      try{ sessionStorage.setItem("lb_auth","1"); } catch(e){ LOG("sessionStorage set fehlgeschlagen: "+e); }
      // Visuelles Feedback
      err.style.color = "#bfffcf";
      setError("Login erfolgreich. Weiterleitung...");
      // Optional: prÃ¼fe, ob Zielseite existiert (nur als test)
      try {
        const testUrl = "index2510.html";
        LOG("PrÃ¼fe Erreichbarkeit von " + testUrl + " (HEAD) ...");
        // HEAD kann scheitern bei file:// und CORS, ignoriere Fehler
        await fetch(testUrl, { method: "HEAD" , cache:"no-store"}).then(r=>{
          LOG("HEAD-Response: " + r.status + " " + r.statusText);
        }).catch(e=>{
          LOG("HEAD-Request fehlgeschlagen (kann CORS/404 sein): " + e.message);
        });
      } catch(e){ LOG("Fehler bei ZielprÃ¼fung: " + e); }

      // kurze VerzÃ¶gerung, dann weiterleiten
      setTimeout(()=>{ window.location.href = "index2510.html"; }, 700);
      return;
    } else {
      // falsch
      let a = getAttempts()+1;
      setAttempts(a);
      if(a >= MAX_ATTEMPTS){
        const until = Date.now() + LOCK_MS;
        setLock(until);
        setError(`Zu viele Fehlversuche. Gesperrt fÃ¼r ${Math.ceil(LOCK_MS/60000)} Minuten.`);
        LOG("Sperre gesetzt bis " + new Date(until).toISOString());
      } else {
        setError(`Falsches Passwort. Versuch ${a} von ${MAX_ATTEMPTS}.`);
        LOG("Falsches Passwort. Versuch " + a);
      }
      pw.value = "";
      pw.focus();
      return;
    }
  }

  btn.addEventListener("click", attemptLogin);
  btnClear.addEventListener("click", ()=>{ pw.value=""; clearError(); pw.focus(); });
  pw.addEventListener("keydown", (e)=>{ if(e.key==="Enter") attemptLogin(); });

  // Periodische SperrprÃ¼fung
  setInterval(()=>{ lockedState(); }, 2000);

  LOG("Login-Form bereit.");
})();
</script>
</body>
</html>
