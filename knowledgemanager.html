<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mitarbeiter-Selbstauskunft – 12‑Monats‑Workflow (Degreed‑Style)</title>
  <style>
    /* ===== Degreed‑inspired theme ===== */
    :root{
      --bg: #0b1220;
      --surface: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --brand: #0A66FF; /* Degreed-esque blue */
      --brand-2: #5BA1FF;
      --accent: #10b981; /* success */
      --warn: #f59e0b;
      --err: #ef4444;
      --radius: 18px;
      --shadow: 0 10px 30px rgba(2,6,23,0.35);
      --frost: rgba(255,255,255,0.06);
    }

    * { box-sizing: border-box; }
    html,body{height:100%}
    body{
      margin:0; 
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 5% 0%, rgba(10,102,255,0.14), transparent 60%),
        radial-gradient(900px 600px at 100% 0%, rgba(16,185,129,0.12), transparent 60%),
        var(--bg);
    }

    .wrap{max-width: 1100px; margin: 42px auto; padding: 0 20px;}

    .shell{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid rgba(148,163,184,0.18);
      border-radius: 26px;
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(6px);
    }

    /* Header */
    header.hero{
      position: relative;
      padding: 28px 28px 16px;
      background: linear-gradient(180deg, rgba(10,102,255,0.18), rgba(10,102,255,0.00));
      border-bottom: 1px solid rgba(148,163,184,0.18);
    }
    header.hero .top{display:flex; gap:16px; align-items:center; justify-content:space-between}
    .brand-left{display:flex; gap:14px; align-items:center}
    .avatar{width:40px; height:40px; border-radius:50%; display:grid; place-items:center; background: linear-gradient(135deg, var(--brand), var(--brand-2)); font-weight:700}
    .title h1{margin:0; font-size: clamp(22px, 2.6vw, 30px); letter-spacing: .2px}
    .title p{margin:4px 0 0; color: var(--muted)}

    .chip{font-size: 12px; padding: 6px 10px; border-radius: 999px; border:1px solid rgba(148,163,184,0.25); background: rgba(255,255,255,0.03)}

    /* Stepper */
    .stepper{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .step{
      display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      border:1px solid rgba(148,163,184,0.25); color: var(--muted); font-size: 13px;
      background: rgba(255,255,255,0.02);
      transition: all .25s ease;
    }
    .step.active{border-color: var(--brand); color: #fff; background: linear-gradient(180deg, var(--brand), var(--brand-2)); box-shadow: 0 4px 12px rgba(10,102,255,0.35)}
    .step svg{opacity:.8}

    /* Content */
    .content{padding: 24px 28px 28px; display: grid; gap: 22px;}
    .row{display: grid; grid-template-columns: 1fr 1fr; gap: 16px;}
    @media (max-width: 800px){ .row{grid-template-columns: 1fr;} }

    label{font-size: 13px; color: var(--muted); display:block; margin: 0 0 6px;}
    input, select, textarea{
      width:100%; border-radius: 14px; border:1px solid rgba(148,163,184,0.28);
      padding: 12px 14px; background: var(--card); color: var(--text);
    }
    textarea{min-height: 110px}

    .btns{display:flex; gap:12px; flex-wrap: wrap; align-items:center}
    .btn{border:none; border-radius: 14px; padding: 12px 16px; cursor:pointer; font-weight:700; letter-spacing:.2px}
    .btn-primary{background: linear-gradient(90deg, var(--brand), var(--brand-2)); color:white; box-shadow: 0 6px 18px rgba(10,102,255,0.35);}
    .btn-ghost{background: rgba(255,255,255,0.04); color: var(--text); border: 1px solid rgba(148,163,184,0.28)}
    .btn-muted{background: transparent; color: var(--muted); border: 1px dashed var(--muted)} 
    .btn-danger{background: transparent; color: var(--err); border: 1px solid var(--err)}
    .btn:hover{transform: translateY(-1px); filter: brightness(1.05)}

    /* Pills Yes/No */
    .yn{display:flex; gap:10px}
    .yn input{display:none}
    .yn label{margin:0; padding: 10px 14px; border-radius: 999px; cursor: pointer; border:1px solid rgba(148,163,184,0.45); background: rgba(255,255,255,0.02)}
    .yn input:checked + label{border-color: var(--brand); color: #fff; background: linear-gradient(90deg, var(--brand), var(--brand-2)); box-shadow: 0 4px 12px rgba(10,102,255,0.35)}

    .list{display:grid; gap:12px}
    .item{padding:14px; border:1px solid rgba(148,163,184,0.28); border-radius: 14px; background: var(--card)}

    .help{font-size:13px; color: var(--muted)}
    .divider{height:1px; background: rgba(148,163,184,0.25); margin: 10px 0 6px}
    .footer{display:flex; justify-content:space-between; align-items:center; gap:8px; padding-top: 10px; border-top: 1px dashed rgba(148,163,184,0.35)}

    .badge{font-size:12px; padding: 4px 8px; border-radius: 999px; border:1px solid rgba(148,163,184,0.35); color:var(--muted)}
    .badge.ok{color:#34d399; border-color:#34d399}
    .badge.warn{color:#f59e0b; border-color:#f59e0b}

    /* ===== Summary ("cool" finish) ===== */
    #sec-4{position: relative}
    .summary-wrap{
      display:grid; gap:18px;
    }
    .summary-hero{
      position: relative; overflow:hidden;
      background: linear-gradient(135deg, rgba(10,102,255,0.25), rgba(16,185,129,0.18));
      border:1px solid rgba(148,163,184,0.25);
      border-radius: 20px; padding: 20px;
    }
    .summary-hero h2{margin:0 0 6px}
    .summary-hero p{margin:0; color:#d1d5db}

    .score{
      display:flex; align-items:center; gap:18px; margin-top:10px
    }
    .donut{width:90px; height:90px; border-radius:50%; display:grid; place-items:center; background: conic-gradient(var(--brand) var(--pct, 0%), rgba(255,255,255,0.15) 0);}
    .donut::after{content: attr(data-label); font-weight:800}

    .summary-grid{display:grid; grid-template-columns:1.2fr 1fr; gap:16px}
    @media (max-width: 900px){ .summary-grid{grid-template-columns:1fr} }

    .card{background: var(--card); border: 1px solid rgba(148,163,184,0.25); border-radius: 16px; padding:16px}
    .timeline{display:grid; gap:12px; position: relative}
    .timeline .titem{display:grid; gap:6px; padding-left:20px; border-left:2px solid rgba(148,163,184,0.25); position: relative}
    .timeline .titem::before{content:""; position:absolute; left:-7px; top:6px; width:10px; height:10px; border-radius:50%; background: var(--brand); box-shadow: 0 0 0 3px rgba(10,102,255,0.25)}

    .jsonbox{max-height: 300px; overflow:auto; background: rgba(255,255,255,0.04); padding:12px; border-radius: 12px; border:1px solid rgba(148,163,184,0.18)}

    .cta-row{display:flex; gap:10px; flex-wrap:wrap}

    /* Confetti Canvas */
    #confetti{position:absolute; inset:0; pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="shell" role="region" aria-label="Mitarbeiter‑Selbstauskunft">
      <header class="hero">
        <div class="top">
          <div class="brand-left">
            <div class="avatar" id="avatar">U</div>
            <div class="title">
              <h1>Selbstauskunft – 12‑Monats‑Workflow</h1>
              <p>Erfassen · Prüfen · Abfragen · Zusammenfassung</p>
            </div>
          </div>
          <span class="chip" id="chip-window">Zeitraum: –</span>
        </div>
        <div class="stepper" id="stepper"></div>
      </header>

      <div class="content">
        <!-- Section 1: Personaldaten -->
        <section class="section" id="sec-1">
          <div class="row">
            <div>
              <label for="vorname">Vorname</label>
              <input id="vorname" autocomplete="given-name" required />
            </div>
            <div>
              <label for="nachname">Nachname</label>
              <input id="nachname" autocomplete="family-name" required />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="email">E‑Mail</label>
              <input id="email" type="email" autocomplete="email" required />
            </div>
            <div>
              <label for="mitid">Mitarbeiter‑ID (optional)</label>
              <input id="mitid" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="abteilung">Abteilung (optional)</label>
              <input id="abteilung" />
            </div>
            <div>
              <label for="standort">Standort (optional)</label>
              <input id="standort" />
            </div>
          </div>
          <div class="btns">
            <button class="btn btn-primary" id="btn-save-person">Speichern & prüfen</button>
            <button class="btn btn-ghost" id="btn-fill-demo" type="button" title="Beispieldaten einfüllen">Beispieldaten</button>
            <span class="badge" id="status-1">Bereit</span>
          </div>
        </section>

        <!-- Section 2: Prüfung Datenbestand -->
        <section class="section" id="sec-2" style="display:none">
          <p><strong>Systemprüfung:</strong> Es wird gesucht, ob für diese Person bereits Daten hinterlegt sind.</p>
          <div id="existing-info" class="list"></div>
          <div class="btns">
            <button class="btn btn-primary" id="btn-continue-to-qa">Weiter zu Abfragen</button>
            <button class="btn btn-muted" id="btn-back-1">Zurück</button>
          </div>
        </section>

        <!-- Section 3: Abfragen -->
        <section class="section" id="sec-3" style="display:none">
          <div class="list">
            <div class="card">
              <label>Haben Sie in den letzten 12 Monaten <strong>externe Schulungen</strong> absolviert?</label>
              <div class="yn" style="margin-top:6px">
                <input type="radio" name="extTrain" id="extNo" value="no" checked>
                <label for="extNo">Nein</label>
                <input type="radio" name="extTrain" id="extYes" value="yes">
                <label for="extYes">Ja</label>
              </div>
              <div id="ext-container" hidden style="margin-top:10px">
                <div class="help">Bitte jede Schulung eintragen. Nur Daten zwischen <span id="ext-min"></span> und <span id="ext-max"></span> sind zulässig.</div>
                <div class="list" id="ext-list" style="margin-top:10px"></div>
                <div class="btns">
                  <button type="button" class="btn btn-ghost" id="btn-add-ext">+ Schulung hinzufügen</button>
                </div>
              </div>
            </div>

            <div class="card">
              <label>Haben Sie in den letzten 12 Monaten <strong>internes Wissen dokumentiert</strong> (z. B. Wiki, SOP, SharePoint)?</label>
              <div class="yn" style="margin-top:6px">
                <input type="radio" name="intDoc" id="intNo" value="no" checked>
                <label for="intNo">Nein</label>
                <input type="radio" name="intDoc" id="intYes" value="yes">
                <label for="intYes">Ja</label>
              </div>
              <div id="int-container" hidden style="margin-top:10px">
                <div class="help">Beschreiben Sie kurz Inhalt und Ablageort. Nur Einträge zwischen <span id="int-min"></span> und <span id="int-max"></span>.</div>
                <div class="list" id="int-list" style="margin-top:10px"></div>
                <div class="btns">
                  <button type="button" class="btn btn-ghost" id="btn-add-int">+ Wissenseintrag hinzufügen</button>
                </div>
              </div>
            </div>
          </div>
          <div class="footer">
            <div class="btns">
              <button class="btn btn-primary" id="btn-to-summary">Zur Zusammenfassung</button>
              <button class="btn btn-muted" id="btn-back-2">Zurück</button>
            </div>
            <span class="badge" id="status-3">Eingaben nicht gespeichert</span>
          </div>
        </section>

        <!-- Section 4: Zusammenfassung (cool) -->
        <section class="section" id="sec-4" style="display:none">
          <canvas id="confetti"></canvas>
          <div class="summary-wrap">
            <div class="summary-hero">
              <h2 id="sum-title">Top! Zusammenfassung bereit</h2>
              <p>Dein 12‑Monats‑Fenster: <span id="win-min"></span> bis <span id="win-max"></span>. <span class="chip" id="badge-count">0 Einträge</span></p>
              <div class="score">
                <div class="donut" id="donut" data-label="0%"></div>
                <div>
                  <div class="chip" id="chip-complete">Vervollständigung: 0%</div>
                  <div class="chip" id="chip-state">Status: Entwurf</div>
                </div>
              </div>
            </div>

            <div class="summary-grid">
              <div class="card">
                <h3 style="margin:0 0 8px">Externe Schulungen</h3>
                <div id="ext-timeline" class="timeline"></div>
              </div>
              <div class="card">
                <h3 style="margin:0 0 8px">Intern dokumentiertes Wissen</h3>
                <div id="int-timeline" class="timeline"></div>
              </div>
            </div>

            <div class="card">
              <h3 style="margin:0 0 8px">Daten (JSON)</h3>
              <div class="jsonbox"><pre id="json-out" aria-live="polite"></pre></div>
            </div>

            <div class="cta-row">
              <button class="btn btn-primary" id="btn-save-all">Lokal speichern</button>
              <button class="btn btn-ghost" id="btn-download-json">JSON herunterladen</button>
              <button class="btn btn-ghost" id="btn-print">Drucken/Export</button>
              <button class="btn btn-ghost" id="btn-new">Neuer Durchlauf</button>
              <button class="btn btn-danger" id="btn-reset-user">Alle lokalen Daten löschen</button>
            </div>
            <p class="help">Hinweis: Standardmäßig wird nichts an Server gesendet. Integration zu SharePoint/Make ist vorbereitet (siehe Platzhalter im Code).</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ===== Utilities & state =====
    const stepNames = ['1 · Personaldaten','2 · Prüfung','3 · Abfragen','4 · Zusammenfassung'];
    const stepper = document.getElementById('stepper');
    function renderStepper(active=1){
      stepper.innerHTML = '';
      stepNames.forEach((name, idx)=>{
        const el = document.createElement('div');
        el.className = 'step' + (idx+1===active? ' active':'');
        el.dataset.step = String(idx+1);
        el.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 7L9 18L4 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> ${name}`;
        stepper.appendChild(el);
      });
    }

    function setStep(step){
      renderStepper(step);
      document.querySelectorAll('.section').forEach((sec, idx)=>{
        sec.style.display = (idx === (step-1)) ? 'block' : 'none';
      });
      window.scrollTo({top:0, behavior:'smooth'});
    }
    renderStepper(1);

    function initials(vor, nach){
      const v = (vor||'').trim()[0]||'U';
      const n = (nach||'').trim()[0]||'';
      return (v+n).toUpperCase();
    }

    // Date window (12 months)
    function formatISODate(d){ return d.toISOString().slice(0,10); }
    const today = new Date();
    const maxDate = formatISODate(today);
    const past = new Date(); past.setMonth(past.getMonth()-12);
    const minDate = formatISODate(past);
    document.getElementById('chip-window').textContent = `Zeitraum: ${minDate} – ${maxDate}`;
    document.getElementById('win-min').textContent = minDate;
    document.getElementById('win-max').textContent = maxDate;

    // State
    let person = {}; // {vorname, nachname, email, mitid, abteilung, standort}
    let answers = { flags: {extYes:false, intYes:false}, extTrainings: [], intDocs: [] };

    const status1 = document.getElementById('status-1');
    const status3 = document.getElementById('status-3');

    const inputs = {
      vorname: document.getElementById('vorname'),
      nachname: document.getElementById('nachname'),
      email: document.getElementById('email'),
      mitid: document.getElementById('mitid'),
      abteilung: document.getElementById('abteilung'),
      standort: document.getElementById('standort')
    };

    // Demo fill
    document.getElementById('btn-fill-demo').addEventListener('click', ()=>{
      inputs.vorname.value = 'Alex';
      inputs.nachname.value = 'Muster';
      inputs.email.value = 'alex.muster@example.com';
      inputs.mitid.value = 'A12345';
      inputs.abteilung.value = 'Vertrieb';
      inputs.standort.value = 'Oldenburg';
      document.getElementById('avatar').textContent = initials(inputs.vorname.value, inputs.nachname.value);
    });

    function keyForUser(p){
      return (p.mitid && String(p.mitid).trim()) || (p.email && String(p.email).toLowerCase().trim());
    }

    function savePersonToLocal(p){
      const key = keyForUser(p);
      if(!key){ throw new Error('Kein Schlüssel (Mitarbeiter‑ID oder E‑Mail)'); }
      localStorage.setItem(`person:${key}`, JSON.stringify(p));
    }

    function loadPersonFromLocal(key){
      const raw = localStorage.getItem(`person:${key}`);
      return raw ? JSON.parse(raw) : null;
    }

    function loadAnswersFromLocal(key){
      const raw = localStorage.getItem(`answers:${key}`);
      return raw ? JSON.parse(raw) : null;
    }

    function saveAnswersToLocal(key, a){
      localStorage.setItem(`answers:${key}`, JSON.stringify(a));
    }

    // Section 1: Save & check
    document.getElementById('btn-save-person').addEventListener('click', ()=>{
      const p = {
        vorname: inputs.vorname.value.trim(),
        nachname: inputs.nachname.value.trim(),
        email: inputs.email.value.trim(),
        mitid: inputs.mitid.value.trim(),
        abteilung: inputs.abteilung.value.trim(),
        standort: inputs.standort.value.trim()
      };
      if(!p.vorname || !p.nachname || !p.email){
        alert('Bitte Vorname, Nachname und E‑Mail ausfüllen.');
        return;
      }
      try{ savePersonToLocal(p); } catch(e){ alert(e.message); return; }
      person = p;
      status1.textContent = 'Gespeichert'; status1.classList.add('ok');
      document.getElementById('avatar').textContent = initials(p.vorname, p.nachname);
      populateExistingInfo();
      setStep(2);
    });

    document.getElementById('btn-back-1').addEventListener('click', ()=> setStep(1));

    function populateExistingInfo(){
      const container = document.getElementById('existing-info');
      container.innerHTML = '';
      const key = keyForUser(person);
      const existingPerson = loadPersonFromLocal(key);
      const existingAnswers = loadAnswersFromLocal(key);
      const hasAnswers = !!existingAnswers;

      const info = document.createElement('div');
      info.className = 'item';
      info.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
        <div><strong>Gefundene Person</strong>: ${existingPerson ? existingPerson.vorname + ' ' + existingPerson.nachname : '—'}<div class="help">Schlüssel: <code>${key}</code></div></div>
        <span class="chip">${existingPerson ? 'vorhanden' : 'neu'}</span>
      </div>`;
      container.appendChild(info);

      const dataPanel = document.createElement('div');
      dataPanel.className = 'item';
      dataPanel.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
        <div><strong>Vorliegende Antworten</strong>: ${hasAnswers ? '<span class="badge ok">vorhanden</span>' : '<span class="badge warn">keine</span>'}</div>
        <div class="btns">
          ${hasAnswers ? '<button id="btn-load-existing" class="btn btn-ghost">Vorhandene laden</button>' : ''}
          <button id="btn-start-fresh" class="btn btn-primary">Neu beginnen</button>
        </div>
      </div>`;
      container.appendChild(dataPanel);

      if(hasAnswers){
        document.getElementById('btn-load-existing').addEventListener('click', ()=>{
          answers = existingAnswers;
          hydrateQAFromAnswers();
          setStep(3);
        });
      }
      document.getElementById('btn-start-fresh').addEventListener('click', ()=>{
        answers = { flags: {extYes:false, intYes:false}, extTrainings: [], intDocs: [] };
        clearQA();
        setStep(3);
      });
    }

    document.getElementById('btn-continue-to-qa').addEventListener('click', ()=> setStep(3));
    document.getElementById('btn-back-2').addEventListener('click', ()=> setStep(2));

    // QA Section handlers
    const extContainer = document.getElementById('ext-container');
    const intContainer = document.getElementById('int-container');
    const extList = document.getElementById('ext-list');
    const intList = document.getElementById('int-list');

    document.getElementById('extYes').addEventListener('change', ()=>{ extContainer.hidden = false; answers.flags.extYes = true; });
    document.getElementById('extNo').addEventListener('change', ()=>{ extContainer.hidden = true; answers.flags.extYes = false; });
    document.getElementById('intYes').addEventListener('change', ()=>{ intContainer.hidden = false; answers.flags.intYes = true; });
    document.getElementById('intNo').addEventListener('change', ()=>{ intContainer.hidden = true; answers.flags.intYes = false; });

    function addExtItem(item={titel:'', anbieter:'', datum:'', stunden:'', nachweis:''}){
      const idx = crypto.randomUUID();
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.key = idx;
      div.innerHTML = `
        <div class="row">
          <div>
            <label>Titel/Name der Schulung</label>
            <input value="${item.titel||''}" placeholder="z.B. Datenschutz Update"/>
          </div>
          <div>
            <label>Anbieter</label>
            <input value="${item.anbieter||''}" placeholder="z.B. IHK Akademie"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Datum</label>
            <input type="date" min="${minDate}" max="${maxDate}" value="${item.datum||''}"/>
          </div>
          <div>
            <label>Unterrichtsstunden (optional)</label>
            <input type="number" min="0" step="0.5" value="${item.stunden||''}" placeholder="z.B. 8"/>
          </div>
        </div>
        <div>
          <label>Nachweis/Link (optional)</label>
          <input value="${item.nachweis||''}" placeholder="URL zu Zertifikat/Ordner"/>
        </div>
        <div class="btns" style="justify-content:end"><button type="button" class="btn btn-danger">Entfernen</button></div>
      `;
      div.querySelector('.btn-danger').addEventListener('click', ()=>{ extList.removeChild(div); });
      extList.appendChild(div);
    }

    function addIntItem(item={titel:'', art:'', ort:'', datum:'', beschreibung:''}){
      const idx = crypto.randomUUID();
      const div = document.createElement('div');
      div.className = 'item';
      div.dataset.key = idx;
      div.innerHTML = `
        <div class="row">
          <div>
            <label>Titel/Kurzbezeichnung</label>
            <input value="${item.titel||''}" placeholder="z.B. Onboarding‑SOP Vertrieb"/>
          </div>
          <div>
            <label>Form/Art</label>
            <input value="${item.art||''}" placeholder="Wiki‑Artikel, SOP, Checkliste, Video…"/>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Ablageort/Link</label>
            <input value="${item.ort||''}" placeholder="SharePoint‑Pfad / URL"/>
          </div>
          <div>
            <label>Datum</label>
            <input type="date" min="${minDate}" max="${maxDate}" value="${item.datum||''}"/>
          </div>
        </div>
        <div>
          <label>Kurzbeschreibung</label>
          <textarea placeholder="Was wurde dokumentiert und wozu?">${item.beschreibung||''}</textarea>
        </div>
        <div class="btns" style="justify-content:end"><button type="button" class="btn btn-danger">Entfernen</button></div>
      `;
      div.querySelector('.btn-danger').addEventListener('click', ()=>{ intList.removeChild(div); });
      intList.appendChild(div);
    }

    document.getElementById('btn-add-ext').addEventListener('click', ()=> addExtItem());
    document.getElementById('btn-add-int').addEventListener('click', ()=> addIntItem());

    function collectQA(){
      const extYes = document.getElementById('extYes').checked;
      const intYes = document.getElementById('intYes').checked;
      const extTrainings = [];
      const intDocs = [];
      if(extYes){
        Array.from(extList.children).forEach(div=>{
          const [titel, anbieter] = div.querySelectorAll('input');
          const date = div.querySelector('input[type=date]');
          const stunden = div.querySelectorAll('input')[3];
          const nachweis = div.querySelectorAll('input')[4];
          if(date.value && (date.value < minDate || date.value > maxDate)){
            throw new Error(`Schulung "${titel.value||''}": Datum außerhalb des zulässigen Bereichs (${minDate} bis ${maxDate}).`);
          }
          if(titel.value || anbieter.value || date.value || stunden.value || nachweis.value){
            extTrainings.push({
              titel: titel.value.trim(),
              anbieter: anbieter.value.trim(),
              datum: date.value,
              stunden: stunden.value ? Number(stunden.value) : null,
              nachweis: nachweis.value.trim()
            });
          }
        });
      }
      if(intYes){
        Array.from(intList.children).forEach(div=>{
          const inputsAll = div.querySelectorAll('input');
          const titel = inputsAll[0];
          const art = inputsAll[1];
          const ort = inputsAll[2];
          const datum = div.querySelector('input[type=date]');
          const beschreibung = div.querySelector('textarea');
          if(datum.value && (datum.value < minDate || datum.value > maxDate)){
            throw new Error(`Interner Eintrag "${titel.value||''}": Datum außerhalb des zulässigen Bereichs (${minDate} bis ${maxDate}).`);
          }
          if(titel.value || art.value || ort.value || datum.value || beschreibung.value){
            intDocs.push({
              titel: titel.value.trim(),
              art: art.value.trim(),
              ort: ort.value.trim(),
              datum: datum.value,
              beschreibung: beschreibung.value.trim()
            });
          }
        });
      }
      return { flags: { extYes, intYes }, extTrainings, intDocs };
    }

    function clearQA(){
      document.getElementById('extNo').checked = true; extContainer.hidden = true; extList.innerHTML = '';
      document.getElementById('intNo').checked = true; intContainer.hidden = true; intList.innerHTML = '';
      status3.textContent = 'Eingaben nicht gespeichert'; status3.classList.remove('ok');
    }

    function hydrateQAFromAnswers(){
      clearQA();
      if(answers.flags?.extYes){
        document.getElementById('extYes').checked = true; extContainer.hidden = false;
        (answers.extTrainings||[]).forEach(addExtItem);
      }
      if(answers.flags?.intYes){
        document.getElementById('intYes').checked = true; intContainer.hidden = false;
        (answers.intDocs||[]).forEach(addIntItem);
      }
      status3.textContent = 'Vorhandene Eingaben geladen'; status3.classList.add('ok');
    }

    document.getElementById('btn-to-summary').addEventListener('click', ()=>{
      try{ answers = collectQA(); }catch(err){ alert(err.message); return; }
      const key = keyForUser(person);
      const payload = { person, answers, meta: { createdAt: new Date().toISOString(), window: { minDate, maxDate } } };
      document.getElementById('json-out').textContent = JSON.stringify(payload, null, 2);
      // compute score & badges and build timelines
      buildSummary(payload);
      setStep(4);
      runConfetti();
    });

    document.getElementById('btn-save-all').addEventListener('click', ()=>{
      try{ saveAnswersToLocal(keyForUser(person), answers); } catch(e){ alert(e.message); return; }
      status3.textContent = 'Gespeichert'; status3.classList.add('ok');
      alert('Daten lokal gespeichert.');
    });

    document.getElementById('btn-download-json').addEventListener('click', ()=>{
      const blob = new Blob([
        JSON.stringify({ person, answers, meta: { exportedAt: new Date().toISOString() } }, null, 2)
      ], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `selbstauskunft_${(person.mitid||person.email||'user')}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('btn-print').addEventListener('click', ()=> window.print());

    document.getElementById('btn-new').addEventListener('click', ()=>{
      clearQA(); setStep(1);
    });

    document.getElementById('btn-reset-user').addEventListener('click', ()=>{
      if(!person || !keyForUser(person)) { alert('Kein Nutzer geladen.'); return; }
      if(confirm('Alle lokalen Daten zu diesem Nutzer endgültig löschen?')){
        const key = keyForUser(person);
        localStorage.removeItem(`person:${key}`);
        localStorage.removeItem(`answers:${key}`);
        alert('Gelöscht.'); setStep(1);
      }
    });

    // Summary builder
    function buildSummary(payload){
      const { person, answers } = payload;
      const countFields = ['vorname','nachname','email','mitid','abteilung','standort'].filter(k=> (person[k]||'').trim()).length;
      const toggles = (answers.flags.extYes?1:0) + (answers.flags.intYes?1:0);
      const volume = answers.extTrainings.length + answers.intDocs.length;
      const totalPossible = 6 + 2 + 6; // approx weights => 6 person fields + 2 toggles + 6 entries allowance baseline
      const scoreRaw = Math.min(100, Math.round(((countFields + toggles + Math.min(volume,6)) / totalPossible) * 100));

      const donut = document.getElementById('donut');
      donut.style.setProperty('--pct', scoreRaw + '%');
      donut.setAttribute('data-label', scoreRaw + '%');
      document.getElementById('chip-complete').textContent = `Vervollständigung: ${scoreRaw}%`;
      document.getElementById('chip-state').textContent = scoreRaw === 100 ? 'Status: vollständig' : (scoreRaw >= 60 ? 'Status: gut' : 'Status: Entwurf');
      document.getElementById('badge-count').textContent = `${volume} Einträge`;

      const extT = document.getElementById('ext-timeline');
      const intT = document.getElementById('int-timeline');
      extT.innerHTML = '';
      intT.innerHTML = '';

      if(answers.flags.extYes && answers.extTrainings.length){
        answers.extTrainings
          .sort((a,b)=> (a.datum||'').localeCompare(b.datum||''))
          .forEach(e=>{
            const it = document.createElement('div'); it.className = 'titem';
            it.innerHTML = `<div><strong>${e.titel||'—'}</strong> · ${e.anbieter||''}</div>
            <div class="help">${e.datum||''} · ${e.stunden? e.stunden+' UE · ': ''}${e.nachweis? `<a href="${e.nachweis}" target="_blank" rel="noopener">Nachweis</a>`:''}</div>`;
            extT.appendChild(it);
          });
      }else{
        extT.innerHTML = '<div class="help">Keine externen Schulungen erfasst.</div>';
      }

      if(answers.flags.intYes && answers.intDocs.length){
        answers.intDocs
          .sort((a,b)=> (a.datum||'').localeCompare(b.datum||''))
          .forEach(e=>{
            const it = document.createElement('div'); it.className = 'titem';
            it.innerHTML = `<div><strong>${e.titel||'—'}</strong> · ${e.art||''}</div>
            <div class="help">${e.datum||''} · ${e.ort? `<a href="${e.ort}" target="_blank" rel="noopener">Ablage</a>`:'—'}<br>${e.beschreibung? e.beschreibung.replace(/</g,'&lt;') : ''}</div>`;
            intT.appendChild(it);
          });
      }else{
        intT.innerHTML = '<div class="help">Keine internen Wissenseinträge erfasst.</div>';
      }

      // Title flair
      const sumTitle = document.getElementById('sum-title');
      sumTitle.textContent = scoreRaw >= 80 ? 'Stark! Zusammenfassung bereit ✅' : 'Gut! Du bist fast fertig ✨';
    }

    // Confetti (tiny)
    function runConfetti(){
      const cv = document.getElementById('confetti');
      const ctx = cv.getContext('2d');
      const W = cv.width = cv.offsetWidth; const H = cv.height = 200; // header height
      const pieces = Array.from({length: 70}).map(()=>({
        x: Math.random()*W,
        y: Math.random()*H/2,
        r: 2+Math.random()*4,
        vx: -1 + Math.random()*2,
        vy: 1 + Math.random()*2,
        col: `hsl(${Math.random()*360},90%,60%)`
      }));
      let t = 0; const maxT = 120; // ~2s
      function draw(){
        ctx.clearRect(0,0,W,H);
        pieces.forEach(p=>{
          ctx.fillStyle = p.col;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
          p.x += p.vx; p.y += p.vy; p.vy += 0.02;
          if(p.y>H || p.x<0 || p.x>W){ p.x=Math.random()*W; p.y=-10; p.vx=-1+Math.random()*2; p.vy=1+Math.random()*2; }
        });
        t++; if(t<maxT) requestAnimationFrame(draw); else ctx.clearRect(0,0,W,H);
      }
      draw();
    }

    // Integration placeholders
    async function sendToMake(payload){
      // Beispiel: per Fetch an Make‑Webhook (URL hier eintragen)
      // return fetch('https://hook.integromat.com/abc123', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      return Promise.resolve();
    }
    async function sendToSharePoint(payload){
      // Beispiel: MS Graph/SharePoint REST – hier nur Platzhalter
      return Promise.resolve();
    }
  </script>
</body>
</html>
