<!DOCTYPE html>
<html lang="de">
<head>
  <!-- ================= META & THEME ================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Mobile Ausbildung · Chatbot</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#072146" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0a1628" media="(prefers-color-scheme: dark)">

  <!-- ================= STYLES ================= -->
  <style>
    /* ---------- Design Tokens (BBVA Palette) ---------- */
    :root {
      --bbva-navy: #072146;
      --bbva-blue: #1973b8;
      --bbva-cyan: #5bc2e7;
      --text: #1c2430;
      --text-2: #5f6b7a;
      --bg: #f5f7fa;
      --panel: #ffffff;
      --border: #e1e5eb;
      --shadow: 0 8px 24px rgba(0, 0, 0, .08);
      --radius: 18px;
      --bubble-user: #1973b8;
      --bubble-bot: #f1f4f8;
    }

    body {
      margin: 0;
      font: 17px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-text-size-adjust: 100%;
    }

    /* ---------- App Layout ---------- */
    .app {
      max-width: 880px;
      height: 100dvh;
      margin: 0 auto;
      display: grid;
      grid-template-rows: auto 1fr auto; /* header · main · input */
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* ---------- Header ---------- */
    header.appbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(90deg, var(--bbva-navy), var(--bbva-blue));
      color: #fff;
      padding: 14px 18px;
    }

    .brand { display:flex; align-items:center; gap:10px; }
    .brand h1 { margin: 0; font-size: 18px; letter-spacing: .3px; font-weight: 600; }

    .actions { display: flex; gap: 10px; }

    .btn {
      appearance: none; border: 0; border-radius: 12px; padding: 8px 12px;
      font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all .2s ease;
    }
    .btn svg { width: 18px; height: 18px; }
    .btn-ghost { background: rgba(255,255,255,.18); color:#fff; }
    .btn-ghost:hover { background: rgba(255,255,255,.3); }
    .btn-wa { background:#25d366; color:#fff; }

    /* ---------- Chat Area ---------- */
    main#chat {
      background: rgba(255, 255, 255, .88);
      backdrop-filter: blur(6px);
      overflow: auto; padding: 16px; scroll-behavior: smooth;
    }

    .row { display:flex; gap:10px; margin:10px 0; max-width:86%; }
    .row.user { margin-left:auto; justify-content:flex-end; }
    .row.bot { justify-content:flex-start; }

    .avatar {
      flex:0 0 36px; height:36px; width:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;
      background: var(--bbva-cyan); color:#0e254b;
    }

    .bubble {
      background: var(--bubble-bot); color: var(--text); padding: 12px 14px; border-radius: var(--radius);
      line-height: 1.5; word-break: break-word; white-space: pre-wrap; box-shadow: 0 1px 0 rgba(0,0,0,.03);
      animation: slideIn .25s ease;
    }
    .row.user .bubble { background: var(--bubble-user); color: #fff; border-bottom-right-radius: 6px; }

    @keyframes slideIn { from{ opacity:0; transform:translateY(6px) } to{ opacity:1; transform:translateY(0) } }

    .meta { font-size:12px; color:var(--text-2); margin-top:4px; }

    /* ---------- Composer ---------- */
    .composer { border-top:1px solid var(--border); background:var(--panel); padding:12px; display:grid; gap:8px; }
    .composer-row { display:flex; gap:10px; }
    .field { flex:1; display:flex; align-items:center; background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px; }
    .input { flex:1; border:0; outline:none; font:inherit; background:transparent; font-size:17px; }
    .send { background:var(--bbva-blue); color:#fff; border-radius:12px; border:0; padding:10px 14px; font-weight:700; cursor:pointer; }
    .send:hover { background:var(--bbva-navy); }

    /* ---------- Suggest Chips ---------- */
    .suggest { display:flex; flex-wrap:wrap; gap:8px; padding:4px 2px 0; }
    .chip { background:#e6f0ff; color:#0d3b82; border:0; border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:600; }

    /* ---------- Notice ---------- */
    .notice { position:fixed; inset:auto 16px 16px auto; background:#d4edda; color:#155724; border-radius:10px; padding:10px 12px; box-shadow:var(--shadow); display:none; z-index:50; }
    .notice.error{ background:#f8d7da; color:#721c24; }

    /* ---------- Modal (Consent BBVA Look) ---------- */
    .modal { position:fixed; inset:0; background:rgba(7,18,35,.55); backdrop-filter:blur(8px); display:none; align-items:center; justify-content:center; z-index:100; }
.modal.show{ display:flex; animation:fadeIn .35s ease both; }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    .modal-card { width:min(780px,96vw); background:var(--panel); border-radius:20px; box-shadow:var(--shadow); overflow:hidden; }
    .modal-head { background:linear-gradient(90deg,var(--bbva-navy),var(--bbva-blue)); color:#fff; padding:16px 18px; display:flex; align-items:center; gap:10px; }
    .modal-body { padding:18px; display:grid; gap:14px; }
    .checkline{ display:flex; align-items:flex-start; gap:10px; }
    .checkline input{ margin-top:4px; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; padding:16px 18px; border-top:1px solid var(--border); }
    .btn-primary{ background:var(--bbva-blue); color:#fff; border:0; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }

    /* Details (soft slide) */
    #moreInfo{ max-height:0; overflow:hidden; transition:max-height .35s ease, opacity .35s ease; opacity:0; border-top:1px solid var(--border); padding-top:0; }
    #moreInfo.show{ max-height:800px; opacity:1; padding-top:12px; }

    /* ---------- Print Overlay ---------- */
    #printOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); color:#fff; display:none; align-items:center; justify-content:center; z-index:9999; font-size:18px; text-align:center; padding:20px; }
    #printOverlay.show{ display:flex; animation:fadeIn .4s ease both; }

    /* ---------- Small Screens ---------- */
    @media (max-width:640px){ header.appbar h1{font-size:16px;} .input{font-size:16px;} .app{border-radius:0;} }
  </style>
</head>
<body>
  <!-- ================= APP CONTAINER ================= -->
  <div class="app" role="application">
    <header class="appbar" aria-label="App-Leiste">
      <div class="brand" aria-live="polite">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2v20"/><path d="M3 7h18"/></svg>
        <h1>Mobile Ausbildung · Chatbot</h1>
      </div>
      <div class="actions">
        <!-- Datenschutz Button (öffnet Consent) -->
        <button type="button" class="btn btn-ghost" id="btnLegal" title="Hinweise anzeigen / bestätigen">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><circle cx="12" cy="16" r="1"/></svg>
          Datenschutz
        </button>
        <!-- Drucken (zeigt Overlay) -->
        <button type="button" class="btn btn-ghost" id="btnPrint" title="Drucken mit Hinweis">
          <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Drucken
        </button>
        <!-- WhatsApp Kontakt (nur Light Mode sichtbar; im Dark Mode optional ausblenden per CSS) -->
        <button type="button" class="btn btn-wa" id="btnWA" title="WhatsApp Kontakt 0160 98665006">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M20 4.5A9.8 9.8 0 0 0 12 2a9.9 9.9 0 0 0-9.9 9.9c0 1.8.5 3.5 1.4 5L2 22l5.2-1.4a9.9 9.9 0 0 0 4.8 1.3c5.4 0 9.9-4.4 9.9-9.9 0-2.5-1-4.9-2.9-6.5Z"/>
            <path d="M16.3 14.3c-.2-.1-1.4-.7-1.6-.8-.2-.1-.4-.1-.6.1s-.7.8-.9.9c-.2.1-.3.2-.5.1-.2-.1-.9-.3-1.8-1.1-.7-.6-1.1-1.3-1.3-1.5-.1-.2 0-.3.1-.4.1-.1.2-.3.3-.4.1-.1.1-.2.2-.3.1-.1.1-.2 0-.3s-.6-1.5-.9-2c-.2-.5-.4-.4-.6-.4h-.5c-.2 0-.3.1-.4.2s-.6.6-.6 1.4.6 1.7.7 1.8c.1.1 1.2 2 3 2.8 1.8.8 1.8.5 2.2.5.3 0 .7-.3.8-.6.1-.3.3-.6.4-.7.1-.1.2-.1.4 0 .2.1 1.4.7 1.6.8.2.1.3.1.4 0 .1-.1.4-.2.5-.3.1-.1.1-.2 0-.3Z"/>
          </svg>
          WhatsApp
        </button>
      </div>
    </header>

    <!-- Chat Log -->
    <main id="chat" role="log" aria-live="polite" aria-relevant="additions" aria-label="Chatverlauf"></main>

    <!-- Composer -->
    <div class="composer" aria-label="Nachrichtenbereich">
      <div class="composer-row">
        <div class="field">
          <input class="input" id="input" type="text" inputmode="text" autocomplete="off" aria-label="Deine Nachricht" placeholder="Schreibe hier deine Nachricht…" />
        </div>
        <button type="button" class="send" id="btnSend" aria-label="Nachricht senden">Senden</button>
      </div>
      <div class="suggest" id="suggest"></div>
    </div>

    <div class="notice" id="notice" role="status">Hinweis</div>
  </div>

  <!-- ================= CONSENT MODAL ================= -->
  <div id="consentGate" class="modal" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
    <div class="modal-card">
      <div class="modal-head">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2l7 7-7 7-7-7z"/></svg>
        <h2 id="dlgTitle">Datenschutz & Nutzungshinweis</h2>
      </div>
      <div class="modal-body">
        <p><strong>Worum geht’s?</strong> Dieser KI-Dialog nutzt Dienste von <strong>Microsoft (SharePoint Online)</strong> und <strong>OpenAI</strong>. Deine Eingaben werden technisch an diese Plattformen zur Verarbeitung weitergeleitet.</p>
        <p class="legal"><strong>Wichtig:</strong> Bitte gib <u>keine personenbezogenen Daten</u> ein (z. B. Namen, Kontaktdaten, Gesundheits- oder Kundendaten, interne Aktenzeichen). Nutze nur abstrakte oder beispielhafte Angaben.</p>
        <div class="checkline">
          <input type="checkbox" id="chkData" />
          <label for="chkData">Ich habe den Datenschutzhinweis gelesen und bin mit der Verarbeitung meiner Eingaben durch Microsoft (SharePoint) und OpenAI einverstanden.</label>
        </div>
        <div class="checkline">
          <input type="checkbox" id="chkNoBinding" />
          <label for="chkNoBinding">Ich verstehe, dass die KI <strong>unverbindliche Vorschläge</strong> erzeugt, die <strong>Fehler enthalten</strong> können. Sie ersetzen keine rechtliche, medizinische oder andere fachliche Beratung.</label>
        </div>
        <section id="moreInfo">
          <div id="moreInfoInner" class="content">
            <h3 style="margin:0 0 8px 0; font-size:16px;">Details zur Verarbeitung</h3>
            <ul style="margin:0 0 10px 18px; line-height:1.6;">
              <li><strong>Verantwortlichkeit:</strong> Weiterleitung/Speicherung über <em>Microsoft SharePoint Online</em> und KI‑Verarbeitung durch <em>OpenAI</em>.</li>
              <li><strong>Zweck:</strong> Unverbindliche Vorschläge im Rahmen eines Personal‑KI‑Dialogs.</li>
              <li><strong>Rechtsgrundlage:</strong> Einwilligung (Art. 6 Abs. 1 lit. a DSGVO). Ohne Einwilligung keine Nutzung.</li>
              <li><strong>Datenkategorien:</strong> Inhalte deiner Texteingaben. Bitte keine personenbezogenen Daten.</li>
              <li><strong>Empfänger:</strong> Microsoft Corporation (SharePoint Online) und OpenAI, L.L.C.</li>
              <li><strong>Risiken:</strong> KI kann Fehler halluzinieren; Ergebnisse sind nicht rechtsverbindlich.</li>
            </ul>
            <p class="legal">Mehr Infos: <a href="https://www.microsoft.com/trust-center" target="_blank" rel="noopener noreferrer">Microsoft Trust Center</a> · <a href="https://openai.com/policies" target="_blank" rel="noopener noreferrer">OpenAI Policies</a></p>
          </div>
        </section>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-primary" id="btnMoreInfo" aria-expanded="false" aria-controls="moreInfo">Details</button>
        <button type="button" class="btn-primary" id="btnProceed" disabled>Verstanden & fortfahren</button>
      </div>
    </div>
  </div>

  <!-- ================= PRINT OVERLAY ================= -->
  <div id="printOverlay" role="dialog" aria-modal="true" aria-label="Druckhinweis">
    <div>
      ⚠️ Achte darauf, dass keine firmeninternen oder vertraulichen Daten im Ausdruck enthalten sind.
      <div style="margin-top:16px">
        <button id="btnConfirmPrint" class="btn-primary">Verstanden – Drucken</button>
      </div>
    </div>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    // ------------------ Elements ------------------
    const elChat = document.getElementById('chat');
    const elInput = document.getElementById('input');
    const elSend  = document.getElementById('btnSend');
    const elSuggest = document.getElementById('suggest');
    const elNotice = document.getElementById('notice');

    const btnPrint = document.getElementById('btnPrint');
    const printOverlay = document.getElementById('printOverlay');
    const btnConfirmPrint = document.getElementById('btnConfirmPrint');

    const btnLegal = document.getElementById('btnLegal');
    const dlg = document.getElementById('consentGate');
    const chkData = document.getElementById('chkData');
    const chkNoBinding = document.getElementById('chkNoBinding');
    const btnProceed = document.getElementById('btnProceed');
    const btnMoreInfo = document.getElementById('btnMoreInfo');

    const btnWA = document.getElementById('btnWA');

    // ------------------ Config ------------------
    const WEBHOOK = 'https://hook.us2.make.com/qa8g1cw25ec5lbydckaga3y4vqj9lx1n';
    const MAX_RETRIES = 3;
    const RETRY_MS = 2000;
    const TIMEOUT_MS = 20000;

    const defaultPrompts = [
      'Was ist mobile Ausbildung?',
      'Wer kann mobile Ausbildung machen?',
      'Welche Vorteile bietet mobile Ausbildung?',
      'Wie beginne ich mit mobiler Ausbildung?',
      'Mobile Ausbildung beantragen'
    ];

    let isBusy = false;
    let lastBotAnswer = '';

    // ------------------ Helpers ------------------
    function notify(msg, isError=false){
      elNotice.textContent = msg;
      elNotice.className = 'notice' + (isError ? ' error' : '');
      elNotice.style.display = 'block';
      setTimeout(()=>{ elNotice.style.display='none'; }, 2600);
    }

    function sanitize(str){
      const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
      return String(str).replace(/[&<>"']/g, ch => map[ch]);
    }

    function push(sender, text){
      const row = document.createElement('div');
      row.className = 'row ' + sender;

      // optional avatar (BBVA style minimal)
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = sanitize(text);

      row.appendChild(bubble);
      elChat.appendChild(row);
      elChat.scrollTop = elChat.scrollHeight;
    }

    function renderSuggestions(list){
      elSuggest.innerHTML='';
      (list || defaultPrompts).forEach(p =>{
        const b = document.createElement('button');
        b.className='chip'; b.textContent=p; b.type='button'; b.setAttribute('aria-label',`Vorschlag: ${p}`);
        b.addEventListener('click',()=>{ elInput.value=p; send(); });
        elSuggest.appendChild(b);
      });
    }

    // Guard gegen personenbezogene Daten
    function containsPersonalData(t){
      const patterns = [
        /\b([A-ZÄÖÜ][a-zäöü]{2,}\s+[A-ZÄÖÜ][a-zäöü]{2,})\b/, // Vor- & Nachname
        /\b\d{5}\b/,                                        // PLZ
        /\+?\d[\d\s\/-]{6,}/,                             // Telefonnummern
        /[\w.+-]+@[^\s@]+\.[A-Za-z]{2,}/,                  // Email
        /\b(IBAN|Konto|Kundennummer|Personalnummer)\b/i       // typische Keywords
      ];
      return patterns.some(rx => rx.test(t));
    }

    // ------------------ Network with Retry ------------------
    async function postWithRetry(payload){
      let attempt=0, lastErr;
      while(attempt < MAX_RETRIES){
        try{
          const ctrl = new AbortController();
          const timer = setTimeout(()=>ctrl.abort(), TIMEOUT_MS);
          const res = await fetch(WEBHOOK, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload), signal: ctrl.signal });
          clearTimeout(timer);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const raw = await res.text();
          try { return JSON.parse(raw); } catch { return { answer: raw }; }
        }catch(err){ lastErr = err; attempt++; if(attempt < MAX_RETRIES){ await new Promise(r=>setTimeout(r, RETRY_MS)); } }
      }
      throw lastErr;
    }

    // ------------------ Send Flow ------------------
    async function send(){
      const text = elInput.value.trim();
      if(!text || isBusy) return;

      // Eingabe-Guard
      if(containsPersonalData(text)){
        notify('Bitte keine personenbezogenen oder vertraulichen Daten eingeben.', true);
        return;
      }

      isBusy = true; elSend.disabled = true;
      push('user', text);
      elInput.value = '';

      try{
        const payload = { message: text, last_answer: lastBotAnswer.replace(/<[^>]+>/g,'') };
        const data = await postWithRetry(payload);
        const reply = String(data.answer || '').trim();
        lastBotAnswer = reply;
        push('bot', reply || '…');
        if(Array.isArray(data.suggestions) && data.suggestions.length){ renderSuggestions(data.suggestions); }
      }catch(err){
        push('bot', 'Es gab einen Verbindungsfehler. Bitte versuche es später erneut.');
        notify('Fehler bei der Kommunikation mit dem Server.', true);
      }finally{
        isBusy = false; elSend.disabled = false; elInput.focus();
      }
    }

    // ------------------ Consent Gate ------------------
    function validateGate(){ btnProceed.disabled = !(chkData.checked && chkNoBinding.checked); }
    function openGate(){ dlg.classList.add('show'); elInput.disabled = true; elSend.disabled = true; }
    function closeGate(){ dlg.classList.remove('show'); elInput.disabled = false; elSend.disabled = false; renderSuggestions(); bootstrapIntro(); elInput.focus(); }

    chkData.addEventListener('change', validateGate);
    chkNoBinding.addEventListener('change', validateGate);

    btnProceed.addEventListener('click', ()=>{ closeGate(); notify('Hinweise bestätigt.'); });

    btnMoreInfo.addEventListener('click', ()=>{
      const panel = document.getElementById('moreInfo');
      const isOpen = panel.classList.contains('show');
      panel.classList.toggle('show', !isOpen);
      btnMoreInfo.setAttribute('aria-expanded', String(!isOpen));
      btnMoreInfo.textContent = isOpen ? 'Details' : 'Details ausblenden';
    });

    btnLegal.addEventListener('click', openGate);

    // ------------------ Print Overlay ------------------
    btnPrint.addEventListener('click', (e)=>{ e.preventDefault(); printOverlay.classList.add('show'); });
    btnConfirmPrint.addEventListener('click', ()=>{ printOverlay.classList.remove('show'); window.print(); });

    // ------------------ WhatsApp ------------------
    btnWA.addEventListener('click', ()=>{ window.open('https://wa.me/4916098665006','_blank'); });

    // ------------------ iOS Zoom Fix / Scroll Stability ------------------
    elInput.addEventListener('focus', ()=>{
      document.body.style.height='100dvh';
      document.body.style.overflow='hidden';
      setTimeout(()=>{ elInput.scrollIntoView({behavior:'smooth', block:'center'}); }, 120);
    });
    elInput.addEventListener('blur', ()=>{
      document.body.style.height='auto';
      document.body.style.overflow='auto';
    });

    // ------------------ Init ------------------
    function bootstrapIntro(){
      push('bot','Liebe Auszubildende, schön, dass ihr euch für mobile Ausbildung interessiert. Diese KI gibt euch erste **Informationen** und prüft unverbindlich, ob mobile Ausbildung für euch passend sein könnte.');
      push('bot','Wollen wir loslegen?');
    }

    // Start: Consent muss bestätigt werden
    openGate();
    renderSuggestions();
    // Falls du Intro direkt nach Consent willst, wird es in closeGate() gestartet

    // Events
    elSend.addEventListener('click', send);
    elInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });
  </script>
</body>
</html>
