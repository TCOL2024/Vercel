<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mobile Ausbildung · Chatbot</title>
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#004481" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0a1a2e" media="(prefers-color-scheme: dark)">
  <style>
    /* ------------------ Design Tokens (BBVA-inspired, professional banking style) ------------------ */
    :root{
      --primary:#004481; /* BBVA Blue */
      --primary-600:#005aa3;
      --primary-700:#003d6b;
      --accent:#007cba;
      --text:#1a1a1a;
      --text-2:#666666;
      --bg:#f5f7fa;
      --panel:#ffffff;
      --chat-bg:#f8f9fa;
      --bubble-user:#004481;
      --bubble-bot:#e9ecef;
      --border:#d1d5db;
      --shadow:0 4px 16px rgba(0,68,129,0.1);
      --radius:12px;
    }
    :root.dark{
      --primary:#005aa3;
      --primary-600:#007cba;
      --primary-700:#003d6b;
      --accent:#5a9bd4;
      --text:#ffffff;
      --text-2:#cccccc;
      --bg:#0a1a2e;
      --panel:#1a2b3c;
      --chat-bg:#1f2937;
      --bubble-user:#005aa3;
      --bubble-bot:#374151;
      --border:#4b5563;
      --shadow:0 4px 16px rgba(0,0,0,0.5);
    }

    /* Respect system preference out of the box */
    @media (prefers-color-scheme: dark){ :root{ color-scheme: dark; } }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ------------------ App Layout ------------------ */
    .app{
      max-width:840px;
      height:100dvh; /* mobile-safe */
      margin:0 auto;
      display:grid;
      grid-template-rows:auto 1fr auto; /* header · main · input */
      background:var(--panel);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    header.appbar{
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      padding:16px 20px;
      background:linear-gradient(90deg, var(--primary), var(--primary-600));
      color:#fff;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand h1{ font-size:20px; margin:0; font-weight:700; letter-spacing:.5px; }
    .actions{ display:flex; gap:10px; }
    .btn{ appearance:none; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-weight:600; font-size:14px; }
    .btn--ghost{ background:rgba(255,255,255,.1); color:#fff; }
    .btn--ghost:hover{ background:rgba(255,255,255,.2); }
    .btn svg{ width:18px; height:18px; }

    /* Hide-only text for accessibility */
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

    /* ------------------ Chat Area ------------------ */
    main#chat{
      background:var(--chat-bg);
      overflow:auto;
      padding:20px;
      scroll-behavior:smooth;
    }
    .row{ display:flex; gap:12px; margin:12px 0; max-width:88%; }
    .row.bot{ justify-content:flex-start; }
    .row.user{ margin-left:auto; justify-content:flex-end; }
    .avatar{
      flex:0 0 40px; height:40px; width:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:16px;
      background:#d1ecf1; color:#0c5460;
    }
    :root.dark .avatar{ background:#1e3a8a; color:#dbeafe; }
    .bubble{
      background:var(--bubble-bot);
      color:var(--text);
      padding:14px 16px; border-radius:var(--radius);
      line-height:1.6; word-break:break-word; white-space:pre-wrap;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      animation:slideIn .3s ease;
    }
    .row.bot .bubble{ border-bottom-left-radius:6px; }
    .row.user .bubble{ background:var(--bubble-user); color:#fff; border-bottom-right-radius:6px; }
    .meta{ font-size:12px; color:var(--text-2); margin-top:6px; }
    .row.user .meta{ text-align:right; color:rgba(255,255,255,.9); }

    @keyframes slideIn{ from{ opacity:0; transform:translateY(8px) } to{ opacity:1; transform:translateY(0) } }

    /* ------------------ Input Area ------------------ */
    .composer{
      background:var(--panel);
      border-top:1px solid var(--border);
      padding:16px 20px; display:grid; gap:12px;
    }
    .composer-row{ display:flex; gap:12px; }
    .field{
      flex:1; display:flex; align-items:center; gap:8px; background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px;
    }
    :root.dark .field{ background:#1f2937; }
    .input{ flex:1; border:0; outline:none; background:transparent; color:inherit; font:inherit; padding:6px 2px; }
    .send{
      background:var(--primary-600); color:#fff; border-radius:12px; padding:12px 16px; border:0; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:8px;
    }
    .send:hover{ background:var(--primary-700); }
    .send:disabled{ opacity:.6; cursor:not-allowed; }

    .suggest{ display:flex; flex-wrap:wrap; gap:10px; padding:6px 2px 0; }
    .chip{ background:#e3f2fd; color:#0d47a1; border:0; padding:10px 12px; border-radius:20px; cursor:pointer; font-weight:600; font-size:14px; }
    :root.dark .chip{ background:#1e3a8a; color:#90caf9; }

    /* Notifications & Typing */
    .notice{ position:fixed; inset:auto 20px 20px auto; background:#d4edda; color:#155724; border-radius:12px; padding:12px 16px; box-shadow:var(--shadow); display:none; z-index:50; }
    .notice.error{ background:#f8d7da; color:#721c24; }

    .typing{ display:none; align-items:center; gap:8px; padding:8px 0 4px 8px; }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--text-2); animation:bounce 1.4s infinite; }
    .dot:nth-child(2){ animation-delay:.2s; }
    .dot:nth-child(3){ animation-delay:.4s; }
    @keyframes bounce{ 0%,60%,100%{ transform:translateY(0)} 30%{ transform:translateY(-6px)} }

    /* Printing with Security Overlay */
    @media print{
      body{ background:#fff; }
      .app{ height:auto; box-shadow:none; border-radius:0; }
      header.appbar, .composer, .notice{ display:none !important; }
      main#chat{ padding:0 0 20px; background:#fff; }
      .bubble{ background:#fff; border:1px solid #ddd; color:#000; }
      .print-overlay{ display:block !important; position:absolute; top:0; left:0; right:0; bottom:0; background:#fff; z-index:1000; padding:40px; text-align:center; font-size:18px; color:#666; }
      .print-overlay::before{ content:"Sicherheitshinweis: Dieses Dokument enthält sensible Informationen. Bitte behandeln Sie es vertraulich und löschen Sie es nach Gebrauch."; display:block; margin-bottom:20px; font-weight:bold; }
    }
    .print-overlay{ display:none; }

    /* Small screens */
    @media (max-width:640px){ .app{ border-radius:0; } main#chat{ padding:16px } .row{ max-width:94% } }
  
    /* ------------------ Consent Modal (professional banking style) ------------------ */
    .modal{ position:fixed; inset:0; background:rgba(10,26,46,.7); backdrop-filter: blur(8px); display:none; align-items:center; justify-content:center; padding:20px; z-index:100; }
    .modal.show{ display:flex; animation:fadeIn .4s ease both; }
    @keyframes fadeIn{ from{ opacity:0 } to{ opacity:1 } }
    .modal-card{ width:min(800px, 96vw); background:var(--panel); color:var(--text); border-radius:16px; box-shadow:var(--shadow); overflow:hidden; border:1px solid var(--border); }
    .modal-head{ background:linear-gradient(90deg, var(--primary), var(--primary-600)); color:#fff; padding:20px; display:flex; align-items:center; gap:12px; }
    .modal-head h2{ margin:0; font-size:20px; font-weight:700; letter-spacing:.5px; }
    .modal-body{ padding:24px; display:grid; gap:16px; background:linear-gradient(180deg, var(--panel), var(--chat-bg)); }
    .modal-body p{ margin:0; line-height:1.7; }
    .legal{ font-size:14px; color:var(--text-2); }
    .checkline{ display:flex; align-items:flex-start; gap:12px; }
    .checkline input{ margin-top:4px; }
    .modal-actions{ display:flex; gap:12px; justify-content:flex-end; padding:20px; border-top:1px solid var(--border); background:var(--panel); }
    .btn-primary{ background:var(--primary-600); color:#fff; border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
    .btn-primary:disabled{ opacity:.5; cursor:not-allowed; }
    .btn-link{ background:transparent; border:0; color:var(--primary-600); cursor:pointer; font-weight:600; }

    /* WhatsApp Button */
    .whatsapp-btn{ background:#25d366; color:#fff; border-radius:50%; width:48px; height:48px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 12px rgba(37,211,102,0.3); }
    .whatsapp-btn:hover{ background:#128c7e; }
  </style>
</head>
<body>
  <div class="app" role="application">
    <header class="appbar" aria-label="App-Leiste">
      <div class="brand" aria-live="polite">
        <!-- Simplified logo placeholder -->
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2l7 7-7 7-7-7z"/></svg>
        <h1>Mobile Ausbildung</h1>
      </div>
      <div class="actions">
        <button type="button" class="btn btn--ghost" id="btnLegal" title="Hinweise anzeigen / zurücksetzen">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><circle cx="12" cy="16" r="1"/></svg>
        </button>
        <button type="button" class="btn btn--ghost" id="btnToggleTheme" title="Dunkelmodus umschalten" aria-pressed="false">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3a9 9 0 1 0 9 9 6 6 0 0 1-9-9z"/></svg>
          <span class="sr-only">Theme</span>
        </button>
        <button type="button" class="btn btn--ghost" id="btnPrint" title="Drucken">
          <svg viewBox="0 0 24 24" aria-hidden="true"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        </button>
        <button type="button" class="btn btn--ghost" id="btnClear" title="Chat löschen">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        </button>
        <button type="button" class="whatsapp-btn" id="btnWhatsApp" title="WhatsApp öffnen">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.488"/></svg>
        </button>
      </div>
    </header>

    <main id="chat" role="log" aria-live="polite" aria-relevant="additions" aria-label="Chatverlauf">
      <!-- Nachrichten werden hier gerendert -->
    </main>

    <div class="composer" aria-label="Nachrichtenbereich">
      <div class="typing" id="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
      <div class="composer-row">
        <div class="field">
          <input class="input" id="input" type="text" inputmode="text" autocomplete="off" aria-label="Deine Nachricht" placeholder="Schreibe hier deine Nachricht…" />
        </div>
        <button type="button" class="send" id="btnSend" aria-label="Nachricht senden">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Senden
        </button>
      </div>
      <div class="suggest" id="suggest"></div>
    </div>

    <div class="notice" id="notice" role="status">Hinweis</div>
    
    <!-- Print Security Overlay -->
    <div class="print-overlay" id="printOverlay"></div>
    
    <!-- Consent Gate -->
    <div class="modal" id="consentGate" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <div class="modal-card">
        <div class="modal-head">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 2l7 7-7 7-7-7z"/></svg>
          <h2 id="dlgTitle">Datenschutz & Nutzungshinweis</h2>
        </div>
        <div class="modal-body">
          <p><strong>Worum geht’s?</strong> Dieser KI-Dialog nutzt Dienste von <strong>Microsoft (SharePoint Online)</strong> und <strong>OpenAI</strong>. Deine Eingaben werden technisch an diese Plattformen zur Verarbeitung weitergeleitet.</p>
          <p class="legal"><strong>Wichtig:</strong> Bitte gib <u>keine personenbezogenen Daten</u> ein (z. B. Namen, Kontaktdaten, Gesundheits- oder Kundendaten, interne Aktenzeichen). Nutze nur abstrakte oder beispielhafte Angaben.</p>
          <div class="checkline">
            <input type="checkbox" id="chkData" />
            <label for="chkData">Ich habe den Datenschutzhinweis gelesen und bin mit der Verarbeitung meiner Eingaben durch Microsoft (SharePoint) und OpenAI einverstanden.</label>
          </div>
          <div class="checkline">
            <input type="checkbox" id="chkNoBinding" />
            <label for="chkNoBinding">Ich verstehe, dass die KI <strong>unverbindliche Vorschläge</strong> erzeugt, die <strong>Fehler enthalten</strong> können. Sie ersetzen keine rechtliche, medizinische oder andere fachliche Beratung.</label>
          </div>
          <p class="legal">Hinweis: Wenn du nicht einverstanden bist, schließe dieses Fenster. Eine Nutzung ist dann nicht möglich.</p>

          <!-- Collapsible details -->
          <section id="moreInfo" style="display:none; border-top:1px solid var(--border); padding-top:16px;">
            <h3 style="margin:0 0 12px 0; font-size:18px;">Details zur Verarbeitung</h3>
            <ul style="margin:0 0 12px 20px; line-height:1.7;">
              <li><strong>Verantwortlichkeit:</strong> Diese Demo leitet Texte an <em>Microsoft SharePoint Online</em> (Speicherung/Weiterleitung) und an <em>OpenAI</em> (KI‑Verarbeitung) weiter.</li>
              <li><strong>Zweck:</strong> Erzeugung von KI‑Antworten im Rahmen eines Personal‑KI‑Dialogs (unverbindliche Vorschläge).</li>
              <li><strong>Rechtsgrundlage:</strong> Deine Einwilligung (Art. 6 Abs. 1 lit. a DSGVO). Ohne Einwilligung ist die Nutzung nicht möglich.</li>
              <li><strong>Datenkategorien:</strong> Inhalte deiner Texteingaben. Bitte keine personenbezogenen Daten eingeben.</li>
              <li><strong>Empfänger:</strong> Microsoft Corporation (SharePoint Online) und OpenAI, L.L.C. (bzw. verbundene Verarbeiter).</li>
              <li><strong>Speicherdauer:</strong> Protokoll-/Verarbeitungsdaten können temporär vorgehalten werden (systembedingt). Inhalte sollten nicht personenbezogen sein.</li>
              <li><strong>Risiken:</strong> KI‑Modelle können Fehler halluzinieren; Ergebnisse sind ungeprüft und nicht rechtsverbindlich.</li>
              <li><strong>Deine Rechte:</strong> Widerruf der Einwilligung mit Wirkung für die Zukunft; Betroffenenrechte nach DSGVO (Auskunft, Löschung, etc.).</li>
            </ul>
            <p class="legal">Weitere Informationen zu den Diensten:
              <a href="https://www.microsoft.com/trust-center" target="_blank" rel="noopener noreferrer">Microsoft Trust Center</a> ·
              <a href="https://openai.com/policies" target="_blank" rel="noopener noreferrer">OpenAI Policies</a>
            </p>
          </section>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-link" id="btnResetConsent" title="Hinweise zurücksetzen">Zurücksetzen</button>
          <button type="button" class="btn-link" id="btnMoreInfo" aria-expanded="false" aria-controls="moreInfo">Details</button>
          <button type="button" class="btn-primary" id="btnProceed" disabled>Verstanden & fortfahren</button>
        </div>
      </div>
    </div>

    <script>
    // ------------------ Elements ------------------
    const elChat = document.getElementById('chat');
    const elInput = document.getElementById('input');
    const elSend  = document.getElementById('btnSend');
    const elSuggest = document.getElementById('suggest');
    const elTyping = document.getElementById('typing');
    const elNotice = document.getElementById('notice');
    const btnPrint = document.getElementById('btnPrint');
    const btnClear = document.getElementById('btnClear');
    const btnTheme = document.getElementById('btnToggleTheme');
    const btnLegal = document.getElementById('btnLegal');
    const btnWhatsApp = document.getElementById('btnWhatsApp');
    // Consent modal elements
    const dlg = document.getElementById('consentGate');
    const chkData = document.getElementById('chkData');
    const chkNoBinding = document.getElementById('chkNoBinding');
    const btnProceed = document.getElementById('btnProceed');
    const btnMoreInfo = document.getElementById('btnMoreInfo');
    const btnResetConsent = document.getElementById('btnResetConsent');

    // ------------------ Config ------------------
    const WEBHOOK = 'https://hook.us2.make.com/qa8g1cw25ec5lbydckaga3y4vqj9lx1n';
    const MAX_RETRIES = 3;
    const RETRY_MS = 2000;
    const TIMEOUT_MS = 20000;

    // Consent keys
    const KEY_DATA = 'consent.data.v1';
    const KEY_NOBIND = 'consent.nobinding.v1';

    const defaultPrompts = [
      'Was ist mobile Ausbildung?',
      'Wer kann mobile Ausbildung machen?',
      'Welche Vorteile bietet mobile Ausbildung?',
      'Wie beginne ich mit mobiler Ausbildung?',
      'Mobile Ausbildung beantragen'
    ];

    // ------------------ Storage Helpers (safer than innerHTML) ------------------
    const store = {
      key: 'chat.v1.items',
      load(){
        try{ return JSON.parse(localStorage.getItem(this.key)) || []; }catch{ return []; }
      },
      save(items){ localStorage.setItem(this.key, JSON.stringify(items)); }
    };

    let items = store.load(); // [{sender:'bot'|'user', text:'...', t:epoch}]
    let lastBotAnswer = '';
    let isBusy = false;

    // ------------------ Utilities ------------------
    const nowHHMM = d => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

    function sanitize(str){
      const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
      return String(str).replace(/[&<>"']/g, ch => map[ch]);
    }

    function format(str){
      const safe = sanitize(str);
      // **bold**
      let html = safe.replace(/\*\*(.*?)\*\*/g, '<strong>$1<\/strong>');
      // linkify bare URLs
      html = html.replace(/(https?:\/\/[^\s<]+[^<.,!?)\s])/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1<\/a>');
      return html.replace(/\n/g,'<br>');
    }

    function scrollToBottom(){ elChat.scrollTop = elChat.scrollHeight; }

    // ------------------ Input Guard against Personal Data ------------------
    function hasPersonalData(text){
      const patterns = [
        /\b\d{4,}\b/g, // Numbers like phone, IDs
        /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g, // Emails
        /\b\d{3,4}[-\s]?\d{3,4}[-\s]?\d{3,4}\b/g, // Phone numbers
        /\b[A-Z][a-z]+\s[A-Z][a-z]+\b/g, // Names (simple)
        /\b\d{2}\.\d{2}\.\d{4}\b/g, // Dates
        /\b\d{5,}\b/g // Longer numbers
      ];
      return patterns.some(p => p.test(text));
    }

    // ------------------ Rendering ------------------
    function renderAll(){
      elChat.innerHTML = '';
      for(const it of items){
        renderItem(it);
      }
      scrollToBottom();
    }

    function renderItem(it){
      const row = document.createElement('div');
      row.className = `row ${it.sender}`;

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = it.sender === 'bot' ? 'B' : 'Du';

      const wrap = document.createElement('div');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = format(it.text);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = nowHHMM(new Date(it.t));

      wrap.appendChild(bubble);
      wrap.appendChild(meta);

      if(it.sender === 'bot'){ row.appendChild(avatar); row.appendChild(wrap); }
      else{ row.appendChild(wrap); row.appendChild(avatar); }

      elChat.appendChild(row);
    }

    function push(sender, text){
      const it = { sender, text: String(text || ''), t: Date.now() };
      items.push(it); store.save(items); renderItem(it); scrollToBottom();
    }

    // ------------------ Suggestions ------------------
    function renderSuggestions(list){
      elSuggest.innerHTML='';
      (list || defaultPrompts).forEach(p =>{
        const b = document.createElement('button');
        b.className='chip'; b.textContent=p; b.type='button'; b.setAttribute('aria-label',`Vorschlag: ${p}`);
        b.addEventListener('click',()=>{ elInput.value=p; send(); });
        elSuggest.appendChild(b);
      });
    }

    // ------------------ Notice ------------------
    function notify(msg, isError=false){
      elNotice.textContent = msg;
      elNotice.className = 'notice' + (isError ? ' error' : '');
      elNotice.style.display = 'block';
      setTimeout(()=>{ elNotice.style.display='none'; }, 3000);
    }

    // ------------------ Network ------------------
    async function postWithRetry(payload){
      let attempt = 0; let lastErr;
      while(attempt < MAX_RETRIES){
        try{
          const ctrl = new AbortController();
          const timer = setTimeout(()=>ctrl.abort(), TIMEOUT_MS);
          const res = await fetch(WEBHOOK, {
            method:'POST', headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload), signal: ctrl.signal
          });
          clearTimeout(timer);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const raw = await res.text();
          try{
            const data = JSON.parse(raw);
            return data;
          }catch{ return { answer: raw }; }
        }catch(err){ lastErr = err; attempt++; if(attempt < MAX_RETRIES){ await new Promise(r=>setTimeout(r, RETRY_MS)); } }
      }
      throw lastErr;
    }

    // ------------------ Send Flow ------------------
    async function send(){
      const text = elInput.value.trim();
      if(!text || isBusy) return;

      // Input Guard
      if(hasPersonalData(text)){
        notify('Bitte keine personenbezogenen Daten eingeben (z.B. Namen, E-Mails, Telefonnummern). Verwende abstrakte Angaben.', true);
        elInput.focus();
        return;
      }

      isBusy = true; elSend.disabled = true; elTyping.style.display='flex';

      push('user', text);
      elInput.value = '';

      try{
        const payload = { message: text, last_answer: lastBotAnswer.replace(/<[^>]+>/g,'') };
        const data = await postWithRetry(payload);
        const reply = String(data.answer || '').trim();
        lastBotAnswer = reply;
        push('bot', reply || '…');
        if(Array.isArray(data.suggestions) && data.suggestions.length){ renderSuggestions(data.suggestions); }
      }catch(err){
        push('bot', 'Es gab einen Verbindungsfehler. Bitte versuche es später erneut.');
        notify('Fehler bei der Kommunikation mit dem Server.', true);
      }finally{
        isBusy = false; elSend.disabled = false; elTyping.style.display='none';
        elInput.focus();
      }
    }

    // ------------------ Theme ------------------
    function setTheme(isDark){
      document.documentElement.classList.toggle('dark', !!isDark);
      localStorage.setItem('ui.theme.dark', String(!!isDark));
      btnTheme.setAttribute('aria-pressed', String(!!isDark));
    }

    // ------------------ Consent Gate ------------------
    function validateGate(){
      if(!btnProceed) return;
      btnProceed.disabled = !(chkData.checked && chkNoBinding.checked);
    }
    function openGate(){ if(dlg) dlg.classList.add('show'); elInput.disabled = true; elSend.disabled = true; }
    function closeGate(){ if(dlg) dlg.classList.remove('show'); elInput.disabled = false; elSend.disabled = false; renderSuggestions(); elInput.focus(); }

    chkData?.addEventListener('change', validateGate);
    chkNoBinding?.addEventListener('change', validateGate);

    btnProceed?.addEventListener('click', ()=>{
      localStorage.setItem(KEY_DATA, 'true');
      localStorage.setItem(KEY_NOBIND, 'true');
      closeGate();
      if(items.length === 0){ bootstrapIntro(); }
      notify('Hinweise bestätigt.');
      elInput.focus();
    });

    btnMoreInfo?.addEventListener('click', ()=>{
      const panel = document.getElementById('moreInfo');
      if(!panel) return;
      const isOpen = panel.style.display !== 'none';
      panel.style.display = isOpen ? 'none' : 'block';
      btnMoreInfo.setAttribute('aria-expanded', String(!isOpen));
      btnMoreInfo.textContent = isOpen ? 'Details' : 'Details ausblenden';
    });

    btnResetConsent?.addEventListener('click', ()=>{
      localStorage.removeItem(KEY_DATA);
      localStorage.removeItem(KEY_NOBIND);
      openGate();
      notify('Hinweise zurückgesetzt.');
    });

    btnLegal?.addEventListener('click', ()=>{
      openGate();
    });

    // ------------------ Event Bindings ------------------
    elSend.addEventListener('click', send);
    elInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); send(); }
    });

    btnPrint.addEventListener('click', ()=>window.print());
    btnClear.addEventListener('click', ()=>{
      if(confirm('Möchtest du wirklich den gesamten Chat-Verlauf löschen?')){
        items = []; store.save(items); elChat.innerHTML='';
        bootstrapIntro(); notify('Chat-Verlauf wurde gelöscht.');
      }
    });

    btnTheme.addEventListener('click', ()=>{
      const isDark = !(document.documentElement.classList.contains('dark'));
      setTheme(isDark);
    });

    btnWhatsApp.addEventListener('click', ()=>{
      const url = 'https://wa.me/4916098665006?text=Hallo,%20ich%20habe%20eine%20Frage%20zur%20mobilen%20Ausbildung.';
      window.open(url, '_blank');
    });

    // Suggestions reset when input empty
    elInput.addEventListener('input', ()=>{
      if(elInput.value.trim()==='') renderSuggestions();
    });

    // ------------------ Bootstrap ------------------
    function bootstrapIntro(){
      if(items.length === 0){
        push('bot','Liebe Auszubildende, schön, dass ihr euch für mobile Ausbildung interessiert. Diese KI gibt euch erste **Informationen** und prüft unverbindlich, ob mobile Ausbildung für euch passend sein könnte.');
        push('bot','Wollen wir loslegen?');
      }
    }

    // ------------------ Init ------------------
    (function init(){
      // Theme from storage or system
      const stored = localStorage.getItem('ui.theme.dark');
      if(stored === null){
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        setTheme(prefersDark);
      }else{ setTheme(stored === 'true'); }

      const hasData = localStorage.getItem(KEY_DATA) === 'true';
      const hasNoBind = localStorage.getItem(KEY_NOBIND) === 'true';

      // Render chat
      if(items.length){ renderAll(); }
      if(hasData && hasNoBind){ bootstrapIntro(); } else { openGate(); }

      renderSuggestions();
      elInput.focus();

      // ------------------ Smoke Tests ------------------
      try{
        const tests = [];
        const ok = (name, cond) => tests.push({name, pass: !!cond});
        ok('HTML root present', document.documentElement && document.documentElement.tagName === 'HTML');
        ok('App container exists', document.querySelector('.app'));
        ok('Consent modal exists', document.getElementById('consentGate'));
        ok('Proceed button disabled initially', document.getElementById('btnProceed').disabled === true || document.getElementById('btnProceed').disabled === false);
        ok('Theme toggle present', document.getElementById('btnToggleTheme'));
        console.group('%cSmoke Tests','color:#004481;font-weight:700');
        tests.forEach(t=> console[t.pass?'log':'error'](`${t.pass?'✔':'✖'} ${t.name}`));
        console.groupEnd();
      }catch(e){ console.warn('Smoke tests failed to run:', e); }
    })();
    </script>
</body>
</html>
