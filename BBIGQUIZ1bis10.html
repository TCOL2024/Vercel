<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz (§§ 1–10) – IHK-Niveau</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- Marked for Markdown rendering -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root { --brand:#0ea5e9; }
    .card { border-radius: 1.15rem; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    .q-badge { background: rgba(14,165,233, .12); color: var(--brand); }
    .pill { border: 1px solid rgba(0,0,0,.07); }
    .progress { height: 10px; border-radius: 999px; background: linear-gradient(90deg, var(--brand), #22c55e); width: 0%; transition: width .25s ease; }
    .prose pre, .prose code { white-space: pre-wrap; word-break: break-word; }
    textarea { -webkit-text-size-adjust: 100%; }
    /* iPhone ergonomics: größere Touch-Ziele */
    .btn-lg { padding: .9rem 1.1rem; border-radius: 0.9rem; }
    /* Safe-area padding für iPhones mit Notch */
    .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom), 12px); }
    .sticky-actions { position: sticky; bottom: 0; z-index: 40; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-white to-sky-50 text-slate-800 antialiased">

  <!-- Hinweis / Disclaimer -->
  <div id="notice" class="sticky top-0 z-50 bg-amber-50 border-b border-amber-200">
    <div class="max-w-3xl mx-auto px-4 py-3 flex items-start gap-3">
      <div class="mt-0.5">
        <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-600"></i>
      </div>
      <div class="text-sm leading-snug">
        <p class="font-medium text-amber-900">Hinweis (Beta):</p>
        <p class="text-amber-800">
          Die KI-Prüfung befindet sich im Test. Antworten müssen fachlich geprüft werden und ersetzen keine Rechtsberatung.
        </p>
        <label class="mt-2 flex items-center gap-2 text-amber-900">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-amber-600">
          <span>Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <button id="ackBtn" class="ml-auto pill px-3 py-2 rounded-lg text-sm hover:bg-amber-100">Weiter</button>
    </div>
  </div>

  <!-- Header -->
  <header class="max-w-3xl mx-auto px-4 pt-4">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-100 grid place-items-center">
        <i data-lucide="graduation-cap" class="w-6 h-6 stroke-[1.5] text-sky-700"></i>
      </div>
      <div class="flex-1">
        <h1 class="text-xl font-semibold tracking-tight">BBiG-Quiz (§§ 1–10) – IHK-Niveau</h1>
        <p class="text-sm text-slate-500">Beantworte 10 Fragen. Du kannst jede Antwort einzeln per KI prüfen lassen oder am Ende alles sammeln.</p>
      </div>
    </div>
  </header>

  <!-- Progress -->
  <section class="max-w-3xl mx-auto px-4 mt-4">
    <div class="card bg-white p-4">
      <div class="flex items-center gap-3">
        <i data-lucide="target" class="w-5 h-5 text-sky-700"></i>
        <div class="flex-1">
          <div class="flex justify-between text-xs text-slate-600 mb-1">
            <span id="progressText">0 / 10 beantwortet</span>
            <span id="timer">00:00</span>
          </div>
          <div class="w-full bg-slate-100 rounded-full overflow-hidden">
            <div id="progressBar" class="progress"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="max-w-3xl mx-auto px-4 py-4">
    <form id="form" class="grid gap-5">
      <!-- Fragen werden per JS eingefügt -->
    </form>

    <!-- KI-Gesamtfeedback -->
    <section id="resultWrap" class="mt-5 hidden">
      <div class="card bg-white p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkle" class="w-5 h-5 text-emerald-700"></i>
          <h2 class="text-base font-semibold">KI-Feedback (Gesamt)</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky Action-Bar (iPhone freundlich) -->
  <div class="sticky-actions bg-white/95 border-t border-slate-200 backdrop-blur safe-bottom">
    <div class="max-w-3xl mx-auto px-4 py-2 flex gap-2">
      <button id="submitBtn" class="flex-1 btn-lg bg-sky-600 text-white font-medium hover:bg-sky-700 active:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-sky-400 flex items-center justify-center gap-2 disabled:opacity-60">
        <i data-lucide="send" class="w-5 h-5"></i>
        Alles prüfen (KI)
      </button>
      <button id="resetBtn" class="btn-lg px-4 border border-slate-200 text-slate-700 hover:bg-slate-50 rounded-lg">
        Zurücksetzen
      </button>
    </div>
  </div>

  <script>
    // === Konfiguration ===
    const webhook = "https://hook.us2.make.com/pkdx4lpoadncdgd9fdwvd2jlgnwfsgx6";
    const proxy   = "https://api.allorigins.win/raw?url=";

    // UI Refs
    const form        = document.getElementById("form");
    const submitBtn   = document.getElementById("submitBtn");
    const resetBtn    = document.getElementById("resetBtn");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const resultWrap  = document.getElementById("resultWrap");
    const aiResult    = document.getElementById("aiResult");
    const timerEl     = document.getElementById("timer");
    const ack         = document.getElementById("ack");
    const ackBtn      = document.getElementById("ackBtn");
    const notice      = document.getElementById("notice");

    // Markdown
    document.addEventListener("DOMContentLoaded", () => {
      if (window.marked) marked.setOptions({ breaks: true, gfm: true });
      if (window.lucide) lucide.createIcons();
    });

    // Daten
    const QUESTIONS = [
      { ref: "§1 BBiG – Zweck", q: "Erläutere den Zweck des BBiG und grenze ihn kurz von landesrechtlich geregelten Berufen ab. Warum ist diese Abgrenzung für Betriebe relevant?" },
      { ref: "§2 BBiG – Begriffsbestimmungen", q: "Definiere ‚Berufsausbildungsvorbereitung‘, ‚Berufsausbildung‘ und ‚Fortbildung‘. Nenne je ein prägnantes Praxisbeispiel." },
      { ref: "§3 BBiG – Anwendungsbereich", q: "Wann gilt das BBiG nicht? Führe zwei typische Ausnahmen an und erläutere kurz, was stattdessen greift." },
      { ref: "§4 BBiG – Anerkennung von Ausbildungsberufen", q: "Welche Kriterien müssen Ausbildungsberufe erfüllen, um anerkannt zu werden, und welche Bedeutung hat die Ausbildungsordnung?" },
      { ref: "§5 BBiG – Ausbildungsordnung", q: "Welche Mindestinhalte muss eine Ausbildungsordnung enthalten? Nenne mindestens vier Kernbestandteile und ordne sie in eine sinnvolle Reihenfolge." },
      { ref: "§6 BBiG – Fortbildungsordnungen", q: "Skizziere Aufbau und Ziel einer Fortbildungsordnung. Worin unterscheidet sich die Zielrichtung gegenüber der Ausbildungsordnung?" },
      { ref: "§7 BBiG – Eignung von Ausbildungsstätten", q: "Welche Anforderungen stellt das BBiG an die Eignung der Ausbildungsstätte? Nenne Risiken bei Verstößen für Betrieb und Auszubildende." },
      { ref: "§8 BBiG – Abkürzung/Verlängerung", q: "Unter welchen Voraussetzungen ist eine Verkürzung bzw. Verlängerung der Ausbildungszeit möglich? Skizziere ein Entscheidungsverfahren für den Betrieb." },
      { ref: "§9 BBiG – Vertragsniederschrift", q: "Welche Pflichtangaben gehören in den Berufsausbildungsvertrag? Was passiert bei fehlenden bzw. fehlerhaften Angaben?" },
      { ref: "§10 BBiG – Teilzeitberufsausbildung", q: "Wie wird eine Teilzeitberufsausbildung rechtssicher vereinbart und organisiert? Nenne typische Anwendungsfälle und Grenzen." }
    ];

    // Timer
    let startTs = Date.now();
    setInterval(() => {
      const s = Math.floor((Date.now() - startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    }, 1000);

    // Autosize Textareas (leichtgewichtig, iPhone-tauglich)
    function autosize(el){
      el.style.height = "auto";
      el.style.height = (el.scrollHeight + 4) + "px";
    }

    // Render
    function renderQuestions() {
      form.innerHTML = "";
      QUESTIONS.forEach((item, idx) => {
        const id = `q_${idx}`;
        const feedbackId = `fb_${idx}`;
        const card = document.createElement("section");
        card.className = "card bg-white p-4";

        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <span class="q-badge px-3 py-1 rounded-full text-[11px] font-medium">${item.ref}</span>
            <span class="text-slate-400 text-[11px]">Frage ${idx+1} / ${QUESTIONS.length}</span>
          </div>
          <h3 class="text-[15px] font-semibold mb-2">${item.q}</h3>
          <div class="space-y-2">
            <textarea id="${id}" name="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]" placeholder="Deine Antwort …"></textarea>
            <div class="flex flex-wrap gap-2">
              <button type="button" data-fill="${id}" class="px-3 py-2 text-[13px] pill rounded-lg hover:bg-slate-50">Beispiel-Gliederung</button>
              <button type="button" data-ask="${idx}" class="px-3 py-2 text-[13px] rounded-lg bg-sky-600 text-white hover:bg-sky-700 flex items-center gap-2 disabled:opacity-60">
                <i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check zu dieser Antwort
              </button>
            </div>
            <div id="${feedbackId}" class="prose prose-slate text-sm max-w-none hidden"></div>
          </div>
        `;
        form.appendChild(card);
      });

      // Beispiel-Gliederung einsetzen
      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const tid = e.currentTarget.getAttribute("data-fill");
          const ta = document.getElementById(tid);
          if (!ta) return;
          ta.value = [
            "### Kernaussage",
            "- …",
            "",
            "### Rechtsgrundlagen / Begriffe",
            "- …",
            "",
            "### Praxisbeispiel",
            "- …",
            "",
            "### Fazit",
            "- …"
          ].join("\n");
          autosize(ta);
          updateProgress();
        });
      });

      // Progress + Autosize + Ctrl/Cmd+Enter
      form.querySelectorAll("textarea").forEach(ta=>{
        autosize(ta);
        ta.addEventListener("input", ()=>{ autosize(ta); updateProgress(); });
        ta.addEventListener("keydown", (ev)=>{
          if ((ev.ctrlKey || ev.metaKey) && ev.key === "Enter") {
            ev.preventDefault();
            submitBtn.click();
          }
        });
      });

      // Einzel-KI-Check
      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!accepted) { alert("Bitte zuerst den Hinweis bestätigen."); return; }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });

      if (window.lucide) lucide.createIcons();
    }

    function updateProgress() {
      const tas = [...form.querySelectorAll("textarea")];
      const filled = tas.filter(t=>t.value.trim().length>0).length;
      const pct = Math.round((filled / QUESTIONS.length) * 100);
      progressBar.style.width = pct + "%";
      progressTxt.textContent = `${filled} / ${QUESTIONS.length} beantwortet`;
    }

    function collectAnswers() {
      return QUESTIONS.map((q, i) => {
        const v = (document.getElementById(`q_${i}`)?.value || "").trim();
        return { nr: i+1, ref: q.ref, question: q.q, answer: v };
      });
    }

    // Prompt Builder
    function buildPromptAll(answers) {
      return `
Du bist eine neutrale IHK-Prüfer:in für Berufsbildungsrecht (BBiG, §§1–10).
Bewerte die Antworten fachlich präzise, kompakt, strukturiert.

Vorgehen:
1) Pro Frage: **Kurzfeedback** (Stärken/Lücken), **Musterlösung** (stichpunktartig mit §-Bezügen), **Praxishinweis** (1 Satz).
2) Abschluss: Gesamtresümee mit 0–100 Punkteschätzung (nicht amtlich).

Referenz: BBiG §§1–10 (aktuelle Fassung).

Eingaben (Fragen + Antworten):
${answers.map(a =>
`[Frage ${a.nr} – ${a.ref}]
Frage: ${a.question}
Antwort:
${a.answer || "(leer)"}`
).join("\n\n")}
      `.trim();
    }

    function buildPromptSingle(idx, item, answer) {
      return `
Du bist eine neutrale IHK-Prüfer:in für Berufsbildungsrecht (BBiG, §§1–10).
Bewerte NUR diese EINE Antwort kurz & präzise.

Ausgabe:
- Kurzfeedback (Stärken/Lücken)
- Knappe Musterlösung stichpunktartig, mit §-Bezügen
- Praxishinweis (1 Satz)

[Frage ${idx+1} – ${item.ref}]
Frage: ${item.q}
Antwort:
${answer || "(leer)"}
`.trim();
    }

    // Webhook Call via CORS-Proxy
    async function callAI(prompt) {
      const url = proxy + encodeURIComponent(webhook);
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt })
      });
      const text = await res.text();
      try {
        const j = JSON.parse(text);
        return j.answer || j.content || j.result || text;
      } catch {
        return text;
      }
    }

    // Einzel-KI-Check
    async function askPerAnswer(idx, btnEl){
      const ta = document.getElementById(`q_${idx}`);
      const fb = document.getElementById(`fb_${idx}`);
      const item = QUESTIONS[idx];
      const prompt = buildPromptSingle(idx, item, ta.value.trim());

      // Loading-Zustand
      btnEl.disabled = true;
      const oldHtml = btnEl.innerHTML;
      btnEl.innerHTML = `<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> Prüfen …`;
      fb.classList.remove("hidden");
      fb.innerHTML = `<div class="text-slate-500 text-sm">KI prüft diese Antwort …</div>`;

      const aiText = await callAI(prompt);
      fb.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));

      btnEl.disabled = false;
      btnEl.innerHTML = oldHtml;
      if (window.lucide) lucide.createIcons();
    }

    // Gesamtabgabe
    submitBtn.addEventListener("click", async ()=>{
      if (!accepted) { alert("Bitte zuerst den Hinweis bestätigen."); return; }
      const answers = collectAnswers();
      const prompt = buildPromptAll(answers);

      submitBtn.disabled = true;
      const old = submitBtn.innerHTML;
      submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> Wird geprüft …`;

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = `<div class="text-slate-500 text-sm">Bitte warten … die KI erstellt Gesamt-Feedback.</div>`;

      const aiText = await callAI(prompt);
      aiResult.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));

      submitBtn.disabled = false;
      submitBtn.innerHTML = old;
      if (window.lucide) lucide.createIcons();
      // sanft scrollen
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    });

    // Reset
    resetBtn.addEventListener("click", ()=>{
      if (!confirm("Alle Eingaben wirklich löschen?")) return;
      startTs = Date.now();
      renderQuestions();
      updateProgress();
      resultWrap.classList.add("hidden");
      aiResult.innerHTML = "";
      window.scrollTo({top:0, behavior:"smooth"});
    });

    // Fortschritt initial
    function initProgressListeners(){
      form.querySelectorAll("textarea").forEach(ta=>{
        ta.addEventListener("input", updateProgress);
      });
      updateProgress();
    }

    // Hinweis bestätigen (blockiert Interaktion bis Zustimmung)
    let accepted = false;
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked) {
        alert("Bitte die Checkbox bestätigen, dass du den Hinweis gelesen hast.");
        return;
      }
      accepted = true;
      notice.style.display = "none";
    });

    // Init
    renderQuestions();
    initProgressListeners();
  </script>
</body>
</html>
