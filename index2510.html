<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Linda – Deine persönliche Assistentin (v27.6-pro + Quellen)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root{
    --bg:#f7f8fb;--panel:#ffffff;--line:#e7ebf0;--text:#0f172a;--muted:#5b6678;
    --brand:#0b5bd3;--brand-2:#2b6ff0;--shadow:0 8px 24px rgba(15,23,42,.06),0 1px 2px rgba(15,23,42,.04)
  }
  body.dark{--bg:#0b0e14;--panel:#0f1420;--line:#1d2535;--text:#e7eaf0;--muted:#a4b0c3;--brand:#6aa4ff;--brand-2:#88b2ff}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--brand-2)}
  /* Header */
  .top{position:sticky;top:0;z-index:30;background:var(--panel);border-bottom:1px solid var(--line);padding:.9rem 1rem;display:flex;align-items:center;gap:.75rem}
  .brand{font-weight:600;letter-spacing:.2px}
  .grow{flex:1}
  .badge{display:inline-flex;align-items:center;gap:.35rem;background:rgba(11,91,211,.08);color:var(--brand);border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem}
  .icon-btn{appearance:none;border:0;background:transparent;cursor:pointer;padding:.35rem;border-radius:.6rem}
  .icon-btn:hover{background:rgba(11,91,211,.08)}
  .sliders{width:22px;height:22px}
  /* Layout grid */
  .container{max-width:1200px;margin:0 auto;padding:1rem;display:grid;grid-template-columns:260px 1fr;gap:1rem}
  /* Sidebar (avatar + sessions) */
  .sidebar{display:flex;flex-direction:column;gap:1rem}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
  .avatar{padding:.9rem;display:flex;flex-direction:column;align-items:center}
  .avatar img{width:100%;border-radius:10px;display:block}
  .avatar .name{margin-top:.55rem;font-weight:600;text-align:center}
  .sessions{display:flex;flex-direction:column;max-height:50vh}
  .sessions .head{padding:.8rem .9rem;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .sessions .list{overflow:auto}
  .sess{display:flex;align-items:center;justify-content:space-between;gap:.5rem;padding:.65rem .9rem;border-top:1px solid var(--line);cursor:pointer}
  .sess:first-child{border-top:0}
  .sess .ttl{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px}
  .sess.active{background:rgba(11,91,211,.06)}
  .sess .rowbtns{display:flex;gap:.35rem}
  .sm-btn{appearance:none;border:1px solid var(--line);background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--brand);border-radius:8px;padding:.25rem .45rem;cursor:pointer;font-size:.85rem}
  .sm-btn:hover{background:rgba(11,91,211,.08)}
  /* Chat column */
  .chat{display:flex;flex-direction:column;min-height:calc(100vh - 120px)}
  .log{flex:1;overflow:auto;display:flex;flex-direction:column;gap:1rem;padding:.25rem;scroll-behavior:smooth}
  .bubble{max-width:78ch;border-radius:12px;padding:1rem 1.1rem;background:var(--panel);box-shadow:var(--shadow)}
  .bubble .md :is(h1,h2,h3){margin:.25rem 0 .35rem;font-size:1.02rem}
  .bubble .md :is(p,ul,ol,pre,blockquote,table){margin:.45rem 0}
  .me{align-self:flex-end;background:var(--brand);color:#fff;box-shadow:none}
  .composer{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:.7rem;display:flex;gap:.6rem;align-items:center;position:sticky;bottom:0}
  .in{flex:1;border:1px solid var(--line);border-radius:10px;background:color-mix(in oklab, var(--panel) 80%, var(--bg));padding:.85rem 1rem;font-size:1rem;outline:none;color:var(--text)}
  .send{appearance:none;border:0;background:var(--brand);color:#fff;font-weight:600;border-radius:10px;padding:.7rem 1rem;cursor:pointer}
  .send:disabled{opacity:.6;cursor:not-allowed}
  /* Palette (snippets) */
  .palette{position:absolute;bottom:66px;left:16px;max-width:640px;background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);display:none}
  .pal-item{padding:.7rem .9rem;border-top:1px solid var(--line);cursor:pointer;display:flex;justify-content:space-between;gap:.6rem}
  .pal-item:first-child{border-top:0}.pal-item:hover{background:rgba(11,91,211,.06)}
  .pal-tag{color:var(--muted);font-size:.85rem}
  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.32);backdrop-filter:saturate(140%) blur(6px);z-index:1000}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);width:min(92vw,760px);max-height:85vh;overflow:auto}
  .card-h{padding:1rem 1.2rem;border-bottom:1px solid var(--line);font-weight:600}
  .card-b{padding:1rem 1.2rem;line-height:1.55}
  .card-f{padding:1rem 1.2rem;border-top:1px solid var(--line);display:flex;gap:.6rem;justify-content:flex-end}
  .btn{appearance:none;border:1px solid var(--line);background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--brand);border-radius:.7rem;padding:.55rem .9rem;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .muted{color:var(--muted)}
  /* Settings */
  .group{padding:1rem 1.2rem;border-top:1px solid var(--line)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin:.55rem 0}
  .chips{display:flex;gap:.45rem;flex-wrap:wrap}
  .chip{padding:.42rem .72rem;border:1px solid var(--line);border-radius:999px;background:var(--panel);cursor:pointer}
  .chip.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .ta{width:100%;min-height:72px;border:1px solid var(--line);border-radius:10px;padding:.6rem;background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--text)}
  .select{border:1px solid var(--line);border-radius:10px;padding:.5rem .65rem;background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--text)}
  .switch{width:46px;height:26px;border-radius:999px;background:#dfe6f3;position:relative;cursor:pointer;border:1px solid var(--line)}
  .switch>i{position:absolute;width:22px;height:22px;top:1px;left:1px;border-radius:50%;background:#fff;transition:left .18s}
  .switch.on{background:#bcd4ff}.switch.on>i{left:23px}
  .disabled{opacity:.55;cursor:not-allowed;user-select:none}
  @media (max-width: 980px){.container{grid-template-columns:1fr}.sessions{max-height:none}}

  /* Quellen-Renderer (intern, ohne Download/Links) */
  .sources{border:1px solid var(--line);border-radius:12px;background:var(--panel);box-shadow:var(--shadow);overflow:hidden;margin-top:8px}
  .src-head{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
  .src-pill{display:inline-flex;align-items:center;gap:8px;background:rgba(11,91,211,.08);color:var(--brand);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:.9rem}
  .src-note{margin-left:auto;color:var(--muted);font-size:.85rem;display:flex;align-items:center;gap:6px}
  .src-toggle{appearance:none;border:1px solid var(--line);background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--brand);
              border-radius:9px;padding:6px 10px;cursor:pointer;margin-left:8px}
  .src-list{padding:8px 10px}
  .src-item{display:grid;grid-template-columns:22px 1fr;gap:8px;align-items:start;padding:8px 4px;border-top:1px solid var(--line)}
  .src-item:first-child{border-top:none}
  .src-idx{width:22px;height:22px;display:inline-grid;place-items:center;background:#e9f0ff;color:#2554d6;border-radius:50%;font-weight:600;font-size:.85rem}
  .src-meta{font-size:.92rem;line-height:1.35}
  .src-title{font-weight:600}
  .src-sub{color:var(--muted);font-size:.85rem}
  .src-collapsed .src-list{display:none}
</style>
</head>
<body>

<!-- Datenschutzhinweis -->
<div id="m-privacy" class="modal" style="display:flex">
  <div class="card" role="dialog" aria-modal="true">
    <div class="card-h">Datenschutzhinweis</div>
    <div class="card-b">
      <p>Um diesen Chatbot nutzen zu können, ist deine Zustimmung zur Datenschutzerklärung erforderlich:</p>
      <ul style="margin:.6rem 0 0 1.2rem">
        <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) übermittelt.</li>
        <li>Die übermittelten Daten werden zur Generierung von Antworten verarbeitet.</li>
        <li>Bitte gib <strong>keine sensiblen oder personenbezogenen Daten</strong> ein!</li>
        <li>Weitere Informationen: <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a>, <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make.com</a>.</li>
      </ul>
      <p class="muted" style="margin-top:.8rem">Hinweis: Dein <b>Chatverlauf</b> und deine <b>Snippets</b> werden <b>nur lokal</b> auf deinem Gerät gespeichert (localStorage). Du kannst beides in den Einstellungen verwalten (löschen/exportieren).</p>
    </div>
    <div class="card-f">
      <button class="btn" id="p-decline">Ablehnen</button>
      <button class="btn primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<!-- Nutzungshinweise -->
<div id="m-usage" class="modal">
  <div class="card" role="dialog" aria-modal="true">
    <div class="card-h">Wichtige Hinweise zur Bot-Nutzung</div>
    <div class="card-b">
      <ul style="margin:.6rem 0 0 1.2rem">
        <li><strong>Automatisierte Antworten:</strong> Alle Antworten werden von KI generiert.</li>
        <li><strong>Keine Gewähr:</strong> Inhalte können unvollständig/fehlerhaft sein – bitte prüfen.</li>
        <li><strong>Kein Ersatz für Beratung:</strong> keine Rechts-, Medizin-, Steuer- oder Finanzberatung.</li>
        <li><strong>Eigenverantwortung:</strong> Antworten kritisch hinterfragen und Quellen beachten.</li>
      </ul>
    </div>
    <div class="card-f"><button class="btn primary" id="u-accept">Einverstanden</button></div>
  </div>
</div>

<!-- Einstellungen (inkl. Snippet-Manager + Quellen-Renderer-Option) -->
<div id="m-settings" class="modal">
  <div class="card" role="dialog" aria-modal="true">
    <div class="card-h">Einstellungen</div>

    <div class="group">
      <div class="row">
        <label>Darstellung</label>
        <div class="chips" id="chip-theme">
          <div class="chip" data-val="light">Hell</div>
          <div class="chip" data-val="dark">Dunkel</div>
          <div class="chip" data-val="system">System</div>
        </div>
      </div>
      <div class="row"><label>Gender-Sprache</label><div id="sw-gender" class="switch"><i></i></div></div>
      <div class="row"><label>Begrüßung anzeigen</label><div id="sw-greet" class="switch on"><i></i></div></div>
      <div class="row"><label>Lernmodus (inaktiv)</label><div class="switch disabled" title="Demnächst"><i></i></div></div>
      <div class="row"><label>Quellen-Renderer</label><div id="sw-sources" class="switch"><i></i></div></div>
    </div>

    <div class="group">
      <div class="row">
        <label>Fachmodus</label>
        <select id="sel-domain" class="select">
          <option value="">— Kein spezieller Modus —</option>
          <option value="AEVO">AEVO</option>
          <option value="Personal">Personal</option>
          <option value="Recht">Recht</option>
          <option value="Kommunikation">Kommunikation</option>
          <option value="VWL">VWL</option>
        </select>
      </div>
    </div>

    <!-- Snippets -->
    <div class="group">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem">
        <div><strong>Prompt-Snippets</strong> <span class="muted">(per „/alias“ einfügen)</span></div>
        <div>
          <button class="btn" id="pm-add">Neu</button>
          <button class="btn" id="pm-export">Export</button>
          <button class="btn" id="pm-import">Import</button>
        </div>
      </div>
      <div id="pm-list" style="display:grid;grid-template-columns:1fr 1fr;gap:.7rem"></div>
    </div>

    <!-- Verlauf Verwaltung (global) -->
    <div class="group">
      <div class="row" style="align-items:flex-start">
        <div>
          <div><strong>Chatverlauf</strong></div>
          <div class="muted">Nur lokal gespeichert. Du kannst ihn löschen oder exportieren.</div>
        </div>
        <div style="display:flex;gap:.5rem">
          <button class="btn" id="btn-export-all">Gesamt-Export (.txt)</button>
          <button class="btn" id="btn-clear-all">Alle löschen</button>
        </div>
      </div>
    </div>

    <div class="card-f">
      <button class="btn" id="s-close">Schließen</button>
      <button class="btn primary" id="s-save">Speichern</button>
    </div>
  </div>
</div>

<!-- Prompt-Editor -->
<div id="m-prompt" class="modal">
  <div class="card" role="dialog" aria-modal="true">
    <div class="card-h">Snippet</div>
    <div class="card-b">
      <div class="row"><label style="min-width:120px">Titel</label><input id="pe-title" class="in" style="border:1px solid var(--line);border-radius:10px;padding:.6rem;background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--text)"/></div>
      <div class="row"><label style="min-width:120px">Alias</label><input id="pe-alias" class="in" placeholder="/aevo" style="border:1px solid var(--line);border-radius:10px;padding:.6rem;background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--text)"/></div>
      <div style="margin:.6rem 0 .3rem">Text</div>
      <textarea id="pe-content" class="ta" placeholder="Dieser Text wird bei /alias eingefügt."></textarea>
    </div>
    <div class="card-f">
      <button class="btn" id="pe-cancel">Abbrechen</button>
      <button class="btn primary" id="pe-save">Speichern</button>
    </div>
  </div>
</div>

<!-- App -->
<div class="top">
  <div class="brand">Linda</div>
  <div class="grow"></div>
  <div id="domain-badge" class="badge" style="display:none">📘 Fachmodus: —</div>
  <button class="icon-btn" id="btn-settings" aria-label="Einstellungen öffnen">
    <svg class="sliders" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="4" y1="6" x2="20" y2="6"></line>
      <line x1="4" y1="12" x2="20" y2="12"></line>
      <line x1="4" y1="18" x2="20" y2="18"></line>
      <circle cx="9" cy="6" r="2.2"></circle>
      <circle cx="15" cy="12" r="2.2"></circle>
      <circle cx="7" cy="18" r="2.2"></circle>
    </svg>
  </button>
</div>

<div class="container">
  <aside class="sidebar">
    <div class="panel avatar">
      <img src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png" alt="Linda"/>
      <div class="name">Linda</div>
    </div>

    <div class="panel sessions">
      <div class="head">
        <div style="font-weight:600">Verläufe</div>
        <button id="btn-new" class="sm-btn">Neu</button>
      </div>
      <div id="sess-list" class="list"></div>
    </div>
  </aside>

  <section class="chat">
    <div id="log" class="log"></div>
    <div style="position:relative">
      <div id="palette" class="palette"></div>
      <div class="composer">
        <input id="in" class="in" placeholder="Deine Frage… (Tipp „/“ für Snippets)"/>
        <button id="send" class="send">Senden</button>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const LS={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))},del(k){localStorage.removeItem(k)}};
  const nowStr=()=>new Date().toLocaleString();

  // ----- Persistent State
  const S=LS.get('linda.settings',{theme:'light',gender:false,greet:true,domain:'',sourcesOn:false});
  let SN=LS.get('linda.snippets',[
    {id:'s1',title:'AEVO-Kurz',alias:'/aevo',content:'Bitte juristisch sauber und prüfungsrelevant zur AEVO antworten.'},
    {id:'s2',title:'TL;DR',alias:'/tldr',content:'TL;DR in drei Bulletpoints, je max. 12 Wörter.'}
  ]);
  let Sessions=LS.get('linda.sessions',[]); // [{id,name,ts,messages:[{role,content}]}]
  let activeId=LS.get('linda.activeId',null);

  // ----- Utilities
  const md=(txt)=>{try{return marked.parse(txt)}catch{return txt}};
  const show=m=>m.style.display='flex', hide=m=>m.style.display='none';
  const uid=()=> 's_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
  function saveAll(){ LS.set('linda.settings',S); LS.set('linda.snippets',SN); LS.set('linda.sessions',Sessions); LS.set('linda.activeId',activeId); }

  // Quellen-Renderer (intern, ohne Download/Links)
  function escapeHtml(str=''){return String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
  function renderSourcesInternal(sources=[]) {
    if(!Array.isArray(sources) || !sources.length) return '';
    const id='src_'+Math.random().toString(36).slice(2,8);
    const items = sources.map((s,i)=>`
      <div class="src-item">
        <div class="src-idx">${i+1}</div>
        <div class="src-meta">
          <div class="src-title">${escapeHtml(s.title || s.doc || 'Quelle')}</div>
          <div class="src-sub">
            ${escapeHtml(s.doc || '')}
            ${s.page ? ' · Seite/Kapitel: '+escapeHtml(s.page) : ''}
            ${s.section ? ' · Abschnitt: '+escapeHtml(s.section) : ''}
            ${s.year ? ' · '+escapeHtml(s.year) : ''}
            ${s.note ? ' · '+escapeHtml(s.note) : ''}
          </div>
        </div>
      </div>`).join('');
    return `
      <div class="sources" id="${id}">
        <div class="src-head">
          <div class="src-pill">📚 Quellen</div>
          <div class="src-note">🔒 internes Archiv</div>
          <button class="src-toggle" data-target="${id}">Ausblenden</button>
        </div>
        <div class="src-list">${items}</div>
      </div>`;
  }
  // Delegierter Toggle
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('.src-toggle'); if(!btn) return;
    const box=document.getElementById(btn.getAttribute('data-target')); if(!box) return;
    box.classList.toggle('src-collapsed');
    btn.textContent=box.classList.contains('src-collapsed')?'Einblenden':'Ausblenden';
  });

  // Versucht Quellen aus dem Antworttext zu extrahieren (unterstützt 3 Varianten)
  function tryExtractSources(text){
    try{
      // Variante 1: Fenced code block ```sources ... ```
      const m1 = text.match(/```sources\s*?\n([\s\S]*?)```/i);
      if(m1){ const arr=JSON.parse(m1[1].trim()); if(Array.isArray(arr)) return arr; }
      // Variante 2: HTML-Kommentar <!--SOURCES:{...}-->
      const m2 = text.match(/<!--\s*SOURCES\s*:(\{[\s\S]*?\})\s*-->/i);
      if(m2){ const obj=JSON.parse(m2[1]); if(Array.isArray(obj.sources)) return obj.sources; }
      // Variante 3: Inline Marker __SOURCES__=...
      const m3 = text.match/__SOURCES__\s*=\s*(\{[\s\S]*?\})/;
      if(m3){ const obj=JSON.parse(m3[1]); if(Array.isArray(obj.sources)) return obj.sources; }
    }catch(e){}
    return null;
  }
  // Entfernt ggf. den Quellenblock-Text aus der sichtbaren Antwort
  function stripSourceMarkup(text){
    return text
      .replace(/```sources[\s\S]*?```/gi,'')
      .replace(/<!--\s*SOURCES\s*:[\s\S]*?-->/gi,'')
      .replace(/__SOURCES__\s*=\s*\{[\s\S]*?\}/gi,'')
      .trim();
  }

  // ----- Theme
  function applyTheme(){
    if(S.theme==='system'){
      const m=window.matchMedia('(prefers-color-scheme: dark)');
      document.body.classList.toggle('dark',m.matches);
      m.onchange=()=>document.body.classList.toggle('dark',m.matches);
    }else{
      document.body.classList.toggle('dark',S.theme==='dark');
    }
    document.querySelectorAll('#chip-theme .chip').forEach(c=>c.classList.toggle('active',c.dataset.val===S.theme));
  }

  // ----- Sessions (CRUD)
  function ensureFirstSession(){
    if(!Sessions.length){
      const id=uid();
      Sessions=[{id,name:'Neuer Chat',ts:Date.now(),messages:[]}];
      activeId=id; Sessions[0].id=id; saveAll();
    }
    if(!activeId || !Sessions.find(s=>s.id===activeId)){ activeId=Sessions[0].id; saveAll(); }
  }
  function active(){ return Sessions.find(s=>s.id===activeId); }
  function setActive(id){ activeId=id; saveAll(); renderSessions(); renderChat(); }
  function addSession(){
    const id=uid();
    Sessions.unshift({id,name:'Neuer Chat',ts:Date.now(),messages:[]});
    setActive(id);
  }
  function renameSession(id){
    const s=Sessions.find(x=>x.id===id); if(!s) return;
    const nn=prompt('Neuer Name für Verlauf:', s.name||''); if(nn!==null){ s.name=nn.trim()||s.name; saveAll(); renderSessions(); }
  }
  function deleteSession(id){
    if(!confirm('Diesen Verlauf wirklich löschen?')) return;
    Sessions=Sessions.filter(x=>x.id!==id);
    if(!Sessions.length){ addSession(); } else if(activeId===id){ activeId=Sessions[0].id; }
    saveAll(); renderSessions(); renderChat();
  }
  function exportSession(id){
    const s=Sessions.find(x=>x.id===id); if(!s) return;
    const text=s.messages.map(m=>(m.role==='user'?'Du: ':'Linda: ')+m.content).join('\n\n');
    const blob=new Blob([text],{type:'text/plain'}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=(s.name||'linda_chat')+'.txt'; a.click(); URL.revokeObjectURL(a.href);
  }

  function renderSessions(){
    const el=$('sess-list');
    el.innerHTML = Sessions.map(s=>`
      <div class="sess ${s.id===activeId?'active':''}" data-id="${s.id}">
        <div class="ttl">${s.name||'Chat'}<div class="muted" style="font-size:.8rem">${new Date(s.ts).toLocaleDateString()}</div></div>
        <div class="rowbtns">
          <button class="sm-btn s-rename" title="Umbenennen">✎</button>
          <button class="sm-btn s-export" title="Exportieren">⤓</button>
          <button class="sm-btn s-del" title="Löschen">🗑</button>
        </div>
      </div>
    `).join('');
    el.querySelectorAll('.sess').forEach(n=>n.onclick=(e)=>{ if(e.target.closest('.rowbtns')) return; setActive(n.dataset.id); });
    el.querySelectorAll('.s-rename').forEach(b=>b.onclick=(e)=>{e.stopPropagation(); renameSession(b.closest('.sess').dataset.id);});
    el.querySelectorAll('.s-export').forEach(b=>b.onclick=(e)=>{e.stopPropagation(); exportSession(b.closest('.sess').dataset.id);});
    el.querySelectorAll('.s-del').forEach(b=>b.onclick=(e)=>{e.stopPropagation(); deleteSession(b.closest('.sess').dataset.id);});
  }

  // ----- Chat rendering
  function addMsg(role,content,sourcesMeta){
    const d=document.createElement('div');
    d.className='bubble'+(role==='user'?' me':'');
    let html = '<div class="md">'+md(content)+'</div>';
    if(role!=='user' && S.sourcesOn && Array.isArray(sourcesMeta) && sourcesMeta.length){
      html += renderSourcesInternal(sourcesMeta);
    }
    d.innerHTML = html;
    $('log').appendChild(d); $('log').scrollTop=$('log').scrollHeight;
  }

  function renderChat(){ $('log').innerHTML=''; const s=active(); if(!s) return; s.messages.forEach(m=>addMsg(m.role,m.content,m.sources)); }
  function push(role,content,sources){ const s=active(); s.messages.push({role,content, ...(sources?{sources}:{} )}); s.ts=Date.now(); saveAll(); }

  // ----- Badge & Prefix
  function setBadge(){ const b=$('domain-badge'); if(S.domain){ b.style.display='inline-flex'; b.textContent='📘 Fachmodus: '+S.domain } else { b.style.display='none' } }
  function systemPrefix(){
    const lines=[];
    if(S.domain){
      const map={
        'AEVO':'Antworte fachlich fundiert im AEVO-Kontext mit kurzer Prüfungsrelevanz.',
        'Personal':'Antworte als Expertin für Personal/HR mit Praxisbeispiel.',
        'Recht':'Antworte juristisch sauber (Normen nennen) und praxisnah.',
        'Kommunikation':'Antworte als Trainerin für Kommunikation, klar strukturiert.',
        'VWL':'Antworte fachlich fundiert in Volkswirtschaftslehre (IHK-Prüfungskontext).'
      };
      lines.push(map[S.domain]||'');
    }
    lines.push(S.gender ? 'Verwende gendergerechte Sprache (neutral, inklusiv, gut lesbar).' :
                          'Verwende neutrale, nicht gegenderte Sprache.');
    lines.push('Strukturiere Antworten: 1) Definition/Einordnung 2) Rechts-/Theoriebezug 3) Praxisbeispiel 4) Prüfungsrelevanz 5) kurze Quellenhinweise (falls vorhanden).');
    return lines.filter(Boolean).join('\n');
  }

  // ----- Send (robust; kein VWL-Routing, „Accepted“-Fallback, Quellen-Parsing)
  async function send(){
    const inp=$('in'); const q=inp.value.trim(); if(!q) return;
    inp.value=''; $('send').disabled=true;
    push('user',q); renderChat();
    push('assistant','⏳ Einen Moment …'); renderChat();

    try{
      const payload={question: systemPrefix()+'\n\n'+q};
      const r=await fetch('/api/bot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const raw=await r.text();
      const isAccepted = raw && raw.trim().toLowerCase()==='accepted';
      const cleaned = stripSourceMarkup(raw||'');
      const sources = tryExtractSources(raw||'') || [];
      const out = (!isAccepted && cleaned) ? cleaned : 'Ich habe deine Frage erhalten und beantworte sie gleich – bitte erneut senden, falls nichts erscheint.';
      const s=active();
      s.messages[s.messages.length-1]={role:'assistant',content:out, ...(S.sourcesOn && sources.length?{sources}:{} )};
      saveAll(); renderChat();
    }catch(e){
      const s=active(); s.messages[s.messages.length-1]={role:'assistant',content:'Es gab ein Verbindungsproblem. Bitte noch einmal senden.'}; saveAll(); renderChat();
    }finally{$('send').disabled=false;}
  }

  // ----- Palette (Snippets, /-Autocomplete)
  function openPalette(list){
    const pal=$('palette');
    pal.innerHTML = list.map(s=>`<div class="pal-item" data-id="${s.id}"><span>${s.title}</span><span class="pal-tag">${s.alias}</span></div>`).join('');
    pal.style.display = list.length ? 'block' : 'none';
    pal.querySelectorAll('.pal-item').forEach(it=>it.onclick=()=>{const s=SN.find(x=>x.id===it.dataset.id); pal.style.display='none'; if(!s) return; replaceAliasWithText($('in'), s.alias, s.content); $('in').focus();});
  }
  function replaceAliasWithText(inp,alias,text){const v=inp.value; const i=v.lastIndexOf(alias); if(i>=0){inp.value=v.slice(0,i)+text+v.slice(i+alias.length);} else {const s=inp.selectionStart; inp.value=v.slice(0,s)+text+v.slice(s);} }

  // ----- Snippet Manager
  function renderPM(){
    const list=$('pm-list');
    list.innerHTML = SN.map(s=>`
      <div class="panel" style="padding:.7rem">
        <div style="display:flex;justify-content:space-between;gap:.5rem;align-items:center">
          <div><b>${s.title}</b> <span class="muted">${s.alias}</span></div>
          <div>
            <button class="sm-btn pm-use" data-id="${s.id}">Einfügen</button>
            <button class="sm-btn pm-edit" data-id="${s.id}">Bearb.</button>
            <button class="sm-btn pm-del" data-id="${s.id}">🗑</button>
          </div>
        </div>
        <div class="muted" style="margin-top:.35rem;max-height:4.2em;overflow:hidden">${s.content}</div>
      </div>`).join('');
    list.querySelectorAll('.pm-use').forEach(b=>b.onclick=()=>{const s=SN.find(x=>x.id===b.dataset.id); if(!s)return; replaceAliasWithText($('in'), s.alias, s.content); hide($('m-settings')); $('in').focus();});
    list.querySelectorAll('.pm-edit').forEach(b=>b.onclick=()=>editSnippet(b.dataset.id));
    list.querySelectorAll('.pm-del').forEach(b=>b.onclick=()=>{SN=SN.filter(x=>x.id!==b.dataset.id); saveAll(); renderPM();});
  }
  function editSnippet(id){
    const s=SN.find(x=>x.id===id) || {id:uid(),title:'',alias:'',content:''};
    editingId=s.id; $('pe-title').value=s.title; $('pe-alias').value=s.alias; $('pe-content').value=s.content; show($('m-prompt'));
  }
  let editingId=null;
  $('pm-add').onclick=()=>editSnippet(null);
  $('pe-cancel').onclick=()=>hide($('m-prompt'));
  $('pe-save').onclick=()=>{const obj={id:editingId||uid(),title:$('pe-title').value.trim(),alias:$('pe-alias').value.trim(),content:$('pe-content').value.trim()};
    if(!obj.alias.startsWith('/')){alert('Alias muss mit / beginnen.');return}
    const i=SN.findIndex(x=>x.id===obj.id); if(i>=0) SN[i]=obj; else SN.push(obj);
    saveAll(); hide($('m-prompt')); renderPM();
  };
  $('pm-export').onclick=()=>{const blob=new Blob([JSON.stringify(SN,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='linda-snippets.json'; a.click(); URL.revokeObjectURL(a.href);};
  $('pm-import').onclick=()=>{const i=document.createElement('input'); i.type='file'; i.accept='application/json'; i.onchange=async()=>{const f=i.files[0]; if(!f)return; const txt=await f.text(); try{const arr=JSON.parse(txt); if(Array.isArray(arr)){SN=arr; saveAll(); renderPM();}}catch{alert('Import fehlgeschlagen.')}}; i.click();};

  // ----- Input & Events
  $('send').onclick=send;
  $('in').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }});
  $('in').addEventListener('input',e=>{
    const v=e.target.value; const m=v.match(/\/([\w-]{0,24})$/);
    if(m){ const q=m[1].toLowerCase(); const list=SN.filter(s=>s.alias.toLowerCase().startsWith('/'+q)||s.title.toLowerCase().includes(q)); openPalette(list); }
    else $('palette').style.display='none';
  });
  document.addEventListener('click',e=>{ if(!e.target.closest('.composer')) $('palette').style.display='none'; });

  // ----- Privacy
  $('p-accept').onclick=()=>{hide($('m-privacy'));show($('m-usage'))};
  $('p-decline').onclick=()=>location.reload();
  $('u-accept').onclick=()=>{hide($('m-usage'));
    const s=active();
    if(S.greet && s.messages.length===0){
      push('assistant','**Willkommen!** Nutze mich für AEVO-, Personal-, Rechts- und Prüfungsfragen. Öffne *Einstellungen* (Fachmodus, Snippets, Quellen-Renderer).');
      renderChat();
    }
  };

  // ----- Settings wiring
  applyTheme(); 
  const sw=(el,val)=>{el.classList.toggle('on',val)}
  sw($('sw-gender'),S.gender); $('sw-gender').onclick=()=>{S.gender=!S.gender; sw($('sw-gender'),S.gender)}
  sw($('sw-greet'),S.greet); $('sw-greet').onclick=()=>{S.greet=!S.greet; sw($('sw-greet'),S.greet)}
  sw($('sw-sources'),S.sourcesOn); $('sw-sources').onclick=()=>{S.sourcesOn=!S.sourcesOn; sw($('sw-sources'),S.sourcesOn)}
  document.querySelectorAll('#chip-theme .chip').forEach(c=>c.onclick=()=>{S.theme=c.dataset.val; saveAll(); applyTheme();});
  $('sel-domain').value=S.domain||'';
  function setBadge(){ const b=$('domain-badge'); if(S.domain){ b.style.display='inline-flex'; b.textContent='📘 Fachmodus: '+S.domain } else { b.style.display='none' } }
  setBadge();
  $('s-save').onclick=()=>{S.domain=$('sel-domain').value; saveAll(); setBadge(); hide($('m-settings'));};
  $('s-close').onclick=()=>hide($('m-settings'));
  $('btn-settings').onclick=()=>{ renderPM(); show($('m-settings')); };

  // Global export/clear
  $('btn-export-all').onclick=()=>{ 
    const all=Sessions.map(s=>`# ${s.name||'Chat'} (${new Date(s.ts).toLocaleString()})\n\n`+s.messages.map(m=>(m.role==='user'?'Du: ':'Linda: ')+m.content).join('\n\n')).join('\n\n---\n\n');
    const blob=new Blob([all],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='linda_all_chats.txt'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('btn-clear-all').onclick=()=>{ if(confirm('Wirklich alle Verläufe löschen?')){ Sessions=[]; addSession(); saveAll(); renderSessions(); renderChat(); } };

  // Sidebar buttons
  $('btn-new').onclick=addSession;

  // ----- Boot
  ensureFirstSession();
  renderSessions();
  renderChat();

})();
</script>
</body>
</html>
