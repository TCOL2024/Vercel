<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Linda ‚Äì Deine pers√∂nliche Assistentin (v27.5-pro)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root{
    --bg:#f7f8fb;--panel:#ffffff;--line:#e7ebf0;--text:#0f172a;--muted:#5b6678;
    --brand:#0b5bd3;--brand-2:#2b6ff0;--ok:#0ea5e9;--shadow:0 8px 24px rgba(15,23,42,.06),0 1px 2px rgba(15,23,42,.04)
  }
  body.dark{--bg:#0b0e14;--panel:#0f1420;--line:#1d2535;--text:#e7eaf0;--muted:#a4b0c3;--brand:#6aa4ff;--brand-2:#88b2ff}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:var(--brand-2)}
  /* Header */
  .top{position:sticky;top:0;z-index:30;background:var(--panel);border-bottom:1px solid var(--line);padding:.9rem 1rem;display:flex;align-items:center;gap:.75rem}
  .brand{font-weight:600;letter-spacing:.2px}
  .grow{flex:1}
  .badge{display:inline-flex;align-items:center;gap:.35rem;background:rgba(11,91,211,.08);color:var(--brand);border:1px solid var(--line);padding:.35rem .6rem;border-radius:999px;font-size:.85rem}
  .icon-btn{appearance:none;border:0;background:transparent;cursor:pointer;padding:.35rem;border-radius:.6rem}
  .icon-btn:hover{background:rgba(11,91,211,.08)}
  .sliders{width:22px;height:22px}
  /* Layout */
  .container{max-width:1200px;margin:0 auto;padding:1rem;display:grid;grid-template-columns:220px 1fr;gap:1rem}
  .sidebar{background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:.9rem;height:fit-content;position:sticky;top:86px}
  .sidebar img{width:100%;border-radius:10px;display:block}
  .sidebar .name{margin-top:.55rem;font-weight:600;text-align:center}
  .chat{display:flex;flex-direction:column;min-height:calc(100vh - 120px)}
  .log{flex:1;overflow:auto;display:flex;flex-direction:column;gap:1rem;padding:.25rem;scroll-behavior:smooth}
  .bubble{max-width:78ch;border-radius:12px;padding:1rem 1.1rem;background:var(--panel);box-shadow:var(--shadow)}
  .bubble .md :is(h1,h2,h3){margin:.25rem 0 .35rem;font-size:1.02rem}
  .bubble .md :is(p,ul,ol,pre,blockquote,table){margin:.45rem 0}
  .me{align-self:flex-end;background:var(--brand);color:#fff;box-shadow:none}
  .composer{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:.7rem;display:flex;gap:.6rem;align-items:center;position:sticky;bottom:0}
  .in{flex:1;border:1px solid var(--line);border-radius:10px;background:color-mix(in oklab, var(--panel) 80%, var(--bg));padding:.85rem 1rem;font-size:1rem;outline:none;color:var(--text)}
  .send{appearance:none;border:0;background:var(--brand);color:#fff;font-weight:600;border-radius:10px;padding:.7rem 1rem;cursor:pointer}
  .send:disabled{opacity:.6;cursor:not-allowed}
  /* Modal/Sheet */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.32);backdrop-filter:saturate(140%) blur(6px);z-index:1000}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);width:min(92vw,720px);max-height:85vh;overflow:auto}
  .card-h{padding:1rem 1.2rem;border-bottom:1px solid var(--line);font-weight:600}
  .card-b{padding:1rem 1.2rem;line-height:1.55}
  .card-f{padding:1rem 1.2rem;border-top:1px solid var(--line);display:flex;gap:.6rem;justify-content:flex-end}
  .btn{appearance:none;border:1px solid var(--line);background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--brand);border-radius:.7rem;padding:.55rem .9rem;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .muted{color:var(--muted)}
  /* Settings */
  .group{padding:1rem 1.2rem;border-top:1px solid var(--line)}
  .row{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin:.55rem 0}
  .chips{display:flex;gap:.45rem;flex-wrap:wrap}
  .chip{padding:.42rem .72rem;border:1px solid var(--line);border-radius:999px;background:var(--panel);cursor:pointer}
  .chip.active{background:var(--brand);border-color:var(--brand);color:#fff}
  .ta{width:100%;min-height:72px;border:1px solid var(--line);border-radius:10px;padding:.6rem;background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--text)}
  .select{border:1px solid var(--line);border-radius:10px;padding:.5rem .65rem;background:color-mix(in oklab, var(--panel) 80%, var(--bg));color:var(--text)}
  .switch{width:46px;height:26px;border-radius:999px;background:#dfe6f3;position:relative;cursor:pointer;border:1px solid var(--line)}
  .switch>i{position:absolute;width:22px;height:22px;top:1px;left:1px;border-radius:50%;background:#fff;transition:left .18s}
  .switch.on{background:#bcd4ff}
  .switch.on>i{left:23px}
  .disabled{opacity:.55;cursor:not-allowed;user-select:none}
  @media (max-width: 980px){.container{grid-template-columns:1fr}.sidebar{position:static}}
</style>
</head>
<body>

<!-- Datenschutzhinweis -->
<div id="m-privacy" class="modal" style="display:flex">
  <div class="card" role="dialog" aria-modal="true">
    <div class="card-h">Datenschutzhinweis</div>
    <div class="card-b">
      <p>Um diesen Chatbot nutzen zu k√∂nnen, ist deine Zustimmung zur Datenschutzerkl√§rung erforderlich:</p>
      <ul style="margin:.6rem 0 0 1.2rem">
        <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) √ºbermittelt.</li>
        <li>Die √ºbermittelten Daten werden zur Generierung von Antworten verarbeitet.</li>
        <li>Bitte gib <strong>keine sensiblen oder personenbezogenen Daten</strong> ein!</li>
        <li>Weitere Informationen: <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a>, <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make.com</a>.</li>
      </ul>
      <p class="muted" style="margin-top:.8rem">Hinweis: Dein <b>Chatverlauf</b> wird <b>nur lokal</b> in deinem Browser gespeichert (localStorage). Du kannst ihn in den Einstellungen l√∂schen oder exportieren.</p>
    </div>
    <div class="card-f">
      <button class="btn" id="p-decline">Ablehnen</button>
      <button class="btn primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<!-- Nutzungshinweise -->
<div id="m-usage" class="modal">
  <div class="card" role="dialog" aria-modal="true">
    <div class="card-h">Wichtige Hinweise zur Bot-Nutzung</div>
    <div class="card-b">
      <ul style="margin:.6rem 0 0 1.2rem">
        <li><strong>Automatisierte Antworten:</strong> Alle Antworten werden von KI generiert.</li>
        <li><strong>Keine Gew√§hr:</strong> Inhalte k√∂nnen unvollst√§ndig/fehlerhaft sein ‚Äì bitte pr√ºfen.</li>
        <li><strong>Kein Ersatz f√ºr Beratung:</strong> keine Rechts-, Medizin-, Steuer- oder Finanzberatung.</li>
        <li><strong>Eigenverantwortung:</strong> Antworten kritisch hinterfragen und Quellen beachten.</li>
      </ul>
    </div>
    <div class="card-f"><button class="btn primary" id="u-accept">Einverstanden</button></div>
  </div>
</div>

<!-- Einstellungen -->
<div id="m-settings" class="modal">
  <div class="card" role="dialog" aria-modal="true">
    <div class="card-h">Einstellungen</div>

    <div class="group">
      <div class="row">
        <label>Darstellung</label>
        <div class="chips" id="chip-theme">
          <div class="chip" data-val="light">Hell</div>
          <div class="chip" data-val="dark">Dunkel</div>
          <div class="chip" data-val="system">System</div>
        </div>
      </div>
      <div class="row"><label>Gender-Sprache</label><div id="sw-gender" class="switch"><i></i></div></div>
      <div class="row"><label>Begr√º√üung anzeigen</label><div id="sw-greet" class="switch on"><i></i></div></div>
      <div class="row"><label>Lernmodus (inaktiv)</label><div class="switch disabled" title="Demn√§chst"><i></i></div></div>
    </div>

    <div class="group">
      <div class="row">
        <label>Fachmodus</label>
        <select id="sel-domain" class="select">
          <option value="">‚Äî Kein spezieller Modus ‚Äî</option>
          <option value="AEVO">AEVO</option>
          <option value="Personal">Personal</option>
          <option value="Recht">Recht</option>
          <option value="Kommunikation">Kommunikation</option>
          <option value="VWL">VWL</option>
        </select>
      </div>
    </div>

    <div class="group">
      <div class="row" style="align-items:flex-start">
        <div>
          <div><strong>Chatverlauf</strong></div>
          <div class="muted">Nur lokal gespeichert. Du kannst ihn l√∂schen oder exportieren.</div>
        </div>
        <div style="display:flex;gap:.5rem">
          <button class="btn" id="btn-export">Export (.txt)</button>
          <button class="btn" id="btn-clear">L√∂schen</button>
        </div>
      </div>
    </div>

    <div class="card-f">
      <button class="btn" id="s-close">Schlie√üen</button>
      <button class="btn primary" id="s-save">Speichern</button>
    </div>
  </div>
</div>

<!-- App -->
<div class="top">
  <div class="brand">Linda</div>
  <div class="grow"></div>
  <div id="domain-badge" class="badge" style="display:none">üìò Fachmodus: ‚Äî</div>
  <button class="icon-btn" id="btn-settings" aria-label="Einstellungen √∂ffnen">
    <svg class="sliders" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <line x1="4" y1="6" x2="20" y2="6"></line>
      <line x1="4" y1="12" x2="20" y2="12"></line>
      <line x1="4" y1="18" x2="20" y2="18"></line>
      <circle cx="9" cy="6" r="2.2"></circle>
      <circle cx="15" cy="12" r="2.2"></circle>
      <circle cx="7" cy="18" r="2.2"></circle>
    </svg>
  </button>
</div>

<div class="container">
  <aside class="sidebar">
    <img src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png" alt="Linda"/>
    <div class="name">Linda</div>
  </aside>

  <section class="chat">
    <div id="log" class="log"></div>
    <div class="composer">
      <input id="in" class="in" placeholder="Deine Frage‚Ä¶"/>
      <button id="send" class="send">Senden</button>
    </div>
  </section>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const LS={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},set(k,v){localStorage.setItem(k,JSON.stringify(v))},del(k){localStorage.removeItem(k)}};

  // ---- State (persisted)
  const S=LS.get('linda.settings',{theme:'light',gender:false,greet:true,domain:''});
  let CHAT=LS.get('linda.chat.history',[]); // [{role:'user'|'assistant',content:'...'}]

  // ---- Theme
  function applyTheme(){
    if(S.theme==='system'){
      const m=window.matchMedia('(prefers-color-scheme: dark)');
      document.body.classList.toggle('dark',m.matches);
      m.onchange=()=>document.body.classList.toggle('dark',m.matches);
    }else{
      document.body.classList.toggle('dark',S.theme==='dark');
    }
    document.querySelectorAll('#chip-theme .chip').forEach(c=>c.classList.toggle('active',c.dataset.val===S.theme));
  }

  // ---- UI helpers
  function show(m){m.style.display='flex'} function hide(m){m.style.display='none'}
  function md(txt){try{return marked.parse(txt)}catch{return txt}}
  function addMsg(role,content){const d=document.createElement('div');d.className='bubble'+(role==='user'?' me':'');d.innerHTML='<div class="md">'+md(content)+'</div>'; $('log').appendChild(d); $('log').scrollTop=$('log').scrollHeight}
  function renderChat(){ $('log').innerHTML=''; CHAT.forEach(m=>addMsg(m.role,m.content)); }
  function saveChat(){ LS.set('linda.chat.history',CHAT) }
  function setBadge(){ const b=$('domain-badge'); if(S.domain){ b.style.display='inline-flex'; b.textContent='üìò Fachmodus: '+S.domain } else { b.style.display='none' } }

  // ---- Privacy flow
  $('p-accept').onclick=()=>{hide($('m-privacy'));show($('m-usage'))};
  $('p-decline').onclick=()=>location.reload();
  $('u-accept').onclick=()=>{hide($('m-usage')); if(S.greet && CHAT.length===0){ CHAT.push({role:'assistant',content:'**Willkommen!** Nutze mich f√ºr AEVO-, Personal-, Rechts- und Pr√ºfungsfragen. √ñffne die *Einstellungen*, um Fachmodus & Darstellung zu w√§hlen.'}); saveChat(); renderChat(); }};

  // ---- Settings UI wire
  applyTheme(); setBadge();
  document.querySelectorAll('#chip-theme .chip').forEach(c=>c.onclick=()=>{S.theme=c.dataset.val; LS.set('linda.settings',S); applyTheme();});
  const sw = (el, val)=>{el.classList.toggle('on',val)}
  sw($('sw-gender'), S.gender); $('sw-gender').onclick=()=>{S.gender=!S.gender; sw($('sw-gender'),S.gender)}
  sw($('sw-greet'), S.greet); $('sw-greet').onclick=()=>{S.greet=!S.greet; sw($('sw-greet'),S.greet)}
  $('sel-domain').value=S.domain||'';
  $('s-save').onclick=()=>{S.domain=$('sel-domain').value; LS.set('linda.settings',S); setBadge(); hide($('m-settings'))}
  $('s-close').onclick=()=>hide($('m-settings'));
  $('btn-settings').onclick=()=>show($('m-settings'));
  $('btn-clear').onclick=()=>{ if(confirm('Verlauf wirklich l√∂schen?')){ CHAT=[]; saveChat(); renderChat(); } }
  $('btn-export').onclick=()=>{ const text=CHAT.map(m=> (m.role==='user'?'Du: ':'Linda: ')+m.content.replace(/\n/g,'\n') ).join('\n\n'); const blob=new Blob([text],{type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='linda_chat.txt'; a.click(); URL.revokeObjectURL(a.href); };

  // ---- Initial chat render
  renderChat();

  // ---- Build system prefix (Domain + Gender)
  function systemPrefix(){
    const lines=[];
    if(S.domain){
      const map={
        'AEVO':'Antworte fachlich fundiert im AEVO-Kontext mit kurzer Pr√ºfungsrelevanz.',
        'Personal':'Antworte als Expertin f√ºr Personal/HR mit Praxisbeispiel.',
        'Recht':'Antworte juristisch sauber (Normen nennen) und praxisnah.',
        'Kommunikation':'Antworte als Trainerin f√ºr Kommunikation, klar strukturiert.',
        'VWL':'Antworte fachlich fundiert in Volkswirtschaftslehre (IHK-Pr√ºfungskontext).'
      };
      lines.push(map[S.domain]||'');
    }
    lines.push(S.gender ? 'Verwende gendergerechte Sprache (neutral, inklusiv, gut lesbar).' :
                          'Verwende neutrale, nicht gegenderte Sprache.');
    lines.push('Strukturiere Antworten: 1) Definition/Einordnung 2) Rechts-/Theoriebezug 3) Praxisbeispiel 4) Pr√ºfungsrelevanz 5) kurze Quellenhinweise (falls vorhanden).');
    return lines.filter(Boolean).join('\n');
  }

  // ---- Send flow (robust, keine VWL-Sonderf√§lle)
  async function send(){
    const q=$('in').value.trim();
    if(!q) return;
    $('in').value=''; $('send').disabled=true;
    CHAT.push({role:'user',content:q}); saveChat(); renderChat();
    CHAT.push({role:'assistant',content:'‚è≥ Einen Moment ‚Ä¶'}); saveChat(); renderChat();
    try{
      // robustes Payload ‚Äì kein Sonderrouting, keine Filter (VWL ok)
      const payload={question: systemPrefix()+ '\n\n' + q};
      const r=await fetch('/api/bot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const text=await r.text();
      // Falls Backend wider Erwarten "Accepted" liefert, abfangen:
      const out=(text && text.trim().toLowerCase()!=='accepted') ? text : 'Ich habe deine Frage erhalten und beantworte sie gleich ‚Äì bitte erneut senden, falls nichts erscheint.';
      CHAT[CHAT.length-1]={role:'assistant',content:out}; saveChat(); renderChat();
    }catch(e){
      CHAT[CHAT.length-1]={role:'assistant',content:'Es gab ein Verbindungsproblem. Bitte noch einmal senden.'}; saveChat(); renderChat();
    }finally{$('send').disabled=false;}
  }
  $('send').onclick=send;
  $('in').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}});

})();
</script>
</body>
</html>
