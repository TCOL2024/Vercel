// BBiG-Quiz Enterprise Edition - Main Application
(function() {
  'use strict';
  
  const PASSWORD = "IHK2025";
  const relay = "/api/linda-proxy";
  const STORAGE_KEY = "BBIGQUIZ_EXAM_V2";
  const HISTORY_KEY = "BBIGQUIZ_HISTORY";
  const MAX_ANSWER_CHARS = 1500;

  const QUESTIONS_ALL = [
    { ref:"V1 ‚Äì Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag geh√∂ren.", tip:["Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung, Verg√ºtung, Probezeit, Urlaub, t√§gliche Ausbildungszeit, K√ºndigung, Hinweise auf Tarif/BV, Form des Ausbildungsnachweises.","¬ß 11 BBiG; Textform/elektronisch zul√§ssig."]},
    { ref:"V2 ‚Äì Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:["Berufsbild, Dauer/Ausbildungsrahmenplan, Pr√ºfungen.","¬ß¬ß 4‚Äì5 BBiG."]},
    { ref:"V3 ‚Äì Probezeit", q:"Wie lang muss/darf die Probezeit sein ‚Äì und warum ist sie wichtig?", tip:["Mind. 1, max. 4 Monate; Eignungspr√ºfung beider Seiten.","¬ß 20 BBiG."]},
    { ref:"V4 ‚Äì Minderj√§hrige: Unterschrift", q:"Wer unterschreibt den Vertrag bei Minderj√§hrigen mit gemeinsamem Sorgerecht?", tip:["Beide Sorgeberechtigte + Minderj√§hrige/r.","¬ß 10 BBiG; ¬ß¬ß 1626, 1629 BGB."]},
    { ref:"V5 ‚Äì Berufsschulzeit & Arbeitszeit", q:"Wie werden Berufsschulzeiten auf die Arbeitszeit angerechnet (U18 vs. ‚â•18)?", tip:["U18: besondere Anrechnung (JArbSchG).","Wegezeiten Schule‚ÜíBetrieb anrechenbar (¬ß 15 Abs. 2 Nr. 1 BBiG).","‚â•18: ArbZG; Freistellung nach ¬ß 15 BBiG."]},
    { ref:"V6 ‚Äì Ruhezeit Jugendliche", q:"Welche t√§gliche Mindestruhezeit gilt f√ºr Jugendliche?", tip:["Mindestens 12 Stunden.","JArbSchG."]},
    { ref:"V7 ‚Äì Verg√ºtung", q:"Was gilt zur Angemessenheit der Ausbildungsverg√ºtung?", tip:["MiAV Untergrenze; tariflich/branchen√ºblich; Steigerung je Jahr.","¬ß 17 BBiG."]},
    { ref:"V8 ‚Äì √úberstunden", q:"Sind √úberstunden zul√§ssig ‚Äì und wie werden sie behandelt?", tip:["Nur ausbildungsdienlich; Verg√ºtung/Zeitausgleich; Jugendarbeitsschutz beachten.","ArbZG/JArbSchG; BBiG."]},
    { ref:"V9 ‚Äì Betrieblicher Ausbildungsplan", q:"Wozu dient der betriebliche Ausbildungsplan?", tip:["Umsetzung Rahmenplan, zeitl./sachl. Gliederung, Qualit√§tssicherung.","¬ß 5 BBiG; Verweis ¬ß 11 Abs. 1 S. 2."]},
    { ref:"V10 ‚Äì Berichtsheft", q:"Welche Bedeutung hat das Berichtsheft und wer kontrolliert es?", tip:["Zulassungsvoraussetzung; elektronisch m√∂glich; Kontrolle Ausbilder/in.","¬ß 13 Nr.7, ¬ß 14 BBiG."]},
    { ref:"V11 ‚Äì Verk√ºrzung", q:"Wann kann die Ausbildungsdauer verk√ºrzt werden?", tip:["Vorbildung/Leistung/Anrechnung; Einvernehmen n√∂tig.","¬ß 8 BBiG."]},
    { ref:"V12 ‚Äì Verl√§ngerung", q:"Wann kommt eine Verl√§ngerung in Betracht?", tip:["Nichtbestehen oder besondere F√§lle.","¬ß 8 Abs. 2 BBiG."]},
    { ref:"V13 ‚Äì Teilzeitberufsausbildung", q:"Wie funktioniert Teilzeit in der Ausbildung und was bleibt unver√§ndert?", tip:["Reduzierte Zeiten, Lernziel bleibt; evtl. l√§ngere Gesamtdauer.","¬ß 7a BBiG."]},
    { ref:"V14 ‚Äì Datenschutz/Geheimnis", q:"Welche Pflichten haben Azubis zu Datenschutz und Betriebsgeheimnissen?", tip:["DSGVO/BDSG beachten; Unterweisungen dokumentieren."]},
    { ref:"V15 ‚Äì K√ºndigung", q:"Welche K√ºndigungsregeln gelten in und nach der Probezeit?", tip:["Probezeit: jederzeit fristlos (¬ß 22 Abs. 1).","Danach: fristlos aus wichtigem Grund oder mit Frist (Berufsaufgabe/Wechsel) ‚Äì schriftlich, Gr√ºnde nennen (¬ß 22)."]},
    { ref:"V16 ‚Äì Schwangerschaft/Mutterschutz", q:"Welche Schutzregeln gelten bei Schwangerschaft in der Ausbildung?", tip:["MuSchG: Schutzfristen, Besch√§ftigungsverbote, K√ºndigungsschutz."]},
    { ref:"V17 ‚Äì Nachteilsausgleich", q:"Wie werden Auszubildende mit Behinderung in Pr√ºfungen unterst√ºtzt?", tip:["Nachteilsausgleich (Zeit, Hilfsmittel) auf Antrag; Chancengleichheit."]},
    { ref:"V18 ‚Äì Ausland", q:"Sind Ausbildungsabschnitte im Ausland m√∂glich und wie werden sie angerechnet?", tip:["Ja; Ausbildungsziel wahren; bis zul√§ssige Zeitanteile.","¬ß 2 Abs. 3 BBiG."]},
    { ref:"V19 ‚Äì Versetzung", q:"Darf der Betrieb Azubis versetzen?", tip:["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten kl√§ren.","¬ß 14 BBiG."]},
    { ref:"V20 ‚Äì Insolvenz", q:"Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip:["Fortf√ºhrung/Anschlussbetrieb/IHK-Unterst√ºtzung; ggf. Insolvenzgeld."]}
  ];

  const LAW_INDEX = [
    { law:"BBiG", para:"¬ß 11", tags:["vertrag","inhalte","mindestinhalte"], excerpt:"¬ß 11 BBiG ‚Äì Niederschrift der wesentlichen Inhalte (u. a. Parteien, Beginn/Dauer, Ziel, sachliche/zeitliche Gliederung, Verg√ºtung, Probezeit, Urlaub, K√ºndigung).", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
    { law:"BBiG", para:"¬ß 20", tags:["probezeit"], excerpt:"¬ß 20 BBiG ‚Äì Probezeit mindestens 1, h√∂chstens 4 Monate.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
    { law:"BBiG", para:"¬ß 15", tags:["freistellung","schule","wegezeit"], excerpt:"¬ß 15 BBiG ‚Äì Freistellung f√ºr Berufsschule/Pr√ºfungen; Wegezeiten Schule‚ÜíBetrieb sind anzurechnen.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
    { law:"BBiG", para:"¬ß 17", tags:["verg√ºtung","miav"], excerpt:"¬ß 17 BBiG ‚Äì Angemessene Verg√ºtung; Mindestausbildungsverg√ºtung als Untergrenze.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
    { law:"JArbSchG", para:"¬ß 8‚Äì15", tags:["arbeitszeit","ruhezeit","pausen"], excerpt:"JArbSchG ‚Äì T√§gliche und w√∂chentliche H√∂chstarbeitszeiten; Ruhepausen; Ruhezeit mind. 12 Std.", link:"https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" },
    { law:"ArbZG", para:"¬ß 3, ¬ß 4, ¬ß 5", tags:["erwachsene","arbeitszeit","pausen","ruhezeit"], excerpt:"ArbZG ‚Äì 8 Std/Tag (bis 10 mit Ausgleich), Pausen 30‚Äì45 Min, Ruhezeit 11 Std.", link:"https://www.gesetze-im-internet.de/arbzg/BJNR117100994.html" },
  ];

  // State
  let accepted = false;
  let examMode = false;
  let examCountdown = null;
  let examTick = null;
  let pool = [...QUESTIONS_ALL];
  let answers = {};
  let selected = {};
  let rubrics = {};
  let rubricChart = null;

  // DOM Elements
  const passwordScreen = document.getElementById("passwordScreen");
  const passwordForm = document.getElementById("passwordForm");
  const passwordInput = document.getElementById("passwordInput");
  const passwordError = document.getElementById("passwordError");
  const mainApp = document.getElementById("mainApp");

  const form = document.getElementById("form");
  const progressBar = document.getElementById("progressBar");
  const progressTxt = document.getElementById("progressText");
  const selText = document.getElementById("selText");
  const submitBtn = document.getElementById("submitBtn");
  const resetBtn = document.getElementById("resetBtn");
  const timerEl = document.getElementById("timer");
  const resultWrap = document.getElementById("resultWrap");
  const aiResult = document.getElementById("aiResult");

  const ack = document.getElementById("ack");
  const ackBtn = document.getElementById("ackBtn");
  const notice = document.getElementById("notice");
  const ackState = document.getElementById("ackState");

  const examToggle = document.getElementById("examToggle");
  const examSize = document.getElementById("examSize");
  const examTimer = document.getElementById("examTimer");

  const quickBtn = document.getElementById("quickBtn");
  const qlBackdrop = document.getElementById("qlBackdrop");
  const qlModal = document.getElementById("qlModal");
  const qlClose = document.getElementById("qlClose");
  const qlSearch = document.getElementById("qlSearch");
  const qlList = document.getElementById("qlList");

  const historyBtn = document.getElementById("historyBtn");
  const historyBackdrop = document.getElementById("historyBackdrop");
  const historyModal = document.getElementById("historyModal");
  const historyClose = document.getElementById("historyClose");
  const historyList = document.getElementById("historyList");

  const themeToggle = document.getElementById("themeToggle");
  const toastEl = document.getElementById("toast");

  const apiStatusDot = document.getElementById("apiStatusDot");
  const apiStatusText = document.getElementById("apiStatusText");

  const chartSection = document.getElementById("chartSection");
  const rubricChartCanvas = document.getElementById("rubricChart");

  // Initialize
  document.addEventListener("DOMContentLoaded", () => {
    if (window.lucide) lucide.createIcons();
    if (window.marked) marked.setOptions({ breaks: true, gfm: true });

    // Check authentication
    const isAuthenticated = sessionStorage.getItem("bbig_authenticated");
    if (isAuthenticated === "true") {
      passwordScreen.style.display = "none";
      mainApp.style.display = "block";
      initApp();
    } else {
      setTimeout(() => passwordInput.focus(), 100);
    }
  });

  // Password Protection
  passwordForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const enteredPassword = passwordInput.value.trim();
    
    if (enteredPassword === PASSWORD) {
      sessionStorage.setItem("bbig_authenticated", "true");
      passwordScreen.style.display = "none";
      mainApp.style.display = "block";
      passwordError.classList.add("hidden");
      initApp();
    } else {
      passwordError.classList.remove("hidden");
      passwordInput.value = "";
      passwordInput.focus();
      passwordForm.style.animation = "shake 0.5s";
      setTimeout(() => passwordForm.style.animation = "", 500);
    }
  });

  function initApp() {
    // Re-initialize Lucide icons
    if (window.lucide) lucide.createIcons();
    
    // Load theme
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.documentElement.classList.add("dark");
    }

    // Theme toggle
    themeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      const isDark = document.documentElement.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      if (rubricChart) updateSpiderChart();
    });

    // API Status
    async function checkAPIStatus() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(relay, {
          method: 'HEAD',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        apiStatusDot.className = "status-dot status-online";
        apiStatusText.textContent = "API: Online";
      } catch (error) {
        apiStatusDot.className = "status-dot status-offline";
        apiStatusText.textContent = "API: Offline";
      }
    }

    checkAPIStatus();
    setInterval(checkAPIStatus, 60000);

    // Timer
    let startTs = Date.now();
    setInterval(() => {
      const s = Math.floor((Date.now() - startTs) / 1000);
      const m = String(Math.floor(s / 60)).padStart(2, "0");
      const r = String(s % 60).padStart(2, "0");
      timerEl.textContent = `${m}:${r}`;
    }, 1000);

    // Load state
    loadState();

    // Disclaimer
    ackBtn.addEventListener("click", () => {
      if (!ack.checked) {
        showToast("‚ùå Bitte die Checkbox best√§tigen.");
        return;
      }
      accepted = true;
      notice.style.display = "none";
      ackState.textContent = "‚úì Best√§tigt";
      ackState.className = "chip";
      ackState.style.background = "#dcfce7";
      ackState.style.color = "#166534";
      ackState.style.borderColor = "#bbf7d0";
      saveState();
    });

    // Exam mode
    examToggle.addEventListener("change", () => setExamMode(examToggle.checked));
    examSize.addEventListener("change", () => {
      if (examMode) {
        applyExamSizing();
        renderForm();
        const mins = Math.ceil(pool.length * 1.5);
        startCountdown(mins * 60);
      }
    });

    function setExamMode(on) {
      examMode = !!on;
      document.getElementById("examToggleWrap").classList.toggle("exam-on", examMode);
      applyExamSizing();
      renderForm();
      updateProgress();
      if (examMode) {
        const mins = Math.ceil(pool.length * 1.5);
        startCountdown(mins * 60);
        showToast(`‚è±Ô∏è Pr√ºfungsmodus: ${mins} Minuten Zeit`);
      } else {
        stopCountdown();
      }
      saveState();
    }

    function startCountdown(seconds) {
      examCountdown = seconds;
      updateCountdownLabel();
      clearInterval(examTick);
      examTick = setInterval(() => {
        examCountdown = Math.max(0, examCountdown - 1);
        updateCountdownLabel();
        if (examCountdown === 0) {
          clearInterval(examTick);
          showToast("‚è∞ Zeit abgelaufen ‚Äì bitte abgeben!");
        }
      }, 1000);
    }

    function stopCountdown() {
      clearInterval(examTick);
      examTick = null;
      examTimer.textContent = "‚Äî";
    }

    function updateCountdownLabel() {
      const m = String(Math.floor(examCountdown / 60)).padStart(2, "0");
      const s = String(examCountdown % 60).padStart(2, "0");
      examTimer.textContent = `${m}:${s}`;
      
      if (examCountdown < 300 && examCountdown > 0) {
        examTimer.style.color = "#dc2626";
      } else {
        examTimer.style.color = "";
      }
    }

    function applyExamSizing() {
      const size = Number(examSize.value) || 20;
      const shuffled = [...QUESTIONS_ALL].sort(() => Math.random() - 0.5);
      pool = shuffled.slice(0, Math.min(size, QUESTIONS_ALL.length));
    }

    // Autosize
    function autosize(el) {
      el.style.height = "auto";
      el.style.height = (el.scrollHeight + 4) + "px";
    }

    // Form render
    function renderForm() {
      [...form.querySelectorAll("section[data-ref]")].forEach(sec => {
        const ref = sec.getAttribute("data-ref");
        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answers[ref] = ta.value;
        if (cb) selected[ref] = cb.checked;
      });

      form.innerHTML = "";
      pool.forEach((item, idx) => {
        const id = `q_${idx}`, fbId = `fb_${idx}`, selId = `sel_${idx}`;
        const sec = document.createElement("section");
        sec.className = "card p-4";
        sec.setAttribute("data-ref", item.ref);

        const tipHtml = `
          <details class="tip mb-2" ${examMode ? "open hidden" : ""}>
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-sky-700 hover:text-sky-900 text-[13px]">
              <i class="chev transition-transform" data-lucide="chevron-down"></i><span>üõà Musterl√∂sung</span>
            </summary>
            <div class="mt-2">${(item.tip || []).map(t => `<p>${t}</p>`).join("")}</div>
          </details>`;

        const r = rubrics[item.ref] || { normbezug: 0, vollstaendigkeit: 0, praxisbezug: 0 };
        const sum = r.normbezug + r.vollstaendigkeit + r.praxisbezug;
        const rubricHtml = `
          <details class="mb-2">
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-slate-700 hover:text-slate-900 text-[13px]">
              <i class="transition-transform" data-lucide="bar-chart-3" class="w-4 h-4"></i><span>Rubrik anzeigen (Punkte: <strong>${sum}/6</strong>)</span>
            </summary>
            <div class="rubric mt-2 space-y-3">
              ${renderRubricRow("Normbezug", "normbezug", r.normbezug)}
              ${renderRubricRow("Vollst√§ndigkeit", "vollstaendigkeit", r.vollstaendigkeit)}
              ${renderRubricRow("Praxisbezug", "praxisbezug", r.praxisbezug)}
            </div>
          </details>`;
          
        function renderRubricRow(label, key, val) {
          const pct = Math.round((val / 2) * 100);
          return `
            <div>
              <div class="flex justify-between text-xs mb-1"><span>${label}</span><span>${val}/2</span></div>
              <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
            </div>`;
        }

        sec.innerHTML = `
          <header class="flex items-center justify-between gap-3 mb-2">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-sky-600" data-select="${idx}" aria-label="F√ºr KI-Feedback ausw√§hlen">
              <span class="q-badge chip">${item.ref}</span>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="btn btn-sm" data-quicklook="${idx}" title="¬ß-Quicklook zu dieser Frage">
                <i data-lucide="search" class="w-4 h-4"></i> ¬ß Quicklook
              </button>
              <span class="text-slate-400 text-[11px]">Frage ${idx + 1}/${pool.length}</span>
            </div>
          </header>

          <h3 class="text-[15px] sm:text-[16px] font-semibold mb-2">${item.q}</h3>
          ${tipHtml}

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px] transition-all" placeholder="Deine Antwort ‚Ä¶"></textarea>

          <div class="mt-2 flex flex-wrap gap-2">
            <button type="button" data-fill="${id}" class="btn btn-sm">Beispiel-Gliederung</button>
            <button type="button" data-ask="${idx}" class="btn btn-sm ${examMode ? 'opacity-50 pointer-events-none' : ''}">
              <i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check (Rubrik)
            </button>
          </div>

          ${rubricHtml}

          <div id="${fbId}" class="prose prose-slate text-sm max-w-none hidden mt-2"></div>
        `;
        form.appendChild(sec);

        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector(`[data-select]`);
        const saved = answers[item.ref] || "";
        ta.value = saved;
        autosize(ta);
        if (selected[item.ref] != null) cb.checked = !!selected[item.ref];
      });

      // Events
      form.querySelectorAll("textarea").forEach(ta => {
        ta.addEventListener("input", () => {
          autosize(ta);
          updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          answers[ref] = ta.value;
          saveStateSchedule();
        });
        ta.addEventListener("keydown", (ev) => {
          if ((ev.ctrlKey || ev.metaKey) && ev.key === "Enter") {
            ev.preventDefault();
            submitBtn.click();
          }
        });
      });
      
      form.querySelectorAll("[data-fill]").forEach(btn => {
        btn.addEventListener("click", e => {
          const tid = e.currentTarget.getAttribute("data-fill");
          const ta = document.getElementById(tid);
          ta.value = ["### Kurzantwort","- ‚Ä¶","- ‚Ä¶","- ‚Ä¶","","### Begr√ºndung/Norm (optional)","- ‚Ä¶"].join("\n");
          autosize(ta);
          updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          answers[ref] = ta.value;
          saveStateSchedule();
        });
      });
      
      form.querySelectorAll("[data-ask]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          if (!relay) {
            showToast("Kein Backend konfiguriert.");
            return;
          }
          if (!accepted) {
            showToast("Bitte zuerst den Hinweis best√§tigen.");
            return;
          }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });
      
      form.querySelectorAll("[data-select]").forEach(cb => {
        cb.addEventListener("change", (e) => {
          const ref = e.currentTarget.closest("section[data-ref]")?.getAttribute("data-ref");
          selected[ref] = e.currentTarget.checked;
          updateSelCount();
          saveStateSchedule();
        });
      });
      
      form.querySelectorAll("[data-quicklook]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const idx = Number(e.currentTarget.getAttribute("data-quicklook"));
          openQuicklookFor(pool[idx]);
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelCount();
      updateProgress();
    }

    function updateSelCount() {
      const n = [...form.querySelectorAll("[data-select]:checked")].length;
      selText.textContent = `${n} ausgew√§hlt`;
    }
    
    function updateProgress() {
      const t = [...form.querySelectorAll("textarea")];
      const f = t.filter(x => x.value.trim().length > 0).length;
      const total = t.length || 1;
      progressBar.style.width = Math.round((f / total) * 100) + "%";
      progressTxt.textContent = `${f} / ${total} beantwortet`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuemax", String(total));
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuenow", String(f));
    }

    // Skeleton Loader
    function showSkeleton(container) {
      container.innerHTML = `
        <div class="space-y-3">
          <div class="h-4 skeleton"></div>
          <div class="h-4 skeleton" style="width:80%"></div>
          <div class="h-4 skeleton" style="width:60%"></div>
        </div>
      `;
    }

    // KI-Prompting
    function buildPromptSingle(item, answer) {
      return `
Bewerte **wohlwollend** eine Kurzantwort (Ausbildung/Arbeitsrecht). Wenn die Soll-Anzahl erreicht ist: ‚Äûpasst", danach optional erg√§nzen.

Gib zuerst **JSON** ausschlie√ülich mit folgendem Schema (keine Einleitung, kein Codeblock!):
{"rubrik":{"normbezug":0..2,"vollstaendigkeit":0..2,"praxisbezug":0..2},"kommentar":"kurzes Feedback (1-2 S√§tze)","loesung":["max. 4 Stichpunkte"],"gesetz":"¬ß/Gesetz","praxistipp":"ein Satz"}

Danach (unterhalb der JSON-Ausgabe) darfst du zus√§tzlich eine kurze Markdown-Auswertung schreiben.

Frage: ${item.q}
Antwort TN: ${answer || "(leer)"} `.trim();
    }

    async function callAI(payload, { timeoutMs = 25000, retries = 1 } = {}) {
      const url = relay;
      let lastErr;
      for (let a = 0; a <= retries; a++) {
        try {
          const res = await Promise.race([
            fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }),
            new Promise((_, rej) => setTimeout(() => rej.new Error("Timeout")), timeoutMs))
          ]);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const t = await res.text();
          try {
            const j = JSON.parse(t);
            return j.answer || j.content || j.result || t;
          } catch {
            return t;
          }
        } catch (e) {
          lastErr = e;
        }
      }
      throw lastErr || new Error("Unbekannter Fehler");
    }

    async function askPerAnswer(idx, btnEl) {
      const item = pool[idx];
      const ref = item.ref;
      const val = (answers[ref] || "").trim().slice(0, MAX_ANSWER_CHARS);
      const fb = form.querySelectorAll("[id^='fb_']")[idx];

      btnEl.disabled = true;
      const old = btnEl.innerHTML;
      btnEl.innerHTML = `<div class="animate-pulse">‚è≥ Pr√ºfen‚Ä¶</div>`;
      fb.classList.remove("hidden");
      showSkeleton(fb);

      try {
        const prompt = buildPromptSingle(item, val);
        const aiText = await callAI({ prompt });
        const jsonMatch = aiText.match(/\{[\s\S]*?\}/);
        if (jsonMatch) {
          try {
            const obj = JSON.parse(jsonMatch[0]);
            const rr = (obj.rubrik || {});
            rubrics[ref] = {
              normbezug: clamp(Number(rr.normbezug) || 0, 0, 2),
              vollstaendigkeit: clamp(Number(rr.vollstaendigkeit) || 0, 0, 2),
              praxisbezug: clamp(Number(rr.praxisbezug) || 0, 0, 2),
            };
            saveStateSchedule();
            const sec = form.querySelector(`section[data-ref="${CSS.escape(ref)}"]`);
            if (sec) {
              const y = window.scrollY;
              renderForm();
              window.scrollTo(0, y);
            }
          } catch (e) {
            console.error('JSON parse error:', e);
          }
        }
        fb.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
      } catch (e) {
        fb.innerHTML = `<div class="text-red-600 text-sm">KI-Check fehlgeschlagen (${String(e).replace(/[<>&]/g, "")}).</div>`;
        showToast("KI-Check fehlgeschlagen.");
      } finally {
        btnEl.disabled = false;
        btnEl.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }
    }

    function clamp(x, min, max) {
      return Math.max(min, Math.min(max, x));
    }

    // Gesamtfeedback
    document.getElementById("submitBtn").addEventListener("click", async () => {
      if (!accepted) {
        showToast("Bitte zuerst den Hinweis best√§tigen.");
        return;
      }
      let idxs = [...form.querySelectorAll("[data-select]:checked")].map((cb) => {
        const card = cb.closest("section");
        return [...form.children].indexOf(card);
      });
      if (idxs.length === 0) {
        const withContent = pool.map((q, i) => ({ i, has: (answers[q.ref] || "").trim().length > 0 })).filter(x => x.has).map(x => x.i);
        idxs = withContent.length ? withContent : pool.map((_, i) => i);
      }
      const answersSlice = idxs.map(i => {
        const ref = pool[i].ref;
        const v = (answers[ref] || "").trim().slice(0, MAX_ANSWER_CHARS);
        return { nr: i + 1, ref, question: pool[i].q, answer: v };
      });

      const prompt = `
Bewerte **wohlwollend** mehrere Kurzantworten (Ausbildung/Arbeitsrecht) und liefere je Frage zuerst **JSON** nach Schema:
{"rubrik":{"normbezug":0..2,"vollstaendigkeit":0..2,"praxisbezug":0..2},"kommentar":"1-2 S√§tze (Sag ‚Äûpasst", wenn Soll-Anzahl erf√ºllt)","loesung":["max. 4 Stichpunkte"],"gesetz":"¬ß/Gesetz","praxistipp":"ein Satz"}

Danach darf eine kurze Markdown-Zusammenfassung folgen.

Fragen & Antworten:
${answersSlice.map(a => `Q${a.nr} (${a.ref}): ${a.question}\nAntwort TN: ${a.answer || "(leer)"}`).join("\n\n")}
      `.trim();

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = `<div class="text-slate-500 text-sm">KI erstellt Feedback‚Ä¶</div>`;
      submitBtn.disabled = true;
      const old = submitBtn.innerHTML;
      submitBtn.innerHTML = `<div class="animate-pulse">‚è≥ Pr√ºfen‚Ä¶</div>`;

      try {
        const aiText = await callAI({ prompt });
        aiResult.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
        
        // Save to history
        saveToHistory();
        
        // Update spider chart
        updateSpiderChart();
        
        // Confetti if good score
        const totalScore = Object.values(rubrics).reduce((sum, r) => sum + (r.normbezug || 0) + (r.vollstaendigkeit || 0) + (r.praxisbezug || 0), 0);
        const maxScore = Object.keys(rubrics).length * 6;
        if (maxScore > 0 && (totalScore / maxScore) > 0.7) {
          confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }
      } catch (e) {
        aiResult.innerHTML = `<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g, "")}).</div>`;
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }

      if (examMode) {
        form.querySelectorAll(".tip").forEach(t => t.classList.remove("hidden"));
      }
    });

    // Reset
    resetBtn.addEventListener("click", () => {
      if (!confirm("Alles l√∂schen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      answers = {};
      selected = {};
      rubrics = {};
      pool = [...QUESTIONS_ALL];
      examToggle.checked = false;
      setExamMode(false);
      renderForm();
      resultWrap.classList.add("hidden");
      aiResult.innerHTML = "";
      chartSection.style.display = "none";
      if (rubricChart) rubricChart.destroy();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Quicklook
    function openQuicklook() {
      qlBackdrop.classList.add("open");
      qlModal.classList.add("open");
      qlSearch.value = "";
      renderQuicklook("");
      qlSearch.focus();
    }

    function closeQuicklook() {
      qlBackdrop.classList.remove("open");
      qlModal.classList.remove("open");
    }

    quickBtn.addEventListener("click", openQuicklook);
    qlBackdrop.addEventListener("click", closeQuicklook);
    qlClose.addEventListener("click", closeQuicklook);
    qlSearch.addEventListener("input", (e) => renderQuicklook(e.target.value));

    function openQuicklookFor(item) {
      openQuicklook();
      const terms = (item.q + " " + (item.tip || []).join(" ")).toLowerCase();
      const keys = ["¬ß", "probezeit", "ruhezeit", "verg√ºtung", "freistellung", "ausbildungsordnung", "ausbildungsplan", "k√ºndigung", "ausland", "berichtsheft"];
      const hit = keys.find(k => terms.includes(k));
      qlSearch.value = hit || "";
      renderQuicklook(qlSearch.value);
    }

    function renderQuicklook(query) {
      const q = (query || "").trim().toLowerCase();
      const list = (q ? LAW_INDEX.filter(x =>
        x.para.toLowerCase().includes(q) ||
        x.law.toLowerCase().includes(q) ||
        x.tags.some(t => t.includes(q))
      ) : LAW_INDEX);
      qlList.innerHTML = "";
      if (list.length === 0) {
        qlList.innerHTML = `<div class="text-sm text-slate-500">Keine Treffer. Probiere ‚Äû¬ß11", ‚ÄûProbezeit", ‚ÄûRuhezeit" ‚Ä¶</div>`;
        return;
      }
      list.forEach(x => {
        const row = document.createElement("div");
        row.className = "p-3 rounded-lg border hover:bg-slate-50";
        row.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${x.law} ${x.para}</div>
            <a class="btn btn-sm" href="${x.link}" target="_blank" rel="noopener">PDF √∂ffnen</a>
          </div>
          <div class="text-sm text-slate-600 mt-1">${x.excerpt}</div>
          <div class="mt-1 flex flex-wrap gap-1">${x.tags.map(t => `<span class="chip">${t}</span>`).join("")}</div>
        `;
        qlList.appendChild(row);
      });
    }

    // History
    function saveToHistory() {
      try {
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        const totalScore = Object.values(rubrics).reduce((sum, r) => 
          sum + (r.normbezug || 0) + (r.vollstaendigkeit || 0) + (r.praxisbezug || 0), 0
        );
        
        history.unshift({
          ts: Date.now(),
          answers: { ...answers },
          rubrics: { ...rubrics },
          totalScore,
          questionsCount: Object.keys(answers).filter(k => answers[k].trim()).length
        });
        
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
      } catch (e) {
        console.error('Error saving history:', e);
      }
    }

    function loadHistory() {
      try {
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        historyList.innerHTML = "";
        
        if (history.length === 0) {
          historyList.innerHTML = '<div class="text-sm text-slate-500 text-center py-8">Keine Historie vorhanden</div>';
          return;
        }

        history.forEach((entry, idx) => {
          const date = new Date(entry.ts);
          const dateStr = date.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          const maxScore = entry.questionsCount * 6;
          const percentage = maxScore > 0 ? Math.round((entry.totalScore / maxScore) * 100) : 0;

          const card = document.createElement('div');
          card.className = 'card p-4 hover:shadow-lg transition-all cursor-pointer';
          card.innerHTML = `
            <div class="flex items-center justify-between gap-4">
              <div class="flex-1">
                <div class="font-semibold text-sm mb-1">${dateStr}</div>
                <div class="text-xs text-slate-500">${entry.questionsCount} Fragen bearbeitet</div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold" style="color: var(--brand);">${entry.totalScore}/${maxScore}</div>
                <div class="text-xs text-slate-500">${percentage}% erreicht</div>
              </div>
            </div>
          `;
          
          card.addEventListener('click', () => {
            if (confirm('M√∂chtest du diesen Versuch laden? Aktuelle Antworten werden √ºberschrieben.')) {
              answers = { ...entry.answers };
              rubrics = { ...entry.rubrics };
              renderForm();
              updateSpiderChart();
              closeHistory();
              showToast('‚úì Versuch geladen');
            }
          });
          
          historyList.appendChild(card);
        });
      } catch (e) {
        console.error('Error loading history:', e);
        historyList.innerHTML = '<div class="text-sm text-red-500 text-center py-8">Fehler beim Laden der Historie</div>';
      }
    }

    historyBtn.addEventListener('click', () => {
      loadHistory();
      historyBackdrop.classList.add('open');
      historyModal.classList.add('open');
    });

    function closeHistory() {
      historyBackdrop.classList.remove('open');
      historyModal.classList.remove('open');
    }

    historyBackdrop.addEventListener('click', closeHistory);
    historyClose.addEventListener('click', closeHistory);

    // Spider Chart
    function updateSpiderChart() {
      const entries = Object.entries(rubrics);
      if (entries.length === 0) {
        chartSection.style.display = "none";
        return;
      }

      const avgRubric = entries.reduce((acc, [ref, r]) => {
        acc.normbezug += r.normbezug || 0;
        acc.vollstaendigkeit += r.vollstaendigkeit || 0;
        acc.praxisbezug += r.praxisbezug || 0;
        acc.count++;
        return acc;
      }, { normbezug: 0, vollstaendigkeit: 0, praxisbezug: 0, count: 0 });

      const count = avgRubric.count || 1;

      chartSection.style.display = "block";

      const isDark = document.documentElement.classList.contains('dark');
      const textColor = isDark ? '#e5e7eb' : '#1a1a1a';
      const gridColor = isDark ? '#1f2937' : '#e5e7eb';

      const data = {
        labels: ['Normbezug', 'Vollst√§ndigkeit', 'Praxisbezug'],
        datasets: [{
          label: 'Durchschnitt',
          data: [
            (avgRubric.normbezug / count).toFixed(1),
            (avgRubric.vollstaendigkeit / count).toFixed(1),
            (avgRubric.praxisbezug / count).toFixed(1)
          ],
          backgroundColor: 'rgba(0, 102, 204, 0.15)',
          borderColor: '#0066cc',
          borderWidth: 2,
          pointBackgroundColor: '#0066cc',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: '#0066cc',
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      };

      if (rubricChart) {
        rubricChart.destroy();
      }

      rubricChart = new Chart(rubricChartCanvas, {
        type: 'radar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 2,
              ticks: {
                stepSize: 0.5,
                color: textColor,
                backdropColor: 'transparent',
                font: {
                  size: 11
                }
              },
              grid: {
                color: gridColor
              },
              pointLabels: {
                color: textColor,
                font: {
                  size: 12,
                  weight: '500'
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: isDark ? '#1e293b' : '#ffffff',
              titleColor: textColor,
              bodyColor: textColor,
              borderColor: gridColor,
              borderWidth: 1,
              padding: 12,
              boxPadding: 6,
              usePointStyle: true
            }
          }
        }
      });
    }

    // Toast
    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.style.display = "none", 2800);
    }

    // Save/Load
    let saveTimer = null;
    function saveState() {
      try {
        const state = {
          ts: Date.now(),
          accepted,
          examMode,
          examSize: examSize.value,
          answers,
          selected,
          rubrics,
          poolRefs: pool.map(p => p.ref)
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Error saving state:', e);
      }
    }

    function saveStateSchedule() {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveState, 500);
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const st = JSON.parse(raw);
        accepted = !!st.accepted;
        if (accepted) {
          notice.style.display = "none";
          ack.checked = true;
          ackState.textContent = "‚úì Best√§tigt";
          ackState.className = "chip";
          ackState.style.background = "#dcfce7";
          ackState.style.color = "#166534";
          ackState.style.borderColor = "#bbf7d0";
        }
        examToggle.checked = !!st.examMode;
        examSize.value = st.examSize || "20";
        answers = st.answers || {};
        selected = st.selected || {};
        rubrics = st.rubrics || {};
        
        if (Array.isArray(st.poolRefs) && st.poolRefs.length) {
          const map = Object.fromEntries(QUESTIONS_ALL.map(q => [q.ref, q]));
          pool = st.poolRefs.map(r => map[r]).filter(Boolean);
        } else {
          pool = [...QUESTIONS_ALL];
        }
        
        if (examToggle.checked) {
          setExamMode(true);
        }
        
        updateSpiderChart();
      } catch (e) {
        console.error('Error loading state:', e);
      }
    }

    // Initial render
    renderForm();
  }

})();
</script>
</body>
</html>
