<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz â€“ Linda (Interaktiv)</title>

  <!-- External -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{
      --primary:#2563eb; --primary2:#0ea5e9; --accent:#22c55e;
      --surface:#ffffff; --surface2:#f7f8fb; --surface3:#eef2f7;
      --ink:#0f172a; --muted:#64748b; --border:#e2e8f0;
      --radius:14px; --pill:999px;
    }
    html.dark{
      --surface:#0b1220; --surface2:#0f172a; --surface3:#111827;
      --ink:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
    }
    html,body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;background:var(--surface2);color:var(--ink);font-size:14px;line-height:1.5}
    .container{max-width:1120px;margin-inline:auto;padding-inline:16px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:var(--surface);font-weight:600}
    .btn:hover{background:var(--surface3)}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-sm{padding:6px 10px;font-size:12px}
    .btn-ghost{border-color:transparent;background:transparent}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);border-radius:999px;background:var(--surface3);color:var(--muted);font-size:11px;font-weight:700}
    .badge-primary{background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.25);color:#0b3b8a}
    .progress-outer{height:8px;border-radius:999px;background:var(--surface3);overflow:hidden;border:1px solid var(--border)}
    .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--primary2));transition:width .3s}
    .tabs{display:flex;gap:.5rem;overflow:auto;scrollbar-width:none}
    .tabs::-webkit-scrollbar{display:none}
    .tab{padding:.55rem .9rem;border:1px solid var(--border);border-radius:999px;background:#fff;display:flex;align-items:center;gap:.55rem;font-weight:700;white-space:nowrap}
    .tab[aria-selected="true"]{background:rgba(37,99,235,.08);border-color:rgba(37,99,235,.25);color:#0b3b8a}
    #clusterSelect{display:none}
    @media (max-width:720px){.tabs{display:none}#clusterSelect{display:block}}
    .q-card{position:relative;padding:16px}
    .tip{margin-top:.5rem;background:linear-gradient(180deg,rgba(37,99,235,.08),rgba(14,165,233,.08));border-left:3px solid var(--primary);padding:.8rem .9rem;border-radius:12px}
    .sticky-actions{position:sticky;bottom:0;z-index:40}
    .notice{background:linear-gradient(135deg,#eaf2ff,#e6fbff);border-bottom:1px solid #cfe3ff}
    .app-header{position:sticky;top:0;z-index:30;background:color-mix(in srgb,var(--surface) 88%,transparent);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}

    /* Intro (leicht) */
    .intro{position:fixed;inset:0;z-index:1000;display:flex;align-items:center;justify-content:center;padding:24px;background:radial-gradient(1200px 600px at 10% 0%, rgba(37,99,235,.15), transparent 60%),radial-gradient(1000px 600px at 90% 90%, rgba(14,165,233,.18), transparent 60%),linear-gradient(180deg,#0b1220 0%,#0c1633 50%,#0b1220 100%);color:#eaf2ff}
    html.dark .intro{background:linear-gradient(180deg,#020617,#030a1a)}
    .glass{width:min(980px,96vw);border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);backdrop-filter:blur(14px);border-radius:22px;box-shadow:0 10px 50px rgba(0,0,0,.35);overflow:hidden}
    .intro-head{display:flex;align-items:center;gap:12px;padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.12)}
    .intro-grid{display:grid;grid-template-columns:1.15fr .85fr;gap:16px;padding:18px}
    @media (max-width:920px){.intro-grid{grid-template-columns:1fr}}
    .intro h1{font-size:26px;line-height:1.15;margin-bottom:8px}
    .lead{color:#bdd3ff;font-size:14px}
    .cta{display:inline-flex;align-items:center;gap:10px;padding:12px 16px;border-radius:14px;font-weight:800;background:#22c55e;color:#0b1220;border:1px solid #22c55e}
    .intro.fadeout{animation:fade .45s ease forwards}
    @keyframes fade{to{opacity:0;visibility:hidden}}

    /* Linda Avatar & Chat */
    #lindaBtn{position:fixed;bottom:16px;right:16px;width:64px;height:64px;z-index:60;border:none;background:transparent;cursor:pointer}
    #lindaChat{position:fixed;bottom:96px;right:16px;width:min(92vw,360px);height:420px;z-index:60;display:none}
    .l-wrap{background:var(--surface);color:var(--ink);border:1px solid var(--border);border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.2);display:flex;flex-direction:column;height:100%}
    .l-drag{cursor:move;padding:10px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);user-select:none}
    .l-body{flex:1;overflow:auto;padding:10px 12px}
    .l-msg{font-size:13px;padding:8px 10px;border-radius:12px;margin:6px 0;max-width:85%}
    .l-msg.me{background:#e5f0ff;margin-left:auto}
    .l-msg.ai{background:#eef6ff}
    .l-input{display:flex;gap:6px;padding:10px;border-top:1px solid var(--border)}
    .l-input input{flex:1;border:1px solid var(--border);border-radius:12px;padding:10px 12px;background:var(--surface)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--surface3);font-size:12px;font-weight:600;cursor:pointer}
    .chip:hover{background:var(--surface)}

    /* Footer (Arial 10) */
    footer.app-footer{font-family:Arial,Helvetica,sans-serif;font-size:10px;line-height:1.4;color:#4b5563;background:#eef2f6;border-top:1px solid var(--border)}
  </style>
</head>
<body>

<!-- Intro -->
<section id="intro" class="intro" role="dialog" aria-modal="true">
  <div class="glass">
    <div class="intro-head">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[color:var(--primary)] to-[color:var(--primary2)] grid place-items-center shadow">
        <i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i>
      </div>
      <div>
        <div class="font-bold">BBiG-Quiz â€¢ Lernmodus</div>
        <div class="text-xs" style="color:#c9dafc">Kurze Antworten. Wohlwollendes Feedback. Mobilfreundlich.</div>
      </div>
      <div class="ml-auto flex items-center gap-3">
        <button id="introTheme" type="button" class="btn btn-ghost btn-sm" style="color:#eaf2ff"><i data-lucide="moon" class="w-4 h-4"></i> Theme</button>
      </div>
    </div>

    <div class="intro-grid">
      <div class="p-5">
        <h1>SchÃ¶n, dass du das BBiG-Quiz testest!</h1>
        <p class="lead">
          Das Quiz ist in <strong>Clustern</strong> aufgebaut. WÃ¤hle ein Gebiet, beantworte ausgewÃ¤hlte oder alle Fragen â€“
          das <strong>Feedback</strong> bezieht sich immer auf die von dir beantworteten Fragen.
          Das Feedback kommt von <strong>Linda</strong> (KI). <em>Bitte prÃ¼fe Antworten stets â€“ KI kann Fehler machen.</em>
        </p>

        <div class="mt-4 text-xs leading-relaxed">
          <label class="inline-flex items-start gap-2"><input id="introAck" type="checkbox" class="mt-0.5 w-4 h-4 accent-[#22c55e]">
            <span>Ich akzeptiere: keine personenbezogenen/sensiblen Daten; KI kann Fehler machen; alles ist zu prÃ¼fen; keine HaftungsansprÃ¼che.</span>
          </label>
        </div>

        <div class="flex items-center gap-2 mt-4">
          <button id="introStart" type="button" class="cta" disabled><i data-lucide="play" class="w-4 h-4"></i> Los gehtâ€™s</button>
          <button id="introSkipNow" type="button" class="btn btn-ghost btn-sm" disabled>Ãœberspringen</button>
        </div>
      </div>

      <div class="p-5">
        <div class="text-sm" style="color:#cfe0ff">
          <strong>Quick-Tipps:</strong>
          <ul class="list-disc ml-5 mt-2 space-y-1">
            <li>Mit â€ž?â€œ Ã¶ffnest du den <em>Â§-Quicklook</em>.</li>
            <li>BBiG/JArbSchG findest du immer unten rechts.</li>
            <li>Auf MobilgerÃ¤ten nutzt du das Cluster-Dropdown.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Hinweis -->
<aside id="notice" class="notice">
  <div class="container px-4 py-3 flex items-start gap-3">
    <div class="w-10 h-10 rounded-lg bg-white/70 grid place-items-center">
      <i data-lucide="shield-check" class="w-6 h-6 text-blue-600"></i>
    </div>
    <div class="text-sm leading-snug">
      <p class="font-semibold text-slate-800">Fachlicher Hinweis (Pilot)</p>
      <p class="text-slate-700">
        Die KI-PrÃ¼fung unterstÃ¼tzt beim Lernen. Ergebnisse sind zu prÃ¼fen; keine Rechtsberatung.
        <strong>Es dÃ¼rfen keine personenbezogenen oder sensiblen Daten eingegeben werden.</strong>
      </p>
      <label class="mt-2 inline-flex items-center gap-2">
        <input id="ack" type="checkbox" class="w-4 h-4 accent-blue-600">
        <span class="text-slate-700">Ich habe den Hinweis gelesen.</span>
      </label>
    </div>
    <div class="ml-auto flex items-center gap-2">
      <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener"><i data-lucide="book-open" class="w-4 h-4"></i> BBiG</a>
      <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener"><i data-lucide="shield" class="w-4 h-4"></i> JArbSchG</a>
      <span id="ackState" class="badge">Hinweis offen</span>
      <button id="ackBtn" type="button" class="btn btn-primary btn-sm"><i data-lucide="check" class="w-4 h-4"></i> Weiter</button>
    </div>
  </div>
</aside>

<!-- Header -->
<header class="app-header">
  <div class="container px-4 py-3 flex flex-wrap items-center gap-3 justify-between">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-sky-500 grid place-items-center shadow">
        <i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i>
      </div>
      <div>
        <h1 class="text-lg sm:text-xl font-semibold">BBiG-Quiz â€“ Cluster</h1>
        <p class="text-xs text-slate-500">Wohlwollendes KI-Feedback â€¢ Â§-Quicklook â€¢ Autosave</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <button id="quickBtn" type="button" class="btn btn-sm"><i data-lucide="search" class="w-4 h-4"></i> Â§-Quicklook</button>
      <button id="themeToggle" type="button" class="btn btn-ghost btn-sm" title="Theme"><i data-lucide="moon" class="w-4 h-4"></i></button>
    </div>
  </div>

  <!-- Cluster Tabs -->
  <div class="container pb-3">
    <div class="card p-3">
      <div id="tabs" class="tabs" role="tablist" aria-label="Cluster"></div>
      <select id="clusterSelect" class="mt-2 w-full rounded-xl border px-3 py-2 text-sm"></select>
    </div>
  </div>
</header>

<!-- Progress -->
<section class="container mt-4">
  <div class="card p-4 flex items-center gap-3">
    <i data-lucide="target" class="w-5 h-5 text-blue-600"></i>
    <div class="flex-1">
      <div class="flex justify-between text-[11px] text-slate-500 font-semibold mb-2">
        <span id="progressText">0 / 0 beantwortet</span>
        <span id="selText">0 ausgewÃ¤hlt</span>
      </div>
      <div class="progress-outer"><div id="progressBar" class="progress-inner"></div></div>
    </div>
    <time id="timer" class="text-xs text-slate-500 font-mono">00:00</time>
  </div>
</section>

<!-- Quiz -->
<main class="container my-4">
  <form id="form" class="grid gap-4" novalidate></form>

  <section id="resultWrap" class="hidden mt-4" aria-live="polite">
    <div class="card p-4">
      <div class="flex items-center gap-2 mb-2">
        <i data-lucide="sparkles" class="w-5 h-5 text-emerald-600"></i>
        <h2 class="text-base font-semibold">KI-Feedback</h2>
      </div>
      <article id="aiResult" class="prose text-sm"></article>
    </div>
  </section>
</main>

<!-- Sticky actions -->
<div class="sticky-actions bg-[color:var(--surface)] border-t border-[color:var(--border)]">
  <div class="container px-4 py-2 flex flex-wrap items-center gap-2">
    <div class="flex items-center gap-2">
      <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener"><i data-lucide="book-open" class="w-4 h-4"></i> BBiG</a>
      <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener"><i data-lucide="shield" class="w-4 h-4"></i> JArbSchG</a>
    </div>
    <div class="flex-1"></div>
    <button id="submitBtn" type="button" class="btn btn-primary"><i data-lucide="send" class="w-5 h-5"></i> KI-Feedback (Auswahl)</button>
    <button id="resetBtn" type="button" class="btn"><i data-lucide="rotate-ccw" class="w-5 h-5"></i> ZurÃ¼cksetzen</button>
  </div>
</div>

<!-- Toast -->
<div id="toast" style="position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;z-index:100;display:none"></div>

<!-- Quicklook Modal -->
<div id="qlBackdrop" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-40"></div>
<div id="qlModal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="card p-4 w-full max-w-xl max-h-[90vh] overflow-auto">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <i data-lucide="search" class="w-5 h-5 text-blue-600"></i>
        <h3 class="text-base font-semibold">Â§-Quicklook â€“ BBiG & JArbSchG</h3>
      </div>
      <button id="qlClose" class="btn btn-ghost btn-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>
    <div class="mt-2 flex gap-2">
      <input id="qlSearch" type="search" class="flex-1 rounded-xl border px-3 py-2" placeholder="Begriff oder Â§ â€¦">
      <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">BBiG</a>
      <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">JArbSchG</a>
    </div>
    <div id="qlList" class="mt-3 grid gap-2"></div>
  </div>
</div>

<!-- Linda Avatar Button -->
<button id="lindaBtn" type="button" aria-label="Linda Ã¶ffnen">
  <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <radialGradient id="grad" cx="50%" cy="40%" r="60%">
        <stop offset="0%" stop-color="#3b82f6"/>
        <stop offset="100%" stop-color="#1e40af"/>
      </radialGradient>
    </defs>
    <circle cx="50" cy="50" r="40" fill="url(#grad)">
      <animate attributeName="r" values="39;41;39" dur="6s" repeatCount="indefinite"/>
    </circle>
    <circle cx="35" cy="45" r="4" fill="white"/>
    <circle cx="65" cy="45" r="4" fill="white"/>
    <path d="M35 63 Q50 73 65 63" stroke="white" stroke-width="3" stroke-linecap="round" fill="none"/>
  </svg>
</button>

<!-- Linda Chat -->
<div id="lindaChat">
  <div class="l-wrap">
    <div id="lDrag" class="l-drag">
      <i data-lucide="grip-horizontal" class="w-4 h-4"></i>
      <strong>Linda</strong><span class="text-xs text-slate-500 ml-2">Deine Lernassistentin</span>
      <button id="lClose" class="btn btn-ghost btn-sm ml-auto"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>
    <div id="lBody" class="l-body"></div>
    <div class="l-input">
      <input id="lText" type="text" placeholder="Frag Linda â€¦ (Enter sendet)">
      <button id="lSend" class="btn btn-primary btn-sm"><i data-lucide="send" class="w-4 h-4"></i></button>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="app-footer">
  <div class="container px-4 py-4">
    Diese Anwendung nutzt kÃ¼nstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antworten von OpenAI verarbeitet und geprÃ¼ft werden.
    Es werden keine personenbezogenen Daten erhoben, erfasst oder verarbeitet. Keine sensiblen Daten eingeben â€“ auch keine Informationen, die RÃ¼ckschlÃ¼sse auf Personen zulassen.
    MissbrÃ¤uchliche Nutzung ist untersagt. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind zu prÃ¼fen. KI-generierte Inhalte kÃ¶nnen fehlerhaft sein. Keine Haftung.
  </div>
</footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  if (window.lucide) lucide.createIcons();
  if (window.marked) marked.setOptions({breaks:true,gfm:true});

  /* Config */
  const relay="/api/linda-proxy";
  const STORAGE="LINDA_INTERACTIVE_V1";
  const INTRO_KEY="LINDA_INTRO_SKIP";

  /* UI Refs */
  const intro=document.getElementById("intro");
  const introStart=document.getElementById("introStart");
  const introSkipNow=document.getElementById("introSkipNow");
  const introAck=document.getElementById("introAck");
  const introTheme=document.getElementById("introTheme");

  const form=document.getElementById("form");
  const progressBar=document.getElementById("progressBar");
  const progressTxt=document.getElementById("progressText");
  const selText=document.getElementById("selText");
  const submitBtn=document.getElementById("submitBtn");
  const resetBtn=document.getElementById("resetBtn");
  const timerEl=document.getElementById("timer");
  const toastEl=document.getElementById("toast");

  const tabs=document.getElementById("tabs");
  const clusterSelect=document.getElementById("clusterSelect");

  const notice=document.getElementById("notice");
  const ack=document.getElementById("ack");
  const ackBtn=document.getElementById("ackBtn");
  const ackState=document.getElementById("ackState");

  const quickBtn=document.getElementById("quickBtn");
  const qlBackdrop=document.getElementById("qlBackdrop");
  const qlModal=document.getElementById("qlModal");
  const qlClose=document.getElementById("qlClose");
  const qlSearch=document.getElementById("qlSearch");
  const qlList=document.getElementById("qlList");

  const themeToggle=document.getElementById("themeToggle");

  /* Linda */
  const lBtn=document.getElementById("lindaBtn");
  const lChat=document.getElementById("lindaChat");
  const lDrag=document.getElementById("lDrag");
  const lClose=document.getElementById("lClose");
  const lBody=document.getElementById("lBody");
  const lText=document.getElementById("lText");
  const lSend=document.getElementById("lSend");

  /* Theme */
  function applyThemeIcon(){ themeToggle.innerHTML = document.documentElement.classList.contains("dark") ? '<i data-lucide="sun" class="w-4 h-4"></i>' : '<i data-lucide="moon" class="w-4 h-4"></i>'; if (window.lucide) lucide.createIcons(); }
  if (localStorage.getItem("theme_pref")==="dark") document.documentElement.classList.add("dark");
  applyThemeIcon();
  const toggleTheme=()=>{ document.documentElement.classList.toggle("dark"); localStorage.setItem("theme_pref", document.documentElement.classList.contains("dark")?"dark":"light"); applyThemeIcon(); };
  themeToggle.addEventListener("click", toggleTheme);
  introTheme.addEventListener("click", toggleTheme);

  /* Timer */
  let startTs=Date.now();
  setInterval(()=>{ const s=Math.floor((Date.now()-startTs)/1000); const m=String(Math.floor(s/60)).padStart(2,"0"); const r=String(s%60).padStart(2,"0"); timerEl.textContent=`${m}:${r}`; },1000);

  /* Toast */
  function toast(m){ toastEl.textContent=m; toastEl.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.style.display="none",2300); }

  /* Disclaimer */
  let accepted=false;
  ackBtn.addEventListener("click", ()=>{ if(!ack.checked){ toast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; } accepted=true; notice.style.display="none"; ackState.textContent="Hinweis bestÃ¤tigt"; saveState(); });

  /* Data (kurz) */
  const CLUSTERS=[
    {key:"core", title:"Kern", icon:"layers", data:[
      {ref:"V1 â€“ Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehÃ¶ren.", tip:["Parteien; Beginn/Dauer; Ziel/Berufsbezeichnung; sachliche & zeitliche Gliederung; VergÃ¼tung; Probezeit; Urlaub; KÃ¼ndigung; Nachweisform.","Â§ 11 BBiG."]},
      {ref:"V3 â€“ Probezeit", q:"Wie lang muss/darf die Probezeit sein â€“ und warum ist sie wichtig?", tip:["Mind. 1, max. 4 Monate; EignungsprÃ¼fung beider Seiten.","Â§ 20 BBiG."]},
      {ref:"V5 â€“ Wegezeiten", q:"ZÃ¤hlt der Weg von der Berufsschule zurÃ¼ck in den Betrieb als Arbeitszeit?", tip:["Ja, Wegezeiten zwischen Schule und AusbildungsstÃ¤tte sind anzurechnen.","Â§ 15 Abs. 2 Nr. 1 BBiG."]}
    ]},
    {key:"recht", title:"Recht", icon:"scale", data:[
      {ref:"R1 â€“ Freistellung", q:"Nenne zwei Beispiele fÃ¼r Freistellung nach Â§ 15 BBiG.", tip:["Berufsschule, PrÃ¼fungen; Wege Schuleâ†’Betrieb."]},
      {ref:"R2 â€“ VergÃ¼tung", q:"Was gilt zur MindestausbildungsvergÃ¼tung (MiAV)?", tip:["Untergrenze je Jahrgang; Tarif ggf. hÃ¶her.","Â§ 17 BBiG."]}
    ]},
    {key:"grundlagen", title:"Grundlagen & Recruiting", icon:"users", data:[
      {ref:"G1 â€“ Eignung", q:"Was umfasst die persÃ¶nliche Eignung von Ausbilder*innen grob?", tip:["Keine einschlÃ¤gigen RechtsverstÃ¶ÃŸe; ZuverlÃ¤ssigkeit; Vorbildfunktion."]},
      {ref:"G2 â€“ Auswahl", q:"Nenne zwei faire Kriterien fÃ¼r die Azubi-Auswahl (keine Diskriminierung).", tip:["Kompetenzen, Schul-/Leistungsnachweise, Motivation (AGG beachten)."]}
    ]}
  ];
  function currentQs(){ return CLUSTERS.find(c=>c.key===activeKey)?.data||[]; }

  const LAW_INDEX=[
    {law:"BBiG", para:"Â§ 11", tags:["vertrag","inhalte"], excerpt:"Niederschrift der wesentlichen Inhalte.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf"},
    {law:"BBiG", para:"Â§ 20", tags:["probezeit"], excerpt:"Probezeit: min. 1, max. 4 Monate.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf"},
    {law:"BBiG", para:"Â§ 15", tags:["freistellung","wegezeit"], excerpt:"Freistellung; Wege Schuleâ†’Betrieb anrechenbar.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf"}
  ];

  /* State */
  let activeKey="core";
  let answersByRef={}, selectedByRef={};

  // Restore
  (function restore(){
    try{
      const s=JSON.parse(localStorage.getItem(STORAGE)||"{}");
      activeKey=s.activeKey||"core"; answersByRef=s.answersByRef||{}; selectedByRef=s.selectedByRef||{}; accepted=!!s.accepted;
    }catch{}
    if(accepted){ notice.style.display="none"; ack.checked=true; ackState.textContent="Hinweis bestÃ¤tigt"; }
    setIntroBtns();
    if(localStorage.getItem(INTRO_KEY)==="1"){ intro.style.display="none"; openLinda(true); }
  })();

  /* Intro logic */
  function setIntroBtns(){ const ok=introAck.checked; introStart.disabled=!ok; introSkipNow.disabled=!ok; }
  introAck.addEventListener("change", setIntroBtns);
  function startApp(){ intro.classList.add("fadeout"); setTimeout(()=>intro.style.display="none",450); openLinda(true); }
  introStart.addEventListener("click", ()=>{ localStorage.setItem(INTRO_KEY,"1"); startApp(); });
  introSkipNow.addEventListener("click", startApp);

  /* Tabs */
  function renderTabs(){
    tabs.innerHTML=""; clusterSelect.innerHTML="";
    CLUSTERS.forEach(c=>{
      const b=document.createElement("button");
      b.type="button"; b.className="tab"; b.setAttribute("aria-selected", c.key===activeKey?"true":"false");
      b.innerHTML=`<i data-lucide="${c.icon}"></i><span>${c.title}</span>`;
      b.addEventListener("click", ()=>{ activeKey=c.key; renderTabs(); renderQuestions(); saveState(); });
      tabs.appendChild(b);
      const opt=document.createElement("option"); opt.value=c.key; opt.textContent=c.title; if(c.key===activeKey) opt.selected=true; clusterSelect.appendChild(opt);
    });
    if (window.lucide) lucide.createIcons();
  }
  clusterSelect.addEventListener("change", e=>{ activeKey=e.target.value; renderTabs(); renderQuestions(); saveState(); });

  /* Questions */
  function renderQuestions(){
    form.innerHTML="";
    currentQs().forEach((item,idx)=>{
      const id=`q_${idx}`, fbId=`fb_${idx}`, selId=`sel_${idx}`;
      const sec=document.createElement("section"); sec.className="card q-card"; sec.dataset.ref=item.ref;
      sec.innerHTML=`
        <header class="flex items-center justify-between gap-3 mb-1">
          <div class="flex items-center gap-2">
            <input id="${selId}" type="checkbox" class="w-4 h-4 accent-blue-600" data-select="${idx}">
            <span class="badge badge-primary">Frage ${idx+1}</span>
            <span class="badge">${item.ref}</span>
          </div>
          <span class="text-[11px] text-slate-400">Cluster: ${CLUSTERS.find(c=>c.key===activeKey)?.title||""}</span>
        </header>
        <h3 class="text-[15px] font-semibold mb-2">${item.q}</h3>
        <details class="tip mb-2">
          <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-blue-700 text-[13px]">
            <i data-lucide="info" class="w-4 h-4"></i><span>ðŸ›ˆ MusterlÃ¶sung</span>
          </summary>
          <div class="mt-2">${(item.tip||[]).map(t=>`<p class="text-sm">â€¢ ${t}</p>`).join("")}
            <div class="mt-2 flex gap-2 flex-wrap">
              <button type="button" data-quick="${idx}" class="btn btn-sm"><i data-lucide="search" class="w-4 h-4"></i> Â§-Quicklook</button>
              <button type="button" data-ask="${idx}" class="btn btn-sm"><i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check</button>
            </div>
            <div id="${fbId}" class="prose text-sm max-w-none hidden mt-2"></div>
          </div>
        </details>
        <textarea id="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-blue-500 text-[15px]" placeholder="Deine Antwort â€¦"></textarea>
        <div class="mt-2"><button type="button" data-fill="${id}" class="btn btn-sm">Beispiel-Gliederung</button></div>
      `;
      form.appendChild(sec);

      const ta=sec.querySelector("textarea");
      ta.value = answersByRef[item.ref]||"";
      ta.addEventListener("input", ()=>{ answersByRef[item.ref]=ta.value; updateProgress(); saveState(); });

      const cb=sec.querySelector(`[data-select]`);
      cb.checked = !!selectedByRef[item.ref];
      cb.addEventListener("change", ()=>{ selectedByRef[item.ref]=cb.checked; updateSel(); saveState(); });
    });

    form.querySelectorAll("[data-fill]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const ta=document.getElementById(btn.getAttribute("data-fill"));
        ta.value=["### Kurzantwort","- â€¦","- â€¦","- â€¦","","### BegrÃ¼ndung/Norm (optional)","- â€¦"].join("\n");
        ta.dispatchEvent(new Event("input"));
      });
    });
    form.querySelectorAll("[data-ask]").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        if(!accepted){ toast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; }
        const idx=Number(e.currentTarget.getAttribute("data-ask"));
        const item=currentQs()[idx];
        const val=(answersByRef[item.ref]||"").trim();
        const fb=document.getElementById(`fb_${idx}`);
        btn.disabled=true; const old=btn.innerHTML; btn.innerHTML='<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> PrÃ¼fen â€¦';
        fb.classList.remove("hidden"); fb.innerHTML='<div class="text-slate-500 text-sm">KI prÃ¼ft â€¦</div>';
        try{
          const out=await callAI({prompt: buildPromptSingle(item,val)});
          fb.innerHTML = window.marked? marked.parse(out) : out;
        }catch(e){ fb.innerHTML=`<div class="text-red-600 text-sm">Fehler: ${String(e).replace(/[<>&]/g,"")}</div>`; }
        btn.disabled=false; btn.innerHTML=old;
        if(window.lucide) lucide.createIcons();
      });
    });

    updateSel(); updateProgress();
    if (window.lucide) lucide.createIcons();
  }

  function updateSel(){ const n=Object.values(selectedByRef).filter(Boolean).length; selText.textContent=`${n} ausgewÃ¤hlt`; }
  function updateProgress(){
    const refs=currentQs().map(q=>q.ref);
    const answered=refs.filter(r=> (answersByRef[r]||"").trim().length>0 ).length;
    progressBar.style.width = refs.length? Math.round((answered/refs.length)*100)+'%': '0%';
    progressTxt.textContent = `${answered} / ${refs.length||0} beantwortet`;
  }

  /* Prompts */
  function buildPromptSingle(item,answer){
    return `Beurteile **wohlwollend** eine Kurzantwort (BBiG/JArbSchG etc.). Wenn die geforderte Anzahl erfÃ¼llt ist, schreibe **"passt"** und ergÃ¤nze nur optional.
- Kurzfeedback (max 2 SÃ¤tze, inkl. "passt" bei ErfÃ¼llung)
- Richtige LÃ¶sung (max 4 Bulletpoints)
- Gesetz/Â§ (falls einschlÃ¤gig)
- 1 Praxistipp (1 Satz)
Frage: ${item.q}
Antwort TN: ${answer||"(leer)"}`.trim();
  }
  function buildPromptAll(list){
    return `Beurteile **wohlwollend** mehrere Kurzantworten. Wenn die Soll-Anzahl erfÃ¼llt ist, schreibe **"passt"** und ergÃ¤nze nur optional.
${list.map(a=>`Q (${a.ref}): ${a.question}\nAntwort: ${a.answer||"(leer)"}`).join("\n\n")}`.trim();
  }

  async function callAI(payload,{timeoutMs=22000}={}){
    const res=await Promise.race([
      fetch(relay,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),timeoutMs))
    ]);
    if(!res.ok) throw new Error("API-Fehler "+res.status);
    const t=await res.text(); try{const j=JSON.parse(t); return j.answer||j.content||j.result||t;}catch{return t;}
  }

  submitBtn.addEventListener("click", async ()=>{
    if(!accepted){ toast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; }
    const refs=currentQs().map(q=>q.ref).filter(r=> selectedByRef[r] || (answersByRef[r]||"").trim().length>0 );
    if(!refs.length){ toast("Bitte wÃ¤hle mindestens eine Frage oder schreibe eine Antwort."); return; }
    const list=refs.map((ref,i)=>({ref,question:currentQs().find(x=>x.ref===ref).q,answer:(answersByRef[ref]||"").trim()}));
    const wrap=document.getElementById("resultWrap"), out=document.getElementById("aiResult");
    wrap.classList.remove("hidden"); out.innerHTML='<div class="text-slate-500 text-sm">KI erstellt Feedback â€¦</div>';
    submitBtn.disabled=true; const old=submitBtn.innerHTML; submitBtn.innerHTML='<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> PrÃ¼fen â€¦';
    try{ const txt=await callAI({prompt: buildPromptAll(list)}); out.innerHTML=window.marked?marked.parse(txt):txt; window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"}); }
    catch(e){ out.innerHTML=`<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`; }
    submitBtn.disabled=false; submitBtn.innerHTML=old; if(window.lucide) lucide.createIcons();
  });

  resetBtn.addEventListener("click", ()=>{ if(!confirm("Alle Eingaben im aktuellen Cluster lÃ¶schen?")) return;
    currentQs().forEach(q=>{ delete answersByRef[q.ref]; delete selectedByRef[q.ref]; });
    renderQuestions(); saveState();
  });

  /* Quicklook */
  function openQL(){ qlBackdrop.classList.remove("hidden"); qlModal.classList.remove("hidden"); qlModal.classList.add("flex"); qlSearch.value=""; renderQL(""); }
  function closeQL(){ qlBackdrop.classList.add("hidden"); qlModal.classList.add("hidden"); qlModal.classList.remove("flex"); }
  function renderQL(q){
    const query=(q||"").toLowerCase(); const list=query? LAW_INDEX.filter(x=>x.para.toLowerCase().includes(query)||x.law.toLowerCase().includes(query)||x.tags.some(t=>t.includes(query))) : LAW_INDEX;
    qlList.innerHTML = list.map(x=>`
      <div class="p-3 rounded-xl border hover:bg-[color:var(--surface3)]">
        <div class="flex items-center justify-between">
          <div class="font-semibold">${x.law} ${x.para}</div>
          <a class="btn btn-sm" href="${x.link}" target="_blank" rel="noopener">PDF Ã¶ffnen</a>
        </div>
        <div class="text-sm text-slate-600 mt-1">${x.excerpt}</div>
        <div class="mt-1 flex flex-wrap gap-1">${x.tags.map(t=>`<span class="badge">${t}</span>`).join("")}</div>
      </div>`).join("");
  }
  quickBtn.addEventListener("click", openQL);
  qlBackdrop.addEventListener("click", closeQL);
  qlClose.addEventListener("click", closeQL);
  qlSearch.addEventListener("input", e=>renderQL(e.target.value));
  document.addEventListener("keydown", e=>{ if(e.key==="?") openQL(); });

  /* Autosave */
  function saveState(){ localStorage.setItem(STORAGE, JSON.stringify({activeKey,answersByRef,selectedByRef,accepted})); }
  window.addEventListener("beforeunload", saveState);

  /* Linda chat */
  function pushLinda(role, html){ const d=document.createElement("div"); d.className=`l-msg ${role==='me'?'me':'ai'}`; d.innerHTML=html; lBody.appendChild(d); lBody.scrollTop=lBody.scrollHeight; }
  function openLinda(greet=false){
    lChat.style.display="block";
    if (greet && !lBody.dataset.greet){
      pushLinda("ai", "Hallo, ich bin <strong>Linda</strong> ðŸ‘‹<br>Womit mÃ¶chtest du starten?");
      // Vorschlags-Chips
      const wrap=document.createElement("div"); wrap.className="l-msg ai"; wrap.innerHTML=`
        <div class="flex flex-wrap gap-2">
          <span class="chip" data-cluster="core">Kern</span>
          <span class="chip" data-cluster="recht">Recht</span>
          <span class="chip" data-cluster="grundlagen">Grundlagen & Recruiting</span>
          <span class="chip" data-action="example">Beispielantwort einfÃ¼gen</span>
        </div>`;
      lBody.appendChild(wrap);
      lBody.dataset.greet="1";
      wrap.querySelectorAll(".chip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          const c=ch.dataset.cluster, act=ch.dataset.action;
          if (c){ activeKey=c; renderTabs(); renderQuestions(); saveState(); pushLinda("ai", `Okay â€“ ich habe auf <strong>${CLUSTERS.find(x=>x.key===c).title}</strong> umgeschaltet.`); }
          if (act==="example"){
            const first=currentQs()[0]; if(!first){ pushLinda("ai","Es gibt hier gerade keine Frage."); return; }
            answersByRef[first.ref]="### Kurzantwort\n- Punkt 1\n- Punkt 2\n- Punkt 3\n\n### BegrÃ¼ndung/Norm\n- Â§-Verweis â€¦"; renderQuestions(); saveState(); pushLinda("ai","Ich habe eine Beispielstruktur in die erste Frage eingefÃ¼gt. ðŸŽ¯");
          }
        });
      });
    }
  }
  function closeLinda(){ lChat.style.display="none"; }
  lBtn.addEventListener("click", ()=>{ lChat.style.display=(lChat.style.display==="block")?"none":"block"; });
  lClose.addEventListener("click", closeLinda);

  // Drag
  (function enableDrag(){
    let down=false,sx=0,sy=0,sl=0,st=0;
    lDrag.addEventListener("mousedown",(e)=>{down=true;sx=e.clientX;sy=e.clientY;const r=lChat.getBoundingClientRect();sl=r.left;st=r.top;document.body.style.userSelect="none";});
    window.addEventListener("mousemove",(e)=>{if(!down)return; const dx=e.clientX-sx, dy=e.clientY-sy; lChat.style.left=(sl+dx)+"px"; lChat.style.top=(st+dy)+"px"; lChat.style.right="auto"; lChat.style.bottom="auto";});
    window.addEventListener("mouseup",()=>{down=false;document.body.style.userSelect="";});
    // default dock
    const dock=()=>{ lChat.style.left=""; lChat.style.top=""; lChat.style.right="16px"; lChat.style.bottom="96px"; };
    dock(); window.addEventListener("resize", dock, {passive:true});
  })();

  async function sendLinda(){
    const txt=lText.value.trim(); if(!txt) return;
    pushLinda("me", txt.replace(/</g,"&lt;")); lText.value="";
    try{
      const out=await callAI({prompt:`Du bist Linda. Antworte knapp, freundlich, mit Â§Â§ wenn sinnvoll. Frage:\n${txt}`});
      pushLinda("ai", window.marked?marked.parse(out):out);
    }catch(e){
      pushLinda("ai", `<span class="text-red-600">Fehler: ${String(e).replace(/[<>&]/g,"")}</span>`);
    }
  }
  lSend.addEventListener("click", sendLinda);
  lText.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendLinda(); } });

  /* Tabs + Questions initial */
  renderTabs(); renderQuestions();

  /* Quick start after intro when accepted previously */
  function gateHideIntro(){ intro.classList.add("fadeout"); setTimeout(()=>intro.style.display="none",450); }
  if (intro && localStorage.getItem(INTRO_KEY)==="1") gateHideIntro();
});
</script>
</body>
</html>
