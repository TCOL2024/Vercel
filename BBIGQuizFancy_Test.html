<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz – Enterprise Edition</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Markdown -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --surface:#ffffff; --surface-2:#f6f8fb; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --brand:#0ea5e9; --brand-2:#2563eb; --ok:#10b981; --warn:#f59e0b; --error:#ef4444;
      --radius:14px; --radius-sm:10px; --shadow-1:0 8px 28px rgba(2,8,23,.06);
    }
    
    html.dark {
      color-scheme: dark;
    }
    
    html.dark body {
      background: linear-gradient(to bottom, #0b1220, #0b1220 40%, #111827 100%);
    }
    
    html.dark {
      --surface:#0f172a; --surface-2:#0b1327; --ink:#e5e7eb; --muted:#9aa6b2; --border:#1f2937;
    }
    
    html, body { font-size: 16px; }
    @media (max-width: 640px){ html, body { font-size: 17px; } }

    body{ 
      background: linear-gradient(to bottom, #fff, #f4f7fb); 
      color: var(--ink);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      transition: background 0.3s ease, color 0.3s ease;
    }
    
    .container{ max-width: 1200px; margin-inline: auto; padding-inline: 1rem; }
    .card{ 
      background: var(--surface); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow-1);
      transition: all 0.3s ease;
    }
    .card:hover {
      box-shadow: 0 12px 40px rgba(2,8,23,.1);
      transform: translateY(-2px);
    }
    
    .chip{ 
      font-size:12px; padding:4px 10px; border-radius:999px; 
      border:1px solid var(--border); color:var(--muted); 
      background:var(--surface-2); 
      transition: all 0.2s ease;
    }
    
    .btn{ 
      display:inline-flex; align-items:center; gap:.5rem; 
      padding:.6rem .9rem; border-radius: var(--radius-sm); 
      border:1px solid var(--border); background: var(--surface); 
      color: var(--ink); cursor:pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .btn:hover{ background:#f8fafc; transform: translateY(-1px); }
    html.dark .btn:hover{ background:#1e293b; }
    
    .btn-primary{ 
      border-color:transparent; 
      background:linear-gradient(180deg, var(--brand), var(--brand-2)); 
      color:#fff; 
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }
    .btn-primary:hover{ filter:brightness(1.05); box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4); }
    
    .btn-ghost{ background:transparent; border:none; }
    .btn-sm{ padding:.45rem .6rem; border-radius:10px; }
    .btn-lg{ padding:.9rem 1.05rem; border-radius:12px; }
    .btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--brand) 50%, transparent); outline-offset:2px; }
    
    .progress-outer{ 
      height:10px; border-radius:999px; 
      background:#eaeef4; overflow:hidden; 
    }
    html.dark .progress-outer { background:#1e293b; }
    
    .progress-inner{ 
      height:100%; width:0%; border-radius:999px; 
      background:linear-gradient(90deg, var(--brand), var(--ok)); 
      transition:width .25s; 
    }
    
    .q-badge{ 
      background: color-mix(in oklab, var(--brand) 18%, #eaf6ff 82%); 
      color: color-mix(in oklab, var(--brand) 80%, #0b3b52 20%); 
    }
    html.dark .q-badge {
      background: rgba(14,165,233,.15);
      color: #7dd3fc;
    }
    
    .rubric{ 
      border:1px dashed var(--border); border-radius:12px; 
      padding:.5rem .6rem; background:var(--surface-2); 
    }
    .rubric .bar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    html.dark .rubric .bar { background:#1e293b; }
    
    .rubric .fill{ 
      height:100%; width:0%; 
      background:linear-gradient(90deg, #93c5fd, #2563eb); 
      transition: width .3s; 
    }
    
    .tip > div{ 
      border-left:3px solid var(--brand); 
      background:#f0f9ff; color:#0b3b52; 
      border-radius:12px; padding:.75rem .85rem; 
    }
    html.dark .tip > div{ background:rgba(14,165,233,.08); color:#cce9fb; }
    
    details[open] summary .chev{ transform:rotate(180deg); }
    summary{ list-style:none; cursor:pointer; }

    /* Notice */
    .notice{ 
      background:linear-gradient(135deg, #e0f2fe, #dbeafe); 
      border-bottom:1px solid rgba(2,8,23,.08); 
    }
    html.dark .notice {
      background:linear-gradient(135deg, rgba(14,165,233,.1), rgba(37,99,235,.1));
      border-bottom:1px solid rgba(255,255,255,.05);
    }
    .notice .inner{ backdrop-filter:blur(6px); }

    /* Modal */
    .modal-backdrop{ 
      position:fixed; inset:0; 
      background:rgba(2,6,23,.45); 
      backdrop-filter:blur(4px);
      display:none; z-index:98; 
      animation: fadeIn 0.2s ease;
    }
    html.dark .modal-backdrop {
      background:rgba(0,0,0,.7);
    }
    
    .modal{ 
      position:fixed; inset:0; display:none; 
      align-items:center; justify-content:center; 
      padding:16px; z-index:99; 
    }
    .modal .panel{ 
      width:100%; max-width:900px; 
      border-radius:1rem;
      animation: slideUp 0.3s ease;
    }
    .modal.open, .modal-backdrop.open{ display:flex; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Exam banner */
    .exam-on { 
      background: #fff7ed; 
      border:1px solid #fed7aa; 
    }
    html.dark .exam-on {
      background: rgba(251,146,60,.1);
      border:1px solid rgba(251,146,60,.3);
    }

    /* Skeleton Loader */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    html.dark .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 200% 100%;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* API Status */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    .status-online { background: #10b981; }
    .status-offline { background: #ef4444; animation: none; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Password Screen */
    #passwordScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    html.dark #passwordScreen {
      background: linear-gradient(135deg, #0c4a6e 0%, #1e3a8a 100%);
    }

    /* Print */
    @media print{
      .sticky, .sticky-actions, #notice, #quickBtn, #examToggleWrap, #themeToggle, #historyBtn { display:none!important; }
      body{ background:#fff!important; }
      .card{ box-shadow:none!important; border:1px solid #ddd; }
    }
    
    footer.app-footer{ 
      font-family:Arial, Helvetica, sans-serif; 
      font-size:10px; line-height:1.4; 
      background: var(--surface-2);
      transition: background 0.3s ease;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }
  </style>
</head>
<body class="min-h-screen antialiased">

  <!-- Password Screen -->
  <div id="passwordScreen">
    <div class="card p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="w-16 h-16 rounded-2xl bg-sky-100 grid place-items-center mx-auto mb-4">
          <i data-lucide="lock" class="w-8 h-8 text-sky-700"></i>
        </div>
        <h2 class="text-2xl font-semibold mb-2">BBiG-Quiz – Geschützter Zugang</h2>
        <p class="text-sm text-slate-600">Bitte gib das Zugangskennwort ein</p>
      </div>
      <form id="passwordForm" class="space-y-4">
        <div>
          <label for="passwordInput" class="block text-sm font-medium mb-2">Kennwort</label>
          <input 
            id="passwordInput" 
            type="password" 
            class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-sky-500" 
            placeholder="Kennwort eingeben"
            autocomplete="off"
          />
        </div>
        <button type="submit" class="btn btn-primary btn-lg w-full justify-center">
          <i data-lucide="unlock" class="w-5 h-5"></i> Zugang freischalten
        </button>
        <p id="passwordError" class="text-sm text-red-600 text-center hidden">Falsches Kennwort. Bitte erneut versuchen.</p>
      </form>
    </div>
  </div>

  <!-- Main App (hidden until password correct) -->
  <div id="mainApp" style="display:none;">

  <!-- Disclaimer -->
  <aside id="notice" class="notice sticky top-0 z-50">
    <div class="inner container px-4 py-3 flex items-start gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-100 grid place-items-center shrink-0">
        <i data-lucide="shield-check" class="w-6 h-6 text-sky-700"></i>
      </div>
      <div class="text-sm leading-snug flex-1">
        <p class="font-semibold text-sky-900">Fachlicher Hinweis (Pilot)</p>
        <p class="text-sky-900/90">
          Die KI-Prüfung unterstützt beim Lernen. Ergebnisse müssen fachlich geprüft werden und ersetzen keine Rechtsberatung.
          <strong>Es dürfen keine personenbezogenen oder sensiblen Daten eingegeben oder erfasst werden.</strong>
        </p>
        <label class="mt-2 inline-flex items-center gap-2">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-sky-600" aria-describedby="ackDesc">
          <span id="ackDesc" class="text-sky-950">Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2 flex-wrap">
        <div class="flex items-center gap-2 px-3 py-1 rounded-lg bg-white/50 backdrop-blur">
          <span class="status-dot status-online" id="apiStatusDot"></span>
          <span class="text-xs font-medium" id="apiStatusText">API: Prüfen...</span>
        </div>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
        <span id="ackState" class="chip">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn">Weiter</button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="container px-4 pt-4">
    <div class="flex flex-wrap items-center gap-3">
      <div class="w-11 h-11 rounded-2xl bg-gradient-to-br from-sky-400 to-blue-600 grid place-items-center shadow-lg">
        <i data-lucide="graduation-cap" class="w-6 h-6 stroke-[1.6] text-white"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight truncate">BBiG-Quiz – Enterprise Edition</h1>
        <p class="text-sm text-slate-500">20 Kernfragen. KI-Feedback mit Rubriken. §-Quicklook zu BBiG/JArbSchG.</p>
      </div>

      <div class="flex items-center gap-2">
        <button id="historyBtn" type="button" class="btn btn-sm" title="Antwort-Historie">
          <i data-lucide="history" class="w-4 h-4"></i>
        </button>
        
        <button id="themeToggle" type="button" class="btn btn-sm" title="Theme wechseln">
          <i data-lucide="moon" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="examToggleWrap" class="flex items-center gap-2 p-2 rounded-xl border border-amber-200 exam-on">
        <i data-lucide="timer" class="w-4 h-4 text-amber-600"></i>
        <label class="text-sm font-medium">Prüfungsmodus</label>
        <input id="examToggle" type="checkbox" class="w-5 h-5 accent-amber-600" />
        <select id="examSize" class="ml-1 text-sm rounded-lg border px-2 py-1 bg-white">
          <option value="10">10 Fragen</option>
          <option value="20" selected>20 Fragen</option>
          <option value="40">40 (wenn vorhanden)</option>
        </select>
        <span id="examTimer" class="text-xs text-amber-700 ml-1 font-mono">—</span>
      </div>

      <button id="quickBtn" type="button" class="btn btn-primary">
        <i data-lucide="search" class="w-4 h-4"></i> §-Quicklook
      </button>
    </div>
  </header>

  <!-- Progress -->
  <section class="container px-4 mt-4" aria-labelledby="progh">
    <div class="card p-4">
      <div class="flex items-center gap-3">
        <i data-lucide="target" class="w-5 h-5 text-sky-700"></i>
        <div class="flex-1">
          <div class="flex justify-between text-xs text-slate-600 mb-1">
            <span id="progressText">0 / 20 beantwortet</span>
            <span id="selText">0 ausgewählt</span>
          </div>
          <div class="progress-outer" role="progressbar" aria-valuemin="0" aria-valuemax="20" aria-valuenow="0" aria-labelledby="progh">
            <div id="progressBar" class="progress-inner"></div>
          </div>
          <span id="progh" class="sr-only">Beantwortete Fragen</span>
        </div>
        <time id="timer" class="text-xs text-slate-500 ml-3 font-mono" aria-live="polite">00:00</time>
      </div>
    </div>
  </section>

  <!-- Spider Chart -->
  <section class="container px-4 mt-4" id="chartSection" style="display:none;">
    <div class="card p-4">
      <div class="flex items-center gap-2 mb-3">
        <i data-lucide="pie-chart" class="w-5 h-5 text-emerald-700"></i>
        <h2 class="text-base font-semibold">Rubrik-Analyse</h2>
      </div>
      <div class="chart-container">
        <canvas id="rubricChart"></canvas>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container px-4 py-4">
    <form id="form" class="grid gap-4 sm:gap-5" novalidate aria-describedby="formhint"></form>
    <p id="formhint" class="sr-only">Mit Strg/⌘+Enter kannst du das KI-Gesamt-Feedback abrufen.</p>

    <section id="resultWrap" class="mt-5 hidden" aria-live="polite">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkles" class="w-5 h-5 text-emerald-700"></i>
          <h2 class="text-base font-semibold">KI-Feedback (Gesamt)</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky actions -->
  <div class="sticky-actions sticky bottom-0 z-40 bg-white/95 border-t border-slate-200 backdrop-blur">
    <div class="container px-4 py-2 flex flex-wrap items-center gap-2">
      <div class="flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener" aria-label="BBiG (PDF)">
          <i data-lucide="book-open" class="w-4 h-4"></i>
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener" aria-label="JArbSchG (PDF)">
          <i data-lucide="shield" class="w-4 h-4"></i>
        </a>
      </div>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback (Auswahl)
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">Zurücksetzen</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite" style="display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:100; box-shadow:0 8px 24px rgba(0,0,0,.3);"></div>

  <!-- Quicklook Modal -->
  <div id="qlBackdrop" class="modal-backdrop"></div>
  <div id="qlModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="qlTitle">
    <div class="panel card p-4 sm:p-5" role="document">
      <div class="flex items-start gap-2">
        <div class="w-10 h-10 rounded-xl bg-sky-100 grid place-items-center">
          <i data-lucide="search" class="w-5 h-5 text-sky-700"></i>
        </div>
        <div class="flex-1">
          <h3 id="qlTitle" class="text-base font-semibold">§-Quicklook – BBiG & JArbSchG</h3>
          <p class="text-sm text-slate-500">Suche nach Paragraph/Begriff (z. B. „§11", „Probezeit", „Ruhezeit"). Auszug + Sprung ins PDF.</p>
        </div>
        <button id="qlClose" type="button" class="btn btn-sm" aria-label="Fenster schließen">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="mt-3 flex flex-col sm:flex-row gap-2">
        <input id="qlSearch" type="search" class="flex-1 rounded-xl border px-3 py-2" placeholder="Begriff oder § …">
        <div class="flex gap-2">
          <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener"><i data-lucide="book-open" class="w-4 h-4"></i> BBiG</a>
          <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener"><i data-lucide="shield" class="w-4 h-4"></i> JArbSchG</a>
        </div>
      </div>
      <div id="qlList" class="mt-3 grid gap-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyBackdrop" class="modal-backdrop"></div>
  <div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
    <div class="panel card p-4 sm:p-5" role="document">
      <div class="flex items-start gap-2">
        <div class="w-10 h-10 rounded-xl bg-emerald-100 grid place-items-center">
          <i data-lucide="history" class="w-5 h-5 text-emerald-700"></i>
        </div>
        <div class="flex-1">
          <h3 id="historyTitle" class="text-base font-semibold">Antwort-Historie</h3>
          <p class="text-sm text-slate-500">Deine letzten 10 Versuche</p>
        </div>
        <button id="historyClose" type="button" class="btn btn-sm" aria-label="Fenster schließen">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div id="historyList" class="mt-3 space-y-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer text-slate-700 mt-8">
    <div class="container px-4 py-4">
      Diese Anwendung nutzt künstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antwort von OpenAI verarbeitet und geprüft werden.
      Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbräuchlich verwendet werden.
      Es dürfen keine personenbezogenen Daten, sensiblen Daten oder Daten erfasst werden, die Rückschlüsse auf eine Person, zum Beispiel Auszubildenden,
      Ausbilder oder ähnliche Personen ermöglichen. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind vom Anwender zu prüfen.
      KI-generierte Antworten können fehlerhaft sein. Keine Haftung.
    </div>
  </footer>

  </div><!-- End mainApp -->

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // === Password Protection ===
    const PASSWORD = "IHK2025";
    const passwordScreen = document.getElementById("passwordScreen");
    const passwordForm = document.getElementById("passwordForm");
    const passwordInput = document.getElementById("passwordInput");
    const passwordError = document.getElementById("passwordError");
    const mainApp = document.getElementById("mainApp");

    // Check if already authenticated
    const isAuthenticated = sessionStorage.getItem("bbig_authenticated");
    if (isAuthenticated === "true") {
      passwordScreen.style.display = "none";
      mainApp.style.display = "block";
      initApp();
    }

    passwordForm.addEventListener("submit", (e) => {
      e.preventDefault();
      if (passwordInput.value === PASSWORD) {
        sessionStorage.setItem("bbig_authenticated", "true");
        passwordScreen.style.display = "none";
        mainApp.style.display = "block";
        initApp();
      } else {
        passwordError.classList.remove("hidden");
        passwordInput.value = "";
        passwordInput.focus();
      }
    });

    function initApp() {
      if (window.lucide) lucide.createIcons();
      
    // === Konfiguration ===
    const relay = "/api/linda-proxy";
    const STORAGE_KEY = "BBIGQUIZ_EXAM_V2";
    const HISTORY_KEY = "BBIGQUIZ_HISTORY";
    const MAX_ANSWER_CHARS = 1500;
    const RUBRIC_KEYS = ["normbezug","vollstaendigkeit","praxisbezug"];

    // UI-Refs
    const form = document.getElementById("form");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn  = document.getElementById("resetBtn");
    const timerEl   = document.getElementById("timer");
    const resultWrap= document.getElementById("resultWrap");
    const aiResult  = document.getElementById("aiResult");

    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");

    const examToggle = document.getElementById("examToggle");
    const examSize   = document.getElementById("examSize");
    const examTimer  = document.getElementById("examTimer");

    const quickBtn = document.getElementById("quickBtn");
    const qlBackdrop = document.getElementById("qlBackdrop");
    const qlModal = document.getElementById("qlModal");
    const qlClose = document.getElementById("qlClose");
    const qlSearch = document.getElementById("qlSearch");
    const qlList = document.getElementById("qlList");

    const historyBtn = document.getElementById("historyBtn");
    const historyBackdrop = document.getElementById("historyBackdrop");
    const historyModal = document.getElementById("historyModal");
    const historyClose = document.getElementById("historyClose");
    const historyList = document.getElementById("historyList");

    const themeToggle = document.getElementById("themeToggle");
    const toastEl = document.getElementById("toast");

    const apiStatusDot = document.getElementById("apiStatusDot");
    const apiStatusText = document.getElementById("apiStatusText");

    const chartSection = document.getElementById("chartSection");
    const rubricChartCanvas = document.getElementById("rubricChart");
    let rubricChart = null;

    if (window.marked) marked.setOptions({ breaks:true, gfm:true });
    if (window.lucide) lucide.createIcons();

    // === Theme Toggle ===
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.documentElement.classList.add("dark");
    }

    themeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      const isDark = document.documentElement.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      if (window.lucide) lucide.createIcons();
    });

    // === API Status Check ===
    async function checkAPIStatus() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(relay, {
          method: 'OPTIONS',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        apiStatusDot.className = "status-dot status-online";
        apiStatusText.textContent = "API: Online";
      } catch (error) {
        apiStatusDot.className = "status-dot status-offline";
        apiStatusText.textContent = "API: Offline";
      }
    }

    checkAPIStatus();
    setInterval(checkAPIStatus, 60000); // Check every minute

    // Timer (Sitzungsuhr)
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    }, 1000);

    // === Fragen (20 Kernfragen) ===
    const QUESTIONS_ALL = [
      { ref:"V1 – Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehören.", tip:["Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung, Vergütung, Probezeit, Urlaub, tägliche Ausbildungszeit, Kündigung, Hinweise auf Tarif/BV, Form des Ausbildungsnachweises.","§ 11 BBiG; Textform/elektronisch zulässig."]},
      { ref:"V2 – Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:["Berufsbild, Dauer/Ausbildungsrahmenplan, Prüfungen.","§§ 4–5 BBiG."]},
      { ref:"V3 – Probezeit", q:"Wie lang muss/darf die Probezeit sein – und warum ist sie wichtig?", tip:["Mind. 1, max. 4 Monate; Eignungsprüfung beider Seiten.","§ 20 BBiG."]},
      { ref:"V4 – Minderjährige: Unterschrift", q:"Wer unterschreibt den Vertrag bei Minderjährigen mit gemeinsamem Sorgerecht?", tip:["Beide Sorgeberechtigte + Minderjährige/r.","§ 10 BBiG; §§ 1626, 1629 BGB."]},
      { ref:"V5 – Berufsschulzeit & Arbeitszeit", q:"Wie werden Berufsschulzeiten auf die Arbeitszeit angerechnet (U18 vs. ≥18)?", tip:["U18: besondere Anrechnung (JArbSchG).","Wegezeiten Schule→Betrieb anrechenbar (§ 15 Abs. 2 Nr. 1 BBiG).","≥18: ArbZG; Freistellung nach § 15 BBiG."]},
      { ref:"V6 – Ruhezeit Jugendliche", q:"Welche tägliche Mindestruhezeit gilt für Jugendliche?", tip:["Mindestens 12 Stunden.","JArbSchG."]},
      { ref:"V7 – Vergütung", q:"Was gilt zur Angemessenheit der Ausbildungsvergütung?", tip:["MiAV Untergrenze; tariflich/branchenüblich; Steigerung je Jahr.","§ 17 BBiG."]},
      { ref:"V8 – Überstunden", q:"Sind Überstunden zulässig – und wie werden sie behandelt?", tip:["Nur ausbildungsdienlich; Vergütung/Zeitausgleich; Jugendarbeitsschutz beachten.","ArbZG/JArbSchG; BBiG."]},
      { ref:"V9 – Betrieblicher Ausbildungsplan", q:"Wozu dient der betriebliche Ausbildungsplan?", tip:["Umsetzung Rahmenplan, zeitl./sachl. Gliederung, Qualitätssicherung.","§ 5 BBiG; Verweis § 11 Abs. 1 S. 2."]},
      { ref:"V10 – Berichtsheft", q:"Welche Bedeutung hat das Berichtsheft und wer kontrolliert es?", tip:["Zulassungsvoraussetzung; elektronisch möglich; Kontrolle Ausbilder/in.","§ 13 Nr.7, § 14 BBiG."]},
      { ref:"V11 – Verkürzung", q:"Wann kann die Ausbildungsdauer verkürzt werden?", tip:["Vorbildung/Leistung/Anrechnung; Einvernehmen nötig.","§ 8 BBiG."]},
      { ref:"V12 – Verlängerung", q:"Wann kommt eine Verlängerung in Betracht?", tip:["Nichtbestehen oder besondere Fälle.","§ 8 Abs. 2 BBiG."]},
      { ref:"V13 – Teilzeitberufsausbildung", q:"Wie funktioniert Teilzeit in der Ausbildung und was bleibt unverändert?", tip:["Reduzierte Zeiten, Lernziel bleibt; evtl. längere Gesamtdauer.","§ 7a BBiG."]},
      { ref:"V14 – Datenschutz/Geheimnis", q:"Welche Pflichten haben Azubis zu Datenschutz und Betriebsgeheimnissen?", tip:["DSGVO/BDSG beachten; Unterweisungen dokumentieren."]},
      { ref:"V15 – Kündigung", q:"Welche Kündigungsregeln gelten in und nach der Probezeit?", tip:["Probezeit: jederzeit fristlos (§ 22 Abs. 1).","Danach: fristlos aus wichtigem Grund oder mit Frist (Berufsaufgabe/Wechsel) – schriftlich, Gründe nennen (§ 22)."]},
      { ref:"V16 – Schwangerschaft/Mutterschutz", q:"Welche Schutzregeln gelten bei Schwangerschaft in der Ausbildung?", tip:["MuSchG: Schutzfristen, Beschäftigungsverbote, Kündigungsschutz."]},
      { ref:"V17 – Nachteilsausgleich", q:"Wie werden Auszubildende mit Behinderung in Prüfungen unterstützt?", tip:["Nachteilsausgleich (Zeit, Hilfsmittel) auf Antrag; Chancengleichheit."]},
      { ref:"V18 – Ausland", q:"Sind Ausbildungsabschnitte im Ausland möglich und wie werden sie angerechnet?", tip:["Ja; Ausbildungsziel wahren; bis zulässige Zeitanteile.","§ 2 Abs. 3 BBiG."]},
      { ref:"V19 – Versetzung", q:"Darf der Betrieb Azubis versetzen?", tip:["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten klären.","§ 14 BBiG."]},
      { ref:"V20 – Insolvenz", q:"Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip:["Fortführung/Anschlussbetrieb/IHK-Unterstützung; ggf. Insolvenzgeld."]}
    ];

    // === §-Quicklook Mini-Index ===
    const LAW_INDEX = [
      { law:"BBiG", para:"§ 11", tags:["vertrag","inhalte","mindestinhalte"], excerpt:"§ 11 BBiG – Niederschrift der wesentlichen Inhalte (u. a. Parteien, Beginn/Dauer, Ziel, sachliche/zeitliche Gliederung, Vergütung, Probezeit, Urlaub, Kündigung).", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 20", tags:["probezeit"], excerpt:"§ 20 BBiG – Probezeit mindestens 1, höchstens 4 Monate.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 15", tags:["freistellung","schule","wegezeit"], excerpt:"§ 15 BBiG – Freistellung für Berufsschule/Prüfungen; Wegezeiten Schule→Betrieb sind anzurechnen.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 17", tags:["vergütung","miav"], excerpt:"§ 17 BBiG – Angemessene Vergütung; Mindestausbildungsvergütung als Untergrenze.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"JArbSchG", para:"§ 8–15", tags:["arbeitszeit","ruhezeit","pausen"], excerpt:"JArbSchG – Tägliche und wöchentliche Höchstarbeitszeiten; Ruhepausen; Ruhezeit mind. 12 Std.", link:"https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" },
      { law:"ArbZG", para:"§ 3, § 4, § 5", tags:["erwachsene","arbeitszeit","pausen","ruhezeit"], excerpt:"ArbZG – 8 Std/Tag (bis 10 mit Ausgleich), Pausen 30–45 Min, Ruhezeit 11 Std.", link:"https://www.gesetze-im-internet.de/arbzg/BJNR117100994.html" },
    ];

    // === State ===
    let accepted = false;
    let examMode = false;
    let examCountdown = null;
    let examTick = null;

    let pool = [...QUESTIONS_ALL];
    let answers = {};
    let selected = {};
    let rubrics  = {};

    // === Spider Chart ===
    function updateSpiderChart() {
      const entries = Object.entries(rubrics);
      if (entries.length === 0) {
        chartSection.style.display = "none";
        return;
      }

      const avgRubric = entries.reduce((acc, [ref, r]) => {
        acc.normbezug += r.normbezug || 0;
        acc.vollstaendigkeit += r.vollstaendigkeit || 0;
        acc.praxisbezug += r.praxisbezug || 0;
        acc.count++;
        return acc;
      }, {normbezug:0, vollstaendigkeit:0, praxisbezug:0, count:0});

      const count = avgRubric.count || 1;

      chartSection.style.display = "block";

      const data = {
        labels: ['Normbezug', 'Vollständigkeit', 'Praxisbezug'],
        datasets: [{
          label: 'Durchschnitt',
          data: [
            (avgRubric.normbezug / count).toFixed(1),
            (avgRubric.vollstaendigkeit / count).toFixed(1),
            (avgRubric.praxisbezug / count).toFixed(1)
          ],
          backgroundColor: 'rgba(14, 165, 233, 0.2)',
          borderColor: 'rgba(14, 165, 233, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(14, 165, 233, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(14, 165, 233, 1)'
        }]
      };

      if (rubricChart) {
        rubricChart.destroy();
      }

      rubricChart = new Chart(rubricChartCanvas, {
        type: 'radar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 2,
              ticks: {
                stepSize: 0.5
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // === History ===
    function saveToHistory() {
      try {
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        const totalScore = Object.values(rubrics).reduce((sum, r) => 
          sum + (r.normbezug || 0) + (r.vollstaendigkeit || 0) + (r.praxisbezug || 0), 0
        );
        
        history.unshift({
          ts: Date.now(),
          answers: {...answers},
          rubrics: {...rubrics},
          totalScore,
          questionsCount: Object.keys(answers).length
        });
        
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 10)));
      } catch(e) {}
    }

    function loadHistory() {
      try {
        const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        historyList.innerHTML = "";
        
        if (history.length === 0) {
          historyList.innerHTML = '<div class="text-sm text-slate-500 text-center py-8">Keine Historie vorhanden</div>';
          return;
        }

        history.forEach((entry, idx) => {
          const date = new Date(entry.ts);
          const dateStr = date.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          const card = document.createElement('div');
          card.className = 'card p-3 hover:shadow-lg transition-all cursor-pointer';
          card.innerHTML = `
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="font-semibold text-sm">${dateStr}</div>
                <div class="text-xs text-slate-500">${entry.questionsCount} Fragen bearbeitet</div>
              </div>
              <div class="text-right">
                <div class="text-lg font-bold text-sky-600">${entry.totalScore}/${entry.questionsCount * 6}</div>
                <div class="text-xs text-slate-500">Punkte</div>
              </div>
            </div>
          `;
          
          card.addEventListener('click', () => {
            if (confirm('Möchtest du diesen Versuch laden? Aktuelle Antworten werden überschrieben.')) {
              answers = {...entry.answers};
              rubrics = {...entry.rubrics};
              renderForm();
              updateSpiderChart();
              closeHistory();
              showToast('Versuch geladen');
            }
          });
          
          historyList.appendChild(card);
        });
      } catch(e) {}
    }

    historyBtn.addEventListener('click', () => {
      loadHistory();
      historyBackdrop.classList.add('open');
      historyModal.classList.add('open');
    });

    function closeHistory() {
      historyBackdrop.classList.remove('open');
      historyModal.classList.remove('open');
    }

    historyBackdrop.addEventListener('click', closeHistory);
    historyClose.addEventListener('click', closeHistory);

    // Disclaimer
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked){ showToast("Bitte die Checkbox bestätigen."); return; }
      accepted = true; notice.style.display = "none"; ackState.textContent = "Hinweis bestätigt"; ackState.className = "chip";
      saveState();
    });

    // Exam: toggle + Size
    examToggle.addEventListener("change", ()=>{ setExamMode(examToggle.checked); });
    examSize.addEventListener("change", ()=>{ applyExamSizing(); });

    function setExamMode(on){
      examMode = !!on;
      document.getElementById("examToggleWrap").classList.toggle("exam-on", examMode);
      applyExamSizing();
      renderForm();
      updateProgress();
      if (examMode){
        const mins = Math.ceil(pool.length * 1.5);
        startCountdown(mins * 60);
      } else {
        stopCountdown();
      }
      saveState();
    }
    
    function startCountdown(seconds){
      examCountdown = seconds;
      updateCountdownLabel();
      clearInterval(examTick);
      examTick = setInterval(()=>{
        examCountdown = Math.max(0, examCountdown - 1);
        updateCountdownLabel();
        if (examCountdown === 0){ 
          clearInterval(examTick); 
          showToast("Zeit abgelaufen – bitte abgeben."); 
        }
      }, 1000);
    }
    
    function stopCountdown(){ 
      clearInterval(examTick); 
      examTick = null; 
      examTimer.textContent = "—"; 
    }
    
    function updateCountdownLabel(){
      const m = String(Math.floor(examCountdown/60)).padStart(2,"0");
      const s = String(examCountdown%60).padStart(2,"0");
      examTimer.textContent = `${m}:${s}`;
    }
    
    function applyExamSizing(){
      const size = Number(examSize.value) || 20;
      const shuffled = [...QUESTIONS_ALL].sort(()=>Math.random()-0.5);
      pool = shuffled.slice(0, Math.min(size, QUESTIONS_ALL.length));
    }

    // Autosize
    function autosize(el){ el.style.height="auto"; el.style.height=(el.scrollHeight+4)+"px"; }

    // Form render
    function renderForm(){
      [...form.querySelectorAll("section[data-ref]")].forEach(sec=>{
        const ref = sec.getAttribute("data-ref");
        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answers[ref]  = ta.value;
        if (cb) selected[ref] = cb.checked;
      });

      form.innerHTML = "";
      pool.forEach((item, idx)=>{
        const id = `q_${idx}`, fbId = `fb_${idx}`, selId = `sel_${idx}`;
        const sec = document.createElement("section");
        sec.className = "card p-4";
        sec.setAttribute("data-ref", item.ref);

        const tipHtml = `
          <details class="tip mb-2" ${examMode ? "open hidden" : ""}>
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-sky-700 hover:text-sky-900 text-[13px]">
              <i class="chev transition-transform" data-lucide="chevron-down"></i><span>🛈 Musterlösung</span>
            </summary>
            <div class="mt-2">${(item.tip||[]).map(t=>`<p>${t}</p>`).join("")}</div>
          </details>`;

        const r = rubrics[item.ref] || {normbezug:0, vollstaendigkeit:0, praxisbezug:0};
        const sum = r.normbezug + r.vollstaendigkeit + r.praxisbezug;
        const rubricHtml = `
          <details class="mb-2">
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-slate-700 hover:text-slate-900 text-[13px]">
              <i class="transition-transform" data-lucide="bar-chart-3" class="w-4 h-4"></i><span>Rubrik anzeigen (Punkte: <strong>${sum}/6</strong>)</span>
            </summary>
            <div class="rubric mt-2 space-y-3">
              ${renderRubricRow("Normbezug", "normbezug", r.normbezug)}
              ${renderRubricRow("Vollständigkeit", "vollstaendigkeit", r.vollstaendigkeit)}
              ${renderRubricRow("Praxisbezug", "praxisbezug", r.praxisbezug)}
            </div>
          </details>`;
          
        function renderRubricRow(label, key, val){
          const pct = Math.round((val/2)*100);
          return `
            <div>
              <div class="flex justify-between text-xs mb-1"><span>${label}</span><span>${val}/2</span></div>
              <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
            </div>`;
        }

        sec.innerHTML = `
          <header class="flex items-center justify-between gap-3 mb-2">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-sky-600" data-select="${idx}" aria-label="Für KI-Feedback auswählen">
              <span class="q-badge chip">${item.ref}</span>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="btn btn-sm" data-quicklook="${idx}" title="§-Quicklook zu dieser Frage">
                <i data-lucide="search" class="w-4 h-4"></i> § Quicklook
              </button>
              <span class="text-slate-400 text-[11px]">Frage ${idx+1}/${pool.length}</span>
            </div>
          </header>

          <h3 class="text-[15px] sm:text-[16px] font-semibold mb-2">${item.q}</h3>
          ${tipHtml}

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px] transition-all" placeholder="Deine Antwort …"></textarea>

          <div class="mt-2 flex flex-wrap gap-2">
            <button type="button" data-fill="${id}" class="btn btn-sm">Beispiel-Gliederung</button>
            <button type="button" data-ask="${idx}" class="btn btn-sm ${examMode ? 'opacity-50 pointer-events-none' : ''}">
              <i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check (Rubrik)
            </button>
          </div>

          ${rubricHtml}

          <div id="${fbId}" class="prose prose-slate text-sm max-w-none hidden mt-2"></div>
        `;
        form.appendChild(sec);

        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector(`[data-select]`);
        const saved = answers[item.ref] || "";
        ta.value = saved; autosize(ta);
        if (selected[item.ref] != null) cb.checked = !!selected[item.ref];

      });

      // events
      form.querySelectorAll("textarea").forEach(ta=>{
        ta.addEventListener("input", ()=>{
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          answers[ref] = ta.value;
          saveStateSchedule();
        });
        ta.addEventListener("keydown", (ev)=>{
          if ((ev.ctrlKey||ev.metaKey) && ev.key === "Enter"){ ev.preventDefault(); submitBtn.click(); }
        });
      });
      
      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const tid = e.currentTarget.getAttribute("data-fill");
          const ta = document.getElementById(tid);
          ta.value = ["### Kurzantwort","- …","- …","- …","","### Begründung/Norm (optional)","- …"].join("\n");
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          answers[ref] = ta.value; saveStateSchedule();
        });
      });
      
      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!relay){ showToast("Kein Backend konfiguriert."); return; }
          if (!accepted){ showToast("Bitte zuerst den Hinweis bestätigen."); return; }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });
      
      form.querySelectorAll("[data-select]").forEach(cb=>{
        cb.addEventListener("change",(e)=>{
          const ref=e.currentTarget.closest("section[data-ref]")?.getAttribute("data-ref");
          selected[ref] = e.currentTarget.checked; updateSelCount(); saveStateSchedule();
        });
      });
      
      form.querySelectorAll("[data-quicklook]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const idx = Number(e.currentTarget.getAttribute("data-quicklook"));
          openQuicklookFor(pool[idx]);
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelCount(); updateProgress();
    }

    function updateSelCount(){
      const n=[...form.querySelectorAll("[data-select]:checked")].length;
      selText.textContent=`${n} ausgewählt`;
    }
    
    function updateProgress(){
      const t=[...form.querySelectorAll("textarea")];
      const f=t.filter(x=>x.value.trim().length>0).length;
      const total=t.length||1;
      progressBar.style.width=Math.round((f/total)*100)+"%";
      progressTxt.textContent=`${f} / ${total} beantwortet`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuemax", String(total));
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuenow", String(f));
    }

    // === Skeleton Loader ===
    function showSkeleton(container) {
      container.innerHTML = `
        <div class="space-y-3">
          <div class="h-4 skeleton"></div>
          <div class="h-4 skeleton" style="width:80%"></div>
          <div class="h-4 skeleton" style="width:60%"></div>
        </div>
      `;
    }

    // === KI-Prompting ===
    function buildPromptSingle(item, answer){
      return `
Bewerte **wohlwollend** eine Kurzantwort (Ausbildung/Arbeitsrecht). Wenn die Soll-Anzahl erreicht ist: „passt", danach optional ergänzen.

Gib zuerst **JSON** ausschließlich mit folgendem Schema (keine Einleitung, kein Codeblock!):
{"rubrik":{"normbezug":0..2,"vollstaendigkeit":0..2,"praxisbezug":0..2},"kommentar":"kurzes Feedback (1-2 Sätze)","loesung":["max. 4 Stichp
