<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz â€“ metafinanz Cluster Edition</title>

  <!-- External -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* ===== metafinanz Design (Amazon-Nova inspiriert) ===== */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{
      --mf-primary:#005EB8; --mf-primary-dark:#004A93; --mf-secondary:#00A0E3;
      --accent:#FF9900; --accent-hover:#EC7211;
      --success:#00D4AA; --warn:#FFA726; --danger:#E53935;

      --surface:#FFFFFF; --surface-2:#F7F8F8; --surface-hover:#EBEEF0;
      --ink:#0F1111; --muted:#565959; --border:#D5D9D9; --focus:#005EB8;

      --radius:10px; --radius-pill:999px;
      --shadow-xs:0 1px 2px rgba(15,17,17,.06);
      --shadow-sm:0 1px 6px rgba(15,17,17,.08);
      --shadow-md:0 2px 10px rgba(15,17,17,.12);
    }
    html.dark{
      --surface:#131A22; --surface-2:#1C2531; --surface-hover:#232F3E;
      --ink:#FFFFFF; --muted:#AAB7B8; --border:#3A4553; --focus:#FF9900;
    }
    html,body{ font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size:14px; line-height:1.5; background:var(--surface-2); color:var(--ink) }
    .container{ max-width:1120px; margin-inline:auto; padding-inline:16px }

    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow-sm) }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--ink); font-weight:600; cursor:pointer; transition:.15s }
    .btn:hover{ background:var(--surface-hover) }
    .btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--focus) 35%, transparent); outline-offset:2px }
    .btn-primary{ background:var(--accent); border-color:var(--accent); color:#111 }
    .btn-primary:hover{ background:var(--accent-hover); border-color:var(--accent-hover) }
    .btn-blue{ background:var(--mf-primary); border-color:var(--mf-primary); color:#fff }
    .btn-blue:hover{ background:var(--mf-primary-dark) }
    .btn-ghost{ background:transparent; border-color:transparent }
    .btn-sm{ padding:6px 10px; font-size:12px }
    .btn-lg{ padding:12px 16px; font-size:14px; border-radius:12px }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--border); border-radius:12px; background:var(--surface-2); color:var(--muted); font-size:11px; font-weight:700; letter-spacing:.2px }
    .badge-primary{ background:#E7F1FF; color:var(--mf-primary); border-color:#B3D9FF }

    .progress-outer{ height:8px; border-radius:4px; background:var(--surface-2); overflow:hidden; border:1px solid var(--border) }
    .progress-inner{ height:100%; width:0%; background:linear-gradient(90deg, var(--mf-primary), var(--mf-secondary)); transition:width .3s; box-shadow:0 0 8px rgba(0,94,184,.3) }

    .app-header{ position:sticky; top:0; z-index:40; backdrop-filter:blur(8px); background:color-mix(in srgb, var(--surface) 88%, transparent); border-bottom:1px solid var(--border) }

    /* Notice (blau, klar) */
    .notice{ background:linear-gradient(135deg, #E7F1FF, #E0F2FF); border-bottom:1px solid #B3D9FF }
    .notice .chip{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid #B3D9FF; background:#F2F8FF; color:#0A3A66 }

    /* Tabs â†’ Cluster */
    .tabs{ display:flex; gap:.5rem; overflow:auto; scrollbar-width:none }
    .tabs::-webkit-scrollbar{ display:none }
    .tab{ padding:.55rem .85rem; border:1px solid var(--border); border-radius:var(--radius-pill); background:#fff; white-space:nowrap; display:flex; align-items:center; gap:.45rem; font-weight:700; }
    .tab[aria-selected="true"]{ background:#ECF6FF; border-color:#B3D9FF; color:#0A3A66 }
    .tab i{ width:18px; height:18px }
    #clusterSelect{ display:none }
    @media (max-width: 720px){ .tabs{ display:none } #clusterSelect{ display:block } }

    /* Question card */
    .q-card{ position:relative; padding:16px }
    .bookmark{ position:absolute; top:12px; right:12px; width:34px; height:34px; border-radius:50%; display:grid; place-items:center; background:var(--surface); border:1px solid var(--border); box-shadow:var(--shadow-xs) }
    .bookmark.active{ background:var(--accent); border-color:var(--accent) }
    .tip{ margin-top:.5rem; background:#F0F8FF; border-left:3px solid var(--mf-primary); padding:.75rem .85rem; border-radius:10px }
    html.dark .tip{ background:rgba(0,94,184,.15) }

    /* Modal base */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(4px); display:none; z-index:98 }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:99 }
    .modal.open, .modal-backdrop.open{ display:flex }
    .panel{ width:100%; max-width:860px; max-height:90vh; overflow:auto; border-radius:12px }

    /* Toast */
    #toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:100; display:none }

    /* Footer (Arial 10) */
    footer.app-footer{ font-family:Arial, Helvetica, sans-serif; font-size:10px; line-height:1.4; color:#4b5563; background:#eef2f6; border-top:1px solid var(--border) }

    /* Print */
    @media print{
      .app-header, .notice, .sticky-actions, .bookmark, .modal, .fab{ display:none !important }
      .card{ box-shadow:none !important; border:1px solid #ddd }
    }
  </style>
</head>
<body>

  <!-- Notice -->
  <aside id="notice" class="notice">
    <div class="container px-4 py-3 flex items-start gap-3">
      <div class="w-10 h-10 rounded-lg bg-[#E7F1FF] grid place-items-center">
        <i data-lucide="shield-check" class="w-6 h-6 text-[#005EB8]"></i>
      </div>
      <div class="text-sm leading-snug">
        <p class="font-semibold text-[#0A3A66]">Fachlicher Hinweis (Pilot)</p>
        <p class="text-[#0A3A66]">
          Die KI-PrÃ¼fung unterstÃ¼tzt beim Lernen. Ergebnisse sind zu prÃ¼fen; keine Rechtsberatung.
          <strong>Keine personenbezogenen/sensiblen Daten eingeben oder erfassen.</strong>
        </p>
        <label class="mt-2 inline-flex items-center gap-2">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-[#005EB8]">
          <span class="text-[#0A3A66]">Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
        <span id="ackState" class="chip badge">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn btn-blue btn-sm">
          <i data-lucide="check" class="w-4 h-4"></i> Weiter
        </button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="app-header">
    <div class="container px-4 py-3 flex flex-wrap items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-md bg-gradient-to-br from-[#005EB8] to-[#004A93] grid place-items-center shadow">
          <i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <h1 class="text-lg sm:text-xl font-semibold">BBiG-Quiz â€“ metafinanz Cluster</h1>
          <p class="text-xs text-slate-500">Cluster â€¢ wohlwollendes KI-Feedback â€¢ Quicklook â€¢ Bookmarks â€¢ Autosave</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="quickBtn" type="button" class="btn btn-sm"><i data-lucide="search" class="w-4 h-4"></i> Â§-Quicklook</button>
        <button id="bookmarksBtn" type="button" class="btn btn-sm" title="Markierte">
          <i data-lucide="bookmark" class="w-4 h-4"></i>
          <span id="bookmarkCount" class="badge badge-primary" style="display:none">0</span>
        </button>
        <button id="historyBtn" type="button" class="btn btn-sm" title="Historie">
          <i data-lucide="history" class="w-4 h-4"></i>
        </button>
        <button id="themeToggle" type="button" class="btn btn-ghost btn-sm" title="Theme">
          <i data-lucide="moon" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <!-- Cluster Tabs -->
    <div class="container pb-3">
      <div class="card p-3">
        <div id="tabs" class="tabs" role="tablist" aria-label="Cluster"></div>
        <select id="clusterSelect" class="mt-2 w-full rounded-lg border px-3 py-2 text-sm"></select>
      </div>
    </div>
  </header>

  <!-- Progress -->
  <section class="container mt-4">
    <div class="card p-4 flex items-center gap-3">
      <i data-lucide="target" class="w-5 h-5 text-[#005EB8]"></i>
      <div class="flex-1">
        <div class="flex justify-between text-[11px] text-slate-500 font-semibold mb-2">
          <span id="progressText">0 / 0 beantwortet</span>
          <span id="selText">0 ausgewÃ¤hlt</span>
        </div>
        <div class="progress-outer"><div id="progressBar" class="progress-inner"></div></div>
      </div>
      <time id="timer" class="text-xs text-slate-500 font-mono">00:00</time>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container my-4">
    <form id="form" class="grid gap-4" novalidate></form>

    <section id="resultWrap" class="hidden mt-4" aria-live="polite">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkles" class="w-5 h-5 text-emerald-600"></i>
          <h2 class="text-base font-semibold">KI-Feedback</h2>
        </div>
        <article id="aiResult" class="prose text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky actions -->
  <div class="sticky-actions bg-[color:var(--surface)] border-t border-[color:var(--border)]">
    <div class="container px-4 py-2 flex flex-wrap items-center gap-2">
      <div class="flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
      </div>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback (Auswahl)
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">
        <i data-lucide="rotate-ccw" class="w-5 h-5"></i> ZurÃ¼cksetzen
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Bookmarks Modal -->
  <div id="bmBackdrop" class="modal-backdrop"></div>
  <div id="bmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bmTitle">
    <div class="panel card p-4">
      <div class="flex items-center justify-between">
        <h3 id="bmTitle" class="text-base font-semibold">Markierte Fragen</h3>
        <button id="bmClose" class="btn btn-ghost btn-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
      <div id="bmList" class="mt-3 grid gap-2 max-h-[70vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Quicklook Modal -->
  <div id="qlBackdrop" class="modal-backdrop"></div>
  <div id="qlModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="qlTitle">
    <div class="panel card p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="search" class="w-5 h-5 text-[#005EB8]"></i>
          <h3 id="qlTitle" class="text-base font-semibold">Â§-Quicklook â€“ BBiG & JArbSchG</h3>
        </div>
        <button id="qlClose" class="btn btn-ghost btn-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
      <div class="mt-2 flex gap-2">
        <input id="qlSearch" type="search" class="flex-1 rounded-lg border px-3 py-2" placeholder="Begriff oder Â§ â€¦">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">BBiG</a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">JArbSchG</a>
      </div>
      <div id="qlList" class="mt-3 grid gap-2 max-h-[65vh] overflow-auto"></div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="histBackdrop" class="modal-backdrop"></div>
  <div id="histModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="panel card p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="history" class="w-5 h-5 text-[#005EB8]"></i>
          <h3 id="histTitle" class="text-base font-semibold">Antwort-Historie</h3>
        </div>
        <button id="histClose" class="btn btn-ghost btn-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
      <div id="histList" class="mt-3 grid gap-2 max-h-[70vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer">
    <div class="container px-4 py-4">
      Diese Anwendung nutzt kÃ¼nstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antwort von OpenAI verarbeitet und geprÃ¼ft werden.
      Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbrÃ¤uchlich verwendet werden. Es dÃ¼rfen keine personenbezogenen Daten,
      sensiblen Daten oder Daten erfasst werden, die RÃ¼ckschlÃ¼sse auf eine Person, zum Beispiel Auszubildenden, Ausbilder oder Ã¤hnliche Personen ermÃ¶glichen. Jegliche Haftung ist ausgeschlossen.
      Alle Antworten sind vom Anwender zu prÃ¼fen. KI-generierte Antworten kÃ¶nnen fehlerhaft sein. Keine Haftung.
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    if (window.lucide) lucide.createIcons();
    if (window.marked) marked.setOptions({ breaks:true, gfm:true });

    // === Config / Keys ===
    const relay = "/api/linda-proxy"; // dein Make-Webhook
    const STORAGE_KEY = "MF_CLUSTER_STATE_V1";
    const BOOKMARK_KEY = "MF_CLUSTER_BOOKMARKS_V1";

    // === UI Refs ===
    const form = document.getElementById("form");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const timerEl = document.getElementById("timer");
    const resultWrap = document.getElementById("resultWrap");
    const aiResult = document.getElementById("aiResult");
    const toastEl = document.getElementById("toast");

    const tabs = document.getElementById("tabs");
    const clusterSelect = document.getElementById("clusterSelect");

    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");

    const bookmarksBtn = document.getElementById("bookmarksBtn");
    const bookmarkCount = document.getElementById("bookmarkCount");
    const bmBackdrop = document.getElementById("bmBackdrop");
    const bmModal = document.getElementById("bmModal");
    const bmClose = document.getElementById("bmClose");
    const bmList = document.getElementById("bmList");

    const quickBtn = document.getElementById("quickBtn");
    const qlBackdrop = document.getElementById("qlBackdrop");
    const qlModal = document.getElementById("qlModal");
    const qlClose = document.getElementById("qlClose");
    const qlSearch = document.getElementById("qlSearch");
    const qlList = document.getElementById("qlList");

    const historyBtn = document.getElementById("historyBtn");
    const histBackdrop = document.getElementById("histBackdrop");
    const histModal = document.getElementById("histModal");
    const histClose = document.getElementById("histClose");
    const histList = document.getElementById("histList");

    const themeToggle = document.getElementById("themeToggle");

    // === Data (Cluster & Fragenbanken) ===
    const BANK_CORE = [
      { ref:"V1 â€“ Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehÃ¶ren.", tip:["Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung, VergÃ¼tung, Probezeit, Urlaub, KÃ¼ndigung, Nachweisform.","Â§ 11 BBiG (Textform/elektronisch)."]},
      { ref:"V2 â€“ Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:["Berufsbild, Ausbildungsrahmenplan/Dauer, PrÃ¼fungen.","Â§Â§ 4â€“5 BBiG."]},
      { ref:"V3 â€“ Probezeit", q:"Wie lang muss/darf die Probezeit sein â€“ und warum ist sie wichtig?", tip:["Mind. 1, max. 4 Monate; EignungsprÃ¼fung beider Seiten.","Â§ 20 BBiG."]},
      { ref:"V4 â€“ MinderjÃ¤hrige: Unterschrift", q:"Wer unterschreibt den Vertrag bei MinderjÃ¤hrigen mit gemeinsamem Sorgerecht?", tip:["Beide Sorgeberechtigte + MinderjÃ¤hrige/r.","Â§ 10 BBiG; Â§Â§ 1626, 1629 BGB."]},
      { ref:"V5 â€“ Berufsschule & Arbeitszeit", q:"Wie werden Berufsschulzeiten angerechnet (U18 vs. â‰¥18)?", tip:["U18: besondere Anrechnung (JArbSchG).","Wege Schuleâ†’Betrieb zÃ¤hlen (Â§15(2)1 BBiG).","â‰¥18: ArbZG; Freistellung Â§15 BBiG."]},
      { ref:"V6 â€“ Ruhezeit Jugendliche", q:"Welche tÃ¤gliche Mindestruhezeit gilt fÃ¼r Jugendliche?", tip:["Mindestens 12 Stunden (JArbSchG)."]},
      { ref:"V7 â€“ VergÃ¼tung", q:"Was gilt zur Angemessenheit der AusbildungsvergÃ¼tung?", tip:["MiAV Untergrenze; Tarif/branchenÃ¼blich; Steigerung je Jahr.","Â§ 17 BBiG."]},
      { ref:"V8 â€“ Ãœberstunden", q:"Sind Ãœberstunden zulÃ¤ssig â€“ und wie werden sie behandelt?", tip:["Nur ausbildungsdienlich; VergÃ¼tung/Zeitausgleich; Schutz beachten."]},
      { ref:"V9 â€“ Betrieblicher Ausbildungsplan", q:"Wozu dient der betriebliche Ausbildungsplan?", tip:["Umsetzung Rahmenplan; zeitl./sachl. Gliederung; QualitÃ¤t."]},
      { ref:"V10 â€“ Berichtsheft", q:"Welche Bedeutung hat das Berichtsheft?", tip:["Zulassungsvoraussetzung; elektronisch mÃ¶glich; Kontrolle Ausbilder/in."]},
      { ref:"V11 â€“ VerkÃ¼rzung", q:"Wann kann die Ausbildungsdauer verkÃ¼rzt werden?", tip:["Vorbildung/Leistung/Anrechnung; Einvernehmen (Â§8 BBiG)."]},
      { ref:"V12 â€“ VerlÃ¤ngerung", q:"Wann kommt eine VerlÃ¤ngerung in Betracht?", tip:["Nichtbestehen oder besondere FÃ¤lle (Â§8(2) BBiG)."]},
      { ref:"V13 â€“ Teilzeit", q:"Wie funktioniert Teilzeit in der Ausbildung, was bleibt unverÃ¤ndert?", tip:["Reduzierte Zeiten; Lernziel bleibt; evtl. lÃ¤ngere Dauer (Â§7a)."]},
      { ref:"V14 â€“ Datenschutz/Geheimnis", q:"Welche Pflichten zu Datenschutz/Betriebsgeheimnissen?", tip:["DSGVO/BDSG; Unterweisung dokumentieren."]},
      { ref:"V15 â€“ KÃ¼ndigung", q:"Welche KÃ¼ndigungsregeln gelten in/nach der Probezeit?", tip:["Probezeit: jederzeit fristlos (Â§22(1)). Danach: wichtiger Grund fristlos oder 4-Wochen-Frist durch Azubi (Â§22)."]},
      { ref:"V16 â€“ Mutterschutz", q:"Welche Schutzregeln gelten bei Schwangerschaft?", tip:["MuSchG: Schutzfristen, BeschÃ¤ftigungsverbote, KÃ¼ndigungsschutz."]},
      { ref:"V17 â€“ Nachteilsausgleich", q:"Wie werden Auszubildende mit Behinderung unterstÃ¼tzt?", tip:["Nachteilsausgleich (Zeit/Hilfsmittel) auf Antrag."]},
      { ref:"V18 â€“ Ausland", q:"Sind Ausbildungsabschnitte im Ausland mÃ¶glich?", tip:["Ja; Ausbildungsziel wahren; anrechenbare Zeit (Â§2(3) BBiG)."]},
      { ref:"V19 â€“ Versetzung", q:"Darf der Betrieb Azubis versetzen?", tip:["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten klÃ¤ren (Â§14)."]},
      { ref:"V20 â€“ Insolvenz", q:"Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip:["FortfÃ¼hrung/Anschlussbetrieb/IHK-UnterstÃ¼tzung; ggf. Insolvenzgeld."]}
    ];
    const BANK_BASICS = [
      { ref:"G1 â€“ Jugendberufsagentur", q:"Aufgabe & Partner?", tip:["Unter 25 unterstÃ¼tzen; AA/Jobcenter/Kommunen/Schulen."]},
      { ref:"G2 â€“ Nutzen Ausbildung", q:"Drei Argumente fÃ¼r Betriebe?", tip:["FachkrÃ¤fte, FlexibilitÃ¤t, Innovation."]},
      { ref:"G3 â€“ Personalplanung", q:"Relevante Dimensionen?", tip:["Quantitativ, qualitativ, zeitlich."]},
      { ref:"G4 â€“ Recruiting-KanÃ¤le", q:"Vier Wege, Azubis zu finden?", tip:["Schulen/Agentur, Social, Messen, Empfehlungen."]},
      { ref:"G5 â€“ Auswahlprozess", q:"Elemente des Auswahlprozesses?", tip:["Screening, GesprÃ¤ch/Test, Entscheidung."]},
      { ref:"G6 â€“ Motive", q:"Drei Motive der Ausbildung?", tip:["Interesse, finanzielle UnabhÃ¤ngigkeit, Perspektive."]},
      { ref:"G7 â€“ Anforderungsprofil", q:"Drei Kompetenzfelder?", tip:["Fachlich, sozial, persÃ¶nlich."]},
      { ref:"G8 â€“ Eignung", q:"Eignung vor/in Probezeit prÃ¼fen (wie)?", tip:["Zeugnisse, Tests/GesprÃ¤che, Beobachtung."]},
      { ref:"G9 â€“ Nachhaltigkeit", q:"Wie verankert in Ausbildung (kurz)?", tip:["Lernziele/Projekte; Rolle Ausbilder."]},
      { ref:"G10 â€“ SDGs", q:"Was sind die 17 SDGs, Nutzen?", tip:["Globale Ziele; Orientierung im Betrieb."]}
    ];
    const BANK_RECHT = [
      { ref:"R1 â€“ Art.12 GG", q:"Was garantiert Art. 12 GG bzgl. Beruf/AusbildungsstÃ¤tte?", tip:["Freie Wahl; gesetzlich einschrÃ¤nkbar."]},
      { ref:"R2 â€“ AGG Ziel", q:"Ziel des AGG (Â§1) im Kontext Ausbildung?", tip:["Benachteiligungen verhindern/beseitigen."]},
      { ref:"R3 â€“ AGG Bereich", q:"Ein Anwendungsbereich Â§2 AGG (Ausbildung)?", tip:["Zugang zu Berufsbildung/Ausbildung."]},
      { ref:"R4 â€“ Â§1 BBiG", q:"Vier SÃ¤ulen Â§1 BBiG?", tip:["Vorbereitung, Ausbildung, Fortbildung, Umschulung."]},
      { ref:"R5 â€“ BvB", q:"Zweck der BvB?", tip:["HeranfÃ¼hrung; Basis berufl. HandlungsfÃ¤higkeit."]},
      { ref:"R6 â€“ EQ", q:"EQ â€“ was & wer gefÃ¶rdert?", tip:["Langzeitpraktikum SGB III; junge Bewerbende."]},
      { ref:"R7 â€“ MiAV", q:"MiAV & Tarif â€“ Zusammenspiel?", tip:["MiAV Untergrenze; Tarif maÃŸgeblich."]},
      { ref:"R8 â€“ GÃ¼nstigkeitsprinzip", q:"Was bedeutet GÃ¼nstigkeitsprinzip?", tip:["Abweichungen nur zugunsten der BeschÃ¤ftigten."]},
      { ref:"R9 â€“ Nachweis", q:"Rolle Ausbildungsnachweis fÃ¼r Zulassung?", tip:["Kann gefordert werden; fehlend kann ausschlieÃŸen."]},
      { ref:"R10 â€“ Moderne Formen", q:"Â§28 BBiG Aussage zur DurchfÃ¼hrung?", tip:["Eignung von AusbildungsstÃ¤tte/Person; moderne Formen ok."]}
    ];
    const BANK_ARBZ = [
      { ref:"A1 â€“ U18 Arbeitszeit", q:"Tages-/Wochengrenzen Jugendliche?", tip:["8 h/Tag, 40 h/W (Ausnahmen)."]},
      { ref:"A2 â€“ U18 Pausen", q:"Pausen Jugendliche?", tip:[">4,5â€“6 h: 30 Min; >6 h: 60 Min; BlÃ¶cke â‰¥15 Min."]},
      { ref:"A3 â€“ U18 Ruhezeit", q:"TÃ¤gliche Freizeit Jugendliche?", tip:["Mindestens 12 Stunden."]},
      { ref:"A4 â€“ U18 Sonn/Feiertag", q:"Grundsatz & Ausnahmen?", tip:["Grundsatz Verbot; Ausnahmen; 2 freie Sonntage/Monat."]},
      { ref:"A5 â€“ â‰¥18 Arbeitszeit", q:"Grund-/HÃ¶chstarbeitszeit ArbZG?", tip:["8 h/Tag; bis 10 mit Ausgleich."]},
      { ref:"A6 â€“ â‰¥18 Pausen/Ruhe", q:"Pausen & Ruhezeit Erwachsene?", tip:["6â€“9 h: 30 Min; >9 h: 45 Min; Ruhe 11 h."]},
      { ref:"A7 â€“ Mehrarbeit Doku", q:"Was dokumentieren & wie lange?", tip:[">8 h/Tag; 2 Jahre (Â§16 ArbZG)."]},
      { ref:"A8 â€“ Urlaub BUrlG", q:"Mindesturlaub 5-Tage-Woche?", tip:["20 AT (4 Wochen)."]},
      { ref:"A9 â€“ Urlaub U18", q:"Mindesturlaub je Alter (Kurz)?", tip:["u16:30 WT; u17:27; u18:25; ab 18:24 WT."]},
      { ref:"A10 â€“ Â§15 BBiG", q:"Freistellung Â§15 BBiG (2 Beispiele)?", tip:["Unterricht/PrÃ¼fungen; Wegezeiten."]}
    ];
    const BANK_ORGA = [
      { ref:"O1 â€“ VollstÃ¤ndige Handlung", q:"Sechs Schritte?", tip:["Informieren, Planen, Entscheiden, AusfÃ¼hren, Kontrollieren, Bewerten."]},
      { ref:"O2 â€“ Lernzielebenen", q:"Richt-/Grob-/Feinlernziel kurz.", tip:["Richt: Gebiet; Grob: FÃ¤higkeit; Fein: Teilziel."]},
      { ref:"O3 â€“ Sachliche Gliederung", q:"Drei Kriterien?", tip:["Einheiten, Ãœberschaubarkeit, Probezeit nutzbar."]},
      { ref:"O4 â€“ Zeitliche Gliederung", q:"Drei Kriterien?", tip:["PrÃ¼fungstermine, Reihenfolge, Block/Urlaub."]},
      { ref:"O5 â€“ Pflichten Â§11/13/14", q:"Nenne Kernpflichten kurz.", tip:["Gliederung; Nachweis fÃ¼hren; Lernziele vermitteln."]},
      { ref:"O6 â€“ Versetzungsplan", q:"Wie helfen EinsatzplÃ¤ne?", tip:["Steuerung Stationen; Lernziele."]},
      { ref:"O7 â€“ Digitale Tools", q:"Zwei Vorteile?", tip:["Transparenz; Feedback/Nachverfolgung."]},
      { ref:"O8 â€“ QualitÃ¤tssicherung", q:"Praxisnahe PrÃ¼fung im Betrieb?", tip:["ZwischengesprÃ¤che, Zielabgleich, Nachweise."]}
    ];
    const BANK_BETEILIGTE = [
      { ref:"B1 â€“ Beteiligte", q:"Zentrale Beteiligte nennen.", tip:["Ausbildende, Ausbilder/in, Beauftragte, Azubis, IHK, Eltern."]},
      { ref:"B2 â€“ Eignung Betrieb", q:"Drei Voraussetzungen?", tip:["Ausstattung, Plan, PlÃ¤tze/Schutz."]},
      { ref:"B3 â€“ Fachkraftbegriff", q:"Wer gilt als Fachkraft?", tip:["Abschluss oder 2Ã— Ausbildungszeit TÃ¤tigkeit."]},
      { ref:"B4 â€“ Relation FK:Azubis", q:"Relation skizzieren.", tip:["1â€“2:1; 3â€“5:2; 6â€“8:3; je +3 FK:+1 Azubi."]},
      { ref:"B5 â€“ Pflichten Ausbildende", q:"Kernpflichten Â§14 BBiG?", tip:["Lernziele, Schutz, Freistellung, Zeugnis."]},
      { ref:"B6 â€“ Rolle Ausbilder", q:"Kernaufgaben?", tip:["Planung, DurchfÃ¼hrung, Kontrolle, Coaching."]},
      { ref:"B7 â€“ Beauftragte", q:"Aufgabe Ausbildungsbeauftragte?", tip:["Teilqualifikationen vermitteln (Â§28(3))."]},
      { ref:"B8 â€“ persÃ¶nliche Eignung", q:"Wann fehlt sie (Beispiel)?", tip:["Wiederholte JArbSchG-VerstÃ¶ÃŸe."]}
    ];
    const BANK_MITBEST = [
      { ref:"M1 â€“ BR Rechte", q:"Zwei Mitwirkungs-/Mitbestimmungsrechte (BBiG)?", tip:["Â§96 Beratungsrecht; Â§98 Mitbestimmung/Bestellung."]},
      { ref:"M2 â€“ Â§87 BetrVG", q:"FÃ¼r welche Themen Mitbestimmung?", tip:["Arbeitszeit, Ordnung, VergÃ¼tung, IT-EinfÃ¼hrung."]},
      { ref:"M3 â€“ Einstellung Azubis", q:"Wie BR einzubeziehen?", tip:["Â§99: Unterrichten, Unterlagen, Zustimmung."]},
      { ref:"M4 â€“ JAV Aufgabe", q:"Zwei Hauptaufgaben JAV?", tip:["Ãœberwachung & Initiativen zugunsten Jugend/Azubis."]},
      { ref:"M5 â€“ JAV Wahl", q:"Wer wahlberechtigt/wÃ¤hlbar (Kurz)?", tip:["u18 + Azubis; wÃ¤hlbar <25; BR-Mitglieder ausgeschlossen."]},
      { ref:"M6 â€“ JAV GrÃ¶ÃŸe", q:"Wovon hÃ¤ngt GrÃ¶ÃŸe ab?", tip:["Zahl der Wahlberechtigten (Â§62 BetrVG)."]},
      { ref:"M7 â€“ Widerspruch BR", q:"Wann kann BR widersprechen?", tip:["Fehlende Eignung (Â§98(2))."]},
      { ref:"M8 â€“ Einigungsstelle", q:"Bei Nichteinigung â€“ was dann?", tip:["Einigungsstelle entscheidet."]}
    ];
    const BANK_PRUEF = [
      { ref:"P1 â€“ ZwischenprÃ¼fung", q:"Wozu dient Â§48 BBiG?", tip:["Wissensstand; Zulassungsvoraussetzung (Â§43)."]},
      { ref:"P2 â€“ Ausbildungsende", q:"Wann endet das VerhÃ¤ltnis Â§21?", tip:["Ablauf der Zeit oder Bekanntgabe des Bestehens."]},
      { ref:"P3 â€“ Zulassung", q:"Rolle Nachweis fÃ¼r Zulassung?", tip:["Kann angefordert werden; fehlend kann ausschlieÃŸen."]},
      { ref:"P4 â€“ Nachteilsausgleich", q:"Beispiele?", tip:["ZeitverlÃ¤ngerung, Hilfsmittel, angepasste Aufgaben."]},
      { ref:"P5 â€“ PrÃ¼fungsrecht", q:"Drei Prinzipien fÃ¼r PA (kurz)?", tip:["Rechtsgrundlagen, Gleichbehandlung, VerhÃ¤ltnismÃ¤ÃŸigkeit."]},
      { ref:"P6 â€“ Freistellung PrÃ¼fung", q:"Â§15 BBiG im PrÃ¼fungszusammenhang?", tip:["Teilnahme; Vortag schriftliche AbschlussprÃ¼fung."]},
      { ref:"P7 â€“ Wiederholung", q:"WiederholungsprÃ¼fung mÃ¶glich?", tip:["Ja; VerlÃ¤ngerung Â§8(2) bis nÃ¤chster Termin mÃ¶glich."]},
      { ref:"P8 â€“ Doku Vorbereitung", q:"Welche Dokumente bereithalten?", tip:["Plan, Nachweise, Beurteilungen, Berichtsheft."]}
    ];
    const BANK_DS = [
      { ref:"D1 â€“ DSGVO GrundsÃ¤tze", q:"Drei GrundsÃ¤tze nennen.", tip:["Zweckbindung, Datenminimierung, Transparenz."]},
      { ref:"D2 â€“ KI-Vorsicht", q:"Wichtige VorsichtsmaÃŸnahme?", tip:["Keine personenbezogenen/sensiblen Daten eingeben."]},
      { ref:"D3 â€“ Betriebsgeheimnis", q:"Wie umgehen?", tip:["Verschwiegenheit; Schulung/Verpflichtung."]},
      { ref:"D4 â€“ Doku DSGVO", q:"Zwei Dokus fÃ¼r Compliance?", tip:["VVT, TOMs, Schulungsnachweise."]},
      { ref:"D5 â€“ Foto/Video", q:"Vor VerÃ¶ffentlichung beachten?", tip:["Einwilligung/Betroffenenrechte."]},
      { ref:"D6 â€“ AGG Recruiting", q:"Zwei Fehler in Ausschreibungen?", tip:["Diskriminierende Formulierungen (Alter/Geschlecht/Religion â€¦)."]},
      { ref:"D7 â€“ SoMe Screening", q:"Worauf achten?", tip:["Datenschutz/Erforderlichkeit/Transparenz."]},
      { ref:"D8 â€“ Aufbewahrung Bewerbungen", q:"Wie lange i. d. R.?", tip:["6 Monate (AGG-Frist), danach lÃ¶schen."]}
    ];
    const BANK_SYS = [
      { ref:"S1 â€“ BIBB Aufgabe", q:"Zwei Aufgaben BIBB.", tip:["Beratung, Forschung, Empfehlungen (Â§90 BBiG)."]},
      { ref:"S2 â€“ Ausbildungsordnung Hoheit", q:"Wer erlÃ¤sst AO, worauf gestÃ¼tzt?", tip:["Fachministerien auf Basis BBiG; BIBB wirkt mit."]},
      { ref:"S3 â€“ Lernorte", q:"Welche Lernorte Â§2 BBiG?", tip:["Betrieb, Schule, ggf. weitere."]},
      { ref:"S4 â€“ Rahmenplan", q:"Funktion des Ausbildungsrahmenplans?", tip:["Zeitlich-sachliche Struktur; Mindestinhalte."]},
      { ref:"S5 â€“ Kammern", q:"Rolle der Kammern?", tip:["ZustÃ¤ndige Stelle: Eintragung, Beratung, PrÃ¼fungen."]},
      { ref:"S6 â€“ Tarifbezug", q:"Nicht tarifgebunden â€“ VergÃ¼tung wie?", tip:["Anlehnung an einschlÃ¤gige Tarife; MiAV beachten."]},
      { ref:"S7 â€“ Rechtsquellen", q:"Hierarchie grob?", tip:["EU/GG â†’ Gesetze â†’ Tarif â†’ BV â†’ Vertrag â†’ Direktionsrecht."]},
      { ref:"S8 â€“ NebentÃ¤tigkeit", q:"Welche Verfassungsnorm tangiert?", tip:["Art. 12 GG."]}
    ];

    const CLUSTERS = [
      { key:"core",  title:"Kern",                     icon:"layers",     data:BANK_CORE },
      { key:"bas",   title:"Grundlagen/Recruiting",    icon:"users",      data:BANK_BASICS },
      { key:"recht", title:"Recht (BBiG/AGG)",         icon:"scale",      data:BANK_RECHT },
      { key:"az",    title:"Arbeitszeit & Urlaub",     icon:"clock-8",    data:BANK_ARBZ },
      { key:"orga",  title:"Organisation/Planung",     icon:"calendar",   data:BANK_ORGA },
      { key:"beteiligte", title:"Beteiligte & Eignung",icon:"id-card",    data:BANK_BETEILIGTE },
      { key:"mitb",  title:"Mitbestimmung (BR/JAV)",   icon:"handshake",  data:BANK_MITBEST },
      { key:"pruef", title:"PrÃ¼fung",                  icon:"file-check", data:BANK_PRUEF },
      { key:"ds",    title:"Datenschutz & Ethik",      icon:"shield",     data:BANK_DS },
      { key:"sys",   title:"System (BIBB/Kammern)",    icon:"building",   data:BANK_SYS }
    ];

    // === State ===
    let accepted=false, activeKey="core";
    let answersByRef={}, selectedByRef={};
    let bookmarks = {};
    // load persisted
    (function restore(){
      try{
        const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
        if (s && typeof s==='object'){
          accepted = !!s.accepted;
          activeKey = s.activeKey || "core";
          answersByRef = s.answersByRef || {};
          selectedByRef = s.selectedByRef || {};
        }
      }catch{}
      try{ bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY)||"{}"); }catch{}
      if (accepted){ notice.style.display="none"; ack.checked=true; ackState.textContent="Hinweis bestÃ¤tigt"; }
    })();

    // === Timer ===
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    },1000);

    // === Theme ===
    const savedTheme = localStorage.getItem("mf_theme") || "light";
    if (savedTheme==="dark") document.documentElement.classList.add("dark");
    themeToggle.addEventListener("click", ()=>{
      document.documentElement.classList.toggle("dark");
      localStorage.setItem("mf_theme", document.documentElement.classList.contains("dark") ? "dark":"light");
      if (window.lucide) lucide.createIcons();
    });

    // === Disclaimer ===
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked){ toast("Bitte die Checkbox bestÃ¤tigen."); return; }
      accepted=true; notice.style.display="none"; ackState.textContent="Hinweis bestÃ¤tigt";
      saveState();
    });

    // === Tabs / Select ===
    function renderTabs(){
      tabs.innerHTML=""; clusterSelect.innerHTML="";
      CLUSTERS.forEach(c=>{
        const b=document.createElement("button");
        b.type="button"; b.className="tab"; b.setAttribute("role","tab");
        b.setAttribute("aria-selected", c.key===activeKey ? "true":"false");
        b.innerHTML=`<i data-lucide="${c.icon}"></i><span>${c.title}</span>`;
        b.addEventListener("click", ()=>{ activeKey=c.key; renderTabs(); renderQuestions(); saveStateThrottled(); });
        tabs.appendChild(b);

        const opt=document.createElement("option");
        opt.value=c.key; opt.textContent=c.title; if(c.key===activeKey) opt.selected=true;
        clusterSelect.appendChild(opt);
      });
      if (window.lucide) lucide.createIcons();
    }
    clusterSelect.addEventListener("change", (e)=>{ activeKey=e.target.value; renderTabs(); renderQuestions(); saveStateThrottled(); });

    function currentQuestions(){ return CLUSTERS.find(x=>x.key===activeKey)?.data || []; }

    // === Quicklook mini-index ===
    const LAW_INDEX = [
      { law:"BBiG", para:"Â§ 11", tags:["vertrag","inhalte","mindestinhalte"], excerpt:"Niederschrift der wesentlichen Inhalte.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"Â§ 20", tags:["probezeit"], excerpt:"Probezeit: min. 1, max. 4 Monate.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"Â§ 15", tags:["freistellung","schule","wegezeit"], excerpt:"Freistellung; Wege Schuleâ†’Betrieb anrechenbar.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"Â§ 17", tags:["vergÃ¼tung","miav"], excerpt:"Angemessene VergÃ¼tung; MiAV.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"JArbSchG", para:"Â§Â§ 8â€“15", tags:["arbeitszeit","ruhezeit","pausen"], excerpt:"HÃ¶chstarbeitszeiten; Ruhepausen; Ruhezeit 12 Std.", link:"https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" },
      { law:"ArbZG", para:"Â§ 3/4/5", tags:["arbeitszeit","pausen","ruhezeit"], excerpt:"8 Std/Tag (bis 10 mit Ausgleich), Pausen, 11 Std Ruhe.", link:"https://www.gesetze-im-internet.de/arbzg/BJNR117100994.html" },
    ];
    function openQuicklook(){ qlBackdrop.classList.add("open"); qlModal.classList.add("open"); qlSearch.value=""; renderQuicklook(""); qlSearch.focus(); }
    function closeQuicklook(){ qlBackdrop.classList.remove("open"); qlModal.classList.remove("open"); }
    function renderQuicklook(q){
      const query=(q||"").toLowerCase().trim();
      const list = query ? LAW_INDEX.filter(x=> x.para.toLowerCase().includes(query) || x.law.toLowerCase().includes(query) || x.tags.some(t=>t.includes(query)) ) : LAW_INDEX;
      qlList.innerHTML="";
      if (!list.length){ qlList.innerHTML=`<div class="text-sm text-slate-500">Keine Treffer â€“ versuche â€žÂ§11â€œ, â€žProbezeitâ€œ, â€žRuhezeitâ€œ â€¦</div>`; return; }
      list.forEach(x=>{
        const row=document.createElement("div");
        row.className="p-3 rounded-lg border hover:bg-[color:var(--surface-hover)]";
        row.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="font-semibold">${x.law} ${x.para}</div>
            <a class="btn btn-sm" href="${x.link}" target="_blank" rel="noopener">PDF Ã¶ffnen</a>
          </div>
          <div class="text-sm text-slate-600 mt-1">${x.excerpt}</div>
          <div class="mt-1 flex flex-wrap gap-1">${x.tags.map(t=>`<span class="badge">${t}</span>`).join("")}</div>
        `;
        qlList.appendChild(row);
      });
    }
    quickBtn.addEventListener("click", openQuicklook);
    qlBackdrop.addEventListener("click", closeQuicklook);
    qlClose.addEventListener("click", closeQuicklook);
    qlSearch.addEventListener("input", (e)=> renderQuicklook(e.target.value));

    // === Bookmarks Modal ===
    function openBM(){ bmBackdrop.classList.add("open"); bmModal.classList.add("open"); renderBM(); }
    function closeBM(){ bmBackdrop.classList.remove("open"); bmModal.classList.remove("open"); }
    bookmarksBtn.addEventListener("click", openBM);
    bmBackdrop.addEventListener("click", closeBM);
    bmClose?.addEventListener("click", closeBM);
    function renderBM(){
      const refs=Object.keys(bookmarks).filter(r=>bookmarks[r]);
      bmList.innerHTML = refs.length? "": `<div class="text-sm text-slate-500">Keine Markierungen.</div>`;
      refs.forEach(ref=>{
        const ans=(answersByRef[ref]||"").trim();
        const div=document.createElement("div");
        div.className="p-3 rounded-lg border";
        div.innerHTML = `<div class="font-semibold mb-1">${ref}</div><div class="text-sm text-slate-600">${ans?ans.slice(0,200)+"â€¦":"(keine Antwort)"}</div>`;
        bmList.appendChild(div);
      });
    }
    function updateBMCount(){
      const n = Object.values(bookmarks).filter(Boolean).length;
      if (n>0){ bookmarkCount.textContent=String(n); bookmarkCount.style.display="inline-flex"; }
      else bookmarkCount.style.display="none";
    }

    // === History (Snapshot pro Gesamtfeedback) ===
    function openHist(){ histBackdrop.classList.add("open"); histModal.classList.add("open"); renderHist(); }
    function closeHist(){ histBackdrop.classList.remove("open"); histModal.classList.remove("open"); }
    historyBtn.addEventListener("click", openHist);
    histBackdrop.addEventListener("click", closeHist);
    histClose.addEventListener("click", closeHist);
    function renderHist(){
      const arr = loadHistory();
      histList.innerHTML = "";
      if (!arr.length){ histList.innerHTML = `<div class="text-sm text-slate-500">Noch keine EintrÃ¤ge.</div>`; return; }
      arr.slice().reverse().forEach(h=>{
        const d=document.createElement("div");
        d.className="p-3 rounded-lg border";
        d.innerHTML = `<div class="text-[11px] text-slate-500">${new Date(h.ts).toLocaleString()}</div><div class="mt-1 prose text-sm">${window.marked? marked.parse(h.html): h.html}</div>`;
        histList.appendChild(d);
      });
    }
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem("MF_CLUSTER_HISTORY_V1")||"[]"); }catch{ return []; } }
    function saveHistory(html){
      const arr = loadHistory(); arr.push({ts:Date.now(), html}); localStorage.setItem("MF_CLUSTER_HISTORY_V1", JSON.stringify(arr));
    }

    // === Render Fragen ===
    function renderQuestions(){
      // persist previous visible
      [...form.querySelectorAll("section[data-ref]")].forEach(sec=>{
        const ref=sec.getAttribute("data-ref");
        const ta=sec.querySelector("textarea");
        const cb=sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answersByRef[ref]=ta.value;
        if (cb) selectedByRef[ref]=cb.checked;
      });

      const QUESTIONS = currentQuestions();
      form.innerHTML="";
      QUESTIONS.forEach((item, idx)=>{
        const id=`q_${idx}`, fbId=`fb_${idx}`, selId=`sel_${idx}`;
        const sec=document.createElement("section");
        sec.className="card q-card";
        sec.setAttribute("data-ref", item.ref);
        const isMarked = !!bookmarks[item.ref];
        sec.innerHTML = `
          <button type="button" class="bookmark ${isMarked?'active':''}" data-bm="${item.ref}" title="Markieren">
            <i data-lucide="bookmark" class="w-4 h-4 ${isMarked?'text-black':''}"></i>
          </button>

          <header class="flex items-center justify-between gap-3 mb-1">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-[#005EB8]" data-select="${idx}" aria-label="FÃ¼r KI-Feedback auswÃ¤hlen">
              <span class="badge badge-primary">Frage ${idx+1}</span>
              <span class="badge">${item.ref}</span>
            </div>
            <span class="text-[11px] text-slate-400">Cluster: ${CLUSTERS.find(c=>c.key===activeKey)?.title||''}</span>
          </header>

          <h3 class="text-[15px] font-semibold mb-2">${item.q}</h3>

          <details class="tip mb-2">
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-[#005EB8] hover:opacity-90 text-[13px]">
              <i data-lucide="info" class="w-4 h-4"></i><span>ðŸ›ˆ MusterlÃ¶sung</span>
            </summary>
            <div class="mt-2">${(item.tip||[]).map(t=>`<p class="text-sm">â€¢ ${t}</p>`).join("")}
              <div class="mt-2 flex gap-2">
                <button type="button" data-quick="${idx}" class="btn btn-sm"><i data-lucide="search" class="w-4 h-4"></i> Â§-Quicklook</button>
                <button type="button" data-ask="${idx}" class="btn btn-sm"><i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check</button>
              </div>
              <div id="${fbId}" class="prose text-sm max-w-none hidden mt-2"></div>
            </div>
          </details>

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-[#005EB8] text-[15px]" placeholder="Deine Antwort â€¦"></textarea>

          <div class="mt-2">
            <button type="button" data-fill="${id}" class="btn btn-sm">Beispiel-Gliederung</button>
          </div>
        `;
        form.appendChild(sec);

        // restore values
        const ta=sec.querySelector("textarea");
        const cb=sec.querySelector(`[data-select]`);
        if (answersByRef[item.ref]) ta.value = answersByRef[item.ref];
        if (selectedByRef[item.ref]!=null) cb.checked = !!selectedByRef[item.ref];
      });

      // events
      form.querySelectorAll("textarea").forEach(ta=>{
        ta.addEventListener("input", ()=>{ answersByRef[ta.closest("section").getAttribute("data-ref")] = ta.value; updateProgress(); saveStateThrottled(); });
        ta.addEventListener("keydown", (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==="Enter"){ e.preventDefault(); submitBtn.click(); } });
      });
      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ta=document.getElementById(btn.getAttribute("data-fill"));
          ta.value = ["### Kurzantwort","- â€¦","- â€¦","- â€¦","","### BegrÃ¼ndung/Norm (optional)","- â€¦"].join("\n");
          answersByRef[ta.closest("section").getAttribute("data-ref")] = ta.value;
          updateProgress(); saveStateThrottled();
        });
      });
      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!accepted){ toast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; }
          await askPerAnswer(Number(e.currentTarget.getAttribute("data-ask")), e.currentTarget);
        });
      });
      form.querySelectorAll("[data-select]").forEach(cb=>{
        cb.addEventListener("change", (e)=>{
          const ref=e.currentTarget.closest("section").getAttribute("data-ref");
          selectedByRef[ref] = e.currentTarget.checked; updateSelCount(); saveStateThrottled();
        });
      });
      form.querySelectorAll("[data-quick]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx=Number(btn.getAttribute("data-quick"));
          const item=currentQuestions()[idx];
          openQuicklook();
          const terms=(item.q+" "+(item.tip||[]).join(" ")).toLowerCase();
          const keys=["Â§","probezeit","ruhezeit","vergÃ¼tung","freistellung","ausbildungsordnung","ausbildungsplan","kÃ¼ndigung","ausland","berichtsheft"];
          const hit=keys.find(k=>terms.includes(k))||"";
          qlSearch.value=hit; renderQuicklook(hit);
        });
      });
      form.querySelectorAll("[data-bm]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ref=btn.getAttribute("data-bm");
          bookmarks[ref]=!bookmarks[ref];
          if (!bookmarks[ref]) delete bookmarks[ref];
          localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
          btn.classList.toggle("active", !!bookmarks[ref]);
          updateBMCount();
          if (window.lucide) lucide.createIcons();
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelCount(); updateProgress(); updateBMCount();
    }

    function updateSelCount(){
      const n = Object.entries(selectedByRef).filter(([r,v])=>v).length;
      selText.textContent = `${n} ausgewÃ¤hlt`;
    }
    function updateProgress(){
      const allRefs = currentQuestions().map(q=>q.ref);
      const answered = allRefs.filter(r => (answersByRef[r]||"").trim().length>0).length;
      const total = allRefs.length || 1;
      progressBar.style.width = Math.round((answered/total)*100) + "%";
      progressTxt.textContent = `${answered} / ${total} beantwortet`;
    }

    // === Prompts (wohlwollend, AILA-Style) ===
    function buildPromptSingle(item, answer){
      return `
Beurteile **wohlwollend** eine Kurzantwort (Ausbildung/Arbeitsrecht). Wenn die geforderte Anzahl erfÃ¼llt ist, bestÃ¤tige ausdrÃ¼cklich **â€žpasstâ€œ** und ergÃ¤nze nur optional weitere zulÃ¤ssige Punkte.

Antwortschema je Frage â€“ knapp:
- **Kurzfeedback** (max. 2 SÃ¤tze; inkl. â€žpasstâ€œ, falls erfÃ¼llt)
- **Richtige LÃ¶sung** (max. 4 Bulletpoints; ggf. ErgÃ¤nzungen)
- **Gesetz/Â§** (falls einschlÃ¤gig: BBiG/JArbSchG/BUrlG/ArbZG/MuSchG/AGG/DSGVO/BGB/BetrVG)
- **1 Praxistipp** (1 Satz)

Frage: ${item.q}
Antwort TN: ${answer || "(leer)"}`.trim();
    }
    function buildPromptAll(list){
      return `
Beurteile **wohlwollend** mehrere Kurzantworten (Ausbildung/Arbeitsrecht). Wenn die Soll-Anzahl erfÃ¼llt ist, schreibe **â€žpasstâ€œ** und ergÃ¤nze nur optional.

Schema je Frage (knapp):
- Kurzfeedback (max. 2 SÃ¤tze; inkl. â€žpasstâ€œ bei ErfÃ¼llung)
- Richtige LÃ¶sung (max. 4 Bulletpoints)
- Gesetz/Â§ (falls einschlÃ¤gig)
- 1 Praxistipp (1 Satz)

Fragen & Antworten:
${list.map(a=>`Q${a.nr} (${a.ref}): ${a.question}\nAntwort TN: ${a.answer || "(leer)"}`).join("\n\n")}
`.trim();
    }

    async function callAI(payload,{timeoutMs=22000,retries=1}={}){
      let lastErr;
      for(let a=0;a<=retries;a++){
        try{
          const res=await Promise.race([
            fetch(relay,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),timeoutMs))
          ]);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const t=await res.text();
          try { const j=JSON.parse(t); return j.answer||j.content||j.result||t; } catch { return t; }
        }catch(e){ lastErr=e; }
      }
      throw lastErr||new Error("Unbekannter Fehler");
    }

    async function askPerAnswer(idx, btnEl){
      const QUESTIONS = currentQuestions();
      const item = QUESTIONS[idx];
      const ref = item.ref;
      const val = (answersByRef[ref]||"").trim();

      const fb = document.getElementById(`fb_${idx}`);
      btnEl.disabled=true; const old=btnEl.innerHTML;
      btnEl.innerHTML = `<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> PrÃ¼fen â€¦`;
      fb.classList.remove("hidden"); fb.innerHTML = `<div class="text-slate-500 text-sm">KI prÃ¼ft â€¦</div>`;

      try{
        const out = await callAI({ prompt: buildPromptSingle(item,val) });
        fb.innerHTML = (window.marked ? marked.parse(out || "_Keine Antwort erhalten._") : (out || "_Keine Antwort erhalten._"));
      }catch(e){
        fb.innerHTML = `<div class="text-red-600 text-sm">Fehler: ${String(e).replace(/[<>&]/g,"")}</div>`;
        toast("KI-Check fehlgeschlagen.");
      }finally{
        btnEl.disabled=false; btnEl.innerHTML=old; if (window.lucide) lucide.createIcons();
      }
    }

    // === Gesamt-Feedback ===
    submitBtn.addEventListener("click", async ()=>{
      if (!accepted){ toast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; }
      const QUESTIONS = currentQuestions();
      let selRefs = QUESTIONS.map(q=>q.ref).filter(r=>selectedByRef[r]);
      if (selRefs.length===0){
        // falls nichts gewÃ¤hlt: alle mit Inhalt
        selRefs = QUESTIONS.map(q=>q.ref).filter(r => (answersByRef[r]||"").trim().length>0);
        if (selRefs.length===0){ toast("Bitte wÃ¤hle mindestens eine Frage (oder schreibe eine Antwort)."); return; }
      }

      const list = selRefs.map((ref, i)=>{
        const q = QUESTIONS.find(x=>x.ref===ref);
        return { nr:i+1, ref:q.ref, question:q.q, answer:(answersByRef[ref]||"").trim() };
      });

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = `<div class="text-slate-500 text-sm">KI erstellt Feedback â€¦</div>`;
      submitBtn.disabled=true; const old=submitBtn.innerHTML;
      submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> PrÃ¼fen â€¦`;

      try{
        const out = await callAI({ prompt: buildPromptAll(list) });
        aiResult.innerHTML = (window.marked ? marked.parse(out || "_Keine Antwort erhalten._") : (out || "_Keine Antwort erhalten._"));
        saveHistory(aiResult.innerHTML);
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      }catch(e){
        aiResult.innerHTML = `<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
      }finally{
        submitBtn.disabled=false; submitBtn.innerHTML=old; if (window.lucide) lucide.createIcons();
      }
    });

    // === Reset ===
    resetBtn.addEventListener("click", ()=>{
      if (!confirm("Alle Eingaben im aktuellen Cluster lÃ¶schen?")) return;
      // nur aktuelles Cluster leeren:
      currentQuestions().forEach(q=>{ delete answersByRef[q.ref]; delete selectedByRef[q.ref]; });
      renderQuestions(); saveState();
      resultWrap.classList.add("hidden"); aiResult.innerHTML="";
      window.scrollTo({top:0, behavior:"smooth"});
    });

    // === Save / Load ===
    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          ts:Date.now(), accepted, activeKey, answersByRef, selectedByRef
        }));
      }catch{}
    }
    let tmr=null; function saveStateThrottled(){ clearTimeout(tmr); tmr=setTimeout(saveState, 400); }

    // === Toast ===
    function toast(msg){ toastEl.textContent=msg; toastEl.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.style.display="none", 2600); }

    // === Init ===
    renderTabs();
    renderQuestions();

  });
  </script>
</body>
</html>
