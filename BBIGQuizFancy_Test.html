<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz – Prüfungsmodus + Quicklook + Rubrik</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Markdown -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --surface:#ffffff; --surface-2:#f6f8fb; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --brand:#0ea5e9; --brand-2:#2563eb; --ok:#10b981; --warn:#f59e0b; --error:#ef4444;
      --radius:14px; --radius-sm:10px; --shadow-1:0 8px 28px rgba(2,8,23,.06);
    }
    @media (prefers-color-scheme: dark){
      html{ color-scheme: dark; }
      body{ background: linear-gradient(to bottom, #0b1220, #0b1220 40%, #111827 100%); }
      :root{ --surface:#0f172a; --surface-2:#0b1327; --ink:#e5e7eb; --muted:#9aa6b2; --border:#1f2937; }
    }
    html, body { font-size: 16px; }
    @media (max-width: 640px){ html, body { font-size: 17px; } } /* bessere Lesbarkeit mobil */

    body{ background: linear-gradient(to bottom, #fff, #f4f7fb); color: var(--ink); }
    .container{ max-width: 1100px; margin-inline: auto; padding-inline: 1rem; }
    .card{ background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-1); }
    .chip{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:var(--surface-2); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border-radius: var(--radius-sm); border:1px solid var(--border); background: var(--surface); color: var(--ink); }
    .btn:hover{ background:#f8fafc; }
    .btn-primary{ border-color:transparent; background:linear-gradient(180deg, var(--brand), var(--brand-2)); color:#fff; }
    .btn-primary:hover{ filter:brightness(0.98); }
    .btn-ghost{ background:transparent; }
    .btn-sm{ padding:.45rem .6rem; border-radius:10px; }
    .btn-lg{ padding:.9rem 1.05rem; border-radius:12px; }
    .btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--brand) 50%, transparent); outline-offset:2px; }
    .progress-outer{ height:10px; border-radius:999px; background:#eaeef4; overflow:hidden; }
    .progress-inner{ height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg, var(--brand), var(--ok)); transition:width .25s; }
    .q-badge{ background: color-mix(in oklab, var(--brand) 18%, #eaf6ff 82%); color: color-mix(in oklab, var(--brand) 80%, #0b3b52 20%); }
    .rubric{ border:1px dashed var(--border); border-radius:12px; padding:.5rem .6rem; background:var(--surface-2); }
    .rubric .bar{ height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .rubric .fill{ height:100%; width:0%; background:linear-gradient(90deg, #93c5fd, #2563eb); transition: width .3s; }
    .tip > div{ border-left:3px solid var(--brand); background:#f0f9ff; color:#0b3b52; border-radius:12px; padding:.75rem .85rem; }
    @media (prefers-color-scheme:dark){ .tip > div{ background:rgba(14,165,233,.08); color:#cce9fb; } }
    details[open] summary .chev{ transform:rotate(180deg); }
    summary{ list-style:none; }

    /* Notice */
    .notice{ background:linear-gradient(135deg, #e0f2fe, #dbeafe); border-bottom:1px solid rgba(2,8,23,.08); }
    .notice .inner{ backdrop-filter:blur(6px); }

    /* Quicklook Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; z-index:98; }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:99; }
    .modal .panel{ width:100%; max-width:900px; border-radius:1rem; }
    .modal.open, .modal-backdrop.open{ display:flex; }

    /* Exam banner */
    .exam-on { background: #fff7ed; border:1px solid #fed7aa; }

    /* Print */
    @media print{
      .sticky, .sticky-actions, #notice, #quickBtn, #examToggleWrap { display:none!important; }
      body{ background:#fff!important; }
      .card{ box-shadow:none!important; border:1px solid #ddd; }
    }
    footer.app-footer{ font-family:Arial, Helvetica, sans-serif; font-size:10px; line-height:1.4; }
  </style>
</head>
<body class="min-h-screen antialiased">
  <!-- Disclaimer -->
  <aside id="notice" class="notice sticky top-0 z-50">
    <div class="inner container px-4 py-3 flex items-start gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-100 grid place-items-center shrink-0">
        <i data-lucide="shield-check" class="w-6 h-6 text-sky-700"></i>
      </div>
      <div class="text-sm leading-snug">
        <p class="font-semibold text-sky-900">Fachlicher Hinweis (Pilot)</p>
        <p class="text-sky-900/90">
          Die KI-Prüfung unterstützt beim Lernen. Ergebnisse müssen fachlich geprüft werden und ersetzen keine Rechtsberatung.
          <strong>Es dürfen keine personenbezogenen oder sensiblen Daten eingegeben oder erfasst werden.</strong>
        </p>
        <label class="mt-2 inline-flex items-center gap-2">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-sky-600" aria-describedby="ackDesc">
          <span id="ackDesc" class="text-sky-950">Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
        <span id="ackState" class="chip">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn">Weiter</button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="container px-4 pt-4">
    <div class="flex flex-wrap items-center gap-3">
      <div class="w-11 h-11 rounded-2xl bg-sky-100 grid place-items-center">
        <i data-lucide="graduation-cap" class="w-6 h-6 stroke-[1.6] text-sky-700"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight truncate">BBiG-Quiz – Prüfungsmodus + Quicklook + Rubrik</h1>
        <p class="text-sm text-slate-500">20 Kernfragen. KI-Feedback mit Rubriken. §-Quicklook zu BBiG/JArbSchG.</p>
      </div>

      <div id="examToggleWrap" class="flex items-center gap-2 p-2 rounded-xl border border-amber-200 exam-on">
        <i data-lucide="timer" class="w-4 h-4 text-amber-600"></i>
        <label class="text-sm">Prüfungsmodus</label>
        <input id="examToggle" type="checkbox" class="w-5 h-5 accent-amber-600" />
        <select id="examSize" class="ml-1 text-sm rounded-lg border px-2 py-1">
          <option value="10">10 Fragen</option>
          <option value="20" selected>20 Fragen</option>
          <option value="40">40 (wenn vorhanden)</option>
        </select>
        <span id="examTimer" class="text-xs text-amber-700 ml-1">—</span>
      </div>

      <button id="quickBtn" type="button" class="btn btn-primary">
        <i data-lucide="search" class="w-4 h-4"></i> §-Quicklook
      </button>
    </div>
  </header>

  <!-- Progress -->
  <section class="container px-4 mt-4" aria-labelledby="progh">
    <div class="card p-4">
      <div class="flex items-center gap-3">
        <i data-lucide="target" class="w-5 h-5 text-sky-700"></i>
        <div class="flex-1">
          <div class="flex justify-between text-xs text-slate-600 mb-1">
            <span id="progressText">0 / 20 beantwortet</span>
            <span id="selText">0 ausgewählt</span>
          </div>
          <div class="progress-outer" role="progressbar" aria-valuemin="0" aria-valuemax="20" aria-valuenow="0" aria-labelledby="progh">
            <div id="progressBar" class="progress-inner"></div>
          </div>
          <span id="progh" class="sr-only">Beantwortete Fragen</span>
        </div>
        <time id="timer" class="text-xs text-slate-500 ml-3" aria-live="polite">00:00</time>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container px-4 py-4">
    <form id="form" class="grid gap-4 sm:gap-5" novalidate aria-describedby="formhint"></form>
    <p id="formhint" class="sr-only">Mit Strg/⌘+Enter kannst du das KI-Gesamt-Feedback abrufen.</p>

    <section id="resultWrap" class="mt-5 hidden" aria-live="polite">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkle" class="w-5 h-5 text-emerald-700"></i>
          <h2 class="text-base font-semibold">KI-Feedback (Gesamt)</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky actions -->
  <div class="sticky bottom-0 z-40 bg-white/95 border-t border-slate-200 backdrop-blur">
    <div class="container px-4 py-2 flex flex-wrap items-center gap-2">
      <div class="flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener" aria-label="BBiG (PDF)">
          <i data-lucide="book-open" class="w-4 h-4"></i>
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener" aria-label="JArbSchG (PDF)">
          <i data-lucide="shield" class="w-4 h-4"></i>
        </a>
      </div>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback (Auswahl)
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">Zurücksetzen</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite" style="display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:100;"></div>

  <!-- Quicklook Modal -->
  <div id="qlBackdrop" class="modal-backdrop"></div>
  <div id="qlModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="qlTitle">
    <div class="panel card p-4 sm:p-5" role="document">
      <div class="flex items-start gap-2">
        <div class="w-10 h-10 rounded-xl bg-sky-100 grid place-items-center">
          <i data-lucide="search" class="w-5 h-5 text-sky-700"></i>
        </div>
        <div class="flex-1">
          <h3 id="qlTitle" class="text-base font-semibold">§-Quicklook – BBiG & JArbSchG</h3>
          <p class="text-sm text-slate-500">Suche nach Paragraph/Begriff (z. B. „§11“, „Probezeit“, „Ruhezeit“). Auszug + Sprung ins PDF.</p>
        </div>
        <button id="qlClose" type="button" class="btn" aria-label="Fenster schließen">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="mt-3 flex flex-col sm:flex-row gap-2">
        <input id="qlSearch" type="search" class="flex-1 rounded-xl border px-3 py-2" placeholder="Begriff oder § …">
        <div class="flex gap-2">
          <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener"><i data-lucide="book-open" class="w-4 h-4"></i> BBiG</a>
          <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener"><i data-lucide="shield" class="w-4 h-4"></i> JArbSchG</a>
        </div>
      </div>
      <div id="qlList" class="mt-3 grid gap-2 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer bg-slate-100 text-slate-700">
    <div class="container px-4 py-4">
      Diese Anwendung nutzt künstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antwort von OpenAI verarbeitet und geprüft werden.
      Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbräuchlich verwendet werden.
      Es dürfen keine personenbezogenen Daten, sensiblen Daten oder Daten erfasst werden, die Rückschlüsse auf eine Person, zum Beispiel Auszubildenden,
      Ausbilder oder ähnliche Personen ermöglichen. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind vom Anwender zu prüfen.
      KI-generierte Antworten können fehlerhaft sein. Keine Haftung.
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // === Konfiguration ===
    const relay = "/api/linda-proxy";           // dein Proxy
    const STORAGE_KEY = "BBIGQUIZ_EXAM_V1";
    const MAX_ANSWER_CHARS = 1500;
    const RUBRIC_KEYS = ["normbezug","vollstaendigkeit","praxisbezug"]; // 0..2 Punkte je Kriterium

    // UI-Refs
    const form = document.getElementById("form");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn  = document.getElementById("resetBtn");
    const timerEl   = document.getElementById("timer");
    const resultWrap= document.getElementById("resultWrap");
    const aiResult  = document.getElementById("aiResult");

    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");

    const examToggle = document.getElementById("examToggle");
    const examSize   = document.getElementById("examSize");
    const examTimer  = document.getElementById("examTimer");

    const quickBtn = document.getElementById("quickBtn");
    const qlBackdrop = document.getElementById("qlBackdrop");
    const qlModal = document.getElementById("qlModal");
    const qlClose = document.getElementById("qlClose");
    const qlSearch = document.getElementById("qlSearch");
    const qlList = document.getElementById("qlList");

    const toastEl = document.getElementById("toast");

    if (window.marked) marked.setOptions({ breaks:true, gfm:true });
    if (window.lucide) lucide.createIcons();

    // Timer (Sitzungsuhr)
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    }, 1000);

    // === Fragen (20 Kernfragen) ===
    const QUESTIONS_ALL = [
      { ref:"V1 – Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehören.", tip:["Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung, Vergütung, Probezeit, Urlaub, tägliche Ausbildungszeit, Kündigung, Hinweise auf Tarif/BV, Form des Ausbildungsnachweises.","§ 11 BBiG; Textform/elektronisch zulässig."]},
      { ref:"V2 – Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:["Berufsbild, Dauer/Ausbildungsrahmenplan, Prüfungen.","§§ 4–5 BBiG."]},
      { ref:"V3 – Probezeit", q:"Wie lang muss/darf die Probezeit sein – und warum ist sie wichtig?", tip:["Mind. 1, max. 4 Monate; Eignungsprüfung beider Seiten.","§ 20 BBiG."]},
      { ref:"V4 – Minderjährige: Unterschrift", q:"Wer unterschreibt den Vertrag bei Minderjährigen mit gemeinsamem Sorgerecht?", tip:["Beide Sorgeberechtigte + Minderjährige/r.","§ 10 BBiG; §§ 1626, 1629 BGB."]},
      { ref:"V5 – Berufsschulzeit & Arbeitszeit", q:"Wie werden Berufsschulzeiten auf die Arbeitszeit angerechnet (U18 vs. ≥18)?", tip:["U18: besondere Anrechnung (JArbSchG).","Wegezeiten Schule→Betrieb anrechenbar (§ 15 Abs. 2 Nr. 1 BBiG).","≥18: ArbZG; Freistellung nach § 15 BBiG."]},
      { ref:"V6 – Ruhezeit Jugendliche", q:"Welche tägliche Mindestruhezeit gilt für Jugendliche?", tip:["Mindestens 12 Stunden.","JArbSchG."]},
      { ref:"V7 – Vergütung", q:"Was gilt zur Angemessenheit der Ausbildungsvergütung?", tip:["MiAV Untergrenze; tariflich/branchenüblich; Steigerung je Jahr.","§ 17 BBiG."]},
      { ref:"V8 – Überstunden", q:"Sind Überstunden zulässig – und wie werden sie behandelt?", tip:["Nur ausbildungsdienlich; Vergütung/Zeitausgleich; Jugendarbeitsschutz beachten.","ArbZG/JArbSchG; BBiG."]},
      { ref:"V9 – Betrieblicher Ausbildungsplan", q:"Wozu dient der betriebliche Ausbildungsplan?", tip:["Umsetzung Rahmenplan, zeitl./sachl. Gliederung, Qualitätssicherung.","§ 5 BBiG; Verweis § 11 Abs. 1 S. 2."]},
      { ref:"V10 – Berichtsheft", q:"Welche Bedeutung hat das Berichtsheft und wer kontrolliert es?", tip:["Zulassungsvoraussetzung; elektronisch möglich; Kontrolle Ausbilder/in.","§ 13 Nr.7, § 14 BBiG."]},
      { ref:"V11 – Verkürzung", q:"Wann kann die Ausbildungsdauer verkürzt werden?", tip:["Vorbildung/Leistung/Anrechnung; Einvernehmen nötig.","§ 8 BBiG."]},
      { ref:"V12 – Verlängerung", q:"Wann kommt eine Verlängerung in Betracht?", tip:["Nichtbestehen oder besondere Fälle.","§ 8 Abs. 2 BBiG."]},
      { ref:"V13 – Teilzeitberufsausbildung", q:"Wie funktioniert Teilzeit in der Ausbildung und was bleibt unverändert?", tip:["Reduzierte Zeiten, Lernziel bleibt; evtl. längere Gesamtdauer.","§ 7a BBiG."]},
      { ref:"V14 – Datenschutz/Geheimnis", q:"Welche Pflichten haben Azubis zu Datenschutz und Betriebsgeheimnissen?", tip:["DSGVO/BDSG beachten; Unterweisungen dokumentieren."]},
      { ref:"V15 – Kündigung", q:"Welche Kündigungsregeln gelten in und nach der Probezeit?", tip:["Probezeit: jederzeit fristlos (§ 22 Abs. 1).","Danach: fristlos aus wichtigem Grund oder mit Frist (Berufsaufgabe/Wechsel) – schriftlich, Gründe nennen (§ 22)."]},
      { ref:"V16 – Schwangerschaft/Mutterschutz", q:"Welche Schutzregeln gelten bei Schwangerschaft in der Ausbildung?", tip:["MuSchG: Schutzfristen, Beschäftigungsverbote, Kündigungsschutz."]},
      { ref:"V17 – Nachteilsausgleich", q:"Wie werden Auszubildende mit Behinderung in Prüfungen unterstützt?", tip:["Nachteilsausgleich (Zeit, Hilfsmittel) auf Antrag; Chancengleichheit."]},
      { ref:"V18 – Ausland", q:"Sind Ausbildungsabschnitte im Ausland möglich und wie werden sie angerechnet?", tip:["Ja; Ausbildungsziel wahren; bis zulässige Zeitanteile.","§ 2 Abs. 3 BBiG."]},
      { ref:"V19 – Versetzung", q:"Darf der Betrieb Azubis versetzen?", tip:["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten klären.","§ 14 BBiG."]},
      { ref:"V20 – Insolvenz", q:"Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip:["Fortführung/Anschlussbetrieb/IHK-Unterstützung; ggf. Insolvenzgeld."]}
    ];

    // === §-Quicklook Mini-Index (öffentl. Rechtstexte: kurze Auszüge) ===
    const LAW_INDEX = [
      { law:"BBiG", para:"§ 11", tags:["vertrag","inhalte","mindestinhalte"], excerpt:"§ 11 BBiG – Niederschrift der wesentlichen Inhalte (u. a. Parteien, Beginn/Dauer, Ziel, sachliche/zeitliche Gliederung, Vergütung, Probezeit, Urlaub, Kündigung).", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 20", tags:["probezeit"], excerpt:"§ 20 BBiG – Probezeit mindestens 1, höchstens 4 Monate.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 15", tags:["freistellung","schule","wegezeit"], excerpt:"§ 15 BBiG – Freistellung für Berufsschule/Prüfungen; Wegezeiten Schule→Betrieb sind anzurechnen.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 17", tags:["vergütung","miav"], excerpt:"§ 17 BBiG – Angemessene Vergütung; Mindestausbildungsvergütung als Untergrenze.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"JArbSchG", para:"§ 8–15", tags:["arbeitszeit","ruhezeit","pausen"], excerpt:"JArbSchG – Tägliche und wöchentliche Höchstarbeitszeiten; Ruhepausen; Ruhezeit mind. 12 Std.", link:"https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" },
      { law:"ArbZG", para:"§ 3, § 4, § 5", tags:["erwachsene","arbeitszeit","pausen","ruhezeit"], excerpt:"ArbZG – 8 Std/Tag (bis 10 mit Ausgleich), Pausen 30–45 Min, Ruhezeit 11 Std.", link:"https://www.gesetze-im-internet.de/arbzg/BJNR117100994.html" },
    ];

    // === State ===
    let accepted = false;
    let examMode = false;
    let examCountdown = null; // Sekunden
    let examTick = null;      // Interval ID

    let pool = [...QUESTIONS_ALL];   // aktuell verwendeter Pool (ggf. reduziert/geshuffled)
    let answers = {};                // {ref: text}
    let selected = {};               // {ref: boolean}
    let rubrics  = {};               // {ref: {normbezug:0..2, vollstaendigkeit:0..2, praxisbezug:0..2}}

    // Disclaimer
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked){ showToast("Bitte die Checkbox bestätigen."); return; }
      accepted = true; notice.style.display = "none"; ackState.textContent = "Hinweis bestätigt"; ackState.className = "chip";
      saveState();
    });

    // Exam: toggle + Size
    examToggle.addEventListener("change", ()=>{ setExamMode(examToggle.checked); });
    examSize.addEventListener("change", ()=>{ applyExamSizing(); });

    function setExamMode(on){
      examMode = !!on;
      document.getElementById("examToggleWrap").classList.toggle("exam-on", examMode);
      applyExamSizing();
      renderForm();
      updateProgress();
      if (examMode){
        // 1,5 Minuten pro Frage Richtwert
        const mins = Math.ceil(pool.length * 1.5);
        startCountdown(mins * 60);
      } else {
        stopCountdown();
      }
      saveState();
    }
    function startCountdown(seconds){
      examCountdown = seconds;
      updateCountdownLabel();
      clearInterval(examTick);
      examTick = setInterval(()=>{
        examCountdown = Math.max(0, examCountdown - 1);
        updateCountdownLabel();
        if (examCountdown === 0){ clearInterval(examTick); showToast("Zeit abgelaufen – bitte abgeben."); }
      }, 1000);
    }
    function stopCountdown(){ clearInterval(examTick); examTick = null; examTimer.textContent = "—"; }
    function updateCountdownLabel(){
      const m = String(Math.floor(examCountdown/60)).padStart(2,"0");
      const s = String(examCountdown%60).padStart(2,"0");
      examTimer.textContent = `${m}:${s}`;
    }
    function applyExamSizing(){
      // Pool neu bilden: shuffle + size
      const size = Number(examSize.value) || 20;
      const shuffled = [...QUESTIONS_ALL].sort(()=>Math.random()-0.5);
      pool = shuffled.slice(0, Math.min(size, QUESTIONS_ALL.length));
    }

    // Autosize
    function autosize(el){ el.style.height="auto"; el.style.height=(el.scrollHeight+4)+"px"; }

    // Form render
    function renderForm(){
      // Werte sichern
      [...form.querySelectorAll("section[data-ref]")].forEach(sec=>{
        const ref = sec.getAttribute("data-ref");
        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answers[ref]  = ta.value;
        if (cb) selected[ref] = cb.checked;
      });

      form.innerHTML = "";
      pool.forEach((item, idx)=>{
        const id = `q_${idx}`, fbId = `fb_${idx}`, selId = `sel_${idx}`;
        const sec = document.createElement("section");
        sec.className = "card p-4";
        sec.setAttribute("data-ref", item.ref);

        // Tipps ggf. sperren
        const tipHtml = `
          <details class="tip mb-2" ${examMode ? "open hidden" : ""}>
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-sky-700 hover:text-sky-900 text-[13px]">
              <i class="chev" data-lucide="chevron-down"></i><span>🛈 Musterlösung</span>
            </summary>
            <div class="mt-2">${(item.tip||[]).map(t=>`<p>${t}</p>`).join("")}</div>
          </details>`;

        // Rubrik-UI (wird von KI befüllt, aber jederzeit einblendbar)
        const r = rubrics[item.ref] || {normbezug:0, vollstaendigkeit:0, praxisbezug:0};
        const sum = r.normbezug + r.vollstaendigkeit + r.praxisbezug;
        const rubricHtml = `
          <details class="mb-2" >
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-slate-700 hover:text-slate-900 text-[13px]">
              <i data-lucide="grid" class="w-4 h-4"></i><span>Rubrik anzeigen (Punkte: <strong>${sum}/6</strong>)</span>
            </summary>
            <div class="rubric mt-2 space-y-3">
              ${renderRubricRow("Normbezug", "normbezug", r.normbezug)}
              ${renderRubricRow("Vollständigkeit", "vollstaendigkeit", r.vollstaendigkeit)}
              ${renderRubricRow("Praxisbezug", "praxisbezug", r.praxisbezug)}
            </div>
          </details>`;
        function renderRubricRow(label, key, val){
          const pct = Math.round((val/2)*100);
          return `
            <div>
              <div class="flex justify-between text-xs mb-1"><span>${label}</span><span>${val}/2</span></div>
              <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
            </div>`;
        }

        sec.innerHTML = `
          <header class="flex items-center justify-between gap-3 mb-2">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-sky-600" data-select="${idx}" aria-label="Für KI-Feedback auswählen">
              <span class="q-badge chip">${item.ref}</span>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="btn btn-sm" data-quicklook="${idx}" title="§-Quicklook zu dieser Frage">
                <i data-lucide="search" class="w-4 h-4"></i> § Quicklook
              </button>
              <span class="text-slate-400 text-[11px]">Frage ${idx+1}/${pool.length}</span>
            </div>
          </header>

          <h3 class="text-[15px] sm:text-[16px] font-semibold mb-2">${item.q}</h3>
          ${tipHtml}

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]" placeholder="Deine Antwort …"></textarea>

          <div class="mt-2 flex flex-wrap gap-2">
            <button type="button" data-fill="${id}" class="btn btn-sm">Beispiel-Gliederung</button>
            <button type="button" data-ask="${idx}" class="btn btn-sm ${examMode ? 'opacity-50 pointer-events-none' : ''}">
              <i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check (Rubrik)
            </button>
          </div>

          ${rubricHtml}

          <div id="${fbId}" class="prose prose-slate text-sm max-w-none hidden mt-2"></div>
        `;
        form.appendChild(sec);

        // restore
        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector(`[data-select]`);
        const saved = answers[item.ref] || "";
        ta.value = saved; autosize(ta);
        if (selected[item.ref] != null) cb.checked = !!selected[item.ref];

      });

      // events
      form.querySelectorAll("textarea").forEach(ta=>{
        ta.addEventListener("input", ()=>{
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          answers[ref] = ta.value;
          saveStateSchedule();
        });
        ta.addEventListener("keydown", (ev)=>{
          if ((ev.ctrlKey||ev.metaKey) && ev.key === "Enter"){ ev.preventDefault(); submitBtn.click(); }
        });
      });
      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const tid = e.currentTarget.getAttribute("data-fill");
          const ta = document.getElementById(tid);
          ta.value = ["### Kurzantwort","- …","- …","- …","","### Begründung/Norm (optional)","- …"].join("\n");
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          answers[ref] = ta.value; saveStateSchedule();
        });
      });
      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!relay){ showToast("Kein Backend konfiguriert."); return; }
          if (!accepted){ showToast("Bitte zuerst den Hinweis bestätigen."); return; }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });
      form.querySelectorAll("[data-select]").forEach(cb=>{
        cb.addEventListener("change",(e)=>{
          const ref=e.currentTarget.closest("section[data-ref]")?.getAttribute("data-ref");
          selected[ref] = e.currentTarget.checked; updateSelCount(); saveStateSchedule();
        });
      });
      form.querySelectorAll("[data-quicklook]").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const idx = Number(e.currentTarget.getAttribute("data-quicklook"));
          openQuicklookFor(pool[idx]);
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelCount(); updateProgress();
    }

    function updateSelCount(){
      const n=[...form.querySelectorAll("[data-select]:checked")].length;
      selText.textContent=`${n} ausgewählt`;
    }
    function updateProgress(){
      const t=[...form.querySelectorAll("textarea")];
      const f=t.filter(x=>x.value.trim().length>0).length;
      const total=t.length||1;
      progressBar.style.width=Math.round((f/total)*100)+"%";
      progressTxt.textContent=`${f} / ${total} beantwortet`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuemax", String(total));
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuenow", String(f));
    }

    // === KI-Prompting mit Rubrik (JSON) ===
    function buildPromptSingle(item, answer){
      return `
Bewerte **wohlwollend** eine Kurzantwort (Ausbildung/Arbeitsrecht). Wenn die Soll-Anzahl erreicht ist: „passt“, danach optional ergänzen.

Gib zuerst **JSON** ausschließlich mit folgendem Schema (keine Einleitung, kein Codeblock!):
{"rubrik":{"normbezug":0..2,"vollstaendigkeit":0..2,"praxisbezug":0..2},"kommentar":"kurzes Feedback (1-2 Sätze)","loesung":["max. 4 Stichpunkte"],"gesetz":"§/Gesetz oder leer","praxistipp":"ein Satz"}

Danach (unterhalb der JSON-Ausgabe) darfst du zusätzlich eine kurze Markdown-Auswertung schreiben.

Frage: ${item.q}
Antwort TN: ${answer || "(leer)"} `.trim();
    }

    async function callAI(payload,{timeoutMs=25000,retries=1}={}){
      const url=relay; let lastErr;
      for(let a=0;a<=retries;a++){
        try{
          const res=await Promise.race([
            fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),timeoutMs))
          ]);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const t=await res.text(); try{const j=JSON.parse(t); return j.answer||j.content||j.result||t;}catch{return t;}
        }catch(e){ lastErr=e; }
      }
      throw lastErr||new Error("Unbekannter Fehler");
    }

    async function askPerAnswer(idx, btnEl){
      const item = pool[idx];
      const ref  = item.ref;
      const val  = (answers[ref]||"").trim().slice(0, MAX_ANSWER_CHARS);
      const fb   = form.querySelectorAll("[id^='fb_']")[idx];

      btnEl.disabled = true; const old = btnEl.innerHTML;
      btnEl.innerHTML = `<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> Prüfen …`;
      fb.classList.remove("hidden");
      fb.innerHTML = `<div class="text-slate-500 text-sm">KI prüft diese Antwort …</div>`;

      try{
        const prompt = buildPromptSingle(item, val);
        const aiText = await callAI({prompt});
        // parse first JSON object from the response
        const jsonMatch = aiText.match(/\{[\s\S]*?\}/);
        if (jsonMatch){
          try{
            const obj = JSON.parse(jsonMatch[0]);
            const rr = (obj.rubrik||{});
            rubrics[ref] = {
              normbezug: clamp(Number(rr.normbezug)||0,0,2),
              vollstaendigkeit: clamp(Number(rr.vollstaendigkeit)||0,0,2),
              praxisbezug: clamp(Number(rr.praxisbezug)||0,0,2),
            };
            saveStateSchedule();
            // re-render rubric block only
            const sec = form.querySelector(`section[data-ref="${CSS.escape(ref)}"]`);
            if (sec){
              // force re-render by calling renderForm but keep scroll
              const y = window.scrollY;
              renderForm();
              window.scrollTo(0,y);
            }
          }catch{}
        }
        fb.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
      }catch(e){
        fb.innerHTML = `<div class="text-red-600 text-sm">KI-Check fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
        showToast("KI-Check fehlgeschlagen.");
      }finally{
        btnEl.disabled=false; btnEl.innerHTML=old; if(window.lucide) lucide.createIcons();
      }
    }
    function clamp(x,min,max){ return Math.max(min, Math.min(max, x)); }

    // === Gesamtfeedback (nur Auswahl → sonst alle mit Inhalt → sonst alle)
    document.getElementById("submitBtn").addEventListener("click", async ()=>{
      if (!accepted){ showToast("Bitte zuerst den Hinweis bestätigen."); return; }
      let idxs = [...form.querySelectorAll("[data-select]:checked")].map((cb)=> {
        const card = cb.closest("section"); return [...form.children].indexOf(card);
      });
      if (idxs.length===0){
        const withContent = pool.map((q,i)=>({i,has:(answers[q.ref]||"").trim().length>0})).filter(x=>x.has).map(x=>x.i);
        idxs = withContent.length ? withContent : pool.map((_,i)=>i);
      }
      const answersSlice = idxs.map(i=>{
        const ref=pool[i].ref; const v=(answers[ref]||"").trim().slice(0,MAX_ANSWER_CHARS);
        return { nr:i+1, ref, question:pool[i].q, answer:v };
      });

      // Build lenient, rubric-aware prompt
      const prompt = `
Bewerte **wohlwollend** mehrere Kurzantworten (Ausbildung/Arbeitsrecht) und liefere je Frage zuerst **JSON** nach Schema:
{"rubrik":{"normbezug":0..2,"vollstaendigkeit":0..2,"praxisbezug":0..2},"kommentar":"1-2 Sätze (Sag „passt“, wenn Soll-Anzahl erfüllt)","loesung":["max. 4 Stichpunkte"],"gesetz":"§/Gesetz","praxistipp":"ein Satz"}

Danach darf eine kurze Markdown-Zusammenfassung folgen.

Fragen & Antworten:
${answersSlice.map(a => `Q${a.nr} (${a.ref}): ${a.question}\nAntwort TN: ${a.answer || "(leer)"}`).join("\n\n")}
      `.trim();

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = `<div class="text-slate-500 text-sm">KI erstellt Feedback …</div>`;
      submitBtn.disabled = true; const old = submitBtn.innerHTML;
      submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> Prüfen …`;

      try{
        const aiText = await callAI({prompt});
        aiResult.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
      }catch(e){
        aiResult.innerHTML = `<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
      }finally{
        submitBtn.disabled=false; submitBtn.innerHTML=old; if(window.lucide) lucide.createIcons();
      }

      // Im Prüfungsmodus: Tipps nach Abgabe freigeben
      if (examMode){
        form.querySelectorAll(".tip").forEach(t=>t.classList.remove("hidden"));
      }
    });

    // Reset
    resetBtn.addEventListener("click", ()=>{
      if (!confirm("Alles löschen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      answers = {}; selected = {}; rubrics = {};
      pool = [...QUESTIONS_ALL];
      examToggle.checked = false; setExamMode(false);
      renderForm(); resultWrap.classList.add("hidden"); aiResult.innerHTML="";
      window.scrollTo({ top:0, behavior:"smooth" });
    });

    // === Quicklook ===
    function openQuicklook(){ qlBackdrop.classList.add("open"); qlModal.classList.add("open"); qlSearch.value=""; renderQuicklook(""); qlSearch.focus(); }
    function closeQuicklook(){ qlBackdrop.classList.remove("open"); qlModal.classList.remove("open"); }
    quickBtn.addEventListener("click", openQuicklook);
    qlBackdrop.addEventListener("click", closeQuicklook);
    qlClose.addEventListener("click", closeQuicklook);
    qlSearch.addEventListener("input", (e)=> renderQuicklook(e.target.value));
    function openQuicklookFor(item){
      openQuicklook();
      // einfache Heuristik: zeige passende Einträge
      const terms = (item.q + " " + (item.tip||[]).join(" ")).toLowerCase();
      const keys = ["§","probezeit","ruhezeit","vergütung","freistellung","ausbildungsordnung","ausbildungsplan","kündigung","ausland","berichtsheft"];
      const hit = keys.find(k=>terms.includes(k));
      qlSearch.value = hit || "";
      renderQuicklook(qlSearch.value);
    }
    function renderQuicklook(query){
      const q = (query||"").trim().toLowerCase();
      const list = (q ? LAW_INDEX.filter(x =>
        x.para.toLowerCase().includes(q) ||
        x.law.toLowerCase().includes(q) ||
        x.tags.some(t=>t.includes(q))
      ) : LAW_INDEX);
      qlList.innerHTML = "";
      if (list.length===0){
        qlList.innerHTML = `<div class="text-sm text-slate-500">Keine Treffer. Probiere „§11“, „Probezeit“, „Ruhezeit“ …</div>`;
        return;
      }
      list.forEach(x=>{
        const row = document.createElement("div");
        row.className = "p-3 rounded-lg border hover:bg-slate-50";
        row.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${x.law} ${x.para}</div>
            <a class="btn btn-sm" href="${x.link}" target="_blank" rel="noopener">PDF öffnen</a>
          </div>
          <div class="text-sm text-slate-600 mt-1">${x.excerpt}</div>
          <div class="mt-1 flex flex-wrap gap-1">${x.tags.map(t=>`<span class="chip">${t}</span>`).join("")}</div>
        `;
        qlList.appendChild(row);
      });
    }

    // Toast
    function showToast(msg){
      toastEl.textContent=msg; toastEl.style.display="block";
      clearTimeout(showToast._t); showToast._t=setTimeout(()=> toastEl.style.display="none", 2800);
    }

    // Save/Load
    function saveState(){
      try{
        const state = {
          ts: Date.now(),
          accepted,
          examMode,
          examSize: examSize.value,
          answers, selected, rubrics,
          poolRefs: pool.map(p=>p.ref)
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch{}
    }
    let saveTimer=null;
    function saveStateSchedule(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveState, 500); }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const st = JSON.parse(raw);
        accepted = !!st.accepted;
        if (accepted){ notice.style.display="none"; ack.checked=true; ackState.textContent="Hinweis bestätigt"; ackState.className="chip"; }
        examToggle.checked = !!st.examMode;
        examSize.value = st.examSize || "20";
        answers = st.answers || {};
        selected= st.selected|| {};
        rubrics = st.rubrics || {};
        // Pool wiederherstellen falls möglich
        if (Array.isArray(st.poolRefs) && st.poolRefs.length){
          const map = Object.fromEntries(QUESTIONS_ALL.map(q=>[q.ref,q]));
          pool = st.poolRefs.map(r=>map[r]).filter(Boolean);
        }else{
          pool = [...QUESTIONS_ALL];
        }
        if (examToggle.checked){ setExamMode(true); } // setzt Pool/Timer
      }catch{}
    }

    // Init
    loadState();
    if (!examToggle.checked){ applyExamSizing = ()=>{ pool=[...QUESTIONS_ALL]; }; } // Standard ohne Exam: keine Reduktion
    renderForm();
  });
  </script>
</body>
</html>
