<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz â€“ Enterprise Edition</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Markdown -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    :root{
      /* metafinanz Professional Color Palette */
      --mf-primary: #005eb8;
      --mf-primary-dark: #004a93;
      --mf-primary-light: #1976d2;
      --mf-secondary: #00a0e3;
      --mf-accent: #00d4aa;
      --mf-gray-50: #fafbfc;
      --mf-gray-100: #f5f7fa;
      --mf-gray-200: #e8ecf1;
      --mf-gray-300: #d1d9e3;
      --mf-gray-400: #98a6b8;
      --mf-gray-500: #6b7a8f;
      --mf-gray-600: #4d5d70;
      --mf-gray-700: #354152;
      --mf-gray-800: #1f2937;
      --mf-gray-900: #0f172a;
      
      --surface: #ffffff; 
      --surface-2: #fafbfc; 
      --surface-3: #f5f7fa;
      --ink: #1f2937; 
      --ink-light: #4d5d70;
      --muted: #6b7a8f; 
      --border: #e8ecf1;
      --brand: #005eb8; 
      --brand-2: #004a93; 
      --brand-light: #1976d2;
      --success: #00d4aa; 
      --warning: #ff9800; 
      --error: #e53935;
      
      --radius: 16px; 
      --radius-lg: 20px;
      --radius-sm: 12px; 
      --radius-xs: 8px;
      
      --shadow-sm: 0 1px 2px rgba(0,0,0,.04);
      --shadow-md: 0 4px 12px rgba(0,0,0,.06), 0 1px 3px rgba(0,0,0,.04);
      --shadow-lg: 0 8px 24px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04);
      --shadow-xl: 0 16px 48px rgba(0,0,0,.1), 0 4px 12px rgba(0,0,0,.06);
      --shadow-hover: 0 12px 32px rgba(0,94,184,.12), 0 4px 8px rgba(0,0,0,.06);
    }
    
    html.dark {
      color-scheme: dark;
      --surface: #0f172a; 
      --surface-2: #1e293b; 
      --surface-3: #334155;
      --ink: #f1f5f9; 
      --ink-light: #cbd5e1;
      --muted: #94a3b8; 
      --border: #334155;
      --brand: #1976d2;
      --brand-2: #005eb8;
      --brand-light: #42a5f5;
    }
    
    html.dark body {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }
    
    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body { 
      font-size: 16px; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
    }
    
    @media (max-width: 640px){ 
      html, body { font-size: 15px; } 
    }

    body{ 
      background: linear-gradient(135deg, #fafbfc 0%, #f5f7fa 50%, #ffffff 100%); 
      color: var(--ink);
      transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s ease;
      min-height: 100vh;
    }
    
    .container{ 
      max-width: 1400px; 
      margin-inline: auto; 
      padding-inline: clamp(1rem, 4vw, 2rem);
    }
    
    .card{ 
      background: var(--surface); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }
    
    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
      border-color: var(--brand);
    }
    
    .card-elevated {
      box-shadow: var(--shadow-lg);
    }
    
    .chip{ 
      font-size: 12px; 
      font-weight: 600;
      letter-spacing: 0.02em;
      padding: 6px 14px; 
      border-radius: 999px; 
      border: 1px solid var(--border); 
      color: var(--muted); 
      background: var(--surface-2); 
      transition: all 0.2s ease;
      text-transform: uppercase;
    }
    
    .chip:hover {
      background: var(--surface-3);
      border-color: var(--brand);
      color: var(--brand);
    }
    
    .btn{ 
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      gap: .5rem; 
      padding: .75rem 1.25rem; 
      border-radius: var(--radius-sm); 
      border: 1px solid var(--border); 
      background: var(--surface); 
      color: var(--ink); 
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 14px;
      text-decoration: none;
      letter-spacing: 0.01em;
      white-space: nowrap;
    }
    
    .btn:hover:not(:disabled){ 
      background: var(--surface-2); 
      transform: translateY(-1px); 
      box-shadow: var(--shadow-md);
      border-color: var(--brand);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary{ 
      border-color: transparent; 
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
      color: #fff; 
      box-shadow: 0 4px 12px rgba(0, 94, 184, 0.3);
    }
    
    .btn-primary:hover:not(:disabled){ 
      background: linear-gradient(135deg, var(--brand-2) 0%, var(--brand) 100%);
      box-shadow: 0 6px 20px rgba(0, 94, 184, 0.4); 
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--mf-secondary);
      border-color: transparent;
      color: #fff;
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--brand-light);
      box-shadow: var(--shadow-md);
    }
    
    .btn-ghost{ 
      background: transparent; 
      border: none; 
    }
    
    .btn-ghost:hover:not(:disabled) {
      background: var(--surface-2);
    }
    
    .btn-sm{ 
      padding: .5rem .9rem; 
      font-size: 13px; 
    }
    
    .btn-lg{ 
      padding: 1rem 1.5rem; 
      font-size: 15px;
      font-weight: 700;
    }
    
    .btn:focus-visible{ 
      outline: 3px solid rgba(0, 94, 184, 0.3); 
      outline-offset: 2px; 
    }
    
    .progress-outer{ 
      height: 10px; 
      border-radius: 999px; 
      background: var(--mf-gray-200); 
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,.08);
    }
    
    html.dark .progress-outer { 
      background: #1e293b; 
    }
    
    .progress-inner{ 
      height: 100%; 
      width: 0%; 
      border-radius: 999px; 
      background: linear-gradient(90deg, var(--brand), var(--mf-secondary), var(--success)); 
      transition: width .4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px rgba(0, 94, 184, 0.4);
    }
    
    .q-badge{ 
      background: linear-gradient(135deg, #e3f2fd, #f0f7ff);
      color: var(--brand); 
      border: 1px solid #bbdefb;
      font-weight: 600;
    }
    
    html.dark .q-badge {
      background: linear-gradient(135deg, rgba(25,118,210,.15), rgba(0,160,227,.1));
      color: #64b5f6;
      border-color: rgba(25,118,210,.3);
    }
    
    .rubric{ 
      border: 2px dashed var(--border); 
      border-radius: var(--radius-sm); 
      padding: .8rem 1rem; 
      background: var(--surface-2); 
      transition: all 0.3s ease;
    }
    
    .rubric:hover {
      border-color: var(--brand);
      background: var(--surface-3);
    }
    
    .rubric .bar{ 
      height: 8px; 
      background: var(--mf-gray-300); 
      border-radius: 999px; 
      overflow: hidden;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.06);
    }
    
    html.dark .rubric .bar { 
      background: #1e293b; 
    }
    
    .rubric .fill{ 
      height: 100%; 
      width: 0%; 
      background: linear-gradient(90deg, var(--brand), var(--mf-secondary));
      transition: width .5s cubic-bezier(0.4, 0, 0.2, 1); 
      box-shadow: 0 0 8px rgba(0, 94, 184, 0.5);
    }
    
    .tip > div{ 
      border-left: 4px solid var(--brand); 
      background: linear-gradient(135deg, #f0f7ff, #e3f2fd); 
      color: var(--ink); 
      border-radius: var(--radius-sm); 
      padding: 1rem 1.25rem; 
      box-shadow: var(--shadow-sm);
    }
    
    html.dark .tip > div{ 
      background: linear-gradient(135deg, rgba(25,118,210,.08), rgba(0,160,227,.05)); 
      color: var(--ink); 
    }
    
    details[open] summary .chev{ 
      transform: rotate(180deg); 
    }
    
    summary{ 
      list-style: none; 
      cursor: pointer; 
      user-select: none;
      font-weight: 600;
    }

    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      letter-spacing: -0.025em;
      color: var(--ink);
    }
    
    h1 {
      font-size: clamp(1.75rem, 4vw, 2.5rem);
    }
    
    h2 {
      font-size: clamp(1.5rem, 3vw, 2rem);
    }

    /* Notice */
    .notice{ 
      background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 50%, #e3f2fd 100%); 
      border-bottom: 2px solid rgba(0, 94, 184, 0.15);
      backdrop-filter: blur(12px);
    }
    
    html.dark .notice {
      background: linear-gradient(135deg, rgba(25,118,210,.12) 0%, rgba(0,160,227,.08) 50%, rgba(25,118,210,.12) 100%);
      border-bottom: 2px solid rgba(255,255,255,.08);
    }
    
    .notice .inner{ 
      backdrop-filter: blur(12px); 
    }

    /* Modal */
    .modal-backdrop{ 
      position: fixed; 
      inset: 0; 
      background: rgba(15, 23, 42, 0.6); 
      backdrop-filter: blur(8px);
      display: none; 
      z-index: 98; 
      animation: fadeIn 0.3s ease;
    }
    
    html.dark .modal-backdrop {
      background: rgba(0, 0, 0, 0.8);
    }
    
    .modal{ 
      position: fixed; 
      inset: 0; 
      display: none; 
      align-items: center; 
      justify-content: center; 
      padding: 16px; 
      z-index: 99; 
    }
    
    .modal .panel{ 
      width: 100%; 
      max-width: 1000px; 
      border-radius: var(--radius-lg);
      animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }
    
    .modal.open, .modal-backdrop.open{ 
      display: flex; 
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(40px) scale(0.96); opacity: 0; }
      to { transform: translateY(0) scale(1); opacity: 1; }
    }

    /* Exam banner */
    .exam-on { 
      background: linear-gradient(135deg, #fff8e1, #ffe0b2); 
      border: 2px solid #ffb74d; 
    }
    
    html.dark .exam-on {
      background: linear-gradient(135deg, rgba(255,152,0,.15), rgba(255,183,77,.1));
      border: 2px solid rgba(255,152,0,.4);
    }

    /* Skeleton Loader */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }
    
    html.dark .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 200% 100%;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* API Status */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-online { 
      background: var(--success); 
      box-shadow: 0 0 12px rgba(0, 212, 170, 0.6);
    }
    
    .status-offline { 
      background: var(--error); 
      animation: none; 
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.9); }
    }

    /* Print */
    @media print{
      .sticky, .sticky-actions, #notice, #quickBtn, #examToggleWrap, #themeToggle, #historyBtn { 
        display: none !important; 
      }
      body { background: #fff !important; }
      .card { box-shadow: none !important; border: 1px solid #ddd; }
    }
    
    footer.app-footer{ 
      font-size: 11px; 
      line-height: 1.6; 
      background: var(--surface-2);
      transition: background 0.3s ease;
      color: var(--muted);
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 320px;
      margin: 1.5rem 0;
    }

    /* Input Styles */
    input[type="text"],
    input[type="password"],
    input[type="search"],
    textarea,
    select {
      background: var(--surface);
      border: 2px solid var(--border);
      color: var(--ink);
      transition: all 0.25s ease;
      border-radius: var(--radius-xs);
      font-family: inherit;
    }

    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 4px rgba(0, 94, 184, 0.1);
    }

    /* Prose styles for markdown */
    .prose {
      color: var(--ink);
      line-height: 1.7;
    }

    .prose h1, .prose h2, .prose h3 {
      color: var(--ink);
      margin-top: 1.8em;
      margin-bottom: 0.6em;
      font-weight: 700;
    }

    .prose p {
      margin-bottom: 1.2em;
    }

    .prose ul, .prose ol {
      margin-left: 1.8em;
      margin-bottom: 1.2em;
    }

    .prose code {
      background: var(--surface-2);
      padding: 0.25em 0.5em;
      border-radius: 6px;
      font-size: 0.9em;
      border: 1px solid var(--border);
    }
    
    .prose strong {
      color: var(--brand);
      font-weight: 700;
    }
    
    /* Professional Header Gradient */
    .header-gradient {
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-2) 100%);
      border-bottom: 2px solid var(--border);
    }
    
    /* Icon containers */
    .icon-box {
      display: grid;
      place-items: center;
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: 0 4px 12px rgba(0, 94, 184, 0.25);
      transition: all 0.3s ease;
    }
    
    .icon-box:hover {
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 8px 24px rgba(0, 94, 184, 0.35);
    }
    
    /* Toast */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      background: var(--surface);
      color: var(--ink);
      padding: 16px 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-xl);
      border: 2px solid var(--brand);
      z-index: 9999;
      animation: slideUp 0.3s ease;
      font-weight: 600;
    }
    
    html.dark .toast {
      background: var(--surface-2);
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--surface-2);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--brand);
      border-radius: 5px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--brand-2);
    }
  </style>
</head>
<body class="min-h-screen antialiased">

  <!-- Disclaimer -->
  <aside id="notice" class="notice sticky top-0 z-50">
    <div class="inner container px-4 py-4 flex items-start gap-4">
      <div class="icon-box w-12 h-12 shrink-0">
        <i data-lucide="shield-check" class="w-6 h-6 text-white"></i>
      </div>
      <div class="text-sm leading-relaxed flex-1">
        <p class="font-bold text-lg mb-1" style="color: var(--brand);">Fachlicher Hinweis (Pilot)</p>
        <p class="text-slate-700" style="font-weight: 500;">
          Die KI-PrÃ¼fung unterstÃ¼tzt beim Lernen. Ergebnisse mÃ¼ssen fachlich geprÃ¼ft werden und ersetzen keine Rechtsberatung.
          <strong>Es dÃ¼rfen keine personenbezogenen oder sensiblen Daten eingegeben oder erfasst werden.</strong>
        </p>
        <label class="mt-3 inline-flex items-center gap-2.5 cursor-pointer">
          <input id="ack" type="checkbox" class="w-4 h-4 cursor-pointer" style="accent-color: var(--brand);" aria-describedby="ackDesc">
          <span id="ackDesc" class="text-slate-800 font-semibold">Ich habe den Hinweis gelesen und akzeptiere die Nutzungsbedingungen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2 flex-wrap">
        <div class="flex items-center gap-2.5 px-4 py-2 rounded-xl bg-white/60 backdrop-blur border-2 border-white/80">
          <span class="status-dot status-online" id="apiStatusDot"></span>
          <span class="text-xs font-bold" id="apiStatusText">API: PrÃ¼fen...</span>
        </div>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
        <span id="ackState" class="chip">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn btn-sm btn-primary">
          <i data-lucide="check-circle" class="w-4 h-4"></i> Weiter
        </button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="header-gradient container px-4 py-8">
    <div class="flex flex-wrap items-center gap-6">
      <div class="icon-box w-16 h-16">
        <i data-lucide="graduation-cap" class="w-9 h-9 stroke-[2] text-white"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h1 class="text-3xl sm:text-4xl font-bold tracking-tight mb-2">BBiG-Quiz â€“ Enterprise Edition</h1>
        <p class="text-sm text-slate-600 font-medium">20 Kernfragen â€¢ KI-Feedback mit Rubriken â€¢ Â§-Quicklook zu BBiG/JArbSchG</p>
      </div>

      <div class="flex items-center gap-2">
        <button id="historyBtn" type="button" class="btn btn-sm" title="Antwort-Historie">
          <i data-lucide="history" class="w-4 h-4"></i>
        </button>
        
        <button id="themeToggle" type="button" class="btn btn-sm" title="Theme wechseln">
          <i data-lucide="moon" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="examToggleWrap" class="flex items-center gap-3 p-3 rounded-xl border-2 exam-on">
        <i data-lucide="timer" class="w-5 h-5 text-amber-600"></i>
        <label class="text-sm font-bold text-amber-900">PrÃ¼fungsmodus</label>
        <input id="examToggle" type="checkbox" class="w-5 h-5" style="accent-color: #ff9800;" />
        <select id="examSize" class="ml-1 text-sm rounded-lg border-2 px-3 py-2 bg-white font-semibold">
          <option value="10">10 Fragen</option>
          <option value="20" selected>20 Fragen</option>
          <option value="40">40 (wenn vorhanden)</option>
        </select>
        <span id="examTimer" class="text-xs text-amber-700 ml-2 font-mono font-bold">â€”</span>
      </div>

      <button id="quickBtn" type="button" class="btn btn-primary btn-lg">
        <i data-lucide="search" class="w-5 h-5"></i> Â§-Quicklook
      </button>
    </div>
  </header>

  <!-- Progress -->
  <section class="container px-4 mt-6" aria-labelledby="progh">
    <div class="card card-elevated p-6">
      <div class="flex items-center gap-5">
        <div class="icon-box w-12 h-12">
          <i data-lucide="target" class="w-6 h-6 text-white"></i>
        </div>
        <div class="flex-1">
          <div class="flex justify-between text-xs font-bold text-slate-600 mb-3">
            <span id="progressText">0 / 20 beantwortet</span>
            <span id="selText">0 ausgewÃ¤hlt</span>
          </div>
          <div class="progress-outer" role="progressbar" aria-valuemin="0" aria-valuemax="20" aria-valuenow="0" aria-labelledby="progh">
            <div id="progressBar" class="progress-inner"></div>
          </div>
          <span id="progh" class="sr-only">Beantwortete Fragen</span>
        </div>
        <time id="timer" class="text-base text-slate-600 ml-4 font-mono font-bold" aria-live="polite">00:00</time>
      </div>
    </div>
  </section>

  <!-- Spider Chart -->
  <section class="container px-4 mt-6" id="chartSection" style="display:none;">
    <div class="card card-elevated p-6">
      <div class="flex items-center gap-3 mb-5">
        <div class="icon-box w-12 h-12">
          <i data-lucide="pie-chart" class="w-6 h-6 text-white"></i>
        </div>
        <h2 class="text-xl font-bold">Rubrik-Analyse</h2>
      </div>
      <div class="chart-container">
        <canvas id="rubricChart"></canvas>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container px-4 py-6">
    <form id="form" class="grid gap-6" novalidate aria-describedby="formhint"></form>
    <p id="formhint" class="sr-only">Mit Strg/âŒ˜+Enter kannst du das KI-Gesamt-Feedback abrufen.</p>

    <section id="resultWrap" class="mt-8 hidden" aria-live="polite">
      <div class="card card-elevated p-6">
        <div class="flex items-center gap-4 mb-5">
          <div class="icon-box w-12 h-12">
            <i data-lucide="sparkles" class="w-6 h-6 text-white"></i>
          </div>
          <h2 class="text-xl font-bold">KI-Feedback (Gesamt)</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky actions -->
  <div class="sticky-actions sticky bottom-0 z-40 bg-white/98 border-t-2 border-slate-200 backdrop-blur-xl shadow-xl">
    <div class="container px-4 py-4 flex flex-wrap items-center gap-3">
      <div class="flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener" aria-label="BBiG (PDF)">
          <i data-lucide="book-open" class="w-4 h-4"></i>
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener" aria-label="JArbSchG (PDF)">
          <i data-lucide="shield" class="w-4 h-4"></i>
        </a>
      </div>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback (Auswahl)
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">
        <i data-lucide="rotate-ccw" class="w-5 h-5"></i> ZurÃ¼cksetzen
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" style="display:none;"></div>

  <!-- Quicklook Modal -->
  <div id="qlBackdrop" class="modal-backdrop"></div>
  <div id="qlModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="qlTitle">
    <div class="panel card p-8" role="document">
      <div class="flex items-start gap-4 mb-6">
        <div class="icon-box w-14 h-14">
          <i data-lucide="search" class="w-7 h-7 text-white"></i>
        </div>
        <div class="flex-1">
          <h3 id="qlTitle" class="text-2xl font-bold mb-2">Â§-Quicklook â€“ BBiG & JArbSchG</h3>
          <p class="text-sm text-slate-600 font-medium">Suche nach Paragraph/Begriff (z. B. â€žÂ§11", â€žProbezeit", â€žRuhezeit"). Auszug + Sprung ins PDF.</p>
        </div>
        <button id="qlClose" type="button" class="btn btn-sm btn-ghost" aria-label="Fenster schlieÃŸen">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="flex flex-col sm:flex-row gap-3 mb-5">
        <input id="qlSearch" type="search" class="flex-1 rounded-xl border-2 px-4 py-3 text-sm font-medium" placeholder="Begriff oder Â§ suchen...">
        <div class="flex gap-2">
          <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
            <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
          </a>
          <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
            <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
          </a>
        </div>
      </div>
      <div id="qlList" class="grid gap-4 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyBackdrop" class="modal-backdrop"></div>
  <div id="historyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
    <div class="panel card p-8" role="document">
      <div class="flex items-start gap-4 mb-6">
        <div class="icon-box w-14 h-14">
          <i data-lucide="history" class="w-7 h-7 text-white"></i>
        </div>
        <div class="flex-1">
          <h3 id="historyTitle" class="text-2xl font-bold mb-2">Antwort-Historie</h3>
          <p class="text-sm text-slate-600 font-medium">Deine letzten 10 Versuche</p>
        </div>
        <button id="historyClose" type="button" class="btn btn-sm btn-ghost" aria-label="Fenster schlieÃŸen">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div id="historyList" class="space-y-4 max-h-[60vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer mt-16 py-8 border-t-2 border-slate-200">
    <div class="container px-4">
      <p class="text-center leading-relaxed">
        Diese Anwendung nutzt kÃ¼nstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antworten von OpenAI verarbeitet und geprÃ¼ft werden.
        Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbrÃ¤uchlich verwendet werden.
        Es dÃ¼rfen keine personenbezogenen Daten, sensiblen Daten oder Daten erfasst werden, die RÃ¼ckschlÃ¼sse auf eine Person, zum Beispiel Auszubildende,
        Ausbilder oder Ã¤hnliche Personen ermÃ¶glichen. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind vom Anwender zu prÃ¼fen.
        KI-generierte Antworten kÃ¶nnen fehlerhaft sein. Keine Haftung.
      </p>
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Initialize Lucide icons
    if (window.lucide) lucide.createIcons();

    // === Konfiguration ===
    const relay = "/api/linda-proxy"; // Make.com Webhook URL
    const STORAGE_KEY = "BBIGQUIZ_EXAM_V2";
    const HISTORY_KEY = "BBIGQUIZ_HISTORY";
    const MAX_ANSWER_CHARS = 1500;
    const RUBRIC_KEYS = ["normbezug","vollstaendigkeit","praxisbezug"];

    // UI-Refs
    const form = document.getElementById("form");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn  = document.getElementById("resetBtn");
    const timerEl   = document.getElementById("timer");
    const resultWrap= document.getElementById("resultWrap");
    const aiResult  = document.getElementById("aiResult");

    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");

    const examToggle = document.getElementById("examToggle");
    const examSize   = document.getElementById("examSize");
    const examTimer  = document.getElementById("examTimer");

    const quickBtn = document.getElementById("quickBtn");
    const qlBackdrop = document.getElementById("qlBackdrop");
    const qlModal = document.getElementById("qlModal");
    const qlClose = document.getElementById("qlClose");
    const qlSearch = document.getElementById("qlSearch");
    const qlList = document.getElementById("qlList");

    const historyBtn = document.getElementById("historyBtn");
    const historyBackdrop = document.getElementById("historyBackdrop");
    const historyModal = document.getElementById("historyModal");
    const historyClose = document.getElementById("historyClose");
    const historyList = document.getElementById("historyList");

    const themeToggle = document.getElementById("themeToggle");
    const toastEl = document.getElementById("toast");

    const apiStatusDot = document.getElementById("apiStatusDot");
    const apiStatusText = document.getElementById("apiStatusText");

    const chartSection = document.getElementById("chartSection");
    const rubricChartCanvas = document.getElementById("rubricChart");
    let rubricChart = null;

    if (window.marked) marked.setOptions({ breaks:true, gfm:true });

    // === Theme Toggle ===
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.documentElement.classList.add("dark");
    }

    themeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      const isDark = document.documentElement.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      if (window.lucide) lucide.createIcons();
      
      // Update chart colors if exists
      if (rubricChart) {
        updateSpiderChart();
      }
    });

    // === API Status Check ===
    async function checkAPIStatus() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(relay, {
          method: 'HEAD',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        apiStatusDot.className = "status-dot status-online";
        apiStatusText.textContent = "API: Online";
      } catch (error) {
        apiStatusDot.className = "status-dot status-offline";
        apiStatusText.textContent = "API: Offline";
      }
    }

    checkAPIStatus();
    setInterval(checkAPIStatus, 60000);

    // Timer (Sitzungsuhr)
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    }, 1000);

    // === Toast Helper ===
    function showToast(msg, duration = 3000) {
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      setTimeout(() => {
        toastEl.style.display = "none";
      }, duration);
    }

    // === Fragen (20 Kernfragen) ===
    const QUESTIONS_ALL = [
      { ref:"V1 â€“ Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehÃ¶ren.", tip:["Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung.","Â§ 11 BBiG."]},
      { ref:"V2 â€“ Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:["Berufsbild, Dauer/Ausbildungsrahmenplan, PrÃ¼fungen.","Â§Â§ 4â€“5 BBiG."]},
      { ref:"V3 â€“ Probezeit", q:"Wie lang muss/darf die Probezeit sein â€“ und warum ist sie wichtig?", tip:["Mind. 1, max. 4 Monate; EignungsprÃ¼fung beider Seiten.","Â§ 20 BBiG."]},
      { ref:"V4 â€“ MinderjÃ¤hrige: Unterschrift", q:"Wer unterschreibt den Vertrag bei MinderjÃ¤hrigen mit gemeinsamem Sorgerecht?", tip:["Beide Sorgeberechtigte + MinderjÃ¤hrige/r.","Â§ 10 BBiG; Â§ 107 BGB."]},
      { ref:"V5 â€“ Berufsschulzeit & Arbeitszeit", q:"Wie werden Berufsschulzeiten auf die Arbeitszeit angerechnet (U18 vs. â‰¥18)?", tip:["U18: besondere Anrechnung (JArbSchG).","Wegezeiten Schuleâ†’Betrieb; Â§ 15 BBiG."]},
      { ref:"V6 â€“ Ruhezeit Jugendliche", q:"Welche tÃ¤gliche Mindestruhezeit gilt fÃ¼r Jugendliche?", tip:["Mindestens 12 Stunden.","JArbSchG."]},
      { ref:"V7 â€“ VergÃ¼tung", q:"Was gilt zur Angemessenheit der AusbildungsvergÃ¼tung?", tip:["MiAV Untergrenze; tariflich/branchenÃ¼blich; Steigerung je Jahr.","Â§ 17 BBiG."]},
      { ref:"V8 â€“ Ãœberstunden", q:"Sind Ãœberstunden zulÃ¤ssig â€“ und wie werden sie behandelt?", tip:["Nur ausbildungsdienlich; VergÃ¼tung/Zeitausgleich; Jugendarbeitsschutz beachten.","ArbZG/JArbSchG."]},
      { ref:"V9 â€“ Betrieblicher Ausbildungsplan", q:"Wozu dient der betriebliche Ausbildungsplan?", tip:["Umsetzung Rahmenplan, zeitl./sachl. Gliederung, QualitÃ¤tssicherung.","Â§ 5 BBiG; Verweis Â§ 11."]},
      { ref:"V10 â€“ Berichtsheft", q:"Welche Bedeutung hat das Berichtsheft und wer kontrolliert es?", tip:["Zulassungsvoraussetzung; elektronisch mÃ¶glich; Kontrolle Ausbilder/in.","Â§ 13 Nr.7, Â§ 14 Abs.1 Nr.4 BBiG."]},
      { ref:"V11 â€“ VerkÃ¼rzung", q:"Wann kann die Ausbildungsdauer verkÃ¼rzt werden?", tip:["Vorbildung/Leistung/Anrechnung; Einvernehmen nÃ¶tig.","Â§ 8 BBiG."]},
      { ref:"V12 â€“ VerlÃ¤ngerung", q:"Wann kommt eine VerlÃ¤ngerung in Betracht?", tip:["Nichtbestehen oder besondere FÃ¤lle.","Â§ 8 Abs. 2 BBiG."]},
      { ref:"V13 â€“ Teilzeitberufsausbildung", q:"Wie funktioniert Teilzeit in der Ausbildung und was bleibt unverÃ¤ndert?", tip:["Reduzierte Zeiten, Lernziel bleibt; evtl. lÃ¤ngere Gesamtdauer.","Â§ 7a BBiG."]},
      { ref:"V14 â€“ Datenschutz/Geheimnis", q:"Welche Pflichten haben Azubis zu Datenschutz und Betriebsgeheimnissen?", tip:["DSGVO/BDSG beachten; Unterweisungen dokumentieren."]},
      { ref:"V15 â€“ KÃ¼ndigung", q:"Welche KÃ¼ndigungsregeln gelten in und nach der Probezeit?", tip:["Probezeit: jederzeit fristlos (Â§ 22 Abs. 1).","Danach: fristlos aus wichtigem Grund oder mit Frist von 4 Wochen (Azubi)."]},
      { ref:"V16 â€“ Schwangerschaft/Mutterschutz", q:"Welche Schutzregeln gelten bei Schwangerschaft in der Ausbildung?", tip:["MuSchG: Schutzfristen, BeschÃ¤ftigungsverbote, KÃ¼ndigungsschutz."]},
      { ref:"V17 â€“ Nachteilsausgleich", q:"Wie werden Auszubildende mit Behinderung in PrÃ¼fungen unterstÃ¼tzt?", tip:["Nachteilsausgleich (Zeit, Hilfsmittel) auf Antrag; Chancengleichheit."]},
      { ref:"V18 â€“ Ausland", q:"Sind Ausbildungsabschnitte im Ausland mÃ¶glich und wie werden sie angerechnet?", tip:["Ja; Ausbildungsziel wahren; bis zulÃ¤ssige Zeitanteile.","Â§ 2 Abs. 3 BBiG."]},
      { ref:"V19 â€“ Versetzung", q:"Darf der Betrieb Azubis versetzen?", tip:["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten klÃ¤ren.","Â§ 14 BBiG."]},
      { ref:"V20 â€“ Insolvenz", q:"Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip:["FortfÃ¼hrung/Anschlussbetrieb/IHK-UnterstÃ¼tzung; ggf. Insolvenzgeld."]}
    ];

    // === Â§-Quicklook Mini-Index ===
    const LAW_INDEX = [
      { law:"BBiG", para:"Â§ 11", tags:["vertrag","inhalte","mindestinhalte"], excerpt:"Â§ 11 BBiG â€“ Niederschrift der wesentlichen Inhalte (u. a. Parteien, Beginn/Dauer, Ziel, sachliche/zeitliche Gliederung).", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"Â§ 20", tags:["probezeit"], excerpt:"Â§ 20 BBiG â€“ Probezeit mindestens 1, hÃ¶chstens 4 Monate.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"Â§ 15", tags:["freistellung","schule","wegezeit"], excerpt:"Â§ 15 BBiG â€“ Freistellung fÃ¼r Berufsschule/PrÃ¼fungen; Wegezeiten Schuleâ†’Betrieb sind anzurechnen.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"Â§ 17", tags:["vergÃ¼tung","miav"], excerpt:"Â§ 17 BBiG â€“ Angemessene VergÃ¼tung; MindestausbildungsvergÃ¼tung als Untergrenze.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"JArbSchG", para:"Â§ 8â€“15", tags:["arbeitszeit","ruhezeit","pausen"], excerpt:"JArbSchG â€“ TÃ¤gliche und wÃ¶chentliche HÃ¶chstarbeitszeiten; Ruhepausen; Ruhezeit mind. 12 Std.", link:"https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" },
      { law:"ArbZG", para:"Â§ 3, Â§ 4, Â§ 5", tags:["erwachsene","arbeitszeit","pausen","ruhezeit"], excerpt:"ArbZG â€“ 8 Std/Tag (bis 10 mit Ausgleich), Pausen 30â€“45 Min, Ruhezeit 11 Std.", link:"https://www.gesetze-im-internet.de/arbzg/ArbZG.pdf" },
    ];

    // === State ===
    let accepted = false;
    let examMode = false;
    let examCountdown = null;
    let examTick = null;

    let pool = [...QUESTIONS_ALL];
    let answers = {};
    let selected = {};
    let rubrics  = {};

    // === Spider Chart ===
    function updateSpiderChart() {
      const entries = Object.entries(rubrics);
      if (entries.length === 0) {
        chartSection.style.display = "none";
        return;
      }

      const avgRubric = entries.reduce((acc, [ref, r]) => {
        acc.normbezug += r.normbezug || 0;
        acc.vollstaendigkeit += r.vollstaendigkeit || 0;
        acc.praxisbezug += r.praxisbezug || 0;
        acc.count++;
        return acc;
      }, {normbezug:0, vollstaendigkeit:0, praxisbezug:0, count:0});

      const count = avgRubric.count || 1;

      chartSection.style.display = "block";

      const isDark = document.documentElement.classList.contains('dark');
      const textColor = isDark ? '#f1f5f9' : '#1f2937';
      const gridColor = isDark ? '#334155' : '#e8ecf1';

      const data = {
        labels: ['Normbezug', 'VollstÃ¤ndigkeit', 'Praxisbezug'],
        datasets: [{
          label: 'Durchschnitt',
          data: [
            (avgRubric.normbezug / count).toFixed(1),
            (avgRubric.vollstaendigkeit / count).toFixed(1),
            (avgRubric.praxisbezug / count).toFixed(1)
          ],
          backgroundColor: isDark ? 'rgba(25, 118, 210, 0.2)' : 'rgba(0, 94, 184, 0.15)',
          borderColor: isDark ? '#1976d2' : '#005eb8',
          borderWidth: 3,
          pointBackgroundColor: isDark ? '#1976d2' : '#005eb8',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: isDark ? '#1976d2' : '#005eb8',
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBorderWidth: 2
        }]
      };

      if (rubricChart) {
        rubricChart.destroy();
      }

      rubricChart = new Chart(rubricChartCanvas, {
        type: 'radar',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 2,
              ticks: {
                stepSize: 0.5,
                color: textColor,
                backdropColor: 'transparent',
                font: {
                  size: 12,
                  weight: '600'
                }
              },
              grid: {
                color: gridColor,
                lineWidth: 2
              },
              pointLabels: {
                color: textColor,
                font: {
                  size: 13,
                  weight: '700'
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: isDark ? '#1e293b' : '#ffffff',
              titleColor: textColor,
              bodyColor: textColor,
              borderColor: gridColor,
              borderWidth: 2,
              padding: 14,
              boxPadding: 8,
              usePointStyle: true,
              titleFont: {
                size: 14,
                weight: '700'
              },
              bodyFont: {
                size: 13,
                weight: '600'
              }
            }
          }
        }
      });
    }

    // === Render Quiz ===
    function renderQuiz() {
      form.innerHTML = "";
      pool.forEach((item, idx) => {
        const card = document.createElement("div");
        card.className = "card p-6 transition-all";
        card.innerHTML = `
          <div class="flex items-start gap-4 mb-4">
            <div class="chip q-badge shrink-0">Frage ${idx+1}</div>
            <h3 class="flex-1 text-base font-bold text-slate-800">${item.ref}</h3>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" class="sel-check w-5 h-5 cursor-pointer" style="accent-color: var(--brand);" data-ref="${item.ref}">
              <span class="text-xs font-bold text-slate-600">Auswahl</span>
            </label>
          </div>
          <p class="text-sm text-slate-700 mb-4 font-medium leading-relaxed">${item.q}</p>
          <textarea 
            class="w-full border-2 border-slate-200 rounded-xl p-4 text-sm resize-none focus:border-blue-600 focus:ring-4 focus:ring-blue-100 transition-all font-medium" 
            rows="4" 
            placeholder="Deine Antwort (max. ${MAX_ANSWER_CHARS} Zeichen)..."
            maxlength="${MAX_ANSWER_CHARS}"
            data-ref="${item.ref}"
          ></textarea>
          <div class="tip mt-4 hidden" data-ref="${item.ref}">
            <details class="text-xs">
              <summary class="flex items-center gap-2 cursor-pointer text-blue-700 font-bold">
                <i data-lucide="info" class="w-4 h-4"></i>
                <span>Orientierungshilfe anzeigen</span>
                <i data-lucide="chevron-down" class="chev w-4 h-4 ml-auto transition-transform"></i>
              </summary>
              <div class="mt-3">
                ${item.tip.map(t => `<p class="mb-2 last:mb-0">â€¢ ${t}</p>`).join("")}
              </div>
            </details>
          </div>
          <div class="rubric-wrap mt-4 hidden" data-ref="${item.ref}">
            <div class="rubric">
              <p class="text-xs font-bold text-slate-600 mb-2">KI-Rubriken-Score:</p>
              ${RUBRIC_KEYS.map(k => `
                <div class="mb-2 last:mb-0">
                  <div class="flex justify-between text-xs font-bold text-slate-600 mb-1">
                    <span>${k === 'normbezug' ? 'ðŸ“š Normbezug' : k === 'vollstaendigkeit' ? 'âœ… VollstÃ¤ndigkeit' : 'ðŸŽ¯ Praxisbezug'}</span>
                    <span class="rubric-val" data-ref="${item.ref}" data-key="${k}">â€”</span>
                  </div>
                  <div class="bar">
                    <div class="fill rubric-fill" data-ref="${item.ref}" data-key="${k}"></div>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
          <div class="feedback-wrap mt-4 hidden bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4" data-ref="${item.ref}">
            <p class="text-xs font-bold text-blue-800 mb-2 flex items-center gap-2">
              <i data-lucide="message-square" class="w-4 h-4"></i>
              KI-Feedback:
            </p>
            <div class="feedback-content text-sm text-slate-700 font-medium"></div>
          </div>
        `;
        form.appendChild(card);
      });

      if (window.lucide) lucide.createIcons();

      form.querySelectorAll("textarea[data-ref]").forEach(ta => {
        const r = ta.dataset.ref;
        ta.value = answers[r] || "";
        ta.addEventListener("input", () => {
          answers[r] = ta.value.trim();
          saveState();
          updateProgress();
        });
      });

      form.querySelectorAll(".sel-check").forEach(cb => {
        const r = cb.dataset.ref;
        cb.checked = !!selected[r];
        cb.addEventListener("change", () => {
          selected[r] = cb.checked;
          updateProgress();
        });
      });

      updateProgress();
      restoreRubrics();
    }

    function updateProgress() {
      const total = pool.length;
      const answered = Object.values(answers).filter(a => a.length > 0).length;
      const selectedCount = Object.values(selected).filter(Boolean).length;
      
      progressBar.style.width = `${(answered / total) * 100}%`;
      progressTxt.textContent = `${answered} /
