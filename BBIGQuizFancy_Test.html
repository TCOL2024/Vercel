<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz – t&c Cluster + Nova Intro</title>

  <!-- External -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* ===== t&c (Amazon Nova inspiriert) ===== */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root{
      --mf-primary:#005EB8; --mf-primary-dark:#004A93; --mf-secondary:#00A0E3;
      --accent:#FF9900; --accent-hover:#EC7211;
      --success:#00D4AA; --warn:#FFA726; --danger:#E53935;

      --surface:#FFFFFF; --surface-2:#F7F8F8; --surface-hover:#EBEEF0;
      --ink:#0F1111; --muted:#565959; --border:#D5D9D9; --focus:#005EB8;

      --radius:10px; --radius-pill:999px;
      --shadow-xs:0 1px 2px rgba(15,17,17,.06);
      --shadow-sm:0 1px 6px rgba(15,17,17,.08);
      --shadow-md:0 2px 10px rgba(15,17,17,.12);
    }
    html.dark{
      --surface:#131A22; --surface-2:#1C2531; --surface-hover:#232F3E;
      --ink:#FFFFFF; --muted:#AAB7B8; --border:#3A4553; --focus:#FF9900;
    }
    html,body{ font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size:14px; line-height:1.5; background:var(--surface-2); color:var(--ink) }
    .container{ max-width:1120px; margin-inline:auto; padding-inline:16px }
    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow-sm) }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:var(--surface); color:var(--ink); font-weight:600; cursor:pointer; transition:.15s }
    .btn:hover{ background:var(--surface-hover) }
    .btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--focus) 35%, transparent); outline-offset:2px }
    .btn-primary{ background:var(--accent); border-color:var(--accent); color:#111 }
    .btn-primary:hover{ background:var(--accent-hover); border-color:var(--accent-hover) }
    .btn-blue{ background:var(--mf-primary); border-color:var(--mf-primary); color:#fff }
    .btn-blue:hover{ background:var(--mf-primary-dark) }
    .btn-ghost{ background:transparent; border-color:transparent }
    .btn-sm{ padding:6px 10px; font-size:12px }
    .btn-lg{ padding:12px 16px; font-size:14px; border-radius:12px }

    .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--border); border-radius:12px; background:var(--surface-2); color:var(--muted); font-size:11px; font-weight:700; letter-spacing:.2px }
    .badge-primary{ background:#E7F1FF; color:var(--mf-primary); border-color:#B3D9FF }

    .progress-outer{ height:8px; border-radius:4px; background:var(--surface-2); overflow:hidden; border:1px solid var(--border) }
    .progress-inner{ height:100%; width:0%; background:linear-gradient(90deg, var(--mf-primary), var(--mf-secondary)); transition:width .3s; box-shadow:0 0 8px rgba(0,94,184,.3) }

    .app-header{ position:sticky; top:0; z-index:40; backdrop-filter:blur(8px); background:color-mix(in srgb, var(--surface) 88%, transparent); border-bottom:1px solid var(--border) }

    /* Tabs → Cluster */
    .tabs{ display:flex; gap:.5rem; overflow:auto; scrollbar-width:none }
    .tabs::-webkit-scrollbar{ display:none }
    .tab{ padding:.55rem .85rem; border:1px solid var(--border); border-radius:var(--radius-pill); background:#fff; white-space:nowrap; display:flex; align-items:center; gap:.45rem; font-weight:700; }
    .tab[aria-selected="true"]{ background:#ECF6FF; border-color:#B3D9FF; color:#0A3A66 }
    .tab i{ width:18px; height:18px }
    #clusterSelect{ display:none }
    @media (max-width: 720px){ .tabs{ display:none } #clusterSelect{ display:block } }

    /* Question card */
    .q-card{ position:relative; padding:16px }
    .bookmark{ position:absolute; top:12px; right:12px; width:34px; height:34px; border-radius:50%; display:grid; place-items:center; background:var(--surface); border:1px solid var(--border); box-shadow:var(--shadow-xs) }
    .bookmark.active{ background:var(--accent); border-color:var(--accent) }
    .tip{ margin-top:.5rem; background:#F0F8FF; border-left:3px solid var(--mf-primary); padding:.75rem .85rem; border-radius:10px }
    html.dark .tip{ background:rgba(0,94,184,.15) }

    /* Modal base */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); backdrop-filter:blur(4px); display:none; z-index:98 }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:99 }
    .modal.open, .modal-backdrop.open{ display:flex }
    .panel{ width:100%; max-width:860px; max-height:90vh; overflow:auto; border-radius:12px }

    /* Toast */
    #toast{ position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:100; display:none }

    /* Notice (blau, klar) */
    .notice{ background:linear-gradient(135deg, #E7F1FF, #E0F2FF); border-bottom:1px solid #B3D9FF }
    .notice .chip{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid #B3D9FF; background:#F2F8FF; color:#0A3A66 }

    /* Footer (Arial 10) */
    footer.app-footer{ font-family:Arial, Helvetica, sans-serif; font-size:10px; line-height:1.4; color:#4b5563; background:#eef2f6; border-top:1px solid var(--border) }

    /* ===== Nova Intro ===== */
    .intro{
      position:fixed; inset:0; z-index:1000; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 600px at 20% 10%, rgba(0,160,227,.18), transparent 60%),
                  radial-gradient(900px 500px at 80% 80%, rgba(0,94,184,.22), transparent 60%),
                  linear-gradient(180deg, #0b1726 0%, #0f1f33 45%, #0b1726 100%);
      color:#eef6ff;
    }
    .intro .glass{
      width:min(960px, 92vw); border:1px solid rgba(255,255,255,.08);
      background: rgba(6,12,20,.55); backdrop-filter: blur(14px);
      border-radius:16px; box-shadow: 0 10px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .intro .head{
      display:flex; align-items:center; gap:12px; padding:18px 20px; border-bottom:1px solid rgba(255,255,255,.08)
    }
    .intro .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(0,160,227,.15); border:1px solid rgba(0,160,227,.35); font-weight:700; font-size:12px; color:#91d7ff }
    .intro .grid{
      display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; padding:18px; align-items:stretch
    }
    @media (max-width: 900px){ .intro .grid{ grid-template-columns: 1fr } }
    .intro .card{
      background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); color:#e8f2ff
    }
    .intro h1{ font-size:26px; line-height:1.2; margin-bottom:6px }
    .intro p.lead{ color:#bcd6ff; font-size:14px }
    .intro .steps{ display:grid; gap:10px; margin-top:10px }
    .intro .step{ display:flex; align-items:flex-start; gap:10px; padding:10px; border:1px dashed rgba(255,255,255,.14); border-radius:10px }
    .intro .step .dot{ width:10px; height:10px; border-radius:999px; background:#4069ff; box-shadow:0 0 0 3px rgba(64,105,255,.25) }
    .intro .step.done .dot{ background:#00D4AA; box-shadow:0 0 0 3px rgba(0,212,170,.25) }
    .intro .foot{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:14px 18px; border-top:1px solid rgba(255,255,255,.08) }
    .intro .cta{ display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:10px; font-weight:800; background:#FF9900; color:#111; border:1px solid #FF9900 }
    .intro .cta:hover{ background:#EC7211; border-color:#EC7211 }
    .intro .skip{ color:#a7b9d6; text-decoration: underline; text-underline-offset: 4px; cursor:pointer }
    .intro.fadeout{ animation: fadeOut .45s ease forwards }
    @keyframes fadeOut{ to{ opacity:0; visibility:hidden } }

    /* Print */
    @media print{
      .app-header, .notice, .sticky-actions, .bookmark, .modal, .fab, .intro{ display:none !important }
      .card{ box-shadow:none !important; border:1px solid #ddd }
    }
  </style>
</head>
<body>

  <!-- ===== Nova Intro Overlay ===== -->
  <section id="intro" class="intro" aria-label="Einführung" role="dialog" aria-modal="true">
    <div class="glass">
      <div class="head">
        <div class="w-9 h-9 rounded-md bg-gradient-to-br from-[#005EB8] to-[#00A0E3] grid place-items-center">
          <i data-lucide="sparkle" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <div class="pill"><i data-lucide="bolt" class="w-4 h-4"></i> t&c • Nova-Start</div>
        </div>
        <div class="ml-auto text-sm text-[#bcd6ff] font-semibold">
          <span id="introStatus">Bereit</span>
        </div>
      </div>

      <div class="grid">
        <div class="card p-5">
          <h1>Willkommen im BBiG-Quiz (Cluster Edition)</h1>
          <p class="lead">Schneller Einstieg mit **wohlwollendem KI-Feedback**. Wähle Cluster, tippe kurz, prüfe mit §-Quicklook. Alles mobile-optimiert – im Stil von Amazon Nova.</p>
          <div class="mt-3 grid gap-3">
            <div class="step" id="st-storage">
              <div class="dot"></div>
              <div>
                <div class="font-semibold">Lokaler Speicher</div>
                <div class="text-sm" style="color:#bcd6ff">Antworten & Historie werden lokal gesichert (Autosave).</div>
              </div>
            </div>
            <div class="step" id="st-network">
              <div class="dot"></div>
              <div>
                <div class="font-semibold">Verbindung zum KI-Relay</div>
                <div class="text-sm" style="color:#bcd6ff">Prüft /api/linda-proxy (Make.com) – optional.</div>
              </div>
            </div>
            <div class="step" id="st-access">
              <div class="dot"></div>
              <div>
                <div class="font-semibold">Barrierefreiheit & Tasten</div>
                <div class="text-sm" style="color:#bcd6ff"><kbd>⌘/Ctrl</kbd> + <kbd>Enter</kbd> sendet; Tabs für Cluster; <kbd>?</kbd> für Quicklook.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between mb-3">
            <div class="font-semibold">Schnellstart</div>
            <a href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener" class="btn btn-sm"><i data-lucide="book-open" class="w-4 h-4"></i> BBiG</a>
          </div>
          <ol class="text-sm leading-6" style="color:#d6e6ff">
            <li>1) Hinweis bestätigen</li>
            <li>2) Cluster wählen (Tabs oben)</li>
            <li>3) Antworten tippen (knapp)</li>
            <li>4) Fragen auswählen → KI-Feedback</li>
          </ol>

          <div class="mt-4 grid gap-2">
            <label class="inline-flex items-center gap-2">
              <input id="introSkip" type="checkbox" class="w-4 h-4 accent-[#FF9900]" />
              <span class="text-sm" style="color:#bcd6ff">Intro beim nächsten Mal überspringen</span>
            </label>

            <div class="flex items-center gap-2">
              <button id="introStart" class="cta">
                <i data-lucide="play" class="w-4 h-4"></i> Los geht’s
              </button>
              <button id="introTheme" class="btn btn-sm" style="background:rgba(255,255,255,.06); color:#e8f2ff; border-color:rgba(255,255,255,.12)">
                <i data-lucide="moon" class="w-4 h-4"></i> Theme
              </button>
              <span class="skip" id="introSkipNow">überspringen</span>
            </div>
          </div>
        </div>
      </div>

      <div class="foot">
        <div class="text-xs" style="color:#9fb8e6">t&c learning • Beta • Keine personenbezogenen Daten eingeben.</div>
        <div class="text-xs" style="color:#9fb8e6">Tip: Prüfe mit §-Quicklook oder öffne BBiG/JArbSchG unten in der Action-Bar.</div>
      </div>
    </div>
  </section>
  <!-- ===== Ende Nova Intro ===== -->

  <!-- Notice -->
  <aside id="notice" class="notice">
    <div class="container px-4 py-3 flex items-start gap-3">
      <div class="w-10 h-10 rounded-lg bg-[#E7F1FF] grid place-items-center">
        <i data-lucide="shield-check" class="w-6 h-6 text-[#005EB8]"></i>
      </div>
      <div class="text-sm leading-snug">
        <p class="font-semibold text-[#0A3A66]">Fachlicher Hinweis (Pilot)</p>
        <p class="text-[#0A3A66]">
          Die KI-Prüfung unterstützt beim Lernen. Ergebnisse sind zu prüfen; keine Rechtsberatung.
          <strong>Keine personenbezogenen/sensiblen Daten eingeben oder erfassen.</strong>
        </p>
        <label class="mt-2 inline-flex items-center gap-2">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-[#005EB8]">
          <span class="text-[#0A3A66]">Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
        <span id="ackState" class="chip badge">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn btn-blue btn-sm">
          <i data-lucide="check" class="w-4 h-4"></i> Weiter
        </button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="app-header">
    <div class="container px-4 py-3 flex flex-wrap items-center gap-3 justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-md bg-gradient-to-br from-[#005EB8] to-[#004A93] grid place-items-center shadow">
          <i data-lucide="graduation-cap" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <h1 class="text-lg sm:text-xl font-semibold">BBiG-Quiz – t&c Cluster</h1>
          <p class="text-xs text-slate-500">Cluster • wohlwollendes KI-Feedback • Quicklook • Bookmarks • Autosave</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="quickBtn" type="button" class="btn btn-sm"><i data-lucide="search" class="w-4 h-4"></i> §-Quicklook</button>
        <button id="bookmarksBtn" type="button" class="btn btn-sm" title="Markierte">
          <i data-lucide="bookmark" class="w-4 h-4"></i>
          <span id="bookmarkCount" class="badge badge-primary" style="display:none">0</span>
        </button>
        <button id="historyBtn" type="button" class="btn btn-sm" title="Historie">
          <i data-lucide="history" class="w-4 h-4"></i>
        </button>
        <button id="themeToggle" type="button" class="btn btn-ghost btn-sm" title="Theme">
          <i data-lucide="moon" class="w-4 h-4"></i>
        </button>
      </div>
    </div>

    <!-- Cluster Tabs -->
    <div class="container pb-3">
      <div class="card p-3">
        <div id="tabs" class="tabs" role="tablist" aria-label="Cluster"></div>
        <select id="clusterSelect" class="mt-2 w-full rounded-lg border px-3 py-2 text-sm"></select>
      </div>
    </div>
  </header>

  <!-- Progress -->
  <section class="container mt-4">
    <div class="card p-4 flex items-center gap-3">
      <i data-lucide="target" class="w-5 h-5 text-[#005EB8]"></i>
      <div class="flex-1">
        <div class="flex justify-between text-[11px] text-slate-500 font-semibold mb-2">
          <span id="progressText">0 / 0 beantwortet</span>
          <span id="selText">0 ausgewählt</span>
        </div>
        <div class="progress-outer"><div id="progressBar" class="progress-inner"></div></div>
      </div>
      <time id="timer" class="text-xs text-slate-500 font-mono">00:00</time>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container my-4">
    <form id="form" class="grid gap-4" novalidate></form>

    <section id="resultWrap" class="hidden mt-4" aria-live="polite">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkles" class="w-5 h-5 text-emerald-600"></i>
          <h2 class="text-base font-semibold">KI-Feedback</h2>
        </div>
        <article id="aiResult" class="prose text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky actions -->
  <div class="sticky-actions bg-[color:var(--surface)] border-t border-[color:var(--border)]">
    <div class="container px-4 py-2 flex flex-wrap items-center gap-2">
      <div class="flex items-center gap-2">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
      </div>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback (Auswahl)
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">
        <i data-lucide="rotate-ccw" class="w-5 h-5"></i> Zurücksetzen
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Bookmarks Modal -->
  <div id="bmBackdrop" class="modal-backdrop"></div>
  <div id="bmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bmTitle">
    <div class="panel card p-4">
      <div class="flex items-center justify-between">
        <h3 id="bmTitle" class="text-base font-semibold">Markierte Fragen</h3>
        <button id="bmClose" class="btn btn-ghost btn-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
      <div id="bmList" class="mt-3 grid gap-2 max-h-[70vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Quicklook Modal -->
  <div id="qlBackdrop" class="modal-backdrop"></div>
  <div id="qlModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="qlTitle">
    <div class="panel card p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="search" class="w-5 h-5 text-[#005EB8]"></i>
          <h3 id="qlTitle" class="text-base font-semibold">§-Quicklook – BBiG & JArbSchG</h3>
        </div>
        <button id="qlClose" class="btn btn-ghost btn-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
      <div class="mt-2 flex gap-2">
        <input id="qlSearch" type="search" class="flex-1 rounded-lg border px-3 py-2" placeholder="Begriff oder § …">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">BBiG</a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">JArbSchG</a>
      </div>
      <div id="qlList" class="mt-3 grid gap-2 max-h-[65vh] overflow-auto"></div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="histBackdrop" class="modal-backdrop"></div>
  <div id="histModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="histTitle">
    <div class="panel card p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i data-lucide="history" class="w-5 h-5 text-[#005EB8]"></i>
          <h3 id="histTitle" class="text-base font-semibold">Antwort-Historie</h3>
        </div>
        <button id="histClose" class="btn btn-ghost btn-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
      </div>
      <div id="histList" class="mt-3 grid gap-2 max-h-[70vh] overflow-auto"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer">
    <div class="container px-4 py-4">
      Diese Anwendung nutzt künstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antwort von OpenAI verarbeitet und geprüft werden.
      Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbräuchlich verwendet werden. Es dürfen keine personenbezogenen Daten,
      sensiblen Daten oder Daten erfasst werden, die Rückschlüsse auf eine Person, zum Beispiel Auszubildenden, Ausbilder oder ähnliche Personen ermöglichen. Jegliche Haftung ist ausgeschlossen.
      Alle Antworten sind vom Anwender zu prüfen. KI-generierte Antworten können fehlerhaft sein. Keine Haftung.
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    if (window.lucide) lucide.createIcons();
    if (window.marked) marked.setOptions({ breaks:true, gfm:true });

    // === Config / Keys ===
    const relay = "/api/linda-proxy"; // dein Make-Webhook
    const STORAGE_KEY = "MF_CLUSTER_STATE_V1";
    const BOOKMARK_KEY = "MF_CLUSTER_BOOKMARKS_V1";
    const INTRO_KEY   = "MF_CLUSTER_INTRO_SKIP_V1";

    // === UI Refs ===
    const intro = document.getElementById("intro");
    const introStart = document.getElementById("introStart");
    const introSkip = document.getElementById("introSkip");
    const introSkipNow = document.getElementById("introSkipNow");
    const introTheme = document.getElementById("introTheme");
    const introStatus = document.getElementById("introStatus");
    const stStorage = document.getElementById("st-storage");
    const stNetwork = document.getElementById("st-network");
    const stAccess  = document.getElementById("st-access");

    const form = document.getElementById("form");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const timerEl = document.getElementById("timer");
    const resultWrap = document.getElementById("resultWrap");
    const aiResult = document.getElementById("aiResult");
    const toastEl = document.getElementById("toast");

    const tabs = document.getElementById("tabs");
    const clusterSelect = document.getElementById("clusterSelect");

    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");

    const bookmarksBtn = document.getElementById("bookmarksBtn");
    const bookmarkCount = document.getElementById("bookmarkCount");
    const bmBackdrop = document.getElementById("bmBackdrop");
    const bmModal = document.getElementById("bmModal");
    const bmClose = document.getElementById("bmClose");
    const bmList = document.getElementById("bmList");

    const quickBtn = document.getElementById("quickBtn");
    const qlBackdrop = document.getElementById("qlBackdrop");
    const qlModal = document.getElementById("qlModal");
    const qlClose = document.getElementById("qlClose");
    const qlSearch = document.getElementById("qlSearch");
    const qlList = document.getElementById("qlList");

    const historyBtn = document.getElementById("historyBtn");
    const histBackdrop = document.getElementById("histBackdrop");
    const histModal = document.getElementById("histModal");
    const histClose = document.getElementById("histClose");
    const histList = document.getElementById("histList");

    const themeToggle = document.getElementById("themeToggle");

    // === Data (Cluster & Fragenbanken) – gekürzt auf Kern + Recht als Beispiel; weitere wie gehabt ergänzbar ===
    const BANK_CORE = [
      { ref:"V1 – Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehören.", tip:["Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung, Vergütung, Probezeit, Urlaub, Kündigung, Nachweisform.","§ 11 BBiG (Textform/elektronisch)."]},
      { ref:"V2 – Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:["Berufsbild, Ausbildungsrahmenplan/Dauer, Prüfungen.","§§ 4–5 BBiG."]},
      { ref:"V3 – Probezeit", q:"Wie lang muss/darf die Probezeit sein – und warum ist sie wichtig?", tip:["Mind. 1, max. 4 Monate; Eignungsprüfung beider Seiten.","§ 20 BBiG."]},
      { ref:"V4 – Minderjährige: Unterschrift", q:"Wer unterschreibt den Vertrag bei Minderjährigen mit gemeinsamem Sorgerecht?", tip:["Beide Sorgeberechtigte + Minderjährige/r.","§ 10 BBiG; §§ 1626, 1629 BGB."]}
    ];
    const BANK_RECHT = [
      { ref:"R1 – Art.12 GG", q:"Was garantiert Art. 12 GG bzgl. Beruf/Ausbildungsstätte?", tip:["Freie Wahl; gesetzlich einschränkbar."]},
      { ref:"R2 – AGG Ziel", q:"Ziel des AGG (§1) im Kontext Ausbildung?", tip:["Benachteiligungen verhindern/beseitigen."]},
      { ref:"R3 – §1 BBiG", q:"Vier Säulen §1 BBiG?", tip:["Vorbereitung, Ausbildung, Fortbildung, Umschulung."]},
      { ref:"R4 – §15 BBiG", q:"Freistellung: 2 Beispiele?", tip:["Unterricht/Prüfungen; Wegezeiten Schule→Betrieb."]}
    ];

    const CLUSTERS = [
      { key:"core",  title:"Kern",         icon:"layers",  data:BANK_CORE },
      { key:"recht", title:"Recht",        icon:"scale",   data:BANK_RECHT }
      // ➜ weitere Cluster aus deiner letzten Version kannst du hier wieder anhängen (bas, az, orga, …)
    ];

    // === State ===
    let accepted=false, activeKey="core";
    let answersByRef={}, selectedByRef={};
    let bookmarks = {};

    // Theme load
    const savedTheme = localStorage.getItem("mf_theme") || "light";
    if (savedTheme==="dark") document.documentElement.classList.add("dark");

    // Intro: skip?
    try{
      const skip = localStorage.getItem(INTRO_KEY) === "1";
      if (skip) intro.style.display="none";
    }catch{}

    // Intro: system checks (simuliert + leichtgewichtig)
    setTimeout(()=>{
      // storage
      try{
        const t="ok"+Math.random();
        localStorage.setItem("_intro_test", t);
        const ok = localStorage.getItem("_intro_test")===t;
        stStorage.classList.toggle("done", ok);
      }catch{}
      // network (HEAD/GET ping – optional; bei CORS/404 trotzdem „ok“ anzeigen, damit UX nicht blockiert)
      fetch("/api/linda-proxy", { method:"OPTIONS" }).then(()=> stNetwork.classList.add("done")).catch(()=> stNetwork.classList.add("done"));
      // access
      stAccess.classList.add("done");
      introStatus.textContent = "Bereit • Alles klar";
    }, 300);

    function hideIntro(){
      intro.classList.add("fadeout");
      setTimeout(()=>{ intro.style.display="none"; }, 460);
    }
    introStart.addEventListener("click", (e)=>{ e.preventDefault(); if (introSkip.checked) localStorage.setItem(INTRO_KEY,"1"); hideIntro(); });
    introSkipNow.addEventListener("click", ()=> hideIntro());
    introTheme.addEventListener("click", ()=>{
      document.documentElement.classList.toggle("dark");
      localStorage.setItem("mf_theme", document.documentElement.classList.contains("dark") ? "dark":"light");
      if (window.lucide) lucide.createIcons();
    });

    // === Timer ===
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    },1000);

    // === Disclaimer ===
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked){ toast("Bitte die Checkbox bestätigen."); return; }
      accepted=true; notice.style.display="none"; ackState.textContent="Hinweis bestätigt";
      saveState();
    });

    // === Tabs / Select ===
    const clusterSelectEl = clusterSelect;
    function renderTabs(){
      tabs.innerHTML=""; clusterSelectEl.innerHTML="";
      CLUSTERS.forEach(c=>{
        const b=document.createElement("button");
        b.type="button"; b.className="tab"; b.setAttribute("role","tab");
        b.setAttribute("aria-selected", c.key===activeKey ? "true":"false");
        b.innerHTML=`<i data-lucide="${c.icon}"></i><span>${c.title}</span>`;
        b.addEventListener("click", ()=>{ activeKey=c.key; renderTabs(); renderQuestions(); saveStateThrottled(); });
        tabs.appendChild(b);

        const opt=document.createElement("option");
        opt.value=c.key; opt.textContent=c.title; if(c.key===activeKey) opt.selected=true;
        clusterSelectEl.appendChild(opt);
      });
      if (window.lucide) lucide.createIcons();
    }
    clusterSelectEl.addEventListener("change", (e)=>{ activeKey=e.target.value; renderTabs(); renderQuestions(); saveStateThrottled(); });

    function currentQuestions(){ return CLUSTERS.find(x=>x.key===activeKey)?.data || []; }

    // === Quicklook mini-index ===
    const LAW_INDEX = [
      { law:"BBiG", para:"§ 11", tags:["vertrag","inhalte","mindestinhalte"], excerpt:"Niederschrift der wesentlichen Inhalte.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 20", tags:["probezeit"], excerpt:"Probezeit: min. 1, max. 4 Monate.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"BBiG", para:"§ 15", tags:["freistellung","schule","wegezeit"], excerpt:"Freistellung; Wege Schule→Betrieb anrechenbar.", link:"https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law:"JArbSchG", para:"§§ 8–15", tags:["arbeitszeit","ruhezeit","pausen"], excerpt:"Höchstarbeitszeiten; Ruhepausen; Ruhezeit 12 Std.", link:"https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" }
    ];
    function openQuicklook(){ qlBackdrop.classList.add("open"); qlModal.classList.add("open"); qlSearch.value=""; renderQuicklook(""); qlSearch.focus(); }
    function closeQuicklook(){ qlBackdrop.classList.remove("open"); qlModal.classList.remove("open"); }
    function renderQuicklook(q){
      const query=(q||"").toLowerCase().trim();
      const list = query ? LAW_INDEX.filter(x=> x.para.toLowerCase().includes(query) || x.law.toLowerCase().includes(query) || x.tags.some(t=>t.includes(query)) ) : LAW_INDEX;
      qlList.innerHTML="";
      if (!list.length){ qlList.innerHTML=`<div class="text-sm text-slate-500">Keine Treffer – versuche „§11“, „Probezeit“, „Ruhezeit“ …</div>`; return; }
      list.forEach(x=>{
        const row=document.createElement("div");
        row.className="p-3 rounded-lg border hover:bg-[color:var(--surface-hover)]";
        row.innerHTML=`
          <div class="flex items-center justify-between">
            <div class="font-semibold">${x.law} ${x.para}</div>
            <a class="btn btn-sm" href="${x.link}" target="_blank" rel="noopener">PDF öffnen</a>
          </div>
          <div class="text-sm text-slate-600 mt-1">${x.excerpt}</div>
          <div class="mt-1 flex flex-wrap gap-1">${x.tags.map(t=>`<span class="badge">${t}</span>`).join("")}</div>
        `;
        qlList.appendChild(row);
      });
    }
    quickBtn.addEventListener("click", openQuicklook);
    qlBackdrop.addEventListener("click", closeQuicklook);
    qlClose.addEventListener("click", closeQuicklook);
    qlSearch.addEventListener("input", (e)=> renderQuicklook(e.target.value));
    document.addEventListener("keydown",(e)=>{ if(e.key==="?") openQuicklook(); });

    // === Bookmarks Modal ===
    function openBM(){ bmBackdrop.classList.add("open"); bmModal.classList.add("open"); renderBM(); }
    function closeBM(){ bmBackdrop.classList.remove("open"); bmModal.classList.remove("open"); }
    bookmarksBtn.addEventListener("click", openBM);
    bmBackdrop.addEventListener("click", closeBM);
    bmClose?.addEventListener("click", closeBM);
    function renderBM(){
      const refs=Object.keys(bookmarks).filter(r=>bookmarks[r]);
      bmList.innerHTML = refs.length? "": `<div class="text-sm text-slate-500">Keine Markierungen.</div>`;
      refs.forEach(ref=>{
        const ans=(answersByRef[ref]||"").trim();
        const div=document.createElement("div");
        div.className="p-3 rounded-lg border";
        div.innerHTML = `<div class="font-semibold mb-1">${ref}</div><div class="text-sm text-slate-600">${ans?ans.slice(0,200)+"…":"(keine Antwort)"}</div>`;
        bmList.appendChild(div);
      });
    }
    function updateBMCount(){
      const n = Object.values(bookmarks).filter(Boolean).length;
      if (n>0){ bookmarkCount.textContent=String(n); bookmarkCount.style.display="inline-flex"; }
      else bookmarkCount.style.display="none";
    }

    // === History (Snapshot pro Gesamtfeedback) ===
    function openHist(){ histBackdrop.classList.add("open"); histModal.classList.add("open"); renderHist(); }
    function closeHist(){ histBackdrop.classList.remove("open"); histModal.classList.remove("open"); }
    historyBtn.addEventListener("click", openHist);
    histBackdrop.addEventListener("click", closeHist);
    histClose.addEventListener("click", closeHist);
    function renderHist(){
      const arr = loadHistory();
      histList.innerHTML = "";
      if (!arr.length){ histList.innerHTML = `<div class="text-sm text-slate-500">Noch keine Einträge.</div>`; return; }
      arr.slice().reverse().forEach(h=>{
        const d=document.createElement("div");
        d.className="p-3 rounded-lg border";
        d.innerHTML = `<div class="text-[11px] text-slate-500">${new Date(h.ts).toLocaleString()}</div><div class="mt-1 prose text-sm">${window.marked? marked.parse(h.html): h.html}</div>`;
        histList.appendChild(d);
      });
    }
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem("MF_CLUSTER_HISTORY_V1")||"[]"); }catch{ return []; } }
    function saveHistory(html){
      const arr = loadHistory(); arr.push({ts:Date.now(), html}); localStorage.setItem("MF_CLUSTER_HISTORY_V1", JSON.stringify(arr));
    }

    // === State restore ===
    (function restore(){
      try{
        const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
        if (s && typeof s==='object'){
          accepted = !!s.accepted;
          activeKey = s.activeKey || "core";
          answersByRef = s.answersByRef || {};
          selectedByRef = s.selectedByRef || {};
        }
      }catch{}
      try{ bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY)||"{}"); }catch{}
      if (accepted){ notice.style.display="none"; ack.checked=true; ackState.textContent="Hinweis bestätigt"; }
    })();

    // === Render Fragen ===
    function renderQuestions(){
      // persist visible
      [...form.querySelectorAll("section[data-ref]")].forEach(sec=>{
        const ref=sec.getAttribute("data-ref");
        const ta=sec.querySelector("textarea");
        const cb=sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answersByRef[ref]=ta.value;
        if (cb) selectedByRef[ref]=cb.checked;
      });

      const QUESTIONS = currentQuestions();
      form.innerHTML="";
      QUESTIONS.forEach((item, idx)=>{
        const id=`q_${idx}`, fbId=`fb_${idx}`, selId=`sel_${idx}`;
        const sec=document.createElement("section");
        sec.className="card q-card";
        sec.setAttribute("data-ref", item.ref);
        const isMarked = !!bookmarks[item.ref];
        sec.innerHTML = `
          <button type="button" class="bookmark ${isMarked?'active':''}" data-bm="${item.ref}" title="Markieren">
            <i data-lucide="bookmark" class="w-4 h-4 ${isMarked?'text-black':''}"></i>
          </button>

          <header class="flex items-center justify-between gap-3 mb-1">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-[#005EB8]" data-select="${idx}" aria-label="Für KI-Feedback auswählen">
              <span class="badge badge-primary">Frage ${idx+1}</span>
              <span class="badge">${item.ref}</span>
            </div>
            <span class="text-[11px] text-slate-400">Cluster: ${CLUSTERS.find(c=>c.key===activeKey)?.title||''}</span>
          </header>

          <h3 class="text-[15px] font-semibold mb-2">${item.q}</h3>

          <details class="tip mb-2">
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-[#005EB8] hover:opacity-90 text-[13px]">
              <i data-lucide="info" class="w-4 h-4"></i><span>🛈 Musterlösung</span>
            </summary>
            <div class="mt-2">${(item.tip||[]).map(t=>`<p class="text-sm">• ${t}</p>`).join("")}
              <div class="mt-2 flex gap-2">
                <button type="button" data-quick="${idx}" class="btn btn-sm"><i data-lucide="search" class="w-4 h-4"></i> §-Quicklook</button>
                <button type="button" data-ask="${idx}" class="btn btn-sm"><i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check</button>
              </div>
              <div id="${fbId}" class="prose text-sm max-w-none hidden mt-2"></div>
            </div>
          </details>

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-[#005EB8] text-[15px]" placeholder="Deine Antwort …"></textarea>

          <div class="mt-2">
            <button type="button" data-fill="${id}" class="btn btn-sm">Beispiel-Gliederung</button>
          </div>
        `;
        form.appendChild(sec);

        const ta=sec.querySelector("textarea");
        const cb=sec.querySelector(`[data-select]`);
        if (answersByRef[item.ref]) ta.value = answersByRef[item.ref];
        if (selectedByRef[item.ref]!=null) cb.checked = !!selectedByRef[item.ref];
      });

      // events
      form.querySelectorAll("textarea").forEach(ta=>{
        ta.addEventListener("input", ()=>{ answersByRef[ta.closest("section").getAttribute("data-ref")] = ta.value; updateProgress(); saveStateThrottled(); });
        ta.addEventListener("keydown", (e)=>{ if((e.ctrlKey||e.metaKey)&&e.key==="Enter"){ e.preventDefault(); submitBtn.click(); } });
      });
      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ta=document.getElementById(btn.getAttribute("data-fill"));
          ta.value = ["### Kurzantwort","- …","- …","- …","","### Begründung/Norm (optional)","- …"].join("\n");
          answersByRef[ta.closest("section").getAttribute("data-ref")] = ta.value;
          updateProgress(); saveStateThrottled();
        });
      });
      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!accepted){ toast("Bitte zuerst den Hinweis bestätigen."); return; }
          await askPerAnswer(Number(e.currentTarget.getAttribute("data-ask")), e.currentTarget);
        });
      });
      form.querySelectorAll("[data-select]").forEach(cb=>{
        cb.addEventListener("change", (e)=>{
          const ref=e.currentTarget.closest("section").getAttribute("data-ref");
          selectedByRef[ref] = e.currentTarget.checked; updateSelCount(); saveStateThrottled();
        });
      });
      form.querySelectorAll("[data-quick]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const idx=Number(btn.getAttribute("data-quick"));
          const item=currentQuestions()[idx];
          openQuicklook();
          const terms=(item.q+" "+(item.tip||[]).join(" ")).toLowerCase();
          const keys=["§","probezeit","ruhezeit","vergütung","freistellung","ausbildungsordnung","ausbildungsplan","kündigung","ausland","berichtsheft"];
          const hit=keys.find(k=>terms.includes(k))||"";
          qlSearch.value=hit; renderQuicklook(hit);
        });
      });
      form.querySelectorAll("[data-bm]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ref=btn.getAttribute("data-bm");
          bookmarks[ref]=!bookmarks[ref];
          if (!bookmarks[ref]) delete bookmarks[ref];
          localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
          btn.classList.toggle("active", !!bookmarks[ref]);
          updateBMCount();
          if (window.lucide) lucide.createIcons();
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelCount(); updateProgress(); updateBMCount();
    }

    function updateSelCount(){
      const n = Object.entries(selectedByRef).filter(([r,v])=>v).length;
      selText.textContent = `${n} ausgewählt`;
    }
    function updateProgress(){
      const allRefs = currentQuestions().map(q=>q.ref);
      const answered = allRefs.filter(r => (answersByRef[r]||"").trim().length>0).length;
      const total = allRefs.length || 1;
      progressBar.style.width = Math.round((answered/total)*100) + "%";
      progressTxt.textContent = `${answered} / ${total} beantwortet`;
    }

    // === Prompts (wohlwollend) ===
    function buildPromptSingle(item, answer){
      return `
Beurteile **wohlwollend** eine Kurzantwort (Ausbildung/Arbeitsrecht). Wenn die geforderte Anzahl erfüllt ist, bestätige ausdrücklich **„passt“** und ergänze nur optional weitere zulässige Punkte.

Antwortschema je Frage – knapp:
- **Kurzfeedback** (max. 2 Sätze; inkl. „passt“, falls erfüllt)
- **Richtige Lösung** (max. 4 Bulletpoints; ggf. Ergänzungen)
- **Gesetz/§** (falls einschlägig: BBiG/JArbSchG/BUrlG/ArbZG/MuSchG/AGG/DSGVO/BGB/BetrVG)
- **1 Praxistipp** (1 Satz)

Frage: ${item.q}
Antwort TN: ${answer || "(leer)"}`.trim();
    }
    function buildPromptAll(list){
      return `
Beurteile **wohlwollend** mehrere Kurzantworten (Ausbildung/Arbeitsrecht). Wenn die Soll-Anzahl erfüllt ist, schreibe **„passt“** und ergänze nur optional.

Schema je Frage (knapp):
- Kurzfeedback (max. 2 Sätze; inkl. „passt“ bei Erfüllung)
- Richtige Lösung (max. 4 Bulletpoints)
- Gesetz/§ (falls einschlägig)
- 1 Praxistipp (1 Satz)

Fragen & Antworten:
${list.map(a=>`Q${a.nr} (${a.ref}): ${a.question}\nAntwort TN: ${a.answer || "(leer)"}`).join("\n\n")}
`.trim();
    }

    async function callAI(payload,{timeoutMs=22000,retries=1}={}){
      let lastErr;
      for(let a=0;a<=retries;a++){
        try{
          const res=await Promise.race([
            fetch(relay,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),timeoutMs))
          ]);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const t=await res.text();
          try { const j=JSON.parse(t); return j.answer||j.content||j.result||t; } catch { return t; }
        }catch(e){ lastErr=e; }
      }
      throw lastErr||new Error("Unbekannter Fehler");
    }

    async function askPerAnswer(idx, btnEl){
      const QUESTIONS = currentQuestions();
      const item = QUESTIONS[idx];
      const ref = item.ref;
      const val = (answersByRef[ref]||"").trim();

      const fb = document.getElementById(`fb_${idx}`);
      btnEl.disabled=true; const old=btnEl.innerHTML;
      btnEl.innerHTML = `<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> Prüfen …`;
      fb.classList.remove("hidden"); fb.innerHTML = `<div class="text-slate-500 text-sm">KI prüft …</div>`;

      try{
        const out = await callAI({ prompt: buildPromptSingle(item,val) });
        fb.innerHTML = (window.marked ? marked.parse(out || "_Keine Antwort erhalten._") : (out || "_Keine Antwort erhalten._"));
      }catch(e){
        fb.innerHTML = `<div class="text-red-600 text-sm">Fehler: ${String(e).replace(/[<>&]/g,"")}</div>`;
        toast("KI-Check fehlgeschlagen.");
      }finally{
        btnEl.disabled=false; btnEl.innerHTML=old; if (window.lucide) lucide.createIcons();
      }
    }

    // === Gesamt-Feedback ===
    submitBtn.addEventListener("click", async ()=>{
      if (!accepted){ toast("Bitte zuerst den Hinweis bestätigen."); return; }
      const QUESTIONS = currentQuestions();
      let selRefs = QUESTIONS.map(q=>q.ref).filter(r=>selectedByRef[r]);
      if (selRefs.length===0){
        // falls nichts gewählt: alle mit Inhalt
        selRefs = QUESTIONS.map(q=>q.ref).filter(r => (answersByRef[r]||"").trim().length>0);
        if (selRefs.length===0){ toast("Bitte wähle mindestens eine Frage (oder schreibe eine Antwort)."); return; }
      }

      const list = selRefs.map((ref, i)=>{
        const q = QUESTIONS.find(x=>x.ref===ref);
        return { nr:i+1, ref:q.ref, question:q.q, answer:(answersByRef[ref]||"").trim() };
      });

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = `<div class="text-slate-500 text-sm">KI erstellt Feedback …</div>`;
      submitBtn.disabled=true; const old=submitBtn.innerHTML;
      submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> Prüfen …`;

      try{
        const out = await callAI({ prompt: buildPromptAll(list) });
        aiResult.innerHTML = (window.marked ? marked.parse(out || "_Keine Antwort erhalten._") : (out || "_Keine Antwort erhalten._"));
        saveHistory(aiResult.innerHTML);
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      }catch(e){
        aiResult.innerHTML = `<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
      }finally{
        submitBtn.disabled=false; submitBtn.innerHTML=old; if (window.lucide) lucide.createIcons();
      }
    });

    // === Reset ===
    resetBtn.addEventListener("click", ()=>{
      if (!confirm("Alle Eingaben im aktuellen Cluster löschen?")) return;
      currentQuestions().forEach(q=>{ delete answersByRef[q.ref]; delete selectedByRef[q.ref]; });
      renderQuestions(); saveState();
      resultWrap.classList.add("hidden"); aiResult.innerHTML="";
      window.scrollTo({top:0, behavior:"smooth"});
    });

    // === Save / Load ===
    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          ts:Date.now(), accepted, activeKey, answersByRef, selectedByRef
        }));
      }catch{}
    }
    let tmr=null; function saveStateThrottled(){ clearTimeout(tmr); tmr=setTimeout(saveState, 400); }

    // === Toast ===
    function toast(msg){ toastEl.textContent=msg; toastEl.style.display="block"; clearTimeout(toast._t); toast._t=setTimeout(()=>toastEl.style.display="none", 2600); }

    // === Init ===
    renderTabs();
    renderQuestions();

    // Header theme button
    themeToggle.addEventListener("click", ()=>{
      document.documentElement.classList.toggle("dark");
      localStorage.setItem("mf_theme", document.documentElement.classList.contains("dark") ? "dark":"light");
      if (window.lucide) lucide.createIcons();
    });

    // Bookmarks
    try{ bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY)||"{}"); }catch{}
    updateBMCount();

  });
  </script>
</body>
</html>
