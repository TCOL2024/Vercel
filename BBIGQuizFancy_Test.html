<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz – Professional Edition</title>

  <!-- External Dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      /* metafinanz.de Professional Color Scheme */
      --mf-primary: #005EB8;
      --mf-primary-dark: #004A93;
      --mf-primary-light: #1976D2;
      --mf-secondary: #00A0E3;
      --mf-accent: #FF9900;
      --mf-accent-hover: #EC7211;
      --mf-success: #00D4AA;
      --mf-warning: #FFA726;
      --mf-error: #E53935;
      
      --surface: #FFFFFF;
      --surface-alt: #F7F8F8;
      --surface-hover: #EBEEF0;
      --text: #0F1111;
      --text-muted: #565959;
      --text-light: #6F7373;
      --border: #D5D9D9;
      --border-focus: #005EB8;
      
      --radius: 4px;
      --radius-lg: 8px;
      --shadow-xs: 0 1px 2px rgba(15,17,17,.04);
      --shadow-sm: 0 1px 3px rgba(15,17,17,.08);
      --shadow-md: 0 2px 8px rgba(15,17,17,.12);
      --shadow-lg: 0 4px 16px rgba(15,17,17,.16);
    }
    
    html.dark {
      --surface: #131A22;
      --surface-alt: #1C2531;
      --surface-hover: #232F3E;
      --text: #FFFFFF;
      --text-muted: #AAB7B8;
      --text-light: #CCCCCC;
      --border: #3A4553;
      --border-focus: #FF9900;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      font-size: 14px;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
    }
    
    body {
      background: var(--surface-alt);
      color: var(--text);
      transition: background 0.2s ease, color 0.2s ease;
    }
    
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      transition: all 0.15s ease;
    }
    
    .card:hover {
      border-color: var(--border-focus);
      box-shadow: var(--shadow-sm);
    }
    
    .card-elevated {
      box-shadow: var(--shadow-sm);
    }
    
    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
      text-decoration: none;
    }
    
    .btn:hover:not(:disabled) {
      background: var(--surface-hover);
      border-color: var(--text-muted);
    }
    
    .btn:active:not(:disabled) {
      transform: scale(0.98);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: var(--mf-accent);
      border-color: var(--mf-accent);
      color: #111;
      font-weight: 700;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: var(--mf-accent-hover);
      border-color: var(--mf-accent-hover);
    }
    
    .btn-blue {
      background: var(--mf-primary);
      border-color: var(--mf-primary);
      color: #fff;
      font-weight: 700;
    }
    
    .btn-blue:hover:not(:disabled) {
      background: var(--mf-primary-dark);
      border-color: var(--mf-primary-dark);
    }
    
    .btn-ghost {
      background: transparent;
      border: none;
    }
    
    .btn-ghost:hover:not(:disabled) {
      background: var(--surface-hover);
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .btn-lg {
      padding: 12px 24px;
      font-size: 14px;
    }
    
    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      font-size: 11px;
      font-weight: 700;
      border-radius: 12px;
      background: var(--surface-alt);
      color: var(--text-muted);
      border: 1px solid var(--border);
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }
    
    .badge-primary {
      background: #E7F1FF;
      color: var(--mf-primary);
      border-color: #B3D9FF;
    }
    
    .badge-success {
      background: #E8F5E9;
      color: var(--mf-success);
      border-color: #A5D6A7;
    }
    
    .badge-warning {
      background: #FFF3E0;
      color: var(--mf-warning);
      border-color: #FFB74D;
    }
    
    /* Progress Bar */
    .progress-outer {
      height: 8px;
      border-radius: 4px;
      background: var(--surface-alt);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    .progress-inner {
      height: 100%;
      background: linear-gradient(90deg, var(--mf-primary), var(--mf-secondary));
      transition: width 0.3s ease;
      box-shadow: 0 0 8px rgba(0, 94, 184, 0.3);
    }
    
    /* Input Styles */
    input[type="text"],
    input[type="search"],
    input[type="checkbox"],
    textarea,
    select {
      font-family: inherit;
      font-size: 13px;
    }
    
    input[type="text"],
    input[type="search"],
    textarea,
    select {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--radius);
      transition: all 0.15s ease;
      padding: 8px 12px;
      width: 100%;
    }
    
    input:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(0, 94, 184, 0.1);
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    /* Typography */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
    }
    
    h1 { font-size: 28px; }
    h2 { font-size: 21px; }
    h3 { font-size: 17px; }
    
    /* Header */
    .app-header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
    }
    
    /* Notice Banner */
    .notice {
      background: #FFF8DC;
      border-bottom: 1px solid #F0E68C;
      padding: 12px 0;
    }
    
    html.dark .notice {
      background: #2C2416;
      border-bottom: 1px solid #4A3C1E;
    }
    
    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: none;
      z-index: 998;
      animation: fadeIn 0.2s ease;
    }
    
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }
    
    .modal.open,
    .modal-backdrop.open {
      display: flex;
    }
    
    .modal-panel {
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      color: var(--text);
      padding: 12px 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      z-index: 9999;
      font-size: 13px;
      font-weight: 600;
      display: none;
      animation: slideUp 0.3s ease;
    }
    
    /* Command Palette */
    .command-palette {
      width: 600px;
      max-width: 90vw;
    }
    
    .command-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.15s ease;
    }
    
    .command-item:hover {
      background: var(--surface-hover);
    }
    
    .command-item.active {
      background: var(--mf-primary);
      color: white;
    }
    
    .command-kbd {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 600;
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: 3px;
      margin-left: auto;
      font-family: monospace;
    }
    
    /* Bookmark */
    .bookmark-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: var(--surface);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.15s ease;
      z-index: 10;
    }
    
    .bookmark-btn:hover {
      background: var(--mf-accent);
      border-color: var(--mf-accent);
      transform: scale(1.1);
    }
    
    .bookmark-btn.active {
      background: var(--mf-accent);
      border-color: var(--mf-accent);
    }
    
    .bookmark-btn.active svg {
      fill: #111;
    }
    
    /* Question Card */
    .question-card {
      position: relative;
      padding: 24px;
      margin-bottom: 16px;
    }
    
    /* Status Dot */
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-online {
      background: var(--mf-success);
      animation: pulse 2s infinite;
    }
    
    .status-offline {
      background: var(--mf-error);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Chart */
    .chart-container {
      position: relative;
      height: 280px;
      margin: 16px 0;
    }
    
    /* Rubric */
    .rubric {
      background: var(--surface-alt);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 12px;
    }
    
    .rubric-bar {
      height: 6px;
      background: var(--surface-alt);
      border-radius: 3px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    .rubric-fill {
      height: 100%;
      background: var(--mf-primary);
      transition: width 0.4s ease;
      box-shadow: 0 0 6px rgba(0, 94, 184, 0.4);
    }
    
    /* Tip */
    .tip {
      background: #F0F8FF;
      border-left: 3px solid var(--mf-primary);
      padding: 12px;
      border-radius: var(--radius);
      font-size: 12px;
      margin-top: 12px;
    }
    
    html.dark .tip {
      background: rgba(0, 94, 184, 0.1);
    }
    
    /* Feedback */
    .feedback-wrap {
      background: #E7F1FF;
      border: 1px solid #B3D9FF;
      border-radius: var(--radius);
      padding: 12px;
      margin-top: 12px;
    }
    
    html.dark .feedback-wrap {
      background: rgba(0, 94, 184, 0.15);
      border-color: rgba(0, 94, 184, 0.3);
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: var(--surface-alt);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
    
    /* Prose */
    .prose {
      color: var(--text);
      line-height: 1.6;
    }
    
    .prose p {
      margin-bottom: 12px;
    }
    
    .prose ul,
    .prose ol {
      margin-left: 24px;
      margin-bottom: 12px;
    }
    
    .prose strong {
      font-weight: 700;
      color: var(--mf-primary);
    }
    
    .prose code {
      background: var(--surface-alt);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
      border: 1px solid var(--border);
    }
    
    /* Utilities */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* Loading Animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* Print */
    @media print {
      .app-header,
      .notice,
      .bookmark-btn,
      button,
      .modal {
        display: none !important;
      }
      body {
        background: white;
      }
      .card {
        border: 1px solid #ddd;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>

  <!-- Notice Banner -->
  <aside id="notice" class="notice">
    <div class="container">
      <div style="display: flex; align-items: start; gap: 12px; font-size: 13px;">
        <i data-lucide="shield-check" style="width: 20px; height: 20px; flex-shrink: 0; color: #856404;"></i>
        <div style="flex: 1;">
          <p style="font-weight: 700; color: #856404; margin-bottom: 4px;">Fachlicher Hinweis (Pilot)</p>
          <p style="color: #856404;">
            Die KI-Prüfung unterstützt beim Lernen. Ergebnisse müssen fachlich geprüft werden.
            <strong>Es dürfen keine personenbezogenen oder sensiblen Daten eingegeben werden.</strong>
          </p>
          <label style="display: flex; align-items: center; gap: 8px; margin-top: 8px; cursor: pointer;">
            <input id="ack" type="checkbox" style="width: 16px; height: 16px; cursor: pointer;" />
            <span style="color: #856404; font-weight: 600;">Ich habe den Hinweis gelesen und akzeptiert.</span>
          </label>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="badge badge-warning">
            <span class="status-dot status-online"></span>
            <span id="apiStatusText">API: Online</span>
          </span>
          <button id="ackBtn" type="button" class="btn btn-primary btn-sm">
            <i data-lucide="check" style="width: 16px; height: 16px;"></i> Weiter
          </button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="app-header">
    <div class="container">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; border-radius: 4px; background: linear-gradient(135deg, var(--mf-primary), var(--mf-primary-dark)); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-sm);">
            <i data-lucide="graduation-cap" style="width: 24px; height: 24px; color: white;"></i>
          </div>
          <div>
            <h1 style="font-size: 20px; font-weight: 700; margin-bottom: 2px;">BBiG-Quiz Professional</h1>
            <p style="font-size: 11px; color: var(--text-muted); font-weight: 500;">20 Kernfragen • KI-Feedback • §-Quicklook</p>
          </div>
        </div>
        
        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
          <button id="commandBtn" type="button" class="btn btn-sm" title="Befehle (Ctrl+K)">
            <i data-lucide="command" style="width: 16px; height: 16px;"></i>
          </button>
          <button id="bookmarksBtn" type="button" class="btn btn-sm" title="Markierte Fragen">
            <i data-lucide="bookmark" style="width: 16px; height: 16px;"></i>
            <span id="bookmarkCount" class="badge badge-primary" style="display:none; margin-left: -4px;">0</span>
          </button>
          <button id="historyBtn" type="button" class="btn btn-sm" title="Historie">
            <i data-lucide="history" style="width: 16px; height: 16px;"></i>
          </button>
          <button id="quickBtn" type="button" class="btn btn-blue btn-sm">
            <i data-lucide="search" style="width: 16px; height: 16px;"></i> §-Quicklook
          </button>
          <button id="themeToggle" type="button" class="btn btn-ghost btn-sm" title="Theme wechseln">
            <i data-lucide="moon" style="width: 16px; height: 16px;"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Progress Section -->
  <section class="container" style="margin-top: 16px;">
    <div class="card card-elevated" style="padding: 16px;">
      <div style="display: flex; align-items: center; gap: 16px;">
        <i data-lucide="target" style="width: 20px; height: 20px; color: var(--mf-primary); flex-shrink: 0;"></i>
        <div style="flex: 1;">
          <div style="display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 8px;">
            <span id="progressText">0 / 20 beantwortet</span>
            <span id="selText">0 ausgewählt</span>
          </div>
          <div class="progress-outer">
            <div id="progressBar" class="progress-inner" style="width: 0%;"></div>
          </div>
        </div>
        <time id="timer" style="font-size: 13px; font-family: monospace; font-weight: 700; color: var(--text-muted);">00:00</time>
      </div>
    </div>
  </section>

  <!-- Spider Chart -->
  <section class="container" id="chartSection" style="margin-top: 16px; display:none;">
    <div class="card card-elevated" style="padding: 16px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
        <i data-lucide="pie-chart" style="width: 20px; height: 20px; color: var(--mf-primary);"></i>
        <h2 style="font-weight: 700; font-size: 17px;">Rubrik-Analyse</h2>
      </div>
      <div class="chart-container">
        <canvas id="rubricChart"></canvas>
      </div>
    </div>
  </section>

  <!-- Quiz Form -->
  <main class="container" style="margin-top: 16px; margin-bottom: 80px;">
    <form id="form" novalidate></form>
    
    <section id="resultWrap" class="hidden" style="margin-top: 16px;">
      <div class="card card-elevated" style="padding: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <i data-lucide="sparkles" style="width: 20px; height: 20px; color: var(--mf-primary);"></i>
          <h2 style="font-weight: 700; font-size: 17px;">KI-Feedback (Gesamt)</h2>
        </div>
        <article id="aiResult" class="prose" style="font-size: 13px;"></article>
      </div>
    </section>
  </main>

  <!-- Sticky Actions -->
  <div style="position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); padding: 12px 0; z-index: 50; backdrop-filter: blur(8px);">
    <div class="container" style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
      <div style="display: flex; gap: 8px;">
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener" title="BBiG (PDF)">
          <i data-lucide="book-open" style="width: 16px; height: 16px;"></i> BBiG
        </a>
        <a class="btn btn-sm" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener" title="JArbSchG (PDF)">
          <i data-lucide="shield" style="width: 16px; height: 16px;"></i> JArbSchG
        </a>
      </div>
      <div style="display: flex; gap: 8px;">
        <button id="submitBtn" type="button" class="btn btn-primary">
          <i data-lucide="send" style="width: 16px; height: 16px;"></i> KI-Feedback
        </button>
        <button id="resetBtn" type="button" class="btn">
          <i data-lucide="rotate-ccw" style="width: 16px; height: 16px;"></i> Zurücksetzen
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Command Palette Modal -->
  <div id="commandBackdrop" class="modal-backdrop"></div>
  <div id="commandModal" class="modal">
    <div class="modal-panel card card-elevated command-palette" style="padding: 0;">
      <div style="padding: 16px; border-bottom: 1px solid var(--border);">
        <input id="commandSearch" type="search" placeholder="Befehle durchsuchen..." autofocus style="border: none; padding: 8px 0; font-size: 14px; font-weight: 500;" />
      </div>
      <div id="commandList" style="padding: 8px; max-height: 400px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- Bookmarks Modal -->
  <div id="bookmarksBackdrop" class="modal-backdrop"></div>
  <div id="bookmarksModal" class="modal">
    <div class="modal-panel card card-elevated" style="padding: 24px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i data-lucide="bookmark" style="width: 20px; height: 20px; color: var(--mf-primary);"></i>
          <h2 style="font-weight: 700; font-size: 17px;">Markierte Fragen</h2>
        </div>
        <button id="bookmarksClose" type="button" class="btn btn-ghost btn-sm">
          <i data-lucide="x" style="width: 16px; height: 16px;"></i>
        </button>
      </div>
      <div id="bookmarksList" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- Quicklook Modal -->
  <div id="qlBackdrop" class="modal-backdrop"></div>
  <div id="qlModal" class="modal">
    <div class="modal-panel card card-elevated" style="padding: 24px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i data-lucide="search" style="width: 20px; height: 20px; color: var(--mf-primary);"></i>
          <h2 style="font-weight: 700; font-size: 17px;">§-Quicklook – BBiG & JArbSchG</h2>
        </div>
        <button id="qlClose" type="button" class="btn btn-ghost btn-sm">
          <i data-lucide="x" style="width: 16px; height: 16px;"></i>
        </button>
      </div>
      <input id="qlSearch" type="search" placeholder="Begriff oder § suchen..." style="margin-bottom: 16px;" />
      <div id="qlList" style="display: grid; gap: 12px; max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="historyBackdrop" class="modal-backdrop"></div>
  <div id="historyModal" class="modal">
    <div class="modal-panel card card-elevated" style="padding: 24px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <i data-lucide="history" style="width: 20px; height: 20px; color: var(--mf-primary);"></i>
          <h2 style="font-weight: 700; font-size: 17px;">Antwort-Historie</h2>
        </div>
        <button id="historyClose" type="button" class="btn btn-ghost btn-sm">
          <i data-lucide="x" style="width: 16px; height: 16px;"></i>
        </button>
      </div>
      <div id="historyList" style="display: grid; gap: 12px; max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer style="background: var(--surface-alt); border-top: 1px solid var(--border); padding: 24px 0; margin-top: 48px;">
    <div class="container">
      <p style="font-size: 11px; text-align: center; color: var(--text-muted); line-height: 1.6;">
        Diese Anwendung nutzt künstliche Intelligenz (KI). Mit der Nutzung stimmst du zu, dass deine Texte von OpenAI über Make.com verarbeitet werden.
        Es werden keine personenbezogenen Daten erhoben. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind zu prüfen.
        KI-generierte Antworten können fehlerhaft sein.
      </p>
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Initialize Lucide Icons
    if (window.lucide) lucide.createIcons();

    // === Configuration ===
    const relay = "/api/linda-proxy"; // Make.com Webhook
    const STORAGE_KEY = "BBIGQUIZ_V3";
    const HISTORY_KEY = "BBIGQUIZ_HISTORY";
    const BOOKMARK_KEY = "BBIGQUIZ_BOOKMARKS";
    const MAX_ANSWER_CHARS = 1500;
    const RUBRIC_KEYS = ["normbezug", "vollstaendigkeit", "praxisbezug"];

    // === UI References ===
    const form = document.getElementById("form");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const timerEl = document.getElementById("timer");
    const resultWrap = document.getElementById("resultWrap");
    const aiResult = document.getElementById("aiResult");
    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const themeToggle = document.getElementById("themeToggle");
    const toastEl = document.getElementById("toast");
    const chartSection = document.getElementById("chartSection");
    const rubricChartCanvas = document.getElementById("rubricChart");
    
    const commandBtn = document.getElementById("commandBtn");
    const commandBackdrop = document.getElementById("commandBackdrop");
    const commandModal = document.getElementById("commandModal");
    const commandSearch = document.getElementById("commandSearch");
    const commandList = document.getElementById("commandList");
    
    const bookmarksBtn = document.getElementById("bookmarksBtn");
    const bookmarksBackdrop = document.getElementById("bookmarksBackdrop");
    const bookmarksModal = document.getElementById("bookmarksModal");
    const bookmarksClose = document.getElementById("bookmarksClose");
    const bookmarksList = document.getElementById("bookmarksList");
    const bookmarkCount = document.getElementById("bookmarkCount");
    
    const quickBtn = document.getElementById("quickBtn");
    const qlBackdrop = document.getElementById("qlBackdrop");
    const qlModal = document.getElementById("qlModal");
    const qlClose = document.getElementById("qlClose");
    const qlSearch = document.getElementById("qlSearch");
    const qlList = document.getElementById("qlList");
    
    const historyBtn = document.getElementById("historyBtn");
    const historyBackdrop = document.getElementById("historyBackdrop");
    const historyModal = document.getElementById("historyModal");
    const historyClose = document.getElementById("historyClose");
    const historyList = document.getElementById("historyList");

    let rubricChart = null;
    if (window.marked) marked.setOptions({ breaks: true, gfm: true });

    // === Questions (20 Core Questions) ===
    const QUESTIONS_ALL = [
      { ref: "V1 – Mindestinhalte Vertrag", q: "Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehören.", tip: ["Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung.", "§ 11 BBiG."] },
      { ref: "V2 – Ausbildungsordnung", q: "Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip: ["Berufsbild, Dauer/Ausbildungsrahmenplan, Prüfungen.", "§§ 4–5 BBiG."] },
      { ref: "V3 – Probezeit", q: "Wie lang muss/darf die Probezeit sein – und warum ist sie wichtig?", tip: ["Mind. 1, max. 4 Monate; Eignungsprüfung beider Seiten.", "§ 20 BBiG."] },
      { ref: "V4 – Minderjährige: Unterschrift", q: "Wer unterschreibt den Vertrag bei Minderjährigen mit gemeinsamem Sorgerecht?", tip: ["Beide Sorgeberechtigte + Minderjährige/r.", "§ 10 BBiG; § 107 BGB."] },
      { ref: "V5 – Berufsschulzeit & Arbeitszeit", q: "Wie werden Berufsschulzeiten auf die Arbeitszeit angerechnet (U18 vs. ≥18)?", tip: ["U18: besondere Anrechnung (JArbSchG).", "Wegezeiten Schule→Betrieb; § 15 BBiG."] },
      { ref: "V6 – Ruhezeit Jugendliche", q: "Welche tägliche Mindestruhezeit gilt für Jugendliche?", tip: ["Mindestens 12 Stunden.", "JArbSchG."] },
      { ref: "V7 – Vergütung", q: "Was gilt zur Angemessenheit der Ausbildungsvergütung?", tip: ["MiAV Untergrenze; tariflich/branchenüblich; Steigerung je Jahr.", "§ 17 BBiG."] },
      { ref: "V8 – Überstunden", q: "Sind Überstunden zulässig – und wie werden sie behandelt?", tip: ["Nur ausbildungsdienlich; Vergütung/Zeitausgleich; Jugendarbeitsschutz beachten.", "ArbZG/JArbSchG."] },
      { ref: "V9 – Betrieblicher Ausbildungsplan", q: "Wozu dient der betriebliche Ausbildungsplan?", tip: ["Umsetzung Rahmenplan, zeitl./sachl. Gliederung, Qualitätssicherung.", "§ 5 BBiG; Verweis § 11."] },
      { ref: "V10 – Berichtsheft", q: "Welche Bedeutung hat das Berichtsheft und wer kontrolliert es?", tip: ["Zulassungsvoraussetzung; elektronisch möglich; Kontrolle Ausbilder/in.", "§ 13 Nr.7, § 14 Abs.1 Nr.4 BBiG."] },
      { ref: "V11 – Verkürzung", q: "Wann kann die Ausbildungsdauer verkürzt werden?", tip: ["Vorbildung/Leistung/Anrechnung; Einvernehmen nötig.", "§ 8 BBiG."] },
      { ref: "V12 – Verlängerung", q: "Wann kommt eine Verlängerung in Betracht?", tip: ["Nichtbestehen oder besondere Fälle.", "§ 8 Abs. 2 BBiG."] },
      { ref: "V13 – Teilzeitberufsausbildung", q: "Wie funktioniert Teilzeit in der Ausbildung und was bleibt unverändert?", tip: ["Reduzierte Zeiten, Lernziel bleibt; evtl. längere Gesamtdauer.", "§ 7a BBiG."] },
      { ref: "V14 – Datenschutz/Geheimnis", q: "Welche Pflichten haben Azubis zu Datenschutz und Betriebsgeheimnissen?", tip: ["DSGVO/BDSG beachten; Unterweisungen dokumentieren."] },
      { ref: "V15 – Kündigung", q: "Welche Kündigungsregeln gelten in und nach der Probezeit?", tip: ["Probezeit: jederzeit fristlos (§ 22 Abs. 1).", "Danach: fristlos aus wichtigem Grund oder mit Frist von 4 Wochen (Azubi)."] },
      { ref: "V16 – Schwangerschaft/Mutterschutz", q: "Welche Schutzregeln gelten bei Schwangerschaft in der Ausbildung?", tip: ["MuSchG: Schutzfristen, Beschäftigungsverbote, Kündigungsschutz."] },
      { ref: "V17 – Nachteilsausgleich", q: "Wie werden Auszubildende mit Behinderung in Prüfungen unterstützt?", tip: ["Nachteilsausgleich (Zeit, Hilfsmittel) auf Antrag; Chancengleichheit."] },
      { ref: "V18 – Ausland", q: "Sind Ausbildungsabschnitte im Ausland möglich und wie werden sie angerechnet?", tip: ["Ja; Ausbildungsziel wahren; bis zulässige Zeitanteile.", "§ 2 Abs. 3 BBiG."] },
      { ref: "V19 – Versetzung", q: "Darf der Betrieb Azubis versetzen?", tip: ["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten klären.", "§ 14 BBiG."] },
      { ref: "V20 – Insolvenz", q: "Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip: ["Fortführung/Anschlussbetrieb/IHK-Unterstützung; ggf. Insolvenzgeld."] }
    ];

    const LAW_INDEX = [
      { law: "BBiG", para: "§ 11", tags: ["vertrag", "inhalte", "mindestinhalte"], excerpt: "§ 11 BBiG – Niederschrift der wesentlichen Inhalte (u. a. Parteien, Beginn/Dauer, Ziel, sachliche/zeitliche Gliederung).", link: "https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law: "BBiG", para: "§ 20", tags: ["probezeit"], excerpt: "§ 20 BBiG – Probezeit mindestens 1, höchstens 4 Monate.", link: "https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law: "BBiG", para: "§ 15", tags: ["freistellung", "schule", "wegezeit"], excerpt: "§ 15 BBiG – Freistellung für Berufsschule/Prüfungen; Wegezeiten Schule→Betrieb sind anzurechnen.", link: "https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law: "BBiG", para: "§ 17", tags: ["vergütung", "miav"], excerpt: "§ 17 BBiG – Angemessene Vergütung; Mindestausbildungsvergütung als Untergrenze.", link: "https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" },
      { law: "JArbSchG", para: "§ 8–15", tags: ["arbeitszeit", "ruhezeit", "pausen"], excerpt: "JArbSchG – Tägliche und wöchentliche Höchstarbeitszeiten; Ruhepausen; Ruhezeit mind. 12 Std.", link: "https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" },
      { law: "ArbZG", para: "§ 3, § 4, § 5", tags: ["erwachsene", "arbeitszeit", "pausen", "ruhezeit"], excerpt: "ArbZG – 8 Std/Tag (bis 10 mit Ausgleich), Pausen 30–45 Min, Ruhezeit 11 Std.", link: "https://www.gesetze-im-internet.de/arbzg/ArbZG.pdf" },
    ];

    // === State ===
    let accepted = false;
    let pool = [...QUESTIONS_ALL];
    let answers = {};
    let selected = {};
    let rubrics = {};
    let bookmarks = JSON.parse(localStorage.getItem(BOOKMARK_KEY) || "{}");

    // === Theme ===
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.documentElement.classList.add("dark");
    }

    themeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      const isDark = document.documentElement.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      if (window.lucide) lucide.createIcons();
      if (rubricChart) updateSpiderChart();
    });

    // === Timer ===
    let startTs = Date.now();
    setInterval(() => {
      const s = Math.floor((Date.now() - startTs) / 1000);
      const m = String(Math.floor(s / 60)).padStart(2, "0");
      const r = String(s % 60).padStart(2, "0");
      timerEl.textContent = `${m}:${r}`;
    }, 1000);

    // === Toast ===
    function showToast(msg, duration = 3000) {
      toastEl.textContent = msg;
      toastEl.style.display = "block";
      setTimeout(() => {
        toastEl.style.display = "none";
      }, duration);
    }

    // === Disclaimer ===
    ackBtn.addEventListener("click", () => {
      if (!ack.checked) {
        showToast("❌ Bitte bestätige den Hinweis.");
        return;
      }
      accepted = true;
      notice.style.display = "none";
      renderQuiz();
    });

    // === Render Quiz ===
    function renderQuiz() {
      form.innerHTML = "";
      pool.forEach((item, idx) => {
        const isBookmarked = bookmarks[item.ref] || false;
        
        const card = document.createElement("div");
        card.className = "card question-card";
        card.innerHTML = `
          <button type="button" class="bookmark-btn ${isBookmarked ? 'active' : ''}" data-ref="${item.ref}" title="Markieren">
            <i data-lucide="bookmark" style="width: 16px; height: 16px;"></i>
          </button>
          
          <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 12px;">
            <span class="badge badge-primary">Frage ${idx + 1}</span>
            <h3 style="flex: 1; font-weight: 700; font-size: 14px;">${item.ref}</h3>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" class="sel-check" data-ref="${item.ref}" style="width: 16px; height: 16px; cursor: pointer;" />
              <span style="font-size: 11px; font-weight: 700; color: var(--text-muted);">Auswahl</span>
            </label>
          </div>
          
          <p style="font-size: 13px; margin-bottom: 12px; color: var(--text); line-height: 1.6;">${item.q}</p>
          
          <textarea 
            style="width: 100%;"
            rows="4"
            placeholder="Deine Antwort (max. ${MAX_ANSWER_CHARS} Zeichen)..."
            maxlength="${MAX_ANSWER_CHARS}"
            data-ref="${item.ref}"
          ></textarea>
          
          <div class="tip hidden" data-ref="${item.ref}">
            <details>
              <summary style="font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="info" style="width: 14px; height: 14px;"></i>
                Orientierungshilfe
              </summary>
              <div style="margin-top: 8px; font-size: 12px; line-height: 1.5;">
                ${item.tip.map(t => `<p style="margin-bottom: 4px;">• ${t}</p>`).join("")}
              </div>
            </details>
          </div>
          
          <div class="rubric-wrap hidden" data-ref="${item.ref}">
            <div class="rubric">
              <p style="font-size: 11px; font-weight: 700; margin-bottom: 8px; color: var(--text-muted);">KI-Rubriken-Score:</p>
              ${RUBRIC_KEYS.map(k => `
                <div style="margin-bottom: 8px;">
                  <div style="display: flex; justify-between; font-size: 11px; font-weight: 700; margin-bottom: 4px; color: var(--text-muted);">
                    <span>${k === 'normbezug' ? '📚 Normbezug' : k === 'vollstaendigkeit' ? '✅ Vollständigkeit' : '🎯 Praxisbezug'}</span>
                    <span class="rubric-val" data-ref="${item.ref}" data-key="${k}">—</span>
                  </div>
                  <div class="rubric-bar">
                    <div class="rubric-fill" data-ref="${item.ref}" data-key="${k}" style="width:0%;"></div>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
          
          <div class="feedback-wrap hidden" data-ref="${item.ref}">
            <p style="font-size: 11px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; color: var(--mf-primary);">
              <i data-lucide="message-square" style="width: 14px; height: 14px;"></i>
              KI-Feedback:
            </p>
            <div class="feedback-content" style="font-size: 13px; line-height: 1.6;"></div>
          </div>
        `;
        form.appendChild(card);
      });

      if (window.lucide) lucide.createIcons();

      // Bookmark buttons
      form.querySelectorAll(".bookmark-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const ref = btn.dataset.ref;
          bookmarks[ref] = !bookmarks[ref];
          if (!bookmarks[ref]) delete bookmarks[ref];
          localStorage.setItem(BOOKMARK_KEY, JSON.stringify(bookmarks));
          btn.classList.toggle("active", bookmarks[ref]);
          updateBookmarkCount();
          if (window.lucide) lucide.createIcons();
        });
      });

      // Textareas
      form.querySelectorAll("textarea[data-ref]").forEach(ta => {
        const r = ta.dataset.ref;
        ta.value = answers[r] || "";
        ta.addEventListener("input", () => {
          answers[r] = ta.value.trim();
          saveState();
          updateProgress();
        });
      });

      // Checkboxes
      form.querySelectorAll(".sel-check").forEach(cb => {
        const r = cb.dataset.ref;
        cb.checked = !!selected[r];
        cb.addEventListener("change", () => {
          selected[r] = cb.checked;
          updateProgress();
        });
      });

      updateProgress();
      updateBookmarkCount();
      restoreRubrics();
    }

    function updateProgress() {
      const total = pool.length;
      const answered = Object.values(answers).filter(a => a.length > 0).length;
      const selectedCount = Object.values(selected).filter(Boolean).length;
      
      progressBar.style.width = `${(answered / total) * 100}%`;
      progressTxt.textContent = `${answered} / ${total} beantwortet`;
      selText.textContent = `${selectedCount} ausgewählt`;
    }

    function updateBookmarkCount() {
      const count = Object.keys(bookmarks).length;
      if (count > 0) {
        bookmarkCount.textContent = count;
        bookmarkCount.style.display = "inline-flex";
      } else {
        bookmarkCount.style.display = "none";
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ answers, selected, rubrics }));
    }

    function restoreRubrics() {
      Object.entries(rubrics).forEach(([ref, r]) => {
        RUBRIC_KEYS.forEach(k => {
          const val = r[k] || 0;
          const valEl = document.querySelector(`.rubric-val[data-ref="${ref}"][data-key="${k}"]`);
          const fillEl = document.querySelector(`.rubric-fill[data-ref="${ref}"][data-key="${k}"]`);
          if (valEl) valEl.textContent = val.toFixed(1);
          if (fillEl) fillEl.style.width = `${(val / 2) * 100}%`;
        });
        const wrap = document.querySelector(`.rubric-wrap[data-ref="${ref}"]`);
        if (wrap) wrap.classList.remove("hidden");
      });
    }

    // === Spider Chart ===
    function updateSpiderChart() {
      const entries = Object.entries(rubrics);
      if (entries.length === 0) {
        chartSection.style.display = "none";
        return;
      }

      const avgRubric = entries.reduce((acc, [ref, r]) => {
        acc.normbezug += r.normbezug || 0;
        acc.vollstaendigkeit += r.vollstaendigkeit || 0;
        acc.praxisbezug += r.praxisbezug || 0;
        acc.count++;
        return acc;
      }, { normbezug: 0, vollstaendigkeit: 0, praxisbezug: 0, count: 0 });

      const count = avgRubric.count || 1;
      chartSection.style.display = "block";

      const isDark = document.documentElement.classList.contains('dark');
      const textColor = isDark ? '#FFFFFF' : '#0F1111';
      const gridColor = isDark ? '#3A4553' : '#D5D9D9';

      if (rubricChart) rubricChart.destroy();

      rubricChart = new Chart(rubricChartCanvas, {
        type: 'radar',
        data: {
          labels: ['Normbezug', 'Vollständigkeit', 'Praxisbezug'],
          datasets: [{
            label: 'Durchschnitt',
            data: [
              (avgRubric.normbezug / count).toFixed(1),
              (avgRubric.vollstaendigkeit / count).toFixed(1),
              (avgRubric.praxisbezug / count).toFixed(1)
            ],
            backgroundColor: 'rgba(0, 94, 184, 0.15)',
            borderColor: '#005EB8',
            borderWidth: 2,
            pointBackgroundColor: '#005EB8',
            pointBorderColor: '#fff',
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 2,
              ticks: {
                stepSize: 0.5,
                color: textColor,
                backdropColor: 'transparent',
                font: { size: 11, weight: '600' }
              },
              grid: { color: gridColor, lineWidth: 1 },
              pointLabels: {
                color: textColor,
                font: { size: 12, weight: '700' }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: isDark ? '#1C2531' : '#FFFFFF',
              titleColor: textColor,
              bodyColor: textColor,
              borderColor: gridColor,
              borderWidth: 1,
              padding: 12
            }
          }
        }
      });
    }

    // === Submit ===
    submitBtn.addEventListener("click", async () => {
      const selectedRefs = Object.keys(selected).filter(r => selected[r]);
      if (selectedRefs.length === 0) {
        showToast("❌ Bitte wähle mindestens eine Frage aus.");
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i data-lucide="loader" class="animate-spin" style="width:16px;height:16px;"></i> Analysiere...';
      if (window.lucide) lucide.createIcons();

      const payload = selectedRefs.map(ref => {
        const q = pool.find(item => item.ref === ref);
        return { question: q.q, answer: answers[ref] || "", ref: q.ref };
      });

      try {
        const res = await fetch(relay, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ questions: payload })
        });

        if (!res.ok) throw new Error("API-Fehler");

        const data = await res.json();
        
        // Process individual feedback
        if (data.results) {
          data.results.forEach(item => {
            const { ref, feedback, rubric } = item;
            
            // Feedback
            const feedbackWrap = document.querySelector(`.feedback-wrap[data-ref="${ref}"]`);
            if (feedbackWrap) {
              feedbackWrap.classList.remove("hidden");
              const feedbackContent = feedbackWrap.querySelector(".feedback-content");
              if (feedbackContent) {
                feedbackContent.innerHTML = window.marked ? marked.parse(feedback || "Keine Rückmeldung.") : (feedback || "Keine Rückmeldung.");
              }
            }

            // Rubrics
            if (rubric) {
              rubrics[ref] = rubric;
              RUBRIC_KEYS.forEach(k => {
                const val = rubric[k] || 0;
                const valEl = document.querySelector(`.rubric-val[data-ref="${ref}"][data-key="${k}"]`);
                const fillEl = document.querySelector(`.rubric-fill[data-ref="${ref}"][data-key="${k}"]`);
                if (valEl) valEl.textContent = val.toFixed(1);
                if (fillEl) fillEl.style.width = `${(val / 2) * 100}%`;
              });
              const wrap = document.querySelector(`.rubric-wrap[data-ref="${ref}"]`);
              if (wrap) wrap.classList.remove("hidden");
            }

            // Tip
            const tipEl = document.querySelector(`.tip[data-ref="${ref}"]
