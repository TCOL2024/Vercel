<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz – Kompaktfragen (IHK-Niveau)</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Markdown -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --surface:#ffffff; --surface-2:#f6f8fb; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --brand:#0ea5e9; --brand-2:#2563eb; --ok:#10b981; --warn:#f59e0b;
      --radius:14px; --radius-sm:10px; --shadow-1:0 8px 28px rgba(2,8,23,.06);
    }
    @media (prefers-color-scheme: dark){
      html{ color-scheme: dark; }
      body{ background: linear-gradient(to bottom, #0b1220, #0b1220 40%, #111827 100%); }
      :root{ --surface:#0f172a; --surface-2:#0b1327; --ink:#e5e7eb; --muted:#9aa6b2; --border:#1f2937; }
    }
    body{ background: linear-gradient(to bottom, #fff, #f4f7fb); color: var(--ink); }
    .container{ max-width: 1100px; margin-inline: auto; padding-inline: 1rem; }
    .card{ background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-1); }
    .chip{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:var(--surface-2); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.7rem 1rem; border-radius: var(--radius-sm); border:1px solid var(--border); background: var(--surface); color: var(--ink); touch-action: manipulation; }
    .btn:hover{ background:#f8fafc; }
    .btn-primary{ border-color:transparent; background:linear-gradient(180deg, var(--brand), var(--brand-2)); color:#fff; }
    .btn-primary:hover{ filter:brightness(0.98); }
    .btn-ghost{ background:transparent; }
    .btn-lg{ padding:.95rem 1.1rem; border-radius:12px; }
    .btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--brand) 50%, transparent); outline-offset:2px; }

    .q-badge{ background: color-mix(in oklab, var(--brand) 18%, #eaf6ff 82%); color: color-mix(in oklab, var(--brand) 80%, #0b3b52 20%); }
    .progress-outer{ height:10px; border-radius:999px; background:#eaeef4; overflow:hidden; }
    .progress-inner{ height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg, var(--brand), var(--ok)); transition:width .25s; }
    .tip > div{ border-left:3px solid var(--brand); background:#f0f9ff; color:#0b3b52; border-radius:12px; padding:.75rem .85rem; }
    @media (prefers-color-scheme:dark){ .tip > div{ background:rgba(14,165,233,.08); color:#cce9fb; } }
    details[open] summary .chev{ transform:rotate(180deg); }
    summary{ list-style:none; }

    /* Disclaimer */
    .notice{ background:linear-gradient(135deg, #e0f2fe, #dbeafe); border-bottom:1px solid rgba(2,8,23,.08); }
    .notice .inner{ backdrop-filter:blur(6px); }

    /* Tabs – Laschenoptik (Amazon Nova inspiriert) */
    .tabs-wrap{ background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-1); border:1px solid var(--border); }
    .tabs-strip{ position:relative; display:flex; gap:.25rem; overflow:auto; scrollbar-width:none; padding:.35rem; }
    .tabs-strip::-webkit-scrollbar{ display:none; }
    .tab{
      position:relative; white-space:nowrap; padding:.65rem 1rem; border-radius: 12px 12px 0 0;
      border:1px solid transparent; background:transparent; font-weight:600; font-size:.95rem; color:#334155;
    }
    .tab .sub{ font-weight:500; color:var(--muted); font-size:.8rem; margin-left:.35rem; }
    .tab[aria-selected="true"]{
      background: #fff; color:#0b3b52; border-color: var(--border); border-bottom-color: transparent;
      box-shadow: 0 -1px 0 #fff inset, 0 2px 0 #ffffff;
    }
    .tabs-bottom{
      border-top:1px solid var(--border); background:#fff; padding:.5rem .8rem; border-radius:0 12px 12px 12px;
      display:flex; align-items:center; gap:.75rem; color:#475569; font-size:.85rem;
    }
    .badge-on{ background: #ecfeff; color:#0369a1; border:1px solid #bae6fd; border-radius:999px; padding:2px 8px; font-size:.75rem; }
    .badge-count{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; border-radius:999px; padding:2px 8px; font-size:.75rem; }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; z-index:98; }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:99; }
    .modal .panel{ width:100%; max-width:720px; border-radius:1rem; }
    .modal.open, .modal-backdrop.open{ display:flex; }

    /* Safe area */
    .safe-bottom{ padding-bottom:max(env(safe-area-inset-bottom),12px); }

    /* Print */
    @media print{
      .sticky, .sticky-actions, #notice, #openAsk, #openAskMobile { display:none!important; }
      body{ background:#fff!important; }
      .card{ box-shadow:none!important; border:1px solid #ddd; }
      footer{ position:fixed; bottom:10mm; left:0; right:0; }
    }
    footer.app-footer{ font-family:Arial, Helvetica, sans-serif; font-size:10px; line-height:1.4; }
  </style>
</head>
<body class="min-h-screen antialiased">

  <!-- Disclaimer -->
  <aside id="notice" class="notice sticky top-0 z-50">
    <div class="inner container px-4 py-3 sm:py-3.5 flex items-start gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-100 grid place-items-center shrink-0">
        <i data-lucide="shield-check" class="w-6 h-6 text-sky-700"></i>
      </div>
      <div class="text-sm leading-snug">
        <p class="font-semibold text-sky-900">Fachlicher Hinweis (Pilot)</p>
        <p class="text-sky-900/90">
          Die KI-Prüfung unterstützt beim Lernen. Ergebnisse müssen fachlich geprüft werden und ersetzen keine Rechtsberatung.
          <strong>Es dürfen keine personenbezogenen oder sensiblen Daten eingegeben oder erfasst werden.</strong>
        </p>
        <label class="mt-2 inline-flex items-center gap-2">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-sky-600" aria-describedby="ackDesc">
          <span id="ackDesc" class="text-sky-950">Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <span id="ackState" class="chip">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn">Weiter</button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="container px-4 pt-4">
    <div class="flex items-center gap-3">
      <div class="w-11 h-11 rounded-2xl bg-sky-100 grid place-items-center">
        <i data-lucide="graduation-cap" class="w-6 h-6 stroke-[1.6] text-sky-700"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight truncate">BBiG-Quiz – Kompaktfragen</h1>
        <p class="text-sm text-slate-500">80 Fragen in Clustern. KI-Feedback gezielt auswählen. Autosave.</p>
      </div>
      <button id="openAsk" type="button" class="hidden sm:inline-flex btn btn-primary">
        <i data-lucide="message-square" class="w-4 h-4"></i> Eigene Frage
      </button>
    </div>

    <!-- Tabs / Laschen -->
    <section class="mt-3 tabs-wrap">
      <div id="tabsStrip" class="tabs-strip" role="tablist" aria-label="Frage-Cluster">
        <!-- Tabs via JS -->
      </div>
      <div class="tabs-bottom">
        <span id="banksMeta" class="badge-on">Aktive Banken: 1</span>
        <span id="countMeta" class="badge-count">Fragen im Formular: 20</span>
        <span class="hidden sm:inline text-slate-500">• Tipp: Klicke eine Lasche, um eine Bank ein-/auszuschalten.</span>
      </div>
    </section>
  </header>

  <!-- Progress -->
  <section class="container px-4 mt-4" aria-labelledby="progh">
    <div class="card p-4">
      <div class="flex items-center gap-3">
        <i data-lucide="target" class="w-5 h-5 text-sky-700"></i>
        <div class="flex-1">
          <div class="flex justify-between text-xs text-slate-600 mb-1">
            <span id="progressText">0 / 20 beantwortet</span>
            <span id="selText">0 ausgewählt</span>
          </div>
          <div class="progress-outer" role="progressbar" aria-valuemin="0" aria-valuemax="80" aria-valuenow="0" aria-labelledby="progh">
            <div id="progressBar" class="progress-inner"></div>
          </div>
          <span id="progh" class="sr-only">Beantwortete Fragen</span>
        </div>
        <time id="timer" class="text-xs text-slate-500 ml-3" aria-live="polite">00:00</time>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container px-4 py-4">
    <form id="form" class="grid gap-4 sm:gap-5" novalidate aria-describedby="formhint"></form>
    <p id="formhint" class="sr-only">Mit Strg/⌘+Enter kannst du das KI-Gesamt-Feedback abrufen.</p>

    <section id="resultWrap" class="mt-5 hidden" aria-live="polite">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkle" class="w-5 h-5 text-emerald-700"></i>
          <h2 class="text-base font-semibold">KI-Feedback</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky Action-Bar -->
  <div class="sticky-actions sticky bottom-0 bg-white/95 border-t border-slate-200 backdrop-blur safe-bottom">
    <div class="container px-4 py-2 flex flex-wrap gap-2">
      <button id="openAskMobile" type="button" class="sm:hidden flex-1 btn btn-ghost">
        <i data-lucide="message-square" class="w-5 h-5"></i> Eigene Frage
      </button>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg flex-1 sm:flex-none">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback für Auswahl
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">Zurücksetzen</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite" style="display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:100;"></div>

  <!-- Modal: Eigene Frage -->
  <div id="askBackdrop" class="modal-backdrop"></div>
  <div id="askModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="askTitle" aria-describedby="askDesc">
    <div class="panel card p-4 sm:p-5" role="document">
      <div class="flex items-start gap-2">
        <div class="w-10 h-10 rounded-xl bg-sky-100 grid place-items-center">
          <i data-lucide="message-square" class="w-5 h-5 text-sky-700"></i>
        </div>
        <div class="flex-1">
          <h3 id="askTitle" class="text-base font-semibold">Eigene Frage an die KI</h3>
          <p id="askDesc" class="text-sm text-slate-500">Formuliere eine Frage. (Optional: mit Bezug auf eine Frage-Nr.)</p>
        </div>
        <button id="askClose" type="button" class="btn" aria-label="Fenster schließen" data-close>
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="mt-3">
        <label for="askText" class="sr-only">Deine Frage</label>
        <textarea id="askText" rows="5" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]" placeholder="Deine Frage …"></textarea>
      </div>
      <div class="mt-3 flex flex-wrap gap-2 justify-end">
        <button id="askSend" type="button" class="btn btn-primary">
          <i data-lucide="send" class="w-5 h-5"></i> Senden
        </button>
        <button type="button" class="btn" data-close>Schließen</button>
      </div>
      <div id="askResult" class="mt-3 hidden prose prose-slate text-sm max-w-none"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer bg-slate-100 text-slate-700">
    <div class="container px-4 py-4">
      Diese Anwendung nutzt künstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antwort von OpenAI verarbeitet und geprüft werden.
      Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbräuchlich verwendet werden.
      Es dürfen keine personenbezogenen Daten, sensiblen Daten oder Daten erfasst werden, die Rückschlüsse auf eine Person, zum Beispiel Auszubildenden,
      Ausbilder oder ähnliche Personen ermöglichen. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind vom Anwender zu prüfen.
      KI-generierte Antworten können fehlerhaft sein. Keine Haftung.
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // === Konfiguration ===
    const relay = "/api/linda-proxy";
    const BATCH_SIZE = 5;
    const MAX_ANSWER_CHARS = 1500;
    const STORAGE_KEY = "BBIGQUIZ_V4_STATE";

    // UI-Refs
    const form = document.getElementById("form");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const resultWrap = document.getElementById("resultWrap");
    const aiResult = document.getElementById("aiResult");
    const timerEl = document.getElementById("timer");
    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");
    const toastEl = document.getElementById("toast");
    const tabsStrip = document.getElementById("tabsStrip");

    // Modal
    const askBackdrop  = document.getElementById("askBackdrop");
    const askModal     = document.getElementById("askModal");
    const askClose     = document.getElementById("askClose");
    const askSend      = document.getElementById("askSend");
    const askText      = document.getElementById("askText");
    const askResult    = document.getElementById("askResult");
    const openAsk      = document.getElementById("openAsk");
    const openAskMobile= document.getElementById("openAskMobile");

    const banksMetaEl = document.getElementById("banksMeta");
    const countMetaEl = document.getElementById("countMeta");

    if (window.marked) marked.setOptions({ breaks:true, gfm:true });
    if (window.lucide) lucide.createIcons();

    // Timer
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    },1000);

    // === Fragenbanken (80) ===
    const BANK_CORE = [
      { ref:"V1 – Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehören.", tip:[
        "Typisch: Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung, Vergütung, Probezeit, Urlaub, tägliche Ausbildungszeit, Kündigung, Hinweise auf Tarif/BV, Form des Ausbildungsnachweises.",
        "§ 11 BBiG; Textform/elektronisch zulässig."
      ]},
      { ref:"V2 – Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:[
        "Berufsbild, Dauer/Ausbildungsrahmenplan, Prüfungen.","§§ 4–5 BBiG."
      ]},
      { ref:"V3 – Probezeit", q:"Wie lang muss/darf die Probezeit sein – und warum ist sie wichtig?", tip:[
        "Mind. 1, max. 4 Monate; Eignungsprüfung beider Seiten.","§ 20 BBiG."
      ]},
      { ref:"V4 – Minderjährige: Unterschrift", q:"Wer unterschreibt den Vertrag bei Minderjährigen mit gemeinsamem Sorgerecht?", tip:[
        "Beide Sorgeberechtigte + Minderjährige/r.","§ 10 BBiG; §§ 1626, 1629 BGB."
      ]},
      { ref:"V5 – Berufsschulzeit & Arbeitszeit", q:"Wie werden Berufsschulzeiten auf die Arbeitszeit angerechnet (U18 vs. ≥18)?", tip:[
        "U18: besondere Anrechnung (JArbSchG).","Wegezeiten Schule→Betrieb anrechenbar (§ 15 Abs. 2 Nr. 1 BBiG).","≥18: ArbZG; Freistellung nach § 15 BBiG."
      ]},
      { ref:"V6 – Ruhezeit Jugendliche", q:"Welche tägliche Mindestruhezeit gilt für Jugendliche?", tip:["Mindestens 12 Stunden.","JArbSchG."]},
      { ref:"V7 – Vergütung", q:"Was gilt zur Angemessenheit der Ausbildungsvergütung?", tip:[
        "MiAV als Untergrenze; tariflich/branchenüblich; Steigerung je Jahr.","§ 17 BBiG."
      ]},
      { ref:"V8 – Überstunden", q:"Sind Überstunden zulässig – und wie werden sie behandelt?", tip:[
        "Nur ausbildungsdienlich; Vergütung/Zeitausgleich; Jugendarbeitsschutz beachten.","ArbZG/JArbSchG; BBiG."
      ]},
      { ref:"V9 – Betrieblicher Ausbildungsplan", q:"Wozu dient der betriebliche Ausbildungsplan?", tip:[
        "Umsetzung Rahmenplan, zeitl./sachl. Gliederung, Qualitätssicherung.","§ 5 BBiG; Verweis § 11 Abs. 1 S. 2."
      ]},
      { ref:"V10 – Berichtsheft", q:"Welche Bedeutung hat das Berichtsheft und wer kontrolliert es?", tip:[
        "Zulassungsvoraussetzung; elektronisch möglich; Kontrolle Ausbilder/in.","§ 13 Nr.7, § 14 BBiG."
      ]},
      { ref:"V11 – Verkürzung", q:"Wann kann die Ausbildungsdauer verkürzt werden?", tip:["Vorbildung/Leistung/Anrechnung; Einvernehmen nötig.","§ 8 BBiG."]},
      { ref:"V12 – Verlängerung", q:"Wann kommt eine Verlängerung in Betracht?", tip:["Nichtbestehen oder besondere Fälle.","§ 8 Abs. 2 BBiG."]},
      { ref:"V13 – Teilzeitberufsausbildung", q:"Wie funktioniert Teilzeit in der Ausbildung und was bleibt unverändert?", tip:["Reduzierte Zeiten, Lernziel bleibt; evtl. längere Gesamtdauer.","§ 7a BBiG."]},
      { ref:"V14 – Datenschutz/Geheimnis", q:"Welche Pflichten haben Azubis zu Datenschutz und Betriebsgeheimnissen?", tip:["DSGVO/BDSG beachten; Unterweisungen dokumentieren."]},
      { ref:"V15 – Kündigung", q:"Welche Kündigungsregeln gelten in und nach der Probezeit?", tip:[
        "Probezeit: jederzeit fristlos (§ 22 Abs. 1).","Danach: fristlos aus wichtigem Grund oder mit Frist (Berufsaufgabe/Wechsel) – schriftlich, Gründe nennen (§ 22)."
      ]},
      { ref:"V16 – Schwangerschaft/Mutterschutz", q:"Welche Schutzregeln gelten bei Schwangerschaft in der Ausbildung?", tip:["MuSchG: Schutzfristen, Beschäftigungsverbote, Kündigungsschutz."]},
      { ref:"V17 – Nachteilsausgleich", q:"Wie werden Auszubildende mit Behinderung in Prüfungen unterstützt?", tip:["Nachteilsausgleich (Zeit, Hilfsmittel) auf Antrag; Chancengleichheit."]},
      { ref:"V18 – Ausland", q:"Sind Ausbildungsabschnitte im Ausland möglich und wie werden sie angerechnet?", tip:["Ja; Ausbildungsziel wahren; bis zul. Zeitanteile.","§ 2 Abs. 3 BBiG."]},
      { ref:"V19 – Versetzung", q:"Darf der Betrieb Azubis versetzen?", tip:["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten klären.","§ 14 BBiG."]},
      { ref:"V20 – Insolvenz", q:"Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip:["Fortführung/Anschlussbetrieb/IHK-Unterstützung; ggf. Insolvenzgeld."]}
    ];

    const BANK_BASICS = [
      { ref:"G1 – Jugendberufsagentur", q:"Was ist die Aufgabe einer Jugendberufsagentur und wer kooperiert dort?", tip:["Unter 25 unterstützen; Bündelung AA/Jobcenter/Kommunen/Schulen."]},
      { ref:"G2 – Nutzen Ausbildung", q:"Nenne drei Argumente, warum sich Ausbildung für Betriebe lohnt.", tip:["Fachkräfte, Flexibilität, Innovation/Kommunikation."]},
      { ref:"G3 – Personalplanung", q:"Welche Dimensionen der Personalbedarfsplanung sind relevant?", tip:["Quantitativ, qualitativ, zeitlich."]},
      { ref:"G4 – Recruiting-Kanäle", q:"Nenne vier Wege, um Auszubildende zu finden.", tip:["Schule/Agentur, Social Media, Messen, Mitarbeitende werben Azubis."]},
      { ref:"G5 – Kennenlernprozess", q:"Welche Elemente umfasst ein typischer Auswahlprozess für Azubis?", tip:["Bewerbung, Screening, Gespräch/Test, Entscheidung."]},
      { ref:"G6 – Motivation Bewerber", q:"Nenne drei mögliche Motive von Bewerbenden für eine Ausbildung.", tip:["Interesse/Berufseinstieg, finanzielle Gründe, Eltern/Tradition."]},
      { ref:"G7 – Anforderungsprofil", q:"Welche drei Kompetenzfelder sind beim Anforderungsprofil zentral?", tip:["Fachlich, sozial, persönlich."]},
      { ref:"G8 – Eignungsfeststellung", q:"Wie kann die Eignung vor und in der Probezeit festgestellt werden?", tip:["Zeugnisse, Gespräche/Tests, Beobachtung in Probezeit."]},
      { ref:"G9 – Nachhaltigkeit", q:"Wie ist Nachhaltigkeit in der Ausbildung verankert (kurz)?", tip:["Lernziele/Handlungsfelder; Projekte/Modelle; Rolle der Ausbilder."]},
      { ref:"G10 – SDGs", q:"Was sind die 17 SDGs und wozu dienen sie in der Ausbildung?", tip:["Globale Ziele; Orientierung für nachhaltiges Handeln."]}
    ];

    const BANK_RECHT_EINSTIEG = [
      { ref:"R1 – Art. 12 GG", q:"Was garantiert Art. 12 GG in Bezug auf Beruf, Arbeitsplatz und Ausbildungsstätte?", tip:["Freie Wahl; Einschränkbar durch Gesetz."]},
      { ref:"R2 – AGG Ziel", q:"Was ist das Ziel des AGG (§1) im Kontext der Ausbildung?", tip:["Benachteiligungen verhindern/beseitigen."]},
      { ref:"R3 – AGG Bereich", q:"Nenne einen Anwendungsbereich des AGG nach §2, der Ausbildung betrifft.", tip:["Zugang zu Berufsbildung/Berufsausbildung."]},
      { ref:"R4 – §1 BBiG", q:"Welche vier Säulen der Berufsbildung nennt §1 BBiG?", tip:["Vorbereitung, Ausbildung, Fortbildung, Umschulung."]},
      { ref:"R5 – BvB", q:"Was ist Zweck der Berufsausbildungsvorbereitung (BvB)?", tip:["Heranführung an Ausbildung; Grundlagen berufl. Handlungsfähigkeit."]},
      { ref:"R6 – EQ", q:"Was ist die Einstiegsqualifizierung (EQ) und wer wird gefördert?", tip:["Langzeitpraktikum nach SGB III; junge Bewerbende, ggf. Geflüchtete."]},
      { ref:"R7 – MiAV", q:"Wie wirkt die Mindestausbildungsvergütung (§17 BBiG) mit Tarifverträgen zusammen?", tip:["MiAV Untergrenze; Tarif bleibt maßgeblich; Angemessenheit."]},
      { ref:"R8 – Tarif & Günstigkeit", q:"Was bedeutet das Günstigkeitsprinzip im Verhältnis Vertrag/Tarif?", tip:["Abweichungen nur zugunsten der Beschäftigten."]},
      { ref:"R9 – Ausbildungsnachweis", q:"Welche Rolle spielt der Ausbildungsnachweis im Zulassungsverfahren?", tip:["Kann angefordert werden; fehlend kann ausschließen."]},
      { ref:"R10 – Digitale Ausbildung", q:"Welche Aussage trifft §28 BBiG zur (auch digitalen) Durchführung?", tip:["Eignung der Ausbildungsstätte/Person; moderne Formen zulässig."]}
    ];

    const BANK_ARBEITSZEIT_URLAUB = [
      { ref:"A1 – U18 Arbeitszeit", q:"Wie lauten Wochen-/Tagesgrenzen der Arbeitszeit für Jugendliche?", tip:["Max 40 h/Woche, 8 h/Tag (Ausnahmen beachten)."]},
      { ref:"A2 – U18 Ruhepausen", q:"Welche Pausen sind für Jugendliche einzuhalten?", tip:[">4,5–6 h: 30 Min; >6 h: 60 Min; min. 15-Min-Blöcke."]},
      { ref:"A3 – U18 Ruhezeit", q:"Wie lang ist die tägliche Freizeit (Ruhezeit) für Jugendliche?", tip:["Mindestens 12 Stunden."]},
      { ref:"A4 – U18 Sonn-/Feiertag", q:"Was gilt für Sonn-/Feiertagsbeschäftigung Jugendlicher grob?", tip:["Grundsatz Verbot; Ausnahmen; 2 freie Sonntage/Monat."]},
      { ref:"A5 – ≥18 Arbeitszeit", q:"Nenne Grund- und Höchstarbeitszeit nach ArbZG.", tip:["8 h/Tag, bis 10 h mit Ausgleich; max 48 h/Woche."]},
      { ref:"A6 – ≥18 Pausen/Ruhezeit", q:"Welche Pausen und Ruhezeit gelten für Erwachsene?", tip:["6–9 h: 30 Min; >9 h: 45 Min; Ruhezeit 11 h."]},
      { ref:"A7 – Mehrarbeit Doku", q:"Welche Mehrarbeit ist zu protokollieren und wie lange?", tip:[">8 h/Tag dokumentieren; 2 Jahre aufbewahren (§16 ArbZG)."]},
      { ref:"A8 – Urlaub BUrlG", q:"Wie rechnet sich der Mindesturlaub bei 5-Tage-Woche?", tip:["Mindestens 20 Arbeitstage (=4 Wochen)."]},
      { ref:"A9 – Urlaub U18", q:"Wie hoch ist der Mindesturlaub für Jugendliche je Alter (Kurzüberblick)?", tip:["u16:30 WT (~25 AT), u17:27, u18:25; ab 18:24 WT (~20 AT)."]},
      { ref:"A10 – §15 BBiG", q:"Was bedeutet Freistellung nach §15 BBiG (zwei Beispiele)?", tip:["Unterricht/Prüfungen; Anrechnung inkl. Wegezeiten."]}
    ];

    const BANK_ORGA_PLANUNG = [
      { ref:"O1 – Vollständige Handlung", q:"Welche sechs Schritte umfasst das Modell der vollständigen Handlung?", tip:["Informieren, Planen, Entscheiden, Ausführen, Kontrollieren, Bewerten."]},
      { ref:"O2 – Lernzielebenen", q:"Unterscheide Richt-, Grob- und Feinlernziel kurz.", tip:["Richt: Gebiet; Grob: Fähigkeit; Fein: Teilziel/operationalisiert."]},
      { ref:"O3 – Ausbildungsplan sachlich", q:"Nenne drei Kriterien der sachlichen Gliederung.", tip:["Einheiten/Abteilungen, Überschaubarkeit, Probezeit nutzbar."]},
      { ref:"O4 – Ausbildungsplan zeitlich", q:"Nenne drei Kriterien der zeitlichen Gliederung.", tip:["Prüfungstermine, Reihenfolge Rahmenplan, Block-/Urlaub berücksichtigen."]},
      { ref:"O5 – Nachweis/Gliederung", q:"Welche Pflichten zu Gliederung und Nachweis nennt §11/§13/§14 BBiG?", tip:["Gliederung schriftl./Textform; Nachweis führen; Ausbildende halten an."]},
      { ref:"O6 – Versetzungsplan", q:"Wie unterstützt der betriebliche Plan die Versetzung/Abteilungsdurchläufe?", tip:["Zeitlich-sachliche Steuerung; Lernziele/Stationen."]},
      { ref:"O7 – Digitale Tools", q:"Nenne zwei Vorteile digitaler Berichtshefte/Planungs-Tools.", tip:["Transparenz, Nachverfolgbarkeit/Feedback."]},
      { ref:"O8 – Qualität", q:"Wie kann Ausbildungsqualität im Betrieb praktisch überprüft werden?", tip:["Zwischengespräche, Zielabgleich, Nachweise/Prüfungsvorbereitung."]}
    ];

    const BANK_BETEILIGTE_EIGNUNG = [
      { ref:"B1 – Beteiligte", q:"Wer sind die zentralen Beteiligten in der Ausbildung?", tip:["Ausbildende, Ausbilder/in, Beauftragte, Azubis, IHK, ggf. Eltern."]},
      { ref:"B2 – Eignung Ausbildungsstätte", q:"Nenne drei Voraussetzungen der Eignung der Ausbildungsstätte.", tip:["Ausstattung, Plan/Rahmenplan, ausreichende Plätze/Schutz."]},
      { ref:"B3 – Fachkraftbegriff", q:"Wer gilt als Fachkraft im Sinne der Relation?", tip:["Ausbildende/Ausbilder, Berufsabschluss oder 2x Ausbildungszeit tätig."]},
      { ref:"B4 – Relation", q:"Gib die Relation Fachkräfte zu Azubis schematisch wieder.", tip:["1–2:1; 3–5:2; 6–8:3; je +3 FK: +1 Azubi (Ausnahme möglich)."]},
      { ref:"B5 – Ausbildende Rolle", q:"Welche Pflichten treffen Ausbildende nach §14 BBiG?", tip:["Vermittlung Lernziele, Schutz, Freistellung, Zeugnis etc."]},
      { ref:"B6 – Ausbilder Rolle", q:"Kernaufgaben der Ausbilder/innen?", tip:["Planung, Durchführung, Kontrolle; Coaching/Erziehen."]},
      { ref:"B7 – Beauftragte Rolle", q:"Was machen Ausbildungsbeauftragte?", tip:["Teilqualifikationen vermitteln; §28(3) beachten."]},
      { ref:"B8 – Persönliche Eignung", q:"Wann fehlt persönliche Eignung als Ausbilder/in (Beispiel)?", tip:["Wiederholte JArbSchG-Verstöße etc. (§29 BBiG i.V.m. BetrVG §98)."]}
    ];

    const BANK_MITBESTIMMUNG = [
      { ref:"M1 – BR Rechte", q:"Nenne zwei Mitwirkungs-/Mitbestimmungsrechte des Betriebsrats in der Berufsbildung.", tip:["§96 Beratungsrecht; §98 Mitbestimmung/Bestellung."]},
      { ref:"M2 – §87 BetrVG", q:"Für welche Themen besteht nach §87 BetrVG Mitbestimmung?", tip:["Arbeitszeit, Ordnung, Vergütungssysteme, IT-Einführung etc."]},
      { ref:"M3 – Einstellung Azubis", q:"Wie ist der BR bei Einstellungen einzubeziehen?", tip:["§99 BetrVG: unterrichten, Unterlagen, Zustimmung einholen."]},
      { ref:"M4 – JAV Aufgabe", q:"Welche zwei Hauptaufgaben hat die JAV?", tip:["Überwachung zugunsten Jugend/Azubis; Verbesserungen anstoßen."]},
      { ref:"M5 – JAV Wahl", q:"Wer ist wahlberechtigt / wählbar (Kurzüberblick)?", tip:["Jugendliche u18 + Azubis; wählbar <25 J.; BR-Mitglieder ausgeschlossen."]},
      { ref:"M6 – JAV Größe", q:"Wovon hängt die Größe der JAV ab?", tip:["Zahl der Wahlberechtigten (§62 BetrVG)."]},
      { ref:"M7 – BR Widerspruch", q:"Wann kann der BR der Bestellung eines Ausbilders widersprechen?", tip:["Fehlende persönliche/fachliche Eignung (§98 Abs.2)."]},
      { ref:"M8 – Einigungsstelle", q:"Was passiert bei fehlender Einigung in mitbestimmungspflichtigen Fragen?", tip:["Einigungsstelle entscheidet."]}
    ];

    const BANK_PRUEFUNG = [
      { ref:"P1 – Zwischenprüfung", q:"Wozu dient die Zwischenprüfung (§48 BBiG)?", tip:["Ermittlung Wissensstand; Voraussetzung für Zulassung (§43)."]},
      { ref:"P2 – Ausbildungsende", q:"Wann endet das Ausbildungsverhältnis nach §21 BBiG?", tip:["Mit Ablauf der Zeit oder mit Bekanntgabe bestandener Prüfung."]},
      { ref:"P3 – Zulassung", q:"Welche Rolle hat der Ausbildungsnachweis für die Prüfungszulassung?", tip:["Kann angefordert werden; fehlend kann ausschließen."]},
      { ref:"P4 – Nachteilsausgleich Prüfung", q:"Beispielhafte Nachteilsausgleiche in Prüfungen?", tip:["Zeitverlängerung, Hilfsmittel, angepasste Aufgabenform."]},
      { ref:"P5 – Prüfungsrecht Basics", q:"Welche Prinzipien sollte ein PA beachten (kurz)?", tip:["Rechtsgrundlagen, Gleichbehandlung, Verhältnismäßigkeit."]},
      { ref:"P6 – Freistellung Prüfung", q:"Welche Freistellungen nennt §15 BBiG im Prüfungszusammenhang?", tip:["Prüfungsteilnahme; Vortag der schriftlichen Abschlussprüfung."]},
      { ref:"P7 – Wiederholung", q:"Ist eine Wiederholungsprüfung möglich und was ist zu beachten?", tip:["Ja; Verlängerung §8(2) möglich bis nächster Termin."]},
      { ref:"P8 – Dokumentation", q:"Welche Dokumente sollte der Betrieb zur Prüfungsvorbereitung bereithalten?", tip:["Ausbildungsplan, Nachweise, Beurteilungen, ggf. Berichtsheft."]}
    ];

    const BANK_DATENSCHUTZ_ETHIK = [
      { ref:"D1 – DSGVO Basics", q:"Welche Grundsätze der DSGVO sind im Ausbildungsalltag besonders wichtig?", tip:["Zweckbindung, Datenminimierung, Transparenz."]},
      { ref:"D2 – KI-Hinweis", q:"Welche Vorsichtsmaßnahme gilt bei Nutzung von KI-Tools im Betrieb?", tip:["Keine personenbezogenen/sensiblen Daten eingeben."]},
      { ref:"D3 – Betriebsgeheimnisse", q:"Wie gehen Azubis mit Betriebsgeheimnissen um?", tip:["Verschwiegenheit; Schulung/Verpflichtung."]},
      { ref:"D4 – Dokumentationspflichten", q:"Welche Dokumente unterstützen DSGVO-Compliance im Ausbildungsbereich?", tip:["Verarbeitungsverzeichnis, TOMs, Schulungsnachweise."]},
      { ref:"D5 – Foto/Video", q:"Was ist vor Veröffentlichung von Fotos/Clips mit Azubis zu beachten?", tip:["Einwilligung/Betroffenenrechte."]},
      { ref:"D6 – AGG im Recruiting", q:"Nenne zwei AGG-kritische Fehler in Stellenausschreibungen.", tip:["Diskriminierende Formulierungen (Alter/Geschlecht/Religion etc.)."]},
      { ref:"D7 – SoMe Screening", q:"Was ist beim Social-Media-Screening von Bewerbenden zu beachten?", tip:["Datenschutz/Erforderlichkeit/Transparenz."]},
      { ref:"D8 – Aufbewahrung Bewerbungen", q:"Wie lange dürfen abgelehnte Bewerbungen typischerweise aufbewahrt werden (Richtwert)?", tip:["i.d.R. 6 Monate (AGG-Fristen) – danach löschen."]}
    ];

    const BANK_BIBB_SYSTEM = [
      { ref:"S1 – BIBB Aufgabe", q:"Nenne zwei Aufgaben des BIBB.", tip:["Beratung, Forschung, Empfehlungen (§90 BBiG)."]},
      { ref:"S2 – Ausbildungsordnung Hoheit", q:"Wer erlässt Ausbildungsordnungen und worauf stützen sie sich?", tip:["Fachministerien auf Basis BBiG; BIBB wirkt mit."]},
      { ref:"S3 – Lernorte", q:"Welche Lernorte nennt §2 BBiG?", tip:["Betrieb, Schule, ggf. weitere."]},
      { ref:"S4 – Rahmenplan", q:"Welche Funktion hat der Ausbildungsrahmenplan?", tip:["Zeitlich-sachliche Struktur; Mindestinhalte."]},
      { ref:"S5 – Kammern", q:"Welche Rolle haben die Kammern in der Ausbildung (kurz)?", tip:["Zuständige Stelle: Eintragung, Beratung, Prüfungen."]},
      { ref:"S6 – Tarifbezug", q:"Wie kann ein nicht tarifgebundener Betrieb die Vergütung bestimmen?", tip:["Anlehnung an einschlägige Tarife/Empfehlungen; MiAV beachten."]},
      { ref:"S7 – Rechtsquellen AR", q:"Ordne die arbeitsrechtlichen Rechtsquellen grob (oben→unten).", tip:["EU/GG → Gesetze → Tarif → BV → Vertrag → Direktionsrecht."]},
      { ref:"S8 – Nebentätigkeit", q:"Welche verfassungsrechtliche Norm ist bei Nebentätigkeit tangiert?", tip:["Art. 12 GG (Berufsausübungsfreiheit)."]}
    ];

    const BANKS = [
      { key:"core",  title:"Kern",                 count:20, data:BANK_CORE, defaultActive:true  },
      { key:"bas",   title:"Grundlagen & Recruiting", count:10, data:BANK_BASICS, defaultActive:false },
      { key:"recht", title:"Recht – Einstieg/BBiG/AGG", count:10, data:BANK_RECHT_EINSTIEG, defaultActive:false },
      { key:"az",    title:"Arbeitszeit & Urlaub",  count:10, data:BANK_ARBEITSZEIT_URLAUB, defaultActive:false },
      { key:"orga",  title:"Organisation & Planung", count:8,  data:BANK_ORGA_PLANUNG, defaultActive:false },
      { key:"beteiligte", title:"Beteiligte & Eignung", count:8, data:BANK_BETEILIGTE_EIGNUNG, defaultActive:false },
      { key:"mitb",  title:"Mitbestimmung/BR/JAV", count:8,  data:BANK_MITBESTIMMUNG, defaultActive:false },
      { key:"pruef", title:"Prüfung",              count:8,  data:BANK_PRUEFUNG, defaultActive:false },
      { key:"ds",    title:"Datenschutz & Ethik",  count:8,  data:BANK_DATENSCHUTZ_ETHIK, defaultActive:false },
      { key:"sys",   title:"System/BIBB/Kammern",  count:8,  data:BANK_BIBB_SYSTEM, defaultActive:false }
    ];

    // Aktive Banken
    const activeBanks = new Set(BANKS.filter(b=>b.defaultActive).map(b=>b.key));

    // State (robust – per ref)
    let answersByRef = {};   // { ref: text }
    let selectedByRef = {};  // { ref: true/false }

    // Disclaimer
    let accepted = false;
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked){ showToast("Bitte die Checkbox bestätigen."); return; }
      accepted = true; notice.style.display = "none"; ackState.textContent = "Hinweis bestätigt"; ackState.className = "chip";
      saveState();
    });

    // Tabs rendern (Laschen)
    function renderTabs(){
      tabsStrip.innerHTML = "";
      BANKS.forEach((b, idx)=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tab";
        btn.setAttribute("role","tab");
        btn.setAttribute("aria-selected", activeBanks.has(b.key) ? "true" : "false");
        btn.innerHTML = `
          <span>${b.title}</span>
          <span class="sub">(${b.count})</span>
        `;
        btn.addEventListener("click", ()=>{
          if (activeBanks.has(b.key)) activeBanks.delete(b.key); else activeBanks.add(b.key);
          btn.setAttribute("aria-selected", activeBanks.has(b.key) ? "true" : "false");
          renderQuestions(); // sofort übernehmen
          updateBanksMeta();
          saveState();
        });
        tabsStrip.appendChild(btn);
      });
      updateBanksMeta();
    }

    function getActiveQuestions(){
      const arr=[]; BANKS.forEach(b=>{ if (activeBanks.has(b.key)) arr.push(...b.data); });
      return arr;
    }

    function updateBanksMeta(){
      const countBanks = activeBanks.size;
      const total = getActiveQuestions().length;
      banksMetaEl.textContent = `Aktive Banken: ${countBanks}`;
      countMetaEl.textContent = `Fragen im Formular: ${total}`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuemax", String(total));
    }

    // Autosize helper
    function autosize(el){ el.style.height="auto"; el.style.height=(el.scrollHeight+4)+"px"; }

    // Render Formular
    function renderQuestions(){
      const QUESTIONS = getActiveQuestions();
      // Vor dem Umbau aktuelle Werte speichern
      [...form.querySelectorAll("section[data-ref]")].forEach(sec=>{
        const ref = sec.getAttribute("data-ref");
        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answersByRef[ref] = ta.value;
        if (cb) selectedByRef[ref] = cb.checked;
      });

      form.innerHTML = "";
      QUESTIONS.forEach((item, idx) => {
        const id  = `q_${idx}`;
        const fbId= `fb_${idx}`;
        const selId=`sel_${idx}`;
        const card = document.createElement("section");
        card.className = "card p-4";
        card.setAttribute("data-ref", item.ref);

        card.innerHTML = `
          <header class="flex items-center justify-between gap-3 mb-2">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-sky-600" data-select="${idx}" aria-label="Für KI-Feedback auswählen">
              <span class="q-badge chip">${item.ref}</span>
            </div>
            <span class="text-slate-400 text-[11px]">Frage ${idx+1}/${QUESTIONS.length}</span>
          </header>

          <h3 class="text-[15px] sm:text-[16px] font-semibold mb-2">${item.q}</h3>

          <details class="tip mb-2" data-tip>
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-sky-700 hover:text-sky-900 text-[13px]">
              <i class="chev" data-lucide="chevron-down"></i><span>🛈 Musterlösung</span>
            </summary>
            <div class="mt-2">
              ${(item.tip||[]).map(t=>`<p>${t}</p>`).join("")}
              <div class="mt-2">
                <button type="button" data-ask="${idx}" class="btn ${!relay?'hidden':''}">
                  <i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check zu dieser Antwort
                </button>
              </div>
              <div id="${fbId}" class="prose prose-slate text-sm max-w-none hidden mt-2"></div>
            </div>
          </details>

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" name="${id}" rows="4"
            class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]"
            placeholder="Deine Antwort …"></textarea>

          <div class="mt-2 flex flex-wrap gap-2">
            <button type="button" data-fill="${id}" class="btn">Beispiel-Gliederung</button>
          </div>
        `;
        form.appendChild(card);

        // Werte aus State wiederherstellen
        const ta = card.querySelector("textarea");
        const cb = card.querySelector(`[data-select]`);
        if (answersByRef[item.ref]) { ta.value = answersByRef[item.ref]; }
        if (selectedByRef[item.ref] != null) { cb.checked = !!selectedByRef[item.ref]; }
      });

      // Events
      form.querySelectorAll("textarea").forEach(ta=>{
        autosize(ta);
        ta.addEventListener("input", ()=>{
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) { answersByRef[ref] = ta.value; saveStateSchedule(); }
        });
        ta.addEventListener("keydown", (ev)=>{
          if ((ev.ctrlKey||ev.metaKey) && ev.key==="Enter") { ev.preventDefault(); submitBtn.click(); }
        });
      });

      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const tid = e.currentTarget.getAttribute("data-fill");
          const ta = document.getElementById(tid);
          ta.value = ["### Kurzantwort","- …","- …","- …","","### Begründung/Norm (optional)","- …"].join("\n");
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) { answersByRef[ref] = ta.value; saveStateSchedule(); }
        });
      });

      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!relay){ showToast("Kein Backend konfiguriert."); return; }
          if (!accepted){ showToast("Bitte zuerst den Hinweis bestätigen."); return; }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });

      form.querySelectorAll("[data-select]").forEach(cb=>{
        cb.addEventListener("change", (e)=>{
          const ref = e.currentTarget.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) selectedByRef[ref] = e.currentTarget.checked;
          updateSelectionCount(); saveStateSchedule();
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelectionCount();
      updateProgress();
    }

    function updateSelectionCount(){
      const n = [...form.querySelectorAll("[data-select]:checked")].length;
      selText.textContent = `${n} ausgewählt`;
    }

    function updateProgress(){
      const all=[...form.querySelectorAll("textarea")];
      const filled=all.filter(t=>t.value.trim().length>0).length;
      const total = all.length || 1;
      progressBar.style.width = Math.round((filled/total)*100) + "%";
      progressTxt.textContent = `${filled} / ${total} beantwortet`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuenow", String(filled));
    }

    // Antworten sammeln
    function collectAnswers(indices=null){
      const QUESTIONS = getActiveQuestions();
      const useIdx = indices ?? QUESTIONS.map((_,i)=>i);
      return useIdx.map(i=>{
        const ref = QUESTIONS[i].ref;
        const v = (answersByRef[ref] || "").trim().slice(0, MAX_ANSWER_CHARS);
        return { nr:i+1, ref, question:QUESTIONS[i].q, answer:v };
      });
    }

    // PROMPTS – wohlwollend
    function buildPromptAll(answers){
      return `
Du bist Prüfer:in für Kurzantworten (Ausbildung/Arbeitsrecht). Beurteile **kriteriumsorientiert und wohlwollend**:
- Wenn z. B. **„Nenne 4 …“** und die Antwort **4 korrekte Punkte** enthält, dann: **„passt“** (keine Abwertung, auch wenn weitere möglich wären). Danach **ergänze optional** weitere zulässige Punkte.
- Antworte **knapp**, **klar**, mit **Gesetz/§** (BBiG/JArbSchG/BUrlG/ArbZG/MuSchG/AGG/DSGVO/BGB/BetrVG), wenn relevant.
- Schema je Frage:
  • Kurzfeedback (max. 2 Sätze; explizit „passt“ falls Soll-Anzahl erreicht)
  • Richtige Lösung stichpunktartig (max. 4 Bulletpoints; ggf. Ergänzungen)
  • Gesetz/§ (falls einschlägig)
  • 1 Praxistipp (ein Satz, konstruktiv)

Fragen & Antworten:
${answers.map(a=>`Q${a.nr} (${a.ref}): ${a.question}\nAntwort TN: ${a.answer || "(leer)"}`).join("\n\n")}
`.trim();
    }

    function buildPromptSingle(idx,item,answer){
      return `
Prüfe **eine** Antwort, **wohlwollend** (Soll-Anzahl korrekt ⇒ „passt“, danach optional ergänzen).
- Kurzfeedback (1–2 Sätze; inkl. „passt“, falls Soll-Anzahl erreicht)
- Richtige Lösung in Stichpunkten (max. 4; ggf. Ergänzungen)
- Gesetz/§ (falls einschlägig)
- 1 Praxistipp (ein Satz)
Frage: ${item.q}
Antwort TN: ${answer || "(leer)"} `.trim();
    }

    async function callAI(payload,{timeoutMs=20000,retries=2}={}){
      const url=relay; let lastErr;
      for(let a=0;a<=retries;a++){
        try{
          const res = await Promise.race([
            fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),timeoutMs))
          ]);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const t=await res.text(); try{const j=JSON.parse(t); return j.answer||j.content||j.result||t;}catch{return t;}
        }catch(e){ lastErr=e; await new Promise(r=>setTimeout(r, 650*(a+1))); }
      }
      throw lastErr||new Error("Unbekannter Fehler");
    }

    async function askPerAnswer(idx, btnEl){
      const QUESTIONS = getActiveQuestions();
      const item = QUESTIONS[idx];
      const ref = item.ref;
      const answer = (answersByRef[ref] || "").trim();
      const fbId = `fb_${idx}`;
      // ensure fb exists
      const fb = form.querySelectorAll("[id^='fb_']")[idx];
      const prompt = buildPromptSingle(idx, item, answer);

      btnEl.disabled = true;
      const old = btnEl.innerHTML;
      btnEl.innerHTML = `<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> Prüfen …`;
      fb.classList.remove("hidden");
      fb.innerHTML = `<div class="text-slate-500 text-sm">KI prüft diese Antwort …</div>`;

      try{
        const aiText = await callAI({ prompt });
        fb.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
      }catch(e){
        fb.innerHTML = `<div class="text-red-600 text-sm">KI-Check fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
        showToast("KI-Check fehlgeschlagen.");
      }finally{
        btnEl.disabled = false;
        btnEl.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }
    }

    // Gesamt-Feedback
    submitBtn.addEventListener("click", async ()=>{
      if (!accepted){ showToast("Bitte zuerst den Hinweis bestätigen."); return; }

      // Auswahl: zuerst alle mit Häkchen, sonst alle mit Inhalt, sonst alle
      let idxs = [...form.querySelectorAll("[data-select]:checked")].map((_,i)=>i);
      if (idxs.length===0){
        const withContent = getActiveQuestions().map((q,i)=>({i,ref:q.ref,has:(answersByRef[q.ref]||"").trim().length>0})).filter(x=>x.has).map(x=>x.i);
        idxs = withContent.length ? withContent : getActiveQuestions().map((_,i)=>i);
      }
      if (!relay){ showToast("Kein Backend konfiguriert."); return; }

      const batches=[]; for(let i=0;i<idxs.length;i+=BATCH_SIZE) batches.push(idxs.slice(i,i+BATCH_SIZE));

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = "";
      submitBtn.disabled = true;
      const old = submitBtn.innerHTML;

      try{
        for (let b=0;b<batches.length;b++){
          const answers = collectAnswers(batches[b]);
          const prompt  = buildPromptAll(answers);
          submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> Prüfe Batch ${b+1}/${batches.length} …`;
          const part = await callAI({ prompt });
          const html = (window.marked ? marked.parse(part || "_Keine Antwort erhalten._") : (part || "_Keine Antwort erhalten._"));
          aiResult.insertAdjacentHTML("beforeend", html + (b < batches.length-1 ? "<hr/>" : ""));
        }
        window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
      }catch(e){
        aiResult.innerHTML = `<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
        showToast("Gesamt-Feedback fehlgeschlagen.");
      }finally{
        submitBtn.disabled = false;
        submitBtn.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }
    });

    // Autosave (per ref)
    function saveState(){
      const state = {
        ts: Date.now(),
        accepted,
        activeBanks: [...activeBanks],
        answersByRef,
        selectedByRef
      };
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{}
    }
    let saveTimer=null;
    function saveStateSchedule(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveState, 600); }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const st = JSON.parse(raw);
        if (st.activeBanks){ activeBanks.clear(); st.activeBanks.forEach(k=>activeBanks.add(k)); }
        answersByRef = st.answersByRef || {};
        selectedByRef = st.selectedByRef || {};
        if (st.accepted){ accepted=true; notice.style.display="none"; ack.checked=true; ackState.textContent="Hinweis bestätigt"; ackState.className="chip"; }
      }catch{}
    }

    // Reset
    resetBtn.addEventListener("click", ()=>{
      if (!confirm("Alle Eingaben wirklich löschen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      answersByRef = {}; selectedByRef = {};
      activeBanks.clear(); BANKS.filter(b=>b.defaultActive).forEach(b=>activeBanks.add(b.key));
      renderTabs(); renderQuestions();
      resultWrap.classList.add("hidden"); aiResult.innerHTML="";
      window.scrollTo({ top:0, behavior:"smooth" });
    });

    // Modal open/close
    function openModal(){ askBackdrop.classList.add("open"); askModal.classList.add("open"); askText.focus(); }
    function closeModal(){ askBackdrop.classList.remove("open"); askModal.classList.remove("open"); askResult.classList.add("hidden"); askText.value=""; }
    openAsk?.addEventListener("click", openModal);
    openAskMobile?.addEventListener("click", openModal);
    askClose?.addEventListener("click", closeModal);
    askBackdrop.addEventListener("click", closeModal);
    askModal.addEventListener("click", (e)=>{ if(e.target===askModal) closeModal(); });
    document.addEventListener("click", (e)=>{ const t=e.target.closest?.("[data-close]"); if(t && askModal.classList.contains("open")) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && askModal.classList.contains("open")) closeModal(); });

    // Modal – KI
    askSend.addEventListener("click", async ()=>{
      if (!relay){ showToast("Kein Backend konfiguriert."); return; }
      if (!accepted){ showToast("Bitte zuerst den Hinweis bestätigen."); return; }
      const q=askText.value.trim(); if(!q){ showToast("Bitte gib eine Frage ein."); return; }
      askSend.disabled=true; const old=askSend.innerHTML; askSend.innerHTML=`<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> Senden …`;
      askResult.classList.remove("hidden"); askResult.innerHTML=`<div class="text-slate-500 text-sm">KI antwortet …</div>`;
      try{
        const prompt=`Beantworte diese individuelle Frage knapp, fundiert und mit §§ (falls einschlägig). Keine personenbezogenen Daten verwenden.\n\n${q}`;
        const resp=await fetch(relay,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})}).then(r=>r.text());
        let txt=resp; try{const j=JSON.parse(resp); txt=j.answer||j.content||j.result||resp;}catch{}
        askResult.innerHTML=(window.marked?marked.parse(txt||"_Keine Antwort erhalten._"):(txt||"_Keine Antwort erhalten._"));
      }catch(e){ askResult.innerHTML=`<div class="text-red-600 text-sm">Fehler: ${String(e).replace(/[<>&]/g,"")}</div>`; }
      finally{ askSend.disabled=false; askSend.innerHTML=old; if(window.lucide) lucide.createIcons(); }
    });

    // Toast
    function showToast(msg){
      toastEl.textContent=msg; toastEl.style.display="block";
      clearTimeout(showToast._t); showToast._t=setTimeout(()=> toastEl.style.display="none", 2800);
    }

    // Init
    loadState();
    renderTabs();
    renderQuestions();
  });
  </script>
</body>
</html>
