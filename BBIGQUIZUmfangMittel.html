<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz ‚Äì Kompaktfragen (IHK-Niveau)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Markdown -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --surface:#ffffff; --surface-2:#f6f8fb; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --brand:#0ea5e9; --brand-2:#2563eb; --ok:#10b981;
      --radius:14px; --radius-sm:10px; --shadow-1:0 8px 28px rgba(2,8,23,.06);
    }
    @media (prefers-color-scheme: dark){
      html{ color-scheme: dark; }
      body{ background: linear-gradient(to bottom, #0b1220, #0b1220 40%, #111827 100%); }
      :root{ --surface:#0f172a; --surface-2:#0b1327; --ink:#e5e7eb; --muted:#9aa6b2; --border:#1f2937; }
    }
    body{ background: linear-gradient(to bottom, #fff, #f4f7fb); color: var(--ink); }
    .container{ max-width: 1100px; margin-inline: auto; padding-inline: 1rem; }
    .card{ background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-1); }
    .chip{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:var(--surface-2); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.7rem 1rem; border-radius: var(--radius-sm); border:1px solid var(--border); background: var(--surface); color: var(--ink); }
    .btn:hover{ background:#f8fafc; }
    .btn-primary{ border-color:transparent; background:linear-gradient(180deg, var(--brand), var(--brand-2)); color:#fff; }
    .btn-primary:hover{ filter:brightness(0.98); }
    .btn-ghost{ background:transparent; }
    .btn-lg{ padding:.95rem 1.1rem; border-radius:12px; }
    .btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--brand) 50%, transparent); outline-offset:2px; }

    .q-badge{ background: color-mix(in oklab, var(--brand) 18%, #eaf6ff 82%); color: color-mix(in oklab, var(--brand) 80%, #0b3b52 20%); }
    .progress-outer{ height:10px; border-radius:999px; background:#eaeef4; overflow:hidden; }
    .progress-inner{ height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg, var(--brand), var(--ok)); transition:width .25s; }
    .tip > div{ border-left:3px solid var(--brand); background:#f0f9ff; color:#0b3b52; border-radius:12px; padding:.75rem .85rem; }
    @media (prefers-color-scheme:dark){ .tip > div{ background:rgba(14,165,233,.08); color:#cce9fb; } }
    details[open] summary .chev{ transform:rotate(180deg); }
    summary{ list-style:none; }

    /* Disclaimer */
    .notice{ background:linear-gradient(135deg, #e0f2fe, #dbeafe); border-bottom:1px solid rgba(2,8,23,.08); }
    .notice .inner{ backdrop-filter:blur(6px); }

    /* Cluster-Auswahl (Laschen + Pills) */
    .cluster-wrap{ background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-1); border:1px solid var(--border); }
    .cluster-row{ display:flex; gap:.5rem; overflow:auto; scrollbar-width:none; padding:.6rem; }
    .cluster-row::-webkit-scrollbar{ display:none; }
    .cluster{
      display:flex; align-items:center; gap:.55rem; padding:.6rem .9rem;
      border-radius: 999px; border:1px solid var(--border); background:#fff; color:#0b3b52;
      font-weight:600; font-size:.93rem; white-space:nowrap;
    }
    .cluster .count{ font-weight:500; color:var(--muted); font-size:.8rem; }
    .cluster[aria-pressed="true"]{
      background: #ecfeff; border-color:#bae6fd; color:#0369a1;
    }
    .cluster i{ width:18px; height:18px; }
    .cluster .tick{ display:none; }
    .cluster[aria-pressed="true"] .tick{ display:inline-block; }

    .cluster-bottom{
      border-top:1px solid var(--border); background:#fff; padding:.5rem .8rem; border-radius:0 0 16px 16px;
      display:flex; align-items:center; gap:.75rem; color:#475569; font-size:.85rem;
    }
    .badge-on{ background: #ecfeff; color:#0369a1; border:1px solid #bae6fd; border-radius:999px; padding:2px 8px; font-size:.75rem; }
    .badge-count{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; border-radius:999px; padding:2px 8px; font-size:.75rem; }

    /* Modal (Chat) */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; z-index:98; }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:99; }
    .modal .panel{ width:100%; max-width:820px; border-radius:1rem; }
    .modal.open, .modal-backdrop.open{ display:flex; }
    .chat{ max-height:50vh; overflow:auto; padding:0.5rem; }
    .bubble{ border:1px solid var(--border); border-radius:16px; padding:.6rem .8rem; background:#fff; }
    .bubble.me{ background:#eef2ff; border-color:#c7d2fe; }
    .composer{ display:flex; gap:.5rem; }
    .composer textarea{ flex:1; }

    /* Safe area */
    .safe-bottom{ padding-bottom:max(env(safe-area-inset-bottom),12px); }

    /* Print */
    @media print{
      .sticky, .sticky-actions, #notice, #openAsk, #openAskMobile { display:none!important; }
      body{ background:#fff!important; }
      .card{ box-shadow:none!important; border:1px solid #ddd; }
      footer{ position:fixed; bottom:10mm; left:0; right:0; }
    }
    footer.app-footer{ font-family:Arial, Helvetica, sans-serif; font-size:10px; line-height:1.4; }
  </style>
</head>
<body class="min-h-screen antialiased">

  <!-- Disclaimer -->
  <aside id="notice" class="notice sticky top-0 z-50">
    <div class="inner container px-4 py-3 sm:py-3.5 flex items-start gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-100 grid place-items-center shrink-0">
        <i data-lucide="shield-check" class="w-6 h-6 text-sky-700"></i>
      </div>
      <div class="text-sm leading-snug">
        <p class="font-semibold text-sky-900">Fachlicher Hinweis (Pilot)</p>
        <p class="text-sky-900/90">
          Die KI-Pr√ºfung unterst√ºtzt beim Lernen. Ergebnisse m√ºssen fachlich gepr√ºft werden und ersetzen keine Rechtsberatung.
          <strong>Es d√ºrfen keine personenbezogenen oder sensiblen Daten eingegeben oder erfasst werden.</strong>
        </p>
        <label class="mt-2 inline-flex items-center gap-2">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-sky-600" aria-describedby="ackDesc">
          <span id="ackDesc" class="text-sky-950">Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <a class="btn" href="https://www.gesetze-im-internet.de/bbig_2005/BBiG.pdf" target="_blank" rel="noopener">
          <i data-lucide="book-open" class="w-4 h-4"></i> BBiG
        </a>
        <a class="btn" href="https://www.gesetze-im-internet.de/jarbschg/JArbSchG.pdf" target="_blank" rel="noopener">
          <i data-lucide="shield" class="w-4 h-4"></i> JArbSchG
        </a>
        <span id="ackState" class="chip">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn">Weiter</button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="container px-4 pt-4">
    <div class="flex items-center gap-3">
      <div class="w-11 h-11 rounded-2xl bg-sky-100 grid place-items-center">
        <i data-lucide="graduation-cap" class="w-6 h-6 stroke-[1.6] text-sky-700"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight truncate">BBiG-Quiz ‚Äì Kompaktfragen</h1>
        <p class="text-sm text-slate-500">80 Fragen in Clustern. KI-Feedback gezielt ausw√§hlen. Autosave.</p>
      </div>
      <button id="openAsk" type="button" class="hidden sm:inline-flex btn btn-primary">
        <i data-lucide="message-square" class="w-4 h-4"></i> Eigene Frage
      </button>
    </div>

    <!-- Cluster-Auswahl -->
    <section class="mt-3 cluster-wrap" aria-labelledby="clustersH">
      <h2 id="clustersH" class="sr-only">Cluster ausw√§hlen</h2>
      <div id="clustersRow" class="cluster-row" role="toolbar" aria-label="Cluster">
        <!-- per JS -->
      </div>
      <div class="cluster-bottom">
        <span id="metaActive" class="badge-on">Aktive Cluster: 1</span>
        <span id="metaCount" class="badge-count">Fragen im Formular: 20</span>
        <span class="hidden sm:inline text-slate-500">‚Ä¢ Tipp: Tippe/Enter schaltet Cluster sofort ein/aus.</span>
      </div>
    </section>
  </header>

  <!-- Progress -->
  <section class="container px-4 mt-4" aria-labelledby="progh">
    <div class="card p-4">
      <div class="flex items-center gap-3">
        <i data-lucide="target" class="w-5 h-5 text-sky-700"></i>
        <div class="flex-1">
          <div class="flex justify-between text-xs text-slate-600 mb-1">
            <span id="progressText">0 / 20 beantwortet</span>
            <span id="selText">0 ausgew√§hlt</span>
          </div>
          <div class="progress-outer" role="progressbar" aria-valuemin="0" aria-valuemax="80" aria-valuenow="0" aria-labelledby="progh">
            <div id="progressBar" class="progress-inner"></div>
          </div>
          <span id="progh" class="sr-only">Beantwortete Fragen</span>
        </div>
        <time id="timer" class="text-xs text-slate-500 ml-3" aria-live="polite">00:00</time>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container px-4 py-4">
    <form id="form" class="grid gap-4 sm:gap-5" novalidate aria-describedby="formhint"></form>
    <p id="formhint" class="sr-only">Mit Strg/‚åò+Enter kannst du das KI-Gesamt-Feedback abrufen.</p>

    <section id="resultWrap" class="mt-5 hidden" aria-live="polite">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkle" class="w-5 h-5 text-emerald-700"></i>
          <h2 class="text-base font-semibold">KI-Feedback</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky Action-Bar -->
  <div class="sticky-actions sticky bottom-0 bg-white/95 border-t border-slate-200 backdrop-blur safe-bottom">
    <div class="container px-4 py-2 flex flex-wrap gap-2">
      <button id="openAskMobile" type="button" class="sm:hidden flex-1 btn btn-ghost">
        <i data-lucide="message-square" class="w-5 h-5"></i> Eigene Frage
      </button>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg flex-1 sm:flex-none">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback f√ºr Auswahl
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">Zur√ºcksetzen</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite" style="display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:100;"></div>

  <!-- Modal: Eigene Frage (Chat) -->
  <div id="askBackdrop" class="modal-backdrop"></div>
  <div id="askModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="askTitle" aria-describedby="askDesc">
    <div class="panel card p-4 sm:p-5" role="document">
      <div class="flex items-start gap-2">
        <div class="w-10 h-10 rounded-xl bg-sky-100 grid place-items-center">
          <i data-lucide="message-square" class="w-5 h-5 text-sky-700"></i>
        </div>
        <div class="flex-1">
          <h3 id="askTitle" class="text-base font-semibold">Eigene Frage (Chat)</h3>
          <p id="askDesc" class="text-sm text-slate-500">Stelle deine Frage, die Antwort erscheint darunter. Du kannst R√ºckfragen stellen.</p>
        </div>
        <button id="askClose" type="button" class="btn" aria-label="Fenster schlie√üen" data-close>
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <div id="askChat" class="chat mt-3 space-y-2" aria-live="polite">
        <!-- Thread -->
      </div>

      <div class="mt-3 composer">
        <textarea id="askInput" rows="2" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]" placeholder="Deine Frage ‚Ä¶ (Shift+Enter = neue Zeile)"></textarea>
        <button id="askSend" type="button" class="btn btn-primary">
          <i data-lucide="send" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer bg-slate-100 text-slate-700">
    <div class="container px-4 py-4">
      Diese Anwendung nutzt k√ºnstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antwort von OpenAI verarbeitet und gepr√ºft werden.
      Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbr√§uchlich verwendet werden.
      Es d√ºrfen keine personenbezogenen Daten, sensiblen Daten oder Daten erfasst werden, die R√ºckschl√ºsse auf eine Person, zum Beispiel Auszubildenden,
      Ausbilder oder √§hnliche Personen erm√∂glichen. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind vom Anwender zu pr√ºfen.
      KI-generierte Antworten k√∂nnen fehlerhaft sein. Keine Haftung.
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const relay = "/api/linda-proxy";
    const BATCH_SIZE = 5;
    const MAX_ANSWER_CHARS = 1500;
    const STORAGE_KEY = "BBIGQUIZ_V5_STATE";

    const form = document.getElementById("form");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const resultWrap = document.getElementById("resultWrap");
    const aiResult = document.getElementById("aiResult");
    const timerEl = document.getElementById("timer");
    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");
    const toastEl = document.getElementById("toast");
    const clustersRow = document.getElementById("clustersRow");
    const metaActive = document.getElementById("metaActive");
    const metaCount  = document.getElementById("metaCount");

    // Modal
    const askBackdrop  = document.getElementById("askBackdrop");
    const askModal     = document.getElementById("askModal");
    const askClose     = document.getElementById("askClose");
    const openAsk      = document.getElementById("openAsk");
    const openAskMobile= document.getElementById("openAskMobile");
    const askChat      = document.getElementById("askChat");
    const askInput     = document.getElementById("askInput");
    const askSend      = document.getElementById("askSend");

    if (window.marked) marked.setOptions({ breaks:true, gfm:true });
    if (window.lucide) lucide.createIcons();

    // Timer
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    },1000);

    // === Fragenpools (80) ‚Äì gleich wie zuvor (gek√ºrzt hier nicht gezeigt) ===
    // --- BEGIN: gleiche Daten wie in der letzten Version (BANK_CORE, BANK_BASICS, BANK_RECHT_EINSTIEG, ... ) ---
    // (Um Platz zu sparen: exakt dieselben Arrays wie in deiner letzten Version einf√ºgen)
    // HINWEIS: In deiner App bitte die vollst√§ndigen Arrays aus der vorherigen Antwort √ºbernehmen.
    // --- END Daten ---

    // F√ºr diese Antwort: Wir rekonstruieren kurz die Struktur:
    const BANK_CORE = [ /* ... wie zuvor (20) ... */ ];
    const BANK_BASICS = [ /* ... (10) ... */ ];
    const BANK_RECHT_EINSTIEG = [ /* ... (10) ... */ ];
    const BANK_ARBEITSZEIT_URLAUB = [ /* ... (10) ... */ ];
    const BANK_ORGA_PLANUNG = [ /* ... (8) ... */ ];
    const BANK_BETEILIGTE_EIGNUNG = [ /* ... (8) ... */ ];
    const BANK_MITBESTIMMUNG = [ /* ... (8) ... */ ];
    const BANK_PRUEFUNG = [ /* ... (8) ... */ ];
    const BANK_DATENSCHUTZ_ETHIK = [ /* ... (8) ... */ ];
    const BANK_BIBB_SYSTEM = [ /* ... (8) ... */ ];

    const CLUSTERS = [
      { key:"core",  title:"Kern",                      count:20, icon:"layers",    data:BANK_CORE, defaultActive:true  },
      { key:"bas",   title:"Grundlagen & Recruiting",   count:10, icon:"users",     data:BANK_BASICS, defaultActive:false },
      { key:"recht", title:"Recht ‚Äì Einstieg/BBiG/AGG", count:10, icon:"scale",     data:BANK_RECHT_EINSTIEG, defaultActive:false },
      { key:"az",    title:"Arbeitszeit & Urlaub",      count:10, icon:"clock-8",   data:BANK_ARBEITSZEIT_URLAUB, defaultActive:false },
      { key:"orga",  title:"Organisation & Planung",    count:8,  icon:"calendar",  data:BANK_ORGA_PLANUNG, defaultActive:false },
      { key:"beteiligte", title:"Beteiligte & Eignung", count:8,  icon:"id-card",   data:BANK_BETEILIGTE_EIGNUNG, defaultActive:false },
      { key:"mitb",  title:"Mitbestimmung/BR/JAV",      count:8,  icon:"handshake", data:BANK_MITBESTIMMUNG, defaultActive:false },
      { key:"pruef", title:"Pr√ºfung",                   count:8,  icon:"file-check",data:BANK_PRUEFUNG, defaultActive:false },
      { key:"ds",    title:"Datenschutz & Ethik",       count:8,  icon:"shield",    data:BANK_DATENSCHUTZ_ETHIK, defaultActive:false },
      { key:"sys",   title:"System/BIBB/Kammern",       count:8,  icon:"building",  data:BANK_BIBB_SYSTEM, defaultActive:false }
    ];

    const activeClusters = new Set(CLUSTERS.filter(c=>c.defaultActive).map(c=>c.key));

    // State pro ref
    let answersByRef = {};
    let selectedByRef = {};
    let accepted = false;

    // Disclaimer
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked){ showToast("Bitte die Checkbox best√§tigen."); return; }
      accepted = true; notice.style.display = "none"; ackState.textContent = "Hinweis best√§tigt"; ackState.className = "chip";
      saveState();
    });

    // Cluster-UI
    function renderClusters(){
      clustersRow.innerHTML = "";
      CLUSTERS.forEach((c)=>{
        const btn = document.createElement("button");
        btn.type="button";
        btn.className="cluster";
        btn.setAttribute("aria-pressed", activeClusters.has(c.key) ? "true" : "false");
        btn.setAttribute("title", `Cluster ‚Äû${c.title}‚Äú (${c.count}) ein-/ausschalten`);
        btn.innerHTML = `
          <i data-lucide="${c.icon}"></i>
          <span>${c.title}</span>
          <span class="count">(${c.count})</span>
          <i class="tick" data-lucide="check"></i>
        `;
        btn.addEventListener("click", ()=>{
          if (activeClusters.has(c.key)) activeClusters.delete(c.key); else activeClusters.add(c.key);
          btn.setAttribute("aria-pressed", activeClusters.has(c.key) ? "true" : "false");
          renderQuestions();
          updateClusterMeta();
          saveStateSchedule();
          if (window.lucide) lucide.createIcons();
        });
        btn.addEventListener("keydown", (e)=>{
          if (e.key === "Enter" || e.key === " "){ e.preventDefault(); btn.click(); }
        });
        clustersRow.appendChild(btn);
      });
      if (window.lucide) lucide.createIcons();
      updateClusterMeta();
    }

    function getActiveQuestions(){
      const arr=[]; CLUSTERS.forEach(c=>{ if (activeClusters.has(c.key)) arr.push(...c.data); });
      return arr;
    }
    function updateClusterMeta(){
      metaActive.textContent = `Aktive Cluster: ${activeClusters.size}`;
      metaCount.textContent  = `Fragen im Formular: ${getActiveQuestions().length}`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuemax", String(getActiveQuestions().length));
    }

    // Autosize
    function autosize(el){ el.style.height="auto"; el.style.height=(el.scrollHeight+4)+"px"; }

    // Formular
    function renderQuestions(){
      const QUESTIONS = getActiveQuestions();

      // vorherigen Zustand puffern
      [...form.querySelectorAll("section[data-ref]")].forEach(sec=>{
        const ref = sec.getAttribute("data-ref");
        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answersByRef[ref] = ta.value;
        if (cb) selectedByRef[ref] = cb.checked;
      });

      form.innerHTML = "";
      QUESTIONS.forEach((item, idx)=>{
        const id=`q_${idx}`, fbId=`fb_${idx}`, selId=`sel_${idx}`;
        const card=document.createElement("section");
        card.className="card p-4"; card.setAttribute("data-ref", item.ref);
        card.innerHTML=`
          <header class="flex items-center justify-between gap-3 mb-2">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-sky-600" data-select="${idx}" aria-label="F√ºr KI-Feedback ausw√§hlen">
              <span class="q-badge chip">${item.ref}</span>
            </div>
            <span class="text-slate-400 text-[11px]">Frage ${idx+1}/${QUESTIONS.length}</span>
          </header>

          <h3 class="text-[15px] sm:text-[16px] font-semibold mb-2">${item.q}</h3>

          <details class="tip mb-2" data-tip>
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-sky-700 hover:text-sky-900 text-[13px]">
              <i class="chev" data-lucide="chevron-down"></i><span>üõà Musterl√∂sung</span>
            </summary>
            <div class="mt-2">
              ${(item.tip||[]).map(t=>`<p>${t}</p>`).join("")}
              <div class="mt-2">
                <button type="button" data-ask="${idx}" class="btn ${!relay?'hidden':''}">
                  <i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check zu dieser Antwort
                </button>
              </div>
              <div id="${fbId}" class="prose prose-slate text-sm max-w-none hidden mt-2"></div>
            </div>
          </details>

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" rows="4" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]" placeholder="Deine Antwort ‚Ä¶"></textarea>

          <div class="mt-2 flex flex-wrap gap-2">
            <button type="button" data-fill="${id}" class="btn">Beispiel-Gliederung</button>
          </div>
        `;
        form.appendChild(card);

        const ta = card.querySelector("textarea");
        const cb = card.querySelector(`[data-select]`);
        if (answersByRef[item.ref]) ta.value = answersByRef[item.ref];
        if (selectedByRef[item.ref] != null) cb.checked = !!selectedByRef[item.ref];
      });

      // Events
      form.querySelectorAll("textarea").forEach(ta=>{
        autosize(ta);
        ta.addEventListener("input", ()=>{
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) { answersByRef[ref] = ta.value; saveStateSchedule(); }
        });
        ta.addEventListener("keydown",(ev)=>{ if((ev.ctrlKey||ev.metaKey)&&ev.key==="Enter"){ ev.preventDefault(); submitBtn.click(); } });
      });

      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click",(e)=>{
          const tid=e.currentTarget.getAttribute("data-fill");
          const ta=document.getElementById(tid);
          ta.value=["### Kurzantwort","- ‚Ä¶","- ‚Ä¶","- ‚Ä¶","","### Begr√ºndung/Norm (optional)","- ‚Ä¶"].join("\n");
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) { answersByRef[ref] = ta.value; saveStateSchedule(); }
        });
      });

      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!relay){ showToast("Kein Backend konfiguriert."); return; }
          if (!accepted){ showToast("Bitte zuerst den Hinweis best√§tigen."); return; }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });

      form.querySelectorAll("[data-select]").forEach(cb=>{
        cb.addEventListener("change",(e)=>{
          const ref=e.currentTarget.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) selectedByRef[ref] = e.currentTarget.checked;
          updateSelectionCount(); saveStateSchedule();
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelectionCount(); updateProgress();
    }

    function updateSelectionCount(){
      const n=[...form.querySelectorAll("[data-select]:checked")].length;
      selText.textContent=`${n} ausgew√§hlt`;
    }
    function updateProgress(){
      const all=[...form.querySelectorAll("textarea")];
      const filled=all.filter(t=>t.value.trim().length>0).length;
      const total=all.length||1;
      progressBar.style.width=Math.round((filled/total)*100)+"%";
      progressTxt.textContent=`${filled} / ${total} beantwortet`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuenow", String(filled));
    }

    function collectAnswers(indices=null){
      const QUESTIONS=getActiveQuestions();
      const useIdx=indices ?? QUESTIONS.map((_,i)=>i);
      return useIdx.map(i=>{
        const ref=QUESTIONS[i].ref;
        const v=(answersByRef[ref]||"").trim().slice(0,MAX_ANSWER_CHARS);
        return { nr:i+1, ref, question:QUESTIONS[i].q, answer:v };
      });
    }

    function buildPromptAll(answers){
      return `
Du bist Pr√ºfer:in f√ºr Kurzantworten (Ausbildung/Arbeitsrecht). Beurteile **kriteriumsorientiert und wohlwollend**:
- Wenn z. B. **‚ÄûNenne 4 ‚Ä¶‚Äú** und die Antwort **4 korrekte Punkte** enth√§lt, dann: **‚Äûpasst‚Äú** (keine Abwertung, auch wenn weitere m√∂glich w√§ren). Danach **erg√§nze optional** weitere zul√§ssige Punkte.
- Antworte **knapp**, **klar**, mit **Gesetz/¬ß** (BBiG/JArbSchG/BUrlG/ArbZG/MuSchG/AGG/DSGVO/BGB/BetrVG), wenn relevant.
- Schema je Frage:
  ‚Ä¢ Kurzfeedback (max. 2 S√§tze; explizit ‚Äûpasst‚Äú falls Soll-Anzahl erreicht)
  ‚Ä¢ Richtige L√∂sung stichpunktartig (max. 4 Bulletpoints; ggf. Erg√§nzungen)
  ‚Ä¢ Gesetz/¬ß (falls einschl√§gig)
  ‚Ä¢ 1 Praxistipp (ein Satz, konstruktiv)

Fragen & Antworten:
${answers.map(a=>`Q${a.nr} (${a.ref}): ${a.question}\nAntwort TN: ${a.answer || "(leer)"}`).join("\n\n")}
`.trim();
    }
    function buildPromptSingle(idx,item,answer){
      return `
Pr√ºfe **eine** Antwort, **wohlwollend** (Soll-Anzahl korrekt ‚áí ‚Äûpasst‚Äú, danach optional erg√§nzen).
- Kurzfeedback (1‚Äì2 S√§tze; inkl. ‚Äûpasst‚Äú, falls Soll-Anzahl erreicht)
- Richtige L√∂sung in Stichpunkten (max. 4; ggf. Erg√§nzungen)
- Gesetz/¬ß (falls einschl√§gig)
- 1 Praxistipp (ein Satz)
Frage: ${item.q}
Antwort TN: ${answer || "(leer)"} `.trim();
    }

    async function callAI(payload,{timeoutMs=20000,retries=2}={}){
      const url=relay; let lastErr;
      for(let a=0;a<=retries;a++){
        try{
          const res=await Promise.race([
            fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),timeoutMs))
          ]);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const t=await res.text(); try{const j=JSON.parse(t); return j.answer||j.content||j.result||t;}catch{return t;}
        }catch(e){ lastErr=e; await new Promise(r=>setTimeout(r, 650*(a+1))); }
      }
      throw lastErr||new Error("Unbekannter Fehler");
    }

    async function askPerAnswer(idx, btnEl){
      const QUESTIONS=getActiveQuestions();
      const item=QUESTIONS[idx];
      const ref=item.ref;
      const answer=(answersByRef[ref]||"").trim();
      const fb=form.querySelectorAll("[id^='fb_']")[idx];
      const prompt=buildPromptSingle(idx,item,answer);

      btnEl.disabled=true; const old=btnEl.innerHTML;
      btnEl.innerHTML=`<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> Pr√ºfen ‚Ä¶`;
      fb.classList.remove("hidden"); fb.innerHTML=`<div class="text-slate-500 text-sm">KI pr√ºft diese Antwort ‚Ä¶</div>`;

      try{
        const aiText=await callAI({prompt});
        fb.innerHTML=(window.marked?marked.parse(aiText||"_Keine Antwort erhalten._"):(aiText||"_Keine Antwort erhalten._"));
      }catch(e){
        fb.innerHTML=`<div class="text-red-600 text-sm">KI-Check fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
        showToast("KI-Check fehlgeschlagen.");
      }finally{
        btnEl.disabled=false; btnEl.innerHTML=old; if(window.lucide) lucide.createIcons();
      }
    }

    // Gesamt-Feedback
    submitBtn.addEventListener("click", async ()=>{
      if (!accepted){ showToast("Bitte zuerst den Hinweis best√§tigen."); return; }
      let idxs=[...form.querySelectorAll("[data-select]:checked")].map((_,i)=>i);
      if (idxs.length===0){
        const withContent=getActiveQuestions().map((q,i)=>({i,ref:q.ref,has:(answersByRef[q.ref]||"").trim().length>0})).filter(x=>x.has).map(x=>x.i);
        idxs=withContent.length ? withContent : getActiveQuestions().map((_,i)=>i);
      }
      if (!relay){ showToast("Kein Backend konfiguriert."); return; }

      const batches=[]; for(let i=0;i<idxs.length;i+=BATCH_SIZE) batches.push(idxs.slice(i,i+BATCH_SIZE));
      resultWrap.classList.remove("hidden"); aiResult.innerHTML=""; submitBtn.disabled=true; const old=submitBtn.innerHTML;

      try{
        for (let b=0;b<batches.length;b++){
          const answers=collectAnswers(batches[b]);
          const prompt=buildPromptAll(answers);
          submitBtn.innerHTML=`<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> Pr√ºfe Batch ${b+1}/${batches.length} ‚Ä¶`;
          const part=await callAI({prompt});
          const html=(window.marked?marked.parse(part||"_Keine Antwort erhalten._"):(part||"_Keine Antwort erhalten._"));
          aiResult.insertAdjacentHTML("beforeend", html + (b < batches.length-1 ? "<hr/>" : ""));
        }
        window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
      }catch(e){
        aiResult.innerHTML=`<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
        showToast("Gesamt-Feedback fehlgeschlagen.");
      }finally{
        submitBtn.disabled=false; submitBtn.innerHTML=old; if(window.lucide) lucide.createIcons();
      }
    });

    // Autosave
    function saveState(){
      try{
        const state={ ts:Date.now(), accepted, answersByRef, selectedByRef, active:[...activeClusters] };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch{}
    }
    let saveTimer=null;
    function saveStateSchedule(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveState, 600); }
    function loadState(){
      try{
        const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const st=JSON.parse(raw);
        if (Array.isArray(st.active)){ activeClusters.clear(); st.active.forEach(k=>activeClusters.add(k)); }
        answersByRef = st.answersByRef || {};
        selectedByRef = st.selectedByRef || {};
        if (st.accepted){ accepted=true; notice.style.display="none"; ack.checked=true; ackState.textContent="Hinweis best√§tigt"; ackState.className="chip"; }
      }catch{}
    }

    resetBtn.addEventListener("click", ()=>{
      if (!confirm("Alle Eingaben wirklich l√∂schen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      answersByRef={}; selectedByRef={};
      activeClusters.clear(); CLUSTERS.filter(c=>c.defaultActive).forEach(c=>activeClusters.add(c.key));
      renderClusters(); renderQuestions();
      resultWrap.classList.add("hidden"); aiResult.innerHTML="";
      window.scrollTo({ top:0, behavior:"smooth" });
    });

    // Modal open/close
    function openModal(){ askBackdrop.classList.add("open"); askModal.classList.add("open"); askInput.focus(); }
    function closeModal(){ askBackdrop.classList.remove("open"); askModal.classList.remove("open"); askInput.value=""; askChat.innerHTML=""; }
    openAsk?.addEventListener("click", openModal);
    openAskMobile?.addEventListener("click", openModal);
    askClose?.addEventListener("click", closeModal);
    askBackdrop.addEventListener("click", closeModal);
    askModal.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    // Chat ‚Äì Thread
    async function sendChatMessage(text){
      const q = text.trim(); if(!q){ showToast("Bitte gib eine Frage ein."); return; }
      // render user bubble
      const u = document.createElement("div");
      u.className = "bubble me";
      u.innerHTML = `<strong>Du:</strong><br>${q.replace(/</g,"&lt;")}`;
      askChat.appendChild(u);
      askChat.scrollTop = askChat.scrollHeight;

      // render ai placeholder
      const a = document.createElement("div");
      a.className = "bubble";
      a.innerHTML = `<em>KI schreibt ‚Ä¶</em>`;
      askChat.appendChild(a);
      askChat.scrollTop = askChat.scrollHeight;

      if (!relay){ a.innerHTML = "Kein Backend konfiguriert."; return; }

      try{
        const prompt = `Beantworte folgende Frage knapp, fundiert und mit ¬ß¬ß (falls einschl√§gig). Keine personenbezogenen Daten verwenden.\n\n${q}`;
        const resp = await fetch(relay,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})}).then(r=>r.text());
        let txt=resp; try{const j=JSON.parse(resp); txt=j.answer||j.content||j.result||resp;}catch{}
        a.innerHTML = (window.marked ? marked.parse(txt || "_Keine Antwort erhalten._") : (txt || "_Keine Antwort erhalten._"));
      }catch(e){
        a.innerHTML = `<span class="text-red-600">Fehler: ${String(e).replace(/[<>&]/g,"")}</span>`;
      }
      askChat.scrollTop = askChat.scrollHeight;
    }

    askSend.addEventListener("click", ()=>{ sendChatMessage(askInput.value); askInput.value=""; askInput.focus(); });
    askInput.addEventListener("keydown",(e)=>{
      if (e.key === "Enter" && !e.shiftKey){ e.preventDefault(); askSend.click(); }
    });

    // Toast
    function showToast(msg){
      toastEl.textContent=msg; toastEl.style.display="block";
      clearTimeout(showToast._t); showToast._t=setTimeout(()=> toastEl.style.display="none", 2800);
    }

    // Init
    loadState();
    renderClusters();
    renderQuestions();
  });
  </script>
</body>
</html>
