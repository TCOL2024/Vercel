<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>BBiG-Quiz â€“ Kompaktfragen (IHK-Niveau)</title>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <!-- Markdown -->
  <script defer src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --surface:#ffffff; --surface-2:#f6f8fb; --ink:#0f172a; --muted:#64748b; --border:#e5e7eb;
      --brand:#0ea5e9; --brand-2:#2563eb; --ok:#10b981; --warn:#f59e0b;
      --radius:14px; --radius-sm:10px; --shadow-1:0 8px 28px rgba(2,8,23,.06);
    }
    @media (prefers-color-scheme: dark){
      html{ color-scheme: dark; }
      body{ background: linear-gradient(to bottom, #0b1220, #0b1220 40%, #111827 100%); }
      :root{ --surface:#0f172a; --surface-2:#0b1327; --ink:#e5e7eb; --muted:#9aa6b2; --border:#1f2937; }
    }
    body{ background: linear-gradient(to bottom, #fff, #f4f7fb); color: var(--ink); }
    .container{ max-width: 1100px; margin-inline: auto; padding-inline: 1rem; }
    .card{ background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow-1); }
    .chip{ font-size:12px; padding:4px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); background:var(--surface-2); }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.7rem 1rem; border-radius: var(--radius-sm); border:1px solid var(--border); background: var(--surface); color: var(--ink); touch-action: manipulation; }
    .btn:hover{ background:#f8fafc; }
    .btn-primary{ border-color:transparent; background:linear-gradient(180deg, var(--brand), var(--brand-2)); color:#fff; }
    .btn-primary:hover{ filter:brightness(0.98); }
    .btn-ghost{ background:transparent; }
    .btn-lg{ padding:.95rem 1.1rem; border-radius:12px; }
    .btn:focus-visible{ outline:3px solid color-mix(in oklab, var(--brand) 50%, transparent); outline-offset:2px; }

    .q-badge{ background: color-mix(in oklab, var(--brand) 18%, #eaf6ff 82%); color: color-mix(in oklab, var(--brand) 80%, #0b3b52 20%); }
    .progress-outer{ height:10px; border-radius:999px; background:#eaeef4; overflow:hidden; }
    .progress-inner{ height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg, var(--brand), var(--ok)); transition:width .25s; }
    .tip > div{ border-left:3px solid var(--brand); background:#f0f9ff; color:#0b3b52; border-radius:12px; padding:.75rem .85rem; }
    @media (prefers-color-scheme:dark){ .tip > div{ background:rgba(14,165,233,.08); color:#cce9fb; } }
    details[open] summary .chev{ transform:rotate(180deg); }
    summary{ list-style:none; }

    /* Disclaimer */
    .notice{ background:linear-gradient(135deg, #e0f2fe, #dbeafe); border-bottom:1px solid rgba(2,8,23,.08); }
    .notice .inner{ backdrop-filter:blur(6px); }

    /* Tabs â€“ Laschenoptik (Amazon Nova inspiriert) */
    .tabs-wrap{ background: var(--surface); border-radius: 16px; box-shadow: var(--shadow-1); border:1px solid var(--border); }
    .tabs-strip{ position:relative; display:flex; gap:.25rem; overflow:auto; scrollbar-width:none; padding:.35rem; }
    .tabs-strip::-webkit-scrollbar{ display:none; }
    .tab{
      position:relative; white-space:nowrap; padding:.65rem 1rem; border-radius: 12px 12px 0 0;
      border:1px solid transparent; background:transparent; font-weight:600; font-size:.95rem; color:#334155;
    }
    .tab .sub{ font-weight:500; color:var(--muted); font-size:.8rem; margin-left:.35rem; }
    .tab[aria-selected="true"]{
      background: #fff; color:#0b3b52; border-color: var(--border); border-bottom-color: transparent;
      box-shadow: 0 -1px 0 #fff inset, 0 2px 0 #ffffff;
    }
    .tabs-bottom{
      border-top:1px solid var(--border); background:#fff; padding:.5rem .8rem; border-radius:0 12px 12px 12px;
      display:flex; align-items:center; gap:.75rem; color:#475569; font-size:.85rem;
    }
    .badge-on{ background: #ecfeff; color:#0369a1; border:1px solid #bae6fd; border-radius:999px; padding:2px 8px; font-size:.75rem; }
    .badge-count{ background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; border-radius:999px; padding:2px 8px; font-size:.75rem; }

    /* Modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.45); display:none; z-index:98; }
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:99; }
    .modal .panel{ width:100%; max-width:720px; border-radius:1rem; }
    .modal.open, .modal-backdrop.open{ display:flex; }

    /* Safe area */
    .safe-bottom{ padding-bottom:max(env(safe-area-inset-bottom),12px); }

    /* Print */
    @media print{
      .sticky, .sticky-actions, #notice, #openAsk, #openAskMobile { display:none!important; }
      body{ background:#fff!important; }
      .card{ box-shadow:none!important; border:1px solid #ddd; }
      footer{ position:fixed; bottom:10mm; left:0; right:0; }
    }
    footer.app-footer{ font-family:Arial, Helvetica, sans-serif; font-size:10px; line-height:1.4; }
  </style>
</head>
<body class="min-h-screen antialiased">

  <!-- Disclaimer -->
  <aside id="notice" class="notice sticky top-0 z-50">
    <div class="inner container px-4 py-3 sm:py-3.5 flex items-start gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-100 grid place-items-center shrink-0">
        <i data-lucide="shield-check" class="w-6 h-6 text-sky-700"></i>
      </div>
      <div class="text-sm leading-snug">
        <p class="font-semibold text-sky-900">Fachlicher Hinweis (Pilot)</p>
        <p class="text-sky-900/90">
          Die KI-PrÃ¼fung unterstÃ¼tzt beim Lernen. Ergebnisse mÃ¼ssen fachlich geprÃ¼ft werden und ersetzen keine Rechtsberatung.
          <strong>Es dÃ¼rfen keine personenbezogenen oder sensiblen Daten eingegeben oder erfasst werden.</strong>
        </p>
        <label class="mt-2 inline-flex items-center gap-2">
          <input id="ack" type="checkbox" class="w-4 h-4 accent-sky-600" aria-describedby="ackDesc">
          <span id="ackDesc" class="text-sky-950">Ich habe den Hinweis gelesen.</span>
        </label>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <span id="ackState" class="chip">Hinweis offen</span>
        <button id="ackBtn" type="button" class="btn">Weiter</button>
      </div>
    </div>
  </aside>

  <!-- Header -->
  <header class="container px-4 pt-4">
    <div class="flex items-center gap-3">
      <div class="w-11 h-11 rounded-2xl bg-sky-100 grid place-items-center">
        <i data-lucide="graduation-cap" class="w-6 h-6 stroke-[1.6] text-sky-700"></i>
      </div>
      <div class="flex-1 min-w-0">
        <h1 class="text-xl sm:text-2xl font-semibold tracking-tight truncate">BBiG-Quiz â€“ Kompaktfragen</h1>
        <p class="text-sm text-slate-500">80 Fragen in Clustern. KI-Feedback gezielt auswÃ¤hlen. Autosave.</p>
      </div>
      <button id="openAsk" type="button" class="hidden sm:inline-flex btn btn-primary">
        <i data-lucide="message-square" class="w-4 h-4"></i> Eigene Frage
      </button>
    </div>

    <!-- Tabs / Laschen -->
    <section class="mt-3 tabs-wrap">
      <div id="tabsStrip" class="tabs-strip" role="tablist" aria-label="Frage-Cluster">
        <!-- Tabs via JS -->
      </div>
      <div class="tabs-bottom">
        <span id="banksMeta" class="badge-on">Aktive Banken: 1</span>
        <span id="countMeta" class="badge-count">Fragen im Formular: 20</span>
        <span class="hidden sm:inline text-slate-500">â€¢ Tipp: Klicke eine Lasche, um eine Bank ein-/auszuschalten.</span>
      </div>
    </section>
  </header>

  <!-- Progress -->
  <section class="container px-4 mt-4" aria-labelledby="progh">
    <div class="card p-4">
      <div class="flex items-center gap-3">
        <i data-lucide="target" class="w-5 h-5 text-sky-700"></i>
        <div class="flex-1">
          <div class="flex justify-between text-xs text-slate-600 mb-1">
            <span id="progressText">0 / 20 beantwortet</span>
            <span id="selText">0 ausgewÃ¤hlt</span>
          </div>
          <div class="progress-outer" role="progressbar" aria-valuemin="0" aria-valuemax="80" aria-valuenow="0" aria-labelledby="progh">
            <div id="progressBar" class="progress-inner"></div>
          </div>
          <span id="progh" class="sr-only">Beantwortete Fragen</span>
        </div>
        <time id="timer" class="text-xs text-slate-500 ml-3" aria-live="polite">00:00</time>
      </div>
    </div>
  </section>

  <!-- Quiz -->
  <main class="container px-4 py-4">
    <form id="form" class="grid gap-4 sm:gap-5" novalidate aria-describedby="formhint"></form>
    <p id="formhint" class="sr-only">Mit Strg/âŒ˜+Enter kannst du das KI-Gesamt-Feedback abrufen.</p>

    <section id="resultWrap" class="mt-5 hidden" aria-live="polite">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-2">
          <i data-lucide="sparkle" class="w-5 h-5 text-emerald-700"></i>
          <h2 class="text-base font-semibold">KI-Feedback</h2>
        </div>
        <article id="aiResult" class="prose prose-slate max-w-none text-sm"></article>
      </div>
    </section>
  </main>

  <!-- Sticky Action-Bar -->
  <div class="sticky-actions sticky bottom-0 bg-white/95 border-t border-slate-200 backdrop-blur safe-bottom">
    <div class="container px-4 py-2 flex flex-wrap gap-2">
      <button id="openAskMobile" type="button" class="sm:hidden flex-1 btn btn-ghost">
        <i data-lucide="message-square" class="w-5 h-5"></i> Eigene Frage
      </button>
      <div class="flex-1"></div>
      <button id="submitBtn" type="button" class="btn btn-primary btn-lg flex-1 sm:flex-none">
        <i data-lucide="send" class="w-5 h-5"></i> KI-Feedback fÃ¼r Auswahl
      </button>
      <button id="resetBtn" type="button" class="btn btn-lg">ZurÃ¼cksetzen</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite" style="display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:10px 14px; border-radius:10px; font-size:14px; z-index:100;"></div>

  <!-- Modal: Eigene Frage -->
  <div id="askBackdrop" class="modal-backdrop"></div>
  <div id="askModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="askTitle" aria-describedby="askDesc">
    <div class="panel card p-4 sm:p-5" role="document">
      <div class="flex items-start gap-2">
        <div class="w-10 h-10 rounded-xl bg-sky-100 grid place-items-center">
          <i data-lucide="message-square" class="w-5 h-5 text-sky-700"></i>
        </div>
        <div class="flex-1">
          <h3 id="askTitle" class="text-base font-semibold">Eigene Frage an die KI</h3>
          <p id="askDesc" class="text-sm text-slate-500">Formuliere eine Frage. (Optional: mit Bezug auf eine Frage-Nr.)</p>
        </div>
        <button id="askClose" type="button" class="btn" aria-label="Fenster schlieÃŸen" data-close>
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="mt-3">
        <label for="askText" class="sr-only">Deine Frage</label>
        <textarea id="askText" rows="5" class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]" placeholder="Deine Frage â€¦"></textarea>
      </div>
      <div class="mt-3 flex flex-wrap gap-2 justify-end">
        <button id="askSend" type="button" class="btn btn-primary">
          <i data-lucide="send" class="w-5 h-5"></i> Senden
        </button>
        <button type="button" class="btn" data-close>SchlieÃŸen</button>
      </div>
      <div id="askResult" class="mt-3 hidden prose prose-slate text-sm max-w-none"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer bg-slate-100 text-slate-700">
    <div class="container px-4 py-4">
      Diese Anwendung nutzt kÃ¼nstliche Intelligenz (KI). Du stimmst mit der Nutzung zu, dass Deine Texte und Antwort von OpenAI verarbeitet und geprÃ¼ft werden.
      Es werden keine personenbezogenen Daten von Dir erhoben, erfasst und verarbeitet. Dieses Tool darf nicht missbrÃ¤uchlich verwendet werden.
      Es dÃ¼rfen keine personenbezogenen Daten, sensiblen Daten oder Daten erfasst werden, die RÃ¼ckschlÃ¼sse auf eine Person, zum Beispiel Auszubildenden,
      Ausbilder oder Ã¤hnliche Personen ermÃ¶glichen. Jegliche Haftung ist ausgeschlossen. Alle Antworten sind vom Anwender zu prÃ¼fen.
      KI-generierte Antworten kÃ¶nnen fehlerhaft sein. Keine Haftung.
    </div>
  </footer>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // === Konfiguration ===
    const relay = "/api/linda-proxy";
    const BATCH_SIZE = 5;
    const MAX_ANSWER_CHARS = 1500;
    const STORAGE_KEY = "BBIGQUIZ_V4_STATE";

    // UI-Refs
    const form = document.getElementById("form");
    const submitBtn = document.getElementById("submitBtn");
    const resetBtn = document.getElementById("resetBtn");
    const progressBar = document.getElementById("progressBar");
    const progressTxt = document.getElementById("progressText");
    const selText = document.getElementById("selText");
    const resultWrap = document.getElementById("resultWrap");
    const aiResult = document.getElementById("aiResult");
    const timerEl = document.getElementById("timer");
    const ack = document.getElementById("ack");
    const ackBtn = document.getElementById("ackBtn");
    const notice = document.getElementById("notice");
    const ackState = document.getElementById("ackState");
    const toastEl = document.getElementById("toast");
    const tabsStrip = document.getElementById("tabsStrip");

    // Modal
    const askBackdrop  = document.getElementById("askBackdrop");
    const askModal     = document.getElementById("askModal");
    const askClose     = document.getElementById("askClose");
    const askSend      = document.getElementById("askSend");
    const askText      = document.getElementById("askText");
    const askResult    = document.getElementById("askResult");
    const openAsk      = document.getElementById("openAsk");
    const openAskMobile= document.getElementById("openAskMobile");

    const banksMetaEl = document.getElementById("banksMeta");
    const countMetaEl = document.getElementById("countMeta");

    if (window.marked) marked.setOptions({ breaks:true, gfm:true });
    if (window.lucide) lucide.createIcons();

    // Timer
    let startTs = Date.now();
    setInterval(()=>{
      const s = Math.floor((Date.now()-startTs)/1000);
      const m = String(Math.floor(s/60)).padStart(2,"0");
      const r = String(s%60).padStart(2,"0");
      timerEl.textContent = `${m}:${r}`;
    },1000);

    // === Fragenbanken (80) ===
    const BANK_CORE = [
      { ref:"V1 â€“ Mindestinhalte Vertrag", q:"Nenne vier Pflichtangaben, die zwingend in den Berufsausbildungsvertrag gehÃ¶ren.", tip:[
        "Typisch: Parteien, Beginn/Dauer, Ziel/Berufsbezeichnung, sachliche & zeitliche Gliederung, VergÃ¼tung, Probezeit, Urlaub, tÃ¤gliche Ausbildungszeit, KÃ¼ndigung, Hinweise auf Tarif/BV, Form des Ausbildungsnachweises.",
        "Â§ 11 BBiG; Textform/elektronisch zulÃ¤ssig."
      ]},
      { ref:"V2 â€“ Ausbildungsordnung", q:"Welche drei Kernpunkte regelt eine Ausbildungsordnung?", tip:[
        "Berufsbild, Dauer/Ausbildungsrahmenplan, PrÃ¼fungen.","Â§Â§ 4â€“5 BBiG."
      ]},
      { ref:"V3 â€“ Probezeit", q:"Wie lang muss/darf die Probezeit sein â€“ und warum ist sie wichtig?", tip:[
        "Mind. 1, max. 4 Monate; EignungsprÃ¼fung beider Seiten.","Â§ 20 BBiG."
      ]},
      { ref:"V4 â€“ MinderjÃ¤hrige: Unterschrift", q:"Wer unterschreibt den Vertrag bei MinderjÃ¤hrigen mit gemeinsamem Sorgerecht?", tip:[
        "Beide Sorgeberechtigte + MinderjÃ¤hrige/r.","Â§ 10 BBiG; Â§Â§ 1626, 1629 BGB."
      ]},
      { ref:"V5 â€“ Berufsschulzeit & Arbeitszeit", q:"Wie werden Berufsschulzeiten auf die Arbeitszeit angerechnet (U18 vs. â‰¥18)?", tip:[
        "U18: besondere Anrechnung (JArbSchG).","Wegezeiten Schuleâ†’Betrieb anrechenbar (Â§ 15 Abs. 2 Nr. 1 BBiG).","â‰¥18: ArbZG; Freistellung nach Â§ 15 BBiG."
      ]},
      { ref:"V6 â€“ Ruhezeit Jugendliche", q:"Welche tÃ¤gliche Mindestruhezeit gilt fÃ¼r Jugendliche?", tip:["Mindestens 12 Stunden.","JArbSchG."]},
      { ref:"V7 â€“ VergÃ¼tung", q:"Was gilt zur Angemessenheit der AusbildungsvergÃ¼tung?", tip:[
        "MiAV als Untergrenze; tariflich/branchenÃ¼blich; Steigerung je Jahr.","Â§ 17 BBiG."
      ]},
      { ref:"V8 â€“ Ãœberstunden", q:"Sind Ãœberstunden zulÃ¤ssig â€“ und wie werden sie behandelt?", tip:[
        "Nur ausbildungsdienlich; VergÃ¼tung/Zeitausgleich; Jugendarbeitsschutz beachten.","ArbZG/JArbSchG; BBiG."
      ]},
      { ref:"V9 â€“ Betrieblicher Ausbildungsplan", q:"Wozu dient der betriebliche Ausbildungsplan?", tip:[
        "Umsetzung Rahmenplan, zeitl./sachl. Gliederung, QualitÃ¤tssicherung.","Â§ 5 BBiG; Verweis Â§ 11 Abs. 1 S. 2."
      ]},
      { ref:"V10 â€“ Berichtsheft", q:"Welche Bedeutung hat das Berichtsheft und wer kontrolliert es?", tip:[
        "Zulassungsvoraussetzung; elektronisch mÃ¶glich; Kontrolle Ausbilder/in.","Â§ 13 Nr.7, Â§ 14 BBiG."
      ]},
      { ref:"V11 â€“ VerkÃ¼rzung", q:"Wann kann die Ausbildungsdauer verkÃ¼rzt werden?", tip:["Vorbildung/Leistung/Anrechnung; Einvernehmen nÃ¶tig.","Â§ 8 BBiG."]},
      { ref:"V12 â€“ VerlÃ¤ngerung", q:"Wann kommt eine VerlÃ¤ngerung in Betracht?", tip:["Nichtbestehen oder besondere FÃ¤lle.","Â§ 8 Abs. 2 BBiG."]},
      { ref:"V13 â€“ Teilzeitberufsausbildung", q:"Wie funktioniert Teilzeit in der Ausbildung und was bleibt unverÃ¤ndert?", tip:["Reduzierte Zeiten, Lernziel bleibt; evtl. lÃ¤ngere Gesamtdauer.","Â§ 7a BBiG."]},
      { ref:"V14 â€“ Datenschutz/Geheimnis", q:"Welche Pflichten haben Azubis zu Datenschutz und Betriebsgeheimnissen?", tip:["DSGVO/BDSG beachten; Unterweisungen dokumentieren."]},
      { ref:"V15 â€“ KÃ¼ndigung", q:"Welche KÃ¼ndigungsregeln gelten in und nach der Probezeit?", tip:[
        "Probezeit: jederzeit fristlos (Â§ 22 Abs. 1).","Danach: fristlos aus wichtigem Grund oder mit Frist (Berufsaufgabe/Wechsel) â€“ schriftlich, GrÃ¼nde nennen (Â§ 22)."
      ]},
      { ref:"V16 â€“ Schwangerschaft/Mutterschutz", q:"Welche Schutzregeln gelten bei Schwangerschaft in der Ausbildung?", tip:["MuSchG: Schutzfristen, BeschÃ¤ftigungsverbote, KÃ¼ndigungsschutz."]},
      { ref:"V17 â€“ Nachteilsausgleich", q:"Wie werden Auszubildende mit Behinderung in PrÃ¼fungen unterstÃ¼tzt?", tip:["Nachteilsausgleich (Zeit, Hilfsmittel) auf Antrag; Chancengleichheit."]},
      { ref:"V18 â€“ Ausland", q:"Sind Ausbildungsabschnitte im Ausland mÃ¶glich und wie werden sie angerechnet?", tip:["Ja; Ausbildungsziel wahren; bis zul. Zeitanteile.","Â§ 2 Abs. 3 BBiG."]},
      { ref:"V19 â€“ Versetzung", q:"Darf der Betrieb Azubis versetzen?", tip:["Ja, wenn ausbildungsdienlich/zumutbar; Reisekosten klÃ¤ren.","Â§ 14 BBiG."]},
      { ref:"V20 â€“ Insolvenz", q:"Was passiert bei Insolvenz des Ausbildungsbetriebs?", tip:["FortfÃ¼hrung/Anschlussbetrieb/IHK-UnterstÃ¼tzung; ggf. Insolvenzgeld."]}
    ];

    const BANK_BASICS = [
      { ref:"G1 â€“ Jugendberufsagentur", q:"Was ist die Aufgabe einer Jugendberufsagentur und wer kooperiert dort?", tip:["Unter 25 unterstÃ¼tzen; BÃ¼ndelung AA/Jobcenter/Kommunen/Schulen."]},
      { ref:"G2 â€“ Nutzen Ausbildung", q:"Nenne drei Argumente, warum sich Ausbildung fÃ¼r Betriebe lohnt.", tip:["FachkrÃ¤fte, FlexibilitÃ¤t, Innovation/Kommunikation."]},
      { ref:"G3 â€“ Personalplanung", q:"Welche Dimensionen der Personalbedarfsplanung sind relevant?", tip:["Quantitativ, qualitativ, zeitlich."]},
      { ref:"G4 â€“ Recruiting-KanÃ¤le", q:"Nenne vier Wege, um Auszubildende zu finden.", tip:["Schule/Agentur, Social Media, Messen, Mitarbeitende werben Azubis."]},
      { ref:"G5 â€“ Kennenlernprozess", q:"Welche Elemente umfasst ein typischer Auswahlprozess fÃ¼r Azubis?", tip:["Bewerbung, Screening, GesprÃ¤ch/Test, Entscheidung."]},
      { ref:"G6 â€“ Motivation Bewerber", q:"Nenne drei mÃ¶gliche Motive von Bewerbenden fÃ¼r eine Ausbildung.", tip:["Interesse/Berufseinstieg, finanzielle GrÃ¼nde, Eltern/Tradition."]},
      { ref:"G7 â€“ Anforderungsprofil", q:"Welche drei Kompetenzfelder sind beim Anforderungsprofil zentral?", tip:["Fachlich, sozial, persÃ¶nlich."]},
      { ref:"G8 â€“ Eignungsfeststellung", q:"Wie kann die Eignung vor und in der Probezeit festgestellt werden?", tip:["Zeugnisse, GesprÃ¤che/Tests, Beobachtung in Probezeit."]},
      { ref:"G9 â€“ Nachhaltigkeit", q:"Wie ist Nachhaltigkeit in der Ausbildung verankert (kurz)?", tip:["Lernziele/Handlungsfelder; Projekte/Modelle; Rolle der Ausbilder."]},
      { ref:"G10 â€“ SDGs", q:"Was sind die 17 SDGs und wozu dienen sie in der Ausbildung?", tip:["Globale Ziele; Orientierung fÃ¼r nachhaltiges Handeln."]}
    ];

    const BANK_RECHT_EINSTIEG = [
      { ref:"R1 â€“ Art. 12 GG", q:"Was garantiert Art. 12 GG in Bezug auf Beruf, Arbeitsplatz und AusbildungsstÃ¤tte?", tip:["Freie Wahl; EinschrÃ¤nkbar durch Gesetz."]},
      { ref:"R2 â€“ AGG Ziel", q:"Was ist das Ziel des AGG (Â§1) im Kontext der Ausbildung?", tip:["Benachteiligungen verhindern/beseitigen."]},
      { ref:"R3 â€“ AGG Bereich", q:"Nenne einen Anwendungsbereich des AGG nach Â§2, der Ausbildung betrifft.", tip:["Zugang zu Berufsbildung/Berufsausbildung."]},
      { ref:"R4 â€“ Â§1 BBiG", q:"Welche vier SÃ¤ulen der Berufsbildung nennt Â§1 BBiG?", tip:["Vorbereitung, Ausbildung, Fortbildung, Umschulung."]},
      { ref:"R5 â€“ BvB", q:"Was ist Zweck der Berufsausbildungsvorbereitung (BvB)?", tip:["HeranfÃ¼hrung an Ausbildung; Grundlagen berufl. HandlungsfÃ¤higkeit."]},
      { ref:"R6 â€“ EQ", q:"Was ist die Einstiegsqualifizierung (EQ) und wer wird gefÃ¶rdert?", tip:["Langzeitpraktikum nach SGB III; junge Bewerbende, ggf. GeflÃ¼chtete."]},
      { ref:"R7 â€“ MiAV", q:"Wie wirkt die MindestausbildungsvergÃ¼tung (Â§17 BBiG) mit TarifvertrÃ¤gen zusammen?", tip:["MiAV Untergrenze; Tarif bleibt maÃŸgeblich; Angemessenheit."]},
      { ref:"R8 â€“ Tarif & GÃ¼nstigkeit", q:"Was bedeutet das GÃ¼nstigkeitsprinzip im VerhÃ¤ltnis Vertrag/Tarif?", tip:["Abweichungen nur zugunsten der BeschÃ¤ftigten."]},
      { ref:"R9 â€“ Ausbildungsnachweis", q:"Welche Rolle spielt der Ausbildungsnachweis im Zulassungsverfahren?", tip:["Kann angefordert werden; fehlend kann ausschlieÃŸen."]},
      { ref:"R10 â€“ Digitale Ausbildung", q:"Welche Aussage trifft Â§28 BBiG zur (auch digitalen) DurchfÃ¼hrung?", tip:["Eignung der AusbildungsstÃ¤tte/Person; moderne Formen zulÃ¤ssig."]}
    ];

    const BANK_ARBEITSZEIT_URLAUB = [
      { ref:"A1 â€“ U18 Arbeitszeit", q:"Wie lauten Wochen-/Tagesgrenzen der Arbeitszeit fÃ¼r Jugendliche?", tip:["Max 40 h/Woche, 8 h/Tag (Ausnahmen beachten)."]},
      { ref:"A2 â€“ U18 Ruhepausen", q:"Welche Pausen sind fÃ¼r Jugendliche einzuhalten?", tip:[">4,5â€“6 h: 30 Min; >6 h: 60 Min; min. 15-Min-BlÃ¶cke."]},
      { ref:"A3 â€“ U18 Ruhezeit", q:"Wie lang ist die tÃ¤gliche Freizeit (Ruhezeit) fÃ¼r Jugendliche?", tip:["Mindestens 12 Stunden."]},
      { ref:"A4 â€“ U18 Sonn-/Feiertag", q:"Was gilt fÃ¼r Sonn-/FeiertagsbeschÃ¤ftigung Jugendlicher grob?", tip:["Grundsatz Verbot; Ausnahmen; 2 freie Sonntage/Monat."]},
      { ref:"A5 â€“ â‰¥18 Arbeitszeit", q:"Nenne Grund- und HÃ¶chstarbeitszeit nach ArbZG.", tip:["8 h/Tag, bis 10 h mit Ausgleich; max 48 h/Woche."]},
      { ref:"A6 â€“ â‰¥18 Pausen/Ruhezeit", q:"Welche Pausen und Ruhezeit gelten fÃ¼r Erwachsene?", tip:["6â€“9 h: 30 Min; >9 h: 45 Min; Ruhezeit 11 h."]},
      { ref:"A7 â€“ Mehrarbeit Doku", q:"Welche Mehrarbeit ist zu protokollieren und wie lange?", tip:[">8 h/Tag dokumentieren; 2 Jahre aufbewahren (Â§16 ArbZG)."]},
      { ref:"A8 â€“ Urlaub BUrlG", q:"Wie rechnet sich der Mindesturlaub bei 5-Tage-Woche?", tip:["Mindestens 20 Arbeitstage (=4 Wochen)."]},
      { ref:"A9 â€“ Urlaub U18", q:"Wie hoch ist der Mindesturlaub fÃ¼r Jugendliche je Alter (KurzÃ¼berblick)?", tip:["u16:30 WT (~25 AT), u17:27, u18:25; ab 18:24 WT (~20 AT)."]},
      { ref:"A10 â€“ Â§15 BBiG", q:"Was bedeutet Freistellung nach Â§15 BBiG (zwei Beispiele)?", tip:["Unterricht/PrÃ¼fungen; Anrechnung inkl. Wegezeiten."]}
    ];

    const BANK_ORGA_PLANUNG = [
      { ref:"O1 â€“ VollstÃ¤ndige Handlung", q:"Welche sechs Schritte umfasst das Modell der vollstÃ¤ndigen Handlung?", tip:["Informieren, Planen, Entscheiden, AusfÃ¼hren, Kontrollieren, Bewerten."]},
      { ref:"O2 â€“ Lernzielebenen", q:"Unterscheide Richt-, Grob- und Feinlernziel kurz.", tip:["Richt: Gebiet; Grob: FÃ¤higkeit; Fein: Teilziel/operationalisiert."]},
      { ref:"O3 â€“ Ausbildungsplan sachlich", q:"Nenne drei Kriterien der sachlichen Gliederung.", tip:["Einheiten/Abteilungen, Ãœberschaubarkeit, Probezeit nutzbar."]},
      { ref:"O4 â€“ Ausbildungsplan zeitlich", q:"Nenne drei Kriterien der zeitlichen Gliederung.", tip:["PrÃ¼fungstermine, Reihenfolge Rahmenplan, Block-/Urlaub berÃ¼cksichtigen."]},
      { ref:"O5 â€“ Nachweis/Gliederung", q:"Welche Pflichten zu Gliederung und Nachweis nennt Â§11/Â§13/Â§14 BBiG?", tip:["Gliederung schriftl./Textform; Nachweis fÃ¼hren; Ausbildende halten an."]},
      { ref:"O6 â€“ Versetzungsplan", q:"Wie unterstÃ¼tzt der betriebliche Plan die Versetzung/AbteilungsdurchlÃ¤ufe?", tip:["Zeitlich-sachliche Steuerung; Lernziele/Stationen."]},
      { ref:"O7 â€“ Digitale Tools", q:"Nenne zwei Vorteile digitaler Berichtshefte/Planungs-Tools.", tip:["Transparenz, Nachverfolgbarkeit/Feedback."]},
      { ref:"O8 â€“ QualitÃ¤t", q:"Wie kann AusbildungsqualitÃ¤t im Betrieb praktisch Ã¼berprÃ¼ft werden?", tip:["ZwischengesprÃ¤che, Zielabgleich, Nachweise/PrÃ¼fungsvorbereitung."]}
    ];

    const BANK_BETEILIGTE_EIGNUNG = [
      { ref:"B1 â€“ Beteiligte", q:"Wer sind die zentralen Beteiligten in der Ausbildung?", tip:["Ausbildende, Ausbilder/in, Beauftragte, Azubis, IHK, ggf. Eltern."]},
      { ref:"B2 â€“ Eignung AusbildungsstÃ¤tte", q:"Nenne drei Voraussetzungen der Eignung der AusbildungsstÃ¤tte.", tip:["Ausstattung, Plan/Rahmenplan, ausreichende PlÃ¤tze/Schutz."]},
      { ref:"B3 â€“ Fachkraftbegriff", q:"Wer gilt als Fachkraft im Sinne der Relation?", tip:["Ausbildende/Ausbilder, Berufsabschluss oder 2x Ausbildungszeit tÃ¤tig."]},
      { ref:"B4 â€“ Relation", q:"Gib die Relation FachkrÃ¤fte zu Azubis schematisch wieder.", tip:["1â€“2:1; 3â€“5:2; 6â€“8:3; je +3 FK: +1 Azubi (Ausnahme mÃ¶glich)."]},
      { ref:"B5 â€“ Ausbildende Rolle", q:"Welche Pflichten treffen Ausbildende nach Â§14 BBiG?", tip:["Vermittlung Lernziele, Schutz, Freistellung, Zeugnis etc."]},
      { ref:"B6 â€“ Ausbilder Rolle", q:"Kernaufgaben der Ausbilder/innen?", tip:["Planung, DurchfÃ¼hrung, Kontrolle; Coaching/Erziehen."]},
      { ref:"B7 â€“ Beauftragte Rolle", q:"Was machen Ausbildungsbeauftragte?", tip:["Teilqualifikationen vermitteln; Â§28(3) beachten."]},
      { ref:"B8 â€“ PersÃ¶nliche Eignung", q:"Wann fehlt persÃ¶nliche Eignung als Ausbilder/in (Beispiel)?", tip:["Wiederholte JArbSchG-VerstÃ¶ÃŸe etc. (Â§29 BBiG i.V.m. BetrVG Â§98)."]}
    ];

    const BANK_MITBESTIMMUNG = [
      { ref:"M1 â€“ BR Rechte", q:"Nenne zwei Mitwirkungs-/Mitbestimmungsrechte des Betriebsrats in der Berufsbildung.", tip:["Â§96 Beratungsrecht; Â§98 Mitbestimmung/Bestellung."]},
      { ref:"M2 â€“ Â§87 BetrVG", q:"FÃ¼r welche Themen besteht nach Â§87 BetrVG Mitbestimmung?", tip:["Arbeitszeit, Ordnung, VergÃ¼tungssysteme, IT-EinfÃ¼hrung etc."]},
      { ref:"M3 â€“ Einstellung Azubis", q:"Wie ist der BR bei Einstellungen einzubeziehen?", tip:["Â§99 BetrVG: unterrichten, Unterlagen, Zustimmung einholen."]},
      { ref:"M4 â€“ JAV Aufgabe", q:"Welche zwei Hauptaufgaben hat die JAV?", tip:["Ãœberwachung zugunsten Jugend/Azubis; Verbesserungen anstoÃŸen."]},
      { ref:"M5 â€“ JAV Wahl", q:"Wer ist wahlberechtigt / wÃ¤hlbar (KurzÃ¼berblick)?", tip:["Jugendliche u18 + Azubis; wÃ¤hlbar <25 J.; BR-Mitglieder ausgeschlossen."]},
      { ref:"M6 â€“ JAV GrÃ¶ÃŸe", q:"Wovon hÃ¤ngt die GrÃ¶ÃŸe der JAV ab?", tip:["Zahl der Wahlberechtigten (Â§62 BetrVG)."]},
      { ref:"M7 â€“ BR Widerspruch", q:"Wann kann der BR der Bestellung eines Ausbilders widersprechen?", tip:["Fehlende persÃ¶nliche/fachliche Eignung (Â§98 Abs.2)."]},
      { ref:"M8 â€“ Einigungsstelle", q:"Was passiert bei fehlender Einigung in mitbestimmungspflichtigen Fragen?", tip:["Einigungsstelle entscheidet."]}
    ];

    const BANK_PRUEFUNG = [
      { ref:"P1 â€“ ZwischenprÃ¼fung", q:"Wozu dient die ZwischenprÃ¼fung (Â§48 BBiG)?", tip:["Ermittlung Wissensstand; Voraussetzung fÃ¼r Zulassung (Â§43)."]},
      { ref:"P2 â€“ Ausbildungsende", q:"Wann endet das AusbildungsverhÃ¤ltnis nach Â§21 BBiG?", tip:["Mit Ablauf der Zeit oder mit Bekanntgabe bestandener PrÃ¼fung."]},
      { ref:"P3 â€“ Zulassung", q:"Welche Rolle hat der Ausbildungsnachweis fÃ¼r die PrÃ¼fungszulassung?", tip:["Kann angefordert werden; fehlend kann ausschlieÃŸen."]},
      { ref:"P4 â€“ Nachteilsausgleich PrÃ¼fung", q:"Beispielhafte Nachteilsausgleiche in PrÃ¼fungen?", tip:["ZeitverlÃ¤ngerung, Hilfsmittel, angepasste Aufgabenform."]},
      { ref:"P5 â€“ PrÃ¼fungsrecht Basics", q:"Welche Prinzipien sollte ein PA beachten (kurz)?", tip:["Rechtsgrundlagen, Gleichbehandlung, VerhÃ¤ltnismÃ¤ÃŸigkeit."]},
      { ref:"P6 â€“ Freistellung PrÃ¼fung", q:"Welche Freistellungen nennt Â§15 BBiG im PrÃ¼fungszusammenhang?", tip:["PrÃ¼fungsteilnahme; Vortag der schriftlichen AbschlussprÃ¼fung."]},
      { ref:"P7 â€“ Wiederholung", q:"Ist eine WiederholungsprÃ¼fung mÃ¶glich und was ist zu beachten?", tip:["Ja; VerlÃ¤ngerung Â§8(2) mÃ¶glich bis nÃ¤chster Termin."]},
      { ref:"P8 â€“ Dokumentation", q:"Welche Dokumente sollte der Betrieb zur PrÃ¼fungsvorbereitung bereithalten?", tip:["Ausbildungsplan, Nachweise, Beurteilungen, ggf. Berichtsheft."]}
    ];

    const BANK_DATENSCHUTZ_ETHIK = [
      { ref:"D1 â€“ DSGVO Basics", q:"Welche GrundsÃ¤tze der DSGVO sind im Ausbildungsalltag besonders wichtig?", tip:["Zweckbindung, Datenminimierung, Transparenz."]},
      { ref:"D2 â€“ KI-Hinweis", q:"Welche VorsichtsmaÃŸnahme gilt bei Nutzung von KI-Tools im Betrieb?", tip:["Keine personenbezogenen/sensiblen Daten eingeben."]},
      { ref:"D3 â€“ Betriebsgeheimnisse", q:"Wie gehen Azubis mit Betriebsgeheimnissen um?", tip:["Verschwiegenheit; Schulung/Verpflichtung."]},
      { ref:"D4 â€“ Dokumentationspflichten", q:"Welche Dokumente unterstÃ¼tzen DSGVO-Compliance im Ausbildungsbereich?", tip:["Verarbeitungsverzeichnis, TOMs, Schulungsnachweise."]},
      { ref:"D5 â€“ Foto/Video", q:"Was ist vor VerÃ¶ffentlichung von Fotos/Clips mit Azubis zu beachten?", tip:["Einwilligung/Betroffenenrechte."]},
      { ref:"D6 â€“ AGG im Recruiting", q:"Nenne zwei AGG-kritische Fehler in Stellenausschreibungen.", tip:["Diskriminierende Formulierungen (Alter/Geschlecht/Religion etc.)."]},
      { ref:"D7 â€“ SoMe Screening", q:"Was ist beim Social-Media-Screening von Bewerbenden zu beachten?", tip:["Datenschutz/Erforderlichkeit/Transparenz."]},
      { ref:"D8 â€“ Aufbewahrung Bewerbungen", q:"Wie lange dÃ¼rfen abgelehnte Bewerbungen typischerweise aufbewahrt werden (Richtwert)?", tip:["i.d.R. 6 Monate (AGG-Fristen) â€“ danach lÃ¶schen."]}
    ];

    const BANK_BIBB_SYSTEM = [
      { ref:"S1 â€“ BIBB Aufgabe", q:"Nenne zwei Aufgaben des BIBB.", tip:["Beratung, Forschung, Empfehlungen (Â§90 BBiG)."]},
      { ref:"S2 â€“ Ausbildungsordnung Hoheit", q:"Wer erlÃ¤sst Ausbildungsordnungen und worauf stÃ¼tzen sie sich?", tip:["Fachministerien auf Basis BBiG; BIBB wirkt mit."]},
      { ref:"S3 â€“ Lernorte", q:"Welche Lernorte nennt Â§2 BBiG?", tip:["Betrieb, Schule, ggf. weitere."]},
      { ref:"S4 â€“ Rahmenplan", q:"Welche Funktion hat der Ausbildungsrahmenplan?", tip:["Zeitlich-sachliche Struktur; Mindestinhalte."]},
      { ref:"S5 â€“ Kammern", q:"Welche Rolle haben die Kammern in der Ausbildung (kurz)?", tip:["ZustÃ¤ndige Stelle: Eintragung, Beratung, PrÃ¼fungen."]},
      { ref:"S6 â€“ Tarifbezug", q:"Wie kann ein nicht tarifgebundener Betrieb die VergÃ¼tung bestimmen?", tip:["Anlehnung an einschlÃ¤gige Tarife/Empfehlungen; MiAV beachten."]},
      { ref:"S7 â€“ Rechtsquellen AR", q:"Ordne die arbeitsrechtlichen Rechtsquellen grob (obenâ†’unten).", tip:["EU/GG â†’ Gesetze â†’ Tarif â†’ BV â†’ Vertrag â†’ Direktionsrecht."]},
      { ref:"S8 â€“ NebentÃ¤tigkeit", q:"Welche verfassungsrechtliche Norm ist bei NebentÃ¤tigkeit tangiert?", tip:["Art. 12 GG (BerufsausÃ¼bungsfreiheit)."]}
    ];

    const BANKS = [
      { key:"core",  title:"Kern",                 count:20, data:BANK_CORE, defaultActive:true  },
      { key:"bas",   title:"Grundlagen & Recruiting", count:10, data:BANK_BASICS, defaultActive:false },
      { key:"recht", title:"Recht â€“ Einstieg/BBiG/AGG", count:10, data:BANK_RECHT_EINSTIEG, defaultActive:false },
      { key:"az",    title:"Arbeitszeit & Urlaub",  count:10, data:BANK_ARBEITSZEIT_URLAUB, defaultActive:false },
      { key:"orga",  title:"Organisation & Planung", count:8,  data:BANK_ORGA_PLANUNG, defaultActive:false },
      { key:"beteiligte", title:"Beteiligte & Eignung", count:8, data:BANK_BETEILIGTE_EIGNUNG, defaultActive:false },
      { key:"mitb",  title:"Mitbestimmung/BR/JAV", count:8,  data:BANK_MITBESTIMMUNG, defaultActive:false },
      { key:"pruef", title:"PrÃ¼fung",              count:8,  data:BANK_PRUEFUNG, defaultActive:false },
      { key:"ds",    title:"Datenschutz & Ethik",  count:8,  data:BANK_DATENSCHUTZ_ETHIK, defaultActive:false },
      { key:"sys",   title:"System/BIBB/Kammern",  count:8,  data:BANK_BIBB_SYSTEM, defaultActive:false }
    ];

    // Aktive Banken
    const activeBanks = new Set(BANKS.filter(b=>b.defaultActive).map(b=>b.key));

    // State (robust â€“ per ref)
    let answersByRef = {};   // { ref: text }
    let selectedByRef = {};  // { ref: true/false }

    // Disclaimer
    let accepted = false;
    ackBtn.addEventListener("click", ()=>{
      if (!ack.checked){ showToast("Bitte die Checkbox bestÃ¤tigen."); return; }
      accepted = true; notice.style.display = "none"; ackState.textContent = "Hinweis bestÃ¤tigt"; ackState.className = "chip";
      saveState();
    });

    // Tabs rendern (Laschen)
    function renderTabs(){
      tabsStrip.innerHTML = "";
      BANKS.forEach((b, idx)=>{
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "tab";
        btn.setAttribute("role","tab");
        btn.setAttribute("aria-selected", activeBanks.has(b.key) ? "true" : "false");
        btn.innerHTML = `
          <span>${b.title}</span>
          <span class="sub">(${b.count})</span>
        `;
        btn.addEventListener("click", ()=>{
          if (activeBanks.has(b.key)) activeBanks.delete(b.key); else activeBanks.add(b.key);
          btn.setAttribute("aria-selected", activeBanks.has(b.key) ? "true" : "false");
          renderQuestions(); // sofort Ã¼bernehmen
          updateBanksMeta();
          saveState();
        });
        tabsStrip.appendChild(btn);
      });
      updateBanksMeta();
    }

    function getActiveQuestions(){
      const arr=[]; BANKS.forEach(b=>{ if (activeBanks.has(b.key)) arr.push(...b.data); });
      return arr;
    }

    function updateBanksMeta(){
      const countBanks = activeBanks.size;
      const total = getActiveQuestions().length;
      banksMetaEl.textContent = `Aktive Banken: ${countBanks}`;
      countMetaEl.textContent = `Fragen im Formular: ${total}`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuemax", String(total));
    }

    // Autosize helper
    function autosize(el){ el.style.height="auto"; el.style.height=(el.scrollHeight+4)+"px"; }

    // Render Formular
    function renderQuestions(){
      const QUESTIONS = getActiveQuestions();
      // Vor dem Umbau aktuelle Werte speichern
      [...form.querySelectorAll("section[data-ref]")].forEach(sec=>{
        const ref = sec.getAttribute("data-ref");
        const ta = sec.querySelector("textarea");
        const cb = sec.querySelector("input[type='checkbox'][data-select]");
        if (ta) answersByRef[ref] = ta.value;
        if (cb) selectedByRef[ref] = cb.checked;
      });

      form.innerHTML = "";
      QUESTIONS.forEach((item, idx) => {
        const id  = `q_${idx}`;
        const fbId= `fb_${idx}`;
        const selId=`sel_${idx}`;
        const card = document.createElement("section");
        card.className = "card p-4";
        card.setAttribute("data-ref", item.ref);

        card.innerHTML = `
          <header class="flex items-center justify-between gap-3 mb-2">
            <div class="flex items-center gap-2">
              <input id="${selId}" type="checkbox" class="w-4 h-4 accent-sky-600" data-select="${idx}" aria-label="FÃ¼r KI-Feedback auswÃ¤hlen">
              <span class="q-badge chip">${item.ref}</span>
            </div>
            <span class="text-slate-400 text-[11px]">Frage ${idx+1}/${QUESTIONS.length}</span>
          </header>

          <h3 class="text-[15px] sm:text-[16px] font-semibold mb-2">${item.q}</h3>

          <details class="tip mb-2" data-tip>
            <summary class="list-none cursor-pointer select-none flex items-center gap-2 text-sky-700 hover:text-sky-900 text-[13px]">
              <i class="chev" data-lucide="chevron-down"></i><span>ðŸ›ˆ MusterlÃ¶sung</span>
            </summary>
            <div class="mt-2">
              ${(item.tip||[]).map(t=>`<p>${t}</p>`).join("")}
              <div class="mt-2">
                <button type="button" data-ask="${idx}" class="btn ${!relay?'hidden':''}">
                  <i data-lucide="sparkles" class="w-4 h-4"></i> KI-Check zu dieser Antwort
                </button>
              </div>
              <div id="${fbId}" class="prose prose-slate text-sm max-w-none hidden mt-2"></div>
            </div>
          </details>

          <label for="${id}" class="sr-only">Antwort</label>
          <textarea id="${id}" name="${id}" rows="4"
            class="w-full p-3 rounded-xl border focus:outline-none focus:ring-2 focus:ring-sky-300 text-[15px]"
            placeholder="Deine Antwort â€¦"></textarea>

          <div class="mt-2 flex flex-wrap gap-2">
            <button type="button" data-fill="${id}" class="btn">Beispiel-Gliederung</button>
          </div>
        `;
        form.appendChild(card);

        // Werte aus State wiederherstellen
        const ta = card.querySelector("textarea");
        const cb = card.querySelector(`[data-select]`);
        if (answersByRef[item.ref]) { ta.value = answersByRef[item.ref]; }
        if (selectedByRef[item.ref] != null) { cb.checked = !!selectedByRef[item.ref]; }
      });

      // Events
      form.querySelectorAll("textarea").forEach(ta=>{
        autosize(ta);
        ta.addEventListener("input", ()=>{
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) { answersByRef[ref] = ta.value; saveStateSchedule(); }
        });
        ta.addEventListener("keydown", (ev)=>{
          if ((ev.ctrlKey||ev.metaKey) && ev.key==="Enter") { ev.preventDefault(); submitBtn.click(); }
        });
      });

      form.querySelectorAll("[data-fill]").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const tid = e.currentTarget.getAttribute("data-fill");
          const ta = document.getElementById(tid);
          ta.value = ["### Kurzantwort","- â€¦","- â€¦","- â€¦","","### BegrÃ¼ndung/Norm (optional)","- â€¦"].join("\n");
          autosize(ta); updateProgress();
          const ref = ta.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) { answersByRef[ref] = ta.value; saveStateSchedule(); }
        });
      });

      form.querySelectorAll("[data-ask]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          if (!relay){ showToast("Kein Backend konfiguriert."); return; }
          if (!accepted){ showToast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; }
          const idx = Number(e.currentTarget.getAttribute("data-ask"));
          await askPerAnswer(idx, e.currentTarget);
        });
      });

      form.querySelectorAll("[data-select]").forEach(cb=>{
        cb.addEventListener("change", (e)=>{
          const ref = e.currentTarget.closest("section[data-ref]")?.getAttribute("data-ref");
          if (ref) selectedByRef[ref] = e.currentTarget.checked;
          updateSelectionCount(); saveStateSchedule();
        });
      });

      if (window.lucide) lucide.createIcons();
      updateSelectionCount();
      updateProgress();
    }

    function updateSelectionCount(){
      const n = [...form.querySelectorAll("[data-select]:checked")].length;
      selText.textContent = `${n} ausgewÃ¤hlt`;
    }

    function updateProgress(){
      const all=[...form.querySelectorAll("textarea")];
      const filled=all.filter(t=>t.value.trim().length>0).length;
      const total = all.length || 1;
      progressBar.style.width = Math.round((filled/total)*100) + "%";
      progressTxt.textContent = `${filled} / ${total} beantwortet`;
      document.querySelector('[role="progressbar"]')?.setAttribute("aria-valuenow", String(filled));
    }

    // Antworten sammeln
    function collectAnswers(indices=null){
      const QUESTIONS = getActiveQuestions();
      const useIdx = indices ?? QUESTIONS.map((_,i)=>i);
      return useIdx.map(i=>{
        const ref = QUESTIONS[i].ref;
        const v = (answersByRef[ref] || "").trim().slice(0, MAX_ANSWER_CHARS);
        return { nr:i+1, ref, question:QUESTIONS[i].q, answer:v };
      });
    }

    // PROMPTS â€“ wohlwollend
    function buildPromptAll(answers){
      return `
Du bist PrÃ¼fer:in fÃ¼r Kurzantworten (Ausbildung/Arbeitsrecht). Beurteile **kriteriumsorientiert und wohlwollend**:
- Wenn z. B. **â€žNenne 4 â€¦â€œ** und die Antwort **4 korrekte Punkte** enthÃ¤lt, dann: **â€žpasstâ€œ** (keine Abwertung, auch wenn weitere mÃ¶glich wÃ¤ren). Danach **ergÃ¤nze optional** weitere zulÃ¤ssige Punkte.
- Antworte **knapp**, **klar**, mit **Gesetz/Â§** (BBiG/JArbSchG/BUrlG/ArbZG/MuSchG/AGG/DSGVO/BGB/BetrVG), wenn relevant.
- Schema je Frage:
  â€¢ Kurzfeedback (max. 2 SÃ¤tze; explizit â€žpasstâ€œ falls Soll-Anzahl erreicht)
  â€¢ Richtige LÃ¶sung stichpunktartig (max. 4 Bulletpoints; ggf. ErgÃ¤nzungen)
  â€¢ Gesetz/Â§ (falls einschlÃ¤gig)
  â€¢ 1 Praxistipp (ein Satz, konstruktiv)

Fragen & Antworten:
${answers.map(a=>`Q${a.nr} (${a.ref}): ${a.question}\nAntwort TN: ${a.answer || "(leer)"}`).join("\n\n")}
`.trim();
    }

    function buildPromptSingle(idx,item,answer){
      return `
PrÃ¼fe **eine** Antwort, **wohlwollend** (Soll-Anzahl korrekt â‡’ â€žpasstâ€œ, danach optional ergÃ¤nzen).
- Kurzfeedback (1â€“2 SÃ¤tze; inkl. â€žpasstâ€œ, falls Soll-Anzahl erreicht)
- Richtige LÃ¶sung in Stichpunkten (max. 4; ggf. ErgÃ¤nzungen)
- Gesetz/Â§ (falls einschlÃ¤gig)
- 1 Praxistipp (ein Satz)
Frage: ${item.q}
Antwort TN: ${answer || "(leer)"} `.trim();
    }

    async function callAI(payload,{timeoutMs=20000,retries=2}={}){
      const url=relay; let lastErr;
      for(let a=0;a<=retries;a++){
        try{
          const res = await Promise.race([
            fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}),
            new Promise((_,rej)=>setTimeout(()=>rej(new Error("Timeout")),timeoutMs))
          ]);
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const t=await res.text(); try{const j=JSON.parse(t); return j.answer||j.content||j.result||t;}catch{return t;}
        }catch(e){ lastErr=e; await new Promise(r=>setTimeout(r, 650*(a+1))); }
      }
      throw lastErr||new Error("Unbekannter Fehler");
    }

    async function askPerAnswer(idx, btnEl){
      const QUESTIONS = getActiveQuestions();
      const item = QUESTIONS[idx];
      const ref = item.ref;
      const answer = (answersByRef[ref] || "").trim();
      const fbId = `fb_${idx}`;
      // ensure fb exists
      const fb = form.querySelectorAll("[id^='fb_']")[idx];
      const prompt = buildPromptSingle(idx, item, answer);

      btnEl.disabled = true;
      const old = btnEl.innerHTML;
      btnEl.innerHTML = `<svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"></svg> PrÃ¼fen â€¦`;
      fb.classList.remove("hidden");
      fb.innerHTML = `<div class="text-slate-500 text-sm">KI prÃ¼ft diese Antwort â€¦</div>`;

      try{
        const aiText = await callAI({ prompt });
        fb.innerHTML = (window.marked ? marked.parse(aiText || "_Keine Antwort erhalten._") : (aiText || "_Keine Antwort erhalten._"));
      }catch(e){
        fb.innerHTML = `<div class="text-red-600 text-sm">KI-Check fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
        showToast("KI-Check fehlgeschlagen.");
      }finally{
        btnEl.disabled = false;
        btnEl.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }
    }

    // Gesamt-Feedback
    submitBtn.addEventListener("click", async ()=>{
      if (!accepted){ showToast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; }

      // Auswahl: zuerst alle mit HÃ¤kchen, sonst alle mit Inhalt, sonst alle
      let idxs = [...form.querySelectorAll("[data-select]:checked")].map((_,i)=>i);
      if (idxs.length===0){
        const withContent = getActiveQuestions().map((q,i)=>({i,ref:q.ref,has:(answersByRef[q.ref]||"").trim().length>0})).filter(x=>x.has).map(x=>x.i);
        idxs = withContent.length ? withContent : getActiveQuestions().map((_,i)=>i);
      }
      if (!relay){ showToast("Kein Backend konfiguriert."); return; }

      const batches=[]; for(let i=0;i<idxs.length;i+=BATCH_SIZE) batches.push(idxs.slice(i,i+BATCH_SIZE));

      resultWrap.classList.remove("hidden");
      aiResult.innerHTML = "";
      submitBtn.disabled = true;
      const old = submitBtn.innerHTML;

      try{
        for (let b=0;b<batches.length;b++){
          const answers = collectAnswers(batches[b]);
          const prompt  = buildPromptAll(answers);
          submitBtn.innerHTML = `<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> PrÃ¼fe Batch ${b+1}/${batches.length} â€¦`;
          const part = await callAI({ prompt });
          const html = (window.marked ? marked.parse(part || "_Keine Antwort erhalten._") : (part || "_Keine Antwort erhalten._"));
          aiResult.insertAdjacentHTML("beforeend", html + (b < batches.length-1 ? "<hr/>" : ""));
        }
        window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
      }catch(e){
        aiResult.innerHTML = `<div class="text-red-600 text-sm">Gesamt-Feedback fehlgeschlagen (${String(e).replace(/[<>&]/g,"")}).</div>`;
        showToast("Gesamt-Feedback fehlgeschlagen.");
      }finally{
        submitBtn.disabled = false;
        submitBtn.innerHTML = old;
        if (window.lucide) lucide.createIcons();
      }
    });

    // Autosave (per ref)
    function saveState(){
      const state = {
        ts: Date.now(),
        accepted,
        activeBanks: [...activeBanks],
        answersByRef,
        selectedByRef
      };
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{}
    }
    let saveTimer=null;
    function saveStateSchedule(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveState, 600); }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const st = JSON.parse(raw);
        if (st.activeBanks){ activeBanks.clear(); st.activeBanks.forEach(k=>activeBanks.add(k)); }
        answersByRef = st.answersByRef || {};
        selectedByRef = st.selectedByRef || {};
        if (st.accepted){ accepted=true; notice.style.display="none"; ack.checked=true; ackState.textContent="Hinweis bestÃ¤tigt"; ackState.className="chip"; }
      }catch{}
    }

    // Reset
    resetBtn.addEventListener("click", ()=>{
      if (!confirm("Alle Eingaben wirklich lÃ¶schen?")) return;
      localStorage.removeItem(STORAGE_KEY);
      answersByRef = {}; selectedByRef = {};
      activeBanks.clear(); BANKS.filter(b=>b.defaultActive).forEach(b=>activeBanks.add(b.key));
      renderTabs(); renderQuestions();
      resultWrap.classList.add("hidden"); aiResult.innerHTML="";
      window.scrollTo({ top:0, behavior:"smooth" });
    });

    // Modal open/close
    function openModal(){ askBackdrop.classList.add("open"); askModal.classList.add("open"); askText.focus(); }
    function closeModal(){ askBackdrop.classList.remove("open"); askModal.classList.remove("open"); askResult.classList.add("hidden"); askText.value=""; }
    openAsk?.addEventListener("click", openModal);
    openAskMobile?.addEventListener("click", openModal);
    askClose?.addEventListener("click", closeModal);
    askBackdrop.addEventListener("click", closeModal);
    askModal.addEventListener("click", (e)=>{ if(e.target===askModal) closeModal(); });
    document.addEventListener("click", (e)=>{ const t=e.target.closest?.("[data-close]"); if(t && askModal.classList.contains("open")) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape" && askModal.classList.contains("open")) closeModal(); });

    // Modal â€“ KI
    askSend.addEventListener("click", async ()=>{
      if (!relay){ showToast("Kein Backend konfiguriert."); return; }
      if (!accepted){ showToast("Bitte zuerst den Hinweis bestÃ¤tigen."); return; }
      const q=askText.value.trim(); if(!q){ showToast("Bitte gib eine Frage ein."); return; }
      askSend.disabled=true; const old=askSend.innerHTML; askSend.innerHTML=`<svg class="animate-spin h-5 w-5" viewBox="0 0 24 24"></svg> Senden â€¦`;
      askResult.classList.remove("hidden"); askResult.innerHTML=`<div class="text-slate-500 text-sm">KI antwortet â€¦</div>`;
      try{
        const prompt=`Beantworte diese individuelle Frage knapp, fundiert und mit Â§Â§ (falls einschlÃ¤gig). Keine personenbezogenen Daten verwenden.\n\n${q}`;
        const resp=await fetch(relay,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt})}).then(r=>r.text());
        let txt=resp; try{const j=JSON.parse(resp); txt=j.answer||j.content||j.result||resp;}catch{}
        askResult.innerHTML=(window.marked?marked.parse(txt||"_Keine Antwort erhalten._"):(txt||"_Keine Antwort erhalten._"));
      }catch(e){ askResult.innerHTML=`<div class="text-red-600 text-sm">Fehler: ${String(e).replace(/[<>&]/g,"")}</div>`; }
      finally{ askSend.disabled=false; askSend.innerHTML=old; if(window.lucide) lucide.createIcons(); }
    });

    // Toast
    function showToast(msg){
      toastEl.textContent=msg; toastEl.style.display="block";
      clearTimeout(showToast._t); showToast._t=setTimeout(()=> toastEl.style.display="none", 2800);
    }

    // Init
    loadState();
    renderTabs();
    renderQuestions();
  });
  </script>
</body>
</html>
