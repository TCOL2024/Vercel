<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Linda â€“ Deine persÃ¶nliche Assistentin (v27.9-pro)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
:root{
  --bg:#f7f8fb;--panel:#fff;--line:#e7ebf0;--text:#0f172a;--muted:#5b6678;
  --brand:#0b5bd3;--brand-2:#2b6ff0;
  --shadow:0 8px 24px rgba(15,23,42,.06),0 1px 2px rgba(15,23,42,.04)
}
body.dark{--bg:#0b0e14;--panel:#0f1420;--line:#1d2535;--text:#e7eaf0;
  --muted:#a4b0c3;--brand:#6aa4ff;--brand-2:#88b2ff}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:var(--brand-2)}
.top{position:sticky;top:0;z-index:30;background:var(--panel);
  border-bottom:1px solid var(--line);padding:.9rem 1rem;
  display:flex;align-items:center;gap:.75rem}
.brand{font-weight:600;letter-spacing:.2px}
.grow{flex:1}
.badge{display:inline-flex;align-items:center;gap:.35rem;
  background:rgba(11,91,211,.08);color:var(--brand);
  border:1px solid var(--line);padding:.35rem .6rem;
  border-radius:999px;font-size:.85rem}
.icon-btn{border:0;background:transparent;cursor:pointer;
  padding:.35rem;border-radius:.6rem}
.icon-btn:hover{background:rgba(11,91,211,.08)}
.sliders{width:22px;height:22px}
.container{max-width:1200px;margin:0 auto;padding:1rem;
  display:grid;grid-template-columns:260px 1fr;gap:1rem}
.sidebar{display:flex;flex-direction:column;gap:1rem}
.panel{background:var(--panel);border:1px solid var(--line);
  border-radius:14px;box-shadow:var(--shadow)}
.avatar{padding:.9rem;display:flex;flex-direction:column;align-items:center}
.avatar img{width:100%;border-radius:10px}
.avatar .name{margin-top:.55rem;font-weight:600;text-align:center}
.sessions{display:flex;flex-direction:column;max-height:50vh}
.sessions .head{padding:.8rem .9rem;border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between}
.sessions .list{overflow:auto}
.sess{display:flex;align-items:center;justify-content:space-between;
  gap:.5rem;padding:.65rem .9rem;border-top:1px solid var(--line);cursor:pointer}
.sess:first-child{border-top:0}
.sess .ttl{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px}
.sess.active{background:rgba(11,91,211,.06)}
.sm-btn{border:1px solid var(--line);
  background:color-mix(in oklab,var(--panel) 80%,var(--bg));
  color:var(--brand);border-radius:8px;padding:.25rem .45rem;
  cursor:pointer;font-size:.85rem}
.sm-btn:hover{background:rgba(11,91,211,.08)}
.chat{display:flex;flex-direction:column;min-height:calc(100vh - 120px)}
.log{flex:1;overflow:auto;display:flex;flex-direction:column;
  gap:1rem;padding:.25rem;scroll-behavior:smooth}
.bubble{max-width:78ch;border-radius:12px;padding:1rem 1.1rem;
  background:var(--panel);box-shadow:var(--shadow)}
.me{align-self:flex-end;background:var(--brand);color:#fff;box-shadow:none}
.composer{background:var(--panel);border:1px solid var(--line);
  border-radius:14px;padding:.7rem;display:flex;gap:.6rem;align-items:center;
  position:sticky;bottom:0}
.in{flex:1;border:1px solid var(--line);border-radius:10px;
  background:color-mix(in oklab,var(--panel) 80%,var(--bg));
  padding:.85rem 1rem;font-size:1rem;color:var(--text);outline:none}
.send{border:0;background:var(--brand);color:#fff;font-weight:600;
  border-radius:10px;padding:.7rem 1rem;cursor:pointer}
.send:disabled{opacity:.6;cursor:not-allowed}
.palette{position:absolute;bottom:66px;left:16px;max-width:640px;
  background:var(--panel);border:1px solid var(--line);border-radius:12px;
  box-shadow:var(--shadow);display:none}
.pal-item{padding:.7rem .9rem;border-top:1px solid var(--line);
  cursor:pointer;display:flex;justify-content:space-between;gap:.6rem}
.pal-item:first-child{border-top:0}
.pal-item:hover{background:rgba(11,91,211,.06)}
.pal-tag{color:var(--muted);font-size:.85rem}
.modal{position:fixed;inset:0;display:none;align-items:center;
  justify-content:center;background:rgba(17,24,39,.32);
  backdrop-filter:saturate(140%) blur(6px);z-index:1000}
.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;
  box-shadow:var(--shadow);width:min(92vw,760px);max-height:85vh;overflow:auto}
.card-h{padding:1rem 1.2rem;border-bottom:1px solid var(--line);font-weight:600}
.card-b{padding:1rem 1.2rem;line-height:1.55}
.card-f{padding:1rem 1.2rem;border-top:1px solid var(--line);
  display:flex;gap:.6rem;justify-content:flex-end}
.btn{border:1px solid var(--line);
  background:color-mix(in oklab,var(--panel) 80%,var(--bg));
  color:var(--brand);border-radius:.7rem;padding:.55rem .9rem;
  cursor:pointer;font-weight:600}
.btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
.muted{color:var(--muted)}
.group{padding:1rem 1.2rem;border-top:1px solid var(--line)}
.row{display:flex;align-items:center;justify-content:space-between;
  gap:1rem;margin:.55rem 0}
.chips{display:flex;gap:.45rem;flex-wrap:wrap}
.chip{padding:.42rem .72rem;border:1px solid var(--line);border-radius:999px;
  background:var(--panel);cursor:pointer}
.chip.active{background:var(--brand);border-color:var(--brand);color:#fff}
.select{border:1px solid var(--line);border-radius:10px;
  padding:.5rem .65rem;background:color-mix(in oklab,var(--panel) 80%,var(--bg));
  color:var(--text)}
.switch{width:46px;height:26px;border-radius:999px;background:#dfe6f3;
  position:relative;cursor:pointer;border:1px solid var(--line)}
.switch>i{position:absolute;width:22px;height:22px;top:1px;left:1px;
  border-radius:50%;background:#fff;transition:left .18s}
.switch.on{background:#bcd4ff}.switch.on>i{left:23px}
@media (max-width:980px){.container{grid-template-columns:1fr}
.sessions{max-height:none}}
</style>
</head>
<body>

<!-- Datenschutz -->
<div id="m-privacy" class="modal" style="display:flex">
  <div class="card">
    <div class="card-h">Datenschutzhinweis</div>
    <div class="card-b">
      <p>Um diesen Chatbot nutzen zu kÃ¶nnen, ist deine Zustimmung zur DatenschutzerklÃ¤rung erforderlich:</p>
      <ul>
        <li>Deine Eingaben werden an OpenAI (USA) und Make (EU) Ã¼bermittelt.</li>
        <li>Bitte keine sensiblen oder personenbezogenen Daten eingeben.</li>
      </ul>
      <p class="muted">Dein Chatverlauf & Snippets werden <b>nur lokal</b> gespeichert.</p>
    </div>
    <div class="card-f">
      <button class="btn" id="p-decline">Ablehnen</button>
      <button class="btn primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<!-- Nutzung -->
<div id="m-usage" class="modal">
  <div class="card">
    <div class="card-h">Wichtige Hinweise</div>
    <div class="card-b">
      <ul>
        <li><b>Automatisierte Antworten</b> â€“ KI-generiert, keine GewÃ¤hr.</li>
        <li><b>Keine Beratung</b> â€“ kein Ersatz fÃ¼r rechtliche oder medizinische Beratung.</li>
      </ul>
    </div>
    <div class="card-f"><button class="btn primary" id="u-accept">Einverstanden</button></div>
  </div>
</div>

<!-- Einstellungen -->
<div id="m-settings" class="modal">
  <div class="card">
    <div class="card-h">Einstellungen</div>
    <div class="group">
      <div class="row">
        <label>Darstellung</label>
        <div class="chips" id="chip-theme">
          <div class="chip" data-val="light">Hell</div>
          <div class="chip" data-val="dark">Dunkel</div>
          <div class="chip" data-val="system">System</div>
        </div>
      </div>
      <div class="row"><label>Gender-Sprache</label><div id="sw-gender" class="switch"><i></i></div></div>
      <div class="row"><label>BegrÃ¼ÃŸung anzeigen</label><div id="sw-greet" class="switch on"><i></i></div></div>
    </div>
    <div class="group">
      <div class="row">
        <label>Fachmodus</label>
        <select id="sel-domain" class="select">
          <option value="">â€” Kein spezieller Modus â€”</option>
          <option value="AEVO">AEVO</option>
          <option value="Personal">Personal</option>
          <option value="Recht">Recht</option>
          <option value="Kommunikation">Kommunikation</option>
          <option value="VWL">VWL</option>
        </select>
      </div>
    </div>
    <div class="card-f">
      <button class="btn" id="s-close">SchlieÃŸen</button>
      <button class="btn primary" id="s-save">Speichern</button>
    </div>
  </div>
</div>

<div class="top">
  <div class="brand">Linda</div><div class="grow"></div>
  <div id="domain-badge" class="badge" style="display:none">ðŸ“˜ Fachmodus: â€”</div>
  <button class="icon-btn" id="btn-settings" aria-label="Einstellungen Ã¶ffnen">
    <svg class="sliders" viewBox="0 0 24 24" fill="none" stroke="var(--brand)"
      stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
      <line x1="4" y1="6" x2="20" y2="6"/>
      <line x1="4" y1="12" x2="20" y2="12"/>
      <line x1="4" y1="18" x2="20" y2="18"/>
      <circle cx="9" cy="6" r="2.2"/>
      <circle cx="15" cy="12" r="2.2"/>
      <circle cx="7" cy="18" r="2.2"/>
    </svg>
  </button>
</div>

<div class="container">
  <aside class="sidebar">
    <div class="panel avatar">
      <img src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png" alt="Linda"/>
      <div class="name">Linda</div>
    </div>
    <div class="panel sessions">
      <div class="head"><div style="font-weight:600">VerlÃ¤ufe</div>
        <button id="btn-new" class="sm-btn">Neu</button></div>
      <div id="sess-list" class="list"></div>
    </div>
  </aside>

  <section class="chat">
    <div id="log" class="log"></div>
    <div style="position:relative">
      <div id="palette" class="palette"></div>
      <div class="composer">
        <input id="in" class="in" placeholder="Deine Frageâ€¦ (Tipp â€ž/â€œ fÃ¼r Snippets)"/>
        <button id="send" class="send">Senden</button>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
const $=id=>document.getElementById(id);
const LS={get(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},
           set(k,v){localStorage.setItem(k,JSON.stringify(v))}};
const S=LS.get('linda.settings',{theme:'light',gender:false,greet:true,domain:''});
let Sessions=LS.get('linda.sessions',[]);let activeId=LS.get('linda.activeId',null);
function saveAll(){LS.set('linda.settings',S);LS.set('linda.sessions',Sessions);LS.set('linda.activeId',activeId);}
const md=t=>{try{return marked.parse(t)}catch{return t}};
const uid=()=> 's_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);
function addMsg(r,c){const d=document.createElement('div');d.className='bubble'+(r==='user'?' me':'');d.innerHTML='<div class="md">'+md(c)+'</div>';
$('log').appendChild(d);$('log').scrollTop=$('log').scrollHeight;}
function ensureSession(){if(!Sessions.length){const id=uid();Sessions=[{id,name:'Neuer Chat',ts:Date.now(),messages:[]}];activeId=id;saveAll();}}
function active(){return Sessions.find(s=>s.id===activeId);}
function renderChat(){$('log').innerHTML='';const s=active();if(!s)return;s.messages.forEach(m=>addMsg(m.role,m.content));}
function push(role,content){const s=active();s.messages.push({role,content});s.ts=Date.now();saveAll();}
function applyTheme(){if(S.theme==='system'){const m=window.matchMedia('(prefers-color-scheme: dark)');
document.body.classList.toggle('dark',m.matches);m.onchange=()=>document.body.classList.toggle('dark',m.matches);}
else{document.body.classList.toggle('dark',S.theme==='dark');}}
function systemPrefix(){
const lines=[];
if(S.domain){
const map={'AEVO':'Antworte fachlich fundiert im AEVO-Kontext.',
'Personal':'Antworte als HR-Expertin mit Praxisbeispiel.',
'Recht':'Antworte juristisch sauber und praxisnah.',
'Kommunikation':'Antworte als Kommunikationstrainerin.',
'VWL':'Antworte volkswirtschaftlich fundiert.'};
lines.push(map[S.domain]||'');}
lines.push(S.gender?'Verwende gendergerechte Sprache (neutral, inklusiv, gut lesbar).':'Verwende neutrale, nicht gegenderte Sprache.');
lines.push('Strukturiere Antworten: 1) Definition 2) Bezug 3) Beispiel 4) PrÃ¼fungsrelevanz 5) Quelle.');
return lines.join('\n');
}

// âœ… Genderfix integriert
async function send(){
const inp=$('in');const q=inp.value.trim();if(!q)return;
inp.value='';$('send').disabled=true;
push('user',q);renderChat();
push('assistant','â³ Einen Moment â€¦');renderChat();
try{
 const payload={question:"Systemanweisung:\n"+systemPrefix()+"\n\nNutzerfrage:\n"+q};
 const r=await fetch('/api/bot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
 const text=await r.text();
 const out=(text&&text.trim().toLowerCase()!=='accepted')?text:'Ich habe deine Frage erhalten.';
 const s=active();s.messages[s.messages.length-1]={role:'assistant',content:out};saveAll();renderChat();
}catch(e){
 const s=active();s.messages[s.messages.length-1]={role:'assistant',content:'Verbindungsproblem.'};saveAll();renderChat();
}finally{$('send').disabled=false;}
}

// Datenschutz & Nutzung
$('p-accept').onclick=()=>{document.getElementById('m-privacy').style.display='none';
 document.getElementById('m-usage').style.display='flex';}
$('p-decline').onclick=()=>location.reload();
$('u-accept').onclick=()=>{document.getElementById('m
('u-accept').onclick = () => {
  document.getElementById('m-usage').style.display = 'none';
  const s = active();
  if (S.greet && s.messages.length === 0) {
    push(
      'assistant',
      '**Willkommen!** Du kannst mich fÃ¼r AEVO-, Personal-, Rechts- und PrÃ¼fungsfragen nutzen. ' +
        'Ã–ffne *Einstellungen*, um Fachmodus, Sprache oder Snippets anzupassen.'
    );
    renderChat();
  }
};

// --- Einstellungen ---
function sw(el, val) { el.classList.toggle('on', val); }
applyTheme();
sw($('sw-gender'), S.gender);
sw($('sw-greet'), S.greet);
document.querySelectorAll('#chip-theme .chip').forEach(c => {
  c.onclick = () => { S.theme = c.dataset.val; saveAll(); applyTheme(); };
});
$('sel-domain').value = S.domain || '';
$('sw-gender').onclick = () => { S.gender = !S.gender; sw($('sw-gender'), S.gender); };
$('sw-greet').onclick = () => { S.greet = !S.greet; sw($('sw-greet'), S.greet); };
$('s-save').onclick = () => {
  S.domain = $('sel-domain').value;
  saveAll();
  hide($('m-settings'));
  const b = $('domain-badge');
  if (S.domain) { b.style.display = 'inline-flex'; b.textContent = 'ðŸ“˜ Fachmodus: ' + S.domain; }
  else { b.style.display = 'none'; }
};
$('s-close').onclick = () => hide($('m-settings'));
$('btn-settings').onclick = () => { show($('m-settings')); };

// --- Sitzungen ---
function renderSessions() {
  const el = $('sess-list');
  el.innerHTML = Sessions.map(s => `
    <div class="sess ${s.id === activeId ? 'active' : ''}" data-id="${s.id}">
      <div class="ttl">${s.name || 'Chat'}<div class="muted" style="font-size:.8rem">${new Date(s.ts).toLocaleDateString()}</div></div>
      <div class="rowbtns">
        <button class="sm-btn s-rename">âœŽ</button>
        <button class="sm-btn s-export">â¤“</button>
        <button class="sm-btn s-del">ðŸ—‘</button>
      </div>
    </div>`).join('');
  el.querySelectorAll('.sess').forEach(n => n.onclick = e => {
    if (e.target.closest('.rowbtns')) return;
    setActive(n.dataset.id);
  });
  el.querySelectorAll('.s-rename').forEach(b => b.onclick = e => {
    e.stopPropagation();
    const id = b.closest('.sess').dataset.id;
    const s = Sessions.find(x => x.id === id);
    const nn = prompt('Neuer Name fÃ¼r Verlauf:', s.name || '');
    if (nn !== null) { s.name = nn.trim() || s.name; saveAll(); renderSessions(); }
  });
  el.querySelectorAll('.s-export').forEach(b => b.onclick = e => {
    e.stopPropagation();
    const s = Sessions.find(x => x.id === b.closest('.sess').dataset.id);
    const text = s.messages.map(m => (m.role === 'user' ? 'Du: ' : 'Linda: ') + m.content).join('\n\n');
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (s.name || 'linda_chat') + '.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  el.querySelectorAll('.s-del').forEach(b => b.onclick = e => {
    e.stopPropagation();
    const id = b.closest('.sess').dataset.id;
    if (confirm('Diesen Verlauf wirklich lÃ¶schen?')) {
      Sessions = Sessions.filter(x => x.id !== id);
      if (!Sessions.length) { addSession(); }
      activeId = Sessions[0].id;
      saveAll(); renderSessions(); renderChat();
    }
  });
}
function setActive(id) { activeId = id; saveAll(); renderSessions(); renderChat(); }
function addSession() {
  const id = uid();
  Sessions.unshift({ id, name: 'Neuer Chat', ts: Date.now(), messages: [] });
  setActive(id);
}
$('btn-new').onclick = addSession;

// --- Utilities show/hide
function show(m) { m.style.display = 'flex'; }
function hide(m) { m.style.display = 'none'; }

// --- Boot
ensureSession();
renderSessions();
renderChat();

// --- Eingabe
$('send').onclick = send;
$('in').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
})();
</script>
</body>
</html>
