<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <title>Linda – Coaching Bot</title>

  <!-- Preconnects -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link rel="preconnect" href="https://ntc-bot1.netlify.app" crossorigin />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/aptos" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      /* McKinsey-clean / neutral grayscale */
      --bg: #f6f6f7;
      --panel: #ffffff;
      --panel-2: #f1f2f3;
      --line: #d9dcdf;
      --text: #1f2328;
      --muted: #5f6b76;

      --btn-bg: #f2f3f4;
      --btn-bg-hover: #e7e9eb;
      --btn-text: #1f2328;
      --btn-border: #cfd4d9;

      --accent: #2b2f36; /* very subtle */
      --radius: 10px;
      --radius-sm: 8px;
      --shadow: 0 1px 0 rgba(31,35,40,0.04);
      --transition: 160ms ease;
      --focus: 0 0 0 3px rgba(31,35,40,0.12);
    }

    body.dark{
      --bg: #0f1114;
      --panel: #14181d;
      --panel-2: #1a1f25;
      --line: #2a3038;
      --text: #e7eaee;
      --muted: #a8b0ba;

      --btn-bg: #1a1f25;
      --btn-bg-hover: #242b33;
      --btn-text: #e7eaee;
      --btn-border: #2a3038;

      --accent: #e7eaee;
      --shadow: 0 1px 0 rgba(0,0,0,0.25);
      --focus: 0 0 0 3px rgba(231,234,238,0.12);
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      letter-spacing: -0.01em;
    }
    a{ color: inherit; text-decoration: underline; text-decoration-color: rgba(31,35,40,0.25); }
    a:hover{ text-decoration-color: rgba(31,35,40,0.6); }

    /* Layout */
    .top{
      position: sticky; top: 0; z-index: 20;
      background: var(--panel);
      border-bottom: 1px solid var(--line);
      box-shadow: var(--shadow);
      padding: 14px 18px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
    }
    .brand-wrap{ display:flex; align-items:center; gap:12px; min-width: 260px; }
    .brand-portrait{
      width: 44px; height: 44px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid var(--line);
    }
    .brand{
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .pulse{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .badge{
      justify-self: center;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--line);
      background: var(--panel-2);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      color: var(--text);
    }

    .top-actions{ display:flex; gap:8px; justify-content:flex-end; }
    .icon-btn{
      appearance:none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 600;
      font-size: 12px;
      cursor:pointer;
      transition: background var(--transition), border-color var(--transition);
      box-shadow: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    .icon-btn:hover{ background: var(--btn-bg-hover); }
    .icon-btn:focus{ outline:none; box-shadow: var(--focus); }

    .container{
      max-width: 1400px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      min-height: calc(100vh - 70px);
    }
    .sidebar{ display:flex; flex-direction:column; gap:12px; }
    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* Coach */
    .coach{ padding: 16px; display:flex; gap:12px; align-items: center; }
    .coach img{
      width: 56px; height: 56px;
      border-radius: 12px;
      border: 1px solid var(--line);
      object-fit: cover;
    }
    .coach h2{ font-size: 14px; font-weight: 700; }
    .coach p{ margin-top: 6px; font-size: 12px; color: var(--muted); line-height: 1.5; }

    /* Quick */
    .quick{
      padding: 12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }
    .chip{
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 600;
      font-size: 12px;
      cursor:pointer;
      transition: background var(--transition);
      text-align: center;
    }
    .chip:hover{ background: var(--btn-bg-hover); }

    /* Sessions */
    .sessions .head{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid var(--line);
    }
    .sessions .head > div{ font-weight:700; font-size: 12px; text-transform: uppercase; letter-spacing: 0.04em; color: var(--muted); }
    .sessions .list{
      max-height: 60vh;
      overflow:auto;
      padding: 10px;
      display:grid;
      gap: 8px;
    }
    .sess{
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius-sm);
      padding: 10px 10px 8px;
      cursor:pointer;
      transition: background var(--transition), border-color var(--transition);
      content-visibility: auto;
      contain-intrinsic-size: 220px;
    }
    .sess:hover{ background: var(--panel-2); }
    .sess.active{ border-color: var(--accent); }
    .sess .ttl{
      display:flex;
      align-items: baseline;
      justify-content:space-between;
      gap: 10px;
      font-weight: 700;
      font-size: 12px;
    }
    .sess small{ font-weight: 500; color: var(--muted); font-size: 11px; }
    .sess .rowbtns{ margin-top: 8px; display:flex; gap: 6px; flex-wrap: wrap; }

    .sm-btn{
      appearance:none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 600;
      font-size: 11px;
      cursor:pointer;
      transition: background var(--transition);
    }
    .sm-btn:hover{ background: var(--btn-bg-hover); }
    .sm-btn:focus{ outline:none; box-shadow: var(--focus); }

    /* Learn mini */
    .learn{ padding: 12px; }
    .learn-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--line);
      margin-bottom: 10px;
    }
    .learn-head .title{
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }
    .tag-list{ display:flex; flex-wrap:wrap; gap: 6px; }
    .tag-pill{
      border: 1px solid var(--line);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Chat */
    .chat{
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-width: 0;
    }
    .hero{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 14px;
    }
    .hero h1{
      font-size: 14px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .hero p{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }
    .stats{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
      min-width: 240px;
    }
    .stat{
      border: 1px solid var(--line);
      background: var(--panel-2);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      text-align: left;
      min-width: 120px;
    }
    .stat .label{ font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }
    .stat .val{ margin-top: 4px; font-size: 12px; font-weight: 700; }

    .log{
      flex: 1;
      min-height: 280px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap: 10px;
      padding: 6px 2px 10px;
    }
    .bubble{
      max-width: 86ch;
      border: 1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 12px 14px;
      line-height: 1.65;
      box-shadow: none;
      content-visibility: auto;
      contain-intrinsic-size: 220px;
    }
    .bubble.me{
      align-self:flex-end;
      background: var(--panel-2);
    }

    .bubble-header{
      display:flex;
      justify-content:flex-end;
      gap: 8px;
      margin-bottom: 8px;
    }
    .copy-btn, .pdf-btn{
      appearance:none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 7px 10px;
      font-weight: 600;
      font-size: 11px;
      cursor:pointer;
      transition: background var(--transition);
    }
    .copy-btn:hover, .pdf-btn:hover{ background: var(--btn-bg-hover); }
    .copy-btn:focus, .pdf-btn:focus{ outline:none; box-shadow: var(--focus); }

    .bubble .md h1, .bubble .md h2, .bubble .md h3{
      margin: 6px 0 10px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .bubble .md p, .bubble .md ul, .bubble .md ol, .bubble .md pre{ margin: 10px 0; }
    .bubble .md pre{
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      overflow-x: auto;
    }
    .bubble .md code{
      background: var(--panel-2);
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 2px 6px;
    }

    .footnotes{
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 11px;
      line-height: 1.5;
    }
    .footnotes ol{ margin-left: 16px; }
    .footnote-marker{ color: var(--muted); font-size: 0.75em; vertical-align: super; }

    /* Palette */
    .palette{
      position:absolute;
      bottom: 86px;
      left: 0;
      width: min(540px, 100%);
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display:none;
      overflow:hidden;
      z-index: 10;
    }
    .pal-item{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      transition: background var(--transition);
      font-size: 12px;
      font-weight: 600;
    }
    .pal-item:hover{ background: var(--panel-2); }
    .pal-tag{ color: var(--muted); font-weight: 600; font-size: 11px; }

    /* Composer */
    .composer{
      position: sticky;
      bottom: 0;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 10px;
      box-shadow: var(--shadow);
      display:flex;
      gap: 10px;
      align-items:center;
    }
    .answer-mode{
      display:flex;
      gap: 10px;
      align-items:center;
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    .answer-mode input{ accent-color: var(--accent); }
    .in{
      flex:1;
      border: 1px solid var(--btn-border);
      background: var(--panel-2);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text);
      outline:none;
      transition: box-shadow var(--transition), background var(--transition), border-color var(--transition);
    }
    .in:focus{
      box-shadow: var(--focus);
      border-color: var(--accent);
      background: var(--panel);
    }
    .send{
      appearance:none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      transition: background var(--transition);
      white-space: nowrap;
    }
    .send:hover{ background: var(--btn-bg-hover); }
    .send:disabled{ opacity: 0.6; cursor:not-allowed; }

    .footer{
      text-align:center;
      padding: 14px 18px;
      color: var(--muted);
      border-top: 1px solid var(--line);
      background: var(--panel);
      font-size: 11px;
    }

    /* Modals */
    .modal{
      position: fixed; inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,0.45);
      z-index: 1000;
      padding: 16px;
    }
    .card{
      width: min(96vw, 860px);
      max-height: 90vh;
      overflow:auto;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card-h{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 12px;
      font-weight: 700;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
    }
    .card-b{ padding: 16px; line-height: 1.6; font-size: 13px; }
    .card-f{
      padding: 14px 16px;
      border-top: 1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap: 8px;
    }
    .btn{
      appearance:none;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 700;
      font-size: 12px;
      cursor:pointer;
      transition: background var(--transition);
    }
    .btn:hover{ background: var(--btn-bg-hover); }
    .btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }
    body.dark .btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color: #0f1114;
    }

    .group{ padding: 16px; border-top: 1px solid var(--line); }
    .group:first-child{ border-top: none; }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 10px 0;
    }
    .select, .ta, .in-inline{
      width: 100%;
      border: 1px solid var(--btn-border);
      background: var(--panel-2);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      color: var(--text);
      font-size: 13px;
      outline:none;
    }
    .select:focus, .ta:focus, .in-inline:focus{ box-shadow: var(--focus); border-color: var(--accent); background: var(--panel); }
    .ta{ min-height: 120px; resize: vertical; }

    /* Switch - clean */
    .switch{
      width: 46px; height: 26px;
      border-radius: 999px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      position: relative;
      cursor:pointer;
      transition: background var(--transition), border-color var(--transition);
      flex: 0 0 auto;
    }
    .switch > i{
      position:absolute;
      width: 20px; height: 20px;
      top: 2px; left: 2px;
      border-radius: 999px;
      background: var(--panel);
      border: 1px solid var(--line);
      transition: left var(--transition);
    }
    .switch.on{
      background: var(--accent);
      border-color: var(--accent);
    }
    body.dark .switch.on{ background: var(--accent); border-color: var(--accent); }
    .switch.on > i{ left: 24px; }

    .muted{ color: var(--muted); font-size: 12px; }

    @media (max-width: 1100px){
      .container{ grid-template-columns: 1fr; }
      .brand-wrap{ min-width: unset; }
      .stats{ min-width: unset; }
    }
    @media (max-width: 720px){
      .top{ grid-template-columns: 1fr; gap: 10px; }
      .badge{ justify-self: start; }
      .top-actions{ justify-content:flex-start; flex-wrap: wrap; }
      .hero{ flex-direction: column; }
      .composer{ flex-direction: column; align-items: stretch; }
      .send{ width: 100%; }
      .in{ width: 100%; }
      .answer-mode{ justify-content:flex-start; }
    }
  </style>
</head>
<body>

<!-- Datenschutzhinweis -->
<div id="m-privacy" class="modal" style="display:none">
  <div class="card">
    <div class="card-h">
      Datenschutzhinweis
      <span class="muted" style="font-weight:700;font-size:12px;">BETA</span>
    </div>
    <div class="card-b">
      <p class="muted" style="margin-bottom:10px;">
        Hinweis: Dieser Bot befindet sich im Beta-Stadium. Antworten können unvollständig oder falsch sein.
      </p>

      <p style="margin-bottom:10px;">
        Um diesen Chatbot nutzen zu können, ist deine Zustimmung zur folgenden Datenverarbeitung erforderlich:
      </p>

      <ul style="margin:10px 0 0 18px; line-height:1.6;">
        <li>Deine Eingaben werden an <strong>OpenAI</strong> (USA) und <strong>Make</strong> (EU) übermittelt.</li>
        <li>Die übermittelten Daten werden dort zur <strong>Generierung von Antworten</strong> automatisiert verarbeitet.</li>
        <li>Gib bitte <strong>keine sensiblen oder personenbezogenen Daten</strong> ein (z. B. Gesundheitsdaten, Klarnamen Dritter, Kontodaten).</li>
        <li>Weitere Informationen:
          <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">Datenschutz OpenAI</a>,
          <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Datenschutz Make</a>.
        </li>
      </ul>

      <p class="muted" style="margin-top:12px;">
        Hinweis: Chatverläufe und Snippets werden nur lokal im Browser gespeichert (localStorage). Verwaltung über Einstellungen (löschen/exportieren).
      </p>

      <p style="margin-top:12px;">
        Durch Klick auf <strong>„Zustimmen“</strong> erklärst du dich mit der beschriebenen Verarbeitung einverstanden.
      </p>
    </div>
    <div class="card-f">
      <button class="btn" id="p-decline">Ablehnen</button>
      <button class="btn primary" id="p-accept">Zustimmen</button>
    </div>
  </div>
</div>

<!-- Nutzungshinweise -->
<div id="m-usage" class="modal" style="display:none">
  <div class="card">
    <div class="card-h">
      Nutzungshinweise
      <span class="muted" style="font-weight:700;font-size:12px;">BETA</span>
    </div>
    <div class="card-b">
      <ul style="margin:10px 0 0 18px; line-height:1.6;">
        <li><strong>Automatisierte Antworten:</strong> Inhalte werden von KI generiert.</li>
        <li><strong>Keine Gewähr:</strong> Inhalte können unvollständig oder fehlerhaft sein.</li>
        <li><strong>Kein Ersatz für Beratung:</strong> keine Rechts-, Medizin-, Steuer- oder Finanzberatung.</li>
        <li><strong>Eigenverantwortung:</strong> Inhalte prüfen, mit Fachquellen abgleichen.</li>
      </ul>
      <p style="margin-top:12px;">
        Durch Klick auf <strong>„Einverstanden“</strong> bestätigst du, dass du die Hinweise verstanden hast.
      </p>
    </div>
    <div class="card-f">
      <button class="btn primary" id="u-accept">Einverstanden</button>
    </div>
  </div>
</div>

<!-- Einstellungen -->
<div id="m-settings" class="modal">
  <div class="card">
    <div class="card-h">Einstellungen</div>

    <div class="group">
      <div class="row">
        <label style="font-weight:700;font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.04em;">Darstellung</label>
        <div class="chips" id="chip-theme" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <div class="chip" data-val="light">Hell</div>
          <div class="chip" data-val="dark">Dunkel</div>
          <div class="chip" data-val="system">System</div>
        </div>
      </div>

      <div class="row">
        <label style="font-weight:600;">Gender-Sprache</label>
        <div id="sw-gender" class="switch"><i></i></div>
      </div>

      <div class="row">
        <label style="font-weight:600;">Begrüßung anzeigen</label>
        <div id="sw-greet" class="switch on"><i></i></div>
      </div>

      <div class="row">
        <label style="font-weight:600;">Lernen aktiv</label>
        <div id="sw-learn" class="switch"><i></i></div>
      </div>
    </div>

    <div class="group">
      <div class="row">
        <label style="font-weight:600;">Fachmodus</label>
        <select id="sel-domain" class="select">
          <option value="">— Kein spezieller Modus —</option>
          <option value="AEVO">AEVO</option>
          <option value="Personal">Personal</option>
          <option value="Recht">Recht</option>
          <option value="Kommunikation">Kommunikation</option>
          <option value="VWL">VWL</option>
        </select>
      </div>
    </div>

    <div class="group">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
        <div>
          <strong style="text-transform:uppercase;letter-spacing:0.04em;color:var(--muted);font-size:12px;">Prompt-Snippets</strong>
          <div class="muted" style="margin-top:4px;">per „/alias“ einfügen</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn" id="pm-add">Neu</button>
          <button class="btn" id="pm-export">Export</button>
          <button class="btn" id="pm-import">Import</button>
        </div>
      </div>
      <div id="pm-list" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:10px"></div>
    </div>

    <div class="group">
      <div class="row" style="align-items:flex-start">
        <div>
          <div style="font-weight:700;">Chatverlauf</div>
          <div class="muted">Nur lokal gespeichert. Du kannst ihn löschen oder exportieren.</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" id="btn-export-all">Gesamt-Export</button>
          <button class="btn" id="btn-clear-all">Alle löschen</button>
        </div>
      </div>
    </div>

    <div class="card-f">
      <button class="btn" id="s-close">Schließen</button>
      <button class="btn primary" id="s-save">Speichern</button>
    </div>
  </div>
</div>

<!-- Prompt-Editor -->
<div id="m-prompt" class="modal">
  <div class="card">
    <div class="card-h">Snippet</div>
    <div class="card-b">
      <div class="row">
        <label style="min-width:140px;font-weight:600;">Titel</label>
        <input id="pe-title" class="in-inline" />
      </div>
      <div class="row">
        <label style="min-width:140px;font-weight:600;">Alias</label>
        <input id="pe-alias" class="in-inline" placeholder="/aevo" />
      </div>
      <div style="margin:10px 0 6px;font-weight:600;">Text</div>
      <textarea id="pe-content" class="ta" placeholder="Dieser Text wird bei /alias eingefügt."></textarea>
    </div>
    <div class="card-f">
      <button class="btn" id="pe-cancel">Abbrechen</button>
      <button class="btn primary" id="pe-save">Speichern</button>
    </div>
  </div>
</div>

<!-- Lernen -->
<div id="m-learn" class="modal">
  <div class="card">
    <div class="card-h">Lernen</div>
    <div class="card-b">
      <div class="row">
        <input id="learn-tag-input" class="in-inline" placeholder="Thema taggen (z. B. AEVO Ausbilderrolle)" />
        <button class="btn primary" id="learn-add">Speichern</button>
      </div>
      <div class="tag-list" id="learn-tags"></div>

      <div style="margin-top:12px;">
        <label style="font-weight:700;">Notizen</label>
        <textarea id="learn-notes" class="ta" placeholder="Eigene Notizen zum Lernen"></textarea>
      </div>

      <div style="margin-top:12px;">
        <label style="font-weight:700;">Lernkarten-Idee</label>
        <textarea id="learn-cards" class="ta" placeholder="Stichworte für Lernkarten (lokal gespeichert)"></textarea>
      </div>
    </div>
    <div class="card-f">
      <button class="btn" id="learn-close">Schließen</button>
      <button class="btn primary" id="learn-save">Speichern</button>
    </div>
  </div>
</div>

<!-- App -->
<div class="top">
  <div class="brand-wrap">
    <img
      class="brand-portrait"
      src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png"
      alt="Linda"
      width="44" height="44"
      decoding="async"
      fetchpriority="high"
    />
    <div>
      <div class="brand">Linda</div>
      <div class="pulse">Coaching Session</div>
    </div>
  </div>

  <div class="badge" id="domain-badge" style="display:none">Fachmodus: —</div>

  <div class="top-actions">
    <button class="icon-btn" id="btn-learn" aria-label="Lernen öffnen">Lernen</button>
    <button class="icon-btn" id="btn-settings" aria-label="Einstellungen öffnen">Einstellungen</button>
  </div>
</div>

<div class="container">
  <aside class="sidebar">
    <div class="panel coach">
      <img
        src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png"
        alt="Linda"
        width="56" height="56"
        loading="lazy"
        decoding="async"
      />
      <div>
        <h2>Coach Linda</h2>
        <p>Strukturiertes Coaching mit schnellen oder ausführlichen Antworten. Snippets per „/“.</p>
      </div>
    </div>

    <div class="panel">
      <div class="quick">
        <div class="chip" data-quick="/tldr">TL;DR</div>
        <div class="chip" data-quick="/aevo">AEVO</div>
        <div class="chip" data-quick="/struktur">Struktur</div>
        <div class="chip" data-quick="/feedback">Feedback</div>
      </div>
    </div>

    <div class="panel learn">
      <div class="learn-head">
        <div class="title">Lernen</div>
        <button class="sm-btn" id="learn-open">Öffnen</button>
      </div>
      <div class="tag-list" id="learn-tags-mini"></div>
    </div>

    <div class="panel sessions">
      <div class="head">
        <div>Verläufe</div>
        <button id="btn-new" class="sm-btn">Neu</button>
      </div>
      <div id="sess-list" class="list"></div>
    </div>
  </aside>

  <section class="chat">
    <div class="hero">
      <div>
        <h1>Training mit Struktur & Tempo</h1>
        <p>Snippets per „/“. Fachmodus in den Einstellungen. Antworten kopieren oder als PDF exportieren.</p>
        <p class="muted">Kontext: 3 letzte Nachrichten werden als Gesprächskontext übermittelt.</p>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="label">Kontext</div>
          <div class="val">3 Nachrichten</div>
        </div>
        <div class="stat">
          <div class="label">Snippets</div>
          <div class="val" id="stat-snippets">–</div>
        </div>
      </div>
    </div>

    <div id="log" class="log"></div>

    <div style="position:relative">
      <div id="palette" class="palette"></div>

      <div class="composer">
        <div class="answer-mode">
          <label><input type="radio" name="answer-mode" value="fast" checked /> Schnell</label>
          <label><input type="radio" name="answer-mode" value="full" /> Ausführlich</label>
        </div>

        <input id="in" class="in" placeholder="Deine Frage… (Tipp „/“ für Snippets)" />
        <button id="send" class="send">Senden</button>
      </div>
    </div>
  </section>
</div>

<div class="footer">
  <p>&copy; 2025 Linda. Clean Training UI.</p>
</div>

<!-- Kontext-Add-on (unverändert) -->
<script id="linda-context-addon">
(function(){
  if (localStorage.getItem('linda.addon.disabled') === '1') { console.info('[linda-addon] disabled'); return; }
  const MAX_CONTEXT_CHARS = 2500;
  const HISTORY_TURNS = 3;
  function getFachmodus() {
    const sel = document.getElementById('sel-domain');
    if (sel && sel.value) return sel.value;
    const selects = Array.from(document.querySelectorAll("select"));
    const candidate = selects.find(s => /AEVO|Personal|Recht|VWL|Kommunikation/i.test(s.textContent || ""));
    const val = candidate?.value?.trim();
    return val && val.length ? val : "Personal";
  }
  function buildCompressedContext() {
    let historyArr = [];
    try {
      const raw = localStorage.getItem("chatHistory");
      if (raw) historyArr = JSON.parse(raw) || [];
    } catch {}
    if (!historyArr || !historyArr.length) {
      try {
        const rawSessions = localStorage.getItem('linda.sessions');
        const activeId = localStorage.getItem('linda.activeId');
        const sessions = rawSessions ? JSON.parse(rawSessions) : [];
        let session = null;
        if (activeId) session = sessions.find(s=>s.id===activeId);
        if (!session && sessions && sessions.length) session = sessions[sessions.length-1];
        if (session && Array.isArray(session.messages)) {
          const turns = [];
          let pendingUser = null;
          for (const m of session.messages) {
            if (m.role === 'user') {
              pendingUser = (pendingUser ? (pendingUser + ' ' + m.content) : m.content) || '';
            } else if (m.role === 'assistant') {
              if (pendingUser !== null) {
                turns.push({ user: pendingUser, bot: m.content || '' });
                pendingUser = null;
              }
            }
          }
          if (pendingUser !== null) turns.push({ user: pendingUser, bot: '' });
          historyArr = turns.map(t => ({ user: t.user, bot: t.bot }));
        }
      } catch {}
    }
    const last = historyArr.slice(-HISTORY_TURNS);
    let context = last.map(turn => `User: ${turn.user || ''}\nLinda: ${turn.bot || ''}`).join("\n");
    if (context.length > MAX_CONTEXT_CHARS) {
      context = "Kurzzusammenfassung vorheriger Dialoge:\n" + context.slice(-MAX_CONTEXT_CHARS);
    }
    return context;
  }
  const _origFetch = window.fetch.bind(window);
  window.fetch = async function(url, options = {}) {
    try {
      const method = ((options && options.method) || "GET").toUpperCase();
      const isPost = method === "POST";
      const headers = options && options.headers ? options.headers : {};
      const contentType = (headers["Content-Type"] || headers["content-type"] || "").toLowerCase();
      const isJson = contentType.includes("application/json") || (typeof options.body === "string" && options.body.trim().startsWith("{"));
      if (isPost && isJson && typeof options.body === "string") {
        try {
          const body = JSON.parse(options.body);
          const hasMessageLike = (typeof body.message === "string") || (typeof body.question === "string");
          if (body && typeof body === "object" && hasMessageLike && !("context" in body) && localStorage.getItem('linda.addon.disabled') !== '1') {
            const context = buildCompressedContext();
            const fachmodus = getFachmodus();
            const augmented = { ...body, context, fachmodus, user: body.user || "Dozent" };
            options.body = JSON.stringify(augmented);
            console.info('[linda-addon] augmented fetch ->', url, { fachmodus, contextAdded: !!context });
          }
        } catch (err) {
          console.warn('[linda-addon] could not parse JSON body, skipping augmentation', err);
        }
      }
    } catch (err) {
      console.warn('[linda-addon] wrapper error, calling original fetch', err);
    }
    return _origFetch(url, options);
  };
  function attachInputHook() {
    const buttons = Array.from(document.querySelectorAll("button"));
    const sendBtn = buttons.find(b => (b.innerText || b.textContent || "").trim().toLowerCase() === "senden" || (b.getAttribute('id') === 'send'));
    const inputs  = Array.from(document.querySelectorAll("input[type='text'], textarea, input:not([type])"));
    const userInput = inputs[0];
    if (!sendBtn || !userInput) return;
    const handler = () => {
      const text = (userInput.value || "").trim();
      if (!text) return;
      try {
        const hist = JSON.parse(localStorage.getItem("chatHistory")) || [];
        hist.push({ user: text, bot: "" });
        localStorage.setItem("chatHistory", JSON.stringify(hist));
      } catch {}
    };
    if (!sendBtn.__lindaHooked) {
      sendBtn.addEventListener("click", handler, { capture: true });
      if (userInput && !userInput.__lindaHooked) {
        userInput.addEventListener("keydown", (e) => { if (e.key === "Enter" && !e.shiftKey) handler(); }, { capture: true });
        userInput.__lindaHooked = true;
      }
      sendBtn.__lindaHooked = true;
    }
  }
  if (document.readyState === "loading") { document.addEventListener("DOMContentLoaded", attachInputHook); }
  else { attachInputHook(); }
})();
</script>

<script>
(function(){
  // Anti-Duplication / Kopierschutz (optional: entfernen, wenn du selektieren willst)
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('copy', e => e.preventDefault());
  document.addEventListener('cut', e => e.preventDefault());
  document.addEventListener('paste', e => e.preventDefault());
  document.addEventListener('selectstart', e => e.preventDefault());

  const uniqueToken = 'Linda-v27.6-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

  const $ = id => document.getElementById(id);
  const LS = {
    get(k, d){ try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    set(k, v){ localStorage.setItem(k, JSON.stringify(v)) },
    del(k){ localStorage.removeItem(k) }
  };

  // Performance / Storage guards
  const MAX_MESSAGES_PER_SESSION = 250;
  const SAVE_DEBOUNCE_MS = 120;
  let _saveT = null;
  function saveAllDebounced(){
    if (_saveT) clearTimeout(_saveT);
    _saveT = setTimeout(() => { saveAll(); _saveT = null; }, SAVE_DEBOUNCE_MS);
  }

  const S = LS.get('linda.settings',{theme:'light',gender:false,greet:true,domain:'',learn:true});

  let SN = LS.get('linda.snippets',[
    {id:'s1',title:'AEVO-Kurz',alias:'/aevo',content:'Bitte juristisch sauber und prüfungsrelevant zur AEVO antworten.'},
    {id:'s2',title:'TL;DR',alias:'/tldr',content:'TL;DR in drei Bulletpoints, je max. 12 Wörter.'}
  ]);
  let Learn    = LS.get('linda.learn',{tags:[],notes:'',cards:''});
  let Sessions = LS.get('linda.sessions',[]);
  let activeId = LS.get('linda.activeId',null);

  const logEl = $('log');
  const palEl = $('palette');
  const inputEl = $('in');
  const sendBtn = $('send');

  const md = (txt)=>{ try { return marked.parse(txt) } catch { return txt } };
  const show = m => m.style.display='flex';
  const hide = m => m.style.display='none';
  const uid  = () => 's_'+Date.now().toString(36)+Math.random().toString(36).slice(2,6);

  function updateStats(){
    const el = $('stat-snippets');
    if (el) el.textContent = SN.length;
  }

  function renderLearnMini(){
    const box = $('learn-tags-mini');
    if (!box) return;
    box.innerHTML = (Learn.tags && Learn.tags.length)
      ? Learn.tags.map(t=>`<span class="tag-pill">${t}</span>`).join('')
      : '<span class="muted">Noch keine Tags</span>';
  }

  function saveAll(){
    LS.set('linda.settings', S);
    LS.set('linda.snippets', SN);
    LS.set('linda.sessions', Sessions);
    LS.set('linda.activeId', activeId);
    LS.set('linda.learn', Learn);
    updateStats();
    renderLearnMini();
  }

  // Theme
  let _mql = null;
  let _mqlHandler = null;
  function applyTheme(){
    if (S.theme === 'system') {
      if (!_mql) _mql = window.matchMedia('(prefers-color-scheme: dark)');
      if (_mqlHandler) _mql.removeEventListener?.('change', _mqlHandler);
      _mqlHandler = () => document.body.classList.toggle('dark', _mql.matches);
      _mqlHandler();
      _mql.addEventListener?.('change', _mqlHandler);
    } else {
      if (_mql && _mqlHandler) _mql.removeEventListener?.('change', _mqlHandler);
      document.body.classList.toggle('dark', S.theme==='dark');
    }
    document.querySelectorAll('#chip-theme .chip')
      .forEach(c=>c.classList.toggle('active', c.dataset.val===S.theme));
  }

  function ensureFirstSession(){
    if(!Sessions.length){
      const id = uid();
      Sessions = [{id, name:'Neuer Chat', ts:Date.now(), messages:[]}];
      activeId = id;
      saveAll();
    }
    if(!activeId || !Sessions.find(s=>s.id===activeId)){
      activeId = Sessions[0].id;
      saveAll();
    }
  }

  function active(){ return Sessions.find(s=>s.id===activeId); }
  function setActive(id){ activeId=id; saveAll(); renderSessions(); renderChat(); }
  function addSession(){ const id=uid(); Sessions.unshift({id,name:'Neuer Chat',ts:Date.now(),messages:[]}); setActive(id); }
  function renameSession(id){
    const s = Sessions.find(x=>x.id===id);
    if(!s) return;
    const nn = prompt('Neuer Name für Verlauf:', s.name||'');
    if(nn!==null){ s.name = nn.trim() || s.name; saveAll(); renderSessions(); }
  }
  function deleteSession(id){
    if(!confirm('Diesen Verlauf wirklich löschen?')) return;
    Sessions = Sessions.filter(x=>x.id!==id);
    if(!Sessions.length){ addSession(); }
    else if(activeId===id){ activeId = Sessions[0].id; }
    saveAll(); renderSessions(); renderChat();
  }
  function exportSession(id){
    const s = Sessions.find(x=>x.id===id);
    if(!s) return;
    const text = s.messages
      .map(m=>(m.role==='user'?'Du: ':'Linda: ')+m.content)
      .join('\n\n');
    const blob = new Blob([text],{type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (s.name||'linda_chat')+'.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function renderSessions(){
    const el = $('sess-list');
    el.innerHTML = Sessions.map(s=>`
      <div class="sess ${s.id===activeId?'active':''}" data-id="${s.id}">
        <div class="ttl">
          <span>${s.name||'Chat'}</span>
          <small>${new Date(s.ts).toLocaleDateString()}</small>
        </div>
        <div class="rowbtns">
          <button class="sm-btn" data-action="rename" title="Umbenennen">Umbenennen</button>
          <button class="sm-btn" data-action="export" title="Exportieren">Export</button>
          <button class="sm-btn" data-action="delete" title="Löschen">Löschen</button>
        </div>
      </div>
    `).join('');

    if (!el.__bound) {
      el.addEventListener('click', (e) => {
        const sessEl = e.target.closest('.sess');
        if (!sessEl) return;
        const actionBtn = e.target.closest('button[data-action]');
        const id = sessEl.dataset.id;
        if (actionBtn) {
          e.stopPropagation();
          const act = actionBtn.dataset.action;
          if (act === 'rename') return renameSession(id);
          if (act === 'export') return exportSession(id);
          if (act === 'delete') return deleteSession(id);
          return;
        }
        setActive(id);
      });
      el.__bound = true;
    }
  }

  function enhanceFootnotes(bubbleEl) {
    const mdEl = bubbleEl.querySelector('.md');
    if (!mdEl) return;
    if (mdEl.__footnoted) return;

    const sections = mdEl.querySelectorAll('h1, h2, h3, p');
    if (!sections.length) return;

    const MAX_FOOTNOTES = 12;
    let idx = 1;

    const footnotes = document.createElement('div');
    footnotes.className = 'footnotes';
    const list = document.createElement('ol');

    for (const sec of sections) {
      if (idx > MAX_FOOTNOTES) break;

      const marker = document.createElement('sup');
      marker.className = 'footnote-marker';
      marker.textContent = '[' + idx + ']';

      sec.appendChild(document.createTextNode(' '));
      sec.appendChild(marker);

      const li = document.createElement('li');
      const t = (sec.textContent || '').replace(/\[\d+\]\s*$/, '').trim();
      li.textContent = 'Passage ' + idx + ': ' + (t.length > 220 ? (t.slice(0, 220) + '…') : t);
      list.appendChild(li);

      idx++;
    }

    if (list.children.length) {
      footnotes.appendChild(list);
      mdEl.appendChild(footnotes);
      mdEl.__footnoted = true;
    }
  }

  function exportPDF(html){
    const win = window.open('', '_blank');
    const now = new Date();
    const timestamp = now.toLocaleString();
    win.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Linda Antwort</title>
          <link href="https://fonts.cdnfonts.com/css/aptos" rel="stylesheet">
          <style>
            body{font-family:'Aptos','Segoe UI',Arial,sans-serif;font-size:11pt;line-height:1.6;padding:32px;color:#111;}
            h1,h2,h3{color:#111;}
            .footnote-marker{color:#555;}
            .footer-note{margin-top:24px;font-size:9pt;color:#555;}
            hr{margin:18px 0;border:0;border-top:1px solid #ddd;}
          </style>
        </head>
        <body>
          <h2>LINDA</h2>
          <div>${html}</div>
          <hr>
          <div class="footer-note">
            ${timestamp}<br/>
            Antwort mit KI erstellt. Keine Gewähr für Richtigkeit und Aktualität.
            Inhalte bitte prüfen.
          </div>
        </body>
      </html>
    `);
    win.document.close();
    win.focus();
    win.print();
  }

  function scrollToBottom(){
    requestAnimationFrame(() => { logEl.scrollTop = logEl.scrollHeight; });
  }

  function createBubbleEl(role, content, idx){
    const d = document.createElement('div');
    d.className = 'bubble' + (role==='user' ? ' me' : '');
    d.dataset.role = role;
    d.dataset.idx = String(idx);

    if (role === 'assistant') {
      d.innerHTML =
        '<div class="bubble-header">' +
          '<button type="button" class="copy-btn" title="Antwort kopieren">Kopieren</button>' +
          '<button type="button" class="pdf-btn" title="Als PDF exportieren">PDF</button>' +
        '</div>' +
        '<div class="md">'+md(content)+'</div>';

      if (!String(content).startsWith('⏳')) enhanceFootnotes(d);
    } else {
      d.innerHTML = '<div class="md">'+md(content)+'</div>';
    }
    return d;
  }

  function updateAssistantMsg(idx, newContent){
    const bubble = logEl.querySelector(`.bubble[data-idx="${idx}"]`);
    if (!bubble) return;

    bubble.innerHTML =
      '<div class="bubble-header">' +
        '<button type="button" class="copy-btn" title="Antwort kopieren">Kopieren</button>' +
        '<button type="button" class="pdf-btn" title="Als PDF exportieren">PDF</button>' +
      '</div>' +
      '<div class="md">'+md(newContent)+'</div>';

    if (!String(newContent).startsWith('⏳')) enhanceFootnotes(bubble);
    scrollToBottom();
  }

  function renderChat(){
    logEl.innerHTML='';
    const s = active();
    if(!s) return;

    const frag = document.createDocumentFragment();
    s.messages.forEach((m, idx) => frag.appendChild(createBubbleEl(m.role, m.content, idx)));
    logEl.appendChild(frag);
    scrollToBottom();
  }

  function push(role, content, immediateSave=false){
    const s = active();
    s.messages.push({role,content});
    if (s.messages.length > MAX_MESSAGES_PER_SESSION) {
      s.messages.splice(0, s.messages.length - MAX_MESSAGES_PER_SESSION);
    }
    s.ts = Date.now();
    if (immediateSave) saveAll(); else saveAllDebounced();
  }

  function setBadge(){
    const b = $('domain-badge');
    if(S.domain){
      b.style.display='inline-flex';
      b.textContent = 'Fachmodus: ' + S.domain;
    } else {
      b.style.display='none';
    }
  }

  function systemPrefix(){
    const lines = [];
    if(S.domain){
      const map = {
        'AEVO':'Antworte fachlich fundiert im AEVO-Kontext mit kurzer Prüfungsrelevanz.',
        'Personal':'Antworte als Expertin für Personal/HR mit Praxisbeispiel.',
        'Recht':'Antworte juristisch sauber (Normen nennen) und praxisnah.',
        'Kommunikation':'Antworte als Trainerin für Kommunikation, klar strukturiert.',
        'VWL':'Antworte fachlich fundiert in Volkswirtschaftslehre (IHK-Prüfungskontext).'
      };
      lines.push(map[S.domain]||'');
    }
    lines.push(S.gender
      ? 'Verwende gendergerechte Sprache (neutral, inklusiv, gut lesbar).'
      : 'Verwende neutrale, nicht gegenderte Sprache.'
    );
    lines.push('Strukturiere Antworten: 1) Definition/Einordnung 2) Rechts-/Theoriebezug 3) Praxisbeispiel 4) Prüfungsrelevanz 5) kurze Quellenhinweise (falls vorhanden).');
    if (S.learn) lines.push('Merke Stellen für Lernen: markiere relevante Tags, damit Notizen und Lernkarten gepflegt werden können.');
    return lines.filter(Boolean).join('\n');
  }

  function buildHistoryArray() {
    const s = active();
    if (!s || !Array.isArray(s.messages)) return [];
    const msgs = s.messages.slice(-3);
    return msgs.map(m => ({ role: m.role, content: m.content }));
  }

  function buildCompressedContextForAddon() {
    const s = active();
    if (!s || !Array.isArray(s.messages)) return '';
    const msgs = s.messages.slice(-3);
    let ctx = msgs.map(m => (m.role === 'user' ? 'User: ' : 'Linda: ') + (m.content || '')).join('\n');
    if (ctx.length > 2500) ctx = ctx.slice(-2500);
    return ctx;
  }

  function getAnswerMode(){
    const checked = document.querySelector('input[name="answer-mode"]:checked');
    return checked ? checked.value : 'fast';
  }

  async function send(){
    const q = (inputEl.value || '').trim();
    if(!q) return;

    inputEl.value = '';
    sendBtn.disabled = true;

    const mode = getAnswerMode();

    try {
      const s = active();

      // User bubble
      push('user', q);
      logEl.appendChild(createBubbleEl('user', q, s.messages.length - 1));
      scrollToBottom();

      // context/history before placeholder
      const historyArray = buildHistoryArray();
      const contextStr = buildCompressedContextForAddon();

      // placeholder
      push('assistant','⏳ Einen Moment …');
      const placeholderIdx = s.messages.length - 1;
      logEl.appendChild(createBubbleEl('assistant', '⏳ Einen Moment …', placeholderIdx));
      scrollToBottom();

      const modePrompt = (mode==='fast')
        ? 'Kurzantwort: Bitte kompakt (Bulletpoints, max. 5 Sätze).'
        : 'Ausführliche Antwort erwünscht.';

      const payload = {
        question: systemPrefix() + '\n\n' + modePrompt + '\n\n' + q,
        token: uniqueToken,
        history: historyArray,
        context: contextStr,
        fachmodus: S.domain || '',
        user: 'Dozent'
      };

      const r = await fetch('/api/bot',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      const text = await r.text();
      const out  = (text && text.trim().toLowerCase()!=='accepted')
        ? text
        : 'Ich habe deine Frage erhalten. Bitte erneut senden, falls nichts erscheint.';

      s.messages[placeholderIdx] = {role:'assistant', content: out};
      saveAllDebounced();

      updateAssistantMsg(placeholderIdx, out);
    } catch(e) {
      const s = active();
      const lastIdx = s.messages.length - 1;
      s.messages[lastIdx] = {role:'assistant',content:'Es gab ein Verbindungsproblem. Bitte noch einmal senden.'};
      saveAllDebounced();
      updateAssistantMsg(lastIdx, 'Es gab ein Verbindungsproblem. Bitte noch einmal senden.');
    } finally {
      sendBtn.disabled = false;
    }
  }

  function openPalette(list){
    palEl.innerHTML = list.map(s=>`
      <div class="pal-item" data-id="${s.id}">
        <span>${s.title}</span>
        <span class="pal-tag">${s.alias}</span>
      </div>`).join('');
    palEl.style.display = list.length ? 'block' : 'none';
  }

  function replaceAliasWithText(inp,alias,text){
    const v = inp.value;
    const i = v.lastIndexOf(alias);
    if(i>=0){
      inp.value = v.slice(0,i)+text+v.slice(i+alias.length);
    } else {
      const s = inp.selectionStart || v.length;
      inp.value = v.slice(0,s)+text+v.slice(s);
    }
  }

  function renderPM(){
    const list = $('pm-list');
    list.innerHTML = SN.map(s=>`
      <div class="panel" style="padding:12px;">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
          <div>
            <div style="font-weight:700;font-size:12px;">${s.title}</div>
            <div class="muted" style="margin-top:2px;">${s.alias}</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="sm-btn pm-use" data-id="${s.id}">Einfügen</button>
            <button class="sm-btn pm-edit" data-id="${s.id}">Bearbeiten</button>
            <button class="sm-btn pm-del" data-id="${s.id}">Löschen</button>
          </div>
        </div>
        <div class="muted" style="margin-top:10px;max-height:5em;overflow:hidden;">${s.content}</div>
      </div>`).join('');

    list.querySelectorAll('.pm-use').forEach(b=>b.onclick=()=>{
      const s = SN.find(x=>x.id===b.dataset.id);
      if(!s) return;
      replaceAliasWithText(inputEl, s.alias, s.content);
      hide($('m-settings'));
      inputEl.focus();
    });
    list.querySelectorAll('.pm-edit').forEach(b=>b.onclick=()=>editSnippet(b.dataset.id));
    list.querySelectorAll('.pm-del').forEach(b=>b.onclick=()=>{
      SN = SN.filter(x=>x.id!==b.dataset.id);
      saveAllDebounced();
      renderPM();
    });
  }

  let editingId = null;
  function editSnippet(id){
    const s = id
      ? (SN.find(x=>x.id===id) || {id:uid(),title:'',alias:'',content:''})
      : {id:uid(),title:'',alias:'',content:''};
    editingId = s.id;
    $('pe-title').value   = s.title;
    $('pe-alias').value   = s.alias;
    $('pe-content').value = s.content;
    show($('m-prompt'));
  }

  $('pm-add').onclick    = () => editSnippet(null);
  $('pe-cancel').onclick = () => hide($('m-prompt'));
  $('pe-save').onclick   = () => {
    const obj = {
      id: editingId || uid(),
      title:  $('pe-title').value.trim(),
      alias:  $('pe-alias').value.trim(),
      content:$('pe-content').value.trim()
    };
    if(!obj.alias.startsWith('/')){
      alert('Alias muss mit / beginnen.');
      return;
    }
    const i = SN.findIndex(x=>x.id===obj.id);
    if(i>=0) SN[i]=obj; else SN.push(obj);
    saveAllDebounced();
    hide($('m-prompt'));
    renderPM();
  };

  $('pm-export').onclick = () => {
    const blob = new Blob([JSON.stringify(SN,null,2)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'linda-snippets.json';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  $('pm-import').onclick = () => {
    const i = document.createElement('input');
    i.type='file'; i.accept='application/json';
    i.onchange = async () => {
      const f = i.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const arr = JSON.parse(txt);
        if(Array.isArray(arr)){
          SN = arr;
          saveAllDebounced();
          renderPM();
        }
      }catch{
        alert('Import fehlgeschlagen.');
      }
    };
    i.click();
  };

  sendBtn.onclick = send;
  inputEl.addEventListener('keydown',e=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // Palette debounce
  let _palT = null;
  inputEl.addEventListener('input', (e) => {
    const v = e.target.value;
    if (_palT) clearTimeout(_palT);
    _palT = setTimeout(() => {
      const m = v.match(/\/([\w-]{0,24})$/);
      if(m){
        const q = m[1].toLowerCase();
        const list = SN.filter(s=>
          s.alias.toLowerCase().startsWith('/'+q) ||
          s.title.toLowerCase().includes(q)
        );
        openPalette(list);
      } else {
        palEl.style.display='none';
      }
    }, 60);
  });

  document.addEventListener('click',e=>{
    if(!e.target.closest('.composer')) palEl.style.display='none';
  });

  palEl.addEventListener('click', (e) => {
    const it = e.target.closest('.pal-item');
    if (!it) return;
    const s = SN.find(x=>x.id===it.dataset.id);
    palEl.style.display='none';
    if(!s) return;
    replaceAliasWithText(inputEl, s.alias, s.content);
    inputEl.focus();
  });

  // Copy/PDF delegation
  if (!logEl.__bound) {
    logEl.addEventListener('click', async (e) => {
      const bubble = e.target.closest('.bubble');
      if (!bubble) return;

      const copyBtn = e.target.closest('.copy-btn');
      const pdfBtn  = e.target.closest('.pdf-btn');
      const mdEl    = bubble.querySelector('.md');
      if (!mdEl) return;

      if (copyBtn && navigator.clipboard && navigator.clipboard.writeText) {
        const txt = mdEl.innerText || '';
        if (!txt) return;
        const original = copyBtn.textContent;
        try {
          await navigator.clipboard.writeText(txt);
          copyBtn.textContent = 'Kopiert';
          setTimeout(()=>{ copyBtn.textContent = original; }, 900);
        } catch {
          copyBtn.textContent = 'Fehler';
          setTimeout(()=>{ copyBtn.textContent = original; }, 900);
        }
        return;
      }

      if (pdfBtn) {
        exportPDF(mdEl.innerHTML);
      }
    });
    logEl.__bound = true;
  }

  // Datenschutz & Nutzungshinweis
  const PRIV_KEY  = 'linda.privacyAccepted';
  const USAGE_KEY = 'linda.usageAccepted';

  function openInitialModals() {
    const privAccepted  = LS.get(PRIV_KEY, false);
    const usageAccepted = LS.get(USAGE_KEY, false);

    if (!privAccepted) { show($('m-privacy')); return; }
    if (!usageAccepted) { show($('m-usage')); }
  }

  $('p-accept').onclick = () => {
    LS.set(PRIV_KEY, true);
    hide($('m-privacy'));
    if (!LS.get(USAGE_KEY, false)) show($('m-usage'));
  };

  $('p-decline').onclick = () => {
    LS.del(PRIV_KEY);
    LS.del(USAGE_KEY);
    alert('Ohne Zustimmung zur Datenschutzerklärung kann der Bot nicht genutzt werden.');
  };

  $('u-accept').onclick = () => {
    LS.set(USAGE_KEY, true);
    hide($('m-usage'));

    const s = active();
    if (S.greet && s.messages.length === 0) {
      push('assistant', '**Willkommen.** Stelle deine Frage. Nutze Snippets („/“) und den Fachmodus in den Einstellungen.', true);
      renderChat();
    }
  };

  // Settings
  applyTheme();
  const sw = (el,val)=>{ el.classList.toggle('on',val); };

  sw($('sw-gender'), S.gender);
  $('sw-gender').onclick = () => { S.gender=!S.gender; sw($('sw-gender'),S.gender); saveAllDebounced(); };

  sw($('sw-greet'), S.greet);
  $('sw-greet').onclick = () => { S.greet=!S.greet; sw($('sw-greet'),S.greet); saveAllDebounced(); };

  sw($('sw-learn'), S.learn);
  $('sw-learn').onclick = () => { S.learn=!S.learn; sw($('sw-learn'),S.learn); saveAllDebounced(); };

  document.querySelectorAll('#chip-theme .chip').forEach(c=>{
    c.onclick = ()=>{ S.theme=c.dataset.val; saveAllDebounced(); applyTheme(); };
  });

  $('sel-domain').value = S.domain||'';
  setBadge();

  $('s-save').onclick = () => {
    S.domain = $('sel-domain').value;
    saveAll();
    setBadge();
    hide($('m-settings'));
  };
  $('s-close').onclick = () => hide($('m-settings'));
  $('btn-settings').onclick = () => { renderPM(); show($('m-settings')); };

  // Export / Clear
  $('btn-export-all').onclick = () => {
    const all = Sessions.map(s=>
      `# ${s.name||'Chat'} (${new Date(s.ts).toLocaleString()})\n\n` +
      s.messages.map(m=>(m.role==='user'?'Du: ':'Linda: ')+m.content).join('\n\n')
    ).join('\n\n---\n\n');
    const blob = new Blob([all],{type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'linda_all_chats.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  };

  $('btn-clear-all').onclick = () => {
    if(confirm('Wirklich alle Verläufe löschen?')){
      Sessions = [];
      addSession();
      saveAll();
      renderSessions();
      renderChat();
    }
  };

  $('btn-new').onclick = addSession;

  // Quick chips
  document.querySelectorAll('[data-quick]').forEach(chip=>{
    chip.onclick = () => {
      const alias = chip.getAttribute('data-quick');
      replaceAliasWithText(inputEl, alias, alias+' ');
      inputEl.focus();
    };
  });

  // Lernen
  function renderLearn(){
    $('learn-tags').innerHTML = (Learn.tags && Learn.tags.length)
      ? Learn.tags.map(t=>`<span class="tag-pill">${t}</span>`).join('')
      : '<span class="muted">Noch keine Tags</span>';
    $('learn-notes').value = Learn.notes || '';
    $('learn-cards').value = Learn.cards || '';
  }

  $('learn-open').onclick = () => { renderLearn(); show($('m-learn')); };
  $('btn-learn').onclick  = () => { renderLearn(); show($('m-learn')); };
  $('learn-close').onclick = () => hide($('m-learn'));
  $('learn-add').onclick   = () => {
    const val = ($('learn-tag-input').value||'').trim();
    if(!val) return;
    if(!Learn.tags.includes(val)) Learn.tags.push(val);
    $('learn-tag-input').value='';
    renderLearn();
    renderLearnMini();
    saveAllDebounced();
  };
  $('learn-save').onclick = () => {
    Learn.notes = $('learn-notes').value || '';
    Learn.cards = $('learn-cards').value || '';
    saveAllDebounced();
    hide($('m-learn'));
  };

  // Init
  ensureFirstSession();
  renderSessions();
  renderChat();
  updateStats();
  renderLearnMini();
  openInitialModals();
})();
</script>
</body>
</html>
